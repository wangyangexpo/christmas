var window=window||global,document=document||(window.document={}),Laya=window.Laya=function(t,e){var n={__internals:[],__packages:{},__classmap:{Object:Object,Function:Function,Array:Array,String:String},__sysClass:{object:"Object",array:"Array",string:"String",dictionary:"Dictionary"},__propun:{writable:!0,enumerable:!1,configurable:!0},__presubstr:String.prototype.substr,__substr:function(t,e){return 1==arguments.length?n.__presubstr.call(this,t):n.__presubstr.call(this,t,e>0?e:this.length+e)},__init:function(t){t.forEach(function(t){t.__init$&&t.__init$()})},__isClass:function(t){return t&&(t.__isclass||t==Object||t==String||t==Array)},__newvec:function(t,e){var n=[];n.length=t;for(var i=0;i<t;i++)n[i]=e;return n},__extend:function(t,e){function i(){n.un(this,"constructor",t)}for(var r in e)if(e.hasOwnProperty(r)){var a=Object.getOwnPropertyDescriptor(e,r),s=a.get,o=a.set;s||o?s&&o?Object.defineProperty(t,r,a):(s&&Object.defineProperty(t,r,s),o&&Object.defineProperty(t,r,o)):t[r]=e[r]}i.prototype=e.prototype,t.prototype=new i,n.un(t.prototype,"__imps",n.__copy({},e.prototype.__imps))},__copy:function(t,e){if(!e)return null;t=t||{};for(var n in e)t[n]=e[n];return t},__package:function(e,i){if(!n.__packages[e]){n.__packages[e]=!0;var r=t,a=e.split(".");if(a.length>1)for(var s=0,o=a.length-1;s<o;s++){var l=r[a[s]];r=l||(r[a[s]]={})}r[a[a.length-1]]||(r[a[a.length-1]]=i||{})}},__hasOwnProperty:function(t,e){function n(t,e){if(Object.hasOwnProperty.call(e.prototype,t))return!0;var i=e.prototype.__super;return null==i?null:n(t,i)}return e=e||this,Object.hasOwnProperty.call(e,t)||n(t,e.__class)},__typeof:function(t,e){if(!t||!e)return!1;if(e===String)return"string"==typeof t;if(e===Number)return"number"==typeof t;if(e.__interface__)e=e.__interface__;else if("string"!=typeof e)return t instanceof e;return t.__imps&&t.__imps[e]||t.__class==e},__as:function(t,e){return this.__typeof(t,e)?t:null},interface:function(e,i){n.__package(e,{});var r=n.__internals,a=r[e]=r[e]||{self:e};if(i){var s=i.split(",");a.extend=[];for(var o=0;o<s.length;o++){var e=s[o];r[e]=r[e]||{self:e},a.extend.push(r[e])}}for(var l=t,h=e.split("."),o=0;o<h.length-1;o++)l=l[h[o]];l[h[h.length-1]]={__interface__:e}},class:function(e,i,r,a){if(r&&n.__extend(e,r),i)if(n.__package(i,e),n.__classmap[i]=e,i.indexOf(".")>0){if(0==i.indexOf("laya.")){var s=i.split(".");a=a||s[s.length-1],n[a]&&console.log("Warning!,this class["+a+"] already exist:",n[a]),n[a]=e}}else"Main"==i?t.Main=e:(n[i]&&console.log("Error!,this class["+i+"] already exist:",n[i]),n[i]=e);var o=n.un,l=e.prototype;o(l,"hasOwnProperty",n.__hasOwnProperty),o(l,"__class",e),o(l,"__super",r),o(l,"__className",i),o(e,"__super",r),o(e,"__className",i),o(e,"__isclass",!0),o(e,"super",function(t){this.__super.call(t)})},imps:function(t,e){function i(t){var e,a;if((e=n.__internals[t])&&(r[t]=!0,a=e.extend))for(var s=0;s<a.length;s++)i(a[s].self)}if(!e)return null;var r=t.__imps||n.un(t,"__imps",{});for(var a in e)i(a)},getset:function(t,e,i,r,a){t?(r&&(e["_$GET_"+i]=r),a&&(e["_$SET_"+i]=a)):(r&&n.un(e,"_$get_"+i,r),a&&n.un(e,"_$set_"+i,a)),r&&a?Object.defineProperty(e,i,{get:r,set:a,enumerable:!1}):(r&&Object.defineProperty(e,i,{get:r,enumerable:!1}),a&&Object.defineProperty(e,i,{set:a,enumerable:!1}))},static:function(t,e){for(var n=0,i=e.length;n<i;n+=2)"length"==e[n]?t.length=e[n+1].call(t):function(){var i=e[n],r=e[n+1];Object.defineProperty(t,i,{get:function(){return delete this[i],this[i]=r.call(this)},set:function(t){delete this[i],this[i]=t},enumerable:!0,configurable:!0})}()},un:function(t,e,i){return i||(i=t[e]),n.__propun.value=i,Object.defineProperty(t,e,n.__propun),i},uns:function(t,e){e.forEach(function(e){n.un(t,e)})}};return t.console=t.console||{log:function(){}},t.trace=t.console.log,Error.prototype.throwError=function(){throw arguments},String.prototype.substr=n.__substr,Object.defineProperty(Array.prototype,"fixed",{enumerable:!1}),n}(window);!function(window,document,Laya){var __un=Laya.un,__uns=Laya.uns,__static=Laya.static,__class=Laya.class,__getset=Laya.getset,__newvec=Laya.__newvec;Laya.interface("laya.d3.core.IClone"),Laya.interface("laya.runtime.IMarket"),Laya.interface("laya.filters.IFilter"),Laya.interface("laya.resource.IDispose"),Laya.interface("laya.runtime.IConchNode"),Laya.interface("laya.webgl.shapes.IShape"),Laya.interface("laya.d3.graphics.IVertex"),Laya.interface("laya.webgl.submit.ISubmit"),Laya.interface("laya.filters.IFilterAction"),Laya.interface("laya.d3.core.render.IUpdate"),Laya.interface("laya.d3.core.scene.ITreeNode"),Laya.interface("laya.webgl.text.ICharSegment"),Laya.interface("laya.runtime.ICPlatformClass"),Laya.interface("laya.d3.core.render.IRenderable"),Laya.interface("laya.webgl.canvas.save.ISaveData"),Laya.interface("laya.webgl.resource.IMergeAtlasBitmap"),Laya.interface("laya.filters.IFilterActionGL","laya.filters.IFilterAction");var RunDriver=function(){function t(){}return __class(t,"laya.utils.RunDriver"),t.FILTER_ACTIONS=[],t.pixelRatio=-1,t._charSizeTestDiv=null,t.now=function(){return Date.now()},t.getWindow=function(){return window},t.getPixelRatio=function(){if(t.pixelRatio<0){var e=Browser.context,n=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;t.pixelRatio=(Browser.window.devicePixelRatio||1)/n,t.pixelRatio<1&&(t.pixelRatio=1)}return t.pixelRatio},t.getIncludeStr=function(t){return null},t.createShaderCondition=function(t){var e="(function() {return "+t+";})";return Browser.window.eval(e)},t.fontMap=[],t.measureText=function(e,n){var i=t.hanzi.test(e);if(i&&t.fontMap[n])return t.fontMap[n];var r=Browser.context;r.font=n;var a=r.measureText(e);return i&&(t.fontMap[n]=a),a},t.getWebGLContext=function(t){},t.beginFlush=function(){},t.endFinish=function(){},t.addToAtlas=null,t.flashFlushImage=function(t){},t.drawToCanvas=function(t,e,n,i,r,a){var s=HTMLCanvas.create("2D"),o=new RenderContext(n,i,s);return RenderSprite.renders[e]._fun(t,o,r,a),s},t.createParticleTemplate2D=null,t.createGLTextur=null,t.createWebGLContext2D=null,t.changeWebGLSize=function(t,e){},t.createRenderSprite=function(t,e){return new RenderSprite(t,e)},t.createFilterAction=function(t){return new ColorFilterAction},t.createGraphics=function(){return new Graphics},t.clear=function(t){Render._context.ctx.clear()},t.clearAtlas=function(t){},t.isAtlas=function(t){return!1},t.addTextureToAtlas=function(t){},t.getTexturePixels=function(t,e,n,i,r){return null},t.skinAniSprite=function(){return null},t.update3DLoop=function(){},__static(t,["hanzi",function(){return this.hanzi=new RegExp("^[一-龥]$")}]),t}(),___Laya=function(){return __getset(1,Laya,"alertGlobalError",null,function(t){var e=0;Browser.window.onerror=t?function(t,n,i,r,a){e++<5&&a&&alert("出错啦，请把此信息截图给研发商\n"+t+"\n"+a.stack||a)}:null}),Laya.init=function(t,e,n){for(var i=[],r=2,a=arguments.length;r<a;r++)i.push(arguments[r]);if(!Laya._isinit){ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=Laya._arrayBufferSlice),Laya._isinit=!0,Browser.__init__(),Context.__init__(),Graphics.__init__(),Laya.timer=new Timer,Laya.scaleTimer=new Timer,Laya.loader=new LoaderManager,WeakObject.__init__();for(var r=0,s=i.length;r<s;r++)i[r].enable&&i[r].enable();return Font.__init__(),Style.__init__(),ResourceManager.__init__(),CacheManager.beginCheck(),Laya._currentStage=Laya.stage=new Stage,Laya.stage.conchModel&&Laya.stage.conchModel.setRootNode(),Laya.getUrlPath(),Laya.render=new Render(0,0),Laya.stage.size(t,e),RenderSprite.__init__(),KeyBoardManager.__init__(),MouseManager.instance.__init__(Laya.stage,Render.canvas),Input.__init__(),SoundManager.autoStopMusic=!0,LocalStorage.__init__(),Render.canvas}},Laya.getUrlPath=function(){var t=Browser.window.location,e=t.pathname;e=":"==e.charAt(2)?e.substring(1):e,URL.rootPath=URL.basePath=URL.getPath("file:"==t.protocol?e:t.protocol+"//"+t.host+t.pathname)},Laya._arrayBufferSlice=function(t,e){var n=this,i=new Uint8Array(n,t,e-t),r=new Uint8Array(i.length);return r.set(i),r.buffer},Laya.stage=null,Laya.timer=null,Laya.scaleTimer=null,Laya.loader=null,Laya.version="1.7.13beta",Laya.render=null,Laya._currentStage=null,Laya._isinit=!1,__static(Laya,["conchMarket",function(){return this.conchMarket=window.conch?conchMarket:null},"PlatformClass",function(){return this.PlatformClass=window.PlatformClass}]),Laya}(),SaveBase=function(){function t(){}__class(t,"laya.webgl.canvas.save.SaveBase");var e=t.prototype;return Laya.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){this._dataObj[this._valueName]=this._value,t._cache[t._cache._length++]=this,this._newSubmit&&(e._curSubmit=Submit.RENDERBASE,e._renderKey=0)},t._createArray=function(){var t=[];return t._length=0,t},t._init=function(){var e=t._namemap={};return e[1]="ALPHA",e[2]="fillStyle",e[8]="font",e[256]="lineWidth",e[512]="strokeStyle",e[8192]="_mergeID",e[1024]=e[2048]=e[4096]=[],e[16384]="textBaseline",e[32768]="textAlign",e[65536]="_nBlendType",e[1048576]="shader",e[2097152]="filters",e},t.save=function(e,n,i,r){if((e._saveMark._saveuse&n)!==n){e._saveMark._saveuse|=n;var a=t._cache,s=a._length>0?a[--a._length]:new t;s._value=i[s._valueName=t._namemap[n]],s._dataObj=i,s._newSubmit=r;var o=e._save;o[o._length++]=s}},t._cache=laya.webgl.canvas.save.SaveBase._createArray(),t._namemap=t._init(),t}(),Vector3=function(){function t(t,e,n){this.elements=new Float32Array(3),void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0);var i=this.elements;i[0]=t,i[1]=e,i[2]=n}__class(t,"laya.d3.math.Vector3");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1],this.elements[2]=t[e+2]},e.cloneTo=function(t){var e=t,n=e.elements,i=this.elements;n[0]=i[0],n[1]=i[1],n[2]=i[2]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},__getset(0,e,"z",function(){return this.elements[2]},function(t){this.elements[2]=t}),__getset(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),__getset(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),t.distanceSquared=function(t,e){var n=t.elements,i=e.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return r*r+a*a+s*s},t.distance=function(t,e){var n=t.elements,i=e.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2];return Math.sqrt(r*r+a*a+s*s)},t.min=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2])},t.max=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2])},t.transformQuat=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],l=r[2],h=a[0],_=a[1],u=a[2],c=a[3],d=c*s+_*l-u*o,f=c*o+u*s-h*l,m=c*l+h*o-_*s,p=-h*s-_*o-u*l;i[0]=d*c+p*-h+f*-u-m*-_,i[1]=f*c+p*-_+m*-h-d*-u,i[2]=m*c+p*-u+d*-_-f*-h},t.scalarLength=function(t){var e=t.elements,n=e[0],i=e[1],r=e[2];return Math.sqrt(n*n+i*i+r*r)},t.scalarLengthSquared=function(t){var e=t.elements,n=e[0],i=e[1],r=e[2];return n*n+i*i+r*r},t.normalize=function(t,e){var n=t.elements,i=e.elements,r=n[0],a=n[1],s=n[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),i[0]=n[0]*o,i[1]=n[1]*o,i[2]=n[2]*o)},t.multiply=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2]},t.scale=function(t,e,n){var i=n.elements,r=t.elements;i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e},t.lerp=function(t,e,n,i){var r=i.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h)},t.transformV3ToV3=function(e,n,i){var r=t._tempVector4;t.transformV3ToV4(e,n,r);var a=r.elements,s=i.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},t.transformV3ToV4=function(t,e,n){var i=t.elements,r=i[0],a=i[1],s=i[2],o=e.elements,l=n.elements;l[0]=r*o[0]+a*o[4]+s*o[8]+o[12],l[1]=r*o[1]+a*o[5]+s*o[9]+o[13],l[2]=r*o[2]+a*o[6]+s*o[10]+o[14],l[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},t.TransformNormal=function(t,e,n){var i=t.elements,r=i[0],a=i[1],s=i[2],o=e.elements,l=n.elements;l[0]=r*o[0]+a*o[4]+s*o[8],l[1]=r*o[1]+a*o[5]+s*o[9],l[2]=r*o[2]+a*o[6]+s*o[10]},t.transformCoordinate=function(e,n,i){var r=t._tempVector4.elements,a=e.elements,s=a[0],o=a[1],l=a[2],h=n.elements;r[0]=s*h[0]+o*h[4]+l*h[8]+h[12],r[1]=s*h[1]+o*h[5]+l*h[9]+h[13],r[2]=s*h[2]+o*h[6]+l*h[10]+h[14],r[3]=1/(s*h[3]+o*h[7]+l*h[11]+h[15]);var _=i.elements;_[0]=r[0]*r[3],_[1]=r[1]*r[3],_[2]=r[2]*r[3]},t.Clamp=function(t,e,n,i){var r=t.elements,a=r[0],s=r[1],o=r[2],l=e.elements,h=l[0],_=l[1],u=l[2],c=n.elements,d=c[0],f=c[1],m=c[2],p=i.elements;a=a>d?d:a,a=a<h?h:a,s=s>f?f:s,s=s<_?_:s,o=o>m?m:o,o=o<u?u:o,p[0]=a,p[1]=s,p[2]=o},t.add=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2]},t.subtract=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2]},t.cross=function(t,e,n){var i=t.elements,r=e.elements,a=n.elements,s=i[0],o=i[1],l=i[2],h=r[0],_=r[1],u=r[2];a[0]=o*u-l*_,a[1]=l*h-s*u,a[2]=s*_-o*h},t.dot=function(t,e){var n=t.elements,i=e.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]},t.equals=function(t,e){var n=t.elements,i=e.elements;return MathUtils3D.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&MathUtils3D.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&MathUtils3D.nearEqual(Math.abs(n[2]),Math.abs(i[2]))},t.ZERO=new t(0,0,0),t.ONE=new t(1,1,1),t.NegativeUnitX=new t(-1,0,0),t.UnitX=new t(1,0,0),t.UnitY=new t(0,1,0),t.UnitZ=new t(0,0,1),t.ForwardRH=new t(0,0,-1),t.ForwardLH=new t(0,0,1),t.Up=new t(0,1,0),t.NAN=new t(NaN,NaN,NaN),__static(t,["_tempVector4",function(){return this._tempVector4=new Vector4}]),t}(),LayaAir3D=function(){function t(){this.meshSprite3D=null,this.lastx=0,this.lasty=0,this.spriteScene=null,this.STATE_INIT=0,this.STATE_DOWN=1,this.STATE_FINISH=2,this.curState=0,this.hat=null,this.hatLine=null,Laya3D.init(300,300,!0),Laya.stage.bgColor="#26eca9",Laya.stage.scaleMode="showall",Laya.stage.screenMode="none",Browser.window.ptgame=this;var t=new Sprite;Laya.stage.addChild(t),t.loadImage("res/back.png"),t.scale(.6,.6);var e=Laya.stage.addChild(new Scene);this.spriteScene=Sprite3D.load("res/LayaScene_testt/testt.lh"),this.spriteScene.on("hierarchyloaded",this,this.onLoded),e.addChild(this.spriteScene)}__class(t,"LayaAir3D");var e=t.prototype;return e.gotoHatDown=function(){return this.curState==this.STATE_INIT&&(this.curState=this.STATE_DOWN),"success"},e.onMouseMove=function(t){var e=t.stageX-this.lastx;t.stageY,this.lasty;this.lastx=t.stageX,this.lasty=t.stageY;var n=new Vector3(0,.35*e,0);this.meshSprite3D.transform.rotate(n,!0,!1)},e.onMouseDown=function(t){this.lastx=t.stageX,this.lasty=t.stageY},e.onLoded=function(){this.meshSprite3D=this.spriteScene.getChildByName("sdlr");var t=this.meshSprite3D.getChildByName("config_sdlr_01");this.hat=t.getChildByName("hat"),this.hatLine=this.spriteScene.getChildByName("hatline"),this.hat.transform.translate(new Laya.Vector3(0,5,0)),Laya.timer.frameLoop(1,this,this.animate),Laya.stage.on("mousemove",this,this.onMouseMove),Laya.stage.on("mousedown",this,this.onMouseDown),console.log(this.meshSprite3D.name)},e.animate=function(){switch(this.curState){case this.STATE_DOWN:this.hat.transform.localPosition.y>0?this.hat.transform.translate(new Laya.Vector3(0,-.1,0)):(this.hatLine.active=!1,this.hat.transform.localPosition=new Vector3(0,0,0),this.curState=this.STATE_FINISH)}},t}(),ColorFilterAction=function(){function t(){this.data=null}__class(t,"laya.filters.ColorFilterAction");var e=t.prototype;return Laya.imps(e,{"laya.filters.IFilterAction":!0}),e.apply=function(t){var e=t.ctx.ctx,n=t.ctx.ctx.canvas;if(0==n.width||0==n.height)return n;for(var i,r=e.getImageData(0,0,n.width,n.height),a=r.data,s=0,o=a.length;s<o;s+=4)i=this.getColor(a[s],a[s+1],a[s+2],a[s+3]),0!=a[s+3]&&(a[s]=i[0],a[s+1]=i[1],a[s+2]=i[2],a[s+3]=i[3]);return e.putImageData(r,0,0),t},e.getColor=function(t,e,n,i){var r=[];if(this.data._mat&&this.data._alpha){var a=this.data._mat,s=this.data._alpha;r[0]=a[0]*t+a[1]*e+a[2]*n+a[3]*i+s[0],r[1]=a[4]*t+a[5]*e+a[6]*n+a[7]*i+s[1],r[2]=a[8]*t+a[9]*e+a[10]*n+a[11]*i+s[2],r[3]=a[12]*t+a[13]*e+a[14]*n+a[15]*i+s[3]}return r},t}(),Filter=function(){function t(){this._action=null}__class(t,"laya.filters.Filter");var e=t.prototype;return Laya.imps(e,{"laya.filters.IFilter":!0}),e.callNative=function(t){},__getset(0,e,"action",function(){return this._action}),__getset(0,e,"type",function(){return-1}),t.BLUR=16,t.COLOR=32,t.GLOW=8,t._filterStart=null,t._filterEnd=null,t._EndTarget=null,t._recycleScope=null,t._filter=null,t._useSrc=null,t._endSrc=null,t._useOut=null,t._endOut=null,t}(),FilterActionGL=function(){function t(){}__class(t,"laya.filters.webgl.FilterActionGL");var e=t.prototype;return Laya.imps(e,{"laya.filters.IFilterActionGL":!0}),e.setValue=function(t){},e.setValueMix=function(t){},e.apply3d=function(t,e,n,i,r){return null},e.apply=function(t){return null},__getset(0,e,"typeMix",function(){return 0}),t}(),EventDispatcher=function(){function t(){this._events=null}var e;__class(t,"laya.events.EventDispatcher");var n=t.prototype;return n.hasListener=function(t){return!(!this._events||!this._events[t])},n.event=function(t,e){if(!this._events||!this._events[t])return!1;var n=this._events[t];if(n.run)n.once&&delete this._events[t],null!=e?n.runWith(e):n.run();else{for(var i=0,r=n.length;i<r;i++){var a=n[i];a&&(null!=e?a.runWith(e):a.run()),a&&!a.once||(n.splice(i,1),i--,r--)}0===n.length&&this._events&&delete this._events[t]}return!0},n.on=function(t,e,n,i){return this._createListener(t,e,n,i,!1)},n.once=function(t,e,n,i){return this._createListener(t,e,n,i,!0)},n._createListener=function(t,n,i,r,a,s){void 0===s&&(s=!0),s&&this.off(t,n,i,a);var o=e.create(n||this,i,r,a);this._events||(this._events={});var l=this._events;return l[t]?l[t].run?l[t]=[l[t],o]:l[t].push(o):l[t]=o,this},n.off=function(t,e,n,i){if(void 0===i&&(i=!1),!this._events||!this._events[t])return this;var r=this._events[t];if(null!=n)if(r.run)e&&r.caller!==e||r.method!==n||i&&!r.once||(delete this._events[t],r.recover());else{for(var a=0,s=0,o=r.length;s<o;s++){var l=r[s];!l||e&&l.caller!==e||l.method!==n||i&&!l.once||(a++,r[s]=null,l.recover())}a===o&&delete this._events[t]}return this},n.offAll=function(t){var e=this._events;if(!e)return this;if(t)this._recoverHandlers(e[t]),delete e[t];else{for(var n in e)this._recoverHandlers(e[n]);this._events=null}return this},n._recoverHandlers=function(t){if(t)if(t.run)t.recover();else for(var e=t.length-1;e>-1;e--)t[e]&&(t[e].recover(),t[e]=null)},n.isMouseEvent=function(e){return t.MOUSE_EVENTS[e]},t.MOUSE_EVENTS={rightmousedown:!0,rightmouseup:!0,rightclick:!0,mousedown:!0,mouseup:!0,mousemove:!0,mouseover:!0,mouseout:!0,click:!0,doubleclick:!0},t.__init$=function(){Object.defineProperty(laya.events.EventDispatcher.prototype,"_events",{enumerable:!1,writable:!0}),e=function(t){function e(t,n,i,r){e.__super.call(this,t,n,i,r)}return __class(e,"",t),e.prototype.recover=function(){this._id>0&&(this._id=0,e._pool.push(this.clear()))},e.create=function(t,n,i,r){return void 0===r&&(r=!0),e._pool.length?e._pool.pop().setTo(t,n,i,r):new e(t,n,i,r)},e._pool=[],e}(Handler)},t}(),Handler=function(){function t(t,e,n,i){this.once=!1,this._id=0,void 0===i&&(i=!1),this.setTo(t,e,n,i)}__class(t,"laya.utils.Handler");var e=t.prototype;return e.setTo=function(e,n,i,r){return this._id=t._gid++,this.caller=e,this.method=n,this.args=i,this.once=r,this},e.run=function(){if(null==this.method)return null;var t=this._id,e=this.method.apply(this.caller,this.args);return this._id===t&&this.once&&this.recover(),e},e.runWith=function(t){if(null==this.method)return null;var e=this._id;if(null==t)var n=this.method.apply(this.caller,this.args);else n=this.args||t.unshift?this.args?this.method.apply(this.caller,this.args.concat(t)):this.method.apply(this.caller,t):this.method.call(this.caller,t);return this._id===e&&this.once&&this.recover(),n},e.clear=function(){return this.caller=null,this.method=null,this.args=null,this},e.recover=function(){this._id>0&&(this._id=0,t._pool.push(this.clear()))},t.create=function(e,n,i,r){return void 0===r&&(r=!0),t._pool.length?t._pool.pop().setTo(e,n,i,r):new t(e,n,i,r)},t._pool=[],t._gid=1,t}(),Graphics=function(){function t(){if(this._one=null,this._cmds=null,this._render=this._renderEmpty,Render.isConchNode){var t=this;t._nativeObj=new window._conchGraphics,t.id=t._nativeObj.conchID}}__class(t,"laya.display.Graphics");var e=t.prototype;return e.destroy=function(){this.clear(),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0),this._sp=null},e.clear=function(e){void 0===e&&(e=!1);var n=0,i=0;if(e){var r=this._one;if(this._cmds){for(i=this._cmds.length,n=0;n<i;n++)!(r=this._cmds[n])||r.callee!==Render._context._drawTexture&&r.callee!==Render._context._drawTextureWithTransform||(r[0]=null,t._cache.push(r));this._cmds.length=0}else r&&(!r||r.callee!==Render._context._drawTexture&&r.callee!==Render._context._drawTextureWithTransform||(r[0]=null,t._cache.push(r)))}else this._cmds=null;if(this._one=null,this._render=this._renderEmpty,this._sp&&(this._sp._renderType&=-514),this._repaint(),this._vectorgraphArray){for(n=0,i=this._vectorgraphArray.length;n<i;n++)VectorGraphManager.getInstance().deleteShape(this._vectorgraphArray[n]);this._vectorgraphArray.length=0}},e._clearBoundsCache=function(){this._graphicBounds&&this._graphicBounds.reset()},e._initGraphicBounds=function(){this._graphicBounds||(this._graphicBounds=new GraphicsBounds,this._graphicBounds._graphics=this)},e._repaint=function(){this._clearBoundsCache(),this._sp&&this._sp.repaint()},e._isOnlyOne=function(){return!this._cmds||0===this._cmds.length},e.getBounds=function(t){return void 0===t&&(t=!1),this._initGraphicBounds(),this._graphicBounds.getBounds(t)},e.getBoundPoints=function(t){return void 0===t&&(t=!1),this._initGraphicBounds(),this._graphicBounds.getBoundPoints(t)},e._addCmd=function(t){this._cmds=this._cmds||[],t.callee=t.shift(),this._cmds.push(t)},e.setFilters=function(t){this._saveToCmd(Render._context._setFilters,t)},e.drawTexture=function(e,n,i,r,a,s,o){if(void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=1),!e||o<.01)return null;r||(r=e.sourceWidth),a||(a=e.sourceHeight),o=o<0?0:o>1?1:o;var l=r/e.sourceWidth,h=a/e.sourceHeight;if(r=e.width*l,a=e.height*h,e.loaded&&(r<=0||a<=0))return null;n+=e.offsetX*l,i+=e.offsetY*h,this._sp&&(this._sp._renderType|=512);var _;return t._cache.length?(_=t._cache.pop(),_[0]=e,_[1]=n,_[2]=i,_[3]=r,_[4]=a,_[5]=s,_[6]=o):_=[e,n,i,r,a,s,o],_.callee=s||1!=o?Render._context._drawTextureWithTransform:Render._context._drawTexture,null!=this._one||s||1!=o?this._saveToCmd(_.callee,_):(this._one=_,this._render=this._renderOneImg),e.loaded||e.once("loaded",this,this._textureLoaded,[e,_]),this._repaint(),_},e.cleanByTexture=function(t,e,n,i,r){if(void 0===i&&(i=0),void 0===r&&(r=0),!t)return this.clear();if(this._one&&this._render===this._renderOneImg){i||(i=t.sourceWidth),r||(r=t.sourceHeight);var a=i/t.sourceWidth,s=r/t.sourceHeight;i=t.width*a,r=t.height*s,e+=t.offsetX*a,n+=t.offsetY*s,this._one[0]=t,this._one[1]=e,this._one[2]=n,this._one[3]=i,this._one[4]=r}else this.clear(),t&&this.drawTexture(t,e,n,i,r)},e.drawTextures=function(t,e){t&&this._saveToCmd(Render._context._drawTextures,[t,e])},e.fillTexture=function(t,e,n,i,r,a,s){if(void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a="repeat"),t){var o=[t,e,n,i,r,a,s||Point.EMPTY,{}];t.loaded||t.once("loaded",this,this._textureLoaded,[t,o]),this._saveToCmd(Render._context._fillTexture,o)}},e._textureLoaded=function(t,e){e[3]=e[3]||t.width,e[4]=e[4]||t.height,this._repaint()},e._saveToCmd=function(t,e){return this._sp&&(this._sp._renderType|=512),null==this._one?(this._one=e,this._render=this._renderOne):(this._sp&&(this._sp._renderType&=-2),this._render=this._renderAll,0===(this._cmds||(this._cmds=[])).length&&this._cmds.push(this._one),this._cmds.push(e)),e.callee=t,this._repaint(),e},e.clipRect=function(t,e,n,i){this._saveToCmd(Render._context._clipRect,[t,e,n,i])},e.fillText=function(t,e,n,i,r,a,s){void 0===s&&(s=0),this._saveToCmd(Render._context._fillText,[t,e,n,i||Font.defaultFont,r,a])},e.fillBorderText=function(t,e,n,i,r,a,s,o){this._saveToCmd(Render._context._fillBorderText,[t,e,n,i||Font.defaultFont,r,a,s,o])},e.strokeText=function(t,e,n,i,r,a,s){this._saveToCmd(Render._context._strokeText,[t,e,n,i||Font.defaultFont,r,a,s])},e.alpha=function(t){t=t<0?0:t>1?1:t,this._saveToCmd(Render._context._alpha,[t])},e.setAlpha=function(t){t=t<0?0:t>1?1:t,this._saveToCmd(Render._context._setAlpha,[t])},e.transform=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=0),this._saveToCmd(Render._context._transform,[t,e,n])},e.rotate=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=0),this._saveToCmd(Render._context._rotate,[t,e,n])},e.scale=function(t,e,n,i){void 0===n&&(n=0),void 0===i&&(i=0),this._saveToCmd(Render._context._scale,[t,e,n,i])},e.translate=function(t,e){this._saveToCmd(Render._context._translate,[t,e])},e.save=function(){this._saveToCmd(Render._context._save,[])},e.restore=function(){this._saveToCmd(Render._context._restore,[])},e.replaceText=function(t){this._repaint();var e=this._cmds;if(e){for(var n=e.length-1;n>-1;n--)if(this._isTextCmd(e[n].callee))return e[n][0].toUpperCase?e[n][0]=t:e[n][0].setText(t),!0}else if(this._one&&this._isTextCmd(this._one.callee))return this._one[0].toUpperCase?this._one[0]=t:this._one[0].setText(t),!0;return!1},e._isTextCmd=function(t){return t===Render._context._fillText||t===Render._context._fillBorderText||t===Render._context._strokeText},e.replaceTextColor=function(t){this._repaint();var e=this._cmds;if(e)for(var n=e.length-1;n>-1;n--)this._isTextCmd(e[n].callee)&&(e[n][4]=t,e[n][0].toUpperCase||(e[n][0].changed=!0));else this._one&&this._isTextCmd(this._one.callee)&&(this._one[4]=t,this._one[0].toUpperCase||(this._one[0].changed=!0))},e.loadImage=function(t,e,n,i,r,a){function s(t){t&&(o.drawTexture(t,e,n,i,r),null!=a&&a.call(o._sp,t))}var o=this;void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0);var l=Loader.getRes(t);l?s(l):Laya.loader.load(t,Handler.create(null,s),null,"image")},e._renderEmpty=function(t,e,n,i){},e._renderAll=function(t,e,n,i){for(var r,a=this._cmds,s=0,o=a.length;s<o;s++)(r=a[s]).callee.call(e,n,i,r)},e._renderOne=function(t,e,n,i){this._one.callee.call(e,n,i,this._one)},e._renderOneImg=function(t,e,n,i){this._one.callee.call(e,n,i,this._one),2305!==t._renderType&&(t._renderType|=1)},e.drawLine=function(t,e,n,i,r,a){void 0===a&&(a=1);var s=0;Render.isWebGL&&(s=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(s));var o=a%2==0?0:.5,l=[t+o,e+o,n+o,i+o,r,a,s];this._saveToCmd(Render._context._drawLine,l)},e.drawLines=function(t,e,n,i,r){void 0===r&&(r=1);var a=0;if(n&&!(n.length<4)){Render.isWebGL&&(a=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(a));var s=r%2==0?0:.5,o=[t+s,e+s,n,i,r,a];this._saveToCmd(Render._context._drawLines,o)}},e.drawCurves=function(t,e,n,i,r){void 0===r&&(r=1);var a=[t,e,n,i,r];this._saveToCmd(Render._context._drawCurves,a)},e.drawRect=function(t,e,n,i,r,a,s){void 0===s&&(s=1);var o=a?s/2:0,l=a?s:0,h=[t+o,e+o,n-l,i-l,r,a,s];this._saveToCmd(Render._context._drawRect,h)},e.drawCircle=function(t,e,n,i,r,a){void 0===a&&(a=1);var s=r?a/2:0,o=0;Render.isWebGL&&(o=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(o));var l=[t,e,n-s,i,r,a,o];this._saveToCmd(Render._context._drawCircle,l)},e.drawPie=function(t,e,n,i,r,a,s,o){void 0===o&&(o=1);var l=s?o/2:0,h=s?o:0,_=0;Render.isWebGL&&(_=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(_));var u=[t+l,e+l,n-h,i,r,a,s,o,_];u[3]=Utils.toRadian(i),u[4]=Utils.toRadian(r),this._saveToCmd(Render._context._drawPie,u)},e.drawPoly=function(t,e,n,i,r,a){void 0===a&&(a=1);var s=0,o=!1;Render.isWebGL&&(s=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(s),o=!(n.length>6));var l=r?a%2==0?0:.5:0,h=[t+l,e+l,n,i,r,a,s,o];this._saveToCmd(Render._context._drawPoly,h)},e.drawPath=function(t,e,n,i,r){var a=[t,e,n,i,r];this._saveToCmd(Render._context._drawPath,a)},__getset(0,e,"cmds",function(){return this._cmds},function(t){this._sp&&(this._sp._renderType|=512),this._cmds=t,this._render=this._renderAll,this._repaint()}),t.__init__=function(){if(Render.isConchNode){for(var t=laya.display.Graphics.prototype,e=Browser.window.ConchGraphics.prototype,n=["clear","destroy","alpha","rotate","transform","scale","translate","save","restore","clipRect","blendMode","fillText","fillBorderText","_fands","drawRect","drawCircle","drawPie","drawPoly","drawPath","drawImageM","drawLine","drawLines","_drawPs","drawCurves","replaceText","replaceTextColor","_fillImage","fillTexture","setSkinMesh","drawParticle","drawImageS"],i=0,r=n.length;i<=r;i++){var a=n[i];t[a]=e[a]}t._saveToCmd=null,e.drawImageS&&(t.drawTextures=function(t,e){if(t&&t.loaded&&t.bitmap&&t.source){var n=t.uv,i=t.bitmap.width,r=t.bitmap.height;this.drawImageS(t.bitmap.source,n[0]*i,n[1]*r,(n[2]-n[0])*i,(n[5]-n[3])*r,t.offsetX,t.offsetY,t.width,t.height,e)}}),t.drawTexture=function(t,e,n,i,r,a,s){if(void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===s&&(s=1),t){if(!t.loaded)return void t.once("loaded",this,function(){this.drawTexture(t,e,n,i,r,a)});if(t.loaded&&t.bitmap&&t.source&&(i||(i=t.sourceWidth),r||(r=t.sourceHeight),s=s<0?0:s>1?1:s,i=i-t.sourceWidth+t.width,r=r-t.sourceHeight+t.height,!(i<=0||r<=0))){e+=t.offsetX,n+=t.offsetY;var o=t.uv,l=t.bitmap.width,h=t.bitmap.height;this.drawImageM(t.bitmap.source,o[0]*l,o[1]*h,(o[2]-o[0])*l,(o[5]-o[3])*h,e,n,i,r,a,s),this._repaint()}}},t.fillTexture=function(t,e,n,i,r,a,s){if(void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a="repeat"),t&&t.loaded){var o,l=Render._context.ctx,h=t.bitmap.width,_=t.bitmap.height,u=t.uv;o=t.uv!=Texture.DEF_UV?l.createPattern(t.bitmap.source,a,u[0]*h,u[1]*_,(u[2]-u[0])*h,(u[5]-u[3])*_):l.createPattern(t.bitmap.source,a);var c=0,d=0;s&&(e+=s.x%t.width,n+=s.y%t.height,c-=s.x%t.width,d-=s.y%t.height),this._fillImage(o,e,n,c,d,i,r)}}}},t._cache=[],t}(),Event=function(){function t(){}__class(t,"laya.events.Event");var e=t.prototype;return e.setTo=function(t,e,n){return this.type=t,this.currentTarget=e,this.target=n,this},e.stopPropagation=function(){this._stoped=!0},__getset(0,e,"stageY",function(){return Laya.stage.mouseY}),__getset(0,e,"stageX",function(){return Laya.stage.mouseX}),__getset(0,e,"keyLocation",function(){return this.nativeEvent.keyLocation}),__getset(0,e,"charCode",function(){return this.nativeEvent.charCode}),__getset(0,e,"shiftKey",function(){return this.nativeEvent.shiftKey}),__getset(0,e,"ctrlKey",function(){return this.nativeEvent.ctrlKey}),__getset(0,e,"altKey",function(){return this.nativeEvent.altKey}),__getset(0,e,"touches",function(){var t=this.nativeEvent.touches;if(t)for(var e=Laya.stage,n=0,i=t.length;n<i;n++){var r=t[n],a=Point.TEMP;a.setTo(r.clientX,r.clientY),e._canvasTransform.invertTransformPoint(a),e.transform.invertTransformPoint(a),r.stageX=a.x,r.stageY=a.y}return t}),t.EMPTY=new t,t.MOUSE_DOWN="mousedown",t.MOUSE_UP="mouseup",t.CLICK="click",t.RIGHT_MOUSE_DOWN="rightmousedown",t.RIGHT_MOUSE_UP="rightmouseup",t.RIGHT_CLICK="rightclick",t.MOUSE_MOVE="mousemove",t.MOUSE_OVER="mouseover",t.MOUSE_OUT="mouseout",t.MOUSE_WHEEL="mousewheel",
t.ROLL_OVER="mouseover",t.ROLL_OUT="mouseout",t.DOUBLE_CLICK="doubleclick",t.CHANGE="change",t.CHANGED="changed",t.RESIZE="resize",t.ADDED="added",t.REMOVED="removed",t.DISPLAY="display",t.UNDISPLAY="undisplay",t.ERROR="error",t.COMPLETE="complete",t.LOADED="loaded",t.PROGRESS="progress",t.INPUT="input",t.RENDER="render",t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.KEY_DOWN="keydown",t.KEY_PRESS="keypress",t.KEY_UP="keyup",t.FRAME="enterframe",t.DRAG_START="dragstart",t.DRAG_MOVE="dragmove",t.DRAG_END="dragend",t.ENTER="enter",t.SELECT="select",t.BLUR="blur",t.FOCUS="focus",t.VISIBILITY_CHANGE="visibilitychange",t.FOCUS_CHANGE="focuschange",t.PLAYED="played",t.PAUSED="paused",t.STOPPED="stopped",t.START="start",t.END="end",t.ENABLE_CHANGED="enablechanged",t.ACTIVE_IN_HIERARCHY_CHANGED="activeinhierarchychanged",t.COMPONENT_ADDED="componentadded",t.COMPONENT_REMOVED="componentremoved",t.LAYER_CHANGED="layerchanged",t.HIERARCHY_LOADED="hierarchyloaded",t.RECOVERED="recovered",t.RELEASED="released",t.LINK="link",t.LABEL="label",t.FULL_SCREEN_CHANGE="fullscreenchange",t.DEVICE_LOST="devicelost",t.MESH_CHANGED="meshchanged",t.MATERIAL_CHANGED="materialchanged",t.WORLDMATRIX_NEEDCHANGE="worldmatrixneedchanged",t.ANIMATION_CHANGED="animationchanged",t.TRIGGER_ENTER="triggerenter",t.TRIGGER_STAY="triggerstay",t.TRIGGER_EXIT="triggerexit",t}(),KeyFramesContent=function(){function t(){this.startTime=NaN,this.duration=NaN,this.interpolationData=null,this.data=null,this.nextData=null}return __class(t,"laya.ani.KeyFramesContent"),t}(),AnimationParser02=function(){function t(){}return __class(t,"laya.ani.AnimationParser02"),t.READ_DATA=function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._reader.getUint16(),n=t._BLOCK.blockStarts=[],i=t._BLOCK.blockLengths=[],r=0;r<e;r++)n.push(t._reader.getUint32()),i.push(t._reader.getUint32())},t.READ_STRINGS=function(){var e=t._reader.getUint32(),n=t._reader.getUint16(),i=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;r<n;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=i},t.parse=function(e,n){t._templet=e,t._reader=n;n.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var i=0,r=t._BLOCK.count;i<r;i++){var a=n.getUint16(),s=t._strings[a],o=t["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},t.READ_ANIMATIONS=function(){var e=t._reader,n=e.__getBuffer(),i=0,r=0,a=0,s=0,o=e.getUint16(),l=[];for(l.length=o,i=0;i<o;i++)l[i]=AnimationTemplet.interpolation[e.getByte()];var h=e.getUint8();for(t._templet._anis.length=h,i=0;i<h;i++){var _=t._templet._anis[i]={};_.nodes=new Array;var u=_.name=t._strings[e.getUint16()];t._templet._aniMap[u]=i,_.bone3DMap={},_.playTime=e.getFloat32();var c=_.nodes.length=e.getInt16();for(_.totalKeyframeDatasLength=0,r=0;r<c;r++){var d=_.nodes[r]={};d.keyframeWidth=o,d.childs=[];var f=e.getUint16();f>=0&&(d.name=t._strings[f],_.bone3DMap[d.name]=r),d.keyFrame=new Array,d.parentIndex=e.getInt16(),-1==d.parentIndex?d.parent=null:d.parent=_.nodes[d.parentIndex],_.totalKeyframeDatasLength+=o,d.interpolationMethod=l,null!=d.parent&&d.parent.childs.push(d);var m=e.getUint16();d.keyFrame.length=m;var p=null,g=null;for(a=0,s=m;a<s;a++){p=d.keyFrame[a]={},p.startTime=e.getFloat32(),g&&(g.duration=p.startTime-g.startTime);var v=t._DATA.offset,x=e.getUint32(),S=4*o,T=n.slice(v+x,v+x+S);p.data=new Float32Array(T),g=p}p.duration=0,d.playTime=_.playTime,t._templet._calculateKeyFrame(d,m,o)}}},t._templet=null,t._reader=null,t._strings=[],__static(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),CanvasMeshRender=function(){function t(){this.mesh=null,this.transform=null,this.context=null,this.mode=0}__class(t,"laya.ani.bone.canvasmesh.CanvasMeshRender");var e=t.prototype;return e.renderToContext=function(t){this.context=t.ctx||t,this.mesh&&(0==this.mode?this._renderWithIndexes(this.mesh):this._renderNoIndexes(this.mesh))},e._renderNoIndexes=function(t){var e=0,n=t.vertices.length/2,i=0;for(e=0;e<n-2;e++)i=2*e,this._renderDrawTriangle(t,i,i+2,i+4)},e._renderWithIndexes=function(t){var e=t.indexes,n=0,i=e.length;for(n=0;n<i;n+=3){var r=2*e[n],a=2*e[n+1],s=2*e[n+2];this._renderDrawTriangle(t,r,a,s)}},e._renderDrawTriangle=function(t,e,n,i){var r=this.context,a=t.uvs,s=t.vertices,o=t.texture,l=o.bitmap,h=l.source,_=o.width,u=o.height,c=l.width,d=l.height,f=NaN,m=NaN,p=NaN,g=NaN,v=NaN,x=NaN;if(t.useUvTransform){var S=t.uvTransform;f=(a[e]*S.a+a[e+1]*S.c+S.tx)*c,m=(a[n]*S.a+a[n+1]*S.c+S.tx)*c,p=(a[i]*S.a+a[i+1]*S.c+S.tx)*c,g=(a[e]*S.b+a[e+1]*S.d+S.ty)*d,v=(a[n]*S.b+a[n+1]*S.d+S.ty)*d,x=(a[i]*S.b+a[i+1]*S.d+S.ty)*d}else f=a[e]*c,m=a[n]*c,p=a[i]*c,g=a[e+1]*d,v=a[n+1]*d,x=a[i+1]*d;var T=s[e],E=s[n],y=s[i],M=s[e+1],D=s[n+1],C=s[i+1];if(t.canvasPadding>0){var R=t.canvasPadding,A=t.canvasPadding,b=(T+E+y)/3,I=(M+D+C)/3,w=T-b,V=M-I,L=Math.sqrt(w*w+V*V);T=b+w/L*(L+R),M=I+V/L*(L+A),w=E-b,V=D-I,L=Math.sqrt(w*w+V*V),E=b+w/L*(L+R),D=I+V/L*(L+A),w=y-b,V=C-I,L=Math.sqrt(w*w+V*V),y=b+w/L*(L+R),C=I+V/L*(L+A)}if(r.save(),this.transform){var P=this.transform;r.transform(P.a,P.b,P.c,P.d,P.tx,P.ty)}r.beginPath(),r.moveTo(T,M),r.lineTo(E,D),r.lineTo(y,C),r.closePath(),r.clip();var N=f*v+g*p+m*x-v*p-g*m-f*x,O=1/N,F=T*v+g*y+E*x-v*y-g*E-T*x,B=f*E+T*p+m*y-E*p-T*m-f*y,U=f*v*y+g*E*p+T*m*x-T*v*p-g*m*y-f*E*x,G=M*v+g*C+D*x-v*C-g*D-M*x,H=f*D+M*p+m*C-D*p-M*m-f*C,W=f*v*C+g*D*p+M*m*x-M*v*p-g*m*C-f*D*x;r.transform(F*O,G*O,B*O,H*O,U*O,W*O),r.drawImage(h,o.uv[0]*c,o.uv[1]*d,_,u,o.uv[0]*c,o.uv[1]*d,_,u),r.restore()},t}(),MeshData=function(){function t(){this.texture=null,this.uvs=[0,0,1,0,1,1,0,1],this.vertices=[0,0,100,0,100,100,0,100],this.indexes=[0,1,3,3,1,2],this.uvTransform=null,this.useUvTransform=!1,this.canvasPadding=1}return __class(t,"laya.ani.bone.canvasmesh.MeshData"),t.prototype.getBounds=function(){return Rectangle._getWrapRec(this.vertices)},t}(),BezierLerp=function(){function t(){}return __class(t,"laya.ani.math.BezierLerp"),t.getBezierRate=function(e,n,i,r,a){var s=t._getBezierParamKey(n,i,r,a),o=100*s+e;if(t._bezierResultCache[o])return t._bezierResultCache[o];var l=t._getBezierPoints(n,i,r,a,s),h=0,_=0;for(_=l.length,h=0;h<_;h+=2)if(e<=l[h])return t._bezierResultCache[o]=l[h+1],l[h+1];return t._bezierResultCache[o]=1,1},t._getBezierParamKey=function(t,e,n,i){return 100*(100*(100*(100*t+e)+n)+i)},t._getBezierPoints=function(e,n,i,r,a){if(t._bezierPointsCache[a])return t._bezierPointsCache[a];var s;s=[0,0,e,n,i,r,1,1];var o;o=new Bezier;var l;return l=o.getBezierPoints(s,100,3),t._bezierPointsCache[a]=l,l},t._bezierResultCache={},t._bezierPointsCache={},t}(),AnimationNodeContent=function(){function t(){this.name=null,this.parentIndex=0,this.parent=null,this.keyframeWidth=0,this.lerpType=0,this.interpolationMethod=null,this.childs=null,this.keyFrame=null,this.playTime=NaN,this.extenData=null,this.dataOffset=0}return __class(t,"laya.ani.AnimationNodeContent"),t}(),AnimationParser01=function(){function t(){}return __class(t,"laya.ani.AnimationParser01"),t.parse=function(t,e){var n=e.__getBuffer(),i=0,r=0,a=0,s=0,o=0,l=0,h=0,_=e.readUTFString();t._aniClassName=_;var u,c=e.readUTFString().split("\n"),d=e.getUint8(),f=e.getUint32(),m=e.getUint32();f>0&&(u=n.slice(f,m));var p=new Byte(u);for(m>0&&(t._publicExtData=n.slice(m,n.byteLength)),t._useParent=!!e.getUint8(),t._anis.length=d,i=0;i<d;i++){var g=t._anis[i]=new AnimationContent;g.nodes=new Array;var v=g.name=c[e.getUint16()];t._aniMap[v]=i,g.bone3DMap={},g.playTime=e.getFloat32();var x=g.nodes.length=e.getUint8();for(g.totalKeyframeDatasLength=0,r=0;r<x;r++){var S=g.nodes[r]=new AnimationNodeContent;S.childs=[];var T=e.getInt16();T>=0&&(S.name=c[T],g.bone3DMap[S.name]=r),S.keyFrame=new Array,S.parentIndex=e.getInt16(),-1==S.parentIndex?S.parent=null:S.parent=g.nodes[S.parentIndex],S.lerpType=e.getUint8();var E=e.getUint32();p.pos=E;var y=S.keyframeWidth=p.getUint16();if(g.totalKeyframeDatasLength+=y,0===S.lerpType||1===S.lerpType)for(S.interpolationMethod=[],S.interpolationMethod.length=y,a=0;a<y;a++)S.interpolationMethod[a]=AnimationTemplet.interpolation[p.getUint8()];null!=S.parent&&S.parent.childs.push(S);var M=e.getUint16();M>0&&(S.extenData=n.slice(e.pos,e.pos+M),e.pos+=M);var D=e.getUint16();S.keyFrame.length=D;var C,R=0;for(a=0,s=D;a<s;a++){if(C=S.keyFrame[a]=new KeyFramesContent,C.duration=e.getFloat32(),C.startTime=R,2===S.lerpType){C.interpolationData=[];var A=e.getUint8(),b=0;switch(b=e.getFloat32()){case 254:for(C.interpolationData.length=y,h=0;h<y;h++)C.interpolationData[h]=0;break;case 255:for(C.interpolationData.length=y,h=0;h<y;h++)C.interpolationData[h]=5;break;default:for(C.interpolationData.push(b),l=1;l<A;l++)C.interpolationData.push(e.getFloat32())}}for(C.data=new Float32Array(y),o=0;o<y;o++)C.data[o]=e.getFloat32(),C.data[o]>-1e-8&&C.data[o]<1e-8&&(C.data[o]=0);R+=C.duration}C.startTime=g.playTime,S.playTime=g.playTime,t._calculateKeyFrame(S,D,y)}}},t}(),AnimationContent=function(){function t(){this.nodes=null,this.name=null,this.playTime=NaN,this.bone3DMap=null,this.totalKeyframeDatasLength=0}return __class(t,"laya.ani.AnimationContent"),t}(),AnimationState=function(){function t(){}return __class(t,"laya.ani.AnimationState"),t.stopped=0,t.paused=1,t.playing=2,t}(),URL=function(){function t(e){this._url=null,this._path=null,this._url=t.formatURL(e),this._path=t.getPath(e)}__class(t,"laya.net.URL");var e=t.prototype;return __getset(0,e,"path",function(){return this._path}),__getset(0,e,"url",function(){return this._url}),t.formatURL=function(e,n){if(!e)return"null path";if(e.indexOf(":")>0)return e;null!=t.customFormat&&(e=t.customFormat(e,n));var i=e.charAt(0);if("."===i)return t.formatRelativePath((n||t.basePath)+e);if("~"===i)return t.rootPath+e.substring(1);if("d"===i){if(0===e.indexOf("data:image"))return e}else if("/"===i)return e;return(n||t.basePath)+e},t.formatRelativePath=function(t){for(var e=t.split("/"),n=0,i=e.length;n<i;n++)".."==e[n]&&(e.splice(n-1,2),n-=2);return e.join("/")},t.isAbsolute=function(t){return t.indexOf(":")>0||"/"==t.charAt(0)},t.getPath=function(t){var e=t.lastIndexOf("/");return e>0?t.substr(0,e+1):""},t.getFileName=function(t){var e=t.lastIndexOf("/");return e>0?t.substr(e+1):t},t.version={},t.basePath="",t.rootPath="",t.customFormat=function(e){var n=t.version[e];return!Render.isConchApp&&n&&(e+="?v="+n),e},t}(),LocalStorage=function(){function t(){}var e;return __class(t,"laya.net.LocalStorage"),t.__init__=function(){t._baseClass||(t._baseClass=e,e.init()),t.items=t._baseClass.items,t.support=t._baseClass.support},t.setItem=function(e,n){t._baseClass.setItem(e,n)},t.getItem=function(e){return t._baseClass.getItem(e)},t.setJSON=function(e,n){t._baseClass.setJSON(e,n)},t.getJSON=function(e){return t._baseClass.getJSON(e)},t.removeItem=function(e){t._baseClass.removeItem(e)},t.clear=function(){t._baseClass.clear()},t._baseClass=null,t.items=null,t.support=!1,t.__init$=function(){e=function(){function t(){}return __class(t,""),t.init=function(){try{t.items=window.localStorage,t.setItem("laya","1"),t.removeItem("laya"),t.support=!0}catch(t){}t.support||console.log("LocalStorage is not supprot or browser is private mode.")},t.setItem=function(e,n){try{t.support&&t.items.setItem(e,n)}catch(t){console.warn("set localStorage failed",t)}},t.getItem=function(e){return t.support?t.items.getItem(e):null},t.setJSON=function(e,n){try{t.support&&t.items.setItem(e,JSON.stringify(n))}catch(t){console.warn("set localStorage failed",t)}},t.getJSON=function(e){return JSON.parse(t.support?t.items.getItem(e):null)},t.removeItem=function(e){t.support&&t.items.removeItem(e)},t.clear=function(){t.support&&t.items.clear()},t.items=null,t.support=!1,t}()},t}(),RenderSprite=function(){function t(e,n){switch(this._next=n||t.NORENDER,e){case 0:return void(this._fun=this._no);case 1:return void(this._fun=this._image);case 2:return void(this._fun=this._alpha);case 4:return void(this._fun=this._transform);case 8:return void(this._fun=this._blend);case 16:return void(this._fun=this._canvas);case 64:return void(this._fun=this._mask);case 128:return void(this._fun=this._clip);case 256:return void(this._fun=this._style);case 512:return void(this._fun=this._graphics);case 2048:return void(this._fun=this._childs);case 1024:return void(this._fun=this._custom);case 513:case 517:return void(this._fun=this._image2);case 32:return void(this._fun=Filter._filter);case 69905:return void(this._fun=t._initRenderFun)}this.onCreate(e)}__class(t,"laya.renders.RenderSprite");var e=t.prototype;return e.onCreate=function(t){},e._style=function(t,e,n,i){t._style.render(t,e,n,i);var r=this._next;r._fun.call(r,t,e,n,i)},e._no=function(t,e,n,i){},e._custom=function(t,e,n,i){t.customRender(e,n,i);var r=t._style._tf;this._next._fun.call(this._next,t,e,n-r.translateX,i-r.translateY)},e._clip=function(e,n,i,r){var a=this._next;if(a!=t.NORENDER){var s=e._style.scrollRect;n.ctx.save(),n.ctx.clipRect(i,r,s.width,s.height),a._fun.call(a,e,n,i-s.x,r-s.y),n.ctx.restore()}},e._blend=function(t,e,n,i){var r=t._style;r.blendMode&&(e.ctx.globalCompositeOperation=r.blendMode);var a=this._next;a._fun.call(a,t,e,n,i),e.ctx.globalCompositeOperation="source-over"},e._mask=function(t,e,n,i){var r=this._next;r._fun.call(r,t,e,n,i);var a=t.mask;a&&(e.ctx.globalCompositeOperation="destination-in",(a.numChildren>0||!a.graphics._isOnlyOne())&&(a.cacheAsBitmap=!0),a.render(e,n-t.pivotX,i-t.pivotY)),e.ctx.globalCompositeOperation="source-over"},e._graphics=function(t,e,n,i){var r=t._style._tf;t._graphics&&t._graphics._render(t,e,n-r.translateX,i-r.translateY);var a=this._next;a._fun.call(a,t,e,n,i)},e._image=function(t,e,n,i){var r=t._style;e.ctx.drawTexture2(n,i,r._tf.translateX,r._tf.translateY,t.transform,r.alpha,r.blendMode,t._graphics._one)},e._image2=function(t,e,n,i){var r=t._style._tf;e.ctx.drawTexture2(n,i,r.translateX,r.translateY,t.transform,1,null,t._graphics._one)},e._alpha=function(t,e,n,i){var r,a=t._style;if((r=a.alpha)>.01||t._needRepaint()){var s=e.ctx.globalAlpha;e.ctx.globalAlpha*=r;var o=this._next;o._fun.call(o,t,e,n,i),e.ctx.globalAlpha=s}},e._transform=function(e,n,i,r){var a=e.transform,s=this._next;a&&s!=t.NORENDER?(n.save(),n.transform(a.a,a.b,a.c,a.d,a.tx+i,a.ty+r),s._fun.call(s,e,n,0,0),n.restore()):s._fun.call(s,e,n,i,r)},e._childs=function(t,e,n,i){var r=t._style,a=r._tf;if(n=n-a.translateX+r.paddingLeft,i=i-a.translateY+r.paddingTop,r._calculation){var s=t._getWords();if(s){var o=r;o&&(o.stroke?e.fillBorderWords(s,n,i,o.font,o.color,o.strokeColor,o.stroke):e.fillWords(s,n,i,o.font,o.color,o.underLine))}}var l,h=t._childs,_=h.length;if(t.viewport||t.optimizeScrollRect&&t._style.scrollRect){var u=t.viewport||t._style.scrollRect,c=u.x,d=u.y,f=u.right,m=u.bottom,p=NaN,g=NaN;for(v=0;v<_;++v)(l=h[v]).visible&&(p=l._x)<f&&p+l.width>c&&(g=l._y)<m&&g+l.height>d&&l.render(e,n,i)}else for(var v=0;v<_;++v)(l=h[v])._style.visible&&l.render(e,n,i)},e._canvas=function(t,e,n,i){var r=t._$P.cacheCanvas;if(!r)return void this._next._fun.call(this._next,t,e,n,i);"bitmap"===r.type?Stat.canvasBitmap++:Stat.canvasNormal++;var a=r.ctx;if(t._needRepaint()||!a)this._canvas_repaint(t,e,n,i);else{var s=r._cacheRec;e.drawCanvas(a.canvas,n+s.x,i+s.y,s.width,s.height)}},e._canvas_repaint=function(t,e,n,i){var r=t._$P.cacheCanvas,a=this._next;if(!r)return void a._fun.call(a,t,_,n,i);var s,o,l,h,_=r.ctx,u=t._needRepaint()||!_,c=r.type;if("bitmap"===c?Stat.canvasBitmap++:Stat.canvasNormal++,u){r._cacheRec||(r._cacheRec=new Rectangle);var d,f;Render.isWebGL&&"bitmap"!==c?r._cacheRec.setTo(-t.pivotX,-t.pivotY,1,1):(h=t.getSelfBounds(),h.x=h.x-t.pivotX,h.y=h.y-t.pivotY,h.x=h.x-16,h.y=h.y-16,h.width=h.width+32,h.height=h.height+32,h.x=Math.floor(h.x+n)-n,h.y=Math.floor(h.y+i)-i,h.width=Math.floor(h.width),h.height=Math.floor(h.height),r._cacheRec.copyFrom(h)),h=r._cacheRec;var m=Render.isWebGL?1:Browser.pixelRatio*Laya.stage.clientScaleX,p=Render.isWebGL?1:Browser.pixelRatio*Laya.stage.clientScaleY;if(!Render.isWebGL){var g,v=1,x=1;for(g=t;g&&g!=Laya.stage;)v*=g.scaleX,x*=g.scaleY,g=g.parent;Render.isWebGL?(v<1&&(m*=v),x<1&&(p*=x)):(v>1&&(m*=v),x>1&&(p*=x))}if(t.scrollRect){var S=t.scrollRect;h.x-=S.x,h.y-=S.y}if(d=h.width*m,f=h.height*p,o=h.x,l=h.y,Render.isWebGL&&"bitmap"===c&&(d>2048||f>2048))return console.warn("cache bitmap size larger than 2048,cache ignored"),r.ctx&&(Pool.recover("RenderContext",r.ctx),r.ctx.canvas.size(0,0),r.ctx=null),void a._fun.call(a,t,e,n,i);_||(_=r.ctx=Pool.getItem("RenderContext")||new RenderContext(d,f,HTMLCanvas.create("AUTO"))),_.ctx.sprite=t,s=_.canvas,s.clear(),(s.width!=d||s.height!=f)&&s.size(d,f),"bitmap"===c?s.context.asBitmap=!0:"normal"===c&&(s.context.asBitmap=!1);var T;if(1!=m||1!=p){var E=_.ctx;E.save(),E.scale(m,p),!Render.isConchWebGL&&Render.isConchApp&&(T=t._$P.cf)&&E.setFilterMatrix&&E.setFilterMatrix(T._mat,T._alpha),a._fun.call(a,t,_,-o,-l),E.restore(),Render.isConchApp&&!Render.isConchWebGL||t._applyFilters()}else E=_.ctx,!Render.isConchWebGL&&Render.isConchApp&&(T=t._$P.cf)&&E.setFilterMatrix&&E.setFilterMatrix(T._mat,T._alpha),a._fun.call(a,t,_,-o,-l),Render.isConchApp&&!Render.isConchWebGL||t._applyFilters();t._$P.staticCache&&(r.reCache=!1),Stat.canvasReCache++}else h=r._cacheRec,o=h.x,l=h.y,s=_.canvas;e.drawCanvas(s,n+o,i+l,h.width,h.height)},t.__init__=function(){var e,n=0,i=0;for(e=RunDriver.createRenderSprite(69905,null),i=t.renders.length=4096,n=0;n<i;n++)t.renders[n]=e;t.renders[0]=RunDriver.createRenderSprite(0,null),function(e,n){for(var i=0,r=0;r<e.length;r++)i|=e[r],t.renders[i]=n}([1,512,4,2],new t(1,null)),t.renders[513]=RunDriver.createRenderSprite(513,null),t.renders[517]=new t(517,null)},t._initRenderFun=function(e,n,i,r){var a=e._renderType;(t.renders[a]=t._getTypeRender(a))._fun(e,n,i,r)},t._getTypeRender=function(t){for(var e=null,n=2048;n>1;)n&t&&(e=RunDriver.createRenderSprite(n,e)),n>>=1;return e},t.IMAGE=1,t.ALPHA=2,t.TRANSFORM=4,t.BLEND=8,t.CANVAS=16,t.FILTERS=32,t.MASK=64,t.CLIP=128,t.STYLE=256,t.GRAPHICS=512,t.CUSTOM=1024,t.CHILDS=2048,t.INIT=69905,t.renders=[],t.NORENDER=new t(0,null),t}(),Render=function(){function t(e,n){function i(){Laya.stage._loop(),Browser.window.requestAnimationFrame(i)}this._timeId=0;var r=t._mainCanvas.source.style;r.position="absolute",r.top=r.left="0px",r.background="#000000",t._mainCanvas.source.id="layaCanvas";var a=laya.renders.Render.isWebGL;t._mainCanvas.source.width=e,t._mainCanvas.source.height=n,a&&t.WebGL.init(t._mainCanvas,e,n),Browser.container.appendChild(t._mainCanvas.source),t._context=new RenderContext(e,n,a?null:t._mainCanvas),t._context.ctx.setIsMainContext(),Browser.window.requestAnimationFrame(i),Laya.stage.on("visibilitychange",this,this._onVisibilitychange)}__class(t,"laya.renders.Render");var e=t.prototype;return e._onVisibilitychange=function(){Laya.stage.isVisibility?0!=this._timeId&&Browser.window.clearInterval(this._timeId):this._timeId=Browser.window.setInterval(this._enterFrame,1e3)},e._enterFrame=function(t){Laya.stage._loop()},__getset(1,t,"canvas",function(){return t._mainCanvas.source}),__getset(1,t,"context",function(){return t._context}),t._context=null,t._mainCanvas=null,t.WebGL=null,t.isConchNode=!1,t.isConchApp=!1,t.isConchWebGL=!1,t.isWebGL=!1,t.is3DMode=!1,t.optimizeTextureMemory=function(t,e){return!0},t.__init$=function(){window.ConchRenderType=window.ConchRenderType||1,window.ConchRenderType|=window.conch?4:0,t.isConchNode=5==(5&window.ConchRenderType),t.isConchApp=4==(4&window.ConchRenderType),t.isConchWebGL=6==window.ConchRenderType},t}(),RenderContext=function(){function t(e,n,i){this.x=0,this.y=0,this._drawTexture=function(t,e,n){n[0].loaded&&this.ctx.drawTexture(n[0],n[1],n[2],n[3],n[4],t,e)},this._fillTexture=function(t,e,n){n[0].loaded&&this.ctx.fillTexture(n[0],n[1]+t,n[2]+e,n[3],n[4],n[5],n[6],n[7])},this._drawTextureWithTransform=function(t,e,n){n[0].loaded&&this.ctx.drawTextureWithTransform(n[0],n[1],n[2],n[3],n[4],n[5],t,e,n[6])},this._fillQuadrangle=function(t,e,n){this.ctx.fillQuadrangle(n[0],n[1],n[2],n[3],n[4])},this._drawRect=function(t,e,n){var i=this.ctx;null!=n[4]&&(i.fillStyle=n[4],i.fillRect(t+n[0],e+n[1],n[2],n[3],null)),null!=n[5]&&(i.strokeStyle=n[5],i.lineWidth=n[6],i.strokeRect(t+n[0],e+n[1],n[2],n[3],n[6]))},this._drawPie=function(t,e,n){var i=this.ctx;Render.isWebGL&&i.setPathId(n[8]),i.beginPath(),Render.isWebGL?(i.movePath(n[0]+t,n[1]+e),i.moveTo(0,0)):i.moveTo(t+n[0],e+n[1]),i.arc(t+n[0],e+n[1],n[2],n[3],n[4]),i.closePath(),this._fillAndStroke(n[5],n[6],n[7],!0)},this._clipRect=function(t,e,n){this.ctx.clipRect(t+n[0],e+n[1],n[2],n[3])},this._fillRect=function(t,e,n){this.ctx.fillRect(t+n[0],e+n[1],n[2],n[3],n[4])},this._drawCircle=function(e,n,i){var r=this.ctx;Render.isWebGL&&r.setPathId(i[6]),Stat.drawCall++,r.beginPath(),Render.isWebGL&&r.movePath(i[0]+e,i[1]+n),r.arc(i[0]+e,i[1]+n,i[2],0,t.PI2),r.closePath(),this._fillAndStroke(i[3],i[4],i[5],!0)},this._fillCircle=function(e,n,i){Stat.drawCall++;var r=this.ctx;r.beginPath(),r.fillStyle=i[3],r.arc(i[0]+e,i[1]+n,i[2],0,t.PI2),r.fill()},this._setShader=function(t,e,n){this.ctx.setShader(n[0])},this._drawLine=function(t,e,n){var i=this.ctx;Render.isWebGL&&i.setPathId(n[6]),i.beginPath(),i.strokeStyle=n[4],i.lineWidth=n[5],Render.isWebGL?(i.movePath(t,e),i.moveTo(n[0],n[1]),i.lineTo(n[2],n[3])):(i.moveTo(t+n[0],e+n[1]),i.lineTo(t+n[2],e+n[3])),i.stroke()},this._drawLines=function(t,e,n){var i=this.ctx;Render.isWebGL&&i.setPathId(n[5]),i.beginPath(),t+=n[0],e+=n[1],Render.isWebGL&&i.movePath(t,e),i.strokeStyle=n[3],i.lineWidth=n[4];var r=n[2],a=2,s=r.length;if(Render.isWebGL)for(i.moveTo(r[0],r[1]);a<s;)i.lineTo(r[a++],r[a++]);else for(i.moveTo(t+r[0],e+r[1]);a<s;)i.lineTo(t+r[a++],e+r[a++]);i.stroke()},this._drawLinesWebGL=function(t,e,n){this.ctx.drawLines(t+this.x+n[0],e+this.y+n[1],n[2],n[3],n[4])},this._drawCurves=function(t,e,n){this.ctx.drawCurves(t,e,n)},this._draw=function(t,e,n){n[0].call(null,this,t,e)},this._transformByMatrix=function(t,e,n){this.ctx.transformByMatrix(n[0])},this._setTransform=function(t,e,n){this.ctx.setTransform(n[0],n[1],n[2],n[3],n[4],n[5])},this._setTransformByMatrix=function(t,e,n){this.ctx.setTransformByMatrix(n[0])},this._save=function(t,e,n){this.ctx.save()},this._restore=function(t,e,n){this.ctx.restore()},this._translate=function(t,e,n){this.ctx.translate(n[0],n[1])},this._transform=function(t,e,n){this.ctx.translate(n[1]+t,n[2]+e);var i=n[0];this.ctx.transform(i.a,i.b,i.c,i.d,i.tx,i.ty),this.ctx.translate(-t-n[1],-e-n[2])},this._rotate=function(t,e,n){this.ctx.translate(n[1]+t,n[2]+e),this.ctx.rotate(n[0]),this.ctx.translate(-t-n[1],-e-n[2])},this._scale=function(t,e,n){this.ctx.translate(n[2]+t,n[3]+e),this.ctx.scale(n[0],n[1]),this.ctx.translate(-t-n[2],-e-n[3])},this._alpha=function(t,e,n){this.ctx.globalAlpha*=n[0]},this._setAlpha=function(t,e,n){this.ctx.globalAlpha=n[0]},this._fillText=function(t,e,n){this.ctx.fillText(n[0],n[1]+t,n[2]+e,n[3],n[4],n[5])},this._strokeText=function(t,e,n){this.ctx.strokeText(n[0],n[1]+t,n[2]+e,n[3],n[4],n[5],n[6])},this._fillBorderText=function(t,e,n){this.ctx.fillBorderText(n[0],n[1]+t,n[2]+e,n[3],n[4],n[5],n[6],n[7])},this._blendMode=function(t,e,n){this.ctx.globalCompositeOperation=n[0]},this._beginClip=function(t,e,n){this.ctx.beginClip&&this.ctx.beginClip(t+n[0],e+n[1],n[2],n[3])},this._setIBVB=function(t,e,n){this.ctx.setIBVB(n[0]+t,n[1]+e,n[2],n[3],n[4],n[5],n[6],n[7])},this._fillTrangles=function(t,e,n){this.ctx.fillTrangles(n[0],n[1]+t,n[2]+e,n[3],n[4])},this._drawPath=function(t,e,n){var i=this.ctx;Render.isWebGL&&i.setPathId(-1),i.beginPath(),t+=n[0],e+=n[1],Render.isWebGL&&i.movePath(t,e);for(var r=n[2],a=0,s=r.length;a<s;a++){var o=r[a];switch(o[0]){case"moveTo":Render.isWebGL?i.moveTo(o[1],o[2]):i.moveTo(t+o[1],e+o[2]);break;case"lineTo":Render.isWebGL?i.lineTo(o[1],o[2]):i.lineTo(t+o[1],e+o[2]);break;case"arcTo":Render.isWebGL?i.arcTo(o[1],o[2],o[3],o[4],o[5]):i.arcTo(t+o[1],e+o[2],t+o[3],e+o[4],o[5]);break;case"closePath":i.closePath()}}var l=n[3];null!=l&&(i.fillStyle=l.fillStyle,i.fill());var h=n[4];null!=h&&(i.strokeStyle=h.strokeStyle,i.lineWidth=h.lineWidth||1,i.lineJoin=h.lineJoin,i.lineCap=h.lineCap,i.miterLimit=h.miterLimit,i.stroke())},this.drawPoly=function(t,e,n){this.ctx.drawPoly(t+this.x+n[0],e+this.y+n[1],n[2],n[3],n[4],n[5],n[6])},this._drawPoly=function(t,e,n){var i=this.ctx,r=n[2],a=2,s=r.length;if(Render.isWebGL)for(i.setPathId(n[6]),i.beginPath(),t+=n[0],e+=n[1],i.movePath(t,e),i.moveTo(r[0],r[1]);a<s;)i.lineTo(r[a++],r[a++]);else for(i.beginPath(),t+=n[0],e+=n[1],i.moveTo(t+r[0],e+r[1]);a<s;)i.lineTo(t+r[a++],e+r[a++]);i.closePath(),this._fillAndStroke(n[3],n[4],n[5],n[7])},this._drawSkin=function(t,e,n){var i=n[0];if(i){var r=this.ctx;i.render(r,t,e)}},this._drawParticle=function(t,e,n){this.ctx.drawParticle(t+this.x,e+this.y,n[0])},this._setFilters=function(t,e,n){this.ctx.setFilters(n)},i?this.ctx=i.getContext("2d"):(i=HTMLCanvas.create("3D"),this.ctx=RunDriver.createWebGLContext2D(i),i._setContext(this.ctx)),i.size(e,n),this.canvas=i}__class(t,"laya.renders.RenderContext");var e=t.prototype;return e.destroy=function(){this.canvas&&(this.canvas.destroy(),this.canvas=null,this.ctx=null),this.ctx&&(this.ctx.destroy(),this.ctx=null)},e.drawTexture=function(t,e,n,i,r){t.loaded&&this.ctx.drawTexture(t,e,n,i,r,this.x,this.y)},e._drawTextures=function(t,e,n){n[0].loaded&&this.ctx.drawTextures(n[0],n[1],t+this.x,e+this.y)},e.drawTextureWithTransform=function(t,e,n,i,r,a,s){t.loaded&&this.ctx.drawTextureWithTransform(t,e,n,i,r,a,this.x,this.y,s)},e.fillQuadrangle=function(t,e,n,i,r){this.ctx.fillQuadrangle(t,e,n,i,r)},e.drawCanvas=function(t,e,n,i,r){this.ctx.drawCanvas(t,e+this.x,n+this.y,i,r)},e.drawRect=function(t,e,n,i,r,a){void 0===a&&(a=1);var s=this.ctx;s.strokeStyle=r,s.lineWidth=a,s.strokeRect(t+this.x,e+this.y,n,i,a)},e._fillAndStroke=function(t,e,n,i){void 0===i&&(i=!1);var r=this.ctx;null!=t&&(r.fillStyle=t,Render.isWebGL?r.fill(i):r.fill()),null!=e&&n>0&&(r.strokeStyle=e,r.lineWidth=n,r.stroke())},e.clipRect=function(t,e,n,i){this.ctx.clipRect(t+this.x,e+this.y,n,i)},e.fillRect=function(t,e,n,i,r){this.ctx.fillRect(t+this.x,e+this.y,n,i,r)},e.drawCircle=function(e,n,i,r,a){void 0===a&&(a=1),Stat.drawCall++;var s=this.ctx;s.beginPath(),s.strokeStyle=r,s.lineWidth=a,s.arc(e+this.x,n+this.y,i,0,t.PI2),s.stroke()},e.fillCircle=function(e,n,i,r){Stat.drawCall++;var a=this.ctx;a.beginPath(),a.fillStyle=r,a.arc(e+this.x,n+this.y,i,0,t.PI2),a.fill()},e.setShader=function(t){this.ctx.setShader(t)},e.drawLine=function(t,e,n,i,r,a){void 0===a&&(a=1);var s=this.ctx;s.beginPath(),s.strokeStyle=r,s.lineWidth=a,s.moveTo(this.x+t,this.y+e),s.lineTo(this.x+n,this.y+i),s.stroke()},e.clear=function(){this.ctx.clear()},e.transformByMatrix=function(t){this.ctx.transformByMatrix(t)},e.setTransform=function(t,e,n,i,r,a){this.ctx.setTransform(t,e,n,i,r,a)},e.setTransformByMatrix=function(t){this.ctx.setTransformByMatrix(t)},e.save=function(){this.ctx.save()},e.restore=function(){this.ctx.restore()},e.translate=function(t,e){this.ctx.translate(t,e)},e.transform=function(t,e,n,i,r,a){this.ctx.transform(t,e,n,i,r,a)},e.rotate=function(t){this.ctx.rotate(t)},e.scale=function(t,e){this.ctx.scale(t,e)},e.alpha=function(t){this.ctx.globalAlpha*=t},e.setAlpha=function(t){this.ctx.globalAlpha=t},e.fillWords=function(t,e,n,i,r,a){void 0===a&&(a=0),this.ctx.fillWords(t,e,n,i,r,a)},e.fillBorderWords=function(t,e,n,i,r,a,s){this.ctx.fillBorderWords(t,e,n,i,r,a,s)},e.fillText=function(t,e,n,i,r,a){this.ctx.fillText(t,e+this.x,n+this.y,i,r,a)},e.strokeText=function(t,e,n,i,r,a,s){this.ctx.strokeText(t,e+this.x,n+this.y,i,r,a,s)},e.blendMode=function(t){this.ctx.globalCompositeOperation=t},e.flush=function(){this.ctx.flush&&this.ctx.flush()},e.addRenderObject=function(t){this.ctx.addRenderObject(t)},e.beginClip=function(t,e,n,i){this.ctx.beginClip&&this.ctx.beginClip(t,e,n,i)},e.endClip=function(){this.ctx.endClip&&this.ctx.endClip()},e.fillTrangles=function(t,e,n){this.ctx.fillTrangles(n[0],n[1],n[2],n[3],n.length>4?n[4]:null)},t.PI2=2*Math.PI,t}(),WebGLContext=function(){function t(){}return __class(t,"laya.webgl.WebGLContext"),t.UseProgram=function(e){return t._useProgram!==e&&(WebGL.mainContext.useProgram(e),t._useProgram=e,!0)},t.setDepthTest=function(e,n){n!==t._depthTest&&(t._depthTest=n,n?e.enable(2929):e.disable(2929))},t.setDepthMask=function(e,n){n!==t._depthMask&&(t._depthMask=n,e.depthMask(n))},t.setDepthFunc=function(e,n){n!==t._depthFunc&&(t._depthFunc=n,e.depthFunc(n))},t.setBlend=function(e,n){n!==t._blend&&(t._blend=n,n?e.enable(3042):e.disable(3042))},t.setBlendFunc=function(e,n,i){(n!==t._sFactor||i!==t._dFactor)&&(t._sFactor=n,t._dFactor=i,e.blendFunc(n,i))},t.setCullFace=function(e,n){n!==t._cullFace&&(t._cullFace=n,n?e.enable(2884):e.disable(2884))},t.setFrontFace=function(e,n){n!==t._frontFace&&(t._frontFace=n,e.frontFace(n))},t.bindTexture=function(e,n,i){e.bindTexture(n,i),t.curBindTexTarget=n,t.curBindTexValue=i},t.DEPTH_BUFFER_BIT=256,t.STENCIL_BUFFER_BIT=1024,t.COLOR_BUFFER_BIT=16384,t.POINTS=0,t.LINES=1,t.LINE_LOOP=2,t.LINE_STRIP=3,t.TRIANGLES=4,t.TRIANGLE_STRIP=5,t.TRIANGLE_FAN=6,t.ZERO=0,t.ONE=1,t.SRC_COLOR=768,t.ONE_MINUS_SRC_COLOR=769,t.SRC_ALPHA=770,t.ONE_MINUS_SRC_ALPHA=771,t.DST_ALPHA=772,t.ONE_MINUS_DST_ALPHA=773,t.DST_COLOR=774,t.ONE_MINUS_DST_COLOR=775,t.SRC_ALPHA_SATURATE=776,t.FUNC_ADD=32774,t.BLEND_EQUATION=32777,t.BLEND_EQUATION_RGB=32777,t.BLEND_EQUATION_ALPHA=34877,t.FUNC_SUBTRACT=32778,t.FUNC_REVERSE_SUBTRACT=32779,t.BLEND_DST_RGB=32968,t.BLEND_SRC_RGB=32969,t.BLEND_DST_ALPHA=32970,t.BLEND_SRC_ALPHA=32971,t.CONSTANT_COLOR=32769,t.ONE_MINUS_CONSTANT_COLOR=32770,t.CONSTANT_ALPHA=32771,t.ONE_MINUS_CONSTANT_ALPHA=32772,t.BLEND_COLOR=32773,t.ARRAY_BUFFER=34962,t.ELEMENT_ARRAY_BUFFER=34963,t.ARRAY_BUFFER_BINDING=34964,t.ELEMENT_ARRAY_BUFFER_BINDING=34965,t.STREAM_DRAW=35040,t.STATIC_DRAW=35044,t.DYNAMIC_DRAW=35048,t.BUFFER_SIZE=34660,t.BUFFER_USAGE=34661,t.CURRENT_VERTEX_ATTRIB=34342,t.FRONT=1028,t.BACK=1029,t.CULL_FACE=2884,t.FRONT_AND_BACK=1032,t.BLEND=3042,t.DITHER=3024,t.STENCIL_TEST=2960,t.DEPTH_TEST=2929,t.SCISSOR_TEST=3089,t.POLYGON_OFFSET_FILL=32823,t.SAMPLE_ALPHA_TO_COVERAGE=32926,t.SAMPLE_COVERAGE=32928,t.NO_ERROR=0,t.INVALID_ENUM=1280,t.INVALID_VALUE=1281,t.INVALID_OPERATION=1282,t.OUT_OF_MEMORY=1285,t.CW=2304,t.CCW=2305,t.LINE_WIDTH=2849,t.ALIASED_POINT_SIZE_RANGE=33901,t.ALIASED_LINE_WIDTH_RANGE=33902,t.CULL_FACE_MODE=2885,t.FRONT_FACE=2886,t.DEPTH_RANGE=2928,t.DEPTH_WRITEMASK=2930,t.DEPTH_CLEAR_VALUE=2931,t.DEPTH_FUNC=2932,t.STENCIL_CLEAR_VALUE=2961,t.STENCIL_FUNC=2962,t.STENCIL_FAIL=2964,t.STENCIL_PASS_DEPTH_FAIL=2965,t.STENCIL_PASS_DEPTH_PASS=2966,t.STENCIL_REF=2967,t.STENCIL_VALUE_MASK=2963,t.STENCIL_WRITEMASK=2968,t.STENCIL_BACK_FUNC=34816,t.STENCIL_BACK_FAIL=34817,t.STENCIL_BACK_PASS_DEPTH_FAIL=34818,t.STENCIL_BACK_PASS_DEPTH_PASS=34819,t.STENCIL_BACK_REF=36003,t.STENCIL_BACK_VALUE_MASK=36004,t.STENCIL_BACK_WRITEMASK=36005,t.VIEWPORT=2978,t.SCISSOR_BOX=3088,t.COLOR_CLEAR_VALUE=3106,t.COLOR_WRITEMASK=3107,t.UNPACK_ALIGNMENT=3317,t.PACK_ALIGNMENT=3333,t.MAX_TEXTURE_SIZE=3379,t.MAX_VIEWPORT_DIMS=3386,t.SUBPIXEL_BITS=3408,t.RED_BITS=3410,t.GREEN_BITS=3411,t.BLUE_BITS=3412,t.ALPHA_BITS=3413,t.DEPTH_BITS=3414,t.STENCIL_BITS=3415,t.POLYGON_OFFSET_UNITS=10752,t.POLYGON_OFFSET_FACTOR=32824,t.TEXTURE_BINDING_2D=32873,t.SAMPLE_BUFFERS=32936,t.SAMPLES=32937,t.SAMPLE_COVERAGE_VALUE=32938,t.SAMPLE_COVERAGE_INVERT=32939,t.NUM_COMPRESSED_TEXTURE_FORMATS=34466,t.COMPRESSED_TEXTURE_FORMATS=34467,t.DONT_CARE=4352,t.FASTEST=4353,t.NICEST=4354,t.GENERATE_MIPMAP_HINT=33170,t.BYTE=5120,t.UNSIGNED_BYTE=5121,t.SHORT=5122,t.UNSIGNED_SHORT=5123,t.INT=5124,t.UNSIGNED_INT=5125,t.FLOAT=5126,t.DEPTH_COMPONENT=6402,t.ALPHA=6406,t.RGB=6407,t.RGBA=6408,t.LUMINANCE=6409,t.LUMINANCE_ALPHA=6410,t.UNSIGNED_SHORT_4_4_4_4=32819,t.UNSIGNED_SHORT_5_5_5_1=32820,t.UNSIGNED_SHORT_5_6_5=33635,
t.FRAGMENT_SHADER=35632,t.VERTEX_SHADER=35633,t.MAX_VERTEX_ATTRIBS=34921,t.MAX_VERTEX_UNIFORM_VECTORS=36347,t.MAX_VARYING_VECTORS=36348,t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661,t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660,t.MAX_TEXTURE_IMAGE_UNITS=34930,t.MAX_FRAGMENT_UNIFORM_VECTORS=36349,t.SHADER_TYPE=35663,t.DELETE_STATUS=35712,t.LINK_STATUS=35714,t.VALIDATE_STATUS=35715,t.ATTACHED_SHADERS=35717,t.ACTIVE_UNIFORMS=35718,t.ACTIVE_ATTRIBUTES=35721,t.SHADING_LANGUAGE_VERSION=35724,t.CURRENT_PROGRAM=35725,t.NEVER=512,t.LESS=513,t.EQUAL=514,t.LEQUAL=515,t.GREATER=516,t.NOTEQUAL=517,t.GEQUAL=518,t.ALWAYS=519,t.KEEP=7680,t.REPLACE=7681,t.INCR=7682,t.DECR=7683,t.INVERT=5386,t.INCR_WRAP=34055,t.DECR_WRAP=34056,t.VENDOR=7936,t.RENDERER=7937,t.VERSION=7938,t.NEAREST=9728,t.LINEAR=9729,t.NEAREST_MIPMAP_NEAREST=9984,t.LINEAR_MIPMAP_NEAREST=9985,t.NEAREST_MIPMAP_LINEAR=9986,t.LINEAR_MIPMAP_LINEAR=9987,t.TEXTURE_MAG_FILTER=10240,t.TEXTURE_MIN_FILTER=10241,t.TEXTURE_WRAP_S=10242,t.TEXTURE_WRAP_T=10243,t.TEXTURE_2D=3553,t.TEXTURE=5890,t.TEXTURE_CUBE_MAP=34067,t.TEXTURE_BINDING_CUBE_MAP=34068,t.TEXTURE_CUBE_MAP_POSITIVE_X=34069,t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070,t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071,t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072,t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073,t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074,t.MAX_CUBE_MAP_TEXTURE_SIZE=34076,t.TEXTURE0=33984,t.TEXTURE1=33985,t.TEXTURE2=33986,t.TEXTURE3=33987,t.TEXTURE4=33988,t.TEXTURE5=33989,t.TEXTURE6=33990,t.TEXTURE7=33991,t.TEXTURE8=33992,t.TEXTURE9=33993,t.TEXTURE10=33994,t.TEXTURE11=33995,t.TEXTURE12=33996,t.TEXTURE13=33997,t.TEXTURE14=33998,t.TEXTURE15=33999,t.TEXTURE16=34e3,t.TEXTURE17=34001,t.TEXTURE18=34002,t.TEXTURE19=34003,t.TEXTURE20=34004,t.TEXTURE21=34005,t.TEXTURE22=34006,t.TEXTURE23=34007,t.TEXTURE24=34008,t.TEXTURE25=34009,t.TEXTURE26=34010,t.TEXTURE27=34011,t.TEXTURE28=34012,t.TEXTURE29=34013,t.TEXTURE30=34014,t.TEXTURE31=34015,t.ACTIVE_TEXTURE=34016,t.REPEAT=10497,t.CLAMP_TO_EDGE=33071,t.MIRRORED_REPEAT=33648,t.FLOAT_VEC2=35664,t.FLOAT_VEC3=35665,t.FLOAT_VEC4=35666,t.INT_VEC2=35667,t.INT_VEC3=35668,t.INT_VEC4=35669,t.BOOL=35670,t.BOOL_VEC2=35671,t.BOOL_VEC3=35672,t.BOOL_VEC4=35673,t.FLOAT_MAT2=35674,t.FLOAT_MAT3=35675,t.FLOAT_MAT4=35676,t.SAMPLER_2D=35678,t.SAMPLER_CUBE=35680,t.VERTEX_ATTRIB_ARRAY_ENABLED=34338,t.VERTEX_ATTRIB_ARRAY_SIZE=34339,t.VERTEX_ATTRIB_ARRAY_STRIDE=34340,t.VERTEX_ATTRIB_ARRAY_TYPE=34341,t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922,t.VERTEX_ATTRIB_ARRAY_POINTER=34373,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975,t.COMPILE_STATUS=35713,t.LOW_FLOAT=36336,t.MEDIUM_FLOAT=36337,t.HIGH_FLOAT=36338,t.LOW_INT=36339,t.MEDIUM_INT=36340,t.HIGH_INT=36341,t.FRAMEBUFFER=36160,t.RENDERBUFFER=36161,t.RGBA4=32854,t.RGB5_A1=32855,t.RGB565=36194,t.DEPTH_COMPONENT16=33189,t.STENCIL_INDEX=6401,t.STENCIL_INDEX8=36168,t.DEPTH_STENCIL=34041,t.RENDERBUFFER_WIDTH=36162,t.RENDERBUFFER_HEIGHT=36163,t.RENDERBUFFER_INTERNAL_FORMAT=36164,t.RENDERBUFFER_RED_SIZE=36176,t.RENDERBUFFER_GREEN_SIZE=36177,t.RENDERBUFFER_BLUE_SIZE=36178,t.RENDERBUFFER_ALPHA_SIZE=36179,t.RENDERBUFFER_DEPTH_SIZE=36180,t.RENDERBUFFER_STENCIL_SIZE=36181,t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048,t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049,t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050,t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051,t.COLOR_ATTACHMENT0=36064,t.DEPTH_ATTACHMENT=36096,t.STENCIL_ATTACHMENT=36128,t.DEPTH_STENCIL_ATTACHMENT=33306,t.NONE=0,t.FRAMEBUFFER_COMPLETE=36053,t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054,t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055,t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057,t.FRAMEBUFFER_UNSUPPORTED=36061,t.FRAMEBUFFER_BINDING=36006,t.RENDERBUFFER_BINDING=36007,t.MAX_RENDERBUFFER_SIZE=34024,t.INVALID_FRAMEBUFFER_OPERATION=1286,t.UNPACK_FLIP_Y_WEBGL=37440,t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441,t.CONTEXT_LOST_WEBGL=37442,t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443,t.BROWSER_DEFAULT_WEBGL=37444,t._useProgram=null,t._depthTest=!0,t._depthMask=!0,t._depthFunc=513,t._blend=!1,t._sFactor=1,t._dFactor=0,t._cullFace=!1,t._frontFace=2305,t.curBindTexTarget=null,t.curBindTexValue=null,t}(),SubmitCMD=function(){function t(){this.fun=null,this.args=null}__class(t,"laya.webgl.submit.SubmitCMD");var e=t.prototype;return Laya.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){return this.fun.apply(null,this.args),1},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},t.create=function(e,n){var i=t._cache._length?t._cache[--t._cache._length]:new t;return i.fun=n,i.args=e,i},t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),SubmitOtherIBVB=function(){function t(){this.offset=0,this.startIndex=0,this._mat=Matrix.create()}__class(t,"laya.webgl.submit.SubmitOtherIBVB");var e=t.prototype;return Laya.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.releaseRender=function(){var e=t._cache;e[e._length++]=this},e.getRenderType=function(){return 10009},e.renderSubmit=function(){var e=this._shaderValue.textureHost;if(e){var n=e.source;if(!e.bitmap||!n)return 1;this._shaderValue.texture=n}this._vb.bind_upload(this._ib);var i=RenderState2D.worldMatrix4,r=Matrix.TEMP;Matrix.mulPre(this._mat,i[0],i[1],i[4],i[5],i[12],i[13],r);var a=RenderState2D.worldMatrix4=t.tempMatrix4;a[0]=r.a,a[1]=r.b,a[4]=r.c,a[5]=r.d,a[12]=r.tx,a[13]=r.ty,this._shader._offset=this.offset,this._shaderValue.refresh(),this._shader.upload(this._shaderValue),this._shader._offset=0;var s=WebGL.mainContext;return BlendMode.activeBlendFunction!==this._blendFn&&(s.enable(3042),this._blendFn(s),BlendMode.activeBlendFunction=this._blendFn),Stat.drawCall++,Stat.trianglesFaces+=this._numEle/3,s.drawElements(4,this._numEle,5123,this.startIndex),RenderState2D.worldMatrix4=i,BaseShader.activeShader=null,1},t.create=function(e,n,i,r,a,s,o,l,h){void 0===h&&(h=0);var _=t._cache._length?t._cache[--t._cache._length]:new t;_._ib=i,_._vb=n,_._numEle=r,_._shader=a,_._shaderValue=s;var u=e._nBlendType;switch(_._blendFn=e._targets?BlendMode.targetFns[u]:BlendMode.fns[u],h){case 0:_.offset=0,_.startIndex=l/(CONST3D2D.BYTES_PE*n.vertexStride)*1.5,_.startIndex*=CONST3D2D.BYTES_PIDX;break;case 1:_.startIndex=o,_.offset=l}return _},t._cache=(t._cache=[],t._cache._length=0,t._cache),t.tempMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t}(),SubmitScissor=function(){function t(){this.submitIndex=0,this.submitLength=0,this.context=null,this.clipRect=new Rectangle,this.screenRect=new Rectangle}__class(t,"laya.webgl.submit.SubmitScissor");var e=t.prototype;return Laya.imps(e,{"laya.webgl.submit.ISubmit":!0}),e._scissor=function(t,e,n,i){var r=RenderState2D.worldMatrix4,a=r[0],s=r[5],o=r[12],l=r[13];if(t=t*a+o,e=e*s+l,n*=a,i*=s,n<1||i<1)return!1;var h=t+n,_=e+i;t<0&&(t=0,n=h-t),e<0&&(e=0,i=_-e);var u=RenderState2D.worldClipRect;if(t=Math.max(t,u.x),e=Math.max(e,u.y),n=Math.min(h,u.right)-t,i=Math.min(_,u.bottom)-e,n<1||i<1)return!1;var c=RenderState2D.worldScissorTest;return this.screenRect.copyFrom(u),u.x=t,u.y=e,u.width=n,u.height=i,RenderState2D.worldScissorTest=!0,e=RenderState2D.height-e-i,WebGL.mainContext.scissor(t,e,n,i),WebGL.mainContext.enable(3089),this.context.submitElement(this.submitIndex,this.submitIndex+this.submitLength),c?(e=RenderState2D.height-this.screenRect.y-this.screenRect.height,WebGL.mainContext.scissor(this.screenRect.x,e,this.screenRect.width,this.screenRect.height),WebGL.mainContext.enable(3089)):(WebGL.mainContext.disable(3089),RenderState2D.worldScissorTest=!1),u.copyFrom(this.screenRect),!0},e._scissorWithTagart=function(t,e,n,i){if(n<1||i<1)return!1;var r=t+n,a=e+i;t<0&&(t=0,n=r-t),e<0&&(e=0,i=a-e);var s=RenderState2D.worldClipRect;if(t=Math.max(t,s.x),e=Math.max(e,s.y),n=Math.min(r,s.right)-t,i=Math.min(a,s.bottom)-e,n<1||i<1)return!1;var o=RenderState2D.worldScissorTest;return this.screenRect.copyFrom(s),RenderState2D.worldScissorTest=!0,s.x=t,s.y=e,s.width=n,s.height=i,e=RenderState2D.height-e-i,WebGL.mainContext.scissor(t,e,n,i),WebGL.mainContext.enable(3089),this.context.submitElement(this.submitIndex,this.submitIndex+this.submitLength),o?(e=RenderState2D.height-this.screenRect.y-this.screenRect.height,WebGL.mainContext.scissor(this.screenRect.x,e,this.screenRect.width,this.screenRect.height),WebGL.mainContext.enable(3089)):(WebGL.mainContext.disable(3089),RenderState2D.worldScissorTest=!1),s.copyFrom(this.screenRect),!0},e.renderSubmit=function(){return this.submitLength=Math.min(this.context._submits._length-1,this.submitLength),this.submitLength<1||this.clipRect.width<1||this.clipRect.height<1?this.submitLength+1:(this.context._targets?this._scissorWithTagart(this.clipRect.x,this.clipRect.y,this.clipRect.width,this.clipRect.height):this._scissor(this.clipRect.x,this.clipRect.y,this.clipRect.width,this.clipRect.height),this.submitLength+1)},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this,this.context=null},t.create=function(e){var n=t._cache._length?t._cache[--t._cache._length]:new t;return n.context=e,n},t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),SubmitStencil=function(){function t(){this.step=0,this.blendMode=null,this.level=0}__class(t,"laya.webgl.submit.SubmitStencil");var e=t.prototype;return Laya.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){switch(this.step){case 1:this.do1();break;case 2:this.do2();break;case 3:this.do3();break;case 4:this.do4();break;case 5:this.do5();break;case 6:this.do6();break;case 7:this.do7();break;case 8:this.do8()}return 1},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},e.do1=function(){var t=WebGL.mainContext;t.enable(2960),t.clear(1024),t.colorMask(!1,!1,!1,!1),t.stencilFunc(514,this.level,255),t.stencilOp(7680,7680,7682)},e.do2=function(){var t=WebGL.mainContext;t.stencilFunc(514,this.level+1,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680)},e.do3=function(){var t=WebGL.mainContext;t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680),t.clear(1024),t.disable(2960)},e.do4=function(){var t=WebGL.mainContext;0==this.level&&(t.enable(2960),t.clear(1024)),t.colorMask(!1,!1,!1,!1),t.stencilFunc(519,0,255),t.stencilOp(7680,7680,7682)},e.do5=function(){var t=WebGL.mainContext;t.stencilFunc(514,this.level,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680)},e.do6=function(){var t=WebGL.mainContext;BlendMode.targetFns[BlendMode.TOINT[this.blendMode]](t)},e.do7=function(){var t=WebGL.mainContext;t.colorMask(!1,!1,!1,!1),t.stencilOp(7680,7680,7683)},e.do8=function(){var t=WebGL.mainContext;t.colorMask(!0,!0,!0,!0),t.stencilFunc(514,this.level,255),t.stencilOp(7680,7680,7680)},t.restore=function(e,n,i,r,a){var s;if(e._renderKey=0,t._mask>0&&t._mask--,0==t._mask)s=laya.webgl.submit.SubmitStencil.create(3),e.addRenderObject(s),e._curSubmit=Submit.RENDERBASE;else{s=laya.webgl.submit.SubmitStencil.create(7),e.addRenderObject(s);var o=e._vb;o._byteLength;if(GlUtils.fillRectImgVb(o,null,n.x,n.y,n.width,n.height,Texture.DEF_UV,i,r,a,0,0)){e._shader2D.glTexture=null;var l=e._curSubmit=Submit.createSubmit(e,e._ib,o,(o._byteLength-64)/32*3,Value2D.create(2,0));l.shaderValue.ALPHA=1,e._submits[e._submits._length++]=l,e._curSubmit._numEle+=6,e._curSubmit=Submit.RENDERBASE}else alert("clipRect calc stencil rect error");s=laya.webgl.submit.SubmitStencil.create(8),e.addRenderObject(s)}},t.restore2=function(e,n){var i;e._renderKey=0,t._mask>0&&t._mask--,0==t._mask?(i=laya.webgl.submit.SubmitStencil.create(3),e.addRenderObject(i),e._curSubmit=Submit.RENDERBASE):(i=laya.webgl.submit.SubmitStencil.create(7),e.addRenderObject(i),e._submits[e._submits._length++]=n,i=laya.webgl.submit.SubmitStencil.create(8),e.addRenderObject(i))},t.create=function(e){var n=t._cache._length?t._cache[--t._cache._length]:new t;return n.step=e,5==e&&++t._mask,n.level=t._mask,n},t._cache=(t._cache=[],t._cache._length=0,t._cache),t._mask=0,t}(),SubmitTarget=function(){function t(){this._renderType=0,this._vb=null,this._ib=null,this._startIdx=0,this._numEle=0,this.shaderValue=null,this.blendType=0,this.proName=null,this.scope=null}__class(t,"laya.webgl.submit.SubmitTarget");var e=t.prototype;return Laya.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){this._vb.bind_upload(this._ib);var t=this.scope.getValue(this.proName);return t&&(this.shaderValue.texture=t.source,this.shaderValue.strength&&!this.shaderValue.blurInfo&&(this.shaderValue.blurInfo=[t.width,t.height]),this.shaderValue.upload(),this.blend(),Stat.drawCall++,Stat.trianglesFaces+=this._numEle/3,WebGL.mainContext.drawElements(4,this._numEle,5123,this._startIdx)),1},e.blend=function(){if(BlendMode.activeBlendFunction!==BlendMode.fns[this.blendType]){var t=WebGL.mainContext;t.enable(3042),BlendMode.fns[this.blendType](t),BlendMode.activeBlendFunction=BlendMode.fns[this.blendType]}},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},t.create=function(e,n,i,r,a,s){var o=t._cache._length?t._cache[--t._cache._length]:new t;return o._ib=n,o._vb=i,o.proName=s,o._startIdx=r*CONST3D2D.BYTES_PIDX,o._numEle=0,o.blendType=e._nBlendType,o.shaderValue=a,o.shaderValue.setValue(e._shader2D),o},t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),Submit=function(){function t(t){void 0===t&&(t=1e4),this._renderType=t}__class(t,"laya.webgl.submit.Submit");var e=t.prototype;return Laya.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.releaseRender=function(){var e=t._cache;e[e._length++]=this,this.shaderValue.release(),this._vb=null},e.getRenderType=function(){return this._renderType},e.renderSubmit=function(){if(0===this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var e=t.source;if(!t.bitmap||!e)return 1;this.shaderValue.texture=e}this._vb.bind_upload(this._ib);var n=WebGL.mainContext;return this.shaderValue.upload(),BlendMode.activeBlendFunction!==this._blendFn&&(n.enable(3042),this._blendFn(n),BlendMode.activeBlendFunction=this._blendFn),Stat.drawCall++,Stat.trianglesFaces+=this._numEle/3,n.drawElements(4,this._numEle,5123,this._startIdx),1},t.__init__=function(){var e=t.RENDERBASE=new t(-1);e.shaderValue=new Value2D(0,0),e.shaderValue.ALPHA=-1234},t.createSubmit=function(e,n,i,r,a){var s=t._cache._length?t._cache[--t._cache._length]:new t;null==i&&(i=s._selfVb||(s._selfVb=VertexBuffer2D.create(-1)),i.clear(),r=0),s._ib=n,s._vb=i,s._startIdx=r*CONST3D2D.BYTES_PIDX,s._numEle=0;var o=e._nBlendType;s._blendFn=e._targets?BlendMode.targetFns[o]:BlendMode.fns[o],s.shaderValue=a,s.shaderValue.setValue(e._shader2D);var l=e._shader2D.filters;return l&&s.shaderValue.setFilters(l),s},t.createShape=function(e,n,i,r,a,s){var o=t._cache._length?t._cache[--t._cache._length]:new t;o._ib=n,o._vb=i,o._numEle=r,o._startIdx=a,o.shaderValue=s,o.shaderValue.setValue(e._shader2D);var l=e._nBlendType;return o._blendFn=e._targets?BlendMode.targetFns[l]:BlendMode.fns[l],o},t.TYPE_2D=1e4,t.TYPE_CANVAS=10003,t.TYPE_CMDSETRT=10004,t.TYPE_CUSTOM=10005,t.TYPE_BLURRT=10006,t.TYPE_CMDDESTORYPRERT=10007,t.TYPE_DISABLESTENCIL=10008,t.TYPE_OTHERIBVB=10009,t.TYPE_PRIMITIVE=10010,t.TYPE_RT=10011,t.TYPE_BLUR_RT=10012,t.TYPE_TARGET=10013,t.TYPE_CHANGE_VALUE=10014,t.TYPE_SHAPE=10015,t.TYPE_TEXTURE=10016,t.TYPE_FILLTEXTURE=10017,t.RENDERBASE=null,t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),SubmitCMDScope=function(){function t(){this.variables={}}__class(t,"laya.webgl.submit.SubmitCMDScope");var e=t.prototype;return e.getValue=function(t){return this.variables[t]},e.addValue=function(t,e){return this.variables[t]=e},e.setValue=function(t,e){return this.variables.hasOwnProperty(t)?this.variables[t]=e:null},e.clear=function(){for(var t in this.variables)delete this.variables[t]},e.recycle=function(){this.clear(),t.POOL.push(this)},t.create=function(){var e=t.POOL.pop();return e||(e=new t),e},t.POOL=[],t}(),BasePoly=function(){function t(t,e,n,i,r,a,s,o,l){this.r0=0,this.fill=!0,this.r1=Math.PI/2,void 0===l&&(l=0),this.x=t,this.y=e,this.width=n,this.height=i,this.edges=r,this.color=a,this.borderWidth=s,this.borderColor=o}__class(t,"laya.webgl.shapes.BasePoly");var e=t.prototype;return Laya.imps(e,{"laya.webgl.shapes.IShape":!0}),e.getData=function(t,e,n){},e.rebuild=function(t){},e.setMatrix=function(t){},e.needUpdate=function(t){return!0},e.sector=function(t,e,n){var i=this.x,r=this.y,a=this.edges,s=(this.r1-this.r0)/a,o=this.width,l=this.height,h=this.color,_=(h>>16&255)/255,u=(h>>8&255)/255,c=(255&h)/255;t.push(i,r,_,u,c);for(var d=0;d<a+1;d++)t.push(i+Math.sin(s*d+this.r0)*o,r+Math.cos(s*d+this.r0)*l),t.push(_,u,c);for(d=0;d<a;d++)e.push(n,n+d+1,n+d+2)},e.createLine2=function(t,e,n,i,r,a){var s,o,l,h,_,u,c,d,f,m,p,g,v,x,S,T,E,y,M,D,C=t.concat(),R=r,A=this.borderColor,b=(A>>16&255)/255,I=(A>>8&255)/255,w=(255&A)/255,V=C.length/2,L=i,P=n/2;l=C[0],h=C[1],_=C[2],u=C[3],f=-(h-u),m=l-_,D=Math.sqrt(f*f+m*m),f=f/D*P,m=m/D*P,R.push(l-f+this.x,h-m+this.y,b,I,w,l+f+this.x,h+m+this.y,b,I,w);for(var N=1;N<V-1;N++)l=C[2*(N-1)],h=C[2*(N-1)+1],_=C[2*N],u=C[2*N+1],c=C[2*(N+1)],d=C[2*(N+1)+1],f=-(h-u),m=l-_,D=Math.sqrt(f*f+m*m),f=f/D*P,m=m/D*P,p=-(u-d),g=_-c,D=Math.sqrt(p*p+g*g),p=p/D*P,g=g/D*P,v=-m+h-(-m+u),x=-f+_-(-f+l),S=(-f+l)*(-m+u)-(-f+_)*(-m+h),T=-g+d-(-g+u),E=-p+_-(-p+c),y=(-p+c)*(-g+u)-(-p+_)*(-g+d),M=v*E-T*x,Math.abs(M)<.1?(M+=10.1,R.push(_-f+this.x,u-m+this.y,b,I,w,_+f+this.x,u+m+this.y,b,I,w)):(s=(x*y-E*S)/M,o=(T*S-v*y)/M,(s-_)*(s-_)+(o-u)+(o-u),R.push(s+this.x,o+this.y,b,I,w,_-(s-_)+this.x,u-(o-u)+this.y,b,I,w));l=C[C.length-4],h=C[C.length-3],_=C[C.length-2],u=C[C.length-1],f=-(h-u),m=l-_,D=Math.sqrt(f*f+m*m),f=f/D*P,m=m/D*P,R.push(_-f+this.x,u-m+this.y,b,I,w,_+f+this.x,u+m+this.y,b,I,w);var O=a;for(N=1;N<O;N++)e.push(L+2*(N-1),L+2*(N-1)+1,L+2*N+1,L+2*N+1,L+2*N,L+2*(N-1));return R},e.createLine=function(t,e,n,i){var r=t.concat(),a=t,s=this.borderColor,o=(s>>16&255)/255,l=(s>>8&255)/255,h=(255&s)/255;r.splice(0,5);var _,u,c,d,f,m,p,g,v,x,S,T,E,y,M,D,C,R,A,b,I=r.length/5,w=i,V=n/2;c=r[0],d=r[1],f=r[5],m=r[6],v=-(d-m),x=c-f,b=Math.sqrt(v*v+x*x),v=v/b*V,x=x/b*V,a.push(c-v,d-x,o,l,h,c+v,d+x,o,l,h);for(var L=1;L<I-1;L++)c=r[5*(L-1)],d=r[5*(L-1)+1],f=r[5*L],m=r[5*L+1],p=r[5*(L+1)],g=r[5*(L+1)+1],v=-(d-m),x=c-f,b=Math.sqrt(v*v+x*x),v=v/b*V,x=x/b*V,S=-(m-g),T=f-p,b=Math.sqrt(S*S+T*T),S=S/b*V,T=T/b*V,E=-x+d-(-x+m),y=-v+f-(-v+c),M=(-v+c)*(-x+m)-(-v+f)*(-x+d),D=-T+g-(-T+m),C=-S+f-(-S+p),R=(-S+p)*(-T+m)-(-S+f)*(-T+g),A=E*C-D*y,Math.abs(A)<.1?(A+=10.1,a.push(f-v,m-x,o,l,h,f+v,m+x,o,l,h)):(_=(y*R-C*M)/A,u=(D*M-E*R)/A,(_-f)*(_-f)+(u-m)+(u-m),a.push(_,u,o,l,h,f-(_-f),m-(u-m),o,l,h));c=r[r.length-10],d=r[r.length-9],f=r[r.length-5],m=r[r.length-4],v=-(d-m),x=c-f,b=Math.sqrt(v*v+x*x),v=v/b*V,x=x/b*V,a.push(f-v,m-x,o,l,h,f+v,m+x,o,l,h);var P=this.edges+1;for(L=1;L<P;L++)e.push(w+2*(L-1),w+2*(L-1)+1,w+2*L+1,w+2*L+1,w+2*L,w+2*(L-1));return a},e.createLoopLine=function(t,e,n,i,r,a){var s=t.concat(),o=r||t,l=this.borderColor,h=(l>>16&255)/255,_=(l>>8&255)/255,u=(255&l)/255;s.splice(0,5);var c=[s[0],s[1]],d=[s[s.length-5],s[s.length-4]],f=d[0]+.5*(c[0]-d[0]),m=d[1]+.5*(c[1]-d[1]);s.unshift(f,m,0,0,0),s.push(f,m,0,0,0);var p,g,v,x,S,T,E,y,M,D,C,R,A,b,I,w,V,L,P,N,O=s.length/5,F=i,B=n/2;v=s[0],x=s[1],S=s[5],T=s[6],M=-(x-T),D=v-S,N=Math.sqrt(M*M+D*D),M=M/N*B,D=D/N*B,o.push(v-M,x-D,h,_,u,v+M,x+D,h,_,u);for(var U=1;U<O-1;U++)v=s[5*(U-1)],x=s[5*(U-1)+1],S=s[5*U],T=s[5*U+1],E=s[5*(U+1)],y=s[5*(U+1)+1],M=-(x-T),D=v-S,N=Math.sqrt(M*M+D*D),M=M/N*B,D=D/N*B,C=-(T-y),R=S-E,N=Math.sqrt(C*C+R*R),C=C/N*B,R=R/N*B,A=-D+x-(-D+T),b=-M+S-(-M+v),I=(-M+v)*(-D+T)-(-M+S)*(-D+x),w=-R+y-(-R+T),V=-C+S-(-C+E),L=(-C+E)*(-R+T)-(-C+S)*(-R+y),P=A*V-w*b,Math.abs(P)<.1?(P+=10.1,o.push(S-M,T-D,h,_,u,S+M,T+D,h,_,u)):(p=(b*L-V*I)/P,g=(w*I-A*L)/P,(p-S)*(p-S)+(g-T)+(g-T),o.push(p,g,h,_,u,S-(p-S),T-(g-T),h,_,u));a&&(e=a);var G=this.edges+1;for(U=1;U<G;U++)e.push(F+2*(U-1),F+2*(U-1)+1,F+2*U+1,F+2*U+1,F+2*U,F+2*(U-1));return e.push(F+2*(U-1),F+2*(U-1)+1,F+1,F+1,F,F+2*(U-1)),o},t}(),ShaderCompile=function(){function t(t,n,i,r){function a(t){var n=[],i=new e(n);return s._compileToTree(i,t.split("\n"),0,n),i}var s=this,o=Browser.now();this._VS=a(n),this._PS=a(i),this._nameMap=r,Browser.now()-o>2&&console.log("ShaderCompile use time:"+(Browser.now()-o)+"  size:"+n.length+"/"+i.length)}var e,n;__class(t,"laya.webgl.utils.ShaderCompile");var i=t.prototype;return i._compileToTree=function(n,i,r,a){for(var s,o,l,h,_,u,c,d=0,f=r;f<i.length;f++)if(l=i[f],!(l.length<1)&&0!==(d=l.indexOf("//"))){if(d>=0&&(l=l.substr(0,d)),s=c||new e(a),c=null,s.text=l,s.noCompile=!0,(d=l.indexOf("#"))>=0){h="#";for(var m=d+1,p=l.length;m<p;m++){var g=l.charAt(m);if(" "===g||"\t"===g||"?"===g)break;h+=g}switch(s.name=h,h){case"#ifdef":case"#ifndef":s.src=l,s.noCompile=null!=l.match(/[!&|()=<>]/),s.noCompile?console.log("function():Boolean{return "+l.substr(d+s.name.length)+"}"):(u=l.replace(/^\s*/,"").split(/\s+/),s.setCondition(u[1],"#ifdef"===h?1:2),s.text="//"+s.text),s.setParent(n),n=s;continue;case"#if":s.src=l,s.noCompile=!0,s.setParent(n),n=s;continue;case"#else":s.src=l,n=n.parent,o=n.childs[n.childs.length-1],s.noCompile=o.noCompile,s.noCompile||(s.condition=o.condition,s.conditionType=1==o.conditionType?2:1,s.text="//"+s.text+" "+o.text+" "+s.conditionType),s.setParent(n),n=s;continue;case"#endif":n=n.parent,o=n.childs[n.childs.length-1],s.noCompile=o.noCompile,s.noCompile||(s.text="//"+s.text),s.setParent(n);continue;case"#include":u=t.splitToWords(l,null);var v=t.includes[u[1]];if(!v)throw"ShaderCompile error no this include file:"+u[1];if((d=u[0].indexOf("?"))<0){s.setParent(n),l=v.getWith("with"==u[2]?u[3]:null),this._compileToTree(s,l.split("\n"),0,a),s.text="";continue}s.setCondition(u[0].substr(d+1),1),s.text=v.getWith("with"==u[2]?u[3]:null);break;case"#import":u=t.splitToWords(l,null),_=u[1],a.push({node:s,file:t.includes[_],ofs:s.text.length});continue}}else{if((o=n.childs[n.childs.length-1])&&!o.name){a.length>0&&t.splitToWords(l,o),c=s,o.text+="\n"+l;continue}a.length>0&&t.splitToWords(l,s)}s.setParent(n)}},i.createShader=function(t,e,n){var i={},r="";if(t)for(var a in t)r+="#define "+a+"\n",i[a]=!0;var s=this._VS.toscript(i,[]),o=this._PS.toscript(i,[]);return(n||Shader.create)(r+s.join("\n"),r+o.join("\n"),e,this._nameMap)},t._parseOne=function(e,n,i,r,a,s){var o={type:t.shaderParamsMap[i[r+1]],name:i[r+2],size:isNaN(parseInt(i[r+3]))?1:parseInt(i[r+3])};return s&&("attribute"==a?e.push(o):n.push(o)),":"==i[r+3]&&(o.type=i[r+4],r+=2),r+=2},t.addInclude=function(e,i){if(!i||0===i.length)throw new Error("add shader include file err:"+e);if(t.includes[e])throw new Error("add shader include file err, has add:"+e);t.includes[e]=new n(i)},t.preGetParams=function(e,n){var i=[e,n],r={},a=[],s=[],o={},l=[];r.attributes=a,r.uniforms=s,r.defines=o;for(var h=0,_=0,u=0;u<2;u++){i[u]=i[u].replace(t._removeAnnotation,"");var c,d=i[u].match(t._reg);for(h=0,_=d.length;h<_;h++){var f=d[h];if("attribute"==f||"uniform"==f)h=t._parseOne(a,s,d,h,f,!0);else{if("#define"==f){f=d[++h],l[f]=1;continue}if("#ifdef"==f){c=d[++h];o[c]=o[c]||[];for(h++;h<_;h++)if("attribute"==(f=d[h])||"uniform"==f)h=t._parseOne(a,s,d,h,f,l[c]);else if("#else"==f)for(h++;h<_;h++)if("attribute"==(f=d[h])||"uniform"==f)h=t._parseOne(a,s,d,h,f,!l[c]);else if("#endif"==f)break}}}}return r},t.splitToWords=function(t,e){for(var n,i,r=[],a=-1,s=0,o=t.length;s<o;s++)if(n=t.charAt(s)," \t=+-*/&%!<>()'\",;".indexOf(n)>=0){if(a>=0&&s-a>1&&(i=t.substr(a,s-a),r.push(i)),'"'==n||"'"==n){var l=t.indexOf(n,s+1);if(l<0)throw"Sharder err:"+t;r.push(t.substr(s+1,l-s-1)),s=l,a=-1;continue}"("==n&&e&&r.length>0&&(i=r[r.length-1]+";","vec4;main;".indexOf(i)<0&&(e.useFuns+=i)),a=-1}else a<0&&(a=s);return a<o&&o-a>1&&(i=t.substr(a,o-a),r.push(i)),r},t.IFDEF_NO=0,t.IFDEF_YES=1,t.IFDEF_ELSE=2,t.IFDEF_PARENT=3,t._removeAnnotation=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g"),t._reg=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g"),t._splitToWordExps=new RegExp("[(\".*\")]+|[('.*')]+|([ \\t=\\+\\-*/&%!<>!%(),;])","g"),t.includes={},__static(t,["shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}}]),t.__init$=function(){e=function(){function t(t){this.childs=[],this.text="",this.parent=null,this.name=null,this.noCompile=!1,this.includefiles=null,this.condition=null,this.conditionType=0,this.useFuns="",this.z=0,this.src=null,this.includefiles=t}__class(t,"");var e=t.prototype;return e.setParent=function(t){t.childs.push(this),this.z=t.z+1,this.parent=t},e.setCondition=function(t,e){t&&(this.conditionType=e,t=t.replace(/(\s*$)/g,""),this.condition=function(){return this[t]},this.condition.__condition=t)},e.toscript=function(e,n){return this._toscript(e,n,++t.__id)},e._toscript=function(t,e,n){if(this.childs.length<1&&!this.text)return e;e.length;if(this.condition){var i=!!this.condition.call(t);if(2===this.conditionType&&(i=!i),!i)return e}if(this.text&&e.push(this.text),this.childs.length>0&&this.childs.forEach(function(i,r,a){i._toscript(t,e,n)}),this.includefiles.length>0&&this.useFuns.length>0)for(var r,a=0,s=this.includefiles.length;a<s;a++)this.includefiles[a].curUseID!=n&&(r=this.includefiles[a].file.getFunsScript(this.useFuns),r.length>0&&(this.includefiles[a].curUseID=n,e[0]=r+e[0]));return e},t.__id=1,t}(),n=function(){function e(e){this.script=null,this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var n=0,i=0,r=0;;){if((n=e.indexOf("#begin",n))<0)break;for(r=n+5;;){if((r=e.indexOf("#end",r))<0)break;if("i"!==e.charAt(r+4))break;r+=5}if(r<0)throw"add include err,no #end:"+e;i=e.indexOf("\n",n);var a=t.splitToWords(e.substr(n,i-n),null);"code"==a[1]?this.codes[a[2]]=e.substr(i+1,r-i-1):"function"==a[1]&&(i=e.indexOf("function",n),i+="function".length,this.funs[a[3]]=e.substr(i+1,r-i-1),this.funnames+=a[3]+";"),n=r+1}}__class(e,"");var n=e.prototype;return n.getWith=function(t){var e=t?this.codes[t]:this.script;if(!e)throw"get with error:"+t;return e},n.getFunsScript=function(t){var e="";for(var n in this.funs)t.indexOf(n+";")>=0&&(e+=this.funs[n]);return e},e}()},t}(),CONST3D2D=function(){function t(){}return __class(t,"laya.webgl.utils.CONST3D2D"),t.defaultMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t.defaultMinusYMatrix4=[1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1],t.uniformMatrix3=[1,0,0,0,0,1,0,0,0,0,1,0],t._TMPARRAY=[],t._OFFSETX=0,t._OFFSETY=0,__static(t,["BYTES_PE",function(){return this.BYTES_PE=Float32Array.BYTES_PER_ELEMENT},"BYTES_PIDX",function(){return this.BYTES_PIDX=Uint16Array.BYTES_PER_ELEMENT}]),t}(),RenderState2D=function(){function t(){}return __class(t,"laya.webgl.utils.RenderState2D"),t.getMatrArray=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},t.mat2MatArray=function(e,n){var i=e,r=n;return r[0]=i.a,r[1]=i.b,r[2]=t.EMPTYMAT4_ARRAY[2],r[3]=t.EMPTYMAT4_ARRAY[3],r[4]=i.c,r[5]=i.d,r[6]=t.EMPTYMAT4_ARRAY[6],r[7]=t.EMPTYMAT4_ARRAY[7],r[8]=t.EMPTYMAT4_ARRAY[8],r[9]=t.EMPTYMAT4_ARRAY[9],r[10]=t.EMPTYMAT4_ARRAY[10],r[11]=t.EMPTYMAT4_ARRAY[11],r[12]=i.tx,r[13]=i.ty,r[14]=t.EMPTYMAT4_ARRAY[14],r[15]=t.EMPTYMAT4_ARRAY[15],n},t.restoreTempArray=function(){t.TEMPMAT4_ARRAY[0]=1,t.TEMPMAT4_ARRAY[1]=0,t.TEMPMAT4_ARRAY[4]=0,t.TEMPMAT4_ARRAY[5]=1,t.TEMPMAT4_ARRAY[12]=0,t.TEMPMAT4_ARRAY[13]=0},t.clear=function(){t.worldScissorTest=!1,t.worldShaderDefines=null,t.worldFilters=null,t.worldAlpha=1,t.worldClipRect.x=t.worldClipRect.y=0,t.worldClipRect.width=t.width,t.worldClipRect.height=t.height,t.curRenderTarget=null},t._MAXSIZE=99999999,t.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t.worldMatrix4=t.TEMPMAT4_ARRAY,t.worldAlpha=1,t.worldScissorTest=!1,t.worldFilters=null,t.worldShaderDefines=null,t.curRenderTarget=null,t.width=0,t.height=0,__static(t,["worldMatrix",function(){return this.worldMatrix=new Matrix},"worldClipRect",function(){return this.worldClipRect=new Rectangle(0,0,99999999,99999999)}]),t}(),GlUtils=function(){function t(){}return __class(t,"laya.webgl.utils.GlUtils"),t.make2DProjection=function(t,e,n){return[2/t,0,0,0,0,-2/e,0,0,0,0,2/n,0,-1,1,0,1]},t.fillIBQuadrangle=function(t,e){if(e>65535/4)throw Error("IBQuadrangle count:"+e+" must<:"+Math.floor(65535/4));e=Math.floor(e),t._resizeBuffer(6*(e+1)*2,!1),t.byteLength=t.bufferLength;for(var n=t.getUint16Array(),i=0,r=0;r<e;r++)n[i++]=4*r,n[i++]=4*r+2,n[i++]=4*r+1,n[i++]=4*r,n[i++]=4*r+3,n[i++]=4*r+2;return t.setNeedUpload(),!0},t.expandIBQuadrangle=function(e,n){e.bufferLength>=6*n*2||t.fillIBQuadrangle(e,n)},t.mathCeilPowerOfTwo=function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},t.fillQuadrangleImgVb=function(t,e,n,i,r,a,s,o){"use strict";var l=16+(t._byteLength>>2);t.byteLength=l<<2;var h=t.getFloat32Array();l-=16,h[l+2]=r[0],h[l+3]=r[1],h[l+6]=r[2],h[l+7]=r[3],h[l+10]=r[4],h[l+11]=r[5],h[l+14]=r[6],h[l+15]=r[7];var _=a.a,u=a.b,c=a.c,d=a.d;if(1!==_||0!==u||0!==c||1!==d){a.bTransform=!0;var f=a.tx+s,m=a.ty+o;h[l]=(i[0]+e)*_+(i[1]+n)*c+f,h[l+1]=(i[0]+e)*u+(i[1]+n)*d+m,h[l+4]=(i[2]+e)*_+(i[3]+n)*c+f,h[l+5]=(i[2]+e)*u+(i[3]+n)*d+m,h[l+8]=(i[4]+e)*_+(i[5]+n)*c+f,h[l+9]=(i[4]+e)*u+(i[5]+n)*d+m,h[l+12]=(i[6]+e)*_+(i[7]+n)*c+f,h[l+13]=(i[6]+e)*u+(i[7]+n)*d+m}else a.bTransform=!1,e+=a.tx+s,n+=a.ty+o,h[l]=e+i[0],h[l+1]=n+i[1],h[l+4]=e+i[2],h[l+5]=n+i[3],h[l+8]=e+i[4],h[l+9]=n+i[5],h[l+12]=e+i[6],h[l+13]=n+i[7];return t._upload=!0,!0},t.fillTranglesVB=function(t,e,n,i,r,a,s){var o=(t._byteLength>>2)+i.length;t.byteLength=o<<2;var l=t.getFloat32Array();o-=i.length;for(var h=i.length,_=r.a,u=r.b,c=r.c,d=r.d,f=0;f<h;f+=4)if(l[o+f+2]=i[f+2],l[o+f+3]=i[f+3],1!==_||0!==u||0!==c||1!==d){r.bTransform=!0;var m=r.tx+a,p=r.ty+s;l[o+f]=(i[f]+e)*_+(i[f+1]+n)*c+m,l[o+f+1]=(i[f]+e)*u+(i[f+1]+n)*d+p}else r.bTransform=!1,e+=r.tx+a,n+=r.ty+s,l[o+f]=e+i[f],l[o+f+1]=n+i[f+1];return t._upload=!0,!0},t.copyPreImgVb=function(t,e,n){var i=t._byteLength>>2;t.byteLength=i+16<<2;for(var r=t.getFloat32Array(),a=0,s=i-16;a<4;a++)r[i]=r[s]+e,++i,++s,r[i]=r[s]+n,++i,++s,r[i]=r[s],++i,++s,r[i]=r[s],++i,++s;t._upload=!0},t.fillRectImgVb=function(t,e,n,i,r,a,s,o,l,h,_,u,c){void 0===c&&(c=!1);var d,f,m,p,g,v,x,S,T,E,y,M,D,C,R,A,b=1,I=o.a,w=o.b,V=o.c,L=o.d,P=e&&e.width<99999999;if(1!==I||0!==w||0!==V||1!==L?(o.bTransform=!0,0===w&&0===V&&(b=23,T=r+n,E=a+i,y=o.tx+l,M=o.ty+h,d=I*n+y,m=I*T+y,f=L*i+M,p=L*E+M)):(b=23,o.bTransform=!1,d=n+o.tx+l,m=d+r,f=i+o.ty+h,p=f+a),P&&(g=e.x,v=e.y,x=e.width+g,S=e.height+v),1!==b){if(Math.min(d,m)>=x)return!1;if(Math.min(f,p)>=S)return!1;if(Math.max(m,d)<=g)return!1;if(Math.max(p,f)<=v)return!1}var N=t._byteLength>>2;t.byteLength=N+16<<2;var O=t.getFloat32Array();switch(O[N+2]=s[0],O[N+3]=s[1],O[N+6]=s[2],O[N+7]=s[3],O[N+10]=s[4],O[N+11]=s[5],O[N+14]=s[6],O[N+15]=s[7],b){case 1:y=o.tx+l,M=o.ty+h,T=r+n,E=a+i;var F=n,B=i,U=I*F,G=V*B,H=L*B,W=w*F,k=I*T,z=V*E,X=L*E,Y=w*T;c?(D=U+G+y,R=Math.round(D)-D,C=H+W+M,A=Math.round(C)-C,O[N]=D+R,O[N+1]=C+A,O[N+4]=k+G+y+R,O[N+5]=H+Y+M+A,O[N+8]=k+z+y+R,O[N+9]=X+Y+M+A,O[N+12]=U+z+y+R,O[N+13]=X+W+M+A):(O[N]=U+G+y,O[N+1]=H+W+M,O[N+4]=k+G+y,O[N+5]=H+Y+M,O[N+8]=k+z+y,O[N+9]=X+Y+M,O[N+12]=U+z+y,O[N+13]=X+W+M);break;case 23:c?(D=d+_,R=Math.round(D)-D,C=f,A=Math.round(C)-C,O[N]=D+R,O[N+1]=C+A,O[N+4]=m+_+R,O[N+5]=f+A,O[N+8]=m+R,O[N+9]=p+A,O[N+12]=d+R,O[N+13]=p+A):(O[N]=d+_,O[N+1]=f,O[N+4]=m+_,O[N+5]=f,O[N+8]=m,O[N+9]=p,O[N+12]=d,O[N+13]=p)}return t._upload=!0,!0},t.fillLineVb=function(e,n,i,r,a,s,o,l){"use strict";var h=.5*o,_=t._fillLineArray,u=-(r-s),c=i-a,d=Math.sqrt(u*u+c*c);u/=d,c/=d,u*=h,c*=h,_[0]=i-u,_[1]=r-c,_[4]=i+u,_[5]=r+c,_[8]=a+u,_[9]=s+c,_[12]=a-u,_[13]=s-c,l&&l.transformPointArray(_,_);var f=16+(e._byteLength>>2);return e.byteLength=f<<2,e.insertData(_,f-16),!0},t._fillLineArray=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t}(),MatirxArray=function(){function t(){}return __class(t,"laya.webgl.utils.MatirxArray"),t.ArrayMul=function(e,n,i){if(!e)return void t.copyArray(n,i);if(!n)return void t.copyArray(e,i)
;for(var r=NaN,a=NaN,s=NaN,o=NaN,l=0;l<4;l++)r=e[l],a=e[l+4],s=e[l+8],o=e[l+12],i[l]=r*n[0]+a*n[1]+s*n[2]+o*n[3],i[l+4]=r*n[4]+a*n[5]+s*n[6]+o*n[7],i[l+8]=r*n[8]+a*n[9]+s*n[10]+o*n[11],i[l+12]=r*n[12]+a*n[13]+s*n[14]+o*n[15]},t.copyArray=function(t,e){if(t&&e)for(var n=0;n<t.length;n++)e[n]=t[n]},t}(),DrawStyle=function(){function t(t){this._color=Color.create("black"),this.setValue(t)}__class(t,"laya.webgl.canvas.DrawStyle");var e=t.prototype;return e.setValue=function(t){if(t){if("string"==typeof t)return void(this._color=Color.create(t));if(t instanceof laya.utils.Color)return void(this._color=t)}},e.reset=function(){this._color=Color.create("black")},e.equal=function(t){return"string"==typeof t?this._color.strColor===t:t instanceof laya.utils.Color&&this._color.numColor===t.numColor},e.toColorStr=function(){return this._color.strColor},t.create=function(e){if(e){var n;if("string"==typeof e?n=Color.create(e):e instanceof laya.utils.Color&&(n=e),n)return n._drawStyle||(n._drawStyle=new t(e))}return null},__static(t,["DEFAULT",function(){return this.DEFAULT=new t("#000000")}]),t}(),Path=function(){function t(){this._x=0,this._y=0,this.dirty=!1,this.offset=0,this.count=0,this.geoStart=0,this.tempArray=[],this.closePath=!1,this.geomatrys=[];WebGL.mainContext;this.ib=IndexBuffer2D.create(35048),this.vb=VertexBuffer2D.create(5)}__class(t,"laya.webgl.canvas.Path");var e=t.prototype;return e.addPoint=function(t,e){this.tempArray.push(t,e)},e.getEndPointX=function(){return this.tempArray[this.tempArray.length-2]},e.getEndPointY=function(){return this.tempArray[this.tempArray.length-1]},e.polygon=function(t,e,n,i,r,a){var s;return this.geomatrys.push(this._curGeomatry=s=new Polygon(t,e,n,i,r,a)),i||(s.fill=!1),void 0==a&&(s.borderWidth=0),s},e.setGeomtry=function(t){this.geomatrys.push(this._curGeomatry=t)},e.drawLine=function(t,e,n,i,r){var a;return this.closePath?this.geomatrys.push(this._curGeomatry=a=new LoopLine(t,e,n,i,r)):this.geomatrys.push(this._curGeomatry=a=new Line(t,e,n,i,r)),a.fill=!1,a},e.update=function(){var t=this.ib._byteLength,e=this.geomatrys.length;this.offset=t;for(var n=this.geoStart;n<e;n++)this.geomatrys[n].getData(this.ib,this.vb,this.vb._byteLength/20);this.geoStart=e,this.count=(this.ib._byteLength-t)/CONST3D2D.BYTES_PIDX},e.reset=function(){this.vb.clear(),this.ib.clear(),this.offset=this.count=this.geoStart=0,this.geomatrys.length=0},e.recover=function(){this._curGeomatry=null,this.vb.destory(),this.vb=null,this.ib.destory(),this.ib=null},t}(),BlendMode=function(){function t(){}return __class(t,"laya.webgl.canvas.BlendMode"),t._init_=function(e){t.fns=[t.BlendNormal,t.BlendAdd,t.BlendMultiply,t.BlendScreen,t.BlendOverlay,t.BlendLight,t.BlendMask,t.BlendDestinationOut],t.targetFns=[t.BlendNormalTarget,t.BlendAddTarget,t.BlendMultiplyTarget,t.BlendScreenTarget,t.BlendOverlayTarget,t.BlendLightTarget,t.BlendMask,t.BlendDestinationOut]},t.BlendNormal=function(t){t.blendFunc(1,771)},t.BlendAdd=function(t){t.blendFunc(1,772)},t.BlendMultiply=function(t){t.blendFunc(774,771)},t.BlendScreen=function(t){t.blendFunc(1,1)},t.BlendOverlay=function(t){t.blendFunc(1,769)},t.BlendLight=function(t){t.blendFunc(1,1)},t.BlendNormalTarget=function(t){t.blendFunc(1,771)},t.BlendAddTarget=function(t){t.blendFunc(1,772)},t.BlendMultiplyTarget=function(t){t.blendFunc(774,771)},t.BlendScreenTarget=function(t){t.blendFunc(1,1)},t.BlendOverlayTarget=function(t){t.blendFunc(1,769)},t.BlendLightTarget=function(t){t.blendFunc(1,1)},t.BlendMask=function(t){t.blendFunc(0,770)},t.BlendDestinationOut=function(t){t.blendFunc(0,0)},t.activeBlendFunction=null,t.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out"],t.TOINT={normal:0,add:1,multiply:2,screen:3,lighter:1,overlay:4,light:5,mask:6,"destination-out":7},t.NORMAL="normal",t.ADD="add",t.MULTIPLY="multiply",t.SCREEN="screen",t.LIGHT="light",t.OVERLAY="overlay",t.DESTINATIONOUT="destination-out",t.fns=[],t.targetFns=[],t}(),SaveClipRect=function(){function t(){this._clipRect=new Rectangle}__class(t,"laya.webgl.canvas.save.SaveClipRect");var e=t.prototype;return Laya.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._clipRect=this._clipSaveRect,t._cache[t._cache._length++]=this,this._submitScissor.submitLength=e._submits._length-this._submitScissor.submitIndex,e._curSubmit=Submit.RENDERBASE,e._renderKey=0},t.save=function(e,n){if(131072!=(131072&e._saveMark._saveuse)){e._saveMark._saveuse|=131072;var i=t._cache,r=i._length>0?i[--i._length]:new t;r._clipSaveRect=e._clipRect,e._clipRect=r._clipRect.copyFrom(e._clipRect),r._submitScissor=n;var a=e._save;a[a._length++]=r}},t._cache=SaveBase._createArray(),t}(),SaveClipRectStencil=function(){function t(){this._contextX=0,this._contextY=0,this._clipRect=new Rectangle,this._rect=new Rectangle,this._matrix=new Matrix}__class(t,"laya.webgl.canvas.save.SaveClipRectStencil");var e=t.prototype;return Laya.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){SubmitStencil.restore(e,this._rect,this._saveMatrix,this._contextX,this._contextY),e._clipRect=this._clipSaveRect,e._curMat=this._saveMatrix,e._x=this._contextX,e._y=this._contextY,t._cache[t._cache._length++]=this,e._curSubmit=Submit.RENDERBASE},t.save=function(e,n,i,r,a,s,o,l,h,_){if(262144!=(262144&e._saveMark._saveuse)){e._saveMark._saveuse|=262144;var u=t._cache,c=u._length>0?u[--u._length]:new t;c._clipSaveRect=e._clipRect,c._clipRect.setTo(o,l,h,_),e._clipRect=c._clipRect,c._rect.x=i,c._rect.y=r,c._rect.width=a,c._rect.height=s,c._contextX=e._x,c._contextY=e._y,c._saveMatrix=e._curMat,e._curMat.copyTo(c._matrix),e._curMat=c._matrix,c._submitStencil=n;var d=e._save;d[d._length++]=c}},t._cache=SaveBase._createArray(),t}(),SaveTransform=function(){function t(){this._matrix=new Matrix}__class(t,"laya.webgl.canvas.save.SaveTransform");var e=t.prototype;return Laya.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._curMat=this._savematrix,t._no[t._no._length++]=this},t.save=function(e){var n=e._saveMark;if(2048!=(2048&n._saveuse)){n._saveuse|=2048;var i=t._no,r=i._length>0?i[--i._length]:new t;r._savematrix=e._curMat,e._curMat=e._curMat.copyTo(r._matrix);var a=e._save;a[a._length++]=r}},t._no=SaveBase._createArray(),t}(),SaveMark=function(){function t(){this._saveuse=0}__class(t,"laya.webgl.canvas.save.SaveMark");var e=t.prototype;return Laya.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!0},e.restore=function(e){e._saveMark=this._preSaveMark,t._no[t._no._length++]=this},t.Create=function(e){var n=t._no,i=n._length>0?n[--n._length]:new t;return i._saveuse=0,i._preSaveMark=e._saveMark,e._saveMark=i,i},t._no=SaveBase._createArray(),t}(),SaveTranslate=function(){function t(){}__class(t,"laya.webgl.canvas.save.SaveTranslate");var e=t.prototype;return Laya.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._curMat;e._x=this._x,e._y=this._y,t._no[t._no._length++]=this},t.save=function(e){var n=t._no,i=n._length>0?n[--n._length]:new t;i._x=e._x,i._y=e._y;var r=e._save;r[r._length++]=i},t._no=SaveBase._createArray(),t}(),Context=function(){function t(){this._repaint=!1}__class(t,"laya.resource.Context");var e=t.prototype;return e.replaceReset=function(){var e=0,n=0;n=t.replaceKeys.length;var i;for(e=0;e<n;e++)i=t.replaceKeys[e],this[t.newKeys[e]]=this[i]},e.replaceResotre=function(){this.__restore(),this.__reset()},e.setIsMainContext=function(){},e.drawTextures=function(t,e,n,i){Stat.drawCall+=e.length/2;for(var r=t.width,a=t.height,s=0,o=e.length;s<o;s+=2)this.drawTexture(t,e[s],e[s+1],r,a,n,i)},e.drawCanvas=function(t,e,n,i,r){Stat.drawCall++,this.drawImage(t.source,e,n,i,r)},e.fillRect=function(t,e,n,i,r){Stat.drawCall++,r&&(this.fillStyle=r),this.__fillRect(t,e,n,i)},e.fillText=function(t,e,n,i,r,a){Stat.drawCall++,arguments.length>3&&null!=i&&(this.font=i,this.fillStyle=r,this.textAlign=a,this.textBaseline="top"),this.__fillText(t,e,n)},e.fillBorderText=function(t,e,n,i,r,a,s,o){Stat.drawCall++,this.font=i,this.fillStyle=r,this.textBaseline="top",this.strokeStyle=a,this.lineWidth=s,this.textAlign=o,this.__strokeText(t,e,n),this.__fillText(t,e,n)},e.strokeText=function(t,e,n,i,r,a,s){Stat.drawCall++,arguments.length>3&&null!=i&&(this.font=i,this.strokeStyle=r,this.lineWidth=a,this.textAlign=s,this.textBaseline="top"),this.__strokeText(t,e,n)},e.transformByMatrix=function(t){this.transform(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.setTransformByMatrix=function(t){this.setTransform(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.clipRect=function(t,e,n,i){Stat.drawCall++,this.beginPath(),this.rect(t,e,n,i),this.clip()},e.drawTexture=function(t,e,n,i,r,a,s){Stat.drawCall++;var o=t.uv,l=t.bitmap.width,h=t.bitmap.height;this.drawImage(t.source,o[0]*l,o[1]*h,(o[2]-o[0])*l,(o[5]-o[3])*h,e+a,n+s,i,r)},e.drawTextureWithTransform=function(t,e,n,i,r,a,s,o,l){Stat.drawCall++;var h=t.uv,_=t.bitmap.width,u=t.bitmap.height;this.save(),1!=l&&(this.globalAlpha*=l),a?(this.transform(a.a,a.b,a.c,a.d,a.tx+s,a.ty+o),this.drawImage(t.source,h[0]*_,h[1]*u,(h[2]-h[0])*_,(h[5]-h[3])*u,e,n,i,r)):this.drawImage(t.source,h[0]*_,h[1]*u,(h[2]-h[0])*_,(h[5]-h[3])*u,e+s,n+o,i,r),this.restore()},e.drawTexture2=function(t,e,n,i,r,a,s,o){"use strict";var l=o[0];if(l.loaded&&l.bitmap&&l.source){Stat.drawCall++;var h=1!==a;if(h){var _=this.globalAlpha;this.globalAlpha*=a}var u=l.uv,c=l.bitmap.width,d=l.bitmap.height;r?(this.save(),this.transform(r.a,r.b,r.c,r.d,r.tx+t,r.ty+e),this.drawImage(l.source,u[0]*c,u[1]*d,(u[2]-u[0])*c,(u[5]-u[3])*d,o[1]-n,o[2]-i,o[3],o[4]),this.restore()):this.drawImage(l.source,u[0]*c,u[1]*d,(u[2]-u[0])*c,(u[5]-u[3])*d,o[1]-n+t,o[2]-i+e,o[3],o[4]),h&&(this.globalAlpha=_)}},e.fillTexture=function(t,e,n,i,r,a,s,o){if(!o.pat){if(t.uv!=Texture.DEF_UV){var l=new HTMLCanvas("2D");l.getContext("2d"),l.size(t.width,t.height),l.context.drawTexture(t,0,0,t.width,t.height,0,0),t=new Texture(l)}o.pat=this.createPattern(t.bitmap.source,a)}var h=e,_=n,u=0,c=0;s&&(h+=s.x%t.width,_+=s.y%t.height,u-=s.x%t.width,c-=s.y%t.height),this.translate(h,_),this.fillRect(u,c,i,r,o.pat),this.translate(-h,-_)},e.flush=function(){return 0},e.fillWords=function(t,e,n,i,r,a){i&&(this.font=i),r&&(this.fillStyle=r);this.textBaseline="top",this.textAlign="left";for(var s=0,o=t.length;s<o;s++){var l=t[s];if(this.__fillText(l.char,l.x+e,l.y+n),1===a){var h=l.height,_=.5*l.style.letterSpacing;_||(_=0),this.beginPath(),this.strokeStyle=r,this.lineWidth=1,this.moveTo(e+l.x-_+.5,n+l.y+h+.5),this.lineTo(e+l.x+l.width+_+.5,n+l.y+h+.5),this.stroke()}}},e.fillBorderWords=function(t,e,n,i,r,a,s){i&&(this.font=i),r&&(this.fillStyle=r),this.textBaseline="top",this.lineWidth=s,this.textAlign="left",this.strokeStyle=a;for(var o=0,l=t.length;o<l;o++){var h=t[o];this.__strokeText(h.char,h.x+e,h.y+n),this.__fillText(h.char,h.x+e,h.y+n)}},e.destroy=function(){this.canvas.width=this.canvas.height=0},e.clear=function(){this.clearRect(0,0,this._canvas.width,this._canvas.height),this._repaint=!1},e.drawCurves=function(t,e,n){this.beginPath(),this.strokeStyle=n[3],this.lineWidth=n[4];var i=n[2];t+=n[0],e+=n[1],this.moveTo(t+i[0],e+i[1]);for(var r=2,a=i.length;r<a;)this.quadraticCurveTo(t+i[r++],e+i[r++],t+i[r++],e+i[r++]);this.stroke()},t.__init__=function(t){var e=laya.resource.Context.prototype;return t=t||CanvasRenderingContext2D.prototype,t.__fillText=t.fillText,t.__fillRect=t.fillRect,t.__strokeText=t.strokeText,void["drawTextures","fillWords","fillBorderWords","setIsMainContext","fillRect","strokeText","fillTexture","fillText","transformByMatrix","setTransformByMatrix","clipRect","drawTexture","drawTexture2","drawTextureWithTransform","flush","clear","destroy","drawCanvas","fillBorderText","drawCurves"].forEach(function(n){t[n]=e[n]})},t.replaceCanvasGetSet=function(t,e){var n=Object.getOwnPropertyDescriptor(t,e);if(!n||!n.configurable)return!1;var i,r={};for(i in n)"set"!=i&&(r[i]=n[i]);var a=n.set;return r.set=function(t){var e=this;a.call(e,t);var n=e.getContext("2d");n&&"__reset"in n&&n.__reset()},Object.defineProperty(t,e,r),!0},t.replaceGetSet=function(e,n){var i=Object.getOwnPropertyDescriptor(e,n);if(!i||!i.configurable)return!1;var r,a={};for(r in i)"set"!=r&&(a[r]=i[r]);var s=i.set,o="___"+n+"__";return t.newKeys.push(o),a.set=function(t){var e=this;t!=e[o]&&(e[o]=t,s.call(e,t))},Object.defineProperty(e,n,a),!0},t._default=new t,t.newKeys=[],__static(t,["replaceKeys",function(){return this.replaceKeys=["font","fillStyle","textBaseline"]}]),t}(),WebGL=function(){function t(){}return __class(t,"laya.webgl.WebGL"),t._uint8ArraySlice=function(){for(var t=this,e=t.length,n=new Uint8Array(t.length),i=0;i<e;i++)n[i]=t[i];return n},t._float32ArraySlice=function(){for(var t=this,e=t.length,n=new Float32Array(t.length),i=0;i<e;i++)n[i]=t[i];return n},t._uint16ArraySlice=function(t){var e,n=arguments,i=this,r=0,a=0;if(0===n.length)for(r=i.length,e=new Uint16Array(r),a=0;a<r;a++)e[a]=i[a];else if(2===n.length){var s=n[0],o=n[1];if(o>s)for(r=o-s,e=new Uint16Array(r),a=s;a<o;a++)e[a-s]=i[a];else e=new Uint16Array(0)}return e},t.expandContext=function(){var t=Context.prototype,e=CanvasRenderingContext2D.prototype;e.fillTrangles=t.fillTrangles,Buffer2D.__int__(null),e.setIBVB=function(t,e,n,i,r,a,s,o,l,h){void 0===l&&(l=0),void 0===h&&(h=0),null===n&&(this._ib=this._ib||IndexBuffer2D.QuadrangleIB,n=this._ib,GlUtils.expandIBQuadrangle(n,i._byteLength/64+8)),this._setIBVB(t,e,n,i,r,a,s,o,l,h)},e.fillTrangles=function(t,e,n,i,r){this._curMat=this._curMat||Matrix.create(),this._vb=this._vb||VertexBuffer2D.create(),this._ib||(this._ib=IndexBuffer2D.create(),GlUtils.fillIBQuadrangle(this._ib,s/4));var a=this._vb,s=i.length>>4;GlUtils.fillTranglesVB(a,e,n,i,r||this._curMat,0,0),GlUtils.expandIBQuadrangle(this._ib,a._byteLength/64+8);var o=new Value2D(1,0);o.textureHost=t;var l=new Shader2X("attribute vec2 position; attribute vec2 texcoord; uniform vec2 size; uniform mat4 mmat; varying vec2 v_texcoord; void main() { vec4 p=vec4(position.xy,0.0,1.0);vec4 pos=mmat*p; gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0); v_texcoord = texcoord; }","precision mediump float; varying vec2 v_texcoord; uniform sampler2D texture; void main() {vec4 color= texture2D(texture, v_texcoord); color.a*=1.0; gl_FragColor= color;}");a._vertType=3,this._setIBVB(e,n,this._ib,a,6*s,r,l,o,0,0)}},t.enable=function(){if(Browser.__init__(),Render.isConchApp&&!Render.isConchWebGL)return RunDriver.skinAniSprite=function(){return new SkinMesh},t.expandContext(),!1;if(RunDriver.getWebGLContext=function(t){for(var e,n=["webgl","experimental-webgl","webkit-3d","moz-webgl"],i=0;i<n.length;i++){try{e=t.getContext(n[i],{stencil:Config.isStencil,alpha:Config.isAlpha,antialias:Config.isAntialias,premultipliedAlpha:Config.premultipliedAlpha,preserveDrawingBuffer:Config.preserveDrawingBuffer})}catch(t){}if(e)return e}return null},t.mainContext=RunDriver.getWebGLContext(Render._mainCanvas),null==t.mainContext)return!1;if(Render.isWebGL)return!0;HTMLImage.create=function(t,e){return new WebGLImage(t,e)},HTMLSubImage.create=function(t,e,n,i,r,a,s){return new WebGLSubImage(t,e,n,i,r,a,s)},Render.WebGL=t,Render.isWebGL=!0,DrawText.__init__(),RunDriver.createRenderSprite=function(t,e){return new RenderSprite3D(t,e)},RunDriver.createWebGLContext2D=function(t){return new WebGLContext2D(t)},RunDriver.changeWebGLSize=function(t,e){laya.webgl.WebGL.onStageResize(t,e)},RunDriver.createGraphics=function(){return new GraphicsGL};var e=RunDriver.createFilterAction;return RunDriver.createFilterAction=e||function(t){return new ColorFilterActionGL},RunDriver.clear=function(t){RenderState2D.worldScissorTest&&laya.webgl.WebGL.mainContext.disable(3089);var e=Render.context.ctx,n=0==e._submits._length||Config.preserveDrawingBuffer?Color.create(t)._color:Stage._wgColor;n&&e.clearBG(n[0],n[1],n[2],n[3]),RenderState2D.clear()},RunDriver.addToAtlas=function(t,e){void 0===e&&(e=!1);var n=t.bitmap;if(!Render.optimizeTextureMemory(t.url,t))return void(n.enableMerageInAtlas=!1);Laya.__typeof(n,"laya.webgl.resource.IMergeAtlasBitmap")&&n.allowMerageInAtlas&&n.on("recovered",t,t.addTextureToAtlas)},RunDriver.isAtlas=function(t){return t instanceof laya.webgl.atlas.AtlasWebGLCanvas},AtlasResourceManager._enable(),RunDriver.beginFlush=function(){for(var t=AtlasResourceManager.instance,e=t.getAtlaserCount(),n=0;n<e;n++){var i=t.getAtlaserByIndex(n).texture;i._flashCacheImageNeedFlush&&RunDriver.flashFlushImage(i)}},RunDriver.drawToCanvas=function(t,e,n,i,r,a){r-=t.x,a-=t.y;var s=RenderTarget2D.create(n,i,6408,5121,0,!1);s.start(),Render.context.clear(),t.render(Render.context,r,RenderState2D.height-i+a),Render.context.flush(),s.end();var o=s.getData(0,0,s.width,s.height);s.recycle();var l=new WebGLCanvas;l._canvas=Browser.createElement("canvas"),l.size(n,i);var h=l._canvas.getContext("2d");Browser.canvas.size(n,i);var _=Browser.context,u=_.createImageData(n,i);return u.data.set(new Uint8ClampedArray(o.buffer)),l._imgData=u,_.putImageData(u,0,0),h.save(),h.translate(0,i),h.scale(1,-1),h.drawImage(Browser.canvas.source,0,0),h.restore(),l},RunDriver.createFilterAction=function(t){var e;switch(t){case 32:e=new ColorFilterActionGL}return e},RunDriver.addTextureToAtlas=function(t){t._uvID++,AtlasResourceManager._atlasRestore++,t.bitmap.enableMerageInAtlas&&AtlasResourceManager.instance.addToAtlas(t)},RunDriver.getTexturePixels=function(t,e,n,i,r){Render.context.ctx.clear();var a=new Sprite;a.graphics.drawTexture(t,-e,-n);var s=RenderTarget2D.create(i,r);s.start(),s.clear(0,0,0,0),a.render(Render.context,0,0),Render.context.ctx.flush(),s.end();for(var o=s.getData(0,0,i,r),l=[],h=0,_=r-1;_>=0;_--)for(var u=0;u<i;u++)h=4*(_*i+u),l.push(o[h]),l.push(o[h+1]),l.push(o[h+2]),l.push(o[h+3]);return l},RunDriver.skinAniSprite=function(){return new SkinMesh},Filter._filterStart=function(t,e,n,i,r){var a=t.getValue("bounds"),s=RenderTarget2D.create(a.width,a.height);if(s.start(),s.clear(0,0,0,0),t.addValue("src",s),t.addValue("ScissorTest",RenderState2D.worldScissorTest),RenderState2D.worldScissorTest){var o=new Rectangle;o.copyFrom(n.ctx._clipRect),t.addValue("clipRect",o),RenderState2D.worldScissorTest=!1,laya.webgl.WebGL.mainContext.disable(3089)}},Filter._filterEnd=function(t,e,n,i,r){var a=t.getValue("bounds");t.getValue("src").end();var s=RenderTarget2D.create(a.width,a.height);s.start(),s.clear(0,0,0,0),t.addValue("out",s),e._set$P("_filterCache",s),e._set$P("_isHaveGlowFilter",t.getValue("_isHaveGlowFilter"))},Filter._EndTarget=function(t,e){if(t.getValue("src").recycle(),t.getValue("out").end(),t.getValue("ScissorTest")){RenderState2D.worldScissorTest=!0,laya.webgl.WebGL.mainContext.enable(3089),e.ctx.save();var n=t.getValue("clipRect");e.ctx.clipRect(n.x,n.y,n.width,n.height)}},Filter._useSrc=function(t){var e=t.getValue("out");e.end(),e=t.getValue("src"),e.start(),e.clear(0,0,0,0)},Filter._endSrc=function(t){t.getValue("src").end()},Filter._useOut=function(t){var e=t.getValue("src");e.end(),e=t.getValue("out"),e.start(),e.clear(0,0,0,0)},Filter._endOut=function(t){t.getValue("out").end()},Filter._recycleScope=function(t){t.recycle()},Filter._filter=function(t,e,n,i){var r=this._next;if(r){var a=t.filters,s=a.length;if(1==s&&32==a[0].type)return e.ctx.save(),e.ctx.setFilters([a[0]]),r._fun.call(r,t,e,n,i),void e.ctx.restore();var o,l,h=SubmitCMDScope.create(),_=Point.TEMP,u=e.ctx._getTransformMatrix(),c=Matrix.create();u.copyTo(c);var d=0,f=0,m=!1,p=t._$P._filterCache?t._$P._filterCache:null;if(!p||t._repaint){m=t._isHaveGlowFilter(),h.addValue("_isHaveGlowFilter",m),m&&(d=50,f=25),l=new Rectangle,l.copyFrom(t.getSelfBounds()),l.x+=t.x,l.y+=t.y,l.x-=t.pivotX+4,l.y-=t.pivotY+4;var g=l.x,v=l.y;if(l.width+=d+8,l.height+=d+8,_.x=l.x*c.a+l.y*c.c,_.y=l.y*c.d+l.x*c.b,l.x=_.x,l.y=_.y,_.x=l.width*c.a+l.height*c.c,_.y=l.height*c.d+l.width*c.b,l.width=_.x,l.height=_.y,l.width<=0||l.height<=0)return;p&&p.recycle(),h.addValue("bounds",l);var x=SubmitCMD.create([h,t,e,0,0],Filter._filterStart);e.addRenderObject(x),e.ctx._renderKey=0,e.ctx._shader2D.glTexture=null;var S=t.x-g+f,T=t.y-v+f;r._fun.call(r,t,e,S,T),x=SubmitCMD.create([h,t,e,0,0],Filter._filterEnd),e.addRenderObject(x);for(var E=0;E<s;E++){0!=E&&(x=SubmitCMD.create([h],Filter._useSrc),e.addRenderObject(x),o=Value2D.create(1,0),Matrix.TEMP.identity(),e.ctx.drawTarget(h,0,0,l.width,l.height,Matrix.TEMP,"out",o,null,BlendMode.TOINT.overlay),x=SubmitCMD.create([h],Filter._useOut),e.addRenderObject(x));a[E].action.apply3d(h,t,e,0,0)}x=SubmitCMD.create([h,e],Filter._EndTarget),e.addRenderObject(x)}else{if(m=!!t._$P._isHaveGlowFilter&&t._$P._isHaveGlowFilter,m&&(d=50,f=25),l=t.getBounds(),l.width<=0||l.height<=0)return;l.width+=d,l.height+=d,_.x=l.x*c.a+l.y*c.c,_.y=l.y*c.d+l.x*c.b,l.x=_.x,l.y=_.y,_.x=l.width*c.a+l.height*c.c,_.y=l.height*c.d+l.width*c.b,l.width=_.x,l.height=_.y,h.addValue("out",p)}n=n-f-t.x,i=i-f-t.y,_.setTo(n,i),c.transformPoint(_),n=_.x+l.x,i=_.y+l.y,o=Value2D.create(1,0),Matrix.TEMP.identity(),e.ctx.drawTarget(h,n,i,l.width,l.height,Matrix.TEMP,"out",o,null,BlendMode.TOINT.overlay),x=SubmitCMD.create([h],Filter._recycleScope),e.addRenderObject(x),c.destroy()}},Float32Array.prototype.slice||(Float32Array.prototype.slice=t._float32ArraySlice),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=t._uint16ArraySlice),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=t._uint8ArraySlice),!0},t.onStageResize=function(e,n){null!=t.mainContext&&(t.mainContext.viewport(0,0,e,n),RenderState2D.width=e,RenderState2D.height=n)},t.onInvalidGLRes=function(){AtlasResourceManager.instance.freeAll(),ResourceManager.releaseContentManagers(!0),t.doNodeRepaint(Laya.stage),t.mainContext.viewport(0,0,RenderState2D.width,RenderState2D.height),Laya.stage.event("devicelost")},t.doNodeRepaint=function(e){0==e.numChildren&&e.repaint();for(var n=0;n<e.numChildren;n++)t.doNodeRepaint(e.getChildAt(n))},t.init=function(e,n,i){t.mainCanvas=e,HTMLCanvas._createContext=function(t){return new WebGLContext2D(t)};var r=laya.webgl.WebGL.mainContext;if(null!=r.getShaderPrecisionFormat){var a=r.getShaderPrecisionFormat(35633,36338),s=r.getShaderPrecisionFormat(35632,36338);t.shaderHighPrecision=!(!a.precision||!s.precision)}else t.shaderHighPrecision=!1;if(t.compressAstc=r.getExtension("WEBGL_compressed_texture_astc"),t.compressAtc=r.getExtension("WEBGL_compressed_texture_atc"),t.compressEtc=r.getExtension("WEBGL_compressed_texture_etc"),t.compressEtc1=r.getExtension("WEBGL_compressed_texture_etc1"),t.compressPvrtc=r.getExtension("WEBGL_compressed_texture_pvrtc"),t.compressS3tc=r.getExtension("WEBGL_compressed_texture_s3tc"),t.compressS3tc_srgb=r.getExtension("WEBGL_compressed_texture_s3tc_srgb"),r.deleteTexture1=r.deleteTexture,r.deleteTexture=function(t){t==WebGLContext.curBindTexValue&&(WebGLContext.curBindTexValue=null),r.deleteTexture1(t)},t.onStageResize(n,i),null==t.mainContext)throw new Error("webGL getContext err!");System.__init__(),AtlasResourceManager.__init__(),ShaderDefines2D.__init__(),Submit.__init__(),WebGLContext2D.__init__(),Value2D.__init__(),Shader2D.__init__(),Buffer2D.__int__(r),BlendMode._init_(r),Render.isConchApp&&conch.setOnInvalidGLRes(t.onInvalidGLRes)},t.compressAstc=null,t.compressAtc=null,t.compressEtc=null,t.compressEtc1=null,t.compressPvrtc=null,t.compressS3tc=null,t.compressS3tc_srgb=null,t.mainCanvas=null,t.mainContext=null,t.antialias=!0,t.shaderHighPrecision=!1,t._bg_null=[0,0,0,0],t}(),ShaderDefines=function(){function t(t,e,n){this._value=0,this._name2int=t,this._int2name=e,this._int2nameMap=n}__class(t,"laya.webgl.shader.ShaderDefines");var e=t.prototype;return e.add=function(t){return"string"==typeof t&&(t=this._name2int[t]),this._value|=t,this._value},e.addInt=function(t){return this._value|=t,this._value},e.remove=function(t){return"string"==typeof t&&(t=this._name2int[t]),this._value&=~t,this._value},e.isDefine=function(t){return(this._value&t)===t},e.getValue=function(){return this._value},e.setValue=function(t){this._value=t},e.toNameDic=function(){var e=this._int2nameMap[this._value];return e||t._toText(this._value,this._int2name,this._int2nameMap)},t._reg=function(t,e,n,i){n[t]=e,i[e]=t},t._toText=function(t,e,n){var i=n[t];if(i)return i;for(var r={},a=1,s=0;s<32&&!((a=1<<s)>t);s++)if(t&a){var o=e[a];o&&(r[o]="")}return n[t]=r,r},t._toInt=function(t,e){for(var n=t.split("."),i=0,r=0,a=n.length;r<a;r++){var s=e[n[r]];if(!s)throw new Error("Defines to int err:"+t+"/"+n[r]);i|=s}return i},t}(),Shader2D=function(){function t(){this.ALPHA=1,this.shaderType=0,this.defines=new ShaderDefines2D}return __class(t,"laya.webgl.shader.d2.Shader2D"),t.prototype.destroy=function(){this.defines=null,this.filters=null,this.glTexture=null,this.strokeStyle=null,this.fillStyle=null},t.__init__=function(){Shader.addInclude("parts/ColorFilter_ps_uniform.glsl","uniform vec4 colorAlpha;\nuniform mat4 colorMat;"),Shader.addInclude("parts/ColorFilter_ps_logic.glsl","mat4 alphaMat =colorMat;\n\nalphaMat[0][3] *= gl_FragColor.a;\nalphaMat[1][3] *= gl_FragColor.a;\nalphaMat[2][3] *= gl_FragColor.a;\n\ngl_FragColor = gl_FragColor * alphaMat;\ngl_FragColor += colorAlpha/255.0*gl_FragColor.a;\n"),Shader.addInclude("parts/GlowFilter_ps_uniform.glsl","uniform vec4 u_color;\nuniform float u_strength;\nuniform float u_blurX;\nuniform float u_blurY;\nuniform float u_offsetX;\nuniform float u_offsetY;\nuniform float u_textW;\nuniform float u_textH;"),Shader.addInclude("parts/GlowFilter_ps_logic.glsl","const float c_IterationTime = 10.0;\nfloat floatIterationTotalTime = c_IterationTime * c_IterationTime;\nvec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\nvec2 vec2FilterDir = vec2(-(u_offsetX)/u_textW,-(u_offsetY)/u_textH);\nvec2 vec2FilterOff = vec2(u_blurX/u_textW/c_IterationTime * 2.0,u_blurY/u_textH/c_IterationTime * 2.0);\nfloat maxNum = u_blurX * u_blurY;\nvec2 vec2Off = vec2(0.0,0.0);\nfloat floatOff = c_IterationTime/2.0;\nfor(float i = 0.0;i<=c_IterationTime; ++i){\n\tfor(float j = 0.0;j<=c_IterationTime; ++j){\n\t\tvec2Off = vec2(vec2FilterOff.x * (i - floatOff),vec2FilterOff.y * (j - floatOff));\n\t\tvec4Color += texture2D(texture, v_texcoord + vec2FilterDir + vec2Off)/floatIterationTotalTime;\n\t}\n}\ngl_FragColor = vec4(u_color.rgb,vec4Color.a * u_strength);\ngl_FragColor.rgb *= gl_FragColor.a;"),Shader.addInclude("parts/BlurFilter_ps_logic.glsl","gl_FragColor =   blur();\ngl_FragColor.w*=alpha;"),Shader.addInclude("parts/BlurFilter_ps_uniform.glsl","uniform vec4 strength_sig2_2sig2_gauss1;\nuniform vec2 blurInfo;\n\n#define PI 3.141593\n\n//float sigma=strength/3.0;//3σ以外影响很小。即当σ=1的时候，半径为3\n//float sig2 = sigma*sigma;\n//float _2sig2 = 2.0*sig2;\n//return 1.0/(2*PI*sig2)*exp(-(x*x+y*y)/_2sig2)\n//float gauss1 = 1.0/(2.0*PI*sig2);\n\nfloat getGaussian(float x, float y){\n    return strength_sig2_2sig2_gauss1.w*exp(-(x*x+y*y)/strength_sig2_2sig2_gauss1.z);\n}\n\nvec4 blur(){\n    const float blurw = 9.0;\n    vec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\n    vec2 halfsz=vec2(blurw,blurw)/2.0/blurInfo;    \n    vec2 startpos=v_texcoord-halfsz;\n    vec2 ctexcoord = startpos;\n    vec2 step = 1.0/blurInfo;  //每个像素      \n    \n    for(float y = 0.0;y<=blurw; ++y){\n        ctexcoord.x=startpos.x;\n        for(float x = 0.0;x<=blurw; ++x){\n            //TODO 纹理坐标的固定偏移应该在vs中处理\n            vec4Color += texture2D(texture, ctexcoord)*getGaussian(x-blurw/2.0,y-blurw/2.0);\n            ctexcoord.x+=step.x;\n        }\n        ctexcoord.y+=step.y;\n    }\n    return vec4Color;\n}"),Shader.addInclude("parts/ColorAdd_ps_uniform.glsl","uniform vec4 colorAdd;\n"),Shader.addInclude("parts/ColorAdd_ps_logic.glsl","gl_FragColor = vec4(colorAdd.rgb,colorAdd.a*gl_FragColor.a);\ngl_FragColor.xyz *= colorAdd.a;");var t,e;t="attribute vec4 position;\nattribute vec2 texcoord;\nuniform vec2 size;\n\n#ifdef WORLDMAT\nuniform mat4 mmat;\n#endif\nvarying vec2 v_texcoord;\nvoid main() {\n  #ifdef WORLDMAT\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  #else\n  gl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n  #endif\n  \n  v_texcoord = texcoord;\n}",e='precision mediump float;\n//precision highp float;\nvarying vec2 v_texcoord;\nuniform sampler2D texture;\nuniform float alpha;\n#include?BLUR_FILTER  "parts/BlurFilter_ps_uniform.glsl";\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\n#include?GLOW_FILTER "parts/GlowFilter_ps_uniform.glsl";\n#include?COLOR_ADD "parts/ColorAdd_ps_uniform.glsl";\n\nvoid main() {\n   vec4 color= texture2D(texture, v_texcoord);\n   color.a*=alpha;\n   color.rgb*=alpha;\n   gl_FragColor=color;\n   #include?COLOR_ADD "parts/ColorAdd_ps_logic.glsl";   \n   #include?BLUR_FILTER  "parts/BlurFilter_ps_logic.glsl";\n   #include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n   #include?GLOW_FILTER "parts/GlowFilter_ps_logic.glsl";\n}',Shader.preCompile2D(0,1,t,e,null),t="attribute vec4 position;\nuniform vec2 size;\nuniform mat4 mmat;\nvoid main() {\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n}",e='precision mediump float;\nuniform vec4 color;\nuniform float alpha;\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\nvoid main() {\n\tvec4 a = vec4(color.r, color.g, color.b, color.a);\n\ta.w = alpha;\n\ta.xyz *= alpha;\n\tgl_FragColor = a;\n\t#include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n}',Shader.preCompile2D(0,2,t,e,null),t="attribute vec4 position;\nattribute vec3 a_color;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nuniform vec2 u_pos;\nuniform vec2 size;\nvarying vec3 color;\nvoid main(){\n  vec4 tPos = vec4(position.x + u_pos.x,position.y + u_pos.y,position.z,position.w);\n  vec4 pos=mmat*u_mmat2*tPos;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  color=a_color;\n}",e="precision mediump float;\n//precision mediump float;\nvarying vec3 color;\nuniform float alpha;\nvoid main(){\n\t//vec4 a=vec4(color.r, color.g, color.b, 1);\n\t//a.a*=alpha;\n    gl_FragColor=vec4(color.r, color.g, color.b, alpha);\n\tgl_FragColor.rgb*=alpha;\n}",Shader.preCompile2D(0,4,t,e,null),t="attribute vec4 position;\nattribute vec2 texcoord;\nuniform vec2 size;\n\n#ifdef WORLDMAT\nuniform mat4 mmat;\n#endif\nvarying vec2 v_texcoord;\nvoid main() {\n  #ifdef WORLDMAT\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  #else\n  gl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n  #endif\n  \n  v_texcoord = texcoord;\n}",e='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n//precision highp float;\nvarying vec2 v_texcoord;\nuniform sampler2D texture;\nuniform float alpha;\nuniform vec4 u_TexRange;\nuniform vec2 u_offset;\n#include?BLUR_FILTER  "parts/BlurFilter_ps_uniform.glsl";\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\n#include?GLOW_FILTER "parts/GlowFilter_ps_uniform.glsl";\n#include?COLOR_ADD "parts/ColorAdd_ps_uniform.glsl";\n\nvoid main() {\n   vec2 newTexCoord;\n   newTexCoord.x = mod(u_offset.x + v_texcoord.x,u_TexRange.y) + u_TexRange.x;\n   newTexCoord.y = mod(u_offset.y + v_texcoord.y,u_TexRange.w) + u_TexRange.z;\n   vec4 color= texture2D(texture, newTexCoord);\n   color.a*=alpha;\n   gl_FragColor=color;\n   #include?COLOR_ADD "parts/ColorAdd_ps_logic.glsl";   \n   #include?BLUR_FILTER  "parts/BlurFilter_ps_logic.glsl";\n   #include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n   #include?GLOW_FILTER "parts/GlowFilter_ps_logic.glsl";\n}',Shader.preCompile2D(0,256,t,e,null),
t="attribute vec2 position;\nattribute vec2 texcoord;\nattribute vec4 color;\nuniform vec2 size;\nuniform float offsetX;\nuniform float offsetY;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nvoid main() {\n  vec4 pos=mmat*u_mmat2*vec4(offsetX+position.x,offsetY+position.y,0,1 );\n  gl_Position = vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  v_color = color;\n  v_color.rgb *= v_color.a;\n  v_texcoord = texcoord;  \n}",e="precision mediump float;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nuniform sampler2D texture;\nuniform float alpha;\nvoid main() {\n\tvec4 t_color = texture2D(texture, v_texcoord);\n\tgl_FragColor = t_color.rgba * v_color;\n\tgl_FragColor *= alpha;\n}",Shader.preCompile2D(0,512,t,e,null)},t}(),ShaderValue=function(){function t(){}return __class(t,"laya.webgl.shader.ShaderValue"),t}(),SkinMesh=function(){function t(){this.mVBBuffer=null,this.mIBBuffer=null,this.mVBData=null,this.mIBData=null,this.mEleNum=0,this.mTexture=null,this.transform=null,this._vs=null,this._ps=null,this._indexStart=-1,this._verticles=null,this._uvs=null,this._tempMatrix=new Matrix}__class(t,"laya.webgl.shader.d2.skinAnishader.SkinMesh");var e=t.prototype;return e.init=function(e,n,i){if(n)this._vs=n;else{this._vs=[];var r=e.width,a=e.height;this._vs.push(0,0,0,0,1,1,1,1),this._vs.push(r,0,1,0,1,1,1,1),this._vs.push(r,a,1,1,1,1,1,1),this._vs.push(0,a,0,1,1,1,1,1)}i?this._ps=i:(t._defaultPS||(t._defaultPS=[],t._defaultPS.push(0,1,3,3,1,2)),this._ps=t._defaultPS),this.mVBData=new Float32Array(this._vs),this.mIBData=new Uint16Array(this._ps.length),this.mIBData.start=-1,this.mEleNum=this._ps.length,this.mTexture=e},e.init2=function(t,e,n,i,r){this.transform&&(this.transform=null),n?this._ps=n:(this._ps=[],this._ps.push(0,1,3,3,1,2)),this._verticles=i,this._uvs=r,this.mEleNum=this._ps.length,this.mTexture=t,(Render.isConchNode||Render.isConchApp)&&(this._initMyData(),this.mVBData=new Float32Array(this._vs))},e._initMyData=function(){var e=0,n=0,i=this._verticles.length,r=4*i;this._vs=t._tempVS;var a=!1;if(Render.isConchNode||Render.isConchApp?(this._vs.length=r,a=!0):this._vs.length<r&&(this._vs.length=r,a=!0),t._tVSLen=r,a)for(;e<r;)this._vs[e]=this._verticles[n],this._vs[e+1]=this._verticles[n+1],this._vs[e+2]=this._uvs[n],this._vs[e+3]=this._uvs[n+1],this._vs[e+4]=1,this._vs[e+5]=1,this._vs[e+6]=1,this._vs[e+7]=1,e+=8,n+=2;else for(;e<r;)this._vs[e]=this._verticles[n],this._vs[e+1]=this._verticles[n+1],this._vs[e+2]=this._uvs[n],this._vs[e+3]=this._uvs[n+1],e+=8,n+=2},e.getData2=function(e,n,i){this.mVBBuffer=e,this.mIBBuffer=n,this._initMyData(),e.appendEx2(this._vs,Float32Array,t._tVSLen,4),this._indexStart=n._byteLength;var r;r=t._tempIB,r.length<this._ps.length&&(r.length=this._ps.length);for(var a=0,s=this._ps.length;a<s;a++)r[a]=this._ps[a]+i;n.appendEx2(r,Uint16Array,this._ps.length,2)},e.getData=function(t,e,n){if(this.mVBBuffer=t,this.mIBBuffer=e,t.append(this.mVBData),this._indexStart=e._byteLength,this.mIBData.start!=n){for(var i=0,r=this._ps.length;i<r;i++)this.mIBData[i]=this._ps[i]+n;this.mIBData.start=n}e.append(this.mIBData)},e.render=function(t,e,n){if(Render.isWebGL&&this.mTexture){t._renderKey=0,t._shader2D.glTexture=null,SkinMeshBuffer.getInstance().addSkinMesh(this);var i=Submit.createShape(t,this.mIBBuffer,this.mVBBuffer,this.mEleNum,this._indexStart,Value2D.create(512,0));this.transform||(this.transform=Matrix.EMPTY),this.transform.translate(e,n),Matrix.mul(this.transform,t._curMat,this._tempMatrix),this.transform.translate(-e,-n);var r=i.shaderValue,a=r.u_mmat2||RenderState2D.getMatrArray();RenderState2D.mat2MatArray(this._tempMatrix,a),r.textureHost=this.mTexture,r.offsetX=0,r.offsetY=0,r.u_mmat2=a,r.ALPHA=t._shader2D.ALPHA,t._submits[t._submits._length++]=i}else Render.isConchApp&&this.mTexture&&(this.transform||(this.transform=Matrix.EMPTY),t.setSkinMesh&&t.setSkinMesh(e,n,this._ps,this.mVBData,this.mEleNum,0,this.mTexture,this.transform))},t._tempVS=[],t._tempIB=[],t._defaultPS=null,t._tVSLen=0,t}(),SkinMeshBuffer=function(){function t(){this.ib=null,this.vb=null;WebGL.mainContext;this.ib=IndexBuffer2D.create(35048),this.vb=VertexBuffer2D.create(8)}__class(t,"laya.webgl.shader.d2.skinAnishader.SkinMeshBuffer");var e=t.prototype;return e.addSkinMesh=function(t){t.getData2(this.vb,this.ib,this.vb._byteLength/32)},e.reset=function(){this.vb.clear(),this.ib.clear()},t.getInstance=function(){return t.instance=t.instance||new t},t.instance=null,t}(),FontInContext=function(){function t(e){this._index=0,this._size=14,this._italic=-2,t._cache2=t._cache2||[],this.setFont(e||"14px Arial")}__class(t,"laya.webgl.text.FontInContext");var e=t.prototype;return e.setFont=function(e){var n=t._cache2[e];if(n)this._words=n[0],this._size=n[1];else{this._words=e.split(" ");for(var i=0,r=this._words.length;i<r;i++)if(this._words[i].indexOf("px")>0){this._index=i;break}this._size=parseInt(this._words[this._index]),t._cache2[e]=[this._words,this._size]}this._text=null,this._italic=-2},e.getItalic=function(){return-2===this._italic&&(this._italic=this.hasType("italic")),this._italic},e.hasType=function(t){for(var e=0,n=this._words.length;e<n;e++)if(this._words[e]===t)return e;return-1},e.removeType=function(t){for(var e=0,n=this._words.length;e<n;e++)if(this._words[e]===t){this._words.splice(e,1),this._index>e&&this._index--;break}this._text=null,this._italic=-2},e.copyTo=function(t){return t._text=this._text,t._size=this._size,t._index=this._index,t._words=this._words.slice(),t._italic=-2,t},e.toString=function(){return this._text?this._text:this._text=this._words.join(" ")},__getset(0,e,"size",function(){return this._size},function(t){this._size=t,this._words[this._index]=t+"px",this._text=null}),t.create=function(e){var n=t._cache[e];return n||(n=t._cache[e]=new t(e))},t.EMPTY=new t,t._cache={},t._cache2=null,t}(),CharSegment=function(){function t(){this._sourceStr=null}__class(t,"laya.webgl.text.CharSegment");var e=t.prototype;return Laya.imps(e,{"laya.webgl.text.ICharSegment":!0}),e.textToSpit=function(t){this._sourceStr=t},e.getChar=function(t){return this._sourceStr.charAt(t)},e.getCharCode=function(t){return this._sourceStr.charCodeAt(t)},e.length=function(){return this._sourceStr.length},t}(),DrawText=function(){function t(){}var e;return __class(t,"laya.webgl.text.DrawText"),t.__init__=function(){t._charsTemp=new Array,t._drawValue=new e,t._charSeg=new CharSegment},t.customCharSeg=function(e){t._charSeg=e},t.getChar=function(e,n,i){var r=WebGLCharImage.createOneChar(e,i);return-1!=n&&(t._charsCache[n]=r),r},t._drawSlow=function(e,n,i,r,a,s,o,l,h,_,u,c,d,f,m){var p,g,v=t._drawValue.value(s,l,h,_,d,f,m),x=0,S=0,T=t._charsTemp,E=0,y=NaN;if(r)for(T.length=r.length,x=0,S=r.length;x<S;x++)g=r[x],y=g.charNum+v.txtID,T[x]=p=t._charsCache[y]||t.getChar(g.char,y,v),p.active();else{var M=i instanceof laya.utils.WordText?i.toString():i;if(Text.CharacterCache){t._charSeg.textToSpit(M);var D=t._charSeg.length();for(T.length=D,x=0,S=D;x<S;x++)y=t._charSeg.getCharCode(x)+v.txtID,T[x]=p=t._charsCache[y]||t.getChar(t._charSeg.getChar(x),y,v),p.active(),E+=p.cw}else T.length=0,p=t.getChar(M,-1,v),p.active(),E+=p.cw,T[0]=p}var C=0;null!==o&&"left"!==o&&(C=-("center"==o?E/2:E));var R,A,b=NaN,I=0;if(r)for(x=0,S=T.length;x<S;x++)p=T[x],p.isSpace||(g=r[x],b=p.borderSize,R=p.texture,n._drawText(R,u+C+g.x*d-b,c+g.y*f-b,R.width,R.height,a,0,0,0,0));else{for(x=0,S=T.length;x<S;x++)p=T[x],p.isSpace||(b=p.borderSize,R=p.texture,n._drawText(R,u+C-b,c-b,R.width,R.height,a,0,0,0,0),e&&(A=e[I++],A||(A=e[I-1]=[]),A[0]=R,A[1]=C-b,A[2]=-b)),C+=p.cw;e&&(e.length=I)}},t._drawFast=function(t,e,n,i,r){for(var a,s,o=0,l=t.length;o<l;o++)s=t[o],a=s[0],a.active(),e._drawText(a,i+s[1],r+s[2],a.width,a.height,n,0,0,0,0)},t.drawText=function(e,n,i,r,a,s,o,l,h,_,u,c){if(void 0===c&&(c=0),!(n&&0===n.length||i&&0===i.length)){var d=r.a,f=r.d;(0!==r.b||0!==r.c)&&(d=f=1);var m=1!==d||1!==f;if(m&&Laya.stage.transform){var p=Laya.stage.transform;m=p.a===d&&p.d===f}else m=!1;if(m){r=r.copyTo(WebGLContext2D._tmpMatrix);var g=r.tx,v=r.ty;r.scale(1/d,1/f),r._checkTransform(),_*=d,u*=f,_+=g-r.tx,u+=v-r.ty}else d=f=1;if(i)t._drawSlow(null,e,n,i,r,a,s,o,l,h,_,u,d,f,c);else{if(null===n.toUpperCase){var x=d+1e5*f,S=n;return void(S.changed||S.id!==x?(S.id=x,S.changed=!1,t._drawSlow(S.save,e,n,i,r,a,s,o,l,h,_,u,d,f,c)):t._drawFast(S.save,e,r,_,u))}var T=n+a.toString()+o+l+h+d+f+s,E=t._textsCache[T];Text.CharacterCache?E?t._drawFast(E,e,r,_,u):(t._textsCache.__length||(t._textsCache.__length=0),t._textsCache.__length>Config.WebGLTextCacheCount&&(t._textsCache={},t._textsCache.__length=0,t._curPoolIndex=0),t._textCachesPool[t._curPoolIndex]?(E=t._textsCache[T]=t._textCachesPool[t._curPoolIndex],E.length=0):t._textCachesPool[t._curPoolIndex]=E=t._textsCache[T]=[],t._textsCache.__length++,t._curPoolIndex++,t._drawSlow(E,e,n,i,r,a,s,o,l,h,_,u,d,f,c)):t._drawSlow(E,e,n,i,r,a,s,o,l,h,_,u,d,f,c)}}},t._charsTemp=null,t._textCachesPool=[],t._curPoolIndex=0,t._charsCache={},t._textsCache={},t._drawValue=null,t.d=[],t._charSeg=null,t.__init$=function(){e=function(){function t(){}return __class(t,""),t.prototype.value=function(e,n,i,r,a,s,o){this.font=e,this.fillColor=n,this.borderColor=i,this.lineWidth=r,this.scaleX=a,this.scaleY=s,this.underLine=o;var l=e.toString()+a+s+r+n+i+o;return this.txtID=t._keymap[l],this.txtID||(this.txtID=1e-7*++t._keymapCount,t._keymap[l]=this.txtID),this},t.clear=function(){t._keymap={},t._keymapCount=1},t._keymap={},t._keymapCount=1,t}()},t}(),AtlasGrid=function(){function t(t,e,i){this._atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._failSize=new n,void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._cells=null,this._rowInfo=null,this._init(t,e),this._atlasID=i}var e,n;__class(t,"laya.webgl.atlas.AtlasGrid");var i=t.prototype;return i.getAltasID=function(){return this._atlasID},i.setAltasID=function(t){t>=0&&(this._atlasID=t)},i.addTex=function(t,e,n){var i=this._get(e,n);return 0==i.ret?i:(this._fill(i.x,i.y,e,n,t),this._texCount++,i)},i._release=function(){null!=this._cells&&(this._cells.length=0,this._cells=null),this._rowInfo&&(this._rowInfo.length=0,this._rowInfo=null)},i._init=function(t,n){if(this._width=t,this._height=n,this._release(),0==this._width)return!1;this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=__newvec(this._height);for(var i=0;i<this._height;i++)this._rowInfo[i]=new e;return this._clear(),!0},i._get=function(t,e){var n=new MergeFillInfo;if(t>=this._failSize.width&&e>=this._failSize.height)return n;for(var i=-1,r=-1,a=this._width,s=this._height,o=this._cells,l=0;l<s;l++)if(!(this._rowInfo[l].spaceCount<t))for(var h=0;h<a;){var _=3*(l*a+h);if(0!=o[_]||o[_+1]<t||o[_+2]<e)h+=o[_+1];else{i=h,r=l;for(var u=0;u<t;u++)if(o[3*u+_+2]<e){i=-1;break}if(!(i<0))return n.ret=!0,n.x=i,n.y=r,n;h+=o[_+1]}}return n},i._fill=function(t,e,n,i,r){var a=this._width,s=this._height;this._check(t+n<=a&&e+i<=s);for(var o=e;o<i+e;++o){this._check(this._rowInfo[o].spaceCount>=n),this._rowInfo[o].spaceCount-=n;for(var l=0;l<n;l++){var h=3*(t+o*a+l);this._check(0==this._cells[h]),this._cells[h]=r,this._cells[h+1]=n,this._cells[h+2]=i}}if(t>0)for(o=0;o<i;++o){var _=0;for(l=t-1;l>=0&&0==this._cells[3*((e+o)*a+l)];--l,++_);for(l=_;l>0;--l)this._cells[3*((e+o)*a+t-l)+1]=l,this._check(l>0)}if(e>0)for(l=t;l<t+n;++l){for(_=0,o=e-1;o>=0&&0==this._cells[3*(l+o*a)];--o,_++);for(o=_;o>0;--o)this._cells[3*(l+(e-o)*a)+2]=o,this._check(o>0)}},i._check=function(t){0==t&&console.log("xtexMerger 错误啦")},i._clear=function(){this._texCount=0;for(var t=0;t<this._height;t++)this._rowInfo[t].spaceCount=this._width;for(var e=0;e<this._height;e++)for(var n=0;n<this._width;n++){var i=3*(e*this._width+n);this._cells[i]=0,this._cells[i+1]=this._width-n,this._cells[i+2]=this._width-e}this._failSize.width=this._width+1,this._failSize.height=this._height+1},t.__init$=function(){e=function(){function t(){this.spaceCount=0}return __class(t,""),t}(),n=function(){function t(){this.width=0,this.height=0}return __class(t,""),t}()},t}(),MergeFillInfo=function(){function t(){this.x=0,this.y=0,this.ret=!1,this.ret=!1,this.x=0,this.y=0}return __class(t,"laya.webgl.atlas.MergeFillInfo"),t}(),AtlasResourceManager=function(){function t(t,e,n,i){this._currentAtlasCount=0,this._maxAtlaserCount=0,this._width=0,this._height=0,this._gridSize=0,this._gridNumX=0,this._gridNumY=0,this._init=!1,this._curAtlasIndex=0,this._setAtlasParam=!1,this._atlaserArray=null,this._needGC=!1,this._setAtlasParam=!0,this._width=t,this._height=e,this._gridSize=n,this._maxAtlaserCount=i,this._gridNumX=t/n,this._gridNumY=e/n,this._curAtlasIndex=0,this._atlaserArray=[]}__class(t,"laya.webgl.atlas.AtlasResourceManager");var e=t.prototype;return e.setAtlasParam=function(e,n,i,r){if(1==this._setAtlasParam)return t._sid_=0,this._width=e,this._height=n,this._gridSize=i,this._maxAtlaserCount=r,this._gridNumX=e/i,this._gridNumY=n/i,this._curAtlasIndex=0,this.freeAll(),!0;throw console.log("设置大图合集参数错误，只能在开始页面设置各种参数"),-1},e.pushData=function(e){var n=e.bitmap,i=-1,r=null,a=0,s=0,o=0;for(a=0,s=this._atlaserArray.length;a<s&&(o=(this._curAtlasIndex+a)%s,r=this._atlaserArray[o],-1==(i=r.findBitmapIsExist(n)));a++);if(-1!=i){var l=r.InAtlasWebGLImagesOffsetValue[i];return m=l[0],p=l[1],r.addToAtlas(e,m,p),!0}this._setAtlasParam=!1;for(var h=Math.ceil((e.bitmap.width+2)/this._gridSize),_=Math.ceil((e.bitmap.height+2)/this._gridSize),u=!1,c=0;c<2;c++){var d=this._maxAtlaserCount;for(a=0;a<d;a++){o=(this._curAtlasIndex+a)%d,this._atlaserArray.length-1>=o||this._atlaserArray.push(new Atlaser(this._gridNumX,this._gridNumY,this._width,this._height,t._sid_++));var f=this._atlaserArray[o],m=0,p=0,g=f.addTex(1,h,_);if(g.ret){m=g.x*this._gridSize+1,p=g.y*this._gridSize+1,n.lock=!0,f.addToAtlasTexture(n,m,p),f.addToAtlas(e,m,p),u=!0,this._curAtlasIndex=o;break}}if(u)break;this._atlaserArray.push(new Atlaser(this._gridNumX,this._gridNumY,this._width,this._height,t._sid_++)),this._needGC=!0,this.garbageCollection(),this._curAtlasIndex=this._atlaserArray.length-1}return u||console.log(">>>AtlasManager pushData error"),u},e.addToAtlas=function(t){laya.webgl.atlas.AtlasResourceManager.instance.pushData(t)},e.garbageCollection=function(){if(!0===this._needGC){for(var t=this._atlaserArray.length-this._maxAtlaserCount,e=0;e<t;e++)this._atlaserArray[e].dispose(),console.log("AtlasResourceManager:Dispose the inner Atlas。");console.log(">>>>altas garbageCollection ="+t),this._atlaserArray.splice(0,t),this._needGC=!1}return!0},e.freeAll=function(){for(var t=0,e=this._atlaserArray.length;t<e;t++)this._atlaserArray[t].dispose();this._atlaserArray.length=0,this._curAtlasIndex=0},e.getAtlaserCount=function(){return this._atlaserArray.length},e.getAtlaserByIndex=function(t){return this._atlaserArray[t]},__getset(1,t,"atlasLimitWidth",function(){return t._atlasLimitWidth},function(e){t._atlasLimitWidth=e}),__getset(1,t,"enabled",function(){return Config.atlasEnable}),__getset(1,t,"atlasLimitHeight",function(){return t._atlasLimitHeight},function(e){t._atlasLimitHeight=e}),__getset(1,t,"instance",function(){return t._Instance||(t._Instance=new t(laya.webgl.atlas.AtlasResourceManager.atlasTextureWidth,laya.webgl.atlas.AtlasResourceManager.atlasTextureHeight,16,laya.webgl.atlas.AtlasResourceManager.maxTextureCount)),t._Instance}),t._enable=function(){Config.atlasEnable=!0},t._disable=function(){Config.atlasEnable=!1},t.__init__=function(){t.atlasTextureWidth=2048,t.atlasTextureHeight=2048,t.maxTextureCount=6,t.atlasLimitWidth=512,t.atlasLimitHeight=512},t._atlasLimitWidth=0,t._atlasLimitHeight=0,t.gridSize=16,t.atlasTextureWidth=0,t.atlasTextureHeight=0,t.maxTextureCount=0,t._atlasRestore=0,t.BOARDER_TYPE_NO=0,t.BOARDER_TYPE_RIGHT=1,t.BOARDER_TYPE_LEFT=2,t.BOARDER_TYPE_BOTTOM=4,t.BOARDER_TYPE_TOP=8,t.BOARDER_TYPE_ALL=15,t._sid_=0,t._Instance=null,t}(),RenderTargetMAX=function(){function t(){this.target=null,this.repaint=!1,this._width=NaN,this._height=NaN,this._sp=null,this._clipRect=new Rectangle}__class(t,"laya.webgl.resource.RenderTargetMAX");var e=t.prototype;return e.setSP=function(t){this._sp=t},e.size=function(t,e){var n=this;if(this._width===t&&this._height===e)return void this.target.size(t,e);this.repaint=!0,this._width=t,this._height=e,this.target?this.target.size(t,e):this.target=RenderTarget2D.create(t,e),this.target.hasListener("recovered")||this.target.on("recovered",this,function(t){Laya.timer.callLater(n._sp,n._sp.repaint)})},e._flushToTarget=function(t,e){if(!e._destroy){var n=RenderState2D.worldScissorTest,i=RenderState2D.worldClipRect;RenderState2D.worldClipRect=this._clipRect,this._clipRect.x=this._clipRect.y=0,this._clipRect.width=this._width,this._clipRect.height=this._height,RenderState2D.worldScissorTest=!1,WebGL.mainContext.disable(3089);var r=RenderState2D.worldAlpha,a=RenderState2D.worldMatrix4,s=RenderState2D.worldMatrix,o=RenderState2D.worldFilters,l=RenderState2D.worldShaderDefines;if(RenderState2D.worldMatrix=Matrix.EMPTY,RenderState2D.restoreTempArray(),RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY,RenderState2D.worldAlpha=1,RenderState2D.worldFilters=null,RenderState2D.worldShaderDefines=null,BaseShader.activeShader=null,e.start(),Config.showCanvasMark?e.clear(0,1,0,.3):e.clear(0,0,0,0),t.flush(),e.end(),BaseShader.activeShader=null,RenderState2D.worldAlpha=r,RenderState2D.worldMatrix4=a,RenderState2D.worldMatrix=s,RenderState2D.worldFilters=o,RenderState2D.worldShaderDefines=l,RenderState2D.worldScissorTest=n,n){var h=RenderState2D.height-i.y-i.height;WebGL.mainContext.scissor(i.x,h,i.width,i.height),WebGL.mainContext.enable(3089)}RenderState2D.worldClipRect=i}},e.flush=function(t){this.repaint&&(this._flushToTarget(t,this.target),this.repaint=!1)},e.drawTo=function(t,e,n,i,r){t.drawTexture(this.target.getTexture(),e,n,i,r,0,0)},e.destroy=function(){this.target&&(this.target.destroy(),this.target=null,this._sp=null)},t}(),Stat=function(){function t(){}return __class(t,"laya.utils.Stat"),__getset(1,t,"onclick",null,function(e){t._sp.on("click",t._sp,e)}),t.show=function(e,n){if(void 0===e&&(e=0),void 0===n&&(n=0),Render.isConchApp)return void(Browser.window.conch.showFPS&&Browser.window.conch.showFPS(e,n));var i=t._sp,r=Browser.pixelRatio;i||(i=new Sprite,t._leftText=new Text,t._leftText.pos(5,5),t._leftText.color="#ffffff",i.addChild(t._leftText),t._txt=new Text,t._txt.pos(80*r,5),t._txt.color="#ffffff",i.addChild(t._txt),t._sp=i),i.pos(e,n),t._show=!0,t._fpsData.length=60,t._view[0]={title:"FPS(Canvas)",value:"_fpsStr",color:"yellow",units:"int"},t._view[1]={title:"Sprite",value:"_spriteStr",color:"white",units:"int"},t._view[2]={title:"DrawCall",value:"drawCall",color:"white",units:"int"},t._view[3]={title:"CurMem",value:"currentMemorySize",color:"yellow",units:"M"},Render.isWebGL?(t._view[4]={title:"Shader",value:"shaderCall",color:"white",units:"int"},Render.is3DMode?(t._view[0].title="FPS(3D)",t._view[5]={title:"TriFaces",value:"trianglesFaces",color:"white",units:"int"},t._view[6]={title:"treeNodeColl",value:"treeNodeCollision",color:"white",units:"int"},t._view[7]={title:"treeSpriteColl",value:"treeSpriteCollision",color:"white",units:"int"}):(t._view[0].title="FPS(WebGL)",t._view[5]={title:"Canvas",value:"_canvasStr",color:"white",units:"int"})):t._view[4]={title:"Canvas",value:"_canvasStr",color:"white",units:"int"};for(var a="",s=0;s<t._view.length;s++){a+=t._view[s].title+"\n"}t._leftText.text=a;var o=138*r,l=r*(12*t._view.length+3*r)+4;t._txt.fontSize=t._fontSize*r,t._leftText.fontSize=t._fontSize*r,i.size(o,l),i.graphics.clear(),i.graphics.setAlpha(.5),i.graphics.drawRect(0,0,o,l,"#999999"),i.graphics.setAlpha(1),t.loop(),t.enable()},t.enable=function(){Laya.timer.frameLoop(1,t,t.loop)},t.hide=function(){t._show=!1,Laya.timer.clear(t,t.loop)},t.clear=function(){t.trianglesFaces=t.drawCall=t.shaderCall=t.spriteCount=t.spriteRenderUseCacheCount=t.treeNodeCollision=t.treeSpriteCollision=t.canvasNormal=t.canvasBitmap=t.canvasReCache=0},t.loop=function(){t._count++;var e=Browser.now();if(!(e-t._timer<1e3)){var n=t._count;if(t.FPS=Math.round(1e3*n/(e-t._timer)),t._show){t.trianglesFaces=Math.round(t.trianglesFaces/n),t.drawCall=Math.round(t.drawCall/n)-2,t.shaderCall=Math.round(t.shaderCall/n)-4,t.spriteCount=Math.round(t.spriteCount/n)-4,t.spriteRenderUseCacheCount=Math.round(t.spriteRenderUseCacheCount/n),t.canvasNormal=Math.round(t.canvasNormal/n),t.canvasBitmap=Math.round(t.canvasBitmap/n),t.canvasReCache=Math.ceil(t.canvasReCache/n),t.treeNodeCollision=Math.round(t.treeNodeCollision/n),t.treeSpriteCollision=Math.round(t.treeSpriteCollision/n);var i=t.FPS>0?Math.floor(1e3/t.FPS).toString():" ";t._fpsStr=t.FPS+(t.renderSlow?" slow":"")+" "+i,t._spriteStr=t.spriteCount+(t.spriteRenderUseCacheCount?"/"+t.spriteRenderUseCacheCount:""),t._canvasStr=t.canvasReCache+"/"+t.canvasNormal+"/"+t.canvasBitmap,t.currentMemorySize=ResourceManager.systemResourceManager.memorySize;for(var r="",a=0;a<t._view.length;a++){var s=t._view[a],o=t[s.value];"M"==s.units&&(o=Math.floor(o/1048576*100)/100+" M"),"K"==s.units&&(o=Math.floor(o/1024*100)/100+" K"),r+=o+"\n"}t._txt.text=r,t.clear()}t._count=0,t._timer=e}},t.FPS=0,t.loopCount=0,t.shaderCall=0,t.drawCall=0,t.trianglesFaces=0,t.spriteCount=0,t.spriteRenderUseCacheCount=0,t.treeNodeCollision=0,t.treeSpriteCollision=0,t.canvasNormal=0,t.canvasBitmap=0,t.canvasReCache=0,t.renderSlow=!1,t.currentMemorySize=0,t._fpsStr=null,t._canvasStr=null,t._spriteStr=null,t._fpsData=[],t._timer=0,t._count=0,t._view=[],t._fontSize=12,t._txt=null,t._leftText=null,t._sp=null,t._show=!1,t}(),Dragging=function(){function t(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}__class(t,"laya.utils.Dragging");var e=t.prototype;return e.start=function(t,e,n,i,r,a,s,o){void 0===o&&(o=.92),this.clearTimer(),this.target=t,this.area=e,this.hasInertia=n,this.elasticDistance=e?i:0,this.elasticBackTime=r,this.data=a,this._disableMouseEvent=s,this.ratio=o,1!=t.globalScaleX||1!=t.globalScaleY?this._parent=t.parent:this._parent=Laya.stage,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,Laya.stage.on("mouseup",this,this.onStageMouseUp),Laya.stage.on("mouseout",this,this.onStageMouseUp),Laya.timer.frameLoop(1,this,this.loop)},e.clearTimer=function(){Laya.timer.clear(this,this.loop),Laya.timer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)},e.stop=function(){this._dragging&&(MouseManager.instance.disableMouseEvent=!1,Laya.stage.off("mouseup",this,this.onStageMouseUp),Laya.stage.off("mouseout",this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())},e.loop=function(){var t=this._parent.getMousePoint(),e=t.x,n=t.y,i=e-this._lastX,r=n-this._lastY;if(this._clickOnly){if(!(Math.abs(i*Laya.stage._canvasTransform.getScaleX())>1||Math.abs(r*Laya.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event("dragstart",this.data),MouseManager.instance.disableMouseEvent=this._disableMouseEvent,this.target._set$P("$_MOUSEDOWN",!1)}else this._offsets.push(i,r);0===i&&0===r||(this._lastX=e,this._lastY=n,this.target.x+=i*this._elasticRateX,this.target.y+=r*this._elasticRateY,this.area&&this.checkArea(),this.target.event("dragmove",this.data))},e.checkArea=function(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target.x<this.area.x)var t=this.area.x-this.target.x;else t=this.target.x>this.area.x+this.area.width?this.target.x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-t/this.elasticDistance),this.target.y<this.area.y)var e=this.area.y-this.target.y;else e=this.target.y>this.area.y+this.area.height?this.target.y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-e/this.elasticDistance)}},e.backToArea=function(){this.target.x=Math.min(Math.max(this.target.x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target.y,this.area.y),this.area.y+this.area.height)},e.onStageMouseUp=function(t){if(MouseManager.instance.disableMouseEvent=!1,Laya.stage.off("mouseup",this,this.onStageMouseUp),Laya.stage.off("mouseout",this,this.onStageMouseUp),Laya.timer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var e=this._offsets.length,n=Math.min(e,6),i=this._offsets.length-n,r=e-1;r>i;r--)this._offsetY+=this._offsets[r--],this._offsetX+=this._offsets[r];this._offsetX=this._offsetX/n*2,this._offsetY=this._offsetY/n*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),Laya.timer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()},e.checkElastic=function(){var t=NaN,e=NaN;if(this.target.x<this.area.x?t=this.area.x:this.target.x>this.area.x+this.area.width&&(t=this.area.x+this.area.width),this.target.y<this.area.y?e=this.area.y:this.target.y>this.area.y+this.area.height&&(e=this.area.y+this.area.height),isNaN(t)&&isNaN(e))this.clear();else{var n={};isNaN(t)||(n.x=t),isNaN(e)||(n.y=e),this._tween=Tween.to(this.target,n,this.elasticBackTime,Ease.sineOut,Handler.create(this,this.clear),0,!1,!1)}},e.tweenMove=function(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event("dragmove",this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(Laya.timer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())},e.clear=function(){if(this.target){this.clearTimer();var t=this.target;this.target=null,this._parent=null,t.event("dragend",this.data)}},t}(),WordText=function(){function t(){this.id=NaN,this.save=[],this.toUpperCase=null,this.changed=!1,this._text=null}__class(t,"laya.utils.WordText");var e=t.prototype;return e.setText=function(t){this.changed=!0,this._text=t},e.toString=function(){return this._text},e.charCodeAt=function(t){return this._text?this._text.charCodeAt(t):NaN},e.charAt=function(t){return this._text?this._text.charAt(t):null},__getset(0,e,"length",function(){return this._text?this._text.length:0}),t}(),Tween=function(){function t(){this.gid=0}__class(t,"laya.utils.Tween");var e=t.prototype;return e.to=function(t,e,n,i,r,a,s){return void 0===a&&(a=0),void 0===s&&(s=!1),this._create(t,e,n,i,r,a,s,!0,!1,!0)},e.from=function(t,e,n,i,r,a,s){return void 0===a&&(a=0),void 0===s&&(s=!1),this._create(t,e,n,i,r,a,s,!1,!1,!0)},e._create=function(e,n,i,r,a,s,o,l,h,_){if(!e)throw new Error("Tween:target is null");this._target=e,this._duration=i,this._ease=r||n.ease||t.easeNone,this._complete=a||n.complete,this._delay=s,this._props=[],this._usedTimer=0,this._startTimer=Browser.now(),this._usedPool=h,this.update=n.update;var u=e.$_GID||(e.$_GID=Utils.getGID());return t.tweenMap[u]?(o&&t.clearTween(e),t.tweenMap[u].push(this)):t.tweenMap[u]=[this],_?s<=0?this.firstStart(e,n,l):Laya.scaleTimer.once(s,this,this.firstStart,[e,n,l]):this._initProps(e,n,l),this},e.firstStart=function(t,e,n){if(t.destroyed)return void this.clear();this._initProps(t,e,n),this._beginLoop()},e._initProps=function(t,e,n){for(var i in e)if("number"==typeof t[i]){var r=n?t[i]:e[i],a=n?e[i]:t[i];this._props.push([i,r,a-r]),n||(t[i]=r)}},e._beginLoop=function(){Laya.scaleTimer.frameLoop(1,this,this._doEase)},e._doEase=function(){this._updateEase(Browser.now())},e._updateEase=function(e){var n=this._target;if(n){if(n.destroyed)return t.clearTween(n);var i=this._usedTimer=e-this._startTimer-this._delay;if(!(i<0)){if(i>=this._duration)return this.complete();for(var r=i>0?this._ease(i,0,1,this._duration):0,a=this._props,s=0,o=a.length;s<o;s++){var l=a[s];n[l[0]]=l[1]+r*l[2]}this.update&&this.update.run()}}},e.complete=function(){if(this._target){Laya.scaleTimer.runTimer(this,this.firstStart);for(var t=this._target,e=this._props,n=this._complete,i=0,r=e.length;i<r;i++){var a=e[i];t[a[0]]=a[1]+a[2]}this.update&&this.update.run(),this.clear(),n&&n.run()}},e.pause=function(){Laya.scaleTimer.clear(this,this._beginLoop),Laya.scaleTimer.clear(this,this._doEase)},e.setStartTime=function(t){this._startTimer=t},e.clear=function(){this._target&&(this._remove(),this._clear())},e._clear=function(){this.pause(),Laya.scaleTimer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._usedPool&&(this.update=null,Pool.recover("tween",this))},e.recover=function(){this._usedPool=!0,this._clear()},e._remove=function(){var e=t.tweenMap[this._target.$_GID];if(e)for(var n=0,i=e.length;n<i;n++)if(e[n]===this){e.splice(n,1);break}},e.restart=function(){this.pause(),this._usedTimer=0,this._startTimer=Browser.now();for(var t=this._props,e=0,n=t.length;e<n;e++){var i=t[e];this._target[i[0]]=i[1]}Laya.scaleTimer.once(this._delay,this,this._beginLoop)},e.resume=function(){this._usedTimer>=this._duration||(this._startTimer=Browser.now()-this._usedTimer-this._delay,this._beginLoop())},__getset(0,e,"progress",null,function(t){var e=t*this._duration;this._startTimer=Browser.now()-this._delay-e}),t.to=function(e,n,i,r,a,s,o,l){return void 0===s&&(s=0),void 0===o&&(o=!1),void 0===l&&(l=!0),Pool.getItemByClass("tween",t)._create(e,n,i,r,a,s,o,!0,l,!0)},t.from=function(e,n,i,r,a,s,o,l){return void 0===s&&(s=0),void 0===o&&(o=!1),void 0===l&&(l=!0),Pool.getItemByClass("tween",t)._create(e,n,i,r,a,s,o,!1,l,!0)},t.clearAll=function(e){if(e&&e.$_GID){var n=t.tweenMap[e.$_GID];if(n){for(var i=0,r=n.length;i<r;i++)n[i]._clear();n.length=0}}},t.clear=function(t){t.clear()},t.clearTween=function(e){t.clearAll(e)},t.easeNone=function(t,e,n,i){return n*t/i+e},t.tweenMap={},t}(),Browser=function(){function t(){}return __class(t,"laya.utils.Browser"),__getset(1,t,"container",function(){return t.__init__(),t._container||(t._container=t.createElement("div"),t._container.id="layaContainer",t.document.body.appendChild(t._container)),t._container},function(e){t._container=e}),__getset(1,t,"pixelRatio",function(){return t.__init__(),t.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?2:RunDriver.getPixelRatio()}),__getset(1,t,"document",function(){return t.__init__(),t._document}),__getset(1,t,"clientHeight",function(){return t.__init__(),t.window.innerHeight||t.document.body.clientHeight||t.document.documentElement.clientHeight}),__getset(1,t,"window",function(){return t.__init__(),t._window}),__getset(1,t,"height",function(){return t.__init__(),(Laya.stage&&Laya.stage.canvasRotation?t.clientWidth:t.clientHeight)*t.pixelRatio}),__getset(1,t,"width",function(){return t.__init__(),(Laya.stage&&Laya.stage.canvasRotation?t.clientHeight:t.clientWidth)*t.pixelRatio}),__getset(1,t,"clientWidth",function(){return t.__init__(),t.window.innerWidth||t.document.body.clientWidth}),t.__init__=function(){if(!t._window){t._window=RunDriver.getWindow(),t._document=t.window.document,t._window.addEventListener("message",function(t){laya.utils.Browser._onMessage(t)},!1),t.document.__createElement=t.document.createElement,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)};var e=window.document.body.style;e.margin=0,e.overflow="hidden",t.userAgent=t.window.navigator.userAgent,t.u=t.userAgent,t.onIOS=!!t.u.match(/\(i[^;]+;(U;)? CPU.+Mac OS X/),t.onMobile=t.u.indexOf("Mobile")>-1,t.onIPhone=t.u.indexOf("iPhone")>-1,
t.onIPad=t.u.indexOf("iPad")>-1,t.onAndriod=t.u.indexOf("Android")>-1||t.u.indexOf("Adr")>-1,t.onWP=t.u.indexOf("Windows Phone")>-1,t.onQQBrowser=t.u.indexOf("QQBrowser")>-1,t.onMQQBrowser=t.u.indexOf("MQQBrowser")>-1||t.u.indexOf("Mobile")>-1&&t.u.indexOf("QQ")>-1,t.onIE=!!t.window.ActiveXObject||"ActiveXObject"in t.window,t.onWeiXin=t.u.indexOf("MicroMessenger")>-1,t.onPC=!t.onMobile,t.onSafari=!!t.u.match(/Version\/\d+\.\d\x20Mobile\/\S+\x20Safari/),t.onFirefox=t.u.indexOf("Firefox")>-1,t.onEdge=t.u.indexOf("Edge")>-1,t.onMiniGame=t.u.indexOf("MiniGame")>-1,t.httpProtocol="http:"==t.window.location.protocol,t.webAudioEnabled=!!(t.window.AudioContext||t.window.webkitAudioContext||t.window.mozAudioContext),t.soundType=t.webAudioEnabled?"WEBAUDIOSOUND":"AUDIOSOUND",Sound=t.webAudioEnabled?WebAudioSound:AudioSound,t.webAudioEnabled&&WebAudioSound.initWebAudio(),AudioSound._initMusicAudio(),t.enableTouch="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,window.focus(),SoundManager._soundClass=Sound,Render._mainCanvas=Render._mainCanvas||HTMLCanvas.create("2D"),t.canvas||(t.canvas=HTMLCanvas.create("2D"),t.context=t.canvas.getContext("2d"))}},t._onMessage=function(e){if(e.data&&"size"==e.data.name){if(t.window.innerWidth=e.data.width,t.window.innerHeight=e.data.height,t.window.__innerHeight=e.data.clientHeight,!t.document.createEvent)return void console.warn("no document.createEvent");var n=t.document.createEvent("HTMLEvents");return n.initEvent("resize",!1,!1),void t.window.dispatchEvent(n)}},t.createElement=function(e){return t.__init__(),t.document.__createElement(e)},t.getElementById=function(e){return t.__init__(),t.document.getElementById(e)},t.removeElement=function(t){t&&t.parentNode&&t.parentNode.removeChild(t)},t.now=function(){return RunDriver.now()},t._window=null,t._document=null,t._container=null,t.userAgent=null,t.u=null,t.onIOS=!1,t.onMobile=!1,t.onIPhone=!1,t.onIPad=!1,t.onAndriod=!1,t.onAndroid=!1,t.onWP=!1,t.onQQBrowser=!1,t.onMQQBrowser=!1,t.onSafari=!1,t.onFirefox=!1,t.onEdge=!1,t.onIE=!1,t.onWeiXin=!1,t.onMiniGame=!1,t.onPC=!1,t.httpProtocol=!1,t.webAudioEnabled=!1,t.soundType=null,t.enableTouch=!1,t.canvas=null,t.context=null,t.__init$=function(){},t}(),StringKey=function(){function t(){this._strsToID={},this._idToStrs=[],this._length=0}__class(t,"laya.utils.StringKey");var e=t.prototype;return e.add=function(t){var e=this._strsToID[t];return null!=e?e:(this._idToStrs[this._length]=t,this._strsToID[t]=this._length++)},e.getID=function(t){var e=this._strsToID[t];return null==e?-1:e},e.getName=function(t){var e=this._idToStrs[t];return null==e?void 0:e},t}(),Utils=function(){function t(){}return __class(t,"laya.utils.Utils"),t.toRadian=function(e){return e*t._pi2},t.toAngle=function(e){return e*t._pi},t.toHexColor=function(t){if(t<0||isNaN(t))return null;for(var e=t.toString(16);e.length<6;)e="0"+e;return"#"+e},t.getGID=function(){return t._gid++},t.concatArray=function(t,e){if(!e)return t;if(!t)return e;var n=0,i=e.length;for(n=0;n<i;n++)t.push(e[n]);return t},t.clearArray=function(t){return t?(t.length=0,t):t},t.copyArray=function(t,e){if(t||(t=[]),!e)return t;t.length=e.length;var n=0,i=e.length;for(n=0;n<i;n++)t[n]=e[n];return t},t.getGlobalRecByPoints=function(t,e,n,i,r){var a;a=new Point(e,n),a=t.localToGlobal(a);var s;return s=new Point(i,r),s=t.localToGlobal(s),Rectangle._getWrapRec([a.x,a.y,s.x,s.y])},t.getGlobalPosAndScale=function(e){return t.getGlobalRecByPoints(e,0,0,1,1)},t.bind=function(t,e){return t.bind(e)},t.measureText=function(t,e){return RunDriver.measureText(t,e)},t.updateOrder=function(t){if(!t||t.length<2)return!1;for(var e,n=1,i=0,r=t.length,a=NaN;n<r;){for(i=n,e=t[i],a=t[i]._zOrder;--i>-1&&t[i]._zOrder>a;)t[i+1]=t[i];t[i+1]=e,n++}var s=e.parent.conchModel;if(s)if(null!=s.updateZOrder)s.updateZOrder();else{for(n=0;n<r;n++)s.removeChild(t[n].conchModel);for(n=0;n<r;n++)s.addChildAt(t[n].conchModel,n)}return!0},t.transPointList=function(t,e,n){var i=0,r=t.length;for(i=0;i<r;i+=2)t[i]+=e,t[i+1]+=n},t.parseInt=function(t,e){void 0===e&&(e=0);var n=Browser.window.parseInt(t,e);return isNaN(n)?0:n},t.getFileExtension=function(e){t._extReg.lastIndex=e.lastIndexOf(".");var n=t._extReg.exec(e);return n&&n.length>1?n[1].toLowerCase():null},t.getTransformRelativeToWindow=function(t,e,n){var i=Laya.stage,r=laya.utils.Utils.getGlobalPosAndScale(t),a=i._canvasTransform.clone(),s=a.tx,o=a.ty;a.rotate(-Math.PI/180*Laya.stage.canvasDegree),a.scale(Laya.stage.clientScaleX,Laya.stage.clientScaleY);var l=Laya.stage.canvasDegree%180!=0,h=NaN,_=NaN;l?(h=n+r.y,_=e+r.x,h*=a.d,_*=a.a,90==Laya.stage.canvasDegree?(h=s-h,_+=o):(h+=s,_=o-_)):(h=e+r.x,_=n+r.y,h*=a.a,_*=a.d,h+=s,_+=o);var u=NaN,c=NaN;return l?(u=a.d*r.height,c=a.a*r.width):(u=a.a*r.width,c=a.d*r.height),{x:h,y:_,scaleX:u,scaleY:c}},t.fitDOMElementInArea=function(e,n,i,r,a,s){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var o=t.getTransformRelativeToWindow(n,i,r);e.style.transform=e.style.webkitTransform="scale("+o.scaleX+","+o.scaleY+") rotate("+Laya.stage.canvasDegree+"deg)",e.style.width=a+"px",e.style.height=s+"px",e.style.left=o.x+"px",e.style.top=o.y+"px"},t._gid=1,t._pi=180/Math.PI,t._pi2=Math.PI/180,t._extReg=/\.(\w+)\??/g,t.parseXMLFromString=function(t){var e;if(t=t.replace(/>\s+</g,"><"),e=(new DOMParser).parseFromString(t,"text/xml"),e.firstChild.textContent.indexOf("This page contains the following errors")>-1)throw new Error(e.firstChild.firstChild.textContent);return e},t}(),CacheManager=function(){function t(){}return __class(t,"laya.utils.CacheManager"),t.regCacheByFunction=function(e,n){t.unRegCacheByFunction(e,n);var i;i={tryDispose:e,getCacheList:n},t._cacheList.push(i)},t.unRegCacheByFunction=function(e,n){var i=0,r=0;for(r=t._cacheList.length,i=0;i<r;i++)if(t._cacheList[i].tryDispose==e&&t._cacheList[i].getCacheList==n)return void t._cacheList.splice(i,1)},t.forceDispose=function(){var e=0,n=t._cacheList.length;for(e=0;e<n;e++)t._cacheList[e].tryDispose(!0)},t.beginCheck=function(e){void 0===e&&(e=15e3),Laya.timer.loop(e,null,t._checkLoop)},t.stopCheck=function(){Laya.timer.clear(null,t._checkLoop)},t._checkLoop=function(){var e=t._cacheList;if(!(e.length<1)){var n=Browser.now(),i=0,r=0;for(r=i=e.length;i>0&&(t._index++,t._index=t._index%r,e[t._index].tryDispose(!1),!(Browser.now()-n>t.loopTimeLimit));)i--}},t.loopTimeLimit=2,t._cacheList=[],t._index=0,t}(),Ease=function(){function t(){}return __class(t,"laya.utils.Ease"),t.linearNone=function(t,e,n,i){return n*t/i+e},t.linearIn=function(t,e,n,i){return n*t/i+e},t.linearInOut=function(t,e,n,i){return n*t/i+e},t.linearOut=function(t,e,n,i){return n*t/i+e},t.bounceIn=function(e,n,i,r){return i-t.bounceOut(r-e,0,i,r)+n},t.bounceInOut=function(e,n,i,r){return e<.5*r?.5*t.bounceIn(2*e,0,i,r)+n:.5*t.bounceOut(2*e-r,0,i,r)+.5*i+n},t.bounceOut=function(t,e,n,i){return(t/=i)<1/2.75?n*(7.5625*t*t)+e:t<2/2.75?n*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?n*(7.5625*(t-=2.25/2.75)*t+.9375)+e:n*(7.5625*(t-=2.625/2.75)*t+.984375)+e},t.backIn=function(t,e,n,i,r){return void 0===r&&(r=1.70158),n*(t/=i)*t*((r+1)*t-r)+e},t.backInOut=function(t,e,n,i,r){return void 0===r&&(r=1.70158),(t/=.5*i)<1?.5*n*(t*t*((1+(r*=1.525))*t-r))+e:n/2*((t-=2)*t*((1+(r*=1.525))*t+r)+2)+e},t.backOut=function(t,e,n,i,r){return void 0===r&&(r=1.70158),n*((t=t/i-1)*t*((r+1)*t+r)+1)+e},t.elasticIn=function(e,n,i,r,a,s){void 0===a&&(a=0),void 0===s&&(s=0);var o;return 0==e?n:1==(e/=r)?n+i:(s||(s=.3*r),!a||i>0&&a<i||i<0&&a<-i?(a=i,o=s/4):o=s/t.PI2*Math.asin(i/a),-a*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*t.PI2/s)+n)},t.elasticInOut=function(e,n,i,r,a,s){void 0===a&&(a=0),void 0===s&&(s=0);var o;return 0==e?n:2==(e/=.5*r)?n+i:(s||(s=r*(.3*1.5)),!a||i>0&&a<i||i<0&&a<-i?(a=i,o=s/4):o=s/t.PI2*Math.asin(i/a),e<1?a*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*t.PI2/s)*-.5+n:a*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*t.PI2/s)*.5+i+n)},t.elasticOut=function(e,n,i,r,a,s){void 0===a&&(a=0),void 0===s&&(s=0);var o;return 0==e?n:1==(e/=r)?n+i:(s||(s=.3*r),!a||i>0&&a<i||i<0&&a<-i?(a=i,o=s/4):o=s/t.PI2*Math.asin(i/a),a*Math.pow(2,-10*e)*Math.sin((e*r-o)*t.PI2/s)+i+n)},t.strongIn=function(t,e,n,i){return n*(t/=i)*t*t*t*t+e},t.strongInOut=function(t,e,n,i){return(t/=.5*i)<1?.5*n*t*t*t*t*t+e:.5*n*((t-=2)*t*t*t*t+2)+e},t.strongOut=function(t,e,n,i){return n*((t=t/i-1)*t*t*t*t+1)+e},t.sineInOut=function(t,e,n,i){return.5*-n*(Math.cos(Math.PI*t/i)-1)+e},t.sineIn=function(e,n,i,r){return-i*Math.cos(e/r*t.HALF_PI)+i+n},t.sineOut=function(e,n,i,r){return i*Math.sin(e/r*t.HALF_PI)+n},t.quintIn=function(t,e,n,i){return n*(t/=i)*t*t*t*t+e},t.quintInOut=function(t,e,n,i){return(t/=.5*i)<1?.5*n*t*t*t*t*t+e:.5*n*((t-=2)*t*t*t*t+2)+e},t.quintOut=function(t,e,n,i){return n*((t=t/i-1)*t*t*t*t+1)+e},t.quartIn=function(t,e,n,i){return n*(t/=i)*t*t*t+e},t.quartInOut=function(t,e,n,i){return(t/=.5*i)<1?.5*n*t*t*t*t+e:.5*-n*((t-=2)*t*t*t-2)+e},t.quartOut=function(t,e,n,i){return-n*((t=t/i-1)*t*t*t-1)+e},t.cubicIn=function(t,e,n,i){return n*(t/=i)*t*t+e},t.cubicInOut=function(t,e,n,i){return(t/=.5*i)<1?.5*n*t*t*t+e:.5*n*((t-=2)*t*t+2)+e},t.cubicOut=function(t,e,n,i){return n*((t=t/i-1)*t*t+1)+e},t.quadIn=function(t,e,n,i){return n*(t/=i)*t+e},t.quadInOut=function(t,e,n,i){return(t/=.5*i)<1?.5*n*t*t+e:.5*-n*(--t*(t-2)-1)+e},t.quadOut=function(t,e,n,i){return-n*(t/=i)*(t-2)+e},t.expoIn=function(t,e,n,i){return 0==t?e:n*Math.pow(2,10*(t/i-1))+e-.001*n},t.expoInOut=function(t,e,n,i){return 0==t?e:t==i?e+n:(t/=.5*i)<1?.5*n*Math.pow(2,10*(t-1))+e:.5*n*(2-Math.pow(2,-10*--t))+e},t.expoOut=function(t,e,n,i){return t==i?e+n:n*(1-Math.pow(2,-10*t/i))+e},t.circIn=function(t,e,n,i){return-n*(Math.sqrt(1-(t/=i)*t)-1)+e},t.circInOut=function(t,e,n,i){return(t/=.5*i)<1?.5*-n*(Math.sqrt(1-t*t)-1)+e:.5*n*(Math.sqrt(1-(t-=2)*t)+1)+e},t.circOut=function(t,e,n,i){return n*Math.sqrt(1-(t=t/i-1)*t)+e},t.HALF_PI=.5*Math.PI,t.PI2=2*Math.PI,t}(),Byte=function(){function t(t){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,t?(this._u8d_=new Uint8Array(t),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this.___resizeBuffer(this._allocated_)}__class(t,"laya.utils.Byte");var e=t.prototype;return e.___resizeBuffer=function(t){try{var e=new Uint8Array(t);null!=this._u8d_&&(this._u8d_.length<=t?e.set(this._u8d_):e.set(this._u8d_.subarray(0,t))),this._u8d_=e,this._d_=new DataView(e.buffer)}catch(e){throw"___resizeBuffer err:"+t}},e.getString=function(){return this.rUTF(this.getUint16())},e.getFloat32Array=function(t,e){var n=t+e;n=n>this._length?this._length:n;var i=new Float32Array(this._d_.buffer.slice(t,n));return this._pos_=n,i},e.getUint8Array=function(t,e){var n=t+e;n=n>this._length?this._length:n;var i=new Uint8Array(this._d_.buffer.slice(t,n));return this._pos_=n,i},e.getInt16Array=function(t,e){var n=t+e;n=n>this._length?this._length:n;var i=new Int16Array(this._d_.buffer.slice(t,n));return this._pos_=n,i},e.getFloat32=function(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var t=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,t},e.getFloat64=function(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var t=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,t},e.writeFloat32=function(t){this.ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,t,this._xd_),this._pos_+=4},e.writeFloat64=function(t){this.ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,t,this._xd_),this._pos_+=8},e.getInt32=function(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var t=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,t},e.getUint32=function(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var t=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,t},e.writeInt32=function(t){this.ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,t,this._xd_),this._pos_+=4},e.writeUint32=function(t){this.ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,t,this._xd_),this._pos_+=4},e.getInt16=function(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var t=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,t},e.getUint16=function(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var t=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,t},e.writeUint16=function(t){this.ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,t,this._xd_),this._pos_+=2},e.writeInt16=function(t){this.ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,t,this._xd_),this._pos_+=2},e.getUint8=function(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._d_.getUint8(this._pos_++)},e.writeUint8=function(t){this.ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,t),this._pos_++},e._getUInt8=function(t){return this._d_.getUint8(t)},e._getUint16=function(t){return this._d_.getUint16(t,this._xd_)},e._getMatrix=function(){return new Matrix(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())},e.rUTF=function(t){for(var e="",n=this._pos_+t,i=0,r=0,a=0,s=String.fromCharCode,o=this._u8d_,l=0;this._pos_<n;)i=o[this._pos_++],i<128?0!=i&&(e+=s(i)):i<224?e+=s((63&i)<<6|127&o[this._pos_++]):i<240?(r=o[this._pos_++],e+=s((31&i)<<12|(127&r)<<6|127&o[this._pos_++])):(r=o[this._pos_++],a=o[this._pos_++],e+=s((15&i)<<18|(127&r)<<12|a<<6&127|127&o[this._pos_++])),l++;return e},e.getCustomString=function(t){for(var e="",n=0,i=0,r=0,a=String.fromCharCode,s=this._u8d_;t>0;)if((i=s[this._pos_])<128)e+=a(i),this._pos_++,t--;else for(n=i-128,this._pos_++,t-=n;n>0;)i=s[this._pos_++],r=s[this._pos_++],e+=a(r<<8|i),n--;return e},e.clear=function(){this._pos_=0,this.length=0},e.__getBuffer=function(){return this._d_.buffer},e.writeUTFBytes=function(t){t+="";for(var e=0,n=t.length;e<n;e++){var i=t.charCodeAt(e);i<=127?this.writeByte(i):i<=2047?(this.ensureWrite(this._pos_+2),this._u8d_.set([192|i>>6,128|63&i],this._pos_),this._pos_+=2):i<=65535?(this.ensureWrite(this._pos_+3),this._u8d_.set([224|i>>12,128|i>>6&63,128|63&i],this._pos_),this._pos_+=3):(this.ensureWrite(this._pos_+4),this._u8d_.set([240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i],this._pos_),this._pos_+=4)}},e.writeUTFString=function(t){var e=this.pos;this.writeUint16(1),this.writeUTFBytes(t);var n=this.pos-e-2;if(n>=65536)throw"writeUTFString byte len more than 65536";this._d_.setUint16(e,n,this._xd_)},e.readUTFString=function(){return this.readUTFBytes(this.getUint16())},e.getUTFString=function(){return this.readUTFString()},e.readUTFBytes=function(t){if(void 0===t&&(t=-1),0==t)return"";var e=this.bytesAvailable;if(t>e)throw"readUTFBytes error - Out of bounds";return t=t>0?t:e,this.rUTF(t)},e.getUTFBytes=function(t){return void 0===t&&(t=-1),this.readUTFBytes(t)},e.writeByte=function(t){this.ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,t),this._pos_+=1},e.readByte=function(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)},e.getByte=function(){return this.readByte()},e.ensureWrite=function(t){this._length<t&&(this._length=t),this._allocated_<t&&(this.length=t)},e.writeArrayBuffer=function(t,e,n){if(void 0===e&&(e=0),void 0===n&&(n=0),e<0||n<0)throw"writeArrayBuffer error - Out of bounds";0==n&&(n=t.byteLength-e),this.ensureWrite(this._pos_+n);var i=new Uint8Array(t);this._u8d_.set(i.subarray(e,e+n),this._pos_),this._pos_+=n},__getset(0,e,"pos",function(){return this._pos_},function(t){this._pos_=t}),__getset(0,e,"bytesAvailable",function(){return this._length-this._pos_}),__getset(0,e,"length",function(){return this._length},function(t){this._allocated_<t?this.___resizeBuffer(this._allocated_=Math.floor(Math.max(t,2*this._allocated_))):this._allocated_>t&&this.___resizeBuffer(this._allocated_=t),this._length=t}),__getset(0,e,"endian",function(){return this._xd_?"littleEndian":"bigEndian"},function(t){this._xd_="littleEndian"==t}),__getset(0,e,"buffer",function(){var t=this._d_.buffer;return t.byteLength==this.length?t:t.slice(0,this.length)}),t.getSystemEndian=function(){if(!t._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),t._sysEndian=256===new Int16Array(e)[0]?"littleEndian":"bigEndian"}return t._sysEndian},t.BIG_ENDIAN="bigEndian",t.LITTLE_ENDIAN="littleEndian",t._sysEndian=null,t}(),HTMLChar=function(){function t(e,n,i,r){this.char=e,this.charNum=e.charCodeAt(0),this._x=this._y=0,this.width=n,this.height=i,this.style=r,this.isWord=!t._isWordRegExp.test(e)}__class(t,"laya.utils.HTMLChar");var e=t.prototype;return Laya.imps(e,{"laya.display.ILayout":!0}),e.setSprite=function(t){this._sprite=t},e.getSprite=function(){return this._sprite},e._isChar=function(){return!0},e._getCSSStyle=function(){return this.style},__getset(0,e,"height",function(){return this._h},function(t){this._h=t}),__getset(0,e,"width",function(){return this._w},function(t){this._w=t}),__getset(0,e,"y",function(){return this._y},function(t){this._sprite&&(this._sprite.y=t),this._y=t}),__getset(0,e,"x",function(){return this._x},function(t){this._sprite&&(this._sprite.x=t),this._x=t}),t._isWordRegExp=new RegExp("[\\w.]",""),t}(),WeakObject=function(){function t(){this._obj=null,this._obj=t.supportWeakMap?new Browser.window.WeakMap:{},t.supportWeakMap||t._maps.push(this)}__class(t,"laya.utils.WeakObject");var e=t.prototype;return e.set=function(e,n){if(null!=e)if(t.supportWeakMap){var i=e;"string"!=typeof e&&"number"!=typeof e||(i=t._keys[e])||(i=t._keys[e]={k:e}),this._obj.set(i,n)}else"string"==typeof e||"number"==typeof e?this._obj[e]=n:(e.$_GID||(e.$_GID=Utils.getGID()),this._obj[e.$_GID]=n)},e.get=function(e){if(null==e)return null;if(t.supportWeakMap){var n="string"==typeof e||"number"==typeof e?t._keys[e]:e;return n?this._obj.get(n):null}return"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[e.$_GID]},e.del=function(e){if(null!=e)if(t.supportWeakMap){var n="string"==typeof e||"number"==typeof e?t._keys[e]:e;if(!n)return;_obj.delete(n)}else"string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[this._obj.$_GID]},e.has=function(e){if(null==e)return!1;if(t.supportWeakMap){var n="string"==typeof e||"number"==typeof e?t._keys[e]:e;return this._obj.has(n)}return"string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[this._obj.$_GID]},t.__init__=function(){t.supportWeakMap=null!=Browser.window.WeakMap,t.supportWeakMap||Laya.timer.loop(t.delInterval,null,t.clearCache)},t.clearCache=function(){for(var e=0,n=t._maps.length;e<n;e++){t._maps[e]._obj={}}},t.supportWeakMap=!1,t.delInterval=6e5,t._keys={},t._maps=[],__static(t,["I",function(){return this.I=new t}]),t}(),Pool=function(){function t(){}return __class(t,"laya.utils.Pool"),t.getPoolBySign=function(e){return t._poolDic[e]||(t._poolDic[e]=[])},t.clearBySign=function(e){t._poolDic[e]&&(t._poolDic[e].length=0)},t.recover=function(e,n){n.__InPool||(n.__InPool=!0,t.getPoolBySign(e).push(n))},t.getItemByClass=function(e,n){var i=t.getPoolBySign(e),r=i.length?i.pop():new n;return r.__InPool=!1,r},t.getItemByCreateFun=function(e,n){var i=t.getPoolBySign(e),r=i.length?i.pop():n();return r.__InPool=!1,r},t.getItem=function(e){var n=t.getPoolBySign(e),i=n.length?n.pop():null;return i&&(i.__InPool=!1),i},t._poolDic={},t.InPoolSign="__InPool",t}(),ClassUtils=function(){function t(){}return __class(t,"laya.utils.ClassUtils"),t.regClass=function(e,n){t._classMap[e]=n},t.getRegClass=function(e){return t._classMap[e]},t.getInstance=function(e){var n=t.getClass(e);return n?new n:(console.warn("[error] Undefined class:",e),null)},t.createByJson=function(e,n,i,r,a){"string"==typeof e&&(e=JSON.parse(e));var s=e.props;if(!n&&!(n=a?a.runWith(e):t.getInstance(s.runtime||e.type)))return null;var o=e.child;if(o)for(var l=0,h=o.length;l<h;l++){var _=o[l];if("render"!==_.props.name&&"render"!==_.props.renderType||!n._$set_itemRender)if("Graphic"==_.type)t.addGraphicsToSprite(_,n);else if(t.isDrawType(_.type))t.addGraphicToSprite(_,n,!0);else{var u=t.createByJson(_,null,i,r,a);"Script"==_.type?u.hasOwnProperty("owner")?u.owner=n:u.hasOwnProperty("target")&&(u.target=n):"mask"==_.props.renderType?n.mask=u:n.addChild(u)}else n.itemRender=_}if(s)for(var c in s){var d=s[c];"var"===c&&i?i[d]=n:d instanceof Array&&"function"==typeof n[c]?n[c].apply(n,d):n[c]=d}return r&&e.customProps&&r.runWith([n,e]),n.created&&n.created(),n},t.addGraphicsToSprite=function(e,n){var i;if((i=e.child)&&!(i.length<1)){var r;r=t._getGraphicsFromSprite(e,n);var a=0,s=0;e.props&&(a=t._getObjVar(e.props,"x",0),s=t._getObjVar(e.props,"y",0)),0!=a&&0!=s&&r.translate(a,s);var o=0,l=0;for(l=i.length,o=0;o<l;o++)t._addGraphicToGraphics(i[o],r);0!=a&&0!=s&&r.translate(-a,-s)}},t.addGraphicToSprite=function(e,n,i){void 0===i&&(i=!1);var r;r=i?t._getGraphicsFromSprite(e,n):n.graphics,t._addGraphicToGraphics(e,r)},t._getGraphicsFromSprite=function(t,e){var n;if(!t||!t.props)return e.graphics;var i;switch(i=t.props.renderType){case"hit":case"unHit":var r;e.hitArea||(e.hitArea=new HitArea),r=e.hitArea,r[i]||(r[i]=new Graphics),n=r[i]}return n||(n=e.graphics),n},t._getTransformData=function(e){var n;(e.hasOwnProperty("pivotX")||e.hasOwnProperty("pivotY"))&&(n=n||new Matrix,n.translate(-t._getObjVar(e,"pivotX",0),-t._getObjVar(e,"pivotY",0)));var i=t._getObjVar(e,"scaleX",1),r=t._getObjVar(e,"scaleY",1),a=t._getObjVar(e,"rotation",0);t._getObjVar(e,"skewX",0),t._getObjVar(e,"skewY",0);return 1==i&&1==r&&0==a||(n=n||new Matrix,n.scale(i,r),n.rotate(.0174532922222222*a)),n},t._addGraphicToGraphics=function(e,n){var i;if(i=e.props){var r;if(r=t.DrawTypeDic[e.type]){var a;a=n;var s,o=t._getParams(i,r[1],r[2],r[3]);s=t._tM,(s||1!=t._alpha)&&(a.save(),s&&a.transform(s),1!=t._alpha&&a.alpha(t._alpha)),a[r[0]].apply(a,o),(s||1!=t._alpha)&&a.restore()}}},t._adptLineData=function(t){return t[2]=parseFloat(t[0])+parseFloat(t[2]),t[3]=parseFloat(t[1])+parseFloat(t[3]),t},t._adptTextureData=function(t){return t[0]=Loader.getRes(t[0]),t},t._adptLinesData=function(e){return e[2]=t._getPointListByStr(e[2]),e},t.isDrawType=function(e){return"Image"!=e&&t.DrawTypeDic.hasOwnProperty(e)},t._getParams=function(e,n,i,r){void 0===i&&(i=0);var a;a=t._temParam,a.length=n.length;var s=0,o=0;for(o=n.length,s=0;s<o;s++)a[s]=t._getObjVar(e,n[s][0],n[s][1]);t._alpha=t._getObjVar(e,"alpha",1);var l;return l=t._getTransformData(e),l?(i||(i=0),l.translate(a[i],a[i+1]),a[i]=a[i+1]=0,t._tM=l):t._tM=null,r&&t[r]&&(a=t[r](a)),a},t._getPointListByStr=function(t){var e;e=t.split(",");var n=0,i=0;for(i=e.length,n=0;n<i;n++)e[n]=parseFloat(e[n]);return e},t._getObjVar=function(t,e,n){return t.hasOwnProperty(e)?t[e]:n},t._temParam=[],t._classMap={Sprite:"laya.display.Sprite",Text:"laya.display.Text",Animation:"laya.display.Animation",Skeleton:"laya.ani.bone.Skeleton",Particle2D:"laya.particle.Particle2D",div:"laya.html.dom.HTMLDivElement",p:"laya.html.dom.HTMLElement",img:"laya.html.dom.HTMLImageElement",span:"laya.html.dom.HTMLElement",br:"laya.html.dom.HTMLBrElement",style:"laya.html.dom.HTMLStyleElement",font:"laya.html.dom.HTMLElement",a:"laya.html.dom.HTMLElement","#text":"laya.html.dom.HTMLElement"},t.getClass=function(e){var n=t._classMap[e]||e;return"string"==typeof n?Laya.__classmap[n]:n},t._tM=null,t._alpha=NaN,__static(t,["DrawTypeDic",function(){return this.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]}}]),t}(),Color=function(){function t(e){if(this._color=[],"string"==typeof e){this.strColor=e,null===e&&(e="#000000"),"#"==e.charAt(0)&&(e=e.substr(1));var n=e.length;if(3==n||4==n){for(var i="",r=0;r<n;r++)i+=e[r]+e[r];e=i}var a=this.numColor=parseInt(e,16);if(8==e.length)return void(this._color=[parseInt(e.substr(0,2),16)/255,((16711680&a)>>16)/255,((65280&a)>>8)/255,(255&a)/255])}else a=this.numColor=e,this.strColor=Utils.toHexColor(a);this._color=[((16711680&a)>>16)/255,((65280&a)>>8)/255,(255&a)/255,1],this._color.__id=++t._COLODID}return __class(t,"laya.utils.Color"),t._initDefault=function(){t._DEFAULT={};for(var e in t._COLOR_MAP)t._SAVE[e]=t._DEFAULT[e]=new t(t._COLOR_MAP[e]);return t._DEFAULT},t._initSaveMap=function(){t._SAVE_SIZE=0,t._SAVE={};for(var e in t._DEFAULT)t._SAVE[e]=t._DEFAULT[e]},t.create=function(e){var n=t._SAVE[e+""];return null!=n?n:(t._SAVE_SIZE<1e3||t._initSaveMap(),t._SAVE[e+""]=new t(e))},t._SAVE={},t._SAVE_SIZE=0,t._COLOR_MAP={white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#AAAAAA"},t._DEFAULT=t._initDefault(),t._COLODID=1,t}(),VectorGraphManager=function(){function t(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],Render.isWebGL&&CacheManager.regCacheByFunction(Utils.bind(this.startDispose,this),Utils.bind(this.getCacheList,this))}__class(t,"laya.utils.VectorGraphManager");var e=t.prototype;return e.getId=function(){return this._id++},e.addShape=function(t,e){this.shapeDic[t]=e,this.useDic[t]||(this.useDic[t]=!0)},e.addLine=function(t,e){this.shapeLineDic[t]=e,this.shapeLineDic[t]||(this.shapeLineDic[t]=!0)},e.getShape=function(t){this._checkKey&&null!=this.useDic[t]&&(this.useDic[t]=!0)},e.deleteShape=function(t){this.shapeDic[t]&&(this.shapeDic[t]=null,delete this.shapeDic[t]),this.shapeLineDic[t]&&(this.shapeLineDic[t]=null,delete this.shapeLineDic[t]),null!=this.useDic[t]&&delete this.useDic[t]},e.getCacheList=function(){var t,e=[];for(t in this.shapeDic)e.push(this.shapeDic[t]);for(t in this.shapeLineDic)e.push(this.shapeLineDic[t]);return e},e.startDispose=function(t){var e;for(e in this.useDic)this.useDic[e]=!1;this._checkKey=!0},e.endDispose=function(){if(this._checkKey){var t;for(t in this.useDic)this.useDic[t]||this.deleteShape(t);this._checkKey=!1}},t.getInstance=function(){return t.instance=t.instance||new t},t.instance=null,t}(),Timer=function(){function t(){this._delta=0,this.scale=1,this.currFrame=0,this._mid=1,this._map=[],this._laters=[],this._handlers=[],this._temp=[],this._count=0,this.currTimer=Browser.now(),this._lastTimer=Browser.now(),Laya.timer&&Laya.timer.frameLoop(1,this,this._update)}var e;__class(t,"laya.utils.Timer");var n=t.prototype;return n._update=function(){if(this.scale<=0)return void(this._lastTimer=Browser.now());var t=this.currFrame=this.currFrame+this.scale,e=Browser.now();this._delta=(e-this._lastTimer)*this.scale;var n=this.currTimer=this.currTimer+this._delta;this._lastTimer=e;var i=this._handlers;for(this._count=0,s=0,o=i.length;s<o;s++)if(l=i[s],null!==l.method){var r=l.userFrame?t:n;if(r>=l.exeTime)if(l.repeat)if(l.jumpFrame)for(;r>=l.exeTime;)l.exeTime+=l.delay,l.run(!1);else l.exeTime+=l.delay,l.run(!1),r>l.exeTime&&(l.exeTime+=Math.ceil((r-l.exeTime)/l.delay)*l.delay);else l.run(!0)}else this._count++;(this._count>30||t%200==0)&&this._clearHandlers();for(var a=this._laters,s=0,o=a.length-1;s<=o;s++){var l=a[s];null!==l.method&&(this._map[l.key]=null,l.run(!1)),this._recoverHandler(l),s===o&&(o=a.length-1)}a.length=0},n._clearHandlers=function(){for(var t=this._handlers,e=0,n=t.length;e<n;e++){var i=t[e];null!==i.method?this._temp.push(i):this._recoverHandler(i)}this._handlers=this._temp,this._temp=t,this._temp.length=0},n._recoverHandler=function(e){this._map[e.key]==e&&(this._map[e.key]=null),e.clear(),t._pool.push(e)},n._create=function(n,i,r,a,s,o,l){if(!r)return s.apply(a,o),null;if(l){var h=this._getHandler(a,s);if(h)return h.repeat=i,h.userFrame=n,h.delay=r,h.caller=a,h.method=s,h.args=o,h.exeTime=r+(n?this.currFrame:this.currTimer+Browser.now()-this._lastTimer),h}return h=t._pool.length>0?t._pool.pop():new e,h.repeat=i,h.userFrame=n,h.delay=r,h.caller=a,h.method=s,h.args=o,h.exeTime=r+(n?this.currFrame:this.currTimer+Browser.now()-this._lastTimer)+1,this._indexHandler(h),this._handlers.push(h),h},n._indexHandler=function(t){var e=t.caller,n=t.method,i=e?e.$_GID||(e.$_GID=Utils.getGID()):0,r=n.$_TID||(n.$_TID=1e5*this._mid++);t.key=i+r,this._map[t.key]=t},n.once=function(t,e,n,i,r){void 0===r&&(r=!0),this._create(!1,!1,t,e,n,i,r)},n.loop=function(t,e,n,i,r,a){void 0===r&&(r=!0),void 0===a&&(a=!1);var s=this._create(!1,!0,t,e,n,i,r);s&&(s.jumpFrame=a)},n.frameOnce=function(t,e,n,i,r){void 0===r&&(r=!0),this._create(!0,!1,t,e,n,i,r)},n.frameLoop=function(t,e,n,i,r){void 0===r&&(r=!0),this._create(!0,!0,t,e,n,i,r)},n.toString=function(){return"callLater:"+this._laters.length+" handlers:"+this._handlers.length+" pool:"+t._pool.length},n.clear=function(t,e){var n=this._getHandler(t,e);n&&(this._map[n.key]=null,n.key=0,n.clear())},n.clearAll=function(t){if(t)for(var e=0,n=this._handlers.length;e<n;e++){var i=this._handlers[e];i.caller===t&&(this._map[i.key]=null,i.key=0,i.clear())}},n._getHandler=function(t,e){var n=t?t.$_GID||(t.$_GID=Utils.getGID()):0,i=e.$_TID||(e.$_TID=1e5*this._mid++);return this._map[n+i]},n.callLater=function(n,i,r){if(null==this._getHandler(n,i)){if(t._pool.length)var a=t._pool.pop();else a=new e;a.caller=n,a.method=i,a.args=r,this._indexHandler(a),this._laters.push(a)}},n.runCallLater=function(t,e){var n=this._getHandler(t,e);n&&null!=n.method&&(this._map[n.key]=null,n.run(!0))},n.runTimer=function(t,e){this.runCallLater(t,e)},__getset(0,n,"delta",function(){return this._delta}),t._pool=[],t.__init$=function(){e=function(){function t(){this.key=0,this.repeat=!1,this.delay=0,this.userFrame=!1,this.exeTime=0,this.caller=null,this.method=null,this.args=null,this.jumpFrame=!1}__class(t,"");var e=t.prototype;return e.clear=function(){this.caller=null,this.method=null,this.args=null},e.run=function(t){var e=this.caller;if(e&&e.destroyed)return this.clear();var n=this.method,i=this.args;t&&this.clear(),null!=n&&(i?n.apply(e,i):n.call(e))},t}()},t}(),HitArea=function(){function t(){this._hit=null,this._unHit=null}__class(t,"laya.utils.HitArea");var e=t.prototype;return e.isHit=function(e,n){return!!t.isHitGraphic(e,n,this.hit)&&!t.isHitGraphic(e,n,this.unHit)},e.contains=function(t,e){return this.isHit(t,e)},__getset(0,e,"unHit",function(){return this._unHit||(this._unHit=new Graphics),this._unHit},function(t){this._unHit=t}),__getset(0,e,"hit",function(){return this._hit||(this._hit=new Graphics),this._hit},function(t){this._hit=t}),t.isHitGraphic=function(e,n,i){if(!i)return!1;var r;if(r=i.cmds,!r&&i._one&&(r=t._cmds,r.length=1,r[0]=i._one),!r)return!1;var a=0,s=0;s=r.length;var o;for(a=0;a<s;a++)if(o=r[a]){var l=Render._context;switch(o.callee){case l._translate:case 6:e-=o[0],n-=o[1]}if(t.isHitCmd(e,n,o))return!0}return!1},t.isHitCmd=function(e,n,i){if(!i)return!1;var r=Render._context,a=!1;switch(i.callee){case r._drawRect:case 13:t._rec.setTo(i[0],i[1],i[2],i[3]),a=t._rec.contains(e,n);break;case r._drawCircle:case r._fillCircle:case 14:var s=NaN;e-=i[0],n-=i[1],s=e*e+n*n,a=s<i[2]*i[2];break
;case r._drawPoly:case 18:e-=i[0],n-=i[1],a=t.ptInPolygon(e,n,i[2])}return a},t.ptInPolygon=function(e,n,i){var r;r=t._ptPoint,r.setTo(e,n);var a=0,s=NaN,o=NaN,l=NaN,h=NaN,_=0;_=i.length;for(var u=0;u<_;u+=2)if(s=i[u],o=i[u+1],l=i[(u+2)%_],h=i[(u+3)%_],o!=h&&!(r.y<Math.min(o,h)||r.y>=Math.max(o,h))){var c=(r.y-o)*(l-s)/(h-o)+s;c>r.x&&a++}return a%2==1},t._cmds=[],__static(t,["_rec",function(){return this._rec=new Rectangle},"_ptPoint",function(){return this._ptPoint=new Point}]),t}(),System=function(){function System(){}return __class(System,"laya.system.System"),System.changeDefinition=function(name,classObj){Laya[name]=classObj;var str=name+"=classObj";eval(str)},System.__init__=function(){Render.isConchApp&&(conch.disableConchResManager(),conch.disableConchAutoRestoreLostedDevice())},System}(),SplineCurvePositionVelocity=function(){function t(){this._tempVector30=new Vector3,this._tempVector31=new Vector3,this._tempVector32=new Vector3,this._a=new Vector3,this._b=new Vector3,this._c=new Vector3,this._d=new Vector3}__class(t,"laya.d3.core.glitter.SplineCurvePositionVelocity");var e=t.prototype;return e.Init=function(t,e,n,i){t.cloneTo(this._d),e.cloneTo(this._c),Vector3.scale(t,2,this._a),Vector3.scale(n,2,this._tempVector30),Vector3.subtract(this._a,this._tempVector30,this._a),Vector3.add(this._a,e,this._a),Vector3.add(this._a,i,this._a),Vector3.scale(n,3,this._b),Vector3.scale(t,3,this._tempVector30),Vector3.subtract(this._b,this._tempVector30,this._b),Vector3.subtract(this._b,i,this._b),Vector3.scale(e,2,this._tempVector30),Vector3.subtract(this._b,this._tempVector30,this._b)},e.Slerp=function(t,e){Vector3.scale(this._a,t*t*t,this._tempVector30),Vector3.scale(this._b,t*t,this._tempVector31),Vector3.scale(this._c,t,this._tempVector32),Vector3.add(this._tempVector30,this._tempVector31,e),Vector3.add(e,this._tempVector32,e),Vector3.add(e,this._d,e)},t}(),PhasorSpriter3D=function(){function t(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._camera=null,this._sharderNameID=0,this._shader=null,this._shaderCompile=null,this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._spriteShaderValue=new ValusArray,this._vb=VertexBuffer3D.create(t._vertexDeclaration,this._defaultBufferSize/this._floatSizePerVer,35048),this._ib=IndexBuffer3D.create("ushort",this._defaultBufferSize,35048),this._sharderNameID=Shader3D.nameKey.getID("LINE"),this._shaderCompile=ShaderCompile3D._preCompileShader[this._sharderNameID]}__class(t,"laya.d3.core.PhasorSpriter3D");var e=t.prototype;return e.line=function(t,e,n,i){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t.x,t.y,t.z,e.x,e.y,e.z,e.w),this.addVertex(n.x,n.y,n.z,i.x,i.y,i.z,i.w),this.addIndexes(this._tempUint0,this._tempUint0+1),this},e.circle=function(t,e,n,i,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*e,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/e,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*t,Math.cos(this._tempNumver0)*t,0,n,i,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},e.plane=function(t,e,n,i,r,a,s,o,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,n,a,s,o,l),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,n,a,s,o,l),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,n,a,s,o,l),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,n,a,s,o,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},e.box=function(t,e,n,i,r,a,s,o,l,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=i/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,n+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e+this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,n-this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,n-this._tempNumver2,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},e.cone=function(t,e,n,i,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*n+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*n>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/n,this.addVertexIndex(0,e,0,i,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,i,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<n;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,i,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==n-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,i,r,a,s,this._tempUint0+(this._tempInt0+n)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==n-1?this.addIndexes(this._tempUint1+n+2):this.addIndexes(this._tempUint1+this._tempInt0+n+1),this.addIndexes(this._tempUint1+this._tempInt0+n),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},e.boundingBoxLine=function(t,e,n,i,r,a,s,o,l,h){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t,r,a,s,o,l,h),this.addVertex(i,r,a,s,o,l,h),this.addVertex(t,e,a,s,o,l,h),this.addVertex(i,e,a,s,o,l,h),this.addVertex(i,r,n,s,o,l,h),this.addVertex(t,r,n,s,o,l,h),this.addVertex(i,e,n,s,o,l,h),this.addVertex(t,e,n,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},e.addVertex=function(t,e,n,i,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=t,this._vbData[this._posInVBData+1]=e,this._vbData[this._posInVBData+2]=n,this._vbData[this._posInVBData+3]=i,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},e.addVertexIndex=function(t,e,n,i,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=t,this._vbData[o+1]=e,this._vbData[o+2]=n,this._vbData[o+3]=i,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,o+=this._floatSizePerVer,o>this._posInVBData&&(this._posInVBData=o),this},e.addIndexes=function(t){var e=arguments;this._hasBegun||this.addVertexIndexException();for(var n=0;n<e.length;n++)this._ibData[this._posInIBData]=e[n],this._posInIBData++;return this},e.begin=function(t,e){return this._hasBegun&&this.beginException0(),1!==t&&4!==t&&this.beginException1(),this._primitiveType=t,this._camera=e,this._hasBegun=!0,this},e.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},e.flush=function(){0!==this._posInVBData&&(this._ib.setData(this._ibData),this._vb.setData(this._vbData),this._vb._bind(),this._ib._bind(),this._shader=this._shaderCompile.withCompile(0,0,0),this._shader.bind(),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._spriteShaderValue.setValue(1,this._camera.projectionViewMatrix.elements),this._shader.uploadSpriteUniforms(this._spriteShaderValue.data),Stat.drawCall++,WebGL.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0)},e.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},e.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},e.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},e.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},e.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},e.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(28,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector4",1)])}]),t}(),Layer=function(){function t(){this._visible=!0,this._nonRigidbodyOffset=0,this._colliders=[]}__class(t,"laya.d3.core.Layer");var e=t.prototype;return e._binarySearchIndex=function(){for(var e=0,n=t._collsionTestList.length-1,i=0;e<=n;){i=parseInt((e+n)/2);var r=t._collsionTestList[i];if(r==this._number)return i;r>this._number?n=i-1:e=i+1}return e},e._addCollider=function(e){0===this._colliders.length&&t._collsionTestList.splice(this._binarySearchIndex(),0,this._number),e._isRigidbody?(this._colliders.unshift(e),this._nonRigidbodyOffset++):this._colliders.push(e)},e._removeCollider=function(e){var n=this._colliders.indexOf(e);n<this._nonRigidbodyOffset&&this._nonRigidbodyOffset--,this._colliders.splice(n,1),0===this._colliders.length&&t._collsionTestList.splice(t._collsionTestList.indexOf(this._number),1)},__getset(0,e,"visible",function(){return this._visible},function(e){this._visible=e,t._visibleLayers=e?t._visibleLayers|this.mask:t._visibleLayers&~this.mask}),__getset(0,e,"mask",function(){return this._mask}),__getset(0,e,"number",function(){return this._number}),__getset(1,t,"visibleLayers",function(){return t._visibleLayers},function(e){t._visibleLayers=e;for(var n=0,i=t._layerList.length;n<i;n++){var r=t._layerList[n];r._visible=0!=(r._mask&t._visibleLayers)}}),t.__init__=function(){t._layerList.length=31;for(var e=0;e<31;e++){var n=new t;t._layerList[e]=n,0===e?(n.name="Default Layer",n.visible=!0):(n.name="Layer-"+e,n.visible=!1),n._number=e,n._mask=Math.pow(2,e)}t.currentCreationLayer=t._layerList[0]},t.getLayerByNumber=function(e){if(e<0||e>30)throw new Error("无法返回指定Layer，该number超出范围！");return t._layerList[e]},t.getLayerByName=function(e){for(var n=0;n<31;n++)if(t._layerList[n].name===e)return t._layerList[n];throw new Error("无法返回指定Layer,该name不存在")},t.isVisible=function(e){return 0!=(e&t._currentCameraCullingMask&t._visibleLayers)},t._layerList=[],t._visibleLayers=2147483647,t._collsionTestList=[],t._currentCameraCullingMask=2147483647,t.maxCount=31,t.currentCreationLayer=null,t}(),RenderElement=function(){function t(){this._id=0,this._type=0,this._mainSortID=0,this._render=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._tempBatchIndexStart=0,this._tempBatchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._onPreRenderFunction=null,this._conchSubmesh=null,this._id=++t._uniqueIDCounter,this._canDynamicBatch=!0,this._shaderValue=new ValusArray,Render.isConchNode&&(this._conchSubmesh=new ConchSubmesh)}__class(t,"laya.d3.core.render.RenderElement");var e=t.prototype;return e.getDynamicBatchBakedVertexs=function(t){for(var e=this._renderObj._getVertexBuffer(t),n=e.getData().slice(),i=e.vertexDeclaration,r=i.getVertexElementByUsage(0).offset/4,a=i.getVertexElementByUsage(3).offset/4,s=this._sprite3D.transform,o=s.worldMatrix,l=s.rotation,h=i.vertexStride/4,_=0,u=n.length;_<u;_+=h){var c=_+r,d=_+a;Utils3D.transformVector3ArrayToVector3ArrayCoordinate(n,c,o,n,c),Utils3D.transformVector3ArrayByQuat(n,d,l,n,d)}return n},e.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},e._destroy=function(){this._staticBatch&&this._staticBatch._manager._garbageCollection(this)},__getset(0,e,"renderObj",function(){return this._renderObj},function(t){this._renderObj!==t&&(this._renderObj=t)}),__getset(0,e,"id",function(){return this._id}),t._uniqueIDCounter=0,t}(),RenderState=function(){function t(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._viewMatrix=null,this._projectionMatrix=null,this._projectionViewMatrix=null,this._viewport=null,this._shader=null,this.elapsedTime=NaN,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null}return __class(t,"laya.d3.core.render.RenderState"),t.clientWidth=0,t.clientHeight=0,t}(),RenderQueue=function(){function t(e){this._id=0,this._needSort=!1,this._renderElements=null,this._renderableRenderObjects=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++t._uniqueIDCounter,this._needSort=!1,this._scene=e,this._renderElements=[],this._renderableRenderObjects=[],this._dynamicBatchCombineRenderElements=[]}__class(t,"laya.d3.core.render.RenderQueue");var e=t.prototype;return e._sortOpaqueFunc=function(t,e){return t._render&&e._render?t._render._distanceForSort-e._render._distanceForSort:0},e._sortAlphaFunc=function(t,e){return t._render&&e._render?e._render._distanceForSort-t._render._distanceForSort:0},e._begainRenderElement=function(t,e,n){return!!e._beforeRender(t)},e._sortAlpha=function(e){t._cameraPosition=e,this._finalElements.sort(this._sortAlphaFunc)},e._sortOpaque=function(e){t._cameraPosition=e,this._finalElements.sort(this._sortOpaqueFunc)},e._preRender=function(t){this._finalElements=this._renderElements.concat(this._dynamicBatchCombineRenderElements)},e._render=function(t,e){for(var n,i,r,a,s,o=Stat.loopCount,l=this._scene,h=t.camera,_=(h.id,!1),u=0,c=this._finalElements.length;u<c;u++){var d,f,m,p=this._finalElements[u];if(null!=p._onPreRenderFunction&&p._onPreRenderFunction.call(p._sprite3D,t),0===p._type)t.owner=m=p._sprite3D,t.renderElement=p,m._preRenderUpdateComponents(t),d=p.renderObj,f=p._material,this._begainRenderElement(t,d,f)&&(n=d._getVertexBuffer(0),i=n.vertexDeclaration,r=t._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue),_=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||_)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(r._uploadScene!==l||_)&&(r.uploadSceneUniforms(l._shaderValues.data),r._uploadScene=l),(h!==r._uploadCamera||r._uploadSprite3D!==m||_)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(h!==r._uploadCamera||_)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==f||_)&&(f._upload(),r._uploadMaterial=f),a!==f?(f._setRenderStateBlendDepth(),f._setRenderStateFrontFace(e,m.transform),a=f,s=m):s!==m&&(f._setRenderStateFrontFace(e,m.transform),s=m),d._render(t),r._uploadLoopCount=o),m._postRenderUpdateComponents(t);else if(2===p._type){p.renderObj;t.owner=m=p._sprite3D,t.renderElement=p,t._batchIndexStart=p._tempBatchIndexStart,t._batchIndexEnd=p._tempBatchIndexEnd,d=p.renderObj,f=p._material,this._begainRenderElement(t,d,f)&&(n=d._getVertexBuffer(0),i=n.vertexDeclaration,r=t._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue),_=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||_)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(r._uploadScene!==l||_)&&(r.uploadSceneUniforms(l._shaderValues.data),r._uploadScene=l),(h!==r._uploadCamera||r._uploadSprite3D!==m||_)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(h!==r._uploadCamera||_)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==f||_)&&(f._upload(),r._uploadMaterial=f),a!==f?(f._setRenderStateBlendDepth(),f._setRenderStateFrontFace(e,m.transform),a=f,s=m):s!==m&&(f._setRenderStateFrontFace(e,m.transform),s=m),d._render(t),r._uploadLoopCount=o)}}},e._renderShadow=function(t,e){for(var n,i,r,a,s,o=Stat.loopCount,l=this._scene,h=t.camera,_=!1,u=0,c=this._finalElements.length;u<c;u++){var d,f,m,p=this._finalElements[u];0===p._type&&(t.owner=m=p._sprite3D,e||m._projectionViewWorldUpdateCamera===h&&m._projectionViewWorldUpdateLoopCount===Stat.loopCount||(m._render._renderUpdate(t._projectionViewMatrix),m._projectionViewWorldUpdateLoopCount=Stat.loopCount,m._projectionViewWorldUpdateCamera=h),t.renderElement=p,m._preRenderUpdateComponents(t),d=p.renderObj,f=p._material,this._begainRenderElement(t,d,null)&&(n=d._getVertexBuffer(0),i=n.vertexDeclaration,r=t._shader=f._getShader(l._shaderDefineValue,i.shaderDefineValue,m._shaderDefineValue),_=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==n||_)&&(r.uploadAttributes(i.shaderValues.data,null),r._uploadVertexBuffer=n),(h!==r._uploadCamera||r._uploadSprite3D!==m||_)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(h!==r._uploadCamera||_)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==f||_)&&(f._upload(),r._uploadMaterial=f),r._uploadRenderElement,a!==f?(f._setRenderStateFrontFace(!1,m.transform),a=f,s=m):s!==m&&(f._setRenderStateFrontFace(!1,m.transform),s=m),d._render(t),r._uploadLoopCount=o),m._postRenderUpdateComponents(t))}},e._clearRenderElements=function(){this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},e._addRenderElement=function(t){this._renderElements.push(t),this._needSort=!0},e._addDynamicBatchElement=function(t){this._dynamicBatchCombineRenderElements.push(t)},__getset(0,e,"id",function(){return this._id}),t._uniqueIDCounter=0,t.OPAQUE=1,t.TRANSPARENT=2,t._cameraPosition=null,t}(),ShurikenParticleData=function(){function t(){}return __class(t,"laya.d3.core.particleShuriKen.ShurikenParticleData"),t._getStartLifetimeFromGradient=function(t,e){for(var n=1,i=t.gradientCount;n<i;n++){var r=t.getKeyByIndex(n);if(r>=e){var a=t.getKeyByIndex(n-1),s=(e-a)/(r-a);return MathUtil.lerp(t.getValueByIndex(n-1),t.getValueByIndex(n),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},t._randomInvertRoationArray=function(t,e,n,i,r){var a=NaN;i?(i.seed=r[6],a=i.getFloat(),r[6]=i.seed):a=Math.random(),a<n?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])},t._randomInvertRoation=function(t,e,n,i){var r=NaN;return n?(n.seed=i[6],r=n.getFloat(),i[6]=n.seed):r=Math.random(),r<e&&(t=-t),t},t.create=function(e,n,i){var r=e.autoRandomSeed,a=e._rand,s=e._randomSeeds;switch(e.startColorType){case 0:var o=e.startColorConstant.elements;t.startColor[0]=o[0],t.startColor[1]=o[1],t.startColor[2]=o[2],t.startColor[3]=o[3];break;case 2:r?MathUtil.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,Math.random(),t.startColor):(a.seed=s[3],MathUtil.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,a.getFloat(),t.startColor),s[3]=a.seed)}var l=e.colorOverLifetime;if(l&&l.enbale){var h=l.color;switch(h.type){case 0:t.startColor[0]=t.startColor[0]*h.constant.x,t.startColor[1]=t.startColor[1]*h.constant.y,t.startColor[2]=t.startColor[2]*h.constant.z,t.startColor[3]=t.startColor[3]*h.constant.w;break;case 2:var _=NaN;r?_=Math.random():(a.seed=s[10],_=a.getFloat(),s[10]=a.seed);var u=h.constantMin,c=h.constantMax;t.startColor[0]=t.startColor[0]*MathUtil.lerp(u.x,c.x,_),t.startColor[1]=t.startColor[1]*MathUtil.lerp(u.y,c.y,_),t.startColor[2]=t.startColor[2]*MathUtil.lerp(u.z,c.z,_),t.startColor[3]=t.startColor[3]*MathUtil.lerp(u.w,c.w,_)}}var d=t.startSize;switch(e.startSizeType){case 0:if(e.threeDStartSize){var f=e.startSizeConstantSeparate;d[0]=f.x,d[1]=f.y,d[2]=f.z}else d[0]=d[1]=d[2]=e.startSizeConstant;break;case 2:if(e.threeDStartSize){var m=e.startSizeConstantMinSeparate,p=e.startSizeConstantMaxSeparate;r?(d[0]=MathUtil.lerp(m.x,p.x,Math.random()),d[1]=MathUtil.lerp(m.y,p.y,Math.random()),d[2]=MathUtil.lerp(m.z,p.z,Math.random())):(a.seed=s[4],d[0]=MathUtil.lerp(m.x,p.x,a.getFloat()),d[1]=MathUtil.lerp(m.y,p.y,a.getFloat()),d[2]=MathUtil.lerp(m.z,p.z,a.getFloat()),s[4]=a.seed)}else r?d[0]=d[1]=d[2]=MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(a.seed=s[4],d[0]=d[1]=d[2]=MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,a.getFloat()),s[4]=a.seed)}var g=e.sizeOverLifetime;if(g&&g.enbale&&1===g.size.type){var v=g.size;if(v.separateAxes)r?(d[0]=d[0]*MathUtil.lerp(v.constantMinSeparate.x,v.constantMaxSeparate.x,Math.random()),d[1]=d[1]*MathUtil.lerp(v.constantMinSeparate.y,v.constantMaxSeparate.y,Math.random()),d[2]=d[2]*MathUtil.lerp(v.constantMinSeparate.z,v.constantMaxSeparate.z,Math.random())):(a.seed=s[11],d[0]=d[0]*MathUtil.lerp(v.constantMinSeparate.x,v.constantMaxSeparate.x,a.getFloat()),d[1]=d[1]*MathUtil.lerp(v.constantMinSeparate.y,v.constantMaxSeparate.y,a.getFloat()),d[2]=d[2]*MathUtil.lerp(v.constantMinSeparate.z,v.constantMaxSeparate.z,a.getFloat()),s[11]=a.seed);else{var x=NaN;r?x=MathUtil.lerp(v.constantMin,v.constantMax,Math.random()):(a.seed=s[11],x=MathUtil.lerp(v.constantMin,v.constantMax,a.getFloat()),s[11]=a.seed),d[0]=d[0]*x,d[1]=d[1]*x,d[2]=d[2]*x}}var S=n.renderMode;if(1!==S)switch(e.startRotationType){case 0:if(e.threeDStartRotation){var T=e.startRotationConstantSeparate,E=t._tempVector30.elements;t._randomInvertRoationArray(T.elements,E,e.randomizeRotationDirection,r?null:a,s),t.startRotation[0]=E[0],t.startRotation[1]=E[1],t.startRotation[2]=4!==S?-E[2]:E[2]}else t.startRotation[0]=t._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,r?null:a,s);break;case 2:if(e.threeDStartRotation){var y=e.startRotationConstantMinSeparate,M=e.startRotationConstantMaxSeparate,D=t._tempVector30.elements;r?(D[0]=MathUtil.lerp(y.x,M.x,Math.random()),D[1]=MathUtil.lerp(y.y,M.y,Math.random()),D[2]=MathUtil.lerp(y.z,M.z,Math.random())):(a.seed=s[5],D[0]=MathUtil.lerp(y.x,M.x,a.getFloat()),D[1]=MathUtil.lerp(y.y,M.y,a.getFloat()),D[2]=MathUtil.lerp(y.z,M.z,a.getFloat()),s[5]=a.seed),t._randomInvertRoationArray(D,D,e.randomizeRotationDirection,r?null:a,s),t.startRotation[0]=D[0],t.startRotation[1]=D[1],t.startRotation[2]=4!==S?-D[2]:D[2]}else r?t.startRotation[0]=t._randomInvertRoation(MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,r?null:a,s):(a.seed=s[5],t.startRotation[0]=t._randomInvertRoation(MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,a.getFloat()),e.randomizeRotationDirection,r?null:a,s),s[5]=a.seed)}switch(e.startLifetimeType){case 0:t.startLifeTime=e.startLifetimeConstant;break;case 1:t.startLifeTime=t._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:r?t.startLifeTime=MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(a.seed=s[7],t.startLifeTime=MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,a.getFloat()),s[7]=a.seed);break;case 3:var C=e.emissionTime;r?t.startLifeTime=MathUtil.lerp(t._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,C),t._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,C),Math.random()):(a.seed=s[7],t.startLifeTime=MathUtil.lerp(t._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,C),t._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,C),a.getFloat()),s[7]=a.seed)}switch(e.startSpeedType){case 0:t.startSpeed=e.startSpeedConstant;break;case 2:r?t.startSpeed=MathUtil.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,Math.random()):(a.seed=s[8],t.startSpeed=MathUtil.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,a.getFloat()),s[8]=a.seed)}var R=e.textureSheetAnimation;if(R&&R.enable){var A=R.tiles,b=A.x,I=A.y,w=1/b,V=1/I,L=0,P=R.randomRow;switch(R.type){case 0:break;case 1:P?r?L=Math.round(Math.random()*I):(a.seed=s[13],L=Math.round(a.getFloat()*I),s[13]=a.seed):L=0}var N=0,O=R.startFrame;switch(O.type){case 0:N=O.constant;break;case 1:r?N=Math.round(MathUtil.lerp(O.constantMin,O.constantMax,Math.random())):(a.seed=s[14],N=Math.round(MathUtil.lerp(O.constantMin,O.constantMax,a.getFloat())),s[14]=a.seed)}var F=R.frame;switch(F.type){case 0:N+=F.constant;break;case 2:r?N+=Math.round(MathUtil.lerp(F.constantMin,F.constantMax,Math.random())):(a.seed=s[15],N+=Math.round(MathUtil.lerp(F.constantMin,F.constantMax,a.getFloat())),s[15]=a.seed)}P||(L=Math.floor(N/b));var B=N%b;t.startUVInfo=t.startUVInfo,t.startUVInfo[0]=w,t.startUVInfo[1]=V,t.startUVInfo[2]=B*w,t.startUVInfo[3]=L*V}else t.startUVInfo=t.startUVInfo,t.startUVInfo[0]=1,t.startUVInfo[1]=1,t.startUVInfo[2]=0,t.startUVInfo[3]=0;switch(e.simulationSpace){case 0:var U=i.position.elements;t.simulationWorldPostion[0]=U[0],t.simulationWorldPostion[1]=U[1],t.simulationWorldPostion[2]=U[2];var G=i.rotation.elements;t.simulationWorldRotation[0]=G[0],t.simulationWorldRotation[1]=G[1],t.simulationWorldRotation[2]=G[2],t.simulationWorldRotation[3]=G[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},t.startLifeTime=NaN,t.startSpeed=NaN,__static(t,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempQuaternion",function(){return this._tempQuaternion=new Quaternion},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]),t}(),FrameOverTime=function(){function t(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}__class(t,"laya.d3.core.particleShuriKen.module.FrameOverTime");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._constant=this._constant,this._overTime.cloneTo(e._overTime),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._overTimeMin.cloneTo(e._overTimeMin),this._overTimeMax.cloneTo(e._overTimeMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"frameOverTimeDataMax",function(){return this._overTimeMax}),__getset(0,e,"frameOverTimeDataMin",function(){return this._overTimeMin}),__getset(0,e,"type",function(){return this._type}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"frameOverTimeData",function(){return this._overTime}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var n=new t;return n._type=0,n._constant=e,n},t.createByOverTime=function(e){var n=new t;return n._type=1,n._overTime=e,n},t.createByRandomTwoConstant=function(e,n){var i=new t;return i._type=2,i._constantMin=e,i._constantMax=n,i},t.createByRandomTwoOverTime=function(e,n){var i=new t;return i._type=3,i._overTimeMin=e,i._overTimeMax=n,i},t}(),TextureSheetAnimation=function(){function t(t,e){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new Vector2(1,1),this.type=0,this.randomRow=!0,this.cycles=1,this.enableUVChannels=1,this._frame=t,this._startFrame=e}__class(t,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this.tiles.cloneTo(e.tiles),e.type=this.type,e.randomRow=this.randomRow,this._frame.cloneTo(e._frame),this._startFrame.cloneTo(e._startFrame),e.cycles=this.cycles,e.enableUVChannels=this.enableUVChannels,e.enable=this.enable},e.clone=function(){var t;switch(this._frame.type){case 0:t=FrameOverTime.createByConstant(this._frame.constant);break;case 1:t=FrameOverTime.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:t=FrameOverTime.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:t=FrameOverTime.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}var e;switch(this._startFrame.type){case 0:e=StartFrame.createByConstant(this._startFrame.constant);break;case 1:e=StartFrame.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new this.constructor(t,e);return this.tiles.cloneTo(n.tiles),n.type=this.type,n.randomRow=this.randomRow,n.cycles=this.cycles,
n.enableUVChannels=this.enableUVChannels,n.enable=this.enable,n},__getset(0,e,"startFrame",function(){return this._startFrame}),__getset(0,e,"frame",function(){return this._frame}),t}(),BaseShape=function(){function t(){this.enable=!1,this.randomDirection=!1}__class(t,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e._getShapeBoundBox=function(t){throw new Error("BaseShape: must override it.")},e._getSpeedBoundBox=function(t){throw new Error("BaseShape: must override it.")},e.generatePositionAndDirection=function(t,e,n,i){throw new Error("BaseShape: must override it.")},e._calculateProceduralBounds=function(t,e,n){this._getShapeBoundBox(t);var i=t.min,r=t.max;Vector3.multiply(i,e,i),Vector3.multiply(r,e,r);var a=new BoundBox(new Vector3,new Vector3);this.randomDirection?(a.min=new Vector3(-1,-1,-1),a.max=new Vector3(1,1,1)):this._getSpeedBoundBox(a);var s=new BoundBox(new Vector3,new Vector3),o=s.min,l=s.max;Vector3.scale(a.min,n.y,o),Vector3.scale(a.max,n.y,l),Vector3.add(t.min,o,o),Vector3.add(t.max,l,l),Vector3.min(t.min,o,t.min),Vector3.max(t.max,o,t.max);var h=new BoundBox(new Vector3,new Vector3),_=h.min,u=h.max;Vector3.scale(a.min,n.x,_),Vector3.scale(a.max,n.x,u),Vector3.min(h.min,u,o),Vector3.max(h.min,u,l),Vector3.min(t.min,o,t.min),Vector3.max(t.max,o,t.max)},e.cloneTo=function(t){t.enable=this.enable},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t}(),ShapeUtils=function(){function t(){}return __class(t,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),t._randomPointUnitArcCircle=function(t,e,n){var i=e.elements,r=NaN;r=n?n.getFloat()*t:Math.random()*t,i[0]=Math.cos(r),i[1]=Math.sin(r)},t._randomPointInsideUnitArcCircle=function(e,n,i){var r=n.elements;t._randomPointUnitArcCircle(e,n,i);var a=NaN;a=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),r[0]=r[0]*a,r[1]=r[1]*a},t._randomPointUnitCircle=function(t,e){var n=t.elements,i=NaN;i=e?e.getFloat()*Math.PI*2:Math.random()*Math.PI*2,n[0]=Math.cos(i),n[1]=Math.sin(i)},t._randomPointInsideUnitCircle=function(e,n){var i=e.elements;t._randomPointUnitCircle(e);var r=NaN;r=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),i[0]=i[0]*r,i[1]=i[1]*r},t._randomPointUnitSphere=function(t,e){var n=t.elements,i=NaN,r=NaN;e?(i=n[2]=2*e.getFloat()-1,r=e.getFloat()*Math.PI*2):(i=n[2]=2*Math.random()-1,r=Math.random()*Math.PI*2);var a=Math.sqrt(1-i*i);n[0]=a*Math.cos(r),n[1]=a*Math.sin(r)},t._randomPointInsideUnitSphere=function(e,n){var i=e.elements;t._randomPointUnitSphere(e);var r=NaN;r=n?Math.pow(n.getFloat(),1/3):Math.pow(Math.random(),1/3),i[0]=i[0]*r,i[1]=i[1]*r,i[2]=i[2]*r},t._randomPointInsideHalfUnitBox=function(t,e){var n=t.elements;e?(n[0]=e.getFloat()-.5,n[1]=e.getFloat()-.5,n[2]=e.getFloat()-.5):(n[0]=Math.random()-.5,n[1]=Math.random()-.5,n[2]=Math.random()-.5)},t}(),Burst=function(){function t(t,e,n){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=t,this._minCount=e,this._maxCount=n}__class(t,"laya.d3.core.particleShuriKen.module.Burst");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._time=this._time,e._minCount=this._minCount,e._maxCount=this._maxCount},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"maxCount",function(){return this._maxCount}),__getset(0,e,"minCount",function(){return this._minCount}),__getset(0,e,"time",function(){return this._time}),t}(),GradientAngularVelocity=function(){function t(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}__class(t,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._separateAxes=this._separateAxes,e._constant=this._constant,this._constantSeparate.cloneTo(e._constantSeparate),this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"gradientWMin",function(){return this._gradientWMin}),__getset(0,e,"gradientZMax",function(){return this._gradientZMax}),__getset(0,e,"gradientZMin",function(){return this._gradientZMin}),__getset(0,e,"gradientYMax",function(){return this._gradientYMax}),__getset(0,e,"gradientYMin",function(){return this._gradientYMin}),__getset(0,e,"gradientMax",function(){return this._gradientMax}),__getset(0,e,"gradientMin",function(){return this._gradientMin}),__getset(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"gradientW",function(){return this._gradientW}),__getset(0,e,"gradientXMax",function(){return this._gradientXMax}),__getset(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),__getset(0,e,"gradientY",function(){return this._gradientY}),__getset(0,e,"gradientZ",function(){return this._gradientZ}),__getset(0,e,"gradientX",function(){return this._gradientX}),__getset(0,e,"constantSeparate",function(){return this._constantSeparate}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"gradientWMax",function(){return this._gradientWMax}),__getset(0,e,"gradient",function(){return this._gradient}),__getset(0,e,"separateAxes",function(){return this._separateAxes}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"gradientXMin",function(){return this._gradientXMin}),__getset(0,e,"type",function(){return this._type}),t.createByConstant=function(e){var n=new t;return n._type=0,n._separateAxes=!1,n._constant=e,n},t.createByConstantSeparate=function(e){var n=new t;return n._type=0,n._separateAxes=!0,n._constantSeparate=e,n},t.createByGradient=function(e){var n=new t;return n._type=1,n._separateAxes=!1,n._gradient=e,n},t.createByGradientSeparate=function(e,n,i,r){var a=new t;return a._type=1,a._separateAxes=!0,a._gradientX=e,a._gradientY=n,a._gradientZ=i,a._gradientW=r,a},t.createByRandomTwoConstant=function(e,n){var i=new t;return i._type=2,i._separateAxes=!1,i._constantMin=e,i._constantMax=n,i},t.createByRandomTwoConstantSeparate=function(e,n){var i=new t;return i._type=2,i._separateAxes=!0,i._constantMinSeparate=e,i._constantMaxSeparate=n,i},t.createByRandomTwoGradient=function(e,n){var i=new t;return i._type=3,i._separateAxes=!1,i._gradientMin=e,i._gradientMax=n,i},t.createByRandomTwoGradientSeparate=function(e,n,i,r,a,s,o,l){var h=new t;return h._type=3,h._separateAxes=!0,h._gradientXMin=e,h._gradientXMax=n,h._gradientYMin=i,h._gradientYMax=r,h._gradientZMin=a,h._gradientZMax=s,h._gradientWMin=o,h._gradientWMax=l,h},t}(),SizeOverLifetime=function(){function t(t){this._size=null,this.enbale=!1,this._size=t}__class(t,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._size.cloneTo(e._size),e.enbale=this.enbale},e.clone=function(){var t;switch(this._size.type){case 0:t=this._size.separateAxes?GradientSize.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):GradientSize.createByGradient(this._size.gradient.clone());break;case 1:t=this._size.separateAxes?GradientSize.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):GradientSize.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:t=this._size.separateAxes?GradientSize.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):GradientSize.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},__getset(0,e,"size",function(){return this._size}),t}(),Emission=function(){function t(){this._destroyed=!1,this._emissionRate=0,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}__class(t,"laya.d3.core.particleShuriKen.module.Emission");var e=t.prototype;return Laya.imps(e,{"laya.resource.IDestroy":!0,"laya.d3.core.IClone":!0}),e._destroy=function(){this._bursts=null,this._destroyed=!0},e.getBurstsCount=function(){return this._bursts.length},e.getBurstByIndex=function(t){return this._bursts[t]},e.addBurst=function(t){var e=this._bursts.length;if(e>0)for(var n=0;n<e;n++)this._bursts[n].time>t.time&&this._bursts.splice(n,0,t);this._bursts.push(t)},e.removeBurst=function(t){var e=this._bursts.indexOf(t);-1!==e&&this._bursts.splice(e,1)},e.removeBurstByIndex=function(t){this._bursts.splice(t,1)},e.clearBurst=function(){this._bursts.length=0},e.cloneTo=function(t){var e=t,n=e._bursts;n.length=this._bursts.length;for(var i=0,r=this._bursts.length;i<r;i++){var a=n[i];a?this._bursts[i].cloneTo(a):n[i]=this._bursts[i].clone()}e._emissionRate=this._emissionRate,e.enbale=this.enbale},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"destroyed",function(){return this._destroyed}),__getset(0,e,"emissionRate",function(){return this._emissionRate},function(t){if(t<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=t}),t}(),GradientDataColor=function(){function t(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}__class(t,"laya.d3.core.particleShuriKen.module.GradientDataColor");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.addAlpha=function(t,e){this._alphaCurrentLength<8?(6===this._alphaCurrentLength&&1!==t&&(t=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._alphaElements[this._alphaCurrentLength++]=t,this._alphaElements[this._alphaCurrentLength++]=e):console.log("GradientDataColor warning:data count must lessEqual than 4")},e.addRGB=function(t,e){this._rgbCurrentLength<16?(12===this._rgbCurrentLength&&1!==t&&(t=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._rgbElements[this._rgbCurrentLength++]=t,this._rgbElements[this._rgbCurrentLength++]=e.x,this._rgbElements[this._rgbCurrentLength++]=e.y,this._rgbElements[this._rgbCurrentLength++]=e.z):console.log("GradientDataColor warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t,n=0,i=0;e._alphaCurrentLength=this._alphaCurrentLength;var r=e._alphaElements;for(r.length=this._alphaElements.length,n=0,i=this._alphaElements.length;n<i;n++)r[n]=this._alphaElements[n];e._rgbCurrentLength=this._rgbCurrentLength;var a=e._rgbElements;for(a.length=this._rgbElements.length,n=0,i=this._rgbElements.length;n<i;n++)a[n]=this._rgbElements[n]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"rgbGradientCount",function(){return this._rgbCurrentLength/4}),__getset(0,e,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),t}(),GradientColor=function(){function t(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}__class(t,"laya.d3.core.particleShuriKen.module.GradientColor");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,this._constant.cloneTo(e._constant),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradient.cloneTo(e._gradient),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"gradientMax",function(){return this._gradientMax}),__getset(0,e,"gradientMin",function(){return this._gradientMin}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"gradient",function(){return this._gradient}),__getset(0,e,"type",function(){return this._type}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var n=new t;return n._type=0,n._constant=e,n},t.createByGradient=function(e){var n=new t;return n._type=1,n._gradient=e,n},t.createByRandomTwoConstant=function(e,n){var i=new t;return i._type=2,i._constantMin=e,i._constantMax=n,i},t.createByRandomTwoGradient=function(e,n){var i=new t;return i._type=3,i._gradientMin=e,i._gradientMax=n,i},t}(),VelocityOverLifetime=function(){function t(t){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=t}__class(t,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._velocity.cloneTo(e._velocity),e.enbale=this.enbale,e.space=this.space},e.clone=function(){var t;switch(this._velocity.type){case 0:t=GradientVelocity.createByConstant(this._velocity.constant.clone());break;case 1:t=GradientVelocity.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:t=GradientVelocity.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:t=GradientVelocity.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e.space=this.space,e},__getset(0,e,"velocity",function(){return this._velocity}),t}(),RotationOverLifetime=function(){function t(t){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=t}__class(t,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._angularVelocity.cloneTo(e._angularVelocity),e.enbale=this.enbale},e.clone=function(){var t;switch(this._angularVelocity.type){case 0:t=this._angularVelocity.separateAxes?GradientAngularVelocity.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):GradientAngularVelocity.createByConstant(this._angularVelocity.constant);break;case 1:t=this._angularVelocity.separateAxes?GradientAngularVelocity.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone(),this._angularVelocity.gradientW.clone()):GradientAngularVelocity.createByGradient(this._angularVelocity.gradient.clone());break;case 2:t=this._angularVelocity.separateAxes?GradientAngularVelocity.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):GradientAngularVelocity.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:t=this._angularVelocity.separateAxes?GradientAngularVelocity.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):GradientAngularVelocity.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},__getset(0,e,"angularVelocity",function(){return this._angularVelocity}),t}(),ColorOverLifetime=function(){function t(t){this._color=null,this.enbale=!1,this._color=t}__class(t,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var e=t.prototype;return e.cloneTo=function(t){var e=t;this._color.cloneTo(e._color),e.enbale=this.enbale},e.clone=function(){var t;switch(this._color.type){case 0:t=GradientColor.createByConstant(this._color.constant.clone());break;case 1:t=GradientColor.createByGradient(this._color.gradient.clone());break;case 2:t=GradientColor.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:t=GradientColor.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},__getset(0,e,"color",function(){return this._color}),t}(),GradientSize=function(){function t(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}__class(t,"laya.d3.core.particleShuriKen.module.GradientSize");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.getMaxSizeInGradient=function(){var t=0,e=0,n=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(t=0,e=this._gradientX.gradientCount;t<e;t++)n=Math.max(n,this._gradientX.getValueByIndex(t));for(t=0,e=this._gradientY.gradientCount;t<e;t++)n=Math.max(n,this._gradientY.getValueByIndex(t))}else for(t=0,e=this._gradient.gradientCount;t<e;t++)n=Math.max(n,this._gradient.getValueByIndex(t));break;case 1:this._separateAxes?(n=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),n=Math.max(n,this._constantMinSeparate.y),n=Math.max(n,this._constantMaxSeparate.y)):n=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(t=0,e=this._gradientXMin.gradientCount;t<e;t++)n=Math.max(n,this._gradientXMin.getValueByIndex(t));for(t=0,e=this._gradientXMax.gradientCount;t<e;t++)n=Math.max(n,this._gradientXMax.getValueByIndex(t));for(t=0,e=this._gradientYMin.gradientCount;t<e;t++)n=Math.max(n,this._gradientYMin.getValueByIndex(t));for(t=0,e=this._gradientZMax.gradientCount;t<e;t++)n=Math.max(n,this._gradientZMax.getValueByIndex(t))}else{for(t=0,e=this._gradientMin.gradientCount;t<e;t++)n=Math.max(n,this._gradientMin.getValueByIndex(t));for(t=0,e=this._gradientMax.gradientCount;t<e;t++)n=Math.max(n,this._gradientMax.getValueByIndex(t))}}return n},e.cloneTo=function(t){var e=t;e._type=this._type,e._separateAxes=this._separateAxes,this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"gradientZMax",function(){return this._gradientZMax}),__getset(0,e,"gradientZMin",function(){return this._gradientZMin}),__getset(0,e,"gradientYMax",function(){return this._gradientYMax}),__getset(0,e,"gradientYMin",function(){return this._gradientYMin}),__getset(0,e,"gradientMax",function(){return this._gradientMax}),__getset(0,e,"gradientXMax",function(){return this._gradientXMax}),__getset(0,e,"gradientY",function(){return this._gradientY}),__getset(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),__getset(0,e,"gradientZ",function(){return this._gradientZ}),__getset(0,e,"gradientX",function(){return this._gradientX}),__getset(0,e,"gradientMin",function(){return this._gradientMin}),__getset(0,e,"gradient",function(){return this._gradient}),__getset(0,e,"separateAxes",function(){return this._separateAxes}),__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"gradientXMin",function(){return this._gradientXMin}),__getset(0,e,"type",function(){return this._type}),t.createByGradient=function(e){var n=new t;return n._type=0,n._separateAxes=!1,n._gradient=e,n},t.createByGradientSeparate=function(e,n,i){var r=new t;return r._type=0,r._separateAxes=!0,r._gradientX=e,r._gradientY=n,r._gradientZ=i,r},t.createByRandomTwoConstant=function(e,n){var i=new t;return i._type=1,i._separateAxes=!1,i._constantMin=e,i._constantMax=n,i},t.createByRandomTwoConstantSeparate=function(e,n){var i=new t;return i._type=1,i._separateAxes=!0,i._constantMinSeparate=e,i._constantMaxSeparate=n,i},t.createByRandomTwoGradient=function(e,n){var i=new t;return i._type=2,i._separateAxes=!1,i._gradientMin=e,i._gradientMax=n,i},t.createByRandomTwoGradientSeparate=function(e,n,i,r,a,s){var o=new t;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=n,o._gradientYMin=i,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},t}(),StartFrame=function(){function t(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}__class(t,"laya.d3.core.particleShuriKen.module.StartFrame");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._constant=this._constant,e._constantMin=this._constantMin,e._constantMax=this._constantMax},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"constantMin",function(){return this._constantMin}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"type",function(){return this._type}),t.createByConstant=function(e){var n=new t;return n._type=0,n._constant=e,n},t.createByRandomTwoConstant=function(e,n){var i=new t;return i._type=1,i._constantMin=e,i._constantMax=n,i},t}(),GradientDataInt=function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}__class(t,"laya.d3.core.particleShuriKen.module.GradientDataInt");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e):console.log("Warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var n=e._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"gradientCount",function(){return this._currentLength/2}),t}(),GradientVelocity=function(){function t(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}__class(t,"laya.d3.core.particleShuriKen.module.GradientVelocity");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,this._constant.cloneTo(e._constant),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"gradientZMax",function(){return this._gradientZMax}),__getset(0,e,"gradientZMin",function(){return this._gradientZMin}),__getset(0,e,"gradientYMin",function(){return this._gradientYMin}),__getset(0,e,"gradientY",function(){return this._gradientY}),__getset(0,e,"gradientXMax",function(){return this._gradientXMax}),__getset(0,e,"constantMax",function(){return this._constantMax}),__getset(0,e,"gradientX",function(){return this._gradientX}),__getset(0,e,"gradientZ",function(){return this._gradientZ}),__getset(0,e,"type",function(){return this._type}),__getset(0,e,"gradientXMin",function(){return this._gradientXMin}),__getset(0,e,"gradientYMax",function(){return this._gradientYMax}),__getset(0,e,"constant",function(){return this._constant}),__getset(0,e,"constantMin",function(){return this._constantMin}),t.createByConstant=function(e){var n=new t;return n._type=0,n._constant=e,n},t.createByGradient=function(e,n,i){var r=new t;return r._type=1,r._gradientX=e,r._gradientY=n,r._gradientZ=i,r},t.createByRandomTwoConstant=function(e,n){var i=new t;return i._type=2,i._constantMin=e,i._constantMax=n,i},t.createByRandomTwoGradient=function(e,n,i,r,a,s){var o=new t;return o._type=3,o._gradientXMin=e,o._gradientXMax=n,o._gradientYMin=i,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},t}(),GradientDataNumber=function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}__class(t,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e):console.log("GradientDataNumber warning:data count must lessEqual than 4")},e.getKeyByIndex=function(t){return this._elements[2*t]},e.getValueByIndex=function(t){return this._elements[2*t+1]},e.getAverageValue=function(){for(var t=0,e=this._currentLength-2;t<e;t+=2){var n=this._elements[t+1];n+=this._elements[t+3],n*=this._elements[t+2]-this._elements[t]}return 0},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var n=e._elements;n.length=this._elements.length;for(var i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"gradientCount",function(){return this._currentLength/2}),t}(),OctreeNode=function(){function t(t,e){this._exactBox=null,this._relaxBox=null,this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new BoundSphere(new Vector3,0),this._corners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],this._boundingBoxCenter=new Vector3,this._children=__newvec(8),this._objects=[],this._tempBoundBoxCorners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],this._scene=t,this._currentDepth=e}__class(t,"laya.d3.core.scene.OctreeNode");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.scene.ITreeNode":!0}),e.init=function(t,e){var n=new Vector3,i=new Vector3;Vector3.scale(e,-.5,n),Vector3.scale(e,.5,i),Vector3.add(n,t,n),Vector3.add(i,t,i),this.exactBox=new BoundBox(n,i),this.relaxBox=new BoundBox(n,i)},e.addTreeNode=function(t){1===Collision.boxContainsBox(this._relaxBox,t.boundingBox)?this.addNodeDown(t,0):this.addObject(t)},e.addChild=function(e){var n=this._children[e];if(null==n){n=new t(this._scene,this._currentDepth+1),this._children[e]=n,n._parent=this,Vector3.subtract(this._exactBox.max,this._exactBox.min,t.tempSize),Vector3.multiply(t.tempSize,t._octreeSplit[e],t.tempCenter),Vector3.add(this._exactBox.min,t.tempCenter,t.tempCenter),Vector3.scale(t.tempSize,.25,t.tempSize);var i=new Vector3,r=new Vector3;Vector3.subtract(t.tempCenter,t.tempSize,i),Vector3.add(t.tempCenter,t.tempSize,r),n.exactBox=new BoundBox(i,r),Vector3.scale(t.tempSize,t.relax,t.tempSize);var a=new Vector3,s=new Vector3;Vector3.subtract(t.tempCenter,t.tempSize,a),Vector3.add(t.tempCenter,t.tempSize,s),n.relaxBox=new BoundBox(a,s)}return n},e.addObject=function(t){t._treeNode=this,this._objects.push(t)},e.removeObject=function(t){if(t._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var e=this._objects.indexOf(t);return-1!==e&&(this._objects.splice(e,1),!0)},e.clearObject=function(){this._objects.length=0},e.addNodeUp=function(t,e){this._parent&&1!==Collision.boxContainsBox(this._exactBox,t.boundingBox)?this._parent.addNodeUp(t,e-1):this.addNodeDown(t,e)},e.addNodeDown=function(t,e){if(e<this._scene.treeLevel){var n=this.inChildIndex(t.boundingBoxCenter),i=this.addChild(n);1===Collision.boxContainsBox(i._relaxBox,t.boundingBox)?i.addNodeDown(t,++e):this.addObject(t)}else this.addObject(t)},e.inChildIndex=function(t){return 4*(t.z<this._boundingBoxCenter.z?0:1)+2*(t.y<this._boundingBoxCenter.y?0:1)+(t.x<this._boundingBoxCenter.x?0:1)},e.updateObject=function(t){1===Collision.boxContainsBox(this._relaxBox,t.boundingBox)?(this.removeObject(t),t._treeNode=null,this.addNodeDown(t,this._currentDepth)):this._parent&&(this.removeObject(t),t._treeNode=null,this._parent.addNodeUp(t,this._currentDepth-1))},e.cullingObjects=function(t,e,n,i,r){var a=0,s=0,o=0,l=0,h=this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var _=this._objects[a];if(Layer.isVisible(_._owner.layer.mask)&&_.enable){if(e&&(Stat.treeSpriteCollision+=1,0===t.containsBoundSphere(_.boundingSphere)))continue;_._renderUpdate(r),_._distanceForSort=Vector3.distance(_.boundingSphere.center,i)+_.sortingFudge;var u=_._renderElements;for(s=0,l=u.length;s<l;s++){var c=u[s],d=c._staticBatch;if(d&&d._material===c._material)d._addBatchRenderElement(c);else{var f=c.renderObj;f.triangleCount<10&&1===f._vertexBufferCount&&f._getIndexBuffer()&&c._material.renderQueue<2&&c._canDynamicBatch&&!_._owner.isStatic?h._addPrepareRenderElement(c):this._scene.getRenderQueue(c._material.renderQueue)._addRenderElement(c)}}}}for(a=0;a<8;a++){var m=this._children[a];if(null!=m){var p=e;if(e){var g=t.containsBoundBox(m._relaxBox);if(Stat.treeNodeCollision+=1,0===g)continue;p=2===g}m.cullingObjects(t,p,n,i,r)}}},e.cullingShadowObjects=function(t,e,n,i,r){var a=0,s=0,o=0,l=0;this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var h=this._objects[a];if(h.castShadow&&Layer.isVisible(h._owner.layer.mask)&&h.enable){if(n&&0===t[0].containsBoundSphere(h.boundingSphere))continue;for(var _=1,u=t.length;_<u;_++){var c=e[_-1];if(0!==t[_].containsBoundSphere(h.boundingSphere)){
var d=h._renderElements;for(s=0,l=d.length;s<l;s++)c._addRenderElement(d[s])}}}}for(a=0;a<8;a++){var f=this._children[a];if(null!=f){var m=n;if(n){var p=t[0].containsBoundBox(f._relaxBox);if(0===p)continue;m=2===p}f.cullingShadowObjects(t,e,m,i,r)}}},e.cullingShadowObjectsOnePSSM=function(t,e,n,i,r,a){var s=e[0],o=0,l=0,h=0,_=0;for(o=0,h=this._objects.length;o<h;o++){var u=this._objects[o];if(u.castShadow&&Layer.isVisible(u._owner.layer.mask)&&u.enable){if(i&&0===t.containsBoundSphere(u.boundingSphere))continue;u._renderUpdate(n);var c=u._renderElements;for(l=0,_=c.length;l<_;l++)s._addRenderElement(c[l])}}for(o=0;o<8;o++){var d=this._children[o];if(null!=d){var f=i;if(i){var m=t.containsBoundBox(d._relaxBox);if(0===m)continue;f=2===m}d.cullingShadowObjectsOnePSSM(t,e,n,f,r,a)}}},e.renderBoudingBox=function(t){this._renderBoudingBox(t);for(var e=0;e<8;++e){var n=this._children[e];n&&n.renderBoudingBox(t)}},e.buildAllChild=function(t){if(t<this._scene.treeLevel)for(var e=0;e<8;e++){var n=this.addChild(e);n.buildAllChild(t+1)}},e._renderBoudingBox=function(t){},__getset(0,e,"relaxBox",function(){return this._relaxBox},function(t){this._relaxBox=t,t.getCorners(this._corners),BoundSphere.createfromPoints(this._corners,this._boundingSphere)}),__getset(0,e,"exactBox",function(){return this._exactBox},function(t){this._exactBox=t,Vector3.add(t.min,t.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),t.debugMode=!1,t.relax=1.15,t.CHILDNUM=8,__static(t,["tempVector0",function(){return this.tempVector0=new Vector3},"tempSize",function(){return this.tempSize=new Vector3},"tempCenter",function(){return this.tempCenter=new Vector3},"_octreeSplit",function(){return this._octreeSplit=[new Vector3(.25,.25,.25),new Vector3(.75,.25,.25),new Vector3(.25,.75,.25),new Vector3(.75,.75,.25),new Vector3(.25,.25,.75),new Vector3(.75,.25,.75),new Vector3(.25,.75,.75),new Vector3(.75,.75,.75)]}]),t}(),ParallelSplitShadowMap=function(){function t(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0,this._lightCulling=null,this._renderTarget=null,this._lightVPMatrix=null,this._lightCameras=null,this._shadowQuenes=null,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._shaderValueVPs=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new Vector3(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new Vector3,this._tempLookAt4=new Vector4,this._tempValue=new Vector4,this._tempPos=new Vector3,this._tempLightUp=new Vector3,this._tempMin=new Vector4,this._tempMax=new Vector4,this._tempMatrix44=new Matrix4x4,this._splitFrustumCulling=new BoundFrustum(Matrix4x4.DEFAULT),this._tempScaleMatrix44=new Matrix4x4,this._shadowPCFOffset=new Vector2(1/1024,1/1024),this._shaderValueDistance=new Vector4;var t=0;for(t=0;t<this._spiltDistance.length;t++)this._spiltDistance[t]=0;for(t=0;t<this._dimension.length;t++)this._dimension[t]=new Vector2;for(t=0;t<this._frustumPos.length;t++)this._frustumPos[t]=new Vector3;for(t=0;t<this._boundingBox.length;t++)this._boundingBox[t]=new BoundBox(new Vector3,new Vector3);for(t=0;t<this._boundingSphere.length;t++)this._boundingSphere[t]=new BoundSphere(new Vector3,0);Matrix4x4.createScaling(new Vector3(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}__class(t,"laya.d3.shadowMap.ParallelSplitShadowMap");var e=t.prototype;return e.setInfo=function(t,e,n,i,r,a){r>3&&(this._numberOfPSSM=3),this._scene=t,this._maxDistance=e,this.PSSMNum=r,this._globalParallelLightDir=n,this._ratioOfDistance=1/this._numberOfPSSM;for(var s=0;s<this._spiltDistance.length;s++)this._spiltDistance[s]=0;this._shadowMapTextureSize=i,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(a),this._statesDirty=!0},e.setPCFType=function(t){switch(this._PCFType=t,this._PCFType){case 0:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 1:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 2:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 3:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2)}},e.getPCFType=function(){return this._PCFType},e.setFarDistance=function(t){this._maxDistance!=t&&(this._maxDistance=t,this._statesDirty=!0)},e.getFarDistance=function(){return this._maxDistance},e._setGlobalParallelLightDir=function(t){this._globalParallelLightDir=t},e.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},e.getCurrentPSSM=function(){return this._currentPSSM},e.getLightCamera=function(t){return this._lightCameras[t]},e._beginSampler=function(t,e){if(t<0||t>this._numberOfPSSM)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=t,this._update(e)},e.endSampler=function(t){this._currentPSSM=-1},e._calcAllLightCameraInfo=function(t){if(1===this._numberOfPSSM)this._beginSampler(0,t),this.endSampler(t);else for(var e=0,n=this._numberOfPSSM+1;e<n;e++)this._beginSampler(e,t),this.endSampler(t)},e._recalculate=function(t,e,n){this._calcSplitDistance(t),this._calcBoundingBox(e,n),this._rebuildRenderInfo()},e._update=function(t){var e=t.nearPlane,n=t.fieldOfView,i=t.aspectRatio;(this._statesDirty||this.lastNearPlane!==e||this.lastFieldOfView!==n||this.lastAspectRatio!==i)&&(this._recalculate(e,n,i),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=e,this.lastFieldOfView=n,this.lastAspectRatio=i),this._calcLightViewProject(t)},e._uploadShaderValue=function(){var t=this._scene;switch(this._numberOfPSSM){case 1:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 2:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 3:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2)}var e=t._shaderValues;switch(e.setValue(15,this._shaderValueDistance.elements),e.setValue(16,this._shaderValueLightVP),e.setValue(17,this._shadowPCFOffset.elements),this._numberOfPSSM){case 3:e.setValue(18,this.getRenderTarget(1)),e.setValue(19,this.getRenderTarget(2)),e.setValue(20,this.getRenderTarget(3));break;case 2:e.setValue(18,this.getRenderTarget(1)),e.setValue(19,this.getRenderTarget(2));break;case 1:e.setValue(18,this.getRenderTarget(1))}},e._calcSplitDistance=function(t){var e=this._maxDistance,n=1/this._numberOfPSSM,i=0;for(i=0;i<=this._numberOfPSSM;i++)this._uniformDistance[i]=t+(e-t)*i*n;var r=e/t;for(i=0;i<=this._numberOfPSSM;i++){var a=Math.pow(r,i*n);this._logDistance[i]=t*a}for(i=0;i<=this._numberOfPSSM;i++)this._spiltDistance[i]=this._uniformDistance[i]*this._ratioOfDistance+this._logDistance[i]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3],this._shaderValueDistance.w=this._spiltDistance[4]},e._calcBoundingBox=function(t,e){var n=3.1415926*t/180,i=Math.tan(n/2),r=NaN,a=NaN,s=NaN,o=0;for(o=0;o<=this._numberOfPSSM;o++){s=this._spiltDistance[o],r=s*i,a=r*e;var l=this._frustumPos[4*o+0].elements;l[0]=-a,l[1]=-r,l[2]=-s,l=this._frustumPos[4*o+1].elements,l[0]=a,l[1]=-r,l[2]=-s,l=this._frustumPos[4*o+2].elements,l[0]=-a,l[1]=r,l[2]=-s,l=this._frustumPos[4*o+3].elements,l[0]=a,l[1]=r,l[2]=-s,l=this._dimension[o].elements,l[0]=a,l[1]=r}var h,_,u,c;for(o=1;o<=this._numberOfPSSM;o++)h=this._dimension[o].elements,_=this._boundingBox[o].min.elements,_[0]=-h[0],_[1]=-h[1],_[2]=-this._spiltDistance[o],u=this._boundingBox[o].max.elements,u[0]=h[0],u[1]=h[1],u[2]=-this._spiltDistance[o-1],c=this._boundingSphere[o].center.elements,c[0]=.5*(_[0]+u[0]),c[1]=.5*(_[1]+u[1]),c[2]=.5*(_[2]+u[2]),this._boundingSphere[o].radius=.5*Math.sqrt(Math.pow(u[0]-_[0],2)+Math.pow(u[1]-_[1],2)+Math.pow(u[2]-_[2],2));_=this._boundingBox[0].min.elements,h=this._dimension[this._numberOfPSSM].elements,_[0]=-h[0],_[1]=-h[1],_[2]=-this._spiltDistance[this._numberOfPSSM],u=this._boundingBox[0].max.elements,u[0]=h[0],u[1]=h[1],u[2]=-this._spiltDistance[0],c=this._boundingSphere[0].center.elements,c[0]=.5*(_[0]+u[0]),c[1]=.5*(_[1]+u[1]),c[2]=.5*(_[2]+u[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(u[0]-_[0],2)+Math.pow(u[1]-_[1],2)+Math.pow(u[2]-_[2],2))},e.calcSplitFrustum=function(t){this._currentPSSM>0?Matrix4x4.createPerspective(3.1416*t.fieldOfView/180,t.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):Matrix4x4.createPerspective(3.1416*t.fieldOfView/180,t.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),Matrix4x4.multiply(this._tempMatrix44,t.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},e._rebuildRenderInfo=function(){var t=this._numberOfPSSM+1,e=0;if(null==this._renderTarget)for(this._renderTarget=__newvec(t),this._renderTarget[0]=null,e=1;e<t;e++)this._renderTarget[e]=new RenderTexture(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else if(this._renderTarget.length!=t)for(this.disposeAllRenderTarget(),this._renderTarget.length=t,this._renderTarget[0]=null,e=1;e<t;e++)this._renderTarget[e]=new RenderTexture(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else for(e=1;e<t;e++)null!=this._renderTarget[e]&&this._renderTarget[e].width==this._shadowMapTextureSize&&this._renderTarget[e].height==this._shadowMapTextureSize||(null!=this._renderTarget[e]&&this._renderTarget[e].dispose(),this._renderTarget[e]=new RenderTexture(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728));if(null==this._lightCulling||this._lightCulling.length!=t)for(this._lightCulling?this._lightCulling.length=t:this._lightCulling=__newvec(t),e=0;e<this._lightCulling.length;e++)this._lightCulling[e]=new BoundFrustum(Matrix4x4.DEFAULT);if(null==this._lightVPMatrix||this._lightVPMatrix.length!=t)for(this._lightVPMatrix?this._lightVPMatrix.length=t:this._lightVPMatrix=__newvec(t),e=0;e<this._lightVPMatrix.length;e++)this._lightVPMatrix[e]=new Matrix4x4;if(null==this._lightCameras||this._lightCameras.length!=t)for(this._lightCameras?this._lightCameras.length=t:this._lightCameras=__newvec(t),e=0;e<this._lightCameras.length;e++)this._lightCameras[e]=new Camera,this._lightCameras[e].name="lightCamera"+e;if(null==this._shadowQuenes||this._shadowQuenes.length!=this._numberOfPSSM)for(this._shadowQuenes?this._shadowQuenes.length=this._numberOfPSSM:this._shadowQuenes=__newvec(this._numberOfPSSM),e=0;e<this._shadowQuenes.length;e++)this._shadowQuenes[e]=new RenderQueue(this._scene);if(null==this._shaderValueVPs||this._shaderValueVPs.length!=t)for(this._shaderValueVPs?this._shaderValueVPs.length=t:this._shaderValueVPs=__newvec(t),this._shaderValueLightVP=new Float32Array(16*t),e=0;e<t;e++)this._shaderValueVPs[e]=new Float32Array(this._shaderValueLightVP.buffer,64*e)},e._calcLightViewProject=function(e){var n=this._boundingSphere[this._currentPSSM],i=e.transform.worldMatrix;n.radius;n.center.cloneTo(this._tempLookAt3),Vector3.transformV3ToV4(this._tempLookAt3,i,this._tempLookAt4);var r=this._tempLookAt3.elements,a=this._tempLookAt4.elements;r[0]=a[0],r[1]=a[1],r[2]=a[2];var s=this._tempLightUp.elements,o=e.forward.elements;s[0]=o[0],s[1]=1,s[2]=o[2],Vector3.normalize(this._tempLightUp,this._tempLightUp),Vector3.scale(this._globalParallelLightDir,4*n.radius,this._tempPos),Vector3.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var l=this._lightCameras[this._currentPSSM];l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var h=this._tempMax.elements,_=this._tempMin.elements;h[0]=h[1]=h[2]=-1e5,h[3]=1,_[0]=_[1]=_[2]=1e5,_[3]=1,Matrix4x4.multiply(l.viewMatrix,i,this._tempMatrix44);var u=this._tempValue.elements,c=[];c.length=8,this._boundingBox[this._currentPSSM].getCorners(c);for(var d=0;d<8;d++){var f=c[d].elements;u[0]=f[0],u[1]=f[1],u[2]=f[2],u[3]=1,Vector4.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),_[0]=u[0]<_[0]?u[0]:_[0],_[1]=u[1]<_[1]?u[1]:_[1],_[2]=u[2]<_[2]?u[2]:_[2],h[0]=u[0]>h[0]?u[0]:h[0],h[1]=u[1]>h[1]?u[1]:h[1],h[2]=u[2]>h[2]?u[2]:h[2]}Vector4.add(this._tempMax,this._tempMin,this._tempValue),u[0]*=.5,u[1]*=.5,u[2]*=.5,u[3]=1,Vector4.transformByM4x4(this._tempValue,l.transform.worldMatrix,this._tempValue);var m=Math.abs(-this._tempMax.z),p=m>this._maxDistance?m:this._maxDistance;Vector3.scale(this._globalParallelLightDir,p,this._tempPos);var g=this._tempPos.elements;g[0]=u[0]-g[0],g[1]=u[1]-g[1],g[2]=u[2]-g[2],l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),Matrix4x4.createOrthoOffCenterRH(_[0],h[0],_[1],h[1],1,p+.5*(h[2]-_[2]),l.projectionMatrix),l.projectionViewMatrix.cloneTo(this._lightVPMatrix[this._currentPSSM]),this._lightCulling[this._currentPSSM].matrix=this._lightVPMatrix[this._currentPSSM],t.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,this._lightVPMatrix[this._currentPSSM],this._shaderValueVPs[this._currentPSSM])},e.getLightFrustumCulling=function(t){return this._lightCulling[t]},e.getSplitFrustumCulling=function(){return this._splitFrustumCulling},e.getSplitDistance=function(t){return this._spiltDistance[t]},e.setShadowMapTextureSize=function(t){t!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=t,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},e.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},e.beginRenderTarget=function(t){this._renderTarget[t].start()},e.endRenderTarget=function(t){this._renderTarget[t].end()},e.getRenderTarget=function(t){return this._renderTarget[t]},e.disposeAllRenderTarget=function(){for(var t=0,e=this._numberOfPSSM+1;t<e;t++)this._renderTarget[t]&&(this._renderTarget[t].dispose(),this._renderTarget[t]=null)},__getset(0,e,"PSSMNum",function(){return this._numberOfPSSM},function(t){t=t>0?t:1,t=t<=3?t:3,this._numberOfPSSM!=t&&(this._numberOfPSSM=t,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)}),t.multiplyMatrixOutFloat32Array=function(t,e,n){var i,r,a,s,o,l,h;for(r=t.elements,a=e.elements,i=0;i<4;i++)s=r[i],o=r[i+4],l=r[i+8],h=r[i+12],n[i]=s*a[0]+o*a[1]+l*a[2]+h*a[3],n[i+4]=s*a[4]+o*a[5]+l*a[6]+h*a[7],n[i+8]=s*a[8]+o*a[9]+l*a[10]+h*a[11],n[i+12]=s*a[12]+o*a[13]+l*a[14]+h*a[15]},t.SHADERDEFINE_RECEIVE_SHADOW=1,t.SHADERDEFINE_CAST_SHADOW=512,t.SHADERDEFINE_SHADOW_PSSM1=1024,t.SHADERDEFINE_SHADOW_PSSM2=2048,t.SHADERDEFINE_SHADOW_PSSM3=4096,t.SHADERDEFINE_SHADOW_PCF_NO=8192,t.SHADERDEFINE_SHADOW_PCF1=16384,t.SHADERDEFINE_SHADOW_PCF2=32768,t.SHADERDEFINE_SHADOW_PCF3=65536,t.MAX_PSSM_COUNT=3,t}(),KeyframeNode=function(){function t(){this._cacheProperty=!1,this.path=null,this.componentType=null,this.propertyNameID=0,this.keyFrameWidth=0,this.defaultData=null,this.keyFrames=null}return __class(t,"laya.d3.animation.KeyframeNode"),t}(),AnimationNode=function(){function t(){this._childs=[],this._transform=new AnimationTransform3D(this)}__class(t,"laya.d3.animation.AnimationNode");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.transform=function(){return this._transform},e.addChild=function(t){t._parent=this,t._transform.parent=this._transform,this._childs.push(t)},e.removeChild=function(t){var e=this._childs.indexOf(t);-1!==e&&this._childs.splice(e,1)},e.getChildByName=function(t){for(var e=0,n=this._childs.length;e<n;e++){var i=this._childs[e];if(i.name===t)return i}return null},e.getChildByIndex=function(t){return this._childs[t]},e.getChildCount=function(){return this._childs.length},e.cloneTo=function(t){var e=t;e.name=this.name;var n=e._transform,i=n.localPosition;this._transform.localPosition.cloneTo(i),n.localPosition=i;var r=n.localRotation;this._transform.localRotation.cloneTo(r),n.localRotation=r;var a=n.localScale;this._transform.localScale.cloneTo(a),n.localScale=a;for(var s=0,o=this._childs.length;s<o;s++){var l=this._childs[s].clone();e.addChild(l)}},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t.__init__=function(){t.registerAnimationNodeProperty("localPosition",t._getLocalPosition,t._setLocalPosition),t.registerAnimationNodeProperty("localRotation",t._getLocalRotation,t._setLocalRotation),t.registerAnimationNodeProperty("localScale",t._getLocalScale,t._setLocalScale),t.registerAnimationNodeProperty("localRotationEuler",t._getLocalRotationEuler,t._setLocalRotationEuler),t.registerAnimationNodeProperty("particleRender.sharedMaterial.tintColor",t._getParticleRenderSharedMaterialTintColor,t._setParticleRenderSharedMaterialTintColor),t.registerAnimationNodeProperty("meshRender.sharedMaterial.tilingOffset",t._getMeshRenderSharedMaterialTilingOffset,t._setMeshRenderSharedMaterialTilingOffset),t.registerAnimationNodeProperty("meshRender.sharedMaterial.albedoColor",t._getMeshRenderSharedMaterialAlbedo,t._setMeshRenderSharedMaterialAlbedo),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.tilingOffset",t._getSkinnedMeshRenderSharedMaterialTilingOffset,t._setSkinnedMeshRenderSharedMaterialTilingOffset),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedoColor",t._getSkinnedMeshRenderSharedMaterialAlbedo,t._setSkinnedMeshRenderSharedMaterialAlbedo),t.registerAnimationNodeProperty("meshRender.sharedMaterial.albedo",t._getMeshRenderSharedMaterialAlbedo,t._setMeshRenderSharedMaterialAlbedo),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedo",t._getSkinnedMeshRenderSharedMaterialAlbedo,t._setSkinnedMeshRenderSharedMaterialAlbedo)},t.registerAnimationNodeProperty=function(e,n,i){if(t._propertyIndexDic[e])throw new Error("AnimationNode: this propertyName has registered.");t._propertyIndexDic[e]=t._propertyIDCounter,t._propertyGetFuncs[t._propertyIDCounter]=n,t._propertySetFuncs[t._propertyIDCounter]=i,t._propertyIDCounter++},t._getLocalPosition=function(t,e){return t?t._transform.localPosition.elements:e._transform.localPosition.elements},t._setLocalPosition=function(t,e,n){var i;if(t){var r=t._transform;i=r._localPosition,i.elements=n,r._setLocalPosition(i)}else{var a=e._transform;i=a.localPosition,i.elements=n,a.localPosition=i}},t._getLocalRotation=function(t,e){return t?t._transform.localRotation.elements:e._transform.localRotation.elements},t._setLocalRotation=function(t,e,n){var i;if(t){var r=t._transform;i=r._localRotation,i.elements=n,r._setLocalRotation(i)}else{var a=e._transform;i=a.localRotation,i.elements=n,a.localRotation=i}},t._getLocalScale=function(t,e){return t?t._transform.localScale.elements:e._transform.localScale.elements},t._setLocalScale=function(t,e,n){var i;if(t){var r=t._transform;i=r._localScale,i.elements=n,r._setLocalScale(i)}else{var a=e._transform;i=a.localScale,i.elements=n,a.localScale=i}},t._getLocalRotationEuler=function(t,e){return t?t._transform.localRotationEuler.elements:e._transform.localRotationEuler.elements},t._setLocalRotationEuler=function(t,e,n){var i;if(t){var r=t._transform;i=r._localRotationEuler,i.elements=n,r._setLocalRotationEuler(i)}else{var a=e._transform;i=a.localRotationEuler,i.elements=n,a.localRotationEuler=i}},t._getMeshRenderSharedMaterialTilingOffset=function(t,e){var n;if(t){var i=t._transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.tilingOffset.elements):null}return n=e.meshRender.sharedMaterial,n.tilingOffset.elements},t._setMeshRenderSharedMaterialTilingOffset=function(t,e,n){var i,r;if(t){var a=t._transform._entity;a&&(i=a.owner.meshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r)}else i=e.meshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r},t._getMeshRenderSharedMaterialAlbedo=function(t,e){var n;if(t){var i=t._transform._entity;return i?(n=i.owner.meshRender.sharedMaterial,n.albedoColor.elements):null}return n=e.meshRender.sharedMaterial,n.albedoColor.elements},t._setMeshRenderSharedMaterialAlbedo=function(t,e,n){var i,r;if(t){var a=t._transform._entity;a&&(i=a.owner.meshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r)}else i=e.meshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r},t._getSkinnedMeshRenderSharedMaterialTilingOffset=function(t,e){var n;if(t){var i=t._transform._entity;return i?(n=i.owner.skinnedMeshRender.sharedMaterial,n.tilingOffset.elements):null}return n=e.skinnedMeshRender.sharedMaterial,n.tilingOffset.elements},t._setSkinnedMeshRenderSharedMaterialTilingOffset=function(t,e,n){var i,r;if(t){var a=t._transform._entity;a&&(i=a.owner.skinnedMeshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r)}else i=e.skinnedMeshRender.material,r=i.tilingOffset,r.elements=n,i.tilingOffset=r},t._getSkinnedMeshRenderSharedMaterialAlbedo=function(t,e){var n;if(t){var i=t._transform._entity;return i?(n=i.owner.skinnedMeshRender.sharedMaterial,n.albedoColor.elements):null}return n=e.skinnedMeshRender.sharedMaterial,n.albedoColor.elements},t._setSkinnedMeshRenderSharedMaterialAlbedo=function(t,e,n){var i,r;if(t){var a=t._transform._entity;a&&(i=a.owner.skinnedMeshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r)}else i=e.skinnedMeshRender.material,r=i.albedoColor,r.elements=n,i.albedoColor=r},t._getParticleRenderSharedMaterialTintColor=function(t,e){var n;if(t){var i=t._transform._entity;return i?(n=i.owner.particleRender.sharedMaterial,n.tintColor.elements):null}return n=e.particleRender.sharedMaterial,n.tintColor.elements},t._setParticleRenderSharedMaterialTintColor=function(t,e,n){var i,r;if(t){var a=t._transform._entity;a&&(i=a.owner.particleRender.material,r=i.tintColor,r.elements=n,i.tintColor=r)}else i=e.particleRender.material,r=i.tintColor,r.elements=n,i.tintColor=r},t._propertyIDCounter=0,t._propertyIndexDic={},t._propertySetFuncs=[],t._propertyGetFuncs=[],t}(),Keyframe=function(){function t(){this.startTime=NaN,this.inTangent=null,this.outTangent=null,this.data=null,this.duration=NaN,this.next=null}return __class(t,"laya.d3.animation.Keyframe"),t}(),AnimationClipParser01=function(){function t(){}return __class(t,"laya.d3.animation.AnimationClipParser01"),t.READ_DATA=function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._reader.getUint16(),n=t._BLOCK.blockStarts=[],i=t._BLOCK.blockLengths=[],r=0;r<e;r++)n.push(t._reader.getUint32()),i.push(t._reader.getUint32())},t.READ_STRINGS=function(){var e=t._reader.getUint32(),n=t._reader.getUint16(),i=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;r<n;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=i},t.parse=function(e,n){t._animationClip=e,t._reader=n;n.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var i=0,r=t._BLOCK.count;i<r;i++){var a=n.getUint16(),s=t._strings[a],o=t["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},t.READ_ANIMATIONS=function(){var e,n=0,i=0,r=t._reader,a=r.__getBuffer(),s=[],o=r.getUint8();for(s.length=o,n=0;n<o;n++)s[n]=r.getUint16();var l=[],h=r.getUint16();for(l.length=h,n=0;n<h;n++)l[n]=r.getFloat32();var _=t._animationClip;_.name=t._strings[r.getUint16()];var u=_._duration=r.getFloat32();_.islooping=!!r.getByte(),_._frameRate=r.getInt16();var c=r.getInt16(),d=_._nodes=new Array;d.length=c;var f=_._nodesMap={},m=0,p=0;for(n=0;n<c;n++){e=d[n]=new KeyframeNode;var g=r.getUint16(),v=e.path=[];for(v.length=g,i=0;i<g;i++)v[i]=t._strings[r.getUint16()];var x=v.join("/"),S=f[x];S||(f[x]=S=[]),S.push(e);var T=r.getInt16();-1!==T&&(e.componentType=t._strings[T]);var E=AnimationNode._propertyIndexDic[t._strings[r.getUint16()]];if(null==E)throw new Error("AnimationClipParser01:unknown property name.");var y=E<4,M=!y||y&&""===v[0];e._cacheProperty=M,M?m++:p++,e.propertyNameID=E;var D=s[r.getUint8()];e.keyFrameWidth=D/4;var C=e.keyFrames=[],R=C.length=r.getUint16(),A=null,b=NaN;for(i=0;i<R;i++){var I=C[i]=new Keyframe;b=I.startTime=l[r.getUint16()];var w=r.pos;I.inTangent=new Float32Array(a.slice(w,w+D)),r.pos+=D,w=r.pos,I.outTangent=new Float32Array(a.slice(w,w+D)),r.pos+=D,w=r.pos,I.data=new Float32Array(a.slice(w,w+D)),r.pos+=D,A&&(A.next=I,A.duration=b-A.startTime),A=I}I.next=null,I.duration=u-b}var V=_._nodeToCachePropertyMap=new Int32Array(c),L=_._cachePropertyToNodeMap=new Int32Array(m),P=_._unCachePropertyToNodeMap=new Int32Array(p);for(m=p=0,n=0;n<c;n++)e=d[n],e._cacheProperty?(V[n]=m,L[m++]=n):P[p++]=n},t._animationClip=null,t._reader=null,t._strings=[],__static(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),Utils3D=function(){function t(){}return __class(t,"laya.d3.utils.Utils3D"),t._rotationTransformScaleSkinAnimation=function(e,n,i,r,a,s,o,l,h,_,u,c){var d=t._tempArray16_0,f=t._tempArray16_1,m=t._tempArray16_2,p=r+r,g=a+a,v=s+s,x=r*p,S=a*p,T=a*g,E=s*p,y=s*g,M=s*v,D=o*p,C=o*g,R=o*v;d[15]=1,d[0]=1-T-M,d[1]=S+R,d[2]=E-C,d[4]=S-R,d[5]=1-x-M,d[6]=y+D,d[8]=E+C,d[9]=y-D,d[10]=1-x-T,f[15]=1,f[0]=l,f[5]=h,f[10]=_;var A,b,I,w,V;for(A=0;A<4;A++)b=d[A],I=d[A+4],w=d[A+8],V=d[A+12],m[A]=b,m[A+4]=I,m[A+8]=w,m[A+12]=b*e+I*n+w*i+V;for(A=0;A<4;A++)b=m[A],I=m[A+4],w=m[A+8],V=m[A+12],u[A+c]=b*f[0]+I*f[1]+w*f[2]+V*f[3],u[A+c+4]=b*f[4]+I*f[5]+w*f[6]+V*f[7],u[A+c+8]=b*f[8]+I*f[9]+w*f[10]+V*f[11],u[A+c+12]=b*f[12]+I*f[13]+w*f[14]+V*f[15]},t._createNodeByJson=function(e,n,i,r){if(!i)switch(n.type){case"Sprite3D":i=new Sprite3D;break;case"MeshSprite3D":i=new MeshSprite3D;break;case"SkinnedMeshSprite3D":i=new SkinnedMeshSprite3D;break;case"ShuriKenParticle3D":i=new ShuriKenParticle3D;break;case"Terrain":i=new Terrain;break;case"Camera":i=new Camera;break;case"DirectionLight":i=new DirectionLight;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=n.props;if(a)for(var s in a)i[s]=a[s];var o=n.customProps;o&&(i instanceof laya.d3.core.Sprite3D?(i._parseBaseCustomProps(o),i._parseCustomProps(e,r,o,n),i._parseCustomComponent(e,r,n.components)):i._parseCustomProps(e,r,o,n));var l=n.child;if(l)for(var h=0,_=l.length;h<_;h++){var u=t._createNodeByJson(e,l[h],null,r);i.addChild(u)}return i},t._computeBoneAndAnimationDatasByBindPoseMatrxix=function(t,e,n,i,r,a){var s,o,l=0,h=0,_=t.length;for(s=0;s<_;l+=t[s].keyframeWidth,h+=16,s++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(e[l+0],e[l+1],e[l+2],e[l+3],e[l+4],e[l+5],e[l+6],e[l+7],e[l+8],e[l+9],i,h),0!=s&&(o=16*t[s].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,o,i,h,i,h));var u=n.length;for(s=0;s<u;s++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,16*a[s],n[s],r,16*s)},t._computeAnimationDatasByArrayAndMatrixFast=function(t,e,n,i){for(var r=0,a=t.length;r<a;r++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(e,16*i[r],t[r],n,16*r)},t._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(t,e,n,i,r){var a,s,o=0,l=0,h=t.length;for(a=0;a<h;o+=t[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(e[o+7],e[o+8],e[o+9],e[o+3],e[o+4],e[o+5],e[o+6],e[o+0],e[o+1],e[o+2],i,l),0!=a&&(s=16*t[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(i,s,i,l,i,l));var _=n.length;for(a=0;a<_;a++){var u=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(i,u,n[a],r,u)}},t._computeAnimationDatasByArrayAndMatrixFastOld=function(t,e,n){for(var i=t.length,r=0;r<i;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(e,a,t[r],n,a)}},t._computeRootAnimationData=function(t,e,n){for(var i=0,r=0,a=0,s=t.length;i<s;r+=t[i].keyframeWidth,a+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(e[r+0],e[r+1],e[r+2],e[r+3],e[r+4],e[r+5],e[r+6],e[r+7],e[r+8],e[r+9],n,a)},t.transformVector3ArrayByQuat=function(t,e,n,i,r){var a=n.elements,s=t[e],o=t[e+1],l=t[e+2],h=a[0],_=a[1],u=a[2],c=a[3],d=c*s+_*l-u*o,f=c*o+u*s-h*l,m=c*l+h*o-_*s,p=-h*s-_*o-u*l;i[r]=d*c+p*-h+f*-u-m*-_,i[r+1]=f*c+p*-_+m*-h-d*-u,i[r+2]=m*c+p*-u+d*-_-f*-h},t.mulMatrixByArray=function(e,n,i,r,a,s){var o,l,h,_,u;if(a===i){for(i=t._tempArray16_3,o=0;o<16;++o)i[o]=a[s+o];r=0}for(o=0;o<4;o++)l=e[n+o],h=e[n+o+4],_=e[n+o+8],u=e[n+o+12],a[s+o]=l*i[r+0]+h*i[r+1]+_*i[r+2]+u*i[r+3],a[s+o+4]=l*i[r+4]+h*i[r+5]+_*i[r+6]+u*i[r+7],a[s+o+8]=l*i[r+8]+h*i[r+9]+_*i[r+10]+u*i[r+11],a[s+o+12]=l*i[r+12]+h*i[r+13]+_*i[r+14]+u*i[r+15]},t.mulMatrixByArrayFast=function(t,e,n,i,r,a){var s,o,l,h,_;for(s=0;s<4;s++)o=t[e+s],l=t[e+s+4],h=t[e+s+8],_=t[e+s+12],r[a+s]=o*n[i+0]+l*n[i+1]+h*n[i+2]+_*n[i+3],r[a+s+4]=o*n[i+4]+l*n[i+5]+h*n[i+6]+_*n[i+7],r[a+s+8]=o*n[i+8]+l*n[i+9]+h*n[i+10]+_*n[i+11],r[a+s+12]=o*n[i+12]+l*n[i+13]+h*n[i+14]+_*n[i+15]},t.mulMatrixByArrayAndMatrixFast=function(t,e,n,i,r){var a,s,o,l,h,_=n.elements,u=_[0],c=_[1],d=_[2],f=_[3],m=_[4],p=_[5],g=_[6],v=_[7],x=_[8],S=_[9],T=_[10],E=_[11],y=_[12],M=_[13],D=_[14],C=_[15],R=e,A=e+4,b=e+8,I=e+12,w=r,V=r+4,L=r+8,P=r+12;for(a=0;a<4;a++)s=t[R+a],o=t[A+a],l=t[b+a],h=t[I+a],i[w+a]=s*u+o*c+l*d+h*f,i[V+a]=s*m+o*p+l*g+h*v,i[L+a]=s*x+o*S+l*T+h*E,i[P+a]=s*y+o*M+l*D+h*C},t.createAffineTransformationArray=function(t,e,n,i,r,a,s,o,l,h,_,u){var c=i+i,d=r+r,f=a+a,m=i*c,p=i*d,g=i*f,v=r*d,x=r*f,S=a*f,T=s*c,E=s*d,y=s*f;_[u+0]=(1-(v+S))*o,_[u+1]=(p+y)*o,_[u+2]=(g-E)*o,_[u+3]=0,_[u+4]=(p-y)*l,_[u+5]=(1-(m+S))*l,_[u+6]=(x+T)*l,_[u+7]=0,_[u+8]=(g+E)*h,_[u+9]=(x-T)*h,_[u+10]=(1-(m+v))*h,_[u+11]=0,_[u+12]=t,_[u+13]=e,_[u+14]=n,_[u+15]=1},t.transformVector3ArrayToVector3ArrayCoordinate=function(e,n,i,r,a){var s=t._tempArray4_0,o=e[n+0],l=e[n+1],h=e[n+2],_=i.elements;s[0]=o*_[0]+l*_[4]+h*_[8]+_[12],s[1]=o*_[1]+l*_[5]+h*_[9]+_[13],s[2]=o*_[2]+l*_[6]+h*_[10]+_[14],s[3]=1/(o*_[3]+l*_[7]+h*_[11]+_[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},t.transformLightingMapTexcoordByUV0Array=function(t,e,n,i,r){var a=n.elements;i[r+0]=t[e+0]*a[0]+a[2],i[r+1]=(t[e+1]-1)*a[1]+a[3]},t.transformLightingMapTexcoordByUV1Array=function(t,e,n,i,r){var a=n.elements
;i[r+0]=t[e+0]*a[0]+a[2],i[r+1]=1+t[e+1]*a[1]+a[3]},t.getURLVerion=function(t){var e=t.indexOf("?");return e>=0?t.substr(e):null},t._quaternionCreateFromYawPitchRollArray=function(t,e,n,i){var r=.5*n,a=.5*e,s=.5*t,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),_=Math.cos(a),u=Math.sin(s),c=Math.cos(s);i[0]=c*h*l+u*_*o,i[1]=u*_*l-c*h*o,i[2]=c*_*o-u*h*l,i[3]=c*_*l+u*h*o},t._createAffineTransformationArray=function(t,e,n,i){var r=i.elements,a=e[0],s=e[1],o=e[2],l=e[3],h=a+a,_=s+s,u=o+o,c=a*h,d=a*_,f=a*u,m=s*_,p=s*u,g=o*u,v=l*h,x=l*_,S=l*u,T=n[0],E=n[1],y=n[2];r[0]=(1-(m+g))*T,r[1]=(d+S)*T,r[2]=(f-x)*T,r[3]=0,r[4]=(d-S)*E,r[5]=(1-(c+g))*E,r[6]=(p+v)*E,r[7]=0,r[8]=(f+x)*y,r[9]=(p-v)*y,r[10]=(1-(c+m))*y,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1},t._mulMatrixArray=function(t,e,n,i){var r,a,s,o,l,h=e.elements,_=t.elements,u=h[0],c=h[1],d=h[2],f=h[3],m=h[4],p=h[5],g=h[6],v=h[7],x=h[8],S=h[9],T=h[10],E=h[11],y=h[12],M=h[13],D=h[14],C=h[15],R=i,A=i+4,b=i+8,I=i+12;for(r=0;r<4;r++)a=_[r],s=_[r+4],o=_[r+8],l=_[r+12],n[R+r]=a*u+s*c+o*d+l*f,n[A+r]=a*m+s*p+o*g+l*v,n[b+r]=a*x+s*S+o*T+l*E,n[I+r]=a*y+s*M+o*D+l*C},t._tempVector3_0=new Vector3,t._tempVector3_1=new Vector3,t._tempVector3_2=new Vector3,t._tempVector3_3=new Vector3,t._tempVector3_4=new Vector3,t._tempVector3_5=new Vector3,t._tempVector3_6=new Vector3,t._tempArray4_0=new Float32Array(4),t._tempArray16_0=new Float32Array(16),t._tempArray16_1=new Float32Array(16),t._tempArray16_2=new Float32Array(16),t._tempArray16_3=new Float32Array(16),__static(t,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),t}(),Physics=function(){function t(){}return __class(t,"laya.d3.utils.Physics"),t.__init__=function(){t._layerCollsionMatrix.length=31;for(var e=0;e<31;e++){var n=[],i=31-e;n.length=i;for(var r=0;r<i;r++)n[r]=r===i-1;t._layerCollsionMatrix[e]=n}},t.setLayerCollision=function(e,n,i){t._layerCollsionMatrix[e.number][30-n.number]=i},t.getLayerCollision=function(e,n){return t._layerCollsionMatrix[e.number][30-n.number]},t.setColliderCollision=function(t,e,n){n?(delete t._ignoreCollisonMap[e.id],delete e._ignoreCollisonMap[t.id]):(t._ignoreCollisonMap[e.id]=e,e._ignoreCollisonMap[t.id]=t)},t.getIColliderCollision=function(t,e){return!!t._ignoreCollisonMap[e.id]},t.rayCast=function(e,n,i,r){void 0===i&&(i=1.79e308),void 0===r&&(r=0),t._outHitAllInfo.length=0;for(var a=Layer.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++){var l=a[s];if(l.enable&&(l.raycast(e,t._outHitInfo,i),-1!==t._outHitInfo.distance&&t._outHitInfo.distance<=i)){var h=new RaycastHit;t._outHitInfo.cloneTo(h),t._outHitAllInfo.push(h)}}if(0==t._outHitAllInfo.length)return n.sprite3D=null,void(n.distance=-1);for(var _=Number.MAX_VALUE,u=0,c=0;c<t._outHitAllInfo.length;c++)t._outHitAllInfo[c].distance<_&&(_=t._outHitAllInfo[c].distance,u=c);t._outHitAllInfo[u].cloneTo(n)},t.rayCastAll=function(e,n,i,r){void 0===i&&(i=1.79e308),void 0===r&&(r=0),n.length=0;for(var a=Layer.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++){var l=a[s];if(l.enable&&(t._outHitInfo.distance=-1,t._outHitInfo.sprite3D=null,l.raycast(e,t._outHitInfo,i),-1!==t._outHitInfo.distance&&t._outHitInfo.distance<=i)){var h=new RaycastHit;t._outHitInfo.cloneTo(h),n.push(h)}}},t._outHitAllInfo=[],t._layerCollsionMatrix=[],__static(t,["_outHitInfo",function(){return this._outHitInfo=new RaycastHit},"collisionManager",function(){return this.collisionManager=new CollisionManager},"gravity",function(){return this.gravity=new Vector3(0,-9.81,0)}]),t}(),RaycastHit=function(){function t(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new Vector3,new Vector3,new Vector3],this.trianglePositions.length=3,this.triangleNormals=[new Vector3,new Vector3,new Vector3],this.triangleNormals.length=3,this.position=new Vector3}return __class(t,"laya.d3.utils.RaycastHit"),t.prototype.cloneTo=function(t){t.distance=this.distance,this.trianglePositions[0].cloneTo(t.trianglePositions[0]),this.trianglePositions[1].cloneTo(t.trianglePositions[1]),this.trianglePositions[2].cloneTo(t.trianglePositions[2]),this.triangleNormals[0].cloneTo(t.triangleNormals[0]),this.triangleNormals[1].cloneTo(t.triangleNormals[1]),this.triangleNormals[2].cloneTo(t.triangleNormals[2]),this.position.cloneTo(t.position),t.sprite3D=this.sprite3D},t}(),Picker=function(){function t(){}return __class(t,"laya.d3.utils.Picker"),t.calculateCursorRay=function(e,n,i,r,a,s){var o=e.elements[0],l=e.elements[1],h=t._tempVector30,_=h.elements;_[0]=o,_[1]=l,_[2]=n.minDepth;var u=t._tempVector31,c=u.elements;c[0]=o,c[1]=l,c[2]=n.maxDepth;var d=s.origin,f=t._tempVector32;n.unprojectFromWVP(h,i,r,a,d),n.unprojectFromWVP(u,i,r,a,f);var m=s.direction.elements;m[0]=f.x-d.x,m[1]=f.y-d.y,m[2]=f.z-d.z,Vector3.normalize(s.direction,s.direction)},t.rayIntersectsPositionsAndIndices=function(e,n,i,r,a){for(var s=i.vertexStride/4,o=i.getVertexElementByUsage(0).offset/4,l=Number.MAX_VALUE,h=-1,_=-1,u=-1,c=0;c<r.length;c+=3){var d=t._tempVector35,f=d.elements,m=r[c]*s,p=m+o;f[0]=n[p],f[1]=n[p+1],f[2]=n[p+2];var g=t._tempVector36,v=g.elements,x=r[c+1]*s,S=x+o;v[0]=n[S],v[1]=n[S+1],v[2]=n[S+2];var T=t._tempVector37,E=T.elements,y=r[c+2]*s,M=y+o;E[0]=n[M],E[1]=n[M+1],E[2]=n[M+2];var D=laya.d3.utils.Picker.rayIntersectsTriangle(e,d,g,T);!isNaN(D)&&D<l&&(l=D,h=m,_=x,u=y)}if(l!==Number.MAX_VALUE){a.distance=l,Vector3.scale(e.direction,l,a.position),Vector3.add(e.origin,a.position,a.position);var C=a.trianglePositions,R=C[0],A=C[1],b=C[2],I=R.elements,w=A.elements,V=b.elements,L=h+o;I[0]=n[L],I[1]=n[L+1],I[2]=n[L+2];var P=_+o;w[0]=n[P],w[1]=n[P+1],w[2]=n[P+2];var N=u+o;V[0]=n[N],V[1]=n[N+1],V[2]=n[N+2];var O=i.getVertexElementByUsage(3);if(O){var F=O.offset/4,B=a.triangleNormals,U=B[0],G=B[1],H=B[2],W=U.elements,k=G.elements,z=H.elements,X=h+F;W[0]=n[X],W[1]=n[X+1],W[2]=n[X+2];var Y=_+F;k[0]=n[Y],k[1]=n[Y+1],k[2]=n[Y+2];var K=u+F;z[0]=n[K],z[1]=n[K+1],z[2]=n[K+2]}return!0}return a.position.toDefault(),a.distance=Number.MAX_VALUE,a.trianglePositions[0].toDefault(),a.trianglePositions[1].toDefault(),a.trianglePositions[2].toDefault(),a.triangleNormals[0].toDefault(),a.triangleNormals[1].toDefault(),a.triangleNormals[2].toDefault(),!1},t.rayIntersectsTriangle=function(e,n,i,r){var a=t._tempVector30,s=t._tempVector31;Vector3.subtract(i,n,a),Vector3.subtract(r,n,s);var o=t._tempVector32;Vector3.cross(e.direction,s,o);var l;if((l=Vector3.dot(a,o))>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return Number.NaN;var h=1/l,_=t._tempVector33;Vector3.subtract(e.origin,n,_);var u;if(u=Vector3.dot(_,o),(u*=h)<0||u>1)return Number.NaN;var c=t._tempVector34;Vector3.cross(_,a,c);var d;if(d=Vector3.dot(e.direction,c),(d*=h)<0||u+d>1)return Number.NaN;var f;return f=Vector3.dot(s,c),(f*=h)<0?Number.NaN:f},__static(t,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempVector34",function(){return this._tempVector34=new Vector3},"_tempVector35",function(){return this._tempVector35=new Vector3},"_tempVector36",function(){return this._tempVector36=new Vector3},"_tempVector37",function(){return this._tempVector37=new Vector3}]),t}(),Size=function(){function t(t,e){this._width=0,this._height=0,this._width=t,this._height=e}__class(t,"laya.d3.utils.Size");var e=t.prototype;return __getset(0,e,"height",function(){return-1===this._height?RenderState.clientHeight:this._height}),__getset(0,e,"width",function(){return-1===this._width?RenderState.clientWidth:this._width}),__getset(1,t,"fullScreen",function(){return new t(-1,-1)}),t}(),MathUtils3D=function(){function t(){}return __class(t,"laya.d3.math.MathUtils3D"),t.isZero=function(e){return Math.abs(e)<t.zeroTolerance},t.nearEqual=function(e,n){return!!t.isZero(e-n)},t.fastInvSqrt=function(e){return t.isZero(e)?e:1/Math.sqrt(e)},__static(t,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),t}(),Rand=function(){function t(t){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=t,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}__class(t,"laya.d3.math.Rand");var e=t.prototype;return e.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]},e.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},e.getSignedFloat=function(){return 2*this.getFloat()-1},__getset(0,e,"seed",function(){return this.seeds[0]},function(t){this.seeds[0]=t,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),t.getFloatFromInt=function(t){return 1/8388607*(8388607&t)},t.getByteFromInt=function(t){return(8388607&t)>>>15},t}(),Matrix3x3=function(){function t(){var t=this.elements=new Float32Array(9);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}__class(t,"laya.d3.math.Matrix3x3");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.determinant=function(){var t=this.elements,e=t[0],n=t[1],i=t[2],r=t[3],a=t[4],s=t[5],o=t[6],l=t[7],h=t[8];return e*(h*a-s*l)+n*(-h*r+s*o)+i*(l*r-a*o)},e.translate=function(t,e){var n=e.elements,i=this.elements,r=t.elements,a=i[0],s=i[1],o=i[2],l=i[3],h=i[4],_=i[5],u=i[6],c=i[7],d=i[8],f=r[0],m=r[1];n[0]=a,n[1]=s,n[2]=o,n[3]=l,n[4]=h,n[5]=_,n[6]=f*a+m*l+u,n[7]=f*s+m*h+c,n[8]=f*o+m*_+d},e.rotate=function(t,e){var n=e.elements,i=this.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=i[4],h=i[5],_=i[6],u=i[7],c=i[8],d=Math.sin(t),f=Math.cos(t);n[0]=f*r+d*o,n[1]=f*a+d*l,n[2]=f*s+d*h,n[3]=f*o-d*r,n[4]=f*l-d*a,n[5]=f*h-d*s,n[6]=_,n[7]=u,n[8]=c},e.scale=function(t,e){var n=e.elements,i=this.elements,r=t.elements,a=r[0],s=r[1];n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=s*i[3],n[4]=s*i[4],n[5]=s*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]},e.invert=function(t){var e=t.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=n[4],l=n[5],h=n[6],_=n[7],u=n[8],c=u*o-l*_,d=-u*s+l*h,f=_*s-o*h,m=i*c+r*d+a*f;m||(t=null),m=1/m,e[0]=c*m,e[1]=(-u*r+a*_)*m,e[2]=(l*r-a*o)*m,e[3]=d*m,e[4]=(u*i-a*h)*m,e[5]=(-l*i+a*s)*m,e[6]=f*m,e[7]=(-_*i+r*h)*m,e[8]=(o*i-r*s)*m},e.transpose=function(t){var e=t.elements,n=this.elements;if(t===this){var i=n[1],r=n[2],a=n[5];e[1]=n[3],e[2]=n[6],e[3]=i,e[5]=n[7],e[6]=r,e[7]=a}else e[0]=n[0],e[1]=n[3],e[2]=n[6],e[3]=n[1],e[4]=n[4],e[5]=n[7],e[6]=n[2],e[7]=n[5],e[8]=n[8]},e.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},e.cloneTo=function(t){var e,n,i;if(n=this.elements,i=t.elements,n!==i)for(e=0;e<9;++e)i[e]=n[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t.createFromTranslation=function(t,e){var n=(e.elements,t.elements);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=n[0],e[7]=n[1],e[8]=1},t.createFromRotation=function(t,e){var n=e.elements,i=Math.sin(t),r=Math.cos(t);n[0]=r,n[1]=i,n[2]=0,n[3]=-i,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1},t.createFromScaling=function(t,e){var n=e.elements,i=t.elements;n[0]=i[0],n[1]=0,n[2]=0,n[3]=0,n[4]=i[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1},t.createFromMatrix4x4=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]},t.multiply=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],l=r[2],h=r[3],_=r[4],u=r[5],c=r[6],d=r[7],f=r[8],m=a[0],p=a[1],g=a[2],v=a[3],x=a[4],S=a[5],T=a[6],E=a[7],y=a[8];i[0]=m*s+p*h+g*c,i[1]=m*o+p*_+g*d,i[2]=m*l+p*u+g*f,i[3]=v*s+x*h+S*c,i[4]=v*o+x*_+S*d,i[5]=v*l+x*u+S*f,i[6]=T*s+E*h+y*c,i[7]=T*o+E*_+y*d,i[8]=T*l+E*u+y*f},t.lookAt=function(e,n,i,r){Vector3.subtract(e,n,t._tempV30),Vector3.normalize(t._tempV30,t._tempV30),Vector3.cross(i,t._tempV30,t._tempV31),Vector3.normalize(t._tempV31,t._tempV31),Vector3.cross(t._tempV30,t._tempV31,t._tempV32);var a=t._tempV30.elements,s=t._tempV31.elements,o=t._tempV32.elements,l=r.elements;l[0]=s[0],l[3]=s[1],l[6]=s[2],l[1]=o[0],l[4]=o[1],l[7]=o[2],l[2]=a[0],l[5]=a[1],l[8]=a[2]},t.DEFAULT=new t,__static(t,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3}]),t}(),Viewport=function(){function t(t,e,n,i){this.minDepth=0,this.maxDepth=1,this.x=t,this.y=e,this.width=n,this.height=i}__class(t,"laya.d3.math.Viewport");var e=t.prototype;return e.project=function(t,e,n){Vector3.transformV3ToV3(t,e,n);var i=t.elements,r=e.elements,a=n.elements,s=i[0]*r[3]+i[1]*r[7]+i[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(1-a[1])*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},e.unprojectFromMat=function(t,e,n){var i=t.elements,r=e.elements,a=n.elements;a[0]=(i[0]-this.x)/this.width*2-1,a[1]=-((i[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(i[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];Vector3.transformV3ToV3(n,e,n),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},e.unprojectFromWVP=function(e,n,i,r,a){Matrix4x4.multiply(n,i,t._tempMatrix4x4),r&&Matrix4x4.multiply(t._tempMatrix4x4,r,t._tempMatrix4x4),t._tempMatrix4x4.invert(t._tempMatrix4x4),this.unprojectFromMat(e,t._tempMatrix4x4,a)},__static(t,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Matrix4x4}]),t}(),Vector4=function(){function t(t,e,n,i){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0);var r=this.elements;r[0]=t,r[1]=e,r[2]=n,r[3]=i}__class(t,"laya.d3.math.Vector4");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1],this.elements[2]=t[e+2],this.elements[3]=t[e+3]},e.cloneTo=function(t){var e=t,n=e.elements,i=this.elements;n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=i[3]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},__getset(0,e,"w",function(){return this.elements[3]},function(t){this.elements[3]=t}),__getset(0,e,"z",function(){return this.elements[2]},function(t){this.elements[2]=t}),__getset(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),__getset(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),t.lerp=function(t,e,n,i){var r=i.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2],_=a[3];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h),r[3]=_+n*(s[3]-_)},t.transformByM4x4=function(t,e,n){var i=t.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=e.elements,h=n.elements;h[0]=r*l[0]+a*l[4]+s*l[8]+o*l[12],h[1]=r*l[1]+a*l[5]+s*l[9]+o*l[13],h[2]=r*l[2]+a*l[6]+s*l[10]+o*l[14],h[3]=r*l[3]+a*l[7]+s*l[11]+o*l[15]},t.equals=function(t,e){var n=t.elements,i=e.elements;return MathUtils3D.nearEqual(Math.abs(n[0]),Math.abs(i[0]))&&MathUtils3D.nearEqual(Math.abs(n[1]),Math.abs(i[1]))&&MathUtils3D.nearEqual(Math.abs(n[2]),Math.abs(i[2]))&&MathUtils3D.nearEqual(Math.abs(n[3]),Math.abs(i[3]))},t.normalize=function(t,e){var n=t.elements,i=e.elements,r=t.length();r>0&&(i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[3]=n[3]*r)},t.add=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},t.subtract=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2],i[3]=r[3]-a[3]},t.multiply=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2],i[3]=r[3]*a[3]},t.scale=function(t,e,n){var i=n.elements,r=t.elements;i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e,i[3]=r[3]*e},t.Clamp=function(t,e,n,i){var r=t.elements,a=r[0],s=r[1],o=r[2],l=r[3],h=e.elements,_=h[0],u=h[1],c=h[2],d=h[3],f=n.elements,m=f[0],p=f[1],g=f[2],v=f[3],x=i.elements;a=a>m?m:a,a=a<_?_:a,s=s>p?p:s,s=s<u?u:s,o=o>g?g:o,o=o<c?c:o,l=l>v?v:l,l=l<d?d:l,x[0]=a,x[1]=s,x[2]=o,x[3]=l},t.distanceSquared=function(t,e){var n=t.elements,i=e.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2],o=n[3]-i[3];return r*r+a*a+s*s+o*o},t.distance=function(t,e){var n=t.elements,i=e.elements,r=n[0]-i[0],a=n[1]-i[1],s=n[2]-i[2],o=n[3]-i[3];return Math.sqrt(r*r+a*a+s*s+o*o)},t.dot=function(t,e){var n=t.elements,i=e.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},t.min=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2]),i[3]=Math.min(r[3],a[3])},t.max=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2]),i[3]=Math.max(r[3],a[3])},__static(t,["ZERO",function(){return this.ZERO=new t},"ONE",function(){return this.ONE=new t(1,1,1,1)},"UnitX",function(){return this.UnitX=new t(1,0,0,0)},"UnitY",function(){return this.UnitY=new t(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new t(0,0,1,0)},"UnitW",function(){return this.UnitW=new t(0,0,0,1)}]),t}(),ContainmentType=function(){function t(){}return __class(t,"laya.d3.math.ContainmentType"),t.Disjoint=0,t.Contains=1,t.Intersects=2,t}(),OrientedBoundBox=function(){function t(t,e){this.extents=null,this.transformation=null,this.extents=t,this.transformation=e}__class(t,"laya.d3.math.OrientedBoundBox");var e=t.prototype;return e.getCorners=function(e){var n=t._tempV30.elements,i=t._tempV31.elements,r=t._tempV32.elements,a=this.extents.elements;n[0]=a[0],n[1]=n[2]=0,i[1]=a[1],i[0]=i[2]=0,r[2]=a[2],r[0]=r[1]=0,Vector3.TransformNormal(t._tempV30,this.transformation,t._tempV30),Vector3.TransformNormal(t._tempV31,this.transformation,t._tempV31),Vector3.TransformNormal(t._tempV32,this.transformation,t._tempV32);var s=t._tempV33;this.transformation.getTranslationVector(s),e.length=8,Vector3.add(s,t._tempV30,t._tempV34),Vector3.add(t._tempV34,t._tempV31,t._tempV34),Vector3.add(t._tempV34,t._tempV32,e[0]),Vector3.add(s,t._tempV30,t._tempV34),Vector3.add(t._tempV34,t._tempV31,t._tempV34),Vector3.subtract(t._tempV34,t._tempV32,e[1]),Vector3.subtract(s,t._tempV30,t._tempV34),Vector3.add(t._tempV34,t._tempV31,t._tempV34),Vector3.subtract(t._tempV34,t._tempV32,e[2]),Vector3.subtract(s,t._tempV30,t._tempV34),Vector3.add(t._tempV34,t._tempV31,t._tempV34),Vector3.add(t._tempV34,t._tempV32,e[3]),Vector3.add(s,t._tempV30,t._tempV34),Vector3.subtract(t._tempV34,t._tempV31,t._tempV34),Vector3.add(t._tempV34,t._tempV32,e[4]),Vector3.add(s,t._tempV30,t._tempV34),Vector3.subtract(t._tempV34,t._tempV31,t._tempV34),Vector3.subtract(t._tempV34,t._tempV32,e[5]),Vector3.subtract(s,t._tempV30,t._tempV34),Vector3.subtract(t._tempV34,t._tempV31,t._tempV34),Vector3.subtract(t._tempV34,t._tempV32,e[6]),Vector3.subtract(s,t._tempV30,t._tempV34),Vector3.subtract(t._tempV34,t._tempV31,t._tempV34),Vector3.add(t._tempV34,t._tempV32,e[7])},e.transform=function(t){Matrix4x4.multiply(this.transformation,t,this.transformation)},e.scale=function(t){Vector3.multiply(this.extents,t,this.extents)},e.translate=function(e){this.transformation.getTranslationVector(t._tempV30),Vector3.add(t._tempV30,e,t._tempV31),this.transformation.setTranslationVector(t._tempV31)},e.Size=function(t){Vector3.scale(this.extents,2,t)},e.getSize=function(e){var n=this.extents.elements;t._tempV30.x=n[0],t._tempV31.y=n[1],t._tempV32.z=n[2],Vector3.TransformNormal(t._tempV30,this.transformation,t._tempV30),Vector3.TransformNormal(t._tempV31,this.transformation,t._tempV31),Vector3.TransformNormal(t._tempV31,this.transformation,t._tempV32);var i=e.elements;i[0]=Vector3.scalarLength(t._tempV30),i[1]=Vector3.scalarLength(t._tempV31),i[2]=Vector3.scalarLength(t._tempV32)},e.getSizeSquared=function(e){var n=this.extents.elements;t._tempV30.x=n[0],t._tempV31.y=n[1],t._tempV32.z=n[2],Vector3.TransformNormal(t._tempV30,this.transformation,t._tempV30),Vector3.TransformNormal(t._tempV31,this.transformation,t._tempV31),Vector3.TransformNormal(t._tempV31,this.transformation,t._tempV32);var i=e.elements;i[0]=Vector3.scalarLengthSquared(t._tempV30),i[1]=Vector3.scalarLengthSquared(t._tempV31),i[2]=Vector3.scalarLengthSquared(t._tempV32)},e.getCenter=function(t){this.transformation.getTranslationVector(t)},e.containsPoint=function(e){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(t._tempM0),Vector3.transformCoordinate(e,t._tempM0,t._tempV30);var s=t._tempV30.elements,o=Math.abs(s[0]),l=Math.abs(s[1]),h=Math.abs(s[2]);return MathUtils3D.nearEqual(o,i)&&MathUtils3D.nearEqual(l,r)&&MathUtils3D.nearEqual(h,a)?2:o<i&&l<r&&h<a?1:0},e.containsPoints=function(e){var n=this.extents.elements,i=n[0],r=n[1],a=n[2];this.transformation.invert(t._tempM0);for(var s=!0,o=!1,l=0;l<e.length;l++){Vector3.transformCoordinate(e[l],t._tempM0,t._tempV30);var h=t._tempV30.elements,_=Math.abs(h[0]),u=Math.abs(h[1]),c=Math.abs(h[2]);MathUtils3D.nearEqual(_,i)&&MathUtils3D.nearEqual(u,r)&&MathUtils3D.nearEqual(c,a)&&(o=!0),_<i&&u<r&&a<c?o=!0:s=!1}return s?1:o?2:0},e.containsSphere=function(e,n){void 0===n&&(n=!1);var i=this.extents.elements,r=i[0],a=i[1],s=i[2],o=e.radius;this.transformation.invert(t._tempM0),Vector3.transformCoordinate(e.center,t._tempM0,t._tempV30);var l=NaN;if(n?l=o:(Vector3.scale(Vector3.UnitX,o,t._tempV31),Vector3.TransformNormal(t._tempV31,t._tempM0,t._tempV31),l=Vector3.scalarLength(t._tempV31)),Vector3.scale(this.extents,-1,t._tempV32),Vector3.Clamp(t._tempV30,t._tempV32,this.extents,t._tempV33),Vector3.distanceSquared(t._tempV30,t._tempV33)>l*l)return 0;var h=t._tempV30.elements,_=h[0],u=h[1],c=h[2],d=t._tempV32.elements,f=d[0],m=d[1],p=d[2];return f+l<=_&&_<=r-l&&r-f>l&&m+l<=u&&u<=a-l&&a-m>l&&p+l<=c&&c<=s-l&&s-p>l?1:2},e.containsOrientedBoundBox=function(e){var n=0,i=0;e.getCorners(t._corners);var r=this.containsPoints(t._corners);if(0!=r)return r;var a=this.extents.elements;e.extents.cloneTo(t._tempV35);var s=t._tempV35.elements;t._getRows(this.transformation,t._rows1),t._getRows(e.transformation,t._rows2);var o=NaN,l=NaN,h=NaN;for(n=0;n<4;n++)for(i=0;i<4;i++)3==n||3==i?(t._tempM0.setElementByRowColumn(n,i,0),t._tempM1.setElementByRowColumn(n,i,0)):(h=Vector3.dot(t._rows1[n],t._rows2[i]),t._tempM0.setElementByRowColumn(n,i,h),t._tempM1.setElementByRowColumn(n,i,Math.abs(h)));e.getCenter(t._tempV34),this.getCenter(t._tempV36),Vector3.subtract(t._tempV34,t._tempV36,t._tempV30);var _=t._tempV31.elements;_[0]=Vector3.dot(t._tempV30,t._rows1[0]),_[1]=Vector3.dot(t._tempV30,t._rows1[1]),_[2]=Vector3.dot(t._tempV30,t._rows1[2]);var u=t._tempV32.elements,c=t._tempV33.elements;for(n=0;n<3;n++)if(u[0]=t._tempM1.getElementByRowColumn(n,0),u[1]=t._tempM1.getElementByRowColumn(n,1),u[2]=t._tempM1.getElementByRowColumn(n,2),o=a[n],l=Vector3.dot(t._tempV35,t._tempV32),Math.abs(_[n])>o+l)return 0;for(i=0;i<3;i++)if(u[0]=t._tempM1.getElementByRowColumn(0,i),u[1]=t._tempM1.getElementByRowColumn(1,i),u[2]=t._tempM1.getElementByRowColumn(2,i),c[0]=t._tempM0.getElementByRowColumn(0,i),c[1]=t._tempM0.getElementByRowColumn(1,i),c[2]=t._tempM0.getElementByRowColumn(2,i),o=Vector3.dot(this.extents,t._tempV32),l=s[i],Math.abs(Vector3.dot(t._tempV31,t._tempV33))>o+l)return 0;for(n=0;n<3;n++)for(i=0;i<3;i++){var d=(n+1)%3,f=(n+2)%3,m=(i+1)%3,p=(i+2)%3;if(o=a[d]*t._tempM1.getElementByRowColumn(f,i)+s[f]*t._tempM1.getElementByRowColumn(d,i),l=a[m]*t._tempM1.getElementByRowColumn(n,p)+s[p]*t._tempM1.getElementByRowColumn(n,m),Math.abs(_[f]*t._tempM0.getElementByRowColumn(d,i)-_[d]*t._tempM0.getElementByRowColumn(f,i))>o+l)return 0}return 2},e.containsLine=function(e,n){t._corners[0]=e,t._corners[1]=n;var i=this.containsPoints(t._corners);if(0!=i)return i;var r=this.extents.elements,a=r[0],s=r[1],o=r[2];this.transformation.invert(t._tempM0),Vector3.transformCoordinate(e,t._tempM0,t._tempV30),Vector3.transformCoordinate(n,t._tempM0,t._tempV31),Vector3.add(t._tempV30,t._tempV31,t._tempV32),Vector3.scale(t._tempV32,.5,t._tempV32),Vector3.subtract(t._tempV30,t._tempV32,t._tempV33);var l=t._tempV33.elements,h=l[0],_=l[1],u=l[2],c=t._tempV34.elements,d=c[0]=Math.abs(l[0]),f=c[1]=Math.abs(l[1]),m=c[2]=Math.abs(l[2]),p=t._tempV32.elements,g=p[0],v=p[1],x=p[2];return Math.abs(g)>a+d?0:Math.abs(v)>s+f?0:Math.abs(x)>o+m?0:Math.abs(v*u-x*_)>s*m+o*f?0:Math.abs(g*u-x*h)>a*m+o*d?0:Math.abs(g*_-v*h)>a*f+s*d?0:2},e.containsBoundBox=function(e){var n=0,i=0,r=e.min,a=e.max;e.getCorners(t._corners);var s=this.containsPoints(t._corners);if(0!=s)return s;Vector3.subtract(a,r,t._tempV30),Vector3.scale(t._tempV30,.5,t._tempV30),Vector3.add(r,t._tempV30,t._tempV30),Vector3.subtract(a,t._tempV30,t._tempV31);var o=this.extents.elements,l=t._tempV31.elements;t._getRows(this.transformation,t._rows1),this.transformation.invert(t._tempM0);var h=NaN,_=NaN;for(n=0;n<3;n++)for(i=0;i<3;i++)t._tempM1.setElementByRowColumn(n,i,Math.abs(t._tempM0.getElementByRowColumn(n,i)));this.getCenter(t._tempV35),Vector3.subtract(t._tempV30,t._tempV35,t._tempV32);var u=t._tempV31.elements;u[0]=Vector3.dot(t._tempV32,t._rows1[0]),u[1]=Vector3.dot(t._tempV32,t._rows1[1]),u[2]=Vector3.dot(t._tempV32,t._rows1[2]);var c=t._tempV33.elements,d=t._tempV34.elements;for(n=0;n<3;n++)if(c[0]=t._tempM1.getElementByRowColumn(n,0),c[1]=t._tempM1.getElementByRowColumn(n,1),c[2]=t._tempM1.getElementByRowColumn(n,2),h=o[n],_=Vector3.dot(t._tempV31,t._tempV33),Math.abs(u[n])>h+_)return 0;for(i=0;i<3;i++)if(c[0]=t._tempM1.getElementByRowColumn(0,i),c[1]=t._tempM1.getElementByRowColumn(1,i),c[2]=t._tempM1.getElementByRowColumn(2,i),d[0]=t._tempM0.getElementByRowColumn(0,i),d[1]=t._tempM0.getElementByRowColumn(1,i),d[2]=t._tempM0.getElementByRowColumn(2,i),h=Vector3.dot(this.extents,t._tempV33),_=l[i],Math.abs(Vector3.dot(t._tempV31,t._tempV34))>h+_)return 0;for(n=0;n<3;n++)for(i=0;i<3;i++){var f=(n+1)%3,m=(n+2)%3,p=(i+1)%3,g=(i+2)%3;if(h=o[f]*t._tempM1.getElementByRowColumn(m,i)+o[m]*t._tempM1.getElementByRowColumn(f,i),_=l[p]*t._tempM1.getElementByRowColumn(n,g)+l[g]*t._tempM1.getElementByRowColumn(n,p),Math.abs(u[m]*t._tempM0.getElementByRowColumn(f,i)-u[f]*t._tempM0.getElementByRowColumn(m,i))>h+_)return 0}return 2},e.intersectsRay=function(e,n){Vector3.scale(this.extents,-1,t._tempV30),this.transformation.invert(t._tempM0),Vector3.TransformNormal(e.direction,t._tempM0,t._ray.direction),Vector3.transformCoordinate(e.origin,t._tempM0,t._ray.origin),t._boxBound1.min=t._tempV30,t._boxBound1.max=this.extents;var i=Collision.intersectsRayAndBoxRP(t._ray,t._boxBound1,n);return-1!==i&&Vector3.transformCoordinate(n,this.transformation,n),i},e._getLocalCorners=function(e){e.length=8;var n=this.extents.elements;t._tempV30.x=n[0],t._tempV31.y=n[1],t._tempV32.z=n[2],Vector3.add(t._tempV30,t._tempV31,t._tempV33),Vector3.add(t._tempV33,t._tempV32,e[0]),Vector3.add(t._tempV30,t._tempV31,t._tempV33),Vector3.subtract(t._tempV33,t._tempV32,e[1]),Vector3.subtract(t._tempV31,t._tempV30,t._tempV33),Vector3.subtract(t._tempV33,t._tempV30,e[2]),Vector3.subtract(t._tempV31,t._tempV30,t._tempV33),Vector3.add(t._tempV33,t._tempV32,e[3]),Vector3.subtract(t._tempV30,t._tempV31,t._tempV33),Vector3.add(t._tempV33,t._tempV32,e[4]),Vector3.subtract(t._tempV30,t._tempV31,t._tempV33),Vector3.subtract(t._tempV33,t._tempV32,e[5]),Vector3.scale(e[0],-1,e[6]),Vector3.subtract(t._tempV32,t._tempV30,t._tempV33),Vector3.subtract(t._tempV33,t._tempV31,e[7])},e.equals=function(t){return this.extents==t.extents&&this.transformation==t.transformation},e.cloneTo=function(t){var e=t;this.extents.cloneTo(e.extents),this.transformation.cloneTo(e.transformation)},t.createByBoundBox=function(e,n){var i=e.min,r=e.max;Vector3.subtract(r,i,t._tempV30),Vector3.scale(t._tempV30,.5,t._tempV30),Vector3.add(i,t._tempV30,t._tempV31),Vector3.subtract(r,t._tempV31,t._tempV32),Matrix4x4.translation(t._tempV31,t._tempM0);var a=t._tempV32.clone(),s=t._tempM0.clone();n.extents=a,n.transformation=s},t.createByMinAndMaxVertex=function(e,n){return Vector3.subtract(n,e,t._tempV30),Vector3.scale(t._tempV30,.5,t._tempV30),Vector3.add(e,t._tempV30,t._tempV31),Vector3.subtract(n,t._tempV31,t._tempV32),Matrix4x4.translation(t._tempV31,t._tempM0),new t(t._tempV32,t._tempM0)},t._getRows=function(t,e){e.length=3;var n=t.elements,i=e[0].elements;i[0]=n[0],i[1]=n[1],i[2]=n[2];var r=e[1].elements;r[0]=n[4],r[1]=n[5],r[2]=n[6];var a=e[2].elements;a[0]=n[8],a[1]=n[9],a[2]=n[10]},t.getObbtoObbMatrix4x4=function(e,n,i,r){var a=e.transformation,s=n.transformation;if(i){t._getRows(a,t._rows1),t._getRows(s,t._rows2);for(var o=0;o<3;o++)for(var l=0;l<3;l++)r.setElementByRowColumn(o,l,Vector3.dot(t._rows2[o],t._rows1[l]));n.getCenter(t._tempV30),e.getCenter(t._tempV31),Vector3.subtract(t._tempV30,t._tempV31,t._tempV32);var h=r.elements;h[12]=Vector3.dot(t._tempV32,t._rows1[0]),h[13]=Vector3.dot(t._tempV32,t._rows1[1]),h[14]=Vector3.dot(t._tempV32,t._rows1[2]),h[15]=1}else a.invert(t._tempM0),Matrix4x4.multiply(s,t._tempM0,r)},t.merge=function(e,n,i){var r=e.extents,a=e.transformation;t.getObbtoObbMatrix4x4(e,n,i,t._tempM0),n._getLocalCorners(t._corners),Vector3.transformCoordinate(t._corners[0],t._tempM0,t._corners[0]),Vector3.transformCoordinate(t._corners[1],t._tempM0,t._corners[1]),Vector3.transformCoordinate(t._corners[2],t._tempM0,t._corners[2]),Vector3.transformCoordinate(t._corners[3],t._tempM0,t._corners[3]),Vector3.transformCoordinate(t._corners[4],t._tempM0,t._corners[4]),Vector3.transformCoordinate(t._corners[5],t._tempM0,t._corners[5]),Vector3.transformCoordinate(t._corners[6],t._tempM0,t._corners[6]),Vector3.transformCoordinate(t._corners[7],t._tempM0,t._corners[7]),Vector3.scale(r,-1,t._boxBound1.min),r.cloneTo(t._boxBound1.max),BoundBox.createfromPoints(t._corners,t._boxBound2),BoundBox.merge(t._boxBound2,t._boxBound1,t._boxBound3);var s=t._boxBound3.min,o=t._boxBound3.max;Vector3.subtract(o,s,t._tempV30),Vector3.scale(t._tempV30,.5,t._tempV30),Vector3.add(s,t._tempV30,t._tempV32),Vector3.subtract(o,t._tempV32,r),Vector3.transformCoordinate(t._tempV32,a,t._tempV33)},__static(t,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3},"_tempM0",function(){return this._tempM0=new Matrix4x4},"_tempM1",function(){return this._tempM1=new Matrix4x4},"_corners",function(){return this._corners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]},"_rows1",function(){return this._rows1=[new Vector3,new Vector3,new Vector3]},"_rows2",function(){return this._rows2=[new Vector3,new Vector3,new Vector3]},"_ray",function(){return this._ray=new Ray(new Vector3,new Vector3)},"_boxBound1",function(){return this._boxBound1=new BoundBox(new Vector3,new Vector3)},"_boxBound2",function(){return this._boxBound2=new BoundBox(new Vector3,new Vector3)},"_boxBound3",function(){return this._boxBound3=new BoundBox(new Vector3,new Vector3)}]),t}(),Plane=function(){function t(t,e){this.normal=null,this.distance=NaN,void 0===e&&(e=0),this.normal=t,this.distance=e}return __class(t,"laya.d3.math.Plane"),t.prototype.normalize=function(){var t=this.normal.elements,e=t[0],n=t[1],i=t[2],r=1/Math.sqrt(e*e+n*n+i*i);t[0]=e*r,t[1]=n*r,t[2]=i*r,this.distance*=r},
t.createPlaneBy3P=function(e,n,i){var r=e.elements,a=n.elements,s=i.elements,o=a[0]-r[0],l=a[1]-r[1],h=a[2]-r[2],_=s[0]-r[0],u=s[1]-r[1],c=s[2]-r[2],d=l*c-h*u,f=h*_-o*c,m=o*u-l*_,p=1/Math.sqrt(d*d+f*f+m*m),g=d*p,v=f*p,x=m*p,S=t._TEMPVec3.elements;S[0]=g,S[1]=v,S[2]=x;var T=-(g*r[0]+v*r[1]+x*r[2]);return new t(t._TEMPVec3,T)},t.PlaneIntersectionType_Back=0,t.PlaneIntersectionType_Front=1,t.PlaneIntersectionType_Intersecting=2,__static(t,["_TEMPVec3",function(){return this._TEMPVec3=new Vector3}]),t}(),BoundBox=function(){function t(t,e){this.min=null,this.max=null,this.min=t,this.max=e}__class(t,"laya.d3.math.BoundBox");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.getCorners=function(t){t.length=8;var e=this.min.elements,n=this.max.elements,i=e[0],r=e[1],a=e[2],s=n[0],o=n[1],l=n[2];t[0]=new Vector3(i,o,l),t[1]=new Vector3(s,o,l),t[2]=new Vector3(s,r,l),t[3]=new Vector3(i,r,l),t[4]=new Vector3(i,o,a),t[5]=new Vector3(s,o,a),t[6]=new Vector3(s,r,a),t[7]=new Vector3(i,r,a)},e.toDefault=function(){this.min.toDefault(),this.max.toDefault()},e.cloneTo=function(t){var e=t;this.min.cloneTo(e.min),this.max.cloneTo(e.max)},e.clone=function(){var t=new this.constructor(new Vector3,new Vector3);return this.cloneTo(t),t},t.createfromPoints=function(t,e){if(null==t)throw new Error("points");var n=e.min,i=e.max,r=n.elements;r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE;var a=i.elements;a[0]=-Number.MAX_VALUE,a[1]=-Number.MAX_VALUE,a[2]=-Number.MAX_VALUE;for(var s=0,o=t.length;s<o;++s)Vector3.min(n,t[s],n),Vector3.max(i,t[s],i)},t.merge=function(t,e,n){Vector3.min(t.min,e.min,n.min),Vector3.max(t.max,e.max,n.max)},t}(),Matrix4x4=function(){function t(t,e,n,i,r,a,s,o,l,h,_,u,c,d,f,m){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===l&&(l=0),void 0===h&&(h=0),void 0===_&&(_=1),void 0===u&&(u=0),void 0===c&&(c=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=t,p[1]=e,p[2]=n,p[3]=i,p[4]=r,p[5]=a,p[6]=s,p[7]=o,p[8]=l,p[9]=h,p[10]=_,p[11]=u,p[12]=c,p[13]=d,p[14]=f,p[15]=m}__class(t,"laya.d3.math.Matrix4x4");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.getElementByRowColumn=function(t,e){if(t<0||t>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*t+e]},e.setElementByRowColumn=function(t,e,n){if(t<0||t>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*t+e]=n},e.equalsOtherMatrix=function(t){var e=this.elements,n=t.elements;return MathUtils3D.nearEqual(e[0],n[0])&&MathUtils3D.nearEqual(e[1],n[1])&&MathUtils3D.nearEqual(e[2],n[2])&&MathUtils3D.nearEqual(e[3],n[3])&&MathUtils3D.nearEqual(e[4],n[4])&&MathUtils3D.nearEqual(e[5],n[5])&&MathUtils3D.nearEqual(e[6],n[6])&&MathUtils3D.nearEqual(e[7],n[7])&&MathUtils3D.nearEqual(e[8],n[8])&&MathUtils3D.nearEqual(e[9],n[9])&&MathUtils3D.nearEqual(e[10],n[10])&&MathUtils3D.nearEqual(e[11],n[11])&&MathUtils3D.nearEqual(e[12],n[12])&&MathUtils3D.nearEqual(e[13],n[13])&&MathUtils3D.nearEqual(e[14],n[14])&&MathUtils3D.nearEqual(e[15],n[15])},e.decomposeTransRotScale=function(e,n,i){var r=t._tempMatrix4x4;return this.decomposeTransRotMatScale(e,r,i)?(Quaternion.createFromMatrix4x4(r,n),!0):(n.identity(),!1)},e.decomposeTransRotMatScale=function(e,n,i){var r=this.elements,a=e.elements,s=n.elements,o=i.elements;a[0]=r[12],a[1]=r[13],a[2]=r[14];var l=r[0],h=r[1],_=r[2],u=r[4],c=r[5],d=r[6],f=r[8],m=r[9],p=r[10],g=o[0]=Math.sqrt(l*l+h*h+_*_),v=o[1]=Math.sqrt(u*u+c*c+d*d),x=o[2]=Math.sqrt(f*f+m*m+p*p);if(MathUtils3D.isZero(g)||MathUtils3D.isZero(v)||MathUtils3D.isZero(x))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var S=t._tempVector0,T=S.elements;T[0]=f/x,T[1]=m/x,T[2]=p/x;var E=t._tempVector1,y=E.elements;y[0]=l/g,y[1]=h/g,y[2]=_/g;var M=t._tempVector2;Vector3.cross(S,E,M);var D=t._tempVector1;return Vector3.cross(M,S,D),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=D.x,s[1]=D.y,s[2]=D.z,s[4]=M.x,s[5]=M.y,s[6]=M.z,s[8]=S.x,s[9]=S.y,s[10]=S.z,s[0]*l+s[1]*h+s[2]*_<0&&(o[0]=-g),s[4]*u+s[5]*c+s[6]*d<0&&(o[1]=-v),s[8]*f+s[9]*m+s[10]*p<0&&(o[2]=-x),!0},e.decomposeYawPitchRoll=function(t){var e=t.elements,n=Math.asin(-this.elements[9]);e[1]=n,Math.cos(n)>MathUtils3D.zeroTolerance?(e[2]=Math.atan2(this.elements[1],this.elements[5]),e[0]=Math.atan2(this.elements[8],this.elements[10])):(e[2]=Math.atan2(-this.elements[4],this.elements[0]),e[0]=0)},e.normalize=function(){var t=this.elements,e=t[0],n=t[1],i=t[2],r=Math.sqrt(e*e+n*n+i*i);if(!r)return t[0]=0,t[1]=0,void(t[2]=0);1!=r&&(r=1/r,t[0]=e*r,t[1]=n*r,t[2]=i*r)},e.transpose=function(){var t,e;return t=this.elements,e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},e.invert=function(t){var e=this.elements,n=t.elements,i=e[0],r=e[1],a=e[2],s=e[3],o=e[4],l=e[5],h=e[6],_=e[7],u=e[8],c=e[9],d=e[10],f=e[11],m=e[12],p=e[13],g=e[14],v=e[15],x=i*l-r*o,S=i*h-a*o,T=i*_-s*o,E=r*h-a*l,y=r*_-s*l,M=a*_-s*h,D=u*p-c*m,C=u*g-d*m,R=u*v-f*m,A=c*g-d*p,b=c*v-f*p,I=d*v-f*g,w=x*I-S*b+T*A+E*R-y*C+M*D;0!==Math.abs(w)&&(w=1/w,n[0]=(l*I-h*b+_*A)*w,n[1]=(a*b-r*I-s*A)*w,n[2]=(p*M-g*y+v*E)*w,n[3]=(d*y-c*M-f*E)*w,n[4]=(h*R-o*I-_*C)*w,n[5]=(i*I-a*R+s*C)*w,n[6]=(g*T-m*M-v*S)*w,n[7]=(u*M-d*T+f*S)*w,n[8]=(o*b-l*R+_*D)*w,n[9]=(r*R-i*b-s*D)*w,n[10]=(m*y-p*T+v*x)*w,n[11]=(c*T-u*y-f*x)*w,n[12]=(l*C-o*A-h*D)*w,n[13]=(i*A-r*C+a*D)*w,n[14]=(p*S-m*E-g*x)*w,n[15]=(u*E-c*S+d*x)*w)},e.identity=function(){var t=this.elements;t[1]=t[2]=t[3]=t[4]=t[6]=t[7]=t[8]=t[9]=t[11]=t[12]=t[13]=t[14]=0,t[0]=t[5]=t[10]=t[15]=1},e.cloneTo=function(t){var e,n,i;if(n=this.elements,i=t.elements,n!==i)for(e=0;e<16;++e)i[e]=n[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.getTranslationVector=function(t){var e=this.elements,n=t.elements;n[0]=e[12],n[1]=e[13],n[2]=e[14]},e.setTranslationVector=function(t){var e=this.elements,n=t.elements;e[12]=n[0],e[13]=n[1],e[14]=n[2]},e.getForward=function(t){var e=this.elements,n=t.elements;n[0]=-e[8],n[1]=-e[9],n[2]=-e[10]},e.setForward=function(t){var e=this.elements,n=t.elements;e[8]=-n[0],e[9]=-n[1],e[10]=-n[2]},t.createRotationX=function(t,e){var n=e.elements,i=Math.sin(t),r=Math.cos(t);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=r,n[6]=i,n[9]=-i},t.createRotationY=function(t,e){var n=e.elements,i=Math.sin(t),r=Math.cos(t);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=r,n[2]=-i,n[8]=i},t.createRotationZ=function(t,e){var n=e.elements,i=Math.sin(t),r=Math.cos(t);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=r,n[1]=i,n[4]=-i},t.createRotationYawPitchRoll=function(e,n,i,r){Quaternion.createFromYawPitchRoll(e,n,i,t._tempQuaternion),t.createRotationQuaternion(t._tempQuaternion,r)},t.createRotationAxis=function(t,e,n){var i=t.elements,r=i[0],a=i[1],s=i[2],o=Math.cos(e),l=Math.sin(e),h=r*r,_=a*a,u=s*s,c=r*a,d=r*s,f=a*s,m=n.elements;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=h+o*(1-h),m[1]=c-o*c+l*s,m[2]=d-o*d-l*a,m[4]=c-o*c-l*s,m[5]=_+o*(1-_),m[6]=f-o*f+l*r,m[8]=d-o*d+l*a,m[9]=f-o*f-l*r,m[10]=u+o*(1-u)},t.createRotationQuaternion=function(t,e){var n=t.elements,i=e.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=r*r,h=a*a,_=s*s,u=r*a,c=s*o,d=s*r,f=a*o,m=a*s,p=r*o;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(h+_),i[1]=2*(u+c),i[2]=2*(d-f),i[4]=2*(u-c),i[5]=1-2*(_+l),i[6]=2*(m+p),i[8]=2*(d+f),i[9]=2*(m-p),i[10]=1-2*(h+l)},t.createTranslate=function(t,e){var n=t.elements,i=e.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},t.createScaling=function(t,e){var n=t.elements,i=e.elements;i[0]=n[0],i[5]=n[1],i[10]=n[2],i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1},t.multiply=function(t,e,n){var i,r,a,s,o,l,h,_;if(r=n.elements,a=t.elements,s=e.elements,r===s)for(s=new Float32Array(16),i=0;i<16;++i)s[i]=r[i];for(i=0;i<4;i++)o=a[i],l=a[i+4],h=a[i+8],_=a[i+12],r[i]=o*s[0]+l*s[1]+h*s[2]+_*s[3],r[i+4]=o*s[4]+l*s[5]+h*s[6]+_*s[7],r[i+8]=o*s[8]+l*s[9]+h*s[10]+_*s[11],r[i+12]=o*s[12]+l*s[13]+h*s[14]+_*s[15]},t.createFromQuaternion=function(t,e){var n=e.elements,i=t.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=r+r,h=a+a,_=s+s,u=r*l,c=a*l,d=a*h,f=s*l,m=s*h,p=s*_,g=o*l,v=o*h,x=o*_;n[0]=1-d-p,n[1]=c+x,n[2]=f-v,n[3]=0,n[4]=c-x,n[5]=1-u-p,n[6]=m+g,n[7]=0,n[8]=f+v,n[9]=m-g,n[10]=1-u-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},t.createAffineTransformation=function(t,e,n,i){var r=t.elements,a=e.elements,s=n.elements,o=i.elements,l=a[0],h=a[1],_=a[2],u=a[3],c=l+l,d=h+h,f=_+_,m=l*c,p=l*d,g=l*f,v=h*d,x=h*f,S=_*f,T=u*c,E=u*d,y=u*f,M=s[0],D=s[1],C=s[2];o[0]=(1-(v+S))*M,o[1]=(p+y)*M,o[2]=(g-E)*M,o[3]=0,o[4]=(p-y)*D,o[5]=(1-(m+S))*D,o[6]=(x+T)*D,o[7]=0,o[8]=(g+E)*C,o[9]=(x-T)*C,o[10]=(1-(m+v))*C,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},t.createLookAt=function(e,n,i,r){var a=r.elements,s=t._tempVector0,o=t._tempVector1,l=t._tempVector2;Vector3.subtract(e,n,l),Vector3.normalize(l,l),Vector3.cross(i,l,s),Vector3.normalize(s,s),Vector3.cross(l,s,o),r.identity(),a[0]=s.x,a[4]=s.y,a[8]=s.z,a[1]=o.x,a[5]=o.y,a[9]=o.z,a[2]=l.x,a[6]=l.y,a[10]=l.z,a[12]=-Vector3.dot(s,e),a[13]=-Vector3.dot(o,e),a[14]=-Vector3.dot(l,e)},t.createPerspective=function(t,e,n,i,r){var a=r.elements,s=1/Math.tan(t/2),o=1/(n-i);a[0]=s/e,a[5]=s,a[10]=(i+n)*o,a[11]=-1,a[14]=2*i*n*o,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},t.createOrthoOffCenterRH=function(t,e,n,i,r,a,s){var o=s.elements,l=1/(t-e),h=1/(n-i),_=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*l,o[5]=-2*h,o[10]=2*_,o[12]=(t+e)*l,o[13]=(i+n)*h,o[14]=(a+r)*_},t.translation=function(t,e){var n=t.elements,i=e.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=n[0],i[13]=n[1],i[14]=n[2]},__static(t,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new t},"_tempVector0",function(){return this._tempVector0=new Vector3},"_tempVector1",function(){return this._tempVector1=new Vector3},"_tempVector2",function(){return this._tempVector2=new Vector3},"_tempQuaternion",function(){return this._tempQuaternion=new Quaternion},"NAN",function(){return this.NAN=new t(NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN)},"DEFAULT",function(){return this.DEFAULT=new t},"ZERO",function(){return this.ZERO=new t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}]),t}(),Ray=function(){function t(t,e){this.origin=null,this.direction=null,this.origin=t,this.direction=e}return __class(t,"laya.d3.math.Ray"),t}(),Collision=function(){function t(){}return __class(t,"laya.d3.math.Collision"),t.distancePlaneToPoint=function(t,e){return Vector3.dot(t.normal,e)-t.distance},t.distanceBoxToPoint=function(t,e){var n=t.min.elements,i=n[0],r=n[1],a=n[2],s=t.max.elements,o=s[0],l=s[1],h=s[2],_=e.elements,u=_[0],c=_[1],d=_[2],f=0;return u<i&&(f+=(i-u)*(i-u)),u>o&&(f+=(o-u)*(o-u)),c<r&&(f+=(r-c)*(r-c)),c>l&&(f+=(l-c)*(l-c)),d<a&&(f+=(a-d)*(a-d)),d>h&&(f+=(h-d)*(h-d)),Math.sqrt(f)},t.distanceBoxToBox=function(t,e){var n=t.min.elements,i=n[0],r=n[1],a=n[2],s=t.max.elements,o=s[0],l=s[1],h=s[2],_=e.min.elements,u=_[0],c=_[1],d=_[2],f=e.max.elements,m=f[0],p=f[1],g=f[2],v=0,x=NaN;return i>m?(x=i-m,v+=x*x):u>o&&(x=u-o,v+=x*x),r>p?(x=r-p,v+=x*x):c>l&&(x=c-l,v+=x*x),a>g?(x=a-g,v+=x*x):d>h&&(x=d-h,v+=x*x),Math.sqrt(v)},t.distanceSphereToPoint=function(t,e){var n=Math.sqrt(Vector3.distanceSquared(t.center,e));return n-=t.radius,Math.max(n,0)},t.distanceSphereToSphere=function(t,e){var n=Math.sqrt(Vector3.distanceSquared(t.center,e.center));return n-=t.radius+e.radius,Math.max(n,0)},t.intersectsRayAndTriangleRD=function(e,n,i,r,a){var s=e.origin,o=s.elements,l=o[0],h=o[1],_=o[2],u=e.direction,c=u.elements,d=c[0],f=c[1],m=c[2],p=n.elements,g=p[0],v=p[1],x=p[2],S=i.elements,T=S[0],E=S[1],y=S[2],M=r.elements,D=M[0],C=M[1],R=M[2],A=t._tempV30.elements,b=A[0],I=A[1],w=A[2];b=T-g,I=E-v,w=y-x;var V=t._tempV31.elements,L=V[0],P=V[1],N=V[2];L=D-g,P=C-v,N=R-x;var O=t._tempV32.elements,F=O[0],B=O[1],U=O[2];F=f*N-m*P,B=m*L-d*N,U=d*P-f*L;var G=b*F+I*B+w*U;if(MathUtils3D.isZero(G))return 0,!1;var H=1/G,W=t._tempV33.elements,k=W[0],z=W[1],X=W[2];k=l-g,z=h-v,X=_-x;var Y=k*F+z*B+X*U;if((Y*=H)<0||Y>1)return 0,!1;var K=t._tempV34.elements,Z=K[0],j=K[1],q=K[2];Z=z*w-X*I,j=X*b-k*w,q=k*I-z*b;var Q=d*Z+f*j+m*q;if((Q*=H)<0||Y+Q>1)return 0,!1;var $=L*Z+P*j+N*q;return($*=H)<0?(0,!1):($,!0)},t.intersectsRayAndTriangleRP=function(e,n,i,r,a){return t.intersectsRayAndTriangleRD(e,n,i,r,NaN)?(Vector3.scale(e.direction,NaN,t._tempV30),Vector3.add(e.origin,t._tempV30,a),!0):(a=Vector3.ZERO,!1)},t.intersectsRayAndPoint=function(e,n){Vector3.subtract(e.origin,n,t._tempV30);var i=Vector3.dot(t._tempV30,e.direction),r=Vector3.dot(t._tempV30,t._tempV30)-MathUtils3D.zeroTolerance;return!(r>0&&i>0)&&!(i*i-r<0)},t.intersectsRayAndRay=function(e,n,i){var r=e.origin,a=r.elements,s=a[0],o=a[1],l=a[2],h=e.direction,_=h.elements,u=_[0],c=_[1],d=_[2],f=n.origin,m=f.elements,p=m[0],g=m[1],v=m[2],x=n.direction,S=x.elements,T=S[0],E=S[1],y=S[2];Vector3.cross(h,x,t._tempV30);var M=t._tempV30.elements,D=Vector3.scalarLength(t._tempV30);if(MathUtils3D.isZero(D)&&MathUtils3D.nearEqual(p,s)&&MathUtils3D.nearEqual(g,o)&&MathUtils3D.nearEqual(v,l))return Vector3.ZERO,!0;D*=D;var C=p-s,R=g-o,A=v-l,b=T,I=E,w=y,V=M[0],L=M[1],P=M[2],N=C*I*P+R*w*V+A*b*L-C*w*L-R*b*P-A*I*V;b=u,I=c,w=d;var O=N/D;Vector3.scale(h,O,t._tempV30),Vector3.scale(x,O,t._tempV31),Vector3.add(r,t._tempV30,t._tempV32),Vector3.add(f,t._tempV31,t._tempV33);var F=t._tempV32.elements,B=t._tempV33.elements;return MathUtils3D.nearEqual(B[0],F[0])&&MathUtils3D.nearEqual(B[1],F[1])&&MathUtils3D.nearEqual(B[2],F[2])?(t._tempV32,!0):(Vector3.ZERO,!1)},t.intersectsPlaneAndTriangle=function(e,n,i,r){var a=t.intersectsPlaneAndPoint(e,n),s=t.intersectsPlaneAndPoint(e,i),o=t.intersectsPlaneAndPoint(e,r);return a==Plane.PlaneIntersectionType_Front&&s==Plane.PlaneIntersectionType_Front&&o==Plane.PlaneIntersectionType_Front?Plane.PlaneIntersectionType_Front:a==Plane.PlaneIntersectionType_Back&&s==Plane.PlaneIntersectionType_Back&&o==Plane.PlaneIntersectionType_Back?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},t.intersectsRayAndPlaneRD=function(t,e,n){var i=e.normal,r=Vector3.dot(i,t.direction);if(MathUtils3D.isZero(r))return 0,!1;var a=Vector3.dot(i,t.origin);return!((-e.distance-a)/r<0)||(0,!1)},t.intersectsRayAndPlaneRP=function(e,n,i){return t.intersectsRayAndPlaneRD(e,n,NaN)?(Vector3.scale(e.direction,NaN,t._tempV30),Vector3.add(e.origin,t._tempV30,t._tempV31),t._tempV31,!0):(Vector3.ZERO,!1)},t.intersectsRayAndBoxRD=function(t,e){var n=t.origin.elements,i=n[0],r=n[1],a=n[2],s=t.direction.elements,o=s[0],l=s[1],h=s[2],_=e.min.elements,u=_[0],c=_[1],d=_[2],f=e.max.elements,m=f[0],p=f[1],g=f[2],v=0,x=MathUtils3D.MaxValue;if(MathUtils3D.isZero(o)){if(i<u||i>m)return-1}else{var S=1/o,T=(u-i)*S,E=(m-i)*S;if(T>E){var y=T;T=E,E=y}if(v=Math.max(T,v),x=Math.min(E,x),v>x)return-1}if(MathUtils3D.isZero(l)){if(r<c||r>p)return-1}else{var M=1/l,D=(c-r)*M,C=(p-r)*M;if(D>C){var R=D;D=C,C=R}if(v=Math.max(D,v),x=Math.min(C,x),v>x)return-1}if(MathUtils3D.isZero(h)){if(a<d||a>g)return-1}else{var A=1/h,b=(d-a)*A,I=(g-a)*A;if(b>I){var w=b;b=I,I=w}if(v=Math.max(b,v),x=Math.min(I,x),v>x)return-1}return v},t.intersectsRayAndBoxRP=function(e,n,i){var r=t.intersectsRayAndBoxRD(e,n);return-1===r?(Vector3.ZERO.cloneTo(i),r):(Vector3.scale(e.direction,r,t._tempV30),Vector3.add(e.origin,t._tempV30,t._tempV31),t._tempV31.cloneTo(i),r)},t.intersectsRayAndSphereRD=function(e,n){var i=n.radius;Vector3.subtract(e.origin,n.center,t._tempV30);var r=Vector3.dot(t._tempV30,e.direction),a=Vector3.dot(t._tempV30,t._tempV30)-i*i;if(a>0&&r>0)return-1;var s=r*r-a;if(s<0)return-1;var o=-r-Math.sqrt(s);return o<0&&(o=0),o},t.intersectsRayAndSphereRP=function(e,n,i){var r=t.intersectsRayAndSphereRD(e,n);return-1===r?(Vector3.ZERO.cloneTo(i),r):(Vector3.scale(e.direction,r,t._tempV30),Vector3.add(e.origin,t._tempV30,t._tempV31),t._tempV31.cloneTo(i),r)},t.intersectsSphereAndTriangle=function(e,n,i,r){var a=e.center,s=e.radius;return t.closestPointPointTriangle(a,n,i,r,t._tempV30),Vector3.subtract(t._tempV30,a,t._tempV31),Vector3.dot(t._tempV31,t._tempV31)<=s*s},t.intersectsPlaneAndPoint=function(t,e){var n=Vector3.dot(t.normal,e)+t.distance;return n>0?Plane.PlaneIntersectionType_Front:n<0?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},t.intersectsPlaneAndPlane=function(e,n){Vector3.cross(e.normal,n.normal,t._tempV30);var i=Vector3.dot(t._tempV30,t._tempV30);return!MathUtils3D.isZero(i)},t.intersectsPlaneAndPlaneRL=function(e,n,i){var r=e.normal,a=n.normal;Vector3.cross(r,a,t._tempV34);var s=Vector3.dot(t._tempV34,t._tempV34);return!MathUtils3D.isZero(s)&&(Vector3.scale(a,e.distance,t._tempV30),Vector3.scale(r,n.distance,t._tempV31),Vector3.subtract(t._tempV30,t._tempV31,t._tempV32),Vector3.cross(t._tempV32,t._tempV34,t._tempV33),Vector3.normalize(t._tempV34,t._tempV34),new Ray(t._tempV33,t._tempV34),!0)},t.intersectsPlaneAndBox=function(e,n){var i=e.distance,r=e.normal,a=r.elements,s=a[0],o=a[1],l=a[2],h=n.min.elements,_=h[0],u=h[1],c=h[2],d=n.max.elements,f=d[0],m=d[1],p=d[2];t._tempV30.elements[0]=s>0?_:f,t._tempV30.elements[1]=o>0?u:m,t._tempV30.elements[2]=l>0?c:p,t._tempV31.elements[0]=s>0?f:_,t._tempV31.elements[1]=o>0?m:u,t._tempV31.elements[2]=l>0?p:c;var g=Vector3.dot(r,t._tempV30);return g+i>0?Plane.PlaneIntersectionType_Front:(g=Vector3.dot(r,t._tempV31),g+i<0?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting)},t.intersectsPlaneAndSphere=function(t,e){var n=e.radius,i=Vector3.dot(t.normal,e.center)+t.distance;return i>n?Plane.PlaneIntersectionType_Front:i<-n?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},t.intersectsBoxAndBox=function(t,e){var n=t.min.elements,i=t.max.elements,r=e.min.elements,a=e.max.elements;return!(n[0]>a[0]||r[0]>i[0])&&(!(n[1]>a[1]||r[1]>i[1])&&!(n[2]>a[2]||r[2]>i[2]))},t.intersectsBoxAndSphere=function(e,n){var i=n.center,r=n.radius;return Vector3.Clamp(i,e.min,e.max,t._tempV30),Vector3.distanceSquared(i,t._tempV30)<=r*r},t.intersectsSphereAndSphere=function(t,e){var n=t.radius+e.radius;return Vector3.distanceSquared(t.center,e.center)<=n*n},t.boxContainsPoint=function(t,e){var n=t.min.elements,i=t.max.elements,r=e.elements;return n[0]<=r[0]&&i[0]>=r[0]&&n[1]<=r[1]&&i[1]>=r[1]&&n[2]<=r[2]&&i[2]>=r[2]?1:0},t.boxContainsBox=function(t,e){var n=t.min.elements,i=n[0],r=n[1],a=n[2],s=t.max.elements,o=s[0],l=s[1],h=s[2],_=e.min.elements,u=_[0],c=_[1],d=_[2],f=e.max.elements,m=f[0],p=f[1],g=f[2];return o<u||i>m?0:l<c||r>p?0:h<d||a>g?0:i<=u&&m<=m&&r<=c&&p<=l&&a<=d&&g<=h?1:2},t.boxContainsSphere=function(e,n){var i=e.min,r=i.elements,a=r[0],s=r[1],o=r[2],l=e.max,h=l.elements,_=h[0],u=h[1],c=h[2],d=n.center,f=d.elements,m=f[0],p=f[1],g=f[2],v=n.radius;return Vector3.Clamp(d,i,l,t._tempV30),Vector3.distanceSquared(d,t._tempV30)>v*v?0:a+v<=m&&m<=_-v&&_-a>v&&s+v<=p&&p<=u-v&&u-s>v&&o+v<=g&&g<=c-v&&c-o>v?1:2},t.sphereContainsPoint=function(t,e){return Vector3.distanceSquared(e,t.center)<=t.radius*t.radius?1:0},t.sphereContainsTriangle=function(e,n,i,r){var a=t.sphereContainsPoint(e,n),s=t.sphereContainsPoint(e,i),o=t.sphereContainsPoint(e,r);return 1==a&&1==s&&1==o?1:t.intersectsSphereAndTriangle(e,n,i,r)?2:0},t.sphereContainsBox=function(e,n){var i=e.center,r=i.elements,a=r[0],s=r[1],o=r[2],l=e.radius,h=n.min,_=h.elements,u=_[0],c=_[1],d=_[2],f=n.max,m=f.elements,p=m[0],g=m[1],v=m[2],x=t._tempV30.elements;x[0],x[1],x[2];if(!t.intersectsBoxAndSphere(n,e))return 0;var S=l*l;return a-u,s-g,o-v,Vector3.scalarLengthSquared(t._tempV30)>S?2:(a-p,s-g,o-v,Vector3.scalarLengthSquared(t._tempV30)>S?2:(a-p,s-c,o-v,Vector3.scalarLengthSquared(t._tempV30)>S?2:(a-u,s-c,o-v,Vector3.scalarLengthSquared(t._tempV30)>S?2:(a-u,s-g,o-d,Vector3.scalarLengthSquared(t._tempV30)>S?2:(a-p,s-g,o-d,Vector3.scalarLengthSquared(t._tempV30)>S?2:(a-p,s-c,o-d,Vector3.scalarLengthSquared(t._tempV30)>S?2:(a-u,s-c,o-d,Vector3.scalarLengthSquared(t._tempV30)>S?2:1)))))))},t.sphereContainsSphere=function(t,e){var n=t.radius,i=e.radius,r=Vector3.distance(t.center,e.center);return n+i<r?0:n-i<r?2:1},t.closestPointPointTriangle=function(e,n,i,r,a){Vector3.subtract(i,n,t._tempV30),Vector3.subtract(r,n,t._tempV31),Vector3.subtract(e,n,t._tempV32),Vector3.subtract(e,i,t._tempV33),Vector3.subtract(e,r,t._tempV34);var s=Vector3.dot(t._tempV30,t._tempV32),o=Vector3.dot(t._tempV31,t._tempV32),l=Vector3.dot(t._tempV30,t._tempV33),h=Vector3.dot(t._tempV31,t._tempV33),_=Vector3.dot(t._tempV30,t._tempV34),u=Vector3.dot(t._tempV31,t._tempV34);if(s<=0&&o<=0)return void n.cloneTo(a);if(l>=0&&h<=l)return void i.cloneTo(a);var c=s*h-l*o;if(c<=0&&s>=0&&l<=0){var d=s/(s-l);return Vector3.scale(t._tempV30,d,a),void Vector3.add(n,a,a)}if(u>=0&&_<=u)return void r.cloneTo(a);var f=_*o-s*u;if(f<=0&&o>=0&&u<=0){var m=o/(o-u);return Vector3.scale(t._tempV31,m,a),void Vector3.add(n,a,a)}var p=l*u-_*h;if(p<=0&&h-l>=0&&_-u>=0){var g=(h-l)/(h-l+(_-u));return Vector3.subtract(r,i,a),Vector3.scale(a,g,a),void Vector3.add(i,a,a)}var v=1/(p+f+c),x=f*v,S=c*v;Vector3.scale(t._tempV30,x,t._tempV35),Vector3.scale(t._tempV31,S,t._tempV36),Vector3.add(t._tempV35,t._tempV36,a),Vector3.add(n,a,a)},t.closestPointPlanePoint=function(e,n,i){var r=e.normal,a=Vector3.dot(r,n)-e.distance;Vector3.scale(r,a,t._tempV30),Vector3.subtract(n,t._tempV30,i)},t.closestPointBoxPoint=function(e,n,i){Vector3.max(n,e.min,t._tempV30),Vector3.min(t._tempV30,e.max,i)},t.closestPointSpherePoint=function(t,e,n){var i=t.center;Vector3.subtract(e,i,n),Vector3.normalize(n,n),Vector3.scale(n,t.radius,n),Vector3.add(n,i,n)},t.closestPointSphereSphere=function(t,e,n){var i=t.center;Vector3.subtract(e.center,i,n),Vector3.normalize(n,n),Vector3.scale(n,t.radius,n),Vector3.add(n,i,n)},__static(t,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3}]),t}(),BoundFrustum=function(){function t(e){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=e,this._near=new Plane(new Vector3),this._far=new Plane(new Vector3),this._left=new Plane(new Vector3),this._right=new Plane(new Vector3),this._top=new Plane(new Vector3),this._bottom=new Plane(new Vector3),t._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}__class(t,"laya.d3.math.BoundFrustum");var e=t.prototype;return e.equalsBoundFrustum=function(t){return this._matrix.equalsOtherMatrix(t.matrix)},e.equalsObj=function(t){if(t instanceof laya.d3.math.BoundFrustum){var e=t;return this.equalsBoundFrustum(e)}return!1},e.getPlane=function(t){switch(t){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},e.getCorners=function(e){t._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(e[0]),t._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(e[1]),t._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(e[2]),t._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(e[3]),t._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(e[4]),t._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(e[5]),t._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(e[6]),t._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(e[7])},e.containsPoint=function(t){for(var e=Plane.PlaneIntersectionType_Front,n=Plane.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Collision.intersectsPlaneAndPoint(this._near,t);break;case 1:n=Collision.intersectsPlaneAndPoint(this._far,t);break;case 2:n=Collision.intersectsPlaneAndPoint(this._left,t);break;case 3:n=Collision.intersectsPlaneAndPoint(this._right,t);break;case 4:n=Collision.intersectsPlaneAndPoint(this._top,t);break;case 5:n=Collision.intersectsPlaneAndPoint(this._bottom,t)}switch(n){case Plane.PlaneIntersectionType_Back:return 0;case Plane.PlaneIntersectionType_Intersecting:e=Plane.PlaneIntersectionType_Intersecting}}switch(e){case Plane.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e.containsBoundBox=function(e){for(var n,i=t._tempV30,r=t._tempV31,a=1,s=0;s<6;s++){if(n=this.getPlane(s),this._getBoxToPlanePVertexNVertex(e,n.normal,i,r),Collision.intersectsPlaneAndPoint(n,i)===Plane.PlaneIntersectionType_Back)return 0;Collision.intersectsPlaneAndPoint(n,r)===Plane.PlaneIntersectionType_Back&&(a=2)}return a},e.containsBoundSphere=function(t){for(var e=Plane.PlaneIntersectionType_Front,n=Plane.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Collision.intersectsPlaneAndSphere(this._near,t);break;case 1:n=Collision.intersectsPlaneAndSphere(this._far,t);break;case 2:n=Collision.intersectsPlaneAndSphere(this._left,t);break;case 3:n=Collision.intersectsPlaneAndSphere(this._right,t);break;case 4:n=Collision.intersectsPlaneAndSphere(this._top,t);break;case 5:n=Collision.intersectsPlaneAndSphere(this._bottom,t)}switch(n){case Plane.PlaneIntersectionType_Back:return 0;case Plane.PlaneIntersectionType_Intersecting:e=Plane.PlaneIntersectionType_Intersecting}}switch(e){case Plane.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e._getBoxToPlanePVertexNVertex=function(t,e,n,i){var r=t.min,a=r.elements,s=t.max,o=s.elements,l=e.elements,h=l[0],_=l[1],u=l[2];r.cloneTo(n);var c=n.elements;h>=0&&(c[0]=o[0]),_>=0&&(c[1]=o[1]),u>=0&&(c[2]=o[2]),s.cloneTo(i);var d=i.elements;h>=0&&(d[0]=a[0]),_>=0&&(d[1]=a[1]),u>=0&&(d[2]=a[2])},__getset(0,e,"bottom",function(){return this._bottom}),__getset(0,e,"top",function(){return this._top}),__getset(0,e,"left",function(){return this._left}),__getset(0,e,"far",function(){return this._far}),__getset(0,e,"near",function(){return this._near}),__getset(0,e,"right",function(){return this._right}),__getset(0,e,"matrix",function(){return this._matrix},function(e){this._matrix=e,t._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),t._getPlanesFromMatrix=function(t,e,n,i,r,a,s){var o=t.elements,l=o[0],h=o[1],_=o[2],u=o[3],c=o[4],d=o[5],f=o[6],m=o[7],p=o[8],g=o[9],v=o[10],x=o[11],S=o[12],T=o[13],E=o[14],y=o[15],M=e.normal.elements;M[0]=u+_,M[1]=m+f,M[2]=x+v,e.distance=y+E,e.normalize();var D=n.normal.elements;D[0]=u-_,D[1]=m-f,D[2]=x-v,n.distance=y-E,n.normalize();var C=i.normal.elements;C[0]=u+l,C[1]=m+c,C[2]=x+p,i.distance=y+S,i.normalize();var R=r.normal.elements;R[0]=u-l,R[1]=m-c,R[2]=x-p,r.distance=y-S,r.normalize();var A=a.normal.elements;A[0]=u-h,A[1]=m-d,A[2]=x-g,a.distance=y-T,a.normalize();var b=s.normal.elements;b[0]=u+h,b[1]=m+d,b[2]=x+g,s.distance=y+T,s.normalize()},t._get3PlaneInterPoint=function(e,n,i){var r=e.normal,a=n.normal,s=i.normal;Vector3.cross(a,s,t._tempV30),Vector3.cross(s,r,t._tempV31),Vector3.cross(r,a,t._tempV32);var o=Vector3.dot(r,t._tempV30),l=Vector3.dot(a,t._tempV31),h=Vector3.dot(s,t._tempV32);return Vector3.scale(t._tempV30,-e.distance/o,t._tempV33),Vector3.scale(t._tempV31,-n.distance/l,t._tempV34),Vector3.scale(t._tempV32,-i.distance/h,t._tempV35),Vector3.add(t._tempV33,t._tempV34,t._tempV36),Vector3.add(t._tempV35,t._tempV36,t._tempV37),t._tempV37},__static(t,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3},"_tempV37",function(){return this._tempV37=new Vector3}]),t}(),BoundSphere=function(){function t(t,e){this.center=null,this.radius=NaN,this.center=t,this.radius=e}__class(t,"laya.d3.math.BoundSphere");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.toDefault=function(){this.center.toDefault(),this.radius=0},e.intersectsRayDistance=function(t){return Collision.intersectsRayAndSphereRD(t,this)},e.intersectsRayPoint=function(t,e){return Collision.intersectsRayAndSphereRP(t,this,e)},e.cloneTo=function(t){var e=t;this.center.cloneTo(e.center),e.radius=this.radius},e.clone=function(){var t=new this.constructor(new Vector3,new Vector3);return this.cloneTo(t),t},t.createFromSubPoints=function(e,n,i,r){if(null==e)throw new Error("points");if(n<0||n>=e.length)throw new Error("start"+n+"Must be in the range [0, "+(e.length-1)+"]");if(i<0||n+i>e.length)throw new Error("count"+i+"Must be in the range <= "+e.length+"}");var a=n+i,s=t._tempVector3;s.elements[0]=0,s.elements[1]=0,s.elements[2]=0;for(var o=n;o<a;++o)Vector3.add(e[o],s,s);var l=r.center;Vector3.scale(s,1/i,l);var h=0;for(o=n;o<a;++o){var _=Vector3.distanceSquared(l,e[o]);_>h&&(h=_)}r.radius=Math.sqrt(h)},t.createfromPoints=function(e,n){if(null==e)throw new Error("points");t.createFromSubPoints(e,0,e.length,n)},__static(t,["_tempVector3",function(){return this._tempVector3=new Vector3}]),t}(),Quaternion=function(){function t(t,e,n,i){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this.elements[0]=t,this.elements[1]=e,this.elements[2]=n,this.elements[3]=i}__class(t,"laya.d3.math.Quaternion");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.scaling=function(t,e){var n=e.elements,i=this.elements;n[0]=i[0]*t,n[1]=i[1]*t,n[2]=i[2]*t,n[3]=i[3]*t},e.normalize=function(t){var e=t.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=a*o,e[3]=s*o)},e.length=function(){var t=this.elements,e=t[0],n=t[1],i=t[2],r=t[3];return Math.sqrt(e*e+n*n+i*i+r*r)},e.rotateX=function(t,e){var n=e.elements,i=this.elements;t*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(t),h=Math.cos(t);n[0]=r*h+o*l,n[1]=a*h+s*l,n[2]=s*h-a*l,n[3]=o*h-r*l},e.rotateY=function(t,e){var n=e.elements,i=this.elements;t*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(t),h=Math.cos(t);n[0]=r*h-s*l,n[1]=a*h+o*l,n[2]=s*h+r*l,n[3]=o*h-a*l},e.rotateZ=function(t,e){var n=e.elements,i=this.elements;t*=.5;var r=i[0],a=i[1],s=i[2],o=i[3],l=Math.sin(t),h=Math.cos(t);n[0]=r*h+a*l,n[1]=a*h-r*l,n[2]=s*h+o*l,n[3]=o*h-s*l},e.getYawPitchRoll=function(e){Vector3.transformQuat(Vector3.ForwardRH,this,t.TEMPVector31),Vector3.transformQuat(Vector3.Up,this,t.TEMPVector32);var n=t.TEMPVector32.elements;t.angleTo(Vector3.ZERO,t.TEMPVector31,t.TEMPVector33);var i=t.TEMPVector33.elements;i[0]==Math.PI/2?(i[1]=t.arcTanAngle(n[2],n[0]),i[2]=0):i[0]==-Math.PI/2?(i[1]=t.arcTanAngle(-n[2],-n[0]),i[2]=0):(Matrix4x4.createRotationY(-i[1],t.TEMPMatrix0),Matrix4x4.createRotationX(-i[0],t.TEMPMatrix1),Vector3.transformCoordinate(t.TEMPVector32,t.TEMPMatrix0,t.TEMPVector32),Vector3.transformCoordinate(t.TEMPVector32,t.TEMPMatrix1,t.TEMPVector32),i[2]=t.arcTanAngle(n[1],-n[0])),i[1]<=-Math.PI&&(i[1]=Math.PI),i[2]<=-Math.PI&&(i[2]=Math.PI),i[1]>=Math.PI&&i[2]>=Math.PI&&(i[1]=0,i[2]=0,i[0]=Math.PI-i[0]);var r=e.elements;r[0]=i[1],r[1]=i[0],r[2]=i[2]},e.invert=function(t){var e=t.elements,n=this.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=i*i+r*r+a*a+s*s,l=o?1/o:0;e[0]=-i*l,e[1]=-r*l,e[2]=-a*l,e[3]=s*l},
e.identity=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=1},e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1],this.elements[2]=t[e+2],this.elements[3]=t[e+3]},e.cloneTo=function(t){var e,n,i;if(n=this.elements,i=t.elements,n!==i)for(e=0;e<4;++e)i[e]=n[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.equals=function(t){var e=this.elements,n=t.elements;return MathUtils3D.nearEqual(e[0],n[0])&&MathUtils3D.nearEqual(e[1],n[1])&&MathUtils3D.nearEqual(e[2],n[2])&&MathUtils3D.nearEqual(e[3],n[3])},e.lengthSquared=function(){var t=this.elements[0],e=this.elements[1],n=this.elements[2],i=this.elements[3];return t*t+e*e+n*n+i*i},__getset(0,e,"w",function(){return this.elements[3]}),__getset(0,e,"z",function(){return this.elements[2]}),__getset(0,e,"y",function(){return this.elements[1]}),__getset(0,e,"x",function(){return this.elements[0]}),t.createFromYawPitchRoll=function(t,e,n,i){var r=.5*n,a=.5*e,s=.5*t,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),_=Math.cos(a),u=Math.sin(s),c=Math.cos(s),d=i.elements;d[0]=c*h*l+u*_*o,d[1]=u*_*l-c*h*o,d[2]=c*_*o-u*h*l,d[3]=c*_*l+u*h*o},t.multiply=function(t,e,n){var i=t.elements,r=e.elements,a=n.elements,s=i[0],o=i[1],l=i[2],h=i[3],_=r[0],u=r[1],c=r[2],d=r[3],f=o*c-l*u,m=l*_-s*c,p=s*u-o*_,g=s*_+o*u+l*c;a[0]=s*d+_*h+f,a[1]=o*d+u*h+m,a[2]=l*d+c*h+p,a[3]=h*d-g},t.arcTanAngle=function(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):t<0?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0},t.angleTo=function(e,n,i){Vector3.subtract(n,e,t.TEMPVector30),Vector3.normalize(t.TEMPVector30,t.TEMPVector30),i.elements[0]=Math.asin(t.TEMPVector30.y),i.elements[1]=t.arcTanAngle(-t.TEMPVector30.z,-t.TEMPVector30.x)},t.createFromAxisAngle=function(t,e,n){var i=n.elements,r=t.elements;e*=.5;var a=Math.sin(e);i[0]=a*r[0],i[1]=a*r[1],i[2]=a*r[2],i[3]=Math.cos(e)},t.createFromMatrix3x3=function(t,e){var n,i=e.elements,r=t.elements,a=r[0]+r[4]+r[8];if(a>0)n=Math.sqrt(a+1),i[3]=.5*n,n=.5/n,i[0]=(r[5]-r[7])*n,i[1]=(r[6]-r[2])*n,i[2]=(r[1]-r[3])*n;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,l=(s+2)%3;n=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*l+l]+1),i[s]=.5*n,n=.5/n,i[3]=(r[3*o+l]-r[3*l+o])*n,i[o]=(r[3*o+s]+r[3*s+o])*n,i[l]=(r[3*l+s]+r[3*s+l])*n}},t.createFromMatrix4x4=function(t,e){var n,i,r=t.elements,a=e.elements,s=r[0]+r[5]+r[10];s>0?(n=Math.sqrt(s+1),a[3]=.5*n,n=.5/n,a[0]=(r[6]-r[9])*n,a[1]=(r[8]-r[2])*n,a[2]=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(n=Math.sqrt(1+r[0]-r[5]-r[10]),i=.5/n,a[0]=.5*n,a[1]=(r[1]+r[4])*i,a[2]=(r[2]+r[8])*i,a[3]=(r[6]-r[9])*i):r[5]>r[10]?(n=Math.sqrt(1+r[5]-r[0]-r[10]),i=.5/n,a[0]=(r[4]+r[1])*i,a[1]=.5*n,a[2]=(r[9]+r[6])*i,a[3]=(r[8]-r[2])*i):(n=Math.sqrt(1+r[10]-r[0]-r[5]),i=.5/n,a[0]=(r[8]+r[2])*i,a[1]=(r[9]+r[6])*i,a[2]=.5*n,a[3]=(r[1]-r[4])*i)},t.slerp=function(t,e,n,i){var r,a,s,o,l,h=t.elements,_=e.elements,u=i.elements,c=h[0],d=h[1],f=h[2],m=h[3],p=_[0],g=_[1],v=_[2],x=_[3];return a=c*p+d*g+f*v+m*x,a<0&&(a=-a,p=-p,g=-g,v=-v,x=-x),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-n)*r)/s,l=Math.sin(n*r)/s):(o=1-n,l=n),u[0]=o*c+l*p,u[1]=o*d+l*g,u[2]=o*f+l*v,u[3]=o*m+l*x,u},t.lerp=function(t,e,n,i){var r=i.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2],_=a[3];r[0]=o+n*(s[0]-o),r[1]=l+n*(s[1]-l),r[2]=h+n*(s[2]-h),r[3]=_+n*(s[3]-_)},t.add=function(t,e,n){var i=n.elements,r=t.elements,a=e.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]},t.dot=function(t,e){var n=t.elements,i=e.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]},t.rotationLookAt=function(e,n,i){t.lookAt(Vector3.ZERO,e,n,i)},t.lookAt=function(e,n,i,r){Matrix3x3.lookAt(e,n,i,t._tempMatrix3x3),t.rotationMatrix(t._tempMatrix3x3,r)},t.invert=function(t,e){var n=t.elements,i=e.elements,r=t.lengthSquared();MathUtils3D.isZero(r)||(r=1/r,i[0]=-n[0]*r,i[1]=-n[1]*r,i[2]=-n[2]*r,i[3]=n[3]*r)},t.rotationMatrix=function(t,e){var n=t.elements,i=n[0],r=n[1],a=n[2],s=n[3],o=n[4],l=n[5],h=n[6],_=n[7],u=n[8],c=e.elements,d=NaN,f=NaN,m=i+o+u;m>0?(d=Math.sqrt(m+1),c[3]=.5*d,d=.5/d,c[0]=(l-_)*d,c[1]=(h-a)*d,c[2]=(r-s)*d):i>=o&&i>=u?(d=Math.sqrt(1+i-o-u),f=.5/d,c[0]=.5*d,c[1]=(r+s)*f,c[2]=(a+h)*f,c[3]=(l-_)*f):o>u?(d=Math.sqrt(1+o-i-u),f=.5/d,c[0]=(s+r)*f,c[1]=.5*d,c[2]=(_+l)*f,c[3]=(h-a)*f):(d=Math.sqrt(1+u-i-o),f=.5/d,c[0]=(h+a)*f,c[1]=(_+l)*f,c[2]=.5*d,c[3]=(r-s)*f)},t.DEFAULT=new t,__static(t,["TEMPVector30",function(){return this.TEMPVector30=new Vector3},"TEMPVector31",function(){return this.TEMPVector31=new Vector3},"TEMPVector32",function(){return this.TEMPVector32=new Vector3},"TEMPVector33",function(){return this.TEMPVector33=new Vector3},"TEMPMatrix0",function(){return this.TEMPMatrix0=new Matrix4x4},"TEMPMatrix1",function(){return this.TEMPMatrix1=new Matrix4x4},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new Matrix3x3},"NAN",function(){return this.NAN=new t(NaN,NaN,NaN,NaN)}]),t}(),Vector2=function(){function t(t,e){this.elements=new Float32Array(2),void 0===t&&(t=0),void 0===e&&(e=0);var n=this.elements;n[0]=t,n[1]=e}__class(t,"laya.d3.math.Vector2");var e=t.prototype;return Laya.imps(e,{"laya.d3.core.IClone":!0}),e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1]},e.cloneTo=function(t){var e=t,n=e.elements,i=this.elements;n[0]=i[0],n[1]=i[1]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),__getset(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),t.scale=function(t,e,n){var i=n.elements,r=t.elements;i[0]=r[0]*e,i[1]=r[1]*e},__static(t,["ZERO",function(){return this.ZERO=new t(0,0)},"ONE",function(){return this.ONE=new t(1,1)}]),t}(),ChunkInfo=function(){function t(){this.alphaMap=null,this.detailID=null,this.normalMap=null}return __class(t,"laya.d3.terrain.unit.ChunkInfo"),t}(),MaterialInfo=function(){function t(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}return __class(t,"laya.d3.terrain.unit.MaterialInfo"),t}(),DetailTextureInfo=function(){function t(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}return __class(t,"laya.d3.terrain.unit.DetailTextureInfo"),t}(),TerrainLeaf=function(){function t(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,t.__init__(),this._currentLODLevel=0}__class(t,"laya.d3.terrain.TerrainLeaf");var e=t.prototype;return e.calcVertextNorml=function(e,n,i,r,a,s){var o=0,l=0;l=-1*t.getHeightFromTerrainHeightData(e-1,n-1,i,r,a),l+=-1*t.getHeightFromTerrainHeightData(e-1,n,i,r,a),l+=-1*t.getHeightFromTerrainHeightData(e-1,n+1,i,r,a),l+=1*t.getHeightFromTerrainHeightData(e+1,n-1,i,r,a),l+=1*t.getHeightFromTerrainHeightData(e+1,n,i,r,a),l+=1*t.getHeightFromTerrainHeightData(e+1,n+1,i,r,a),o=-1*t.getHeightFromTerrainHeightData(e-1,n-1,i,r,a),o+=-1*t.getHeightFromTerrainHeightData(e,n-1,i,r,a),o+=-1*t.getHeightFromTerrainHeightData(e+1,n-1,i,r,a),o+=1*t.getHeightFromTerrainHeightData(e-1,n+1,i,r,a),o+=1*t.getHeightFromTerrainHeightData(e,n+1,i,r,a),o+=1*t.getHeightFromTerrainHeightData(e+1,n+1,i,r,a),s.x=-l,s.y=6,s.z=-o,Vector3.normalize(s,s)},e.calcVertextNormlUV=function(t,e,n,i,r){r.x=t/n,r.y=e/i,r.z=e/i},e.calcVertextBuffer=function(e,n,i,r,a,s,o,l,h,_,u,c){if(1==c&&!t.__ADAPT_MATRIX__){t.__ADAPT_MATRIX__=new Matrix4x4;var d=new Matrix4x4;Matrix4x4.createRotationY(Math.PI,t.__ADAPT_MATRIX__),Matrix4x4.createTranslate(new Vector3(0,0,(u-1)*a),d),Matrix4x4.multiply(d,t.__ADAPT_MATRIX__,t.__ADAPT_MATRIX__),t.__ADAPT_MATRIX_INV__=new Matrix4x4,t.__ADAPT_MATRIX__.invert(t.__ADAPT_MATRIX_INV__)}this._gridSize=a,this._beginGridX=e*t.CHUNK_GRID_NUM+i,this._beginGridZ=n*t.CHUNK_GRID_NUM+r;for(var f=o*l,m=2147483647,p=-2147483648,g=new Vector3,v=0,x=t.LEAF_GRID_NUM+1;v<x;v++)for(var S=0,T=t.LEAF_GRID_NUM+1;S<T;S++)t.__VECTOR3__.x=(this._beginGridX+S)*this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+v)*this._gridSize,t.__VECTOR3__.y=h[(this._beginGridZ+v)*_+(this._beginGridX+S)],m=t.__VECTOR3__.y<m?t.__VECTOR3__.y:m,p=t.__VECTOR3__.y>p?t.__VECTOR3__.y:p,t.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[f]=t.__VECTOR3__.x,f++,s[f]=t.__VECTOR3__.y,f++,s[f]=t.__VECTOR3__.z,f++,this.calcVertextNormlUV(this._beginGridX+S,this._beginGridZ+v,_,u,g),s[f]=g.x,f++,s[f]=g.y,f++,s[f]=g.z,f++,s[f]=(i+S)/t.CHUNK_GRID_NUM,f++,s[f]=(r+v)/t.CHUNK_GRID_NUM,f++,s[f]=this._beginGridX+S,f++,s[f]=this._beginGridZ+v,f++;this._sizeOfY=new Vector2(m-1,p+1),this.calcLODErrors(h,_,u),this.calcOriginalBoudingBoxAndSphere()},e.calcSkirtVertextBuffer=function(e,n,i,r,a,s,o,l,h,_,u){this._gridSize=a,this._beginGridX=e*t.CHUNK_GRID_NUM+i,this._beginGridZ=n*t.CHUNK_GRID_NUM+r;var c=o*l,d=0,f=0,m=t.LEAF_GRID_NUM+1,p=new Vector3,g=0,v=0;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,t.__VECTOR3__.y=1==d?h[this._beginGridZ*_+(this._beginGridX+f)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,t.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,g=0==d?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+f,g,_,u,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(i+f)/t.CHUNK_GRID_NUM,c++,s[c]=(r+0)/t.CHUNK_GRID_NUM,c++,s[c]=this._beginGridX+f,c++,s[c]=g,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,t.__VECTOR3__.y=0==d?h[(this._beginGridZ+t.LEAF_GRID_NUM)*_+(this._beginGridX+f)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+t.LEAF_GRID_NUM)*this._gridSize,t.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,g=0==d?this._beginGridZ+t.LEAF_GRID_NUM:this._beginGridZ+t.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+f,g,_,u,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(i+f)/t.CHUNK_GRID_NUM,c++,s[c]=(r+t.LEAF_GRID_NUM)/t.CHUNK_GRID_NUM,c++,s[c]=this._beginGridX+f,c++,s[c]=g,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,t.__VECTOR3__.y=0==d?h[(this._beginGridZ+f)*_+(this._beginGridX+0)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,t.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,v=0==d?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(v,this._beginGridZ+f,_,u,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(i+0)/t.CHUNK_GRID_NUM,c++,s[c]=(r+f)/t.CHUNK_GRID_NUM,c++,s[c]=v,c++,s[c]=this._beginGridZ+f,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+t.LEAF_GRID_NUM)*this._gridSize,t.__VECTOR3__.y=1==d?h[(this._beginGridZ+f)*_+(this._beginGridX+t.LEAF_GRID_NUM)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,t.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,v=0==d?this._beginGridX+t.LEAF_GRID_NUM+1:this._beginGridX+t.LEAF_GRID_NUM,this.calcVertextNormlUV(v,this._beginGridZ+f,_,u,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(i+t.LEAF_GRID_NUM)/t.CHUNK_GRID_NUM,c++,s[c]=(r+f)/t.CHUNK_GRID_NUM,c++,s[c]=v,c++,s[c]=this._beginGridZ+f,c++},e.calcOriginalBoudingBoxAndSphere=function(){var e=new Vector3(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),n=new Vector3((this._beginGridX+t.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+t.LEAF_GRID_NUM)*this._gridSize);t.__ADAPT_MATRIX__&&(Vector3.transformV3ToV3(e,t.__ADAPT_MATRIX__,e),Vector3.transformV3ToV3(n,t.__ADAPT_MATRIX__,n)),this._originalBoundingBox=new BoundBox(e,n);var i=new Vector3;Vector3.subtract(n,e,i),Vector3.scale(i,.5,i);var r=new Vector3;Vector3.add(e,i,r),this._originalBoundingSphere=new BoundSphere(r,Vector3.scalarLength(i)),this._originalBoundingBoxCorners=__newvec(8,null),this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new BoundBox(new Vector3(-.5,-.5,-.5),new Vector3(.5,.5,.5)),this._boundingSphere=new BoundSphere(new Vector3(0,0,0),1)},e.calcLeafBoudingBox=function(t){for(var e=0;e<8;e++)Vector3.transformCoordinate(this._originalBoundingBoxCorners[e],t,BaseRender._tempBoundBoxCorners[e]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox)},e.calcLeafBoudingSphere=function(t,e){Vector3.transformCoordinate(this._originalBoundingSphere.center,t,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*e},e.calcLODErrors=function(e,n,i){this._LODError=new Float32Array(t._maxLODLevel+1);for(var r=1,a=0,s=t._maxLODLevel+1;a<s;a++){for(var o=0,l=0,h=t.LEAF_GRID_NUM;l<h;l+=r)for(var _=0,u=t.LEAF_GRID_NUM;_<u;_+=r)for(var c=e[(this._beginGridZ+l)*n+(this._beginGridX+_)],d=e[(this._beginGridZ+l)*n+(this._beginGridX+_)+r],f=e[(this._beginGridZ+l+r)*n+(this._beginGridX+_)],m=e[(this._beginGridZ+l+r)*n+(this._beginGridX+_)+r],p=0;p<r;p++)for(var g=p/r,v=0;v<r;v++){var x=v/r,S=e[(this._beginGridZ+l+p)*n+(this._beginGridX+_)+v],T=x+g<=1?c+(d-c)*x+(f-c)*g:m+(f-m)*(1-x)+(d-m)*(1-g),E=Math.abs(T-S);o=Math.max(o,E)}r*=2,this._LODError[a]=o}},e.determineLod=function(e,n,i,r){var a=Vector3.distance(e,this._boundingSphere.center),s=t._maxLODLevel;if(!r){if(this._lastDistanceToEye==a)return this._currentLODLevel;this._lastDistanceToEye>a&&(s=this._currentLODLevel)}for(var o=s;o>=1;o--)if(Terrain.LOD_DISTANCE_FACTOR*this._LODError[o]/a*n<i){this._currentLODLevel=o;break}return this._lastDistanceToEye=a,this._currentLODLevel},t.__init__=function(){if(!t._bInit){var e=t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM*(t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM);t._planeLODIndex=__newvec(e);var n=0,i=0,r=0,a=0,s=0,o=0,l=null,h=null;for(n=0;n<e;n++)t._planeLODIndex[n]=new Array(t._maxLODLevel+1);for(n=0,a=t._maxLODLevel+1;n<a;n++)t._planeLODIndex[0][n]=t.calcPlaneLODIndex(n);for(n=1;n<e;n++)for(o=n*t.LEAF_PLANE_VERTEXT_COUNT,i=0,s=t._maxLODLevel+1;i<s;i++){for(l=t._planeLODIndex[0][i],h=new Uint16Array(l.length),r=0;r<l.length;r++)h[r]=l[r]+o;t._planeLODIndex[n][i]=h}for(t._skirtLODIndex=__newvec(e),n=0;n<e;n++)t._skirtLODIndex[n]=new Array(t._maxLODLevel+1);for(n=0,a=t._maxLODLevel+1;n<a;n++)t._skirtLODIndex[0][n]=t.calcSkirtLODIndex(n);for(n=1;n<e;n++)for(o=n*t.LEAF_SKIRT_VERTEXT_COUNT,i=0,s=t._maxLODLevel+1;i<s;i++){for(l=t._skirtLODIndex[0][i],h=new Uint16Array(l.length),r=0;r<l.length;r++)h[r]=l[r]+o;t._skirtLODIndex[n][i]=h}t._bInit=!0}},t.getPlaneLODIndex=function(e,n){return t._planeLODIndex[e][n]},t.getSkirtLODIndex=function(e,n){return t._skirtLODIndex[e][n]},t.calcPlaneLODIndex=function(e){e>t._maxLODLevel&&(e=t._maxLODLevel);var n=t.LEAF_GRID_NUM+1,i=0,r=null,a=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);r=new Uint16Array(a*a*6);for(var s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/a,o=0;o<t.LEAF_GRID_NUM;o+=s)for(var l=0;l<t.LEAF_GRID_NUM;l+=s)r[i]=(o+s)*n+l,i++,r[i]=o*n+l,i++,r[i]=o*n+l+s,i++,r[i]=o*n+l+s,i++,r[i]=(o+s)*n+l+s,i++,r[i]=(o+s)*n+l,i++;return r},t.calcSkirtLODIndex=function(e){e>t._maxLODLevel&&(e=t._maxLODLevel);var n=t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM*(t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM)*t.LEAF_PLANE_VERTEXT_COUNT,i=t.LEAF_GRID_NUM+1,r=0,a=null,s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);a=new Uint16Array(4*s*6);for(var o=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/s,l=0;l<4;l++){for(var h=0;h<t.LEAF_GRID_NUM;h+=o)a[r]=n+i+h,r++,a[r]=n+h,r++,a[r]=n+h+o,r++,a[r]=n+h+o,r++,a[r]=n+i+h+o,r++,a[r]=n+i+h,r++;n+=2*i}return a},t.getHeightFromTerrainHeightData=function(t,e,n,i,r){return t=t<0?0:t,t=t>=i?i-1:t,e=e<0?0:e,e=e>=r?r-1:e,n[e*i+t]},t.CHUNK_GRID_NUM=64,t.LEAF_GRID_NUM=32,t.__ADAPT_MATRIX__=null,t.__ADAPT_MATRIX_INV__=null,t._planeLODIndex=null,t._skirtLODIndex=null,t._bInit=!1,__static(t,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(t.LEAF_GRID_NUM+1)*(t.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(t.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=t.LEAF_PLANE_VERTEXT_COUNT+t.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=t.LEAF_GRID_NUM*t.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*t.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=t.LEAF_PLANE_MAX_INDEX_COUNT+t.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new Vector3},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(t.LEAF_GRID_NUM)}]),t}(),ValusArray=function(){function t(){this._data=null,this._data=[]}__class(t,"laya.d3.shader.ValusArray");var e=t.prototype;return e.setValue=function(t,e){this._data[t]=e},__getset(0,e,"data",function(){return this._data}),t}(),ShaderInit3D=function(){function t(){}return __class(t,"laya.d3.shader.ShaderInit3D"),t.__init__=function(){ShaderCompile3D._globalRegDefine("HIGHPRECISION",ShaderCompile3D.SHADERDEFINE_HIGHPRECISION),ShaderCompile3D._globalRegDefine("FOG",ShaderCompile3D.SHADERDEFINE_FOG),ShaderCompile3D._globalRegDefine("DIRECTIONLIGHT",ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT),ShaderCompile3D._globalRegDefine("POINTLIGHT",ShaderCompile3D.SHADERDEFINE_POINTLIGHT),ShaderCompile3D._globalRegDefine("SPOTLIGHT",ShaderCompile3D.SHADERDEFINE_SPOTLIGHT),ShaderCompile3D._globalRegDefine("UV",ShaderCompile3D.SHADERDEFINE_UV0),ShaderCompile3D._globalRegDefine("COLOR",ShaderCompile3D.SHADERDEFINE_COLOR),ShaderCompile3D._globalRegDefine("UV1",ShaderCompile3D.SHADERDEFINE_UV1),ShaderCompile3D._globalRegDefine("CASTSHADOW",ParallelSplitShadowMap.SHADERDEFINE_CAST_SHADOW),ShaderCompile3D._globalRegDefine("SHADOWMAP_PSSM1",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),ShaderCompile3D._globalRegDefine("SHADOWMAP_PSSM2",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),ShaderCompile3D._globalRegDefine("SHADOWMAP_PSSM3",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF_NO",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF1",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF2",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),ShaderCompile3D._globalRegDefine("SHADOWMAP_PCF3",ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),ShaderCompile3D._globalRegDefine("DEPTHFOG",ShaderCompile3D.SAHDERDEFINE_DEPTHFOG),Shader3D.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n\tvec3 normalT = 2.0*normalMapSample - 1.0;\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent- dot(tangent, N)*N);\n\tvec3 B = cross(T, N);\n\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 ambinentColor,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec=-normalize(dirLight.Direction);\n\t\n\tamb=matAmb*ambinentColor;\n\t\n\tfloat  diffuseFactor=dot(lightVec, normal);\n\t\n\tif(diffuseFactor>0.0)\n\t{\n\t   vec3 v = reflect(-lightVec, normal);\n\t   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t   \n\t   dif = diffuseFactor * matDif * dirLight.Diffuse;\n\t   spec = specFactor * matSpe.rgb;\n\t}\n\t\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight,in vec3 ambinentColor, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec = poiLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > poiLight.Range )\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif( diffuseFactor > 0.0 )\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * poiLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\n\tfloat attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 ambinentColor,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tamb = vec3(0.0);\n\tdif =vec3(0.0);\n\tspec= vec3(0.0);\n\tvec3 lightVec = spoLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > spoLight.Range)\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif(diffuseFactor > 0.0)\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * spoLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\t\n\tfloat spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n\tfloat attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n\tamb *= spot;\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\n"),Shader3D.addInclude("Lighting.glsl","\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat Spot;\n\tfloat Range;\n};\n\n// U3D中使用衰减纹理,此函数模拟并非正确\n//float U3DAttenuation(in vec3 L,in float invLightRadius)\n//{\n//\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n//\tfRatio *= fRatio;\n//\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n//} \n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius)\n{\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius)); \t\n\treturn attenuation * attenuation;\n} \n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\t\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius)\n{\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n} \n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor)\n{\n    mediump vec3 h = normalize(viewDir-lightVec);\n    lowp float ln = max (0.0, dot (-lightVec,normal));\n    float nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec=normalize(light.Direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec,diffuseColor,specularColor);\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,normalLightVec,diffuseColor,specularColor);\n\tfloat spot = pow(max(dot(normalLightVec, normalize(light.Direction)), 0.0), light.Spot);\n\tfloat attenuate = spot*BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal)\n{\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\t\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tmat3 TBN = mat3(T, B, N);\n\t\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\n"),
Shader3D.addInclude("PBRLighting.glsl","struct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvec3 UnpackScaleNormal(in vec2 uv0)\n{\n\t#ifdef NORMALTEXTURE\n\t\tvec3 normalT;\n\t\tvec4 normalMapSample = texture2D(u_NormalTexture, uv0);\n\t\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\t\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\t\tnormalT.xy *= u_normalScale;\n\t\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\t\t\n\t\tvec3 T = normalize(v_Tangent);\n\t\tvec3 B = normalize(v_Binormal);\n\t\tvec3 N = normalize(v_Normal);\n\t\tmat3 TBN = mat3(T, B, N);\n\t\t\n\t\tvec3 bumpedNormal = TBN * normalize(normalT);\n\t\treturn bumpedNormal;\n\t#else\n\t\treturn normalize(v_Normal);\n\t#endif\n}\n\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nfloat PI = 3.14159265359;\n\nvec3 FresnelTerm (in vec3 F0, in float cosA)\n{\n\treturn F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\n}\n\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\n{\n\treturn perceptualRoughness * perceptualRoughness;\n}\n\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\n{\n\tfloat m = PerceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat sq = max(0.0001, m * m);\n\tfloat n = (2.0 / sq) - 2.0;\n\tn = max(n, 0.0001);\n\treturn n;\n}\n\nfloat RoughnessToPerceptualRoughness(in float roughness)\n{\n\treturn sqrt(roughness);\n}\n\nfloat SmoothnessToRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness) * (1.0 - smoothness);\n}\n\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness);\n}\n\nvec3 SafeNormalize(in vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * (1.0 / sqrt(dp3));\n}\n\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\n{\n\tfloat fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\tfloat lightScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\n\tfloat viewScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\n\n\treturn lightScatter * viewScatter;\n}\n\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\n{\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\n\treturn 0.5 / (lambdaV + lambdaL + 0.00001);\n}\n\nfloat GGXTerm (float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0;\n\treturn 0.31830988618 * a2 / (d * d + 0.0000001);\n}\n\nvec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\n\tvec3 halfDir = SafeNormalize(viewDir - lightDir);\n\t\n\tfloat nv = abs(dot(normal, viewDir));\n\t\n\tfloat nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\n\tfloat nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\n\tfloat lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\n\tfloat lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\n\t\n\tfloat diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\t\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\n\t\n\t//#if UNITY_BRDF_GGX\n\tfloat V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = GGXTerm(nh, roughness);\n\t\n\tfloat specularTerm = V * D * PI;\n\t\n\tspecularTerm = sqrt(max(0.0001, specularTerm));\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\n\tvec4 color;\n\tcolor.rgb = diffuseColor * (gi + lightColor * diffuseTerm) + specularTerm * lightColor * FresnelTerm (specularColor, lh);\n\t\n\tcolor.a = 1.0;\n\treturn color;\n}\n\nfloat OneMinusReflectivityFromMetallic(in float metallic)\n{\n\tfloat oneMinusDielectricSpec = DielectricSpecularColor.a;\n\treturn oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\n}\n\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\n{\n\tspecularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\n\toneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec4 LayaAirPBRLight(in vec3 diffuseColor, in vec3 normal, in float metallic, in float smoothness, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 specularColor;\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (diffuseColor, metallic, specularColor, oneMinusReflectivity);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\treturn color;\n}\n\nvec4 LayaAirPBRDiectionLight (in vec3 diffuseColor, in vec3 normal, in float metallic, in float smoothness, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn LayaAirPBRLight(diffuseColor, normal, metallic, smoothness, viewDir, lightVec, light.Color, gi);\n}\n\nvec2 MetallicGloss(in vec4 diffuseTextureColor, in vec2 uv0)\n{\n\tvec2 mg;\n\t\n\t#ifdef METALLICGLOSSTEXTURE\n\t\tvec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.r = metallicGlossTextureColor.r;\n\t\t\tmg.g = diffuseTextureColor.a;\n\t\t#else\n\t\t    mg = metallicGlossTextureColor.ra;\n\t\t#endif\n\t\tmg.g *= u_smoothnessScale;\n\t#else\n\t\tmg.r = u_metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.g = diffuseTextureColor.a * u_smoothnessScale;\n\t\t#else\n\t\t\tmg.g = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n\treturn mg;\n}\n\nvec4 Occlusion(in vec2 uv0){\n\t#ifdef OCCLUSIONTEXTURE\n\t\tvec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\n\t\tfloat occ = occlusionTextureColor.g;\n\t\tfloat oneMinusT = 1.0 - u_occlusionStrength;\n\t\tfloat lerpOneTo = oneMinusT + occ * u_occlusionStrength;\n\t\treturn occlusionTextureColor * lerpOneTo;\n\t#else\n\t\treturn vec4(1.0);\n\t#endif\n}\n\nvec2 ParallaxOffset(in vec3 viewDir){\n\t#ifdef PARALLAXTEXTURE\n\t\tfloat h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\n\t\th = h * u_parallaxScale - u_parallaxScale / 2.0;\n\t\tvec3 v = viewDir;\n\t\tv.z += 0.42;\n\t\tvec2 offset = h * (v.xy / v.z);\n\t\treturn v_Texcoord0 + offset;\n\t#else\n\t\treturn v_Texcoord0;\n\t#endif\n}\n\n"),Shader3D.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2\t  u_shadowPCFoffset;\nuniform vec4     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n\tres -= res.xxyz * bitMask;\n\treturn res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n\tvec2 texelpos =texcoord / invsize;\n\tvec2 lerps = fract( texelpos );\n\tfloat sourcevals[4];\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\tnPSNum += int(posViewZ>pssmDistance.z);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\telse if( nPSNum == 2 )\n\t{\n\t\tlightVP = lightShadowVP[3];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t} \n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tif( posViewZ < pssmDistance.x )\n\t{\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n\t\tfloat fMyZ = vText.z - zBias;\n\t\t/*\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\t\tbool bInFrustum = all( bInFrustumVec );\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\t\tbool bFrustumTest = all( bFrustumTestVec );\n\t\t*/\n\t\tif ( fMyZ <= 1.0 ) \n\t\t{\n\t\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n\t\t\tvalue = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2\t\t\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO\t\t\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t\t}\n\t}\n\treturn value;\n}"),Shader3D.addInclude("WaveFunction.glsl","\nuniform vec2 u_WaveInfoD[20];\nuniform vec4 u_WaveInfo[20];\n\nuniform float TEXWAVE_UV_SCALE ;//= 20.0; //每texwidth像素代表的实际距离\n/**\n\t这里的计算都是\n*/\n\n/**\n* 计算一个波形\n*  开始计算的时候都按照z向上，最后输出的时候，颠倒一下。\n* @param tm {float} 毫秒\n*/\nvoid calcGerstnerWave(float curtm, vec3 pos, float deep, vec2 uvpos, out vec3 opos, out vec3 B, out vec3 T, out vec3 N, out float foamS){\n\tfloat tm = curtm/1000.;\n\topos = pos;\n\tvec3 wpos=vec3(0.);\t\t//累加的位置\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tT=vec3(0.,0.,0.);\n\tB=vec3(0.,0.,0.);\n\tvec2 cD ;//= D;\n\t//float deepAtt = max(0.,min(deep,1.0));\n\t//A*=deepAtt; //TODO\n\t\n\tfor( int i=0; i<4; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat Q = u_WaveInfo[i].x;//wi.QorK;\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\twpos += vec3(Q*A*cD.x*c,\n\t\t\t\t\tQ*A*cD.y*c,\n\t\t\t\t\tA*s);\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\tT += vec3(_QxyAWs,\n\t\t\t\tQ*cD.y*cD.y*AWs,//记得1-\n\t\t\t\tcD.y*AWc\n\t\t\t);\n\t\tB += vec3(Q*cD.x*cD.x*AWs,//记得1-\n\t\t\t\t_QxyAWs,\n\t\t\t\tcD.x*AWc\n\t\t\t);\n\t\t//float v1 = exp(-tan((dop*W - tm*P)/2.+1.07));//除2，+pi/2 这样正好能对齐\n#ifdef USE_FOAM\t\t\n\t\tfloat v1 = 0.5-sin((dop*W - tm*P)/1.+2.0)/2.;\n\t\tfoamS += pow(v1,9.)/4.;\n#endif\n\t}\n\tT.y=1.-T.y; B.x=1.-B.x;N.z=1.-N.z;\n\topos += vec3(wpos.x,wpos.z*min(deep/10.,1.),wpos.y);\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tT.xyz=T.xzy;\n\tB.xyz=B.xzy;\n\tN.xyz=N.xzy;\n}\n\n\nvoid calcWave(float curtm, vec2 uv, out vec3 B, out vec3 T, out vec3 N){\n\tfloat tm = curtm/1000.;\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tvec2 uvpos = uv*TEXWAVE_UV_SCALE; //TODO 这个范围是什么 就是1？\n\tuvpos.y*=-1.;\n\tvec2 cD;// = D;\n\tconst int NumWaves = 4;\n\tfloat scale = 1./float(NumWaves);\n\tfor( int i=0; i<NumWaves; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat k = 1.5;//u_WaveInfo[i].x;//wi.QorK; TODO  不知道为什么，这个取u_WaveInfo[i].x，在mi3w上就会闪。测试发现实际值也传过来了，就是1.5\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\t\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\t/*\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\t*/\n\t\tfloat kWAc = scale*c;//k*W*A*c;  为了提高精度，这里只保留sin，cos部分，实际使用的时候再乘回来。\n\t\t//float kWAc = k*W*A*c;  \n\t\tN += vec3(\n\t\t\t-kWAc*cD.x*pow((s+1.)/2.,k-1.),\n\t\t\t-kWAc*cD.y*pow((s+1.)/2.,k-1.),\n\t\t\t1.\n\t\t);\n\t}\n\t//N.z=1.-N.z;\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tN.xyz=N.xzy;\n}\n");var t,e,n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_ReflectTexture:[5,1],u_AlphaTestValue:[0,1],u_DiffuseColor:[6,1],u_MaterialSpecular:[8,1],u_Shininess:[9,1],u_MaterialReflect:[10,1],u_TilingOffset:[11,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Color":[4,4],"u_DirectionLight.Direction":[3,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Color":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Color":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},r=Shader3D.nameKey.add("BLINNPHONG");t='attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal; \n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tmat3 worldMat;\n\t\t#ifdef BONE\n\t\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\t#else\n\t\t\tworldMat=mat3(u_WorldMat);\n\t\t#endif  \n\t\tv_Normal=worldMat*a_Normal;//TODO:法线可以用"魔法"矩阵\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tv_Tangent=worldMat*a_Tangent0.xyz;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t\t#ifdef BONE\n\t\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t\t#else\n\t\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\tv_Texcoord0=a_Texcoord0;\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0+v_Texcoord0.y);\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t#endif\n\n\t#ifdef COLOR\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',e='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nuniform vec4 u_DiffuseColor;\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvarying vec3 v_ViewDir; \n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform vec3 u_MaterialReflect;\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#ifdef COLOR\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tvec3 normal;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t\t#else\n\t\t\tnormal = normalize(v_Normal);\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t\tvec3 diffuse = vec3(0.0);\n\t\tvec3 specular= vec3(0.0);\n\t\tvec3 dif,spe;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef SPOTLIGHT\n\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t\n\tvec3 finalDiffuse;\n\t#ifdef LIGHTMAP\n\t\tfinalDiffuse=texture2D(u_LightMap, v_LightMapUV).rgb*2.0;\n\t#else\n\t\tfinalDiffuse=vec3(0.0);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tfinalDiffuse+=diffuse;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse)*shadowValue,mainColor.a);\n\t#else\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse),mainColor.a);\n\t#endif\n\t\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t#ifdef RECEIVESHADOW\n\t\t\tgl_FragColor.rgb+=specular*shadowValue;\n\t\t#else\n\t\t\tgl_FragColor.rgb+=specular;\n\t\t#endif\n\t#endif\n\n\n\t#ifdef REFLECTMAP\n\t\tvec3 incident = -viewDir;\n\t\tvec3 reflectionVector = reflect(incident,normal);\n\t\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\t\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n\t#endif\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t  main_normal();\n\t#endif  \n}\n\n';var a=ShaderCompile3D.add(r,t,e,n,i);BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),BlinnPhongMaterial.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),BlinnPhongMaterial.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),n={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_AmbientTexture:[5,1],u_ReflectTexture:[6,1],u_AlphaTestValue:[0,1],u_Albedo:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_TilingOffset:[15,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var s=Shader3D.nameKey.add("SIMPLE")
;t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#if defined(AMBIENTMAP)||(defined(LIGHTMAP)&&defined(UV1))\nattribute vec2 a_Texcoord1;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_LightMapUV;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n \n//TODO没考虑UV动画呢\n#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\tv_Texcoord0=a_Texcoord0;\n#endif\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t#else\n\t\tworldMat=mat3(u_WorldMat);\n\t#endif  \n\tv_Normal=worldMat*a_Normal;\n\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tv_Tangent0=worldMat*a_Tangent0;\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t#ifdef BONE\n\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t#else\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n\tv_Texcoord0=a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t#ifdef UVTRANSFORM\n\t\tv_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n\t#endif\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\n\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t#else\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t#else\n\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t#endif \n\t#endif \n#endif\n\n#ifdef COLOR\n\tv_Color=a_Color;\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\n\tmain_castShadow();\n#else\n\tmain_normal();\n#endif\n}",e='#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nvarying vec2 v_LightMapUV;\n#endif\n#ifdef AMBIENTMAP\nuniform sampler2D u_AmbientTexture;\n#endif\n#ifdef LIGHTMAP\nuniform sampler2D u_LightMap;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#if defined(FOG)||defined(DEPTHFOG)\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||(defined(RECEIVESHADOW)&&(defined(SHADOWMAP_PSM2)||defined(SHADOWMAP_PSM3)))\nuniform vec3 u_CameraPos;\n#endif\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)\nvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n#if defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n#endif \n  \n#if defined(COLOR)&&!defined(DIFFUSEMAP)\n\tgl_FragColor=v_Color;\n#endif \n  \n#if defined(DIFFUSEMAP)&&defined(COLOR)\n\tvec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\tgl_FragColor=texColor*v_Color;\n#endif\n  \n#if !defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=vec4(1.0,1.0,1.0,1.0);\n#endif \n    \n#ifdef ALPHATEST\n\tif(gl_FragColor.a-u_AlphaTestValue<0.0)\n\t\tdiscard;\n#endif\n  \n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n\t#else\n\t\tnormal = normalize(v_Normal);\n    #endif\n#endif\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\t\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef AMBIENTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_Albedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n\t\tspecular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular*shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n\t#endif\n#endif\n  \n#ifdef REFLECTMAP\n\tvec3 incident = -toEye;\n\tvec3 reflectionVector = reflect(incident,normal);\n\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n#endif\n  \n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t#ifdef ADDTIVEFOG\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t#else\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n#endif\n#ifdef DEPTHFOG\n\tfloat lerpFact = (-v_PositionWorld.y-u_FogStart)/u_FogRange;\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\t\t\n\tmain_castShadow();\n#else\n  main_normal();\n#endif  \n}\n\n',a=ShaderCompile3D.add(s,t,e,n,i),StandardMaterial.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),StandardMaterial.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),StandardMaterial.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),StandardMaterial.SHADERDEFINE_EMISSIVEMAP=a.registerMaterialDefine("EMISSIVEMAP"),StandardMaterial.SHADERDEFINE_AMBIENTMAP=a.registerMaterialDefine("AMBIENTMAP"),StandardMaterial.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),StandardMaterial.SHADERDEFINE_UVTRANSFORM=a.registerMaterialDefine("UVTRANSFORM"),StandardMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),StandardMaterial.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),n={a_Position:0,a_Color:1},i={u_MvpMatrix:[1,2]};var o=Shader3D.nameKey.add("LINE");t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}",e="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",ShaderCompile3D.add(o,t,e,n,i),n={a_position:0,a_normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},i={u_Bones:[0,0],u_lodRect:[9,3],irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],u_aoObjPos:[14,1],texBaseColor:[1,1],texNormal:[2,1],texPbrInfo:[3,1],texPrefilterdEnv:[8,3],texHSNoise:[15,1],texPrefilterDiff:[7,3],u_AlphaTestValue:[0,1],texBRDFLUT:[4,1],u_UVAniAge:[5,1],u_roughness:[6,1],u_metaless:[7,1],u_UVMatrix:[8,1],u_UVAge:[9,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var l=Shader3D.nameKey.add("PBR");t="\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n#ifdef HAS_TANGENT\nattribute vec3 tangent;\nattribute vec3 binormal;\n#endif\nattribute vec2 uv;\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\n\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\nvoid main() {\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tgl_Position = mvp*skinTransform*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix*skinTransform;\n#else\n\tgl_Position = mvp*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix;\n#endif\t\n\tvWorldPos = modelMat*vec4(a_position,1.);\n\n#ifdef CASTSHADOW \n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tvUv = uv;\n\t#endif\t\n#else\n    vUv = uv;\n\tvWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t#ifdef HAS_TANGENT\n\tvWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\tvWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n\t#endif\n    \n    vViewDir = (vWorldPos.xyz-cameraPosition);//这个不能normalize。否则无法线性差值了\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.z;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vWorldPos;\n\t#endif\n#endif\t\n#endif\n}\n",e='//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n#ifdef HAS_PBRINFO\nuniform sampler2D texPbrInfo;   //Ao, Roughness, Metallic\n#endif\nuniform float u_hdrexposure;\nuniform float u_AlphaTestValue;\n\nuniform float u_roughness;\nuniform float u_metaless;\nconst float maxlv = 7.;\t//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n\t\t\t\t\t\t\t\nuniform mat4 irrad_mat_red;\nuniform mat4 irrad_mat_green;\nuniform mat4 irrad_mat_blue;\t\t\t\t\t\t\t\n\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n\tvec2 uv = vec2(u,v);\n\tuv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n\treturn texture2D(tex,uv,lod-16.);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn tex2dLod(tex,envu,envv,lod);\n}\n\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nfloat environment_exposure = 1.0;\nvec3 diff_sh9(vec3 dir){\n\tvec4 shDir = vec4(dir.x,-dir.z,dir.y,1.0);\n  return max(vec3(0.0), vec3(\n\tdot(shDir, irrad_mat_red * shDir),\n\tdot(shDir, irrad_mat_green * shDir),\n\tdot(shDir, irrad_mat_blue * shDir)\n\t)) * environment_exposure;\t\n}\n\n#ifdef HAS_TANGENT\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );\n    return normalize( tsn * mapN );\n}\n#endif\n\nvec4 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tbasecolor.rgb = pow(basecolor.rgb,vec3(2.2));\n\tfloat metaless = 1.0; \t\n\tconst float ismetalinfov = (128./255.);\n\tif(basecolor.a>=ismetalinfov){//这时候表示金属度\n\t\tmetaless = (basecolor.a-ismetalinfov)*2.;\n\t\tbasecolor.a = 1.0;\n\t}else{\n\t\tmetaless = 0.;\n\t\tbasecolor.a = basecolor.a*2.0;\n\t}\n\t#ifdef FIX_METALESS\n\tmetaless = u_metaless;\n\t#endif\n\t#ifdef HAS_PBRINFO\t\n\tvec4 pbrinfo = texture2D(texPbrInfo, vUv);\n\tmetaless = pbrinfo.b;\n\trough = pbrinfo.g;\n\t#endif\n    const vec3 nonmetalF0 =vec3(0.02);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n\t\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, rough*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(rough , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    speccontrib = (F0* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n\tvec3 color_spec = PrefilteredColor.rgb*speccontrib;\n\t\n\tvec3 color_diff=diff_sh9(normal);\n\tvec3 outc =  color_diff*mix(basecolor.rgb,vec3(0.),metaless)*(vec3(1.0)-speccontrib)+color_spec;\n\t#ifdef HAS_PBRINFO\n\toutc*=pbrinfo.r;\n\t#endif\n\treturn vec4(outc, basecolor.a);\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tconst vec3 lightdir=normalize(vec3(1.,1.,0.));\n\tconst vec3 spcecol = vec3(1.,0.8,0.8);\n\tconst vec3 amb = vec3(0.5);\n\tvec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n\t//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n\treturn diffv*basecolor.rgb;//+spec;\n}\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main() {\n#ifdef CASTSHADOW\n\tgl_FragColor=packDepth(gl_FragCoord.w);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(texBaseColor,vUv).w;\n\t\tif( alpha < u_AlphaTestValue ){\n\t\t\tdiscard;\n\t\t}\n\t#endif\n#else\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.0001);\n\t\t#endif\n\t#endif\t\n\t\n    vec3 normal =  normalize(vWorldNorm);\n\tvec4 normtex = texture2D( texNormal, vUv );\n\t#ifdef HAS_TANGENT\t\n\tnormal = applyNormalTex(normtex.xyz, normal);\n\t#endif\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n\tfloat roughness = normtex.a;\n\t#ifdef FIX_ROUGHNESS\n\troughness = u_roughness;\n\t#endif\n\t\n\tvec4 pbrl = pbrlight(normal,roughness,NoV,R)*u_hdrexposure;\n    gl_FragColor.rgb =  pow(pbrl.rgb,vec3(0.45455));\n\t//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n\t#ifdef RECEIVESHADOW\n\tgl_FragColor.rgb *= max(shadowValue,0.7);\n\t#endif\n\t\n    gl_FragColor.a = pbrl.a;\n\n#endif\n}\n',a=ShaderCompile3D.add(l,t,e,n,i),PBRMaterial.SHADERDEFINE_FIX_METALESS=a.registerMaterialDefine("FIX_METALESS"),PBRMaterial.SHADERDEFINE_FIX_ROUGHNESS=a.registerMaterialDefine("FIX_ROUGHNESS"),PBRMaterial.SHADERDEFINE_HAS_TANGENT=a.registerMaterialDefine("HAS_TANGENT"),PBRMaterial.SHADERDEFINE_HAS_PBRINFO=a.registerMaterialDefine("HAS_PBRINFO"),PBRMaterial.SHADERDEFINE_USE_GROUNDTRUTH=a.registerMaterialDefine("USE_GROUNDTRUTH"),PBRMaterial.SHADERDEFINE_TEST_CLIPZ=a.registerMaterialDefine("CLIPZ"),n={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},i={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_EmissionColor:[8,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_MetallicGlossTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_metallic:[9,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var h=Shader3D.nameKey.add("PBRStandard");t="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(v_Texcoord0 * u_TilingOffset.xy) + u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}",e='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec4 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\n\n#ifdef DIFFUSETEXTURE\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n\t\tvec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n\t#else\n\t\tvec4 diffuseColor = u_DiffuseColor;\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(diffuseColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\tvec3 normal = UnpackScaleNormal(uv0);\n  \n\tvec2 mg = MetallicGloss(diffuseColor, uv0);\n\t\n\tvec3 gi = (u_AmbientColor * Occlusion(uv0)).rgb;\n  \n\tvec4 color = LayaAirPBRDiectionLight(diffuseColor.rgb, normal, mg.r, mg.g, viewDir, u_DirectionLight, gi);\n\t\n\tcolor.a = diffuseColor.a;\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',a=ShaderCompile3D.add(h,t,e,n,i),PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE=a.registerMaterialDefine("METALLICGLOSSTEXTURE"),PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=a.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE=a.registerMaterialDefine("NORMALTEXTURE"),PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE=a.registerMaterialDefine("PARALLAXTEXTURE"),PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=a.registerMaterialDefine("OCCLUSIONTEXTURE"),PBRStandardMaterial.SHADERDEFINE_EMISSION=a.registerMaterialDefine("EMISSION"),PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE=a.registerMaterialDefine("EMISSIONTEXTURE"),PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),n={a_position:0,a_normal:3,uv:2},i={irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],texBaseColor:[1,1],texNormal:[2,1],texSky:[11,1],texUnderWater:[3,1],
texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texWaterDisp:[4,1],texWaveDetail:[9,1],texDeepColor:[10,1],texWaterInfo:[16,1],texFoam:[17,1],GEOWAVE_UV_SCALE:[18,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_curTm:[8,1],u_scrsize:[15,1],u_WaveInfoD:[13,1],u_WaveInfo:[12,1],u_WaveMainDir:[14,1],u_DeepScale:[20,1],u_SeaColor:[19,1],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4]};var _=Shader3D.nameKey.add("Water");t='\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\nuniform float u_curTm;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n//uniform sampler2D texWaterDisp;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nuniform sampler2D texWaterInfo;\nvarying vec4 vWaterInfo;\nuniform float u_DeepScale;//texWaterInfo.r*vDeepScale\n#endif\nuniform float u_WaveMainDir;\t//主波方向\nuniform float GEOWAVE_UV_SCALE ;//= 100.0;\n\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vDisp;\nvarying float fDeep;\nvarying mat2 matUVTrans;\nvarying float fFoam;\n\nconst float PI = 3.14159265358979323846264;\n\n#include "WaveFunction.glsl"\n\nvec2 getPosFromUV(vec2 uv){\n\treturn uv*50.;\n}\n\nvoid main() {\n\tvec3 pos = a_position;\n    vUv = uv;\n\t\n\t//vDisp = texture2D(texWaterDisp,uv).rgb;\n\t//vec3 disp = vDisp;\n\t\n\t//TODO 这里有个潜规则。\n\tfloat tt = pos.y; pos.y=pos.z; pos.z=-tt;\n\t\n\t#ifdef USE_VERTEX_DEEPINFO\n\tfDeep = -pos.y;\n\tpos.y=0.0;\n\t#else\n\tvWaterInfo = texture2D(texWaterInfo,uv);\n\tfDeep = vWaterInfo.r*u_DeepScale;\n\t#endif\n\t\n\t\n\t//计算波形\n\tmat4 modelMat = modelMatrix;\n\tvec3 opos, T,B,N;\n\tfloat foams=0.;\n\tvec2 uvpos = uv*GEOWAVE_UV_SCALE+vec2(modelMat[3][0],0.);//TODO 如果有旋转缩放怎么办\n\tcalcGerstnerWave(u_curTm, pos,fDeep, uvpos,opos,B,T,N,foams);\n\tfFoam = foams;\n\tgl_Position = mvp*vec4(opos,1.);\n\tvWorldPos = modelMat*vec4(opos,1.);\n\n\tvWorldNorm = normalize((modelMatrix*vec4(N,0.0)).xyz);\n\tvWorldTan = normalize((modelMatrix*vec4(T,0.0)).xyz);\n\tvWorldBin = normalize((modelMatrix*vec4(B,0.0)).xyz);\n    vViewDir = vWorldPos.xyz-cameraPosition; //这个不能取normalize，否则会引入非线性\n\t\n\tfloat s = sin(u_WaveMainDir);\n\tfloat c = cos(u_WaveMainDir);\n\tmatUVTrans = mat2(c,-s,s,c);\n}\n',e="//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec3 vViewDir;//入射。pos-cam\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying float fDeep;\nvarying mat2 matUVTrans;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nvarying vec4 vWaterInfo;\n#endif\nmat3 matTBNOff;//\n\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n#ifdef CUBE_ENV\nuniform samplerCube texSky;\n#else\nuniform sampler2D texSky;\n#endif\nuniform sampler2D texUnderWater;\nuniform sampler2D texWaveDetail;\n//uniform sampler2D texDeepColor;\nuniform sampler2D texFoam;\nvarying float fFoam;\nuniform float u_curTm;\nuniform vec2 u_scrsize;\nuniform vec3 u_SeaColor;//\n\nconst int NumTexWaves=4;\nconst float Amp_over_L = 0.01;\n//const vec3 SEA_COLOR1 = vec3(0.0292,0.672,0.7467);//大洋\n//const vec3 SEA_COLOR2 = vec3(0,0.927,0.43);//近海\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/*\n\t各种 ToneMap\n*/\n//Reinhard\nvec3 ReinhardToneMapping(vec3 color, float adapted_lum) {\n    const float MIDDLE_GREY = 1.;\n    color *= MIDDLE_GREY / adapted_lum;\n    return color / (1.0 + color);\n}\n\n//CE2\nvec3 CEToneMapping(vec3 color, float adapted_lum){\n    return 1. - exp(-adapted_lum * color);\n}\n\n//UC2\nvec3 F1(vec3 x){\n\tconst float A = 0.22;\n\tconst float B = 0.30;\n\tconst float C = 0.10;\n\tconst float D = 0.20;\n\tconst float E = 0.01;\n\tconst float F = 0.30;\n \n\treturn ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;\n}\n\nvec3 Uncharted2ToneMapping(vec3 color, float adapted_lum){\n\tconst vec3 WHITE = vec3(11.2);\n\treturn F1(1.6 * adapted_lum * color) / F1(WHITE);\n}\n\n//ACES\nvec3 ACESToneMapping(vec3 color, float adapted_lum){\n\tconst float A = 2.51;\n\tconst float B = 0.03;\n\tconst float C = 2.43;\n\tconst float D = 0.59;\n\tconst float E = 0.14;\n\n\tcolor *= adapted_lum;\n\treturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\n/*\n\t与位于0点的测试棒的相交测试交点\n\t这个是瞎写的，只是为了测试\n*/\nbool hitClydiner(vec3 pos, vec3 dir, out vec3 hitpos, out vec3 hitnormal){\n\tconst float r = 0.5;\n\tfloat a = dir.x*dir.x+dir.z*dir.z;\n\tfloat b = 2.*dir.x*pos.x+2.*dir.z*pos.z;\n\tfloat c = pos.x*pos.x+pos.z*pos.z-r*r;\n\tfloat d = b*b-4.*a*c;\n\tif(d>=0.0){\n\t\tfloat t = (-b+sqrt(d))/2./a;\n\t\tt =min(t, (-b-sqrt(d))/2./a);\n\t\thitpos = pos+dir*t;\n\t\treturn true;\n\t}\n\t/*\n\tvec3 v1 = normalize(cross(dir,vec3(0.,1.,0.)));//公垂线\n\tfloat dist = dot(pos,v1);//最短距离\n\tif(abs(dist)<r){\n\t\treturn true;\n\t}\n\t*/\n\treturn false;\n}\n\n///* 根据散射公式来计算某个方向的颜色 *///\n//\nfloat phase_function(float costheta, float g, float g2){\n\treturn 1.5*( (1.0-g2) / (2.0+g2) ) * (1.0+costheta*costheta) / pow(1.0+g2-2.0*g*costheta, 1.5);\t\n}\n\nconst float _density = .2;\nconst vec3 _vLightDir=vec3(0.,-1.,0.);//必须是规格化的\nconst int _SAMPLENUM = 20;\nconst float _K1 = 1.0;\nconst float _g = -0.93;\n//\nvec3 calcScatter(vec3 start, vec3 dir, vec3 end){\n\tfloat len = length(end-start);\n\tfloat costheta = dot(dir,_vLightDir);\n\tfloat g2 = _g*_g;\n\tfloat K = _K1*len*_density*phase_function(costheta,_g,g2);\n\t//用分段的方式来积分\n\tfloat dlen = len/float(_SAMPLENUM);//距离平分\n\tfloat ddeep = (start.y-end.y)/float(_SAMPLENUM);//深度平分\n\tfloat sum=0.;\n\tfor( int i=0; i<_SAMPLENUM; i++){\n\t\tfloat fi = float(i);\n\t\tfloat v1 = exp(-_density*(dlen+ddeep)*fi);//TODO 应该可以用分析法计算出来\n\t\tsum += v1;\n\t}\n\treturn vec3(K*sum);\n}\n///* 根据散射公式来计算某个方向的亮度  END *///\n\nconst float cDeep = -2.;\t//假设水的深度\nvec3 getShuiDiColor(vec3 pos, vec3 dir, vec3 normal){\n\t//一个无限大的水底，黑白格纹理。纹理长度为1米\n\tfloat t = ( cDeep-pos.y )/dir.y;\n\tif(t<0.) return vec3(1.,0.,0.);//TEST\n\tbool bhit = false;\n\tvec3 hitpos;\n\tvec3 hitcolor;\n\tvec3 hn;\n\tif(hitClydiner(pos,dir,hitpos,hn) && hitpos.y>cDeep && hitpos.y<pos.y){\n\t\tbhit=true;\n\t\thitcolor = vec3(.8,.8,.8);\n\n\t}else\n\t{\n\t\thitpos = pos+dir*t;\n\t\tvec3 hp = floor(hitpos);\n\t\tfloat a = mod((hp.x+hp.z),2.);\n\t\thitcolor = (a<.9)?vec3(0.,0.,0.):vec3(1.,1.,1.);\n\t\t//hitcolor = texture2D(texUnderWater,hitpos.xz/10.).rgb;\n\t}\n\t\n\tfloat l = length(hitpos-pos);\n\t//return texture2D(texDeepColor,vec2(min(max(l/400.,0.),1.),0.5)).rgb;\n\t//return SEA_COLOR1*calcScatter(pos,dir,hitpos);\n\tfloat left = pow(0.8,l);//假设透过率为80%，则到达水底的时候的光强。\n\treturn mix(hitcolor,u_SeaColor,1.-left);\n}\n\n/*\n\tview已经normalize了\n*/\nvec3 getRefractColor(vec3 view,vec3 normal){\n\tvec3 T = refract(-view, normal, 0.7);\n\treturn getShuiDiColor(vWorldPos.xyz,T,normal); \n}\n\nvec4 calcWaterC(vec3 view, vec3 normal, float von, vec3 R, float rough){\n\t/*\n\t只有浪顶的法线向下，也就是波形形成了交叠的时候，才会这样，所以要通过参数控制避免出现这种情况，而不是在这里保护。\n\tif(dot(R,vec3(0.,1.,0.))<0.){\n\t\tR = -R;\n\t}\n\t*/\n\t//vec3 refr = getRefractColor(-view,normal);\n#ifdef USE_REFR_TEX\t\n\tvec3 refr = texture2D(texUnderWater, gl_FragCoord.xy/u_scrsize+normal.xz/8.).rgb;\n#else\n\tvec3 refr = u_SeaColor;\n#endif\n\tfloat F0=0.02;\n\t//菲涅尔，越大反射越强\n\tfloat f =  F0+(1.0-F0)*exp2((-5.55473*von-6.98316)*von);\n\t//float f = F0+(1.0-F0)*pow(1.-von,5.);\n\t//能看到水底的程度。反射剩余的*水中的衰减\n\t//float a = (1.-f)*(1.-deepk);\n#ifdef CUBE_ENV\n\tvec4 reflc = textureCube(texSky,R);\n#else\n\tvec4 reflc = texPanorama(texSky, R);\n#endif\n#ifdef HDR_ENV\n\tvec3 refl = _RGBEToRGB(reflc)*f;\n#else\n\tvec3 refl = reflc.rgb*f;\n#endif\n\t//return vec4(refl*(1.-rough),1.);\n\t\n\t//vec3 refl = reflc.rgb*f;\n\tvec3 final = mix(refr, u_SeaColor, min(fDeep/10.,1.))+refl*(max(0.,1.-rough));\n#ifdef HDR_ENV\n\tfinal = ACESToneMapping(final,1.);//TODO 这个要uniform传入\n#endif\n\treturn vec4(final,f);\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n\t//如果uv=1为100米，希望每个细节纹理表示20米的小波形，则uv缩放是 100/20。细节纹理内部也要用这个值，即pos=uv*20\n\tvec2 ruv = matUVTrans*vUv;\n\tvec3 detailNorm = texture2D(texWaveDetail,fract(ruv*5.)).rgb*2.-vec3(1.);//TODO uv怎么算\n\tfloat texNormScale = 2.*PI*float(NumTexWaves)*Amp_over_L*2.5;\n\tdetailNorm *= vec3(texNormScale,1.,texNormScale);\n\t//旋转\n\t//细节纹理来自rendertarget，因此需要颠倒z\n\t\n\tmatTBNOff = mat3(matUVTrans[0][0],0.,matUVTrans[1][0],\n\t0.,1.,0.,\n\tmatUVTrans[0][1],0.,matUVTrans[1][1]\n\t);\n\t\n\t/*\n\tmatTBNOff = mat3(0.,0.,1.,\n\t0.,1.,0.,\n\t-1.,0.,0.\n\t);\n\t*/\n\n    mat3 tsn = mat3( vWorldBin, normal, vWorldTan);\t\n    //normal = normalize(tsn * matTBNOff * detailNorm);\n\tnormal = normalize(tsn * detailNorm); //这个应该更正确。因为本身方向就是根据uv算的，如果是静态图片才需要转换。\n\t//vec4 normtex = texture2D( texNormal, vUv );\n    vec3 view   = -normalize(vViewDir);//view 是指向camera的\n    float NoV = saturate(dot( view, normal ));\n    //vec3 R = 2. * NoV * normal - view;\n\t\n#ifdef USE_FOAM\t\n\tvec4 foamc = (texture2D(texFoam,vUv*50.)+texture2D(texFoam,vUv*20.))/2.;\n\tfloat nearcoast = 1.-min(fDeep/10.,1.);// 1.-vWaterInfo.r;\n\tfloat foams = (nearcoast/4.+fFoam)*2.*nearcoast;\n#else\n\tfloat foams =0.;\n#endif\n\t\n\tvec3 R = reflect(-view,normal);\n\tvec4 wc = calcWaterC(view, normal,NoV,R, foams);\n\n\tgl_FragColor.rgb = wc.rgb;//normalize(detailNorm).rrr;//((normal)+vec3(0.0))/1.;//normalize(normal).rgb;//texture2D(texWaveDetail,vUv).rgb;// fracColor * texture2D(texUnderWater, vUv*20.0).rgb;// vec3(1.0);//pbrl.rgb;\n    gl_FragColor.a = 1.0;//wc.a;\n#ifdef USE_FOAM\n\tgl_FragColor.rgb = mix(gl_FragColor.rgb,vec3(1.),foamc.a*foams);\n\tgl_FragColor.a = foamc.r;\n#endif\n\t//if(mod(vUv.x*100.,1.0)<0.02 || mod(vUv.y*100.,1.0)<0.02) gl_FragColor.rgb=vec3(0.5,.5,.5);\n\t//gl_FragColor.rgb = detailNorm;\n}\n",a=ShaderCompile3D.add(_,t,e,n,i),WaterMaterial.SHADERDEFINE_CUBE_ENV=a.registerMaterialDefine("CUBE_ENV"),WaterMaterial.SHADERDEFINE_HDR_ENV=a.registerMaterialDefine("HDR_ENV"),WaterMaterial.SHADERDEFINE_SHOW_NORMAL=a.registerMaterialDefine("SHOW_NORMAL"),WaterMaterial.SHADERDEFINE_USEVERTEXHEIGHT=a.registerMaterialDefine("USE_VERTEX_DEEPINFO"),WaterMaterial.SHADERDEFINE_USE_FOAM=a.registerMaterialDefine("USE_FOAM"),WaterMaterial.SHADERDEFINE_USE_REFRACT_TEX=a.registerMaterialDefine("USE_REFR_TEX"),n={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshColor:1,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},i={u_Tintcolor:[2,1],u_TilingOffset:[3,1],u_texture:[1,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]};var u=Shader3D.nameKey.add("PARTICLESHURIKEN")
;t="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec4 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec4 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationMesh(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x=uv.x+totalULength-floorTotalULength;\n\t\tuv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x=uv.x+totalULength-floorTotalULength;\n\t\tuv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0){ \n\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t#endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,-1.0);\n\t    const vec3 sideVector = vec3(1.0,0.0,0.0);\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0)\n\t\t\t\t{\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t\tv_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef DIFFUSEMAP\n\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t\t\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset.xy+vec2(u_TilingOffset.z,-u_TilingOffset.w);//需要特殊处理\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t#endif\n    v_Discard=0.0;\n\t  \n\t#ifdef FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n}\n\n",
e="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\tif(v_Discard!=0.0)\n\t\t\tdiscard;\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",a=ShaderCompile3D.add(u,t,e,n,i),ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR=a.registerMaterialDefine("TINTCOLOR"),ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD=a.registerSpriteDefine("SPHERHBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=a.registerSpriteDefine("STRETCHEDBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=a.registerSpriteDefine("HORIZONTALBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=a.registerSpriteDefine("VERTICALBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME=a.registerSpriteDefine("COLOROVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerSpriteDefine("ROTATIONOVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH=a.registerSpriteDefine("RENDERMODE_MESH"),ShuriKenParticle3D.SHADERDEFINE_SHAPE=a.registerSpriteDefine("SHAPE"),n={a_Position:0,a_Texcoord0:2,a_Time:33},i={u_Texture:[1,1],u_Albedo:[2,1],u_Color:[3,1],u_CurrentTime:[2,2],u_Duration:[3,2],u_MvpMatrix:[1,2]};var c=Shader3D.nameKey.add("GLITTER");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",e="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\t\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",a=ShaderCompile3D.add(c,t,e,n,i),n={a_Position:0},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]};var d=Shader3D.nameKey.add("SkyBox");t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",e="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ShaderCompile3D.add(d,t,e,n,i),n={a_Position:0,a_Texcoord0:2},i={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]};var f=Shader3D.nameKey.add("SkyDome");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",e="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ShaderCompile3D.add(f,t,e,n,i),n={a_Position:0,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_NormalTexture:[1,1],u_DiffuseTexture1:[2,1],u_DiffuseTexture2:[3,1],u_DiffuseTexture3:[4,1],u_DiffuseTexture4:[5,1],u_DiffuseScale1:[6,1],u_DiffuseScale2:[7,1],u_DiffuseScale3:[8,1],u_DiffuseScale4:[9,1],u_MaterialDiffuse:[11,1],u_MaterialAmbient:[10,1],u_MaterialSpecular:[12,1],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var m=Shader3D.nameKey.add("Terrain");t="attribute vec4 a_Position;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nuniform mat4 u_MvpMatrix;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Texcoord0=a_Texcoord0;\n\tv_Texcoord1=a_Texcoord1;\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tv_Normal=a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n#endif\n\n#ifdef LIGHTMAP\n\t//这个地方使用a_Normal 并不是真的代表normal，其实凑巧法线图的uv正好是符合 light_Map的UV\n\tv_LightMapUV=vec2(a_Normal.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Normal.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1\n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n\n}",e='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\nuniform sampler2D u_NormalTexture;\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform vec2 u_DiffuseScale1;\nuniform vec2 u_DiffuseScale2;\nuniform vec2 u_DiffuseScale3;\nuniform vec2 u_DiffuseScale4;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n#ifdef DETAIL_NUM1\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz;\n#endif\n#ifdef DETAIL_NUM2\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-splatAlpha.r) + color2.xyz * splatAlpha.r;\n#endif\n#ifdef DETAIL_NUM3\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g)) + color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g;\n#endif\n#ifdef DETAIL_NUM4\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord1/u_DiffuseScale4);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g+splatAlpha.b))+ color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g + color4.xyz * splatAlpha.b;\n#endif\n\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = texture2D(u_NormalTexture,v_Normal.xy).xyz;\n\tnormal = normal*2.0 - vec3(1.0);\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n';var p=ShaderCompile3D.add(m,t,e,n,i);TerrainMaterial.SHADERDEFINE_DETAIL_NUM1=p.registerMaterialDefine("DETAIL_NUM1"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM2=p.registerMaterialDefine("DETAIL_NUM2"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM4=p.registerMaterialDefine("DETAIL_NUM4"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM3=p.registerMaterialDefine("DETAIL_NUM3"),n={a_Position:0,a_Normal:3,a_Texcoord0:2},i={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_DiffuseTexture1:[1,1],u_DiffuseTexture2:[2,1],u_DiffuseTexture3:[3,1],u_DiffuseTexture4:[4,1],u_DiffuseTexture5:[5,1],u_DiffuseScaleOffset1:[6,1],u_DiffuseScaleOffset2:[7,1],u_DiffuseScaleOffset3:[8,1],u_DiffuseScaleOffset4:[9,1],u_DiffuseScaleOffset5:[10,1],u_MaterialAlbedo:[14,1],u_MaterialDiffuse:[12,1],u_MaterialAmbient:[11,1],u_MaterialSpecular:[13,1],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var g=Shader3D.nameKey.add("ExtendTerrain");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n\tvarying float v_posViewZ;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}",e='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\nuniform vec3 u_MaterialAmbient;\nuniform vec4 u_MaterialAlbedo;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\t\t\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t\t//vec3 tColor= u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue + mix(vec3(0.15,0.15,0.15),vec3(0.0),shadowValue);\n\t\t\t//gl_FragColor.rgb*=tColor;\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_MaterialAlbedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor = vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n';var v=ShaderCompile3D.add(g,t,e,n,i);ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1=v.registerMaterialDefine("ExtendTerrain_DETAIL_NUM1"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2=v.registerMaterialDefine("ExtendTerrain_DETAIL_NUM2"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3=v.registerMaterialDefine("ExtendTerrain_DETAIL_NUM3"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4=v.registerMaterialDefine("ExtendTerrain_DETAIL_NUM4"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5=v.registerMaterialDefine("ExtendTerrain_DETAIL_NUM5")},t}(),SubMesh=function(){function t(t){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._indexInMesh=0,this._vertexBuffer=null,this._vertexStart=0,this._vertexCount=0,this._indexBuffer=null,this._indexStart=0,this._indexCount=0,this._indices=null,this._bufferUsage={},this._mesh=t,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}__class(t,"laya.d3.resource.models.SubMesh");var e=t.prototype;return Laya.imps(e,{"laya.resource.IDispose":!0,"laya.d3.core.render.IRenderable":!0}),e._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getStaticBatchBakedVertexs=function(e,n){var i,r,a=this._vertexBuffer,s=a.vertexDeclaration,o=s.getVertexElementByUsage(0).offset/4,l=s.getVertexElementByUsage(3).offset/4,h=n.meshRender.lightmapScaleOffset,_=0,u=0,c=0,d=0,f=0,m=0;if(h)if(r=s.getVertexElementByUsage(15))c=s.vertexStride/4,i=this._vertexCount>0?a.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):a.getData().slice(),d=r.offset/4;else{m=s.vertexStride/4,c=m+2,i=this._vertexCount?new Float32Array(this._vertexCount*(a.vertexDeclaration.vertexStride/4+2)):new Float32Array(a.vertexCount*(a.vertexDeclaration.vertexStride/4+2)),f=s.getVertexElementByUsage(2).offset/4,d=f+2;var p=a.getData();for(_=0,u=p.length/m;_<u;_++){var g=0;g=this._vertexCount>0?(this._vertexStart+_)*m:_*m;var v=_*c,x=0;for(x=0;x<d;x++)i[v+x]=p[g+x];for(x=d;x<m;x++)i[v+x+2]=p[g+x]}}else c=s.vertexStride/4,i=this._vertexCount?a.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):a.getData().slice();if(e){var S=e.worldMatrix,T=t._tempMatrix4x40;S.invert(T);var E=t._tempMatrix4x41,y=n.transform.worldMatrix;Matrix4x4.multiply(T,y,E)}else E=n.transform.worldMatrix;var M=t._tempQuaternion0;for(E.decomposeTransRotScale(t._tempVector30,M,t._tempVector31),_=0,u=i.length/c;_<u;_++){var D=_*c+o,C=_*c+l;if(Utils3D.transformVector3ArrayToVector3ArrayCoordinate(i,D,E,i,D),Utils3D.transformVector3ArrayByQuat(i,C,M,i,C),h){var R=_*c+d;if(r)Utils3D.transformLightingMapTexcoordByUV1Array(i,R,h,i,R);else{var A=_*m+f;Utils3D.transformLightingMapTexcoordByUV0Array(p,A,h,i,R)}}}return i},e._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(t){var e,n=0,i=t.renderElement;if(this._indexCount>1){var r=this._boneIndicesList.length;if(r>1){for(var a=0;a<r;a++)e=i._skinAnimationDatas||this._skinAnimationDatas,e&&(i._shaderValue.setValue(0,e[a]),t._shader.uploadRenderElementUniforms(i._shaderValue.data)),WebGL.mainContext.drawElements(4,this._subIndexBufferCount[a],5123,2*this._subIndexBufferStart[a]);Stat.drawCall+=r}else e=i._skinAnimationDatas||this._skinAnimationDatas,e&&(i._shaderValue.setValue(0,e[0]),t._shader.uploadRenderElementUniforms(i._shaderValue.data)),WebGL.mainContext.drawElements(4,this._indexCount,5123,2*this._indexStart),Stat.drawCall++;n=this._indexCount}else n=this._indexBuffer.indexCount,e=i._skinAnimationDatas||this._skinAnimationDatas,e&&(i._shaderValue.setValue(0,e[0]),t._shader.uploadRenderElementUniforms(i._shaderValue.data)),WebGL.mainContext.drawElements(4,n,5123,0),Stat.drawCall++;Stat.trianglesFaces+=n/3},e.getIndices=function(){return this._indexCount>0?this._indices:this._indexBuffer.getData()},e.dispose=function(){this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._vertexBuffer=null,this._indexBuffer=null},e._renderRuntime=function(t,e,n){e._material,e._sprite3D;t.drawSubmesh(e._conchSubmesh,0,4,0,this._indexBuffer.indexCount)},__getset(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),__getset(0,e,"_vertexBufferCount",function(){return 1}),__static(t,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempQuaternion0",function(){return this._tempQuaternion0=new Quaternion},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Matrix4x4}]),t}(),VertexPositionNormalColorTexture0Texture1=function(){function t(t,e,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r}__class(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){
return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15)])}]),t}(),DynamicBatchManager=function(){function t(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}__class(t,"laya.d3.graphics.DynamicBatchManager");var e=t.prototype;return e.getDynamicBatch=function(t,e){var n,i=t.id.toString()+e;return this._dynamicBatches[i]?n=this._dynamicBatches[i]:this._dynamicBatches[i]=n=new DynamicBatch(t),n},e._garbageCollection=function(){for(var t in this._dynamicBatches)0===this._dynamicBatches[t].combineRenderElementsCount&&delete this._dynamicBatches[t]},e._addPrepareRenderElement=function(t){this._prepareDynamicBatchCombineElements.push(t)},e._finishCombineDynamicBatch=function(e){this._prepareDynamicBatchCombineElements.sort(t._sortPrepareDynamicBatch);for(var n,i,r,a,s,o,l,h,_=-1,u=!0,c=0,d=-1,f=0,m=this._prepareDynamicBatchCombineElements.length;f<m;f++){s=this._prepareDynamicBatchCombineElements[f];var p=s.renderObj._getVertexBuffer(0).vertexDeclaration,g=i!==p;g&&(c=0,i=p);var v=c!==_;if(v&&(_=c),(g||v)&&(o=this.getDynamicBatch(p,c),n=null),u)if(o._addCombineRenderObjTest(s)){if(a=s._material,n!==a)l&&(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),l=a,d=o.combineRenderElementsCount,h=s,n=a;else if(l){var x=h.renderObj,S=s.renderObj;x._getVertexBuffer().vertexCount+S._getVertexBuffer().vertexCount>DynamicBatch.maxVertexCount||x._getIndexBuffer().indexCount+S._getIndexBuffer().indexCount>DynamicBatch.maxIndexCount?(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=a,d=o.combineRenderElementsCount,h=s):(o._addCombineMaterial(l),o._addMaterialToRenderElementOffset(d),o._addCombineRenderObj(h),l=null,h=null,d=-1,o._addCombineRenderObj(s))}else o._addCombineRenderObj(s);u=!0}else l&&(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),c++,u=!1;else r=this._prepareDynamicBatchCombineElements[f-1],o._addMaterialToRenderElementOffset(o.combineRenderElementsCount),n=r._material,o._addCombineMaterial(n),o._addCombineRenderObj(r),u=!0,a=s._material,n!==a?(l=a,d=o.combineRenderElementsCount,h=s):o._addCombineRenderObj(s),n=a}l&&(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),this._prepareDynamicBatchCombineElements.length=0},e._clearRenderElements=function(){for(var t in this._dynamicBatches)this._dynamicBatches[t]._clearRenderElements()},e._addToRenderQueue=function(t,e,n,i){for(var r in this._dynamicBatches){var a=this._dynamicBatches[r];a.combineRenderElementsCount>0&&a._addToRenderQueue(t,e,n,i)}},e.dispose=function(){this._dynamicBatches=null},t._sortPrepareDynamicBatch=function(t,e){return t._mainSortID-e._mainSortID},t}(),VertexPositionNormalColorTexture0Texture1SkinSTangent=function(){function t(t,e,n,i,r,a,s,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o}__class(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(104,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6),new VertexElement(88,"vector4",5)])}]),t}(),VertexPositionNormalTexture=function(){function t(t,e,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=n}__class(t,"laya.d3.graphics.VertexPositionNormalTexture");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(32,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2)])}]),t}(),VertexPositionNormalColorSkinSTangent=function(){function t(t,e,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(t,"laya.d3.graphics.VertexPositionNormalColorSkinSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector4",5)])}]),t}(),VertexPositionNormalTextureSkin=function(){function t(t,e,n,i,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate=n,this._blendIndex=i,this._blendWeight=r}__class(t,"laya.d3.graphics.VertexPositionNormalTextureSkin");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(64,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",7),new VertexElement(48,"vector4",6)])}]),t}(),VertexPositionNormalColorSkin=function(){function t(t,e,n,i,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=n,this._blendIndex=i,this._blendWeight=r}__class(t,"laya.d3.graphics.VertexPositionNormalColorSkin");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(72,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6)])}]),t}(),StaticBatch=function(){function t(t,e,n){this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=null,this._initBatchRenderElements=null,this._batchRenderElements=null,this._material=null,this._rootOwner=null,this._key=null,this._manager=null,this._key=t,this._manager=e,this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=[],this._initBatchRenderElements=[],this._batchRenderElements=[],this._rootOwner=n}__class(t,"laya.d3.graphics.StaticBatch");var e=t.prototype;return Laya.imps(e,{"laya.resource.IDispose":!0,"laya.d3.core.render.IRenderable":!0}),e._binarySearch=function(t){for(var e=0,n=this._batchRenderElements.length-1,i=0;e<=n;)i=parseInt((e+n)/2),this._compareBatchRenderElement(this._batchRenderElements[i],t)?n=i-1:e=i+1;return e},e._compareBatchRenderElement=function(t,e){throw new Error("StaticBatch:must override this function.")},e._getVertexDecLightMap=function(t){return t===VertexPositionNormalTextureSkinSTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1SkinSTangent.vertexDeclaration:t===VertexPositionNormalTextureSkin.vertexDeclaration?VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:t===VertexPositionNormalColorTextureSTangent.vertexDeclaration?VertexPositionNormalColorTexture0Texture1STangent.vertexDeclaration:t===VertexPositionNTBTexture.vertexDeclaration?null:t===VertexPositionNormalColorTexture.vertexDeclaration?VertexPositionNormalColorTexture0Texture1.vertexDeclaration:t===VertexPositionNormalTextureSTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1STangent.vertexDeclaration:t===VertexPositionNormalTexture.vertexDeclaration?VertexPositionNormalTexture0Texture1.vertexDeclaration:t===VertexPositionNormalTextureSkinTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration:t===VertexPositionNormalTextureSkin.vertexDeclaration?VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:t===VertexPositionNormalColorTextureTangent.vertexDeclaration?VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration:t===VertexPositionNTBTexture.vertexDeclaration?null:t===VertexPositionNormalColorTexture.vertexDeclaration?VertexPositionNormalColorTexture0Texture1.vertexDeclaration:t===VertexPositionNormalTextureTangent.vertexDeclaration?VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration:t===VertexPositionNormalTexture.vertexDeclaration?VertexPositionNormalTexture0Texture1.vertexDeclaration:t},e._getCombineRenderElementFromPool=function(){throw new Error("StaticBatch:must override this function.")},e._addBatchRenderElement=function(t){this._batchRenderElements.splice(this._binarySearch(t),0,t)},e._updateToRenderQueue=function(t,e){this._combineRenderElementPoolIndex=0,this._getRenderElement(t.getRenderQueue(this._material.renderQueue)._renderElements,t,e)},e._getRenderElement=function(t,e,n){throw new Error("StaticBatch:must override this function.")},e._finshInit=function(){throw new Error("StaticBatch:must override this function.")},e._clearRenderElements=function(){this._batchRenderElements.length=0},e.dispose=function(){},e._getVertexBuffer=function(t){return void 0===t&&(t=0),null},e._getIndexBuffer=function(){return null},e._beforeRender=function(t){return!0},e._render=function(t){},e._renderRuntime=function(t,e,n){},__getset(0,e,"triangleCount",function(){return 0}),__getset(0,e,"_vertexBufferCount",function(){return 1}),t.combine=function(t){console.log("StaticBatch: discard property,please use StaticBatchManager.combine() function instead."),StaticBatchManager.combine(t)},t.maxBatchVertexCount=65535,t}(),VertexPosition=function(){function t(t){this._position=null,this._position=t}__class(t,"laya.d3.graphics.VertexPosition");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(12,[new VertexElement(0,"vector3",0)])}]),t}(),VertexPositionNormalTextureSTangent=function(){function t(t,e,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=n,this._tangent=i}__class(t,"laya.d3.graphics.VertexPositionNormalTextureSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(48,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",5)])}]),t}(),VertexPositionNormalColorTexture0Texture1STangent=function(){function t(t,e,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a}__class(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1STangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(72,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",5)])}]),t}(),VertexPositionNormalColorTexture0Texture1Skin=function(){function t(t,e,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}__class(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6)])}]),t}(),VertexPositionNormalTexture0Texture1STangent=function(){function t(t,e,n,i,r){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r}__class(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1STangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",5)])}]),t}(),VertexPositionNormalColorSTangent=function(){function t(t,e,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._tangent=i}__class(t,"laya.d3.graphics.VertexPositionNormalColorSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",5)])}]),t}(),VertexPositionNormalColorTexture0Texture1SkinTangent=function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}__class(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0SkinTangent=function(t,e,n,i,r,a,s,o){this._position=t,this._normal=e,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(100,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6),new VertexElement(88,"vector3",5)])}]),t}(),VertexPositionNormalTextureSkinTangent=function(){function t(t,e,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(t,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(76,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",7),new VertexElement(48,"vector4",6),new VertexElement(64,"vector3",5)])}]),t}(),VertexElementFormat=function(){function t(){}return __class(t,"laya.d3.graphics.VertexElementFormat"),t.Single="single",t.Vector2="vector2",t.Vector3="vector3",t.Vector4="vector4",t.Color="color",t.Byte4="byte4",t.Short2="short2",t.Short4="short4",t.NormalizedShort2="normalizedshort2",t.NormalizedShort4="normalizedshort4",t.HalfVector2="halfvector2",t.HalfVector4="halfvector4",t}(),VertexPositionNormalColorTexture0Texture1Tangent=function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}__class(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0Tangent=function(t,e,n,i,r,a){this._position=t,this._normal=e,this._color=n,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a},__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(68,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector2",15),new VertexElement(56,"vector3",5)])}]),t}(),VertexPositionNormalTexture0Texture1SkinSTangent=function(){function t(t,e,n,i,r,a,s){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s}__class(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector4",5)])}]),t}(),VertexShurikenParticleBillboard=function(){function t(t,e,n,i,r,a,s,o,l,h,_,u,c,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=t,this._positionStartLifeTime=e,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=h,this._startSpeed=_,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}__class(t,"laya.d3.graphics.VertexShurikenParticleBillboard");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"simulationWorldPostion",function(){return this._simulationWorldPostion}),__getset(0,e,"time",function(){return this._time}),__getset(0,e,"startLifeTime",function(){return this._startLifeTime}),__getset(0,e,"startRotation2",function(){return this._startRotation2}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"startRotation1",function(){return this._startRotation1}),__getset(0,e,"random0",function(){return this._randoms0}),__getset(0,e,"startRotation0",function(){return this._startRotation0}),__getset(0,e,"startSize",function(){return this._startSize}),__getset(0,e,"random1",function(){return this._randoms1}),__getset(0,e,"startColor",function(){return this._startColor}),__getset(0,e,"startSpeed",function(){return this._startSpeed}),__getset(0,e,"velocity",function(){return this._velocity}),__getset(0,e,"positionStartLifeTime",function(){return this._positionStartLifeTime}),__getset(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(152,[new VertexElement(0,"vector4",17),new VertexElement(16,"vector4",30),new VertexElement(32,"vector4",32),new VertexElement(48,"vector4",19),new VertexElement(64,"vector3",20),new VertexElement(76,"vector3",22),new VertexElement(88,"single",31),new VertexElement(92,"vector4",34),new VertexElement(108,"vector4",35),new VertexElement(124,"vector3",36),new VertexElement(136,"vector4",37)])}]),t}(),VertexPositionNormalTextureTangent=function(){function t(t,e,n,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=n,this._tangent=i}__class(t,"laya.d3.graphics.VertexPositionNormalTextureTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(44,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector3",5)])}]),t}(),VertexPositionNormal=function(){function t(t,e){this._position=null,this._normal=null,this._position=t,this._normal=e}__class(t,"laya.d3.graphics.VertexPositionNormal");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(24,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3)])}]),t}(),VertexPositionNormalColorTextureSkinSTangent=function(){function t(t,e,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s}__class(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkinSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(96,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",7),new VertexElement(64,"vector4",6),new VertexElement(80,"vector4",5)])}]),t}(),VertexPositionNormalColorTangent=function(){function t(t,e,n,i){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._tangent=i}__class(t,"laya.d3.graphics.VertexPositionNormalColorTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(52,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector3",5)])}]),t}(),VertexPositionNormalColorSkinTangent=function(){function t(t,e,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,
this._position=t,this._normal=e,this._color=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(t,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(84,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector3",5)])}]),t}(),VertexPositionTerrain=function(){function t(t,e,n,i){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=t,this._normal=e,this._textureCoord0=n,this._textureCoord1=i}__class(t,"laya.d3.graphics.VertexPositionTerrain");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoord1",function(){return this._textureCoord1}),__getset(0,e,"textureCoord0",function(){return this._textureCoord0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15)])}]),t}(),StaticBatchManager=function(){function t(){this._initBatchRenderElements=null,this._staticBatches=null,this._initBatchRenderElements=[],this._staticBatches={}}__class(t,"laya.d3.graphics.StaticBatchManager");var e=t.prototype;return e._finshInit=function(){for(var t in this._staticBatches)this._staticBatches[t]._finshInit();this._initBatchRenderElements.length=0},e._initStaticBatchs=function(t){throw new Error("StaticBatchManager:must override this function.")},e._addInitBatchSprite=function(t){for(var e=t._render._renderElements,n=0,i=e.length;n<i;n++)this._initBatchRenderElements.push(e[n])},e._clearRenderElements=function(){for(var t in this._staticBatches)this._staticBatches[t]._clearRenderElements()},e._garbageCollection=function(t){var e=t._staticBatch,n=e._initBatchRenderElements,i=n.indexOf(t);n.splice(i,1),0===n.length&&(e.dispose(),delete this._staticBatches[e._key])},e._addToRenderQueue=function(t,e,n,i){for(var r in this._staticBatches){var a=this._staticBatches[r];a._batchRenderElements.length>0&&a._updateToRenderQueue(t,i)}},e.dispose=function(){this._staticBatches=null},t._addToRenderQueueStaticBatch=function(e){e instanceof laya.d3.core.RenderableSprite3D&&e._addToInitStaticBatchManager();for(var n=0,i=e.numChildren;n<i;n++)t._addToRenderQueueStaticBatch(e._childs[n])},t.combine=function(e,n){var i,r=0,a=0;if(n)for(r=0,a=n.length;r<a;r++){var s=n[r];s._addToInitStaticBatchManager()}else e&&t._addToRenderQueueStaticBatch(e);for(r=0,a=t._staticBatchManagers.length;r<a;r++)i=t._staticBatchManagers[r],i._initStaticBatchs(e),i._finshInit()},t._staticBatchManagers=[],t}(),VertexPositionNormalColorTexture=function(){function t(t,e,n,i){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate=i}__class(t,"laya.d3.graphics.VertexPositionNormalColorTexture");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(48,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2)])}]),t}(),VertexGlitter=function(){function t(t,e,n){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=t,this._textureCoordinate0=e,this._time=n}__class(t,"laya.d3.graphics.VertexGlitter");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"time",function(){return this._time}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate0}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(24,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector2",2),new VertexElement(20,"single",33)])}]),t}(),VertexPositionNormalSTangent=function(){function t(t,e,n){this._position=null,this._normal=null,this._tangent=null,this._position=t,this._normal=e,this._tangent=n}__class(t,"laya.d3.graphics.VertexPositionNormalSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",5)])}]),t}(),FrustumCulling=function(){function t(){}return __class(t,"laya.d3.graphics.FrustumCulling"),t.renderShadowObjectCulling=function(t,e,n,i,r){var a=0,s=0,o=0,l=0;for(a=0,o=n.length;a<o;a++){var h=n[a];h&&h._clearRenderElements()}var _,u,c,d=t._cullingRenders;if(r>1){for(a=0,o=t._cullingRendersLength;a<o;a++)if(_=d[a],_.castShadow&&Layer.isVisible(_._owner.layer.mask)&&_.enable)for(var f=1,m=e.length;f<m;f++)if(u=n[f-1],0!==e[f].containsBoundSphere(_.boundingSphere))for(c=_._renderElements,s=0,l=c.length;s<l;s++)u._addRenderElement(c[s])}else for(a=0,o=t._cullingRendersLength;a<o;a++)if(_=d[a],_.castShadow&&Layer.isVisible(_._owner.layer.mask)&&_.enable&&0!==e[0].containsBoundSphere(_.boundingSphere))for(_._renderUpdate(i),u=n[0],c=_._renderElements,s=0,l=c.length;s<l;s++)u._addRenderElement(c[s])},t.renderShadowObjectCullingOctree=function(t,e,n,i,r){for(var a=0,s=n.length;a<s;a++){var o=n[a];o&&o._clearRenderElements()}r>1?t.treeRoot.cullingShadowObjects(e,n,!0,0,t):t.treeRoot.cullingShadowObjectsOnePSSM(e[0],n,i,!0,0,t)},t.renderObjectCulling=function(t,e,n,i,r,a){var s=0,o=0,l=0,h=0,_=e._quenes,u=e._dynamicBatchManager,c=e._cullingRenders;for(s=0,o=_.length;s<o;s++){var d=_[s];d&&d._clearRenderElements()}var f=StaticBatchManager._staticBatchManagers;for(s=0,o=f.length;s<o;s++)f[s]._clearRenderElements();u._clearRenderElements();var m=n.transform.position;for(s=0,o=e._cullingRendersLength;s<o;s++){var p=c[s];if(Layer.isVisible(p._owner.layer.mask)&&p.enable&&0!==t.containsBoundSphere(p.boundingSphere)){p._renderUpdate(a),p._distanceForSort=Vector3.distance(p.boundingSphere.center,m)+p.sortingFudge;var g=p._renderElements;for(l=0,h=g.length;l<h;l++){var v=g[l],x=v._staticBatch;if(x&&x._material===v._material)x._addBatchRenderElement(v);else{var S=v.renderObj;S.triangleCount<10&&1===S._vertexBufferCount&&S._getIndexBuffer()&&v._material.renderQueue<2&&v._canDynamicBatch&&!p._owner.isStatic?u._addPrepareRenderElement(v):e.getRenderQueue(v._material.renderQueue)._addRenderElement(v)}}}}for(s=0,o=f.length;s<o;s++)f[s]._addToRenderQueue(e,i,r,a);u._finishCombineDynamicBatch(e),u._addToRenderQueue(e,i,r,a)},t.renderObjectCullingOctree=function(t,e,n,i,r,a){var s=0,o=0,l=e._quenes,h=e._dynamicBatchManager;for(s=0,o=l.length;s<o;s++){var _=l[s];_&&_._clearRenderElements()}var u=StaticBatchManager._staticBatchManagers;for(s=0,o=u.length;s<o;s++)u[s]._clearRenderElements();for(h._clearRenderElements(),e._cullingRenders.length=0,e.treeRoot.cullingObjects(t,!0,0,n.transform.position,a),s=0,o=u.length;s<o;s++)u[s]._addToRenderQueue(e,i,r,a);h._finishCombineDynamicBatch(e),h._addToRenderQueue(e,i,r,a)},t.renderObjectCullingNoBoundFrustum=function(t,e,n,i,r){var a=0,s=0,o=0,l=0,h=t._quenes,_=t._dynamicBatchManager,u=t._cullingRenders;for(a=0,s=h.length;a<s;a++){var c=h[a];c&&c._clearRenderElements()}var d=StaticBatchManager._staticBatchManagers;for(a=0,s=d.length;a<s;a++)d[a]._clearRenderElements();_._clearRenderElements();var f=e.transform.position;for(a=0,s=t._cullingRendersLength;a<s;a++){var m=u[a];if(Layer.isVisible(m._owner.layer.mask)&&m.enable){m._renderUpdate(r),m._distanceForSort=Vector3.distance(m.boundingSphere.center,f)+m.sortingFudge;var p=m._renderElements;for(o=0,l=p.length;o<l;o++){var g=p[o],v=g._staticBatch;if(v&&v._material===g._material)v._addBatchRenderElement(g);else{var x=g.renderObj;x.triangleCount<10&&1===x._vertexBufferCount&&x._getIndexBuffer()&&g._material.renderQueue<2&&g._canDynamicBatch&&!m._owner.isStatic?_._addPrepareRenderElement(g):t.getRenderQueue(g._material.renderQueue)._addRenderElement(g)}}}}for(a=0,s=d.length;a<s;a++)d[a]._addToRenderQueue(t,n,i,r);_._finishCombineDynamicBatch(t),_._addToRenderQueue(t,n,i,r)},t}(),VertexPositionNormalTexture0Texture1=function(){function t(t,e,n,i){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=i}__class(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15)])}]),t}(),VertexElement=function(){function t(t,e,n){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=t,this.elementFormat=e,this.elementUsage=n}return __class(t,"laya.d3.graphics.VertexElement"),t}(),VertexPositionNormalColorTextureSkin=function(){function t(t,e,n,i,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate=i,this._blendIndex=r,this._blendWeight=a}__class(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(80,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",7),new VertexElement(64,"vector4",6)])}]),t}(),VertexPositionNormalColorTextureSTangent=function(){function t(t,e,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate=i,this._tangent=r}__class(t,"laya.d3.graphics.VertexPositionNormalColorTextureSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(64,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",5)])}]),t}(),VertexPositionNormalColorTextureTangent=function(){function t(t,e,n,i,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate=i,this._tangent=r}__class(t,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(60,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector3",5)])}]),t}(),VertexPositionNormalColor=function(){function t(t,e,n){this._position=null,this._normal=null,this._color=null,this._position=t,this._normal=e,this._color=n}__class(t,"laya.d3.graphics.VertexPositionNormalColor");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1)])}]),t}(),VertexShurikenParticleMesh=function(){function t(t,e,n,i,r,a,s,o,l,h,_,u,c,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=t,this._positionStartLifeTime=e,this._velocity=n,this._startColor=i,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=h,this._startSpeed=_,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}__class(t,"laya.d3.graphics.VertexShurikenParticleMesh");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"simulationWorldPostion",function(){return this._simulationWorldPostion}),__getset(0,e,"time",function(){return this._time}),__getset(0,e,"startLifeTime",function(){return this._startLifeTime}),__getset(0,e,"startRotation2",function(){return this._startRotation2}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"startRotation1",function(){return this._startRotation1}),__getset(0,e,"random0",function(){return this._randoms0}),__getset(0,e,"startRotation0",function(){return this._startRotation0}),__getset(0,e,"startSize",function(){return this._startSize}),__getset(0,e,"velocity",function(){return this._velocity}),__getset(0,e,"startSpeed",function(){return this._startSpeed}),__getset(0,e,"position",function(){return this._positionStartLifeTime}),__getset(0,e,"random1",function(){return this._randoms1}),__getset(0,e,"startColor",function(){return this._startColor}),__getset(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(172,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector4",1),new VertexElement(28,"vector2",2),new VertexElement(36,"vector4",30),new VertexElement(52,"vector4",32),new VertexElement(68,"vector4",19),new VertexElement(84,"vector3",20),new VertexElement(96,"vector3",22),new VertexElement(108,"single",31),new VertexElement(112,"vector4",34),new VertexElement(128,"vector4",35),new VertexElement(144,"vector3",36),new VertexElement(156,"vector4",37)])}]),t}(),VertexPositionTexture0=function(){function t(t,e){this._position=null,this._textureCoordinate0=null,this._position=t,this._textureCoordinate0=e}__class(t,"laya.d3.graphics.VertexPositionTexture0");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(20,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector2",2)])}]),t}(),VertexPositionNTBTexture=function(){function t(t,e,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=n}__class(t,"laya.d3.graphics.VertexPositionNTBTexture");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(56,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5),new VertexElement(36,"vector3",4),new VertexElement(48,"vector2",2)])}]),t}(),VertexDeclaration=function(){function t(e,n){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._conchVertexDeclaration=null,this._id=++t._uniqueIDCounter,this._id>t.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",t.maxVertexDeclaration);this._shaderValues=new ValusArray,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=n,Render.isConchNode&&(this._conchVertexDeclaration=new ConchVertexDeclare);for(var i=0;i<n.length;i++){var r=n[i],a=r.elementUsage;this._vertexElementsDic[a]=r;var s=[t._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];switch(this._shaderValues.setValue(a,s),a){case 1:this._addShaderDefine(ShaderCompile3D.SHADERDEFINE_COLOR);break;case 2:this._addShaderDefine(ShaderCompile3D.SHADERDEFINE_UV0);break;case 15:this._addShaderDefine(ShaderCompile3D.SHADERDEFINE_UV1)}}if(Render.isConchNode){for(var o=[],l=0,h=n.length;l<h;l++){var _=n[l];switch(_.elementFormat){case"vector2":o.push({offset:_.offset,elementFormat:35664,elementUsage:_.elementUsage});break;case"vector3":o.push({offset:_.offset,elementFormat:35665,elementUsage:_.elementUsage});break;case"vector4":o.push({offset:_.offset,elementFormat:35666,elementUsage:_.elementUsage})}}this._conchVertexDeclaration.setDelcare(o)}}__class(t,"laya.d3.graphics.VertexDeclaration");var e=t.prototype;return e._addShaderDefine=function(t){this._shaderDefineValue|=t,this._conchVertexDeclaration&&this._conchVertexDeclaration.addShaderDefine(t)},e._removeShaderDefine=function(t){this._shaderDefineValue&=~t,this._conchVertexDeclaration&&this._conchVertexDeclaration.removeShaderDefine(t)},e.getVertexElements=function(){return this._vertexElements.slice()},e.getVertexElementByUsage=function(t){return this._vertexElementsDic[t]},e.unBinding=function(){},__getset(0,e,"shaderValues",function(){return this._shaderValues}),__getset(0,e,"shaderDefineValue",function(){return this._shaderDefineValue}),__getset(0,e,"vertexStride",function(){return this._vertexStride}),__getset(0,e,"id",function(){return this._id}),t._getTypeSize=function(t){switch(t){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":case"byte4":case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},t.getVertexStride=function(e){for(var n=0,i=0;i<e.Length;i++){var r=e[i],a=r.offset+t._getTypeSize(r.elementFormat);n<a&&(n=a)}return n},t._maxVertexDeclarationBit=1e3,t._uniqueIDCounter=1,__static(t,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),t}(),VertexPositionNTBTextureSkin=function(){function t(t,e,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=n}__class(t,"laya.d3.graphics.VertexPositionNTBTextureSkin");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(88,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5),new VertexElement(36,"vector3",4),new VertexElement(48,"vector2",2),new VertexElement(56,"vector4",7),new VertexElement(72,"vector4",6)])}]),t}(),VertexPositionNormalTexture0Texture1Skin=function(){function t(t,e,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=i,this._blendIndex=r,this._blendWeight=a}__class(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(72,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6)])}]),t}(),VertexPositionNormalTextureSkinSTangent=function(){function t(t,e,n,i,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=n,this._tangent=i,this._blendIndex=r,this._blendWeight=a}__class(t,"laya.d3.graphics.VertexPositionNormalTextureSkinSTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(80,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector4",7),new VertexElement(48,"vector4",6),new VertexElement(64,"vector4",5)])}]),t}(),VertexPositionNormalColorTextureSkinTangent=function(){function t(t,e,n,i,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=n,this._textureCoordinate=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s}__class(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"textureCoordinate",function(){return this._textureCoordinate}),__getset(0,e,"color",function(){return this._color}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(92,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector4",1),new VertexElement(40,"vector2",2),new VertexElement(48,"vector4",7),new VertexElement(64,"vector4",6),new VertexElement(80,"vector3",5)])}]),t}(),VertexPositionNTBTexture0Texture1Skin=function(){function t(t,e,n,i,r,a,s,o){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this.binormal=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=r,this._tangent=a,n=n,this._blendIndex=s,this._blendWeight=o}__class(t,"laya.d3.graphics.VertexPositionNTBTexture0Texture1Skin");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(96,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5),new VertexElement(36,"vector3",4),new VertexElement(48,"vector2",2),new VertexElement(56,"vector2",15),new VertexElement(64,"vector4",7),new VertexElement(80,"vector4",6)])}]),t}(),VertexElementUsage=function(){function t(){}return __class(t,"laya.d3.graphics.VertexElementUsage"),t.POSITION0=0,t.COLOR0=1,t.TEXTURECOORDINATE0=2,t.NORMAL0=3,t.BINORMAL0=4,t.TANGENT0=5,t.BLENDINDICES0=6,t.BLENDWEIGHT0=7,t.DEPTH0=8,t.FOG0=9,t.POINTSIZE0=10,t.SAMPLE0=11,t.TESSELLATEFACTOR0=12,t.COLOR1=13,t.NEXTTEXTURECOORDINATE0=14,t.TEXTURECOORDINATE1=15,t.NEXTTEXTURECOORDINATE1=16,t.CORNERTEXTURECOORDINATE0=17,t.VELOCITY0=18,t.STARTCOLOR0=19,t.STARTSIZE=20,t.AGEADDSCALE0=21,t.STARTROTATION=22,t.ENDCOLOR0=23,t.STARTLIFETIME=24,t.TIME0=33,t.SHAPEPOSITIONSTARTLIFETIME=30,t.DIRECTIONTIME=32,t.SIZEROTATION0=27,t.RADIUS0=28,t.RADIAN0=29,t.STARTSPEED=31,t.RANDOM0=34,t.RANDOM1=35,t.SIMULATIONWORLDPOSTION=36,t.SIMULATIONWORLDROTATION=37,t}(),VertexPositionNormalTexture0Texture1Tangent=function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}__class(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0Tangent=function(t,e,n,i,r){this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r},__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(52,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector3",5)])}]),t}(),DynamicBatch=function(){function t(t){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=t}__class(t,"laya.d3.graphics.DynamicBatch");var e=t.prototype;return Laya.imps(e,{
"laya.d3.core.render.IRenderable":!0}),e._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getCombineRenderElementFromPool=function(t,e,n){var i=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return i||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=i=new RenderElement,i._sprite3D=new MeshSprite3D),i._sprite3D._render._renderUpdate(n),i},e._getRenderElement=function(e,n,i){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*t.maxVertexCount),this._indexDatas=new Uint16Array(t.maxIndexCount),this._vertexBuffer=VertexBuffer3D.create(this._vertexDeclaration,t.maxVertexCount,35048),this._indexBuffer=IndexBuffer3D.create("ushort",t.maxIndexCount,35048)),this._merageElements.length=0;for(var r=0,a=0,s=0,o=this._combineRenderElements.length;s<o;s++){var l=this._combineRenderElements[s],h=l.getDynamicBatchBakedVertexs(0),_=l.getBakedIndices(),u=l._sprite3D.transform._isFrontFaceInvert,c=r/(this._vertexDeclaration.vertexStride/4),d=a,f=d+_.length;l._tempBatchIndexStart=d,l._tempBatchIndexEnd=f,this._indexDatas.set(_,a);var m=0;if(u)for(m=d;m<f;m+=3){this._indexDatas[m]=c+this._indexDatas[m];var p=this._indexDatas[m+1],g=this._indexDatas[m+2];this._indexDatas[m+1]=c+g,this._indexDatas[m+2]=c+p}else for(m=d;m<f;m+=3)this._indexDatas[m]=c+this._indexDatas[m],this._indexDatas[m+1]=c+this._indexDatas[m+1],this._indexDatas[m+2]=c+this._indexDatas[m+2];a+=_.length,this._vertexDatas.set(h,r),r+=h.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),this._combineRenderElementPoolIndex=0,s=0,o=this._materials.length;s<o;s++){var v=this._getCombineRenderElementFromPool(e,n,i);v._type=2,v._staticBatch=null,v.renderObj=this;var x=this._combineRenderElements[this._materialToRenderElementsOffsets[s]]._tempBatchIndexStart,S=s+1===this._materialToRenderElementsOffsets.length?a:this._combineRenderElements[this._materialToRenderElementsOffsets[s+1]]._tempBatchIndexStart;v._tempBatchIndexStart=x,v._tempBatchIndexEnd=S,v._material=this._materials[s],this._merageElements.push(v)}},e._addCombineRenderObjTest=function(e){var n=e.renderObj,i=this._currentCombineIndexCount+n._getIndexBuffer().indexCount;return!(this._currentCombineVertexCount+n._getVertexBuffer().vertexCount>t.maxVertexCount||i>t.maxIndexCount)},e._addCombineRenderObj=function(t){var e=t.renderObj;this._combineRenderElements.push(t),this._currentCombineIndexCount=this._currentCombineIndexCount+e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+e._getVertexBuffer().vertexCount},e._addCombineMaterial=function(t){this._materials.push(t)},e._addMaterialToRenderElementOffset=function(t){this._materialToRenderElementsOffsets.push(t)},e._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},e._addToRenderQueue=function(t,e,n,i){this._getRenderElement(e,n,i);for(var r=0,a=this._materials.length;r<a;r++)t.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},e._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(t){var e=t._batchIndexEnd-t._batchIndexStart;WebGL.mainContext.drawElements(4,e,5123,2*t._batchIndexStart),Stat.drawCall++,Stat.trianglesFaces+=e/3},e._renderRuntime=function(t,e,n){},__getset(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),__getset(0,e,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),__getset(0,e,"_vertexBufferCount",function(){return 1}),t.maxVertexCount=2e4,t.maxIndexCount=4e4,t.maxCombineTriangleCount=10,t}(),VertexPositionNormalTangent=function(){function t(t,e,n){this._position=null,this._normal=null,this._tangent=null,this._position=t,this._normal=e,this._tangent=n}__class(t,"laya.d3.graphics.VertexPositionNormalTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(36,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector3",5)])}]),t}(),VertexPositionNormalTexture0Texture1SkinTangent=function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}__class(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var e=t.prototype;return Laya.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0SkinTangent=function(t,e,n,i,r,a,s){this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=i,this._tangent=r,this._blendIndex=a,this._blendWeight=s},__getset(0,e,"tangent",function(){return this._tangent}),__getset(0,e,"blendIndex",function(){return this._blendIndex}),__getset(0,e,"blendWeight",function(){return this._blendWeight}),__getset(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,e,"normal",function(){return this._normal}),__getset(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),__getset(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),__getset(0,e,"position",function(){return this._position}),__getset(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),__static(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(84,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",3),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",15),new VertexElement(40,"vector4",7),new VertexElement(56,"vector4",6),new VertexElement(72,"vector3",5)])}]),t}(),MeshReader=function(){function t(){}return __class(t,"laya.d3.loaders.MeshReader"),t.read=function(e,n,i,r,a){var s=new Byte(e);s.pos=0;var o=s.readUTFString();switch(o){case"LAYAMODEL:01":case"LAYASKINANI:01":t._readVersion01(s,o,n,i,r,a);break;case"LAYAMODEL:02":LoadModelV02.parse(s,o,n,i,r,a);break;case"LAYAMODEL:03":case"LAYAMODEL:0301":LoadModelV03.parse(s,o,n,r,a);break;default:throw new Error("MeshReader: unknown mesh version.")}n._setSubMeshes(r)},t._readVersion01=function(t,e,n,i,r,a){new LoadModelV01(t,e,n,i,r,a)},t}(),LoadModelV02=function(){function t(){}return __class(t,"laya.d3.loaders.LoadModelV02"),t.parse=function(e,n,i,r,a,s){t._mesh=i,t._materials=r,t._subMeshes=a,t._materialMap=s,t._version=n,t._readData=e,t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var o=0,l=t._BLOCK.count;o<l;o++){t._readData.pos=t._BLOCK.blockStarts[o];var h=t._readData.getUint16(),_=t._strings[h],u=t["READ_"+_];if(null==u)throw new Error("model file err,no this function:"+h+" "+_);u.call()}t._strings.length=0,t._readData=null,t._version=null,t._mesh=null,t._materials=null,t._subMeshes=null,t._materialMap=null},t._readString=function(){return t._strings[t._readData.getUint16()]},t.READ_DATA=function(){t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._readData.getUint16(),n=t._BLOCK.blockStarts=[],i=t._BLOCK.blockLengths=[],r=0;r<e;r++)n.push(t._readData.getUint32()),i.push(t._readData.getUint32())},t.READ_STRINGS=function(){var e=t._readData.getUint32(),n=t._readData.getUint16(),i=t._readData.pos;t._readData.pos=e+t._DATA.offset;for(var r=0;r<n;r++)t._strings[r]=t._readData.readUTFString();t._readData.pos=i},t.READ_MATERIAL=function(){var e=(t._readString(),t._readString(),t._readString());return""!==e&&t._materials.push(Loader.getRes(t._materialMap[e])),!0},t.READ_MESH=function(){var e=(t._readString(),t._readData.__getBuffer()),n=0,i=0,r=t._readData.getInt16(),a=t._DATA.offset;for(n=0;n<r;n++){var s=a+t._readData.getUint32(),o=t._readData.getUint32(),l=new Float32Array(e.slice(s,s+o)),h=t._readString(),_=h.match(t._attrReg),u=t._getVertexDeclaration(_),c=VertexBuffer3D.create(u,4*l.length/u.vertexStride,35044,!0);c.setData(l),t._mesh._vertexBuffers.push(c)}var d=a+t._readData.getUint32(),f=t._readData.getUint32(),m=new Uint16Array(e.slice(d,d+f)),p=IndexBuffer3D.create("ushort",f/2,35044,!0);p.setData(m),t._mesh._indexBuffer=p;var g=t._mesh._boneNames=[],v=t._readData.getUint16();for(g.length=v,n=0;n<v;n++)g[n]=t._strings[t._readData.getUint16()];var x=t._readData.getUint32(),S=t._readData.getUint32(),T=(new Float32Array(e.slice(a+x,a+x+S)),t._readData.getUint32()),E=t._readData.getUint32(),y=new Float32Array(e.slice(a+T,a+T+E));for(t._mesh._inverseBindPoses=[],n=0,i=y.length;n<i;n+=16){var M=new Matrix4x4(y[n+0],y[n+1],y[n+2],y[n+3],y[n+4],y[n+5],y[n+6],y[n+7],y[n+8],y[n+9],y[n+10],y[n+11],y[n+12],y[n+13],y[n+14],y[n+15]);t._mesh._inverseBindPoses.push(M)}return!0},t.READ_SUBMESH=function(){var e=t._readData.__getBuffer(),n=new SubMesh(t._mesh),i=t._readData.getInt16(),r=t._readData.getUint32(),a=t._readData.getUint32();n._vertexBuffer=t._mesh._vertexBuffers[i],n._vertexStart=r,n._vertexCount=a;var s=t._readData.getUint32(),o=t._readData.getUint32(),l=t._mesh._indexBuffer;n._indexBuffer=l,n._indexStart=s,n._indexCount=o,n._indices=new Uint16Array(l.getData().buffer,2*s,o);var h=t._DATA.offset,_=n._subIndexBufferStart,u=n._subIndexBufferCount,c=n._boneIndicesList,d=t._readData.getUint16();_.length=d,u.length=d,c.length=d;for(var f=0;f<d;f++){_[f]=t._readData.getUint32(),u[f]=t._readData.getUint32();var m=t._readData.getUint32(),p=t._readData.getUint32();n._boneIndicesList[f]=new Uint8Array(e.slice(h+m,h+m+p))}return t._subMeshes.push(n),!0},t._getVertexDeclaration=function(t){for(var e=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=!1,h=!1,_=0;_<t.length;_++)switch(t[_]){case"POSITION":e=!0;break;case"NORMAL":n=!0;break;case"COLOR":i=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":o=!0;break;case"BLENDINDICES":l=!0;break;case"TANGENT":s=!0;break;case"BINORMAL":h=!0}var u;return e&&n&&i&&r&&a&&o&&l&&s?u=VertexPositionNormalColorTexture0Texture1SkinTangent.vertexDeclaration:e&&n&&i&&r&&a&&o&&l?u=VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration:e&&n&&r&&a&&o&&l&&s?u=VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration:e&&n&&r&&a&&o&&l?u=VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:e&&n&&i&&r&&o&&l&&s?u=VertexPositionNormalColorTextureSkinTangent.vertexDeclaration:e&&n&&i&&r&&o&&l?u=VertexPositionNormalColorTextureSkin.vertexDeclaration:e&&n&&r&&o&&l&&s?u=VertexPositionNormalTextureSkinTangent.vertexDeclaration:e&&n&&r&&o&&l?u=VertexPositionNormalTextureSkin.vertexDeclaration:e&&n&&i&&o&&l&&s?u=VertexPositionNormalColorSkinTangent.vertexDeclaration:e&&n&&i&&o&&l?u=VertexPositionNormalColorSkin.vertexDeclaration:e&&n&&i&&r&&a&&s?u=VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration:e&&n&&i&&r&&a?u=VertexPositionNormalColorTexture0Texture1.vertexDeclaration:e&&n&&r&&a&&s?u=VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration:e&&n&&r&&a?u=VertexPositionNormalTexture0Texture1.vertexDeclaration:e&&n&&i&&r&&s?u=VertexPositionNormalColorTextureTangent.vertexDeclaration:e&&n&&r&&s&&h?u=VertexPositionNTBTexture.vertexDeclaration:e&&n&&i&&r?u=VertexPositionNormalColorTexture.vertexDeclaration:e&&n&&r&&s?u=VertexPositionNormalTextureTangent.vertexDeclaration:e&&n&&r?u=VertexPositionNormalTexture.vertexDeclaration:e&&n&&i&&s?u=VertexPositionNormalColorTangent.vertexDeclaration:e&&n&&i&&(u=VertexPositionNormalColor.vertexDeclaration),u},t._attrReg=new RegExp("(\\w+)|([:,;])","g"),t._strings=[],t._readData=null,t._version=null,t._mesh=null,t._materials=null,t._subMeshes=null,t._materialMap=null,__static(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),LoadModelV03=function(){function t(){}return __class(t,"laya.d3.loaders.LoadModelV03"),t.parse=function(e,n,i,r,a){t._mesh=i,t._subMeshes=r,t._materialMap=a,t._version=n,t._readData=e,t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var s=0,o=t._BLOCK.count;s<o;s++){t._readData.pos=t._BLOCK.blockStarts[s];var l=t._readData.getUint16(),h=t._strings[l],_=t["READ_"+h];if(null==_)throw new Error("model file err,no this function:"+l+" "+h);_.call()}t._strings.length=0,t._readData=null,t._version=null,t._mesh=null,t._subMeshes=null,t._materialMap=null},t._readString=function(){return t._strings[t._readData.getUint16()]},t.READ_DATA=function(){t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._readData.getUint16(),n=t._BLOCK.blockStarts=[],i=t._BLOCK.blockLengths=[],r=0;r<e;r++)n.push(t._readData.getUint32()),i.push(t._readData.getUint32())},t.READ_STRINGS=function(){var e=t._readData.getUint32(),n=t._readData.getUint16(),i=t._readData.pos;t._readData.pos=e+t._DATA.offset;for(var r=0;r<n;r++)t._strings[r]=t._readData.readUTFString();t._readData.pos=i},t.READ_MESH=function(){var e=(t._readString(),t._readData.__getBuffer()),n=0,i=0,r=t._readData.getInt16(),a=t._DATA.offset;for(n=0;n<r;n++){var s,o=a+t._readData.getUint32(),l=t._readData.getUint32(),h=new Float32Array(e.slice(o,o+l)),_=t._readString();switch(t._version){case"LAYAMODEL:03":s=t._vertexDeclarationMap_Discard[_];break;case"LAYAMODEL:0301":s=t._vertexDeclarationMap[_];break;default:throw new Error("LoadModelV03: unknown version.")}if(!s)throw new Error("LoadModelV03: unknown vertexDeclaration.");var u=VertexBuffer3D.create(s,4*h.length/s.vertexStride,35044,!0);u.setData(h),t._mesh._vertexBuffers.push(u)}var c=a+t._readData.getUint32(),d=t._readData.getUint32(),f=new Uint16Array(e.slice(c,c+d)),m=IndexBuffer3D.create("ushort",d/2,35044,!0);m.setData(f),t._mesh._indexBuffer=m;var p=t._mesh._boneNames=[],g=t._readData.getUint16();for(p.length=g,n=0;n<g;n++)p[n]=t._strings[t._readData.getUint16()];t._readData.pos+=8;var v=t._readData.getUint32(),x=t._readData.getUint32(),S=new Float32Array(e.slice(a+v,a+v+x));for(t._mesh._inverseBindPoses=[],n=0,i=S.length;n<i;n+=16){var T=new Matrix4x4(S[n+0],S[n+1],S[n+2],S[n+3],S[n+4],S[n+5],S[n+6],S[n+7],S[n+8],S[n+9],S[n+10],S[n+11],S[n+12],S[n+13],S[n+14],S[n+15]);t._mesh._inverseBindPoses.push(T)}return!0},t.READ_SUBMESH=function(){var e=t._readData.__getBuffer(),n=new SubMesh(t._mesh),i=t._readData.getInt16(),r=t._readData.getUint32(),a=t._readData.getUint32();n._vertexBuffer=t._mesh._vertexBuffers[i],n._vertexStart=r,n._vertexCount=a;var s=t._readData.getUint32(),o=t._readData.getUint32(),l=t._mesh._indexBuffer;n._indexBuffer=l,n._indexStart=s,n._indexCount=o,n._indices=new Uint16Array(l.getData().buffer,2*s,o);var h=t._DATA.offset,_=n._subIndexBufferStart,u=n._subIndexBufferCount,c=n._boneIndicesList,d=t._readData.getUint16();_.length=d,u.length=d,c.length=d;for(var f=0;f<d;f++){_[f]=t._readData.getUint32(),u[f]=t._readData.getUint32();var m=t._readData.getUint32(),p=t._readData.getUint32();n._boneIndicesList[f]=new Uint8Array(e.slice(h+m,h+m+p))}return t._subMeshes.push(n),!0},t._strings=[],t._readData=null,t._version=null,t._mesh=null,t._subMeshes=null,t._materialMap=null,__static(t,["_vertexDeclarationMap_Discard",function(){return this._vertexDeclarationMap_Discard={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTexture0Texture1SkinTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":VertexPositionNTBTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTextureSkinTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTextureSkin.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTextureSkinTangent.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTextureSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorSkinTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":VertexPositionNormalColorTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1":VertexPositionNormalTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":VertexPositionNormalColorTextureTangent.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":VertexPositionNTBTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":VertexPositionNormalColorTexture.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":VertexPositionNormalTextureTangent.vertexDeclaration,"POSITION,NORMAL,UV":VertexPositionNormalTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":VertexPositionNormalColorTangent.vertexDeclaration,"POSITION,NORMAL,COLOR":VertexPositionNormalColor.vertexDeclaration,"POSITION,NORMAL,TANGENT":VertexPositionNormalTangent.vertexDeclaration,"POSITION,NORMAL":VertexPositionNormal.vertexDeclaration,"POSITION,UV":VertexPositionTexture0.vertexDeclaration,POSITION:VertexPosition.vertexDeclaration}},"_vertexDeclarationMap",function(){return this._vertexDeclarationMap={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTexture0Texture1SkinSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":VertexPositionNTBTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTexture0Texture1SkinSTangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTexture0Texture1Skin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorTextureSkinSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorTextureSkin.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalTextureSkinSTangent.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalTextureSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":VertexPositionNormalColorSkinSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":VertexPositionNormalColorSkin.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":VertexPositionNormalColorTexture0Texture1STangent.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":VertexPositionNormalColorTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":VertexPositionNormalTexture0Texture1STangent.vertexDeclaration,"POSITION,NORMAL,UV,UV1":VertexPositionNormalTexture0Texture1.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":VertexPositionNormalColorTextureSTangent.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":VertexPositionNTBTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":VertexPositionNormalColorTexture.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":VertexPositionNormalTextureSTangent.vertexDeclaration,"POSITION,NORMAL,UV":VertexPositionNormalTexture.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":VertexPositionNormalColorSTangent.vertexDeclaration,"POSITION,NORMAL,COLOR":VertexPositionNormalColor.vertexDeclaration,"POSITION,NORMAL,TANGENT":VertexPositionNormalSTangent.vertexDeclaration,"POSITION,NORMAL":VertexPositionNormal.vertexDeclaration,"POSITION,UV":VertexPositionTexture0.vertexDeclaration,POSITION:VertexPosition.vertexDeclaration}},"_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),LoadModelV01=function(){function t(t,e,n,i,r,a){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._subMeshes=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=n,this._materials=i,this._subMeshes=r,this._materialMap=a,this._version=e,this._onLoaded(t)}__class(t,"laya.d3.loaders.LoadModelV01");var e=t.prototype;return e._onLoaded=function(t){this._readData=t,this.READ_BLOCK();for(var e=0;e<this._BLOCK.count;e++){var n=this._readData.getUint16(),i=this._strings[n],r=this["READ_"+i];if(null==r)throw new Error("model file err,no this function:"+n+" "+i);if(!r.call(this))break}return this._mesh},e.onError=function(){},e._readString=function(){return this._strings[this._readData.getUint16()]},e.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},e.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},e.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var t=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var e=0;e<this._STRINGS.size;e++)this._strings[e]=this._readData.readUTFString();return this._readData.pos=t,!0},e.READ_MATERIAL=function(){var t=this._readData.getUint16(),e=(this._readString(),this._readString());return this._materials[t]="null"!==e?Loader.getRes(this._materialMap[e]):new BaseMaterial,!0},e.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var t=this._readData.__getBuffer(),e=0,n=0,i=this._readData.getUint32(),r=this._readData.getUint32(),a=(new Float32Array(t.slice(i+this._DATA.offset,i+this._DATA.offset+r)),this._readData.getUint32()),s=this._readData.getUint32(),o=new Float32Array(t.slice(a+this._DATA.offset,a+this._DATA.offset+s));for(this.mesh._inverseBindPoses=[],e=0,n=o.length;e<n;e+=16){var l=new Matrix4x4(o[e+0],o[e+1],o[e+2],o[e+3],o[e+4],o[e+5],o[e+6],o[e+7],o[e+8],o[e+9],o[e+10],o[e+11],o[e+12],o[e+13],o[e+14],o[e+15]);this.mesh._inverseBindPoses.push(l)}break;default:throw new Error("LoadModel:unknown version.")}return!0},e.READ_SUBMESH=function(){var e=(this._readString(),this._readData.getUint8(),this._readString());this._shaderAttributes=e.match(t._attrReg);var n=this._readData.getUint32(),i=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),l=this._readData.__getBuffer(),h=new SubMesh(this._mesh),_=this._getVertexDeclaration(),u=VertexBuffer3D.create(_,a/_.vertexStride,35044,!0),c=r+this._DATA.offset,d=l.slice(c,c+a);u.setData(new Float32Array(d)),h._vertexBuffer=u;for(var f=u.vertexDeclaration.getVertexElements(),m=0;m<f.length;m++)h._bufferUsage[f[m].elementUsage]=u;var p=IndexBuffer3D.create("ushort",i/2,35044,!0),g=n+this._DATA.offset,v=l.slice(g,g+i);p.setData(new Uint16Array(v)),h._indexBuffer=p;var x=l.slice(s+this._DATA.offset,s+this._DATA.offset+o);return h._boneIndicesList[0]=new Uint8Array(x),this._subMeshes.push(h),!0},e.READ_DATAAREA=function(){return!1},e._getVertexDeclaration=function(){for(var t=!1,e=!1,n=!1,i=!1,r=!1,a=!1,s=!1,o=!1,l=!1,h=0;h<this._shaderAttributes.length;h+=8)switch(this._shaderAttributes[h]){case"POSITION":t=!0;break;case"NORMAL":e=!0;break;case"COLOR":n=!0;break;case"UV":i=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0;break;case"TANGENT":a=!0;break;case"BINORMAL":l=!0}var _;return t&&e&&n&&i&&r&&s&&o&&a?_=VertexPositionNormalColorTexture0Texture1SkinTangent.vertexDeclaration:t&&e&&n&&i&&r&&s&&o?_=VertexPositionNormalColorTexture0Texture1Skin.vertexDeclaration:t&&e&&i&&r&&s&&o&&a?_=VertexPositionNormalTexture0Texture1SkinTangent.vertexDeclaration:t&&e&&i&&r&&s&&o?_=VertexPositionNormalTexture0Texture1Skin.vertexDeclaration:t&&e&&n&&i&&s&&o&&a?_=VertexPositionNormalColorTextureSkinTangent.vertexDeclaration:t&&e&&n&&i&&s&&o?_=VertexPositionNormalColorTextureSkin.vertexDeclaration:t&&e&&a&&l&&i&&s&&o?_=VertexPositionNTBTextureSkin.vertexDeclaration:t&&e&&i&&s&&o&&a?_=VertexPositionNormalTextureSkinTangent.vertexDeclaration:t&&e&&i&&s&&o?_=VertexPositionNormalTextureSkin.vertexDeclaration:t&&e&&n&&s&&o&&a?_=VertexPositionNormalColorSkinTangent.vertexDeclaration:t&&e&&n&&s&&o?_=VertexPositionNormalColorSkin.vertexDeclaration:t&&e&&n&&i&&r&&a?_=VertexPositionNormalColorTexture0Texture1Tangent.vertexDeclaration:t&&e&&n&&i&&r?_=VertexPositionNormalColorTexture0Texture1.vertexDeclaration:t&&e&&i&&r&&a?_=VertexPositionNormalTexture0Texture1Tangent.vertexDeclaration:t&&e&&i&&r?_=VertexPositionNormalTexture0Texture1.vertexDeclaration:t&&e&&n&&i&&a?_=VertexPositionNormalColorTextureTangent.vertexDeclaration:t&&e&&i&&a&&l?_=VertexPositionNTBTexture.vertexDeclaration:t&&e&&n&&i?_=VertexPositionNormalColorTexture.vertexDeclaration:t&&e&&i&&a?_=VertexPositionNormalTextureTangent.vertexDeclaration:t&&e&&i?_=VertexPositionNormalTexture.vertexDeclaration:t&&e&&n&&a?_=VertexPositionNormalColorTangent.vertexDeclaration:t&&e&&n&&(_=VertexPositionNormalColor.vertexDeclaration),_},__getset(0,e,"mesh",function(){return this._mesh}),t._attrReg=new RegExp("(\\w+)|([:,;])","g"),t}(),Rectangle=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.width=n,this.height=i}__class(t,"laya.maths.Rectangle");var e=t.prototype;return e.setTo=function(t,e,n,i){return this.x=t,this.y=e,this.width=n,this.height=i,this},e.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},e.contains=function(t,e){return!(this.width<=0||this.height<=0)&&(t>=this.x&&t<this.right&&e>=this.y&&e<this.bottom)},e.intersects=function(t){return!(t.x>this.x+this.width||t.x+t.width<this.x||t.y>this.y+this.height||t.y+t.height<this.y)},e.intersection=function(e,n){return this.intersects(e)?(n||(n=new t),n.x=Math.max(this.x,e.x),n.y=Math.max(this.y,e.y),n.width=Math.min(this.right,e.right)-n.x,n.height=Math.min(this.bottom,e.bottom)-n.y,n):null},e.union=function(e,n){return n||(n=new t),this.clone(n),e.width<=0||e.height<=0?n:(n.addPoint(e.x,e.y),n.addPoint(e.right,e.bottom),this)},e.clone=function(e){return e||(e=new t),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e},e.toString=function(){return this.x+","+this.y+","+this.width+","+this.height},e.equals=function(t){return!(!t||t.x!==this.x||t.y!==this.y||t.width!==this.width||t.height!==this.height)},e.addPoint=function(t,e){return this.x>t&&(this.width+=this.x-t,this.x=t),this.y>e&&(this.height+=this.y-e,this.y=e),this.width<t-this.x&&(this.width=t-this.x),this.height<e-this.y&&(this.height=e-this.y),this},e._getBoundPoints=function(){var e=t._temB;return e.length=0,0==this.width||0==this.height?e:(e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e)},e.isEmpty=function(){return this.width<=0||this.height<=0},__getset(0,e,"bottom",function(){return this.y+this.height}),__getset(0,e,"right",function(){return this.x+this.width}),t._getBoundPointS=function(e,n,i,r){var a=t._temA;return a.length=0,0==i||0==r?a:(a.push(e,n,e+i,n,e,n+r,e+i,n+r),a)},t._getWrapRec=function(e,n){if(!e||e.length<1)return n?n.setTo(0,0,0,0):t.TEMP.setTo(0,0,0,0);n=n||new t;var i,r,a,s,o,l=e.length,h=Point.TEMP;for(r=s=99999,a=o=-r,i=0;i<l;i+=2)h.x=e[i],h.y=e[i+1],r=r<h.x?r:h.x,s=s<h.y?s:h.y,a=a>h.x?a:h.x,o=o>h.y?o:h.y;return n.setTo(r,s,a-r,o-s)},t.EMPTY=new t,t.TEMP=new t,t._temB=[],t._temA=[],t}(),Arith=function(){function t(){}return __class(t,"laya.maths.Arith"),t.formatR=function(t){return t>Math.PI&&(t-=2*Math.PI),t<-Math.PI&&(t+=2*Math.PI),t},t.isPOT=function(t,e){return t>0&&0==(t&t-1)&&e>0&&0==(e&e-1)},t.setMatToArray=function(t,e){t.a,t.b,t.c,t.d,t.tx,t.ty,e[0]=t.a,e[1]=t.b,e[4]=t.c,e[5]=t.d,e[12]=t.tx,e[13]=t.ty},t}(),MathUtil=function(){function t(){}return __class(t,"laya.maths.MathUtil"),t.subtractVector3=function(t,e,n){n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2]},t.lerp=function(t,e,n){return t*(1-n)+e*n},t.scaleVector3=function(t,e,n){n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e},t.lerpVector3=function(t,e,n,i){var r=t[0],a=t[1],s=t[2];i[0]=r+n*(e[0]-r),i[1]=a+n*(e[1]-a),i[2]=s+n*(e[2]-s)},t.lerpVector4=function(t,e,n,i){var r=t[0],a=t[1],s=t[2],o=t[3];i[0]=r+n*(e[0]-r),i[1]=a+n*(e[1]-a),i[2]=s+n*(e[2]-s),i[3]=o+n*(e[3]-o)},t.slerpQuaternionArray=function(t,e,n,i,r,a,s){var o,l,h,_,u,c=t[e+0],d=t[e+1],f=t[e+2],m=t[e+3],p=n[i+0],g=n[i+1],v=n[i+2],x=n[i+3];return l=c*p+d*g+f*v+m*x,l<0&&(l=-l,p=-p,g=-g,v=-v,x=-x),1-l>1e-6?(o=Math.acos(l),h=Math.sin(o),_=Math.sin((1-r)*o)/h,u=Math.sin(r*o)/h):(_=1-r,u=r),a[s+0]=_*c+u*p,a[s+1]=_*d+u*g,a[s+2]=_*f+u*v,a[s+3]=_*m+u*x,a},t.getRotation=function(t,e,n,i){return Math.atan2(i-e,n-t)/Math.PI*180},t.sortBigFirst=function(t,e){return t==e?0:e>t?1:-1},t.sortSmallFirst=function(t,e){return t==e?0:e>t?-1:1},t.sortNumBigFirst=function(t,e){return parseFloat(e)-parseFloat(t)},t.sortNumSmallFirst=function(t,e){return parseFloat(t)-parseFloat(e)},t.sortByKey=function(e,n,i){void 0===n&&(n=!1),void 0===i&&(i=!0);var r;return r=n?i?t.sortNumBigFirst:t.sortBigFirst:i?t.sortNumSmallFirst:t.sortSmallFirst,function(t,n){return r(t[e],n[e])}},t}(),Point=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}__class(t,"laya.maths.Point");var e=t.prototype;return e.setTo=function(t,e){return this.x=t,this.y=e,this},e.distance=function(t,e){return Math.sqrt((this.x-t)*(this.x-t)+(this.y-e)*(this.y-e))},e.toString=function(){return this.x+","+this.y},e.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t>0){var e=1/t;this.x*=e,this.y*=e}},t.TEMP=new t,t.EMPTY=new t,t}(),GrahamScan=function(){function t(){}return __class(t,"laya.maths.GrahamScan"),t.multiply=function(t,e,n){return(t.x-n.x)*(e.y-n.y)-(e.x-n.x)*(t.y-n.y)},t.dis=function(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)},t._getPoints=function(e,n,i){for(void 0===n&&(n=!1),t._mPointList||(t._mPointList=[]);t._mPointList.length<e;)t._mPointList.push(new Point);return i||(i=[]),i.length=0,n?t.getFrom(i,t._mPointList,e):t.getFromR(i,t._mPointList,e),i},t.getFrom=function(t,e,n){var i=0;for(i=0;i<n;i++)t.push(e[i]);return t},t.getFromR=function(t,e,n){var i=0;for(i=0;i<n;i++)t.push(e.pop());return t},t.pListToPointList=function(e,n){void 0===n&&(n=!1);var i=0,r=e.length/2,a=t._getPoints(r,n,t._tempPointList);for(i=0;i<r;i++)a[i].setTo(e[i+i],e[i+i+1]);return a},t.pointListToPlist=function(e){var n,i=0,r=e.length,a=t._temPList;for(a.length=0,i=0;i<r;i++)n=e[i],a.push(n.x,n.y);return a},t.scanPList=function(e){return Utils.copyArray(e,t.pointListToPlist(t.scan(t.pListToPointList(e,!0))))},t.scan=function(e){var n,i,r,a=0,s=0,o=0,l=e.length,h={};for(i=t._temArr,i.length=0,l=e.length,a=l-1;a>=0;a--)n=e[a],r=n.x+"_"+n.y,h.hasOwnProperty(r)||(h[r]=!0,i.push(n));for(l=i.length,
Utils.copyArray(e,i),a=1;a<l;a++)(e[a].y<e[o].y||e[a].y==e[o].y&&e[a].x<e[o].x)&&(o=a);for(n=e[0],e[0]=e[o],e[o]=n,a=1;a<l-1;a++){for(o=a,s=a+1;s<l;s++)(t.multiply(e[s],e[o],e[0])>0||0==t.multiply(e[s],e[o],e[0])&&t.dis(e[0],e[s])<t.dis(e[0],e[o]))&&(o=s);n=e[a],e[a]=e[o],e[o]=n}if(i=t._temArr,i.length=0,e.length<3)return Utils.copyArray(i,e);for(i.push(e[0],e[1],e[2]),a=3;a<l;a++){for(;i.length>=2&&t.multiply(e[a],i[i.length-1],i[i.length-2])>=0;)i.pop();e[a]&&i.push(e[a])}return i},t._mPointList=null,t._tempPointList=[],t._temPList=[],t._temArr=[],t}(),Matrix=function(){function t(t,e,n,i,r,a){this.inPool=!1,this.bTransform=!1,void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===a&&(a=0),this.a=t,this.b=e,this.c=n,this.d=i,this.tx=r,this.ty=a,this._checkTransform()}__class(t,"laya.maths.Matrix");var e=t.prototype;return e.identity=function(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this.bTransform=!1,this},e._checkTransform=function(){return this.bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d},e.setTranslate=function(t,e){return this.tx=t,this.ty=e,this},e.translate=function(t,e){return this.tx+=t,this.ty+=e,this},e.scale=function(t,e){this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this.bTransform=!0},e.rotate=function(t){var e=Math.cos(t),n=Math.sin(t),i=this.a,r=this.c,a=this.tx;this.a=i*e-this.b*n,this.b=i*n+this.b*e,this.c=r*e-this.d*n,this.d=r*n+this.d*e,this.tx=a*e-this.ty*n,this.ty=a*n+this.ty*e,this.bTransform=!0},e.skew=function(t,e){var n=Math.tan(t),i=Math.tan(e),r=this.a,a=this.b;return this.a+=i*this.c,this.b+=i*this.d,this.c+=n*r,this.d+=n*a,this},e.invertTransformPoint=function(t){var e=this.a,n=this.b,i=this.c,r=this.d,a=this.tx,s=e*r-n*i,o=r/s,l=-n/s,h=-i/s,_=e/s,u=(i*this.ty-r*a)/s,c=-(e*this.ty-n*a)/s;return t.setTo(o*t.x+h*t.y+u,l*t.x+_*t.y+c)},e.transformPoint=function(t){return t.setTo(this.a*t.x+this.c*t.y+this.tx,this.b*t.x+this.d*t.y+this.ty)},e.transformPointN=function(t){return t.setTo(this.a*t.x+this.c*t.y,this.b*t.x+this.d*t.y)},e.transformPointArray=function(t,e){for(var n=t.length,i=0;i<n;i+=2){var r=t[i],a=t[i+1];e[i]=this.a*r+this.c*a+this.tx,e[i+1]=this.b*r+this.d*a+this.ty}return e},e.transformPointArrayScale=function(t,e){for(var n=t.length,i=0;i<n;i+=2){var r=t[i],a=t[i+1];e[i]=this.a*r+this.c*a,e[i+1]=this.b*r+this.d*a}return e},e.getScaleX=function(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)},e.getScaleY=function(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)},e.invert=function(){var t=this.a,e=this.b,n=this.c,i=this.d,r=this.tx,a=t*i-e*n;return this.a=i/a,this.b=-e/a,this.c=-n/a,this.d=t/a,this.tx=(n*this.ty-i*r)/a,this.ty=-(t*this.ty-e*r)/a,this},e.setTo=function(t,e,n,i,r,a){return this.a=t,this.b=e,this.c=n,this.d=i,this.tx=r,this.ty=a,this},e.concat=function(t){var e=this.a,n=this.c,i=this.tx;return this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=n*t.a+this.d*t.c,this.d=n*t.b+this.d*t.d,this.tx=i*t.a+this.ty*t.c+t.tx,this.ty=i*t.b+this.ty*t.d+t.ty,this},e.scaleEx=function(t,e){var n=this.a,i=this.b,r=this.c,a=this.d;0!==i||0!==r?(this.a=t*n,this.b=t*i,this.c=e*r,this.d=e*a):(this.a=t*n,this.b=0*a,this.c=0*n,this.d=e*a),this.bTransform=!0},e.rotateEx=function(t){var e=Math.cos(t),n=Math.sin(t),i=this.a,r=this.b,a=this.c,s=this.d;0!==r||0!==a?(this.a=e*i+n*a,this.b=e*r+n*s,this.c=-n*i+e*a,this.d=-n*r+e*s):(this.a=e*i,this.b=n*s,this.c=-n*i,this.d=e*s),this.bTransform=!0},e.clone=function(){var e=t.create();return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e.bTransform=this.bTransform,e},e.copyTo=function(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t.bTransform=this.bTransform,t},e.toString=function(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty},e.destroy=function(){if(!this.inPool){var e=t._cache;this.inPool=!0,e._length||(e._length=0),e[e._length++]=this,this.a=this.d=1,this.b=this.c=this.tx=this.ty=0,this.bTransform=!1}},t.mul=function(t,e,n){var i=t.a,r=t.b,a=t.c,s=t.d,o=t.tx,l=t.ty,h=e.a,_=e.b,u=e.c,c=e.d,d=e.tx,f=e.ty;return 0!==_||0!==u?(n.a=i*h+r*u,n.b=i*_+r*c,n.c=a*h+s*u,n.d=a*_+s*c,n.tx=h*o+u*l+d,n.ty=_*o+c*l+f):(n.a=i*h,n.b=r*c,n.c=a*h,n.d=s*c,n.tx=h*o+d,n.ty=c*l+f),n},t.mul16=function(t,e,n){var i=t.a,r=t.b,a=t.c,s=t.d,o=t.tx,l=t.ty,h=e.a,_=e.b,u=e.c,c=e.d,d=e.tx,f=e.ty;return 0!==_||0!==u?(n[0]=i*h+r*u,n[1]=i*_+r*c,n[4]=a*h+s*u,n[5]=a*_+s*c,n[12]=h*o+u*l+d,n[13]=_*o+c*l+f):(n[0]=i*h,n[1]=r*c,n[4]=a*h,n[5]=s*c,n[12]=h*o+d,n[13]=c*l+f),n},t.mulPre=function(t,e,n,i,r,a,s,o){var l=t.a,h=t.b,_=t.c,u=t.d,c=t.tx,d=t.ty;return 0!==n||0!==i?(o.a=l*e+h*i,o.b=l*n+h*r,o.c=_*e+u*i,o.d=_*n+u*r,o.tx=e*c+i*d+a,o.ty=n*c+r*d+s):(o.a=l*e,o.b=h*r,o.c=_*e,o.d=u*r,o.tx=e*c+a,o.ty=r*d+s),o},t.mulPos=function(t,e,n,i,r,a,s,o){var l=t.a,h=t.b,_=t.c,u=t.d,c=t.tx,d=t.ty;return 0!==h||0!==_?(o.a=e*l+n*_,o.b=e*h+n*u,o.c=i*l+r*_,o.d=i*h+r*u,o.tx=l*a+_*s+c,o.ty=h*a+u*s+d):(o.a=e*l,o.b=n*u,o.c=i*l,o.d=r*u,o.tx=l*a+c,o.ty=u*s+d),o},t.preMul=function(t,e,n){var i=t.a,r=t.b,a=t.c,s=t.d,o=e.a,l=e.b,h=e.c,_=e.d,u=e.tx,c=e.ty;return n.a=o*i,n.b=n.c=0,n.d=_*s,n.tx=u*i+t.tx,n.ty=c*s+t.ty,0===l&&0===h&&0===r&&0===a||(n.a+=l*a,n.d+=h*r,n.b+=o*r+l*s,n.c+=h*i+_*a,n.tx+=c*a,n.ty+=u*r),n},t.preMulXY=function(t,e,n,i){var r=t.a,a=t.b,s=t.c,o=t.d;return i.a=r,i.b=a,i.c=s,i.d=o,i.tx=e*r+t.tx+n*s,i.ty=n*o+t.ty+e*a,i},t.create=function(){var e=t._cache,n=e._length?e[--e._length]:new t;return n.inPool=!1,n},t.EMPTY=new t,t.TEMP=new t,t._cache=[],t}(),Bezier=function(){function t(){this._controlPoints=[new Point,new Point,new Point],this._calFun=this.getPoint2}__class(t,"laya.maths.Bezier");var e=t.prototype;return e._switchPoint=function(t,e){var n=this._controlPoints.shift();n.setTo(t,e),this._controlPoints.push(n)},e.getPoint2=function(t,e){var n=this._controlPoints[0],i=this._controlPoints[1],r=this._controlPoints[2],a=Math.pow(1-t,2)*n.x+2*t*(1-t)*i.x+Math.pow(t,2)*r.x,s=Math.pow(1-t,2)*n.y+2*t*(1-t)*i.y+Math.pow(t,2)*r.y;e.push(a,s)},e.getPoint3=function(t,e){var n=this._controlPoints[0],i=this._controlPoints[1],r=this._controlPoints[2],a=this._controlPoints[3],s=Math.pow(1-t,3)*n.x+3*i.x*t*(1-t)*(1-t)+3*r.x*t*t*(1-t)+a.x*Math.pow(t,3),o=Math.pow(1-t,3)*n.y+3*i.y*t*(1-t)*(1-t)+3*r.y*t*t*(1-t)+a.y*Math.pow(t,3);e.push(s,o)},e.insertPoints=function(t,e){var n=NaN;t=t>0?t:5;var i=NaN;for(i=1/t,n=0;n<=1;n+=i)this._calFun(n,e)},e.getBezierPoints=function(t,e,n){void 0===e&&(e=5),void 0===n&&(n=2);var i=0,r=0;if((r=t.length)<2*(n+1))return[];var a;switch(a=[],n){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=n;)this._controlPoints.push(new Point);for(i=0;i<2*n;i+=2)this._switchPoint(t[i],t[i+1]);for(i=2*n;i<r;i+=2)this._switchPoint(t[i],t[i+1]),i/2%n==0&&this.insertPoints(e,a);return a},__static(t,["I",function(){return this.I=new t}]),t}(),GraphicsBounds=function(){function t(){this._cacheBoundsType=!1}__class(t,"laya.display.GraphicsBounds");var e=t.prototype;return e.destroy=function(){this._graphics=null,this._temp=null,this._rstBoundPoints=null,this._bounds=null},e.reset=function(){this._temp&&(this._temp.length=0)},e.getBounds=function(t){return void 0===t&&(t=!1),(!this._bounds||!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._bounds=Rectangle._getWrapRec(this.getBoundPoints(t),this._bounds)),this._cacheBoundsType=t,this._bounds},e.getBoundPoints=function(t){return void 0===t&&(t=!1),(!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(t)),this._cacheBoundsType=t,this._rstBoundPoints=Utils.copyArray(this._rstBoundPoints,this._temp)},e._getCmdPoints=function(e){void 0===e&&(e=!1);var n,i=Render._context,r=this._graphics.cmds;if(n=this._temp||(this._temp=[]),n.length=0,r||null==this._graphics._one||(t._tempCmds.length=0,t._tempCmds.push(this._graphics._one),r=t._tempCmds),!r)return n;var a;a=t._tempMatrixArrays,a.length=0;var s=t._initMatrix;s.identity();for(var o,l,h=t._tempMatrix,_=NaN,u=NaN,c=NaN,d=NaN,f=NaN,m=NaN,p=0,g=r.length;p<g;p++)if(o=r[p],o.callee)switch(o.callee){case i._save:case 7:a.push(s),s=s.clone();break;case i._restore:case 8:s=a.pop();break;case i._scale:case 5:h.identity(),h.translate(-o[2],-o[3]),h.scale(o[0],o[1]),h.translate(o[2],o[3]),this._switchMatrix(s,h);break;case i._rotate:case 3:h.identity(),h.translate(-o[1],-o[2]),h.rotate(o[0]),h.translate(o[1],o[2]),this._switchMatrix(s,h);break;case i._translate:case 6:h.identity(),h.translate(o[0],o[1]),this._switchMatrix(s,h);break;case i._transform:case 4:h.identity(),h.translate(-o[1],-o[2]),h.concat(o[0]),h.translate(o[1],o[2]),this._switchMatrix(s,h);break;case 16:case 24:t._addPointArrToRst(n,Rectangle._getBoundPointS(o[0],o[1],o[2],o[3]),s);break;case 17:s.copyTo(h),h.concat(o[4]),t._addPointArrToRst(n,Rectangle._getBoundPointS(o[0],o[1],o[2],o[3]),h);break;case i._drawTexture:l=o[0],e?o[3]&&o[4]?t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1],o[2],o[3],o[4]),s):(l=o[0],t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1],o[2],l.width,l.height),s)):(_=(o[3]||l.sourceWidth)/l.width,u=(o[4]||l.sourceHeight)/l.height,c=_*l.sourceWidth,d=u*l.sourceHeight,f=l.offsetX>0?l.offsetX:0,m=l.offsetY>0?l.offsetY:0,f*=_,m*=u,t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1]-f,o[2]-m,c,d),s));break;case i._fillTexture:o[3]&&o[4]?t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1],o[2],o[3],o[4]),s):(l=o[0],t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1],o[2],l.width,l.height),s));break;case i._drawTextureWithTransform:var v;o[5]?(s.copyTo(h),h.concat(o[5]),v=h):v=s,e?o[3]&&o[4]?t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1],o[2],o[3],o[4]),v):(l=o[0],t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1],o[2],l.width,l.height),v)):(l=o[0],_=(o[3]||l.sourceWidth)/l.width,u=(o[4]||l.sourceHeight)/l.height,c=_*l.sourceWidth,d=u*l.sourceHeight,f=l.offsetX>0?l.offsetX:0,m=l.offsetY>0?l.offsetY:0,f*=_,m*=u,t._addPointArrToRst(n,Rectangle._getBoundPointS(o[1]-f,o[2]-m,c,d),v));break;case i._drawRect:case 13:t._addPointArrToRst(n,Rectangle._getBoundPointS(o[0],o[1],o[2],o[3]),s);break;case i._drawCircle:case i._fillCircle:case 14:t._addPointArrToRst(n,Rectangle._getBoundPointS(o[0]-o[2],o[1]-o[2],o[2]+o[2],o[2]+o[2]),s);break;case i._drawLine:case 20:t._tempPoints.length=0;var x=NaN;x=.5*o[5],o[0]==o[2]?t._tempPoints.push(o[0]+x,o[1],o[2]+x,o[3],o[0]-x,o[1],o[2]-x,o[3]):o[1]==o[3]?t._tempPoints.push(o[0],o[1]+x,o[2],o[3]+x,o[0],o[1]-x,o[2],o[3]-x):t._tempPoints.push(o[0],o[1],o[2],o[3]),t._addPointArrToRst(n,t._tempPoints,s);break;case i._drawCurves:case 22:t._addPointArrToRst(n,Bezier.I.getBezierPoints(o[2]),s,o[0],o[1]);break;case i._drawPoly:case i._drawLines:case 18:t._addPointArrToRst(n,o[2],s,o[0],o[1]);break;case i._drawPath:case 19:t._addPointArrToRst(n,this._getPathPoints(o[2]),s,o[0],o[1]);break;case i._drawPie:case 15:t._addPointArrToRst(n,this._getPiePoints(o[0],o[1],o[2],o[3],o[4]),s)}return n.length>200?n=Utils.copyArray(n,Rectangle._getWrapRec(n)._getBoundPoints()):n.length>8&&(n=GrahamScan.scanPList(n)),n},e._switchMatrix=function(t,e){e.concat(t),e.copyTo(t)},e._getPiePoints=function(e,n,i,r,a){var s=t._tempPoints;t._tempPoints.length=0,s.push(e,n);var o=(a-r)%(2*Math.PI),l=o/10,h=NaN,_=r;for(h=0;h<=10;h++)s.push(e+i*Math.cos(_),n+i*Math.sin(_)),_+=l;return s},e._getPathPoints=function(e){var n=0,i=0,r=t._tempPoints;r.length=0,i=e.length;var a;for(n=0;n<i;n++)a=e[n],a.length>1&&(r.push(a[1],a[2]),a.length>3&&r.push(a[3],a[4]));return r},t._addPointArrToRst=function(e,n,i,r,a){void 0===r&&(r=0),void 0===a&&(a=0);var s=0,o=0;for(o=n.length,s=0;s<o;s+=2)t._addPointToRst(e,n[s]+r,n[s+1]+a,i)},t._addPointToRst=function(t,e,n,i){var r=Point.TEMP;r.setTo(e||0,n||0),i.transformPoint(r),t.push(r.x,r.y)},t._tempPoints=[],t._tempMatrixArrays=[],t._tempCmds=[],__static(t,["_tempMatrix",function(){return this._tempMatrix=new Matrix},"_initMatrix",function(){return this._initMatrix=new Matrix}]),t}(),TransformInfo=function(){function t(){this.translateX=0,this.translateY=0,this.scaleX=1,this.scaleY=1,this.rotate=0,this.skewX=0,this.skewY=0}return __class(t,"laya.display.css.TransformInfo"),t}(),Style=function(){function t(){this.alpha=1,this.visible=!0,this.scrollRect=null,this.blendMode=null,this._type=0,this._tf=t._TF_EMPTY}__class(t,"laya.display.css.Style");var e=t.prototype;return e.getTransform=function(){return this._tf},e.setTransform=function(e){this._tf="none"!==e&&e?e:t._TF_EMPTY},e.setTranslateX=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.translateX=e},e.setTranslateY=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.translateY=e},e.setScaleX=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleX=e},e.setScale=function(e,n){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleX=e,this._tf.scaleY=n},e.setScaleY=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleY=e},e.setRotate=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.rotate=e},e.setSkewX=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.skewX=e},e.setSkewY=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.skewY=e},e.destroy=function(){this.scrollRect=null},e.render=function(t,e,n,i){},e.getCSSStyle=function(){return CSSStyle.EMPTY},e._enableLayout=function(){return!1},__getset(0,e,"absolute",function(){return!0}),__getset(0,e,"block",function(){return 0!=(1&this._type)}),__getset(0,e,"scaleX",function(){return this._tf.scaleX},function(t){this.setScaleX(t)}),__getset(0,e,"skewY",function(){return this._tf.skewY},function(t){this.setSkewY(t)}),__getset(0,e,"skewX",function(){return this._tf.skewX},function(t){this.setSkewX(t)}),__getset(0,e,"rotate",function(){return this._tf.rotate},function(t){this.setRotate(t)}),__getset(0,e,"transform",function(){return this.getTransform()},function(t){this.setTransform(t)}),__getset(0,e,"scaleY",function(){return this._tf.scaleY},function(t){this.setScaleY(t)}),__getset(0,e,"paddingTop",function(){return 0}),__getset(0,e,"translateY",function(){return this._tf.translateY},function(t){this.setTranslateY(t)}),__getset(0,e,"translateX",function(){return this._tf.translateX},function(t){this.setTranslateX(t)}),__getset(0,e,"paddingLeft",function(){return 0}),t.__init__=function(){t._TF_EMPTY=new TransformInfo,t.EMPTY=new t},t.EMPTY=null,t._TF_EMPTY=null,t}(),Font=function(){function t(e){this._type=0,this._weight=0,this._decoration=null,this._text=null,this.indent=0,this._color=Color.create(t.defaultColor),this.family=t.defaultFamily,this.stroke=t._STROKE,this.size=t.defaultSize,e&&e!==t.EMPTY&&e.copyTo(this)}__class(t,"laya.display.css.Font");var e=t.prototype;return e.set=function(t){this._text=null;for(var e=t.split(" "),n=0,i=e.length;n<i;n++){var r=e[n];switch(r){case"italic":this.italic=!0;continue;case"bold":this.bold=!0;continue}r.indexOf("px")>0&&(this.size=parseInt(r),this.family=e[n+1],n++)}},e.toString=function(){return this._text="",this.italic&&(this._text+="italic "),this.bold&&(this._text+="bold "),this._text+=this.size+"px "+this.family},e.copyTo=function(e){e._type=this._type,e._text=this._text,e._weight=this._weight,e._color=this._color,e.family=this.family,e.stroke=this.stroke!=t._STROKE?this.stroke.slice():t._STROKE,e.indent=this.indent,e.size=this.size},__getset(0,e,"decoration",function(){return this._decoration?this._decoration.value:"none"},function(t){var e=t.split(" ");switch(this._decoration||(this._decoration={}),e[0]){case"_":this._decoration.type="underline";break;case"-":this._decoration.type="line-through";break;case"overline":this._decoration.type="overline";break;default:this._decoration.type=e[0]}e[1]&&(this._decoration.color=Color.create(e)),this._decoration.value=t}),__getset(0,e,"weight",function(){return""+this._weight},function(t){var e=0;switch(t){case"normal":break;case"bold":this.bold=!0,e=700;break;case"bolder":e=800;break;case"lighter":e=100;break;default:e=parseInt(t)}this._weight=e,this._text=null}),__getset(0,e,"color",function(){return this._color.strColor},function(t){this._color=Color.create(t)}),__getset(0,e,"bold",function(){return 0!=(2048&this._type)},function(t){t?this._type|=2048:this._type&=-2049}),__getset(0,e,"italic",function(){return 0!=(512&this._type)},function(t){t?this._type|=512:this._type&=-513}),__getset(0,e,"password",function(){return 0!=(1024&this._type)},function(t){t?this._type|=1024:this._type&=-1025}),t.__init__=function(){t.EMPTY=new t(null)},t.EMPTY=null,t.defaultColor="#000000",t.defaultSize=12,t.defaultFamily="Arial",t.defaultFont="12px Arial",t._STROKE=[0,"#000000"],t._ITALIC=512,t._PASSWORD=1024,t._BOLD=2048,t}(),BitmapFont=function(){function t(){this._texture=null,this._fontCharDic={},this._fontWidthMap={},this._complete=null,this._path=null,this._maxWidth=0,this._spaceWidth=10,this._padding=null,this.fontSize=12,this.autoScaleSize=!1,this.letterSpacing=0}__class(t,"laya.display.BitmapFont");var e=t.prototype;return e.loadFont=function(t,e){this._path=t,this._complete=e,Laya.loader.load([{url:this._path,type:"xml"},{url:this._path.replace(".fnt",".png"),type:"image"}],Handler.create(this,this.onLoaded))},e.onLoaded=function(){this.parseFont(Loader.getRes(this._path),Loader.getRes(this._path.replace(".fnt",".png"))),this._complete&&this._complete.run()},e.parseFont=function(t,e){if(null!=t&&null!=e){this._texture=e;var n=t.getElementsByTagName("info");if(!n[0].getAttributeNode)return this.parseFont2(t,e);this.fontSize=parseInt(n[0].getAttributeNode("size").nodeValue);var i=n[0].getAttributeNode("padding").nodeValue,r=i.split(",");this._padding=[parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),parseInt(r[3])];var a;a=t.getElementsByTagName("char");var s=0;for(s=0;s<a.length;s++){var o=a[s],l=parseInt(o.getAttributeNode("id").nodeValue),h=parseInt(o.getAttributeNode("xoffset").nodeValue)/1,_=parseInt(o.getAttributeNode("yoffset").nodeValue)/1,u=parseInt(o.getAttributeNode("xadvance").nodeValue)/1,c=new Rectangle;c.x=parseInt(o.getAttributeNode("x").nodeValue),c.y=parseInt(o.getAttributeNode("y").nodeValue),c.width=parseInt(o.getAttributeNode("width").nodeValue),c.height=parseInt(o.getAttributeNode("height").nodeValue);var d=Texture.create(e,c.x,c.y,c.width,c.height,h,_);this._maxWidth=Math.max(this._maxWidth,u+this.letterSpacing),this._fontCharDic[l]=d,this._fontWidthMap[l]=u}}},e.parseFont2=function(t,e){if(null!=t&&null!=e){this._texture=e;var n=t.getElementsByTagName("info");this.fontSize=parseInt(n[0].attributes.size.nodeValue);var i=n[0].attributes.padding.nodeValue,r=i.split(",");this._padding=[parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),parseInt(r[3])];var a=t.getElementsByTagName("char"),s=0;for(s=0;s<a.length;s++){var o=a[s].attributes,l=parseInt(o.id.nodeValue),h=parseInt(o.xoffset.nodeValue)/1,_=parseInt(o.yoffset.nodeValue)/1,u=parseInt(o.xadvance.nodeValue)/1,c=new Rectangle;c.x=parseInt(o.x.nodeValue),c.y=parseInt(o.y.nodeValue),c.width=parseInt(o.width.nodeValue),c.height=parseInt(o.height.nodeValue);var d=Texture.create(e,c.x,c.y,c.width,c.height,h,_);this._maxWidth=Math.max(this._maxWidth,u+this.letterSpacing),this._fontCharDic[l]=d,this._fontWidthMap[l]=u}}},e.getCharTexture=function(t){return this._fontCharDic[t.charCodeAt(0)]},e.destroy=function(){if(this._texture){for(var t in this._fontCharDic){var e=this._fontCharDic[t];e&&e.destroy()}this._texture.destroy(),this._fontCharDic=null,this._fontWidthMap=null,this._texture=null}},e.setSpaceWidth=function(t){this._spaceWidth=t},e.getCharWidth=function(t){var e=t.charCodeAt(0);return this._fontWidthMap[e]?this._fontWidthMap[e]+this.letterSpacing:" "==t?this._spaceWidth+this.letterSpacing:0},e.getTextWidth=function(t){for(var e=0,n=0,i=t.length;n<i;n++)e+=this.getCharWidth(t.charAt(n));return e},e.getMaxWidth=function(){return this._maxWidth},e.getMaxHeight=function(){return this.fontSize},e.drawText=function(t,e,n,i,r,a){var s,o=this.getTextWidth(t),l=0;"center"===r&&(l=(a-o)/2),"right"===r&&(l=a-o);for(var h=0,_=0,u=t.length;_<u;_++)(s=this.getCharTexture(t.charAt(_)))&&(e.graphics.drawTexture(s,n+h+l,i),h+=this.getCharWidth(t.charAt(_)))},t}(),TouchManager=function(){function t(){this.preOvers=[],this.preDowns=[],this.preRightDowns=[],this.enable=!0,this._lastClickTime=0,this._event=new Event}__class(t,"laya.events.TouchManager");var e=t.prototype;return e._clearTempArrs=function(){t._oldArr.length=0,t._newArr.length=0,t._tEleArr.length=0},e.getTouchFromArr=function(t,e){var n=0,i=0;i=e.length;var r;for(n=0;n<i;n++)if(r=e[n],r.id==t)return r;return null},e.removeTouchFromArr=function(t,e){var n=0;for(n=e.length-1;n>=0;n--)e[n].id==t&&e.splice(n,1)},e.createTouchO=function(t,e){var n;return n=Pool.getItem("TouchData")||{},n.id=e,n.tar=t,n},e.onMouseDown=function(e,n,i){if(void 0===i&&(i=!1),this.enable){var r,a,s;r=this.getTouchFromArr(n,this.preOvers),s=this.getEles(e,null,t._tEleArr),r?r.tar=e:(a=this.createTouchO(e,n),this.preOvers.push(a)),Browser.onMobile&&this.sendEvents(s,"mouseover",n);var o;o=i?this.preDowns:this.preRightDowns,r=this.getTouchFromArr(n,o),r?r.tar=e:(a=this.createTouchO(e,n),o.push(a)),this.sendEvents(s,i?"mousedown":"rightmousedown",n),this._clearTempArrs()}},e.sendEvents=function(t,e,n){void 0===n&&(n=0);var i=0,r=0;r=t.length,this._event._stoped=!1;var a;a=t[0];var s;for(i=0;i<r;i++){if(s=t[i],s.destroyed)return;if(s.event(e,this._event.setTo(e,s,a)),this._event._stoped)break}},e.getEles=function(t,e,n){for(n?n.length=0:n=[];t&&t!=e;)n.push(t),t=t.parent;return n},e.checkMouseOutAndOverOfMove=function(e,n,i){if(void 0===i&&(i=0),n!=e){var r,a,s=0,o=0;if(n.contains(e))a=this.getEles(e,n,t._tEleArr),this.sendEvents(a,"mouseover",i);else if(e.contains(n))a=this.getEles(n,e,t._tEleArr),this.sendEvents(a,"mouseout",i);else{a=t._tEleArr,a.length=0;var l;l=this.getEles(n,null,t._oldArr);var h;h=this.getEles(e,null,t._newArr),o=l.length;var _=0;for(s=0;s<o;s++){if(r=l[s],(_=h.indexOf(r))>=0){h.splice(_,h.length-_);break}a.push(r)}a.length>0&&this.sendEvents(a,"mouseout",i),h.length>0&&this.sendEvents(h,"mouseover",i)}}},e.onMouseMove=function(e,n){if(this.enable){var i;i=this.getTouchFromArr(n,this.preOvers);var r;i?(this.checkMouseOutAndOverOfMove(e,i.tar),i.tar=e,r=this.getEles(e,null,t._tEleArr)):(r=this.getEles(e,null,t._tEleArr),this.sendEvents(r,"mouseover",n),this.preOvers.push(this.createTouchO(e,n))),this.sendEvents(r,"mousemove",n),this._clearTempArrs()}},e.getLastOvers=function(){return t._tEleArr.length=0,this.preOvers.length>0&&this.preOvers[0].tar?this.getEles(this.preOvers[0].tar,null,t._tEleArr):(t._tEleArr.push(Laya.stage),t._tEleArr)},e.stageMouseOut=function(){var t;t=this.getLastOvers(),this.preOvers.length=0,this.sendEvents(t,"mouseout",0)},e.onMouseUp=function(e,n,i){if(void 0===i&&(i=!1),this.enable){var r,a,s,o,l,h=0,_=0,u=Browser.onMobile;a=this.getEles(e,null,t._tEleArr),this.sendEvents(a,i?"mouseup":"rightmouseup",n);var c;if(c=i?this.preDowns:this.preRightDowns,r=this.getTouchFromArr(n,c)){var d=!1,f=Browser.now();if(d=f-this._lastClickTime<300,this._lastClickTime=f,e==r.tar)l=a;else for(s=this.getEles(r.tar,null,t._oldArr),l=t._newArr,l.length=0,_=s.length,h=0;h<_;h++)o=s[h],a.indexOf(o)>=0&&l.push(o);l.length>0&&this.sendEvents(l,i?"click":"rightclick",n),i&&d&&this.sendEvents(l,"doubleclick",n),this.removeTouchFromArr(n,c),r.tar=null,Pool.recover("TouchData",r)}else;r=this.getTouchFromArr(n,this.preOvers),r&&u&&(l=this.getEles(r.tar,null,l),l&&l.length>0&&this.sendEvents(l,"mouseout",n),this.removeTouchFromArr(n,this.preOvers),r.tar=null,Pool.recover("TouchData",r)),this._clearTempArrs()}},t._oldArr=[],t._newArr=[],t._tEleArr=[],__static(t,["I",function(){return this.I=new t}]),t}(),KeyBoardManager=function(){function t(){}return __class(t,"laya.events.KeyBoardManager"),t.__init__=function(){t._addEvent("keydown"),t._addEvent("keypress"),t._addEvent("keyup")},t._addEvent=function(t){Browser.document.addEventListener(t,function(e){laya.events.KeyBoardManager._dispatch(e,t)},!0)},t._dispatch=function(e,n){if(t.enabled){t._event._stoped=!1,t._event.nativeEvent=e,t._event.keyCode=e.keyCode||e.which||e.charCode,"keydown"===n?t._pressKeys[t._event.keyCode]=!0:"keyup"===n&&(t._pressKeys[t._event.keyCode]=null);for(var i=Laya.stage.focus&&null!=Laya.stage.focus.event&&Laya.stage.focus.displayedInStage?Laya.stage.focus:Laya.stage,r=i;r;)r.event(n,t._event.setTo(n,r,i)),r=r.parent}},t.hasKeyDown=function(e){return t._pressKeys[e]},t._pressKeys={},t.enabled=!0,__static(t,["_event",function(){return this._event=new Event}]),t}(),MouseManager=function(){function t(){this.mouseX=0,this.mouseY=0,this.disableMouseEvent=!1,this.mouseDownTime=0,this.mouseMoveAccuracy=2,this._stage=null,this._target=null,this._lastMoveTimer=0,this._isLeftMouse=!1,this._eventList=[],this._touchIDs={},this._id=1,this._tTouchID=0,this._event=new Event,this._matrix=new Matrix,this._point=new Point,this._rect=new Rectangle,this._prePoint=new Point,this._curTouchID=NaN}__class(t,"laya.events.MouseManager");var e=t.prototype;return e.__init__=function(e,n){var i=this;this._stage=e;var r=this,a=this._eventList;n.oncontextmenu=function(e){if(t.enabled)return!1},n.addEventListener("mousedown",function(e){t.enabled&&(Browser.onIE||e.preventDefault(),a.push(e),r.mouseDownTime=Browser.now())}),n.addEventListener("mouseup",function(e){t.enabled&&(e.preventDefault(),a.push(e),r.mouseDownTime=-Browser.now())},!0),n.addEventListener("mousemove",function(e){if(t.enabled){e.preventDefault();var n=Browser.now();if(n-r._lastMoveTimer<10)return;r._lastMoveTimer=n,a.push(e)}},!0),n.addEventListener("mouseout",function(e){t.enabled&&a.push(e)}),n.addEventListener("mouseover",function(e){t.enabled&&a.push(e)}),n.addEventListener("touchstart",function(e){t.enabled&&(a.push(e),t._isFirstTouch||Input.isInputting||e.preventDefault(),r.mouseDownTime=Browser.now())}),n.addEventListener("touchend",function(e){t.enabled?(t._isFirstTouch||Input.isInputting||e.preventDefault(),t._isFirstTouch=!1,a.push(e),r.mouseDownTime=-Browser.now()):i._curTouchID=NaN},!0),n.addEventListener("touchmove",function(e){t.enabled&&(e.preventDefault(),a.push(e))},!0),n.addEventListener("touchcancel",function(e){t.enabled?(e.preventDefault(),a.push(e)):i._curTouchID=NaN},!0),n.addEventListener("mousewheel",function(e){t.enabled&&a.push(e)}),n.addEventListener("DOMMouseScroll",function(e){t.enabled&&a.push(e)})},e.initEvent=function(t,e){var n=this;n._event._stoped=!1,n._event.nativeEvent=e||t,n._target=null,this._point.setTo(t.pageX||t.clientX,t.pageY||t.clientY),this._stage._canvasTransform.invertTransformPoint(this._point),n.mouseX=this._point.x,n.mouseY=this._point.y,n._event.touchId=t.identifier||0,this._tTouchID=n._event.touchId;var i;i=TouchManager.I._event,i._stoped=!1,i.nativeEvent=n._event.nativeEvent,i.touchId=n._event.touchId},e.checkMouseWheel=function(t){this._event.delta=t.wheelDelta?.025*t.wheelDelta:-t.detail;for(var e=TouchManager.I.getLastOvers(),n=0,i=e.length;n<i;n++){var r=e[n];r.event("mousewheel",this._event.setTo("mousewheel",r,this._target))}},e.onMouseMove=function(t){TouchManager.I.onMouseMove(t,this._tTouchID)},e.onMouseDown=function(t){if(Input.isInputting&&Laya.stage.focus&&Laya.stage.focus.focus&&!Laya.stage.focus.contains(this._target)){var e=Laya.stage.focus._tf||Laya.stage.focus,n=t._tf||t;n instanceof laya.display.Input&&n.multiline==e.multiline?e._focusOut():e.focus=!1}TouchManager.I.onMouseDown(t,this._tTouchID,this._isLeftMouse)},e.onMouseUp=function(t){TouchManager.I.onMouseUp(t,this._tTouchID,this._isLeftMouse)},e.check=function(t,e,n,i){this._point.setTo(e,n),t.fromParentPoint(this._point),e=this._point.x,n=this._point.y;var r=t.scrollRect;if(r&&(this._rect.setTo(r.x,r.y,r.width,r.height),!this._rect.contains(e,n)))return!1;if(!this.disableMouseEvent){if(t.hitTestPrior&&!t.mouseThrough&&!this.hitTest(t,e,n))return!1;for(var a=t._childs.length-1;a>-1;a--){var s=t._childs[a];if(!s.destroyed&&s.mouseEnabled&&s.visible&&this.check(s,e,n,i))return!0}}var o=!(!t.hitTestPrior||t.mouseThrough||this.disableMouseEvent)||this.hitTest(t,e,n);return o?(this._target=t,i.call(this,t)):i===this.onMouseUp&&t===this._stage&&(this._target=this._stage,i.call(this,this._target)),o},e.hitTest=function(t,e,n){var i=!1;if(t.scrollRect&&(e-=t.scrollRect.x,n-=t.scrollRect.y),t.hitArea instanceof laya.utils.HitArea)return t.hitArea.isHit(e,n);if(t.width>0&&t.height>0||t.mouseThrough||t.hitArea)if(t.mouseThrough)i=t.getGraphicBounds().contains(e,n);else{var r=this._rect;t.hitArea?r=t.hitArea:r.setTo(0,0,t.width,t.height),i=r.contains(e,n)}return i},e.runEvent=function(){var e=this._eventList.length;if(e){for(var n,i=this,r=0,a=0,s=0;r<e;){var o=this._eventList[r];switch("mousemove"!==o.type&&(this._prePoint.x=this._prePoint.y=-1e6),o.type){case"mousedown":this._touchIDs[0]=this._id++,t._isTouchRespond?t._isTouchRespond=!1:(i._isLeftMouse=0===o.button,i.initEvent(o),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseDown));break;case"mouseup":i._isLeftMouse=0===o.button,i.initEvent(o),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseUp);break;case"mousemove":Math.abs(this._prePoint.x-o.clientX)+Math.abs(this._prePoint.y-o.clientY)>=this.mouseMoveAccuracy&&(this._prePoint.x=o.clientX,this._prePoint.y=o.clientY,i.initEvent(o),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseMove));break;case"touchstart":t._isTouchRespond=!0,i._isLeftMouse=!0;var l=o.changedTouches;for(a=0,s=l.length;a<s;a++)n=l[a],(t.multiTouchEnabled||isNaN(this._curTouchID))&&(this._curTouchID=n.identifier,this._id%200==0&&(this._touchIDs={}),this._touchIDs[n.identifier]=this._id++,i.initEvent(n,o),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseDown));break;case"touchend":case"touchcancel":t._isTouchRespond=!0,i._isLeftMouse=!0;var h=o.changedTouches;for(a=0,s=h.length;a<s;a++)if(n=h[a],t.multiTouchEnabled||n.identifier==this._curTouchID){this._curTouchID=NaN,i.initEvent(n,o);var _=!1;_=i.check(i._stage,i.mouseX,i.mouseY,i.onMouseUp),_||i.onMouseUp(null)}break;case"touchmove":var u=o.changedTouches;for(a=0,s=u.length;a<s;a++)n=u[a],(t.multiTouchEnabled||n.identifier==this._curTouchID)&&(i.initEvent(n,o),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseMove));break;case"wheel":case"mousewheel":case"DOMMouseScroll":i.checkMouseWheel(o);break;case"mouseout":TouchManager.I.stageMouseOut();break;case"mouseover":i._stage.event("mouseover",i._event.setTo("mouseover",i._stage,i._stage))}r++}this._eventList.length=0}},t.enabled=!0,t.multiTouchEnabled=!0,t._isTouchRespond=!1,t._isFirstTouch=!0,__static(t,["instance",function(){return this.instance=new t}]),t}(),ResourceManager=function(){function t(){this._id=0,this._name=null,this._resources=null,this._memorySize=0,this._garbageCollectionRate=NaN,this._isOverflow=!1,this.autoRelease=!1,this.autoReleaseMaxSize=0,this._id=++t._uniqueIDCounter,this._name="Content Manager",t._isResourceManagersSorted=!1,this._memorySize=0,this._isOverflow=!1,this.autoRelease=!1,this.autoReleaseMaxSize=536870912,this._garbageCollectionRate=.2,t._resourceManagers.push(this),this._resources=[]}__class(t,"laya.resource.ResourceManager");var e=t.prototype;return Laya.imps(e,{"laya.resource.IDispose":!0}),e.getResourceByIndex=function(t){return this._resources[t]},e.getResourcesLength=function(){return this._resources.length},e.addResource=function(t){return t.resourceManager&&t.resourceManager.removeResource(t),-1===this._resources.indexOf(t)&&(t._resourceManager=this,this._resources.push(t),this.addSize(t.memorySize),!0)},e.removeResource=function(t){var e=this._resources.indexOf(t);return-1!==e&&(this._resources.splice(e,1),t._resourceManager=null,this._memorySize-=t.memorySize,!0)},e.unload=function(){for(var t=this._resources.slice(0,this._resources.length),e=0;e<t.length;e++){t[e].dispose()}t.length=0},e.setUniqueName=function(e){
for(var n=!0,i=0;i<t._resourceManagers.length;i++)if(t._resourceManagers[i]._name===e&&t._resourceManagers[i]!==this)return void(n=!1);n?this.name!=e&&(this.name=e,t._isResourceManagersSorted=!1):this.setUniqueName(e.concat("-copy"))},e.dispose=function(){if(this===t._systemResourceManager)throw new Error("systemResourceManager不能被释放！");t._resourceManagers.splice(t._resourceManagers.indexOf(this),1),t._isResourceManagersSorted=!1;for(var e=this._resources.slice(0,this._resources.length),n=0;n<e.length;n++){var i=e[n];i.resourceManager.removeResource(i),i.dispose()}e.length=0},e.addSize=function(t){t&&(this.autoRelease&&t>0&&this._memorySize+t>this.autoReleaseMaxSize&&this.garbageCollection((1-this._garbageCollectionRate)*this.autoReleaseMaxSize),this._memorySize+=t)},e.garbageCollection=function(t){var e=this._resources;e=e.slice(),e.sort(function(t,e){if(!t||!e)throw new Error("a或b不能为空！");return t.released&&e.released?0:t.released?1:e.released?-1:t._lastUseFrameCount-e._lastUseFrameCount});for(var n=Stat.loopCount,i=0,r=e.length;i<r;i++){var a=e[i];if(!(n-a._lastUseFrameCount>1))return void(this._memorySize>=t&&(this._isOverflow=!0));if(a.releaseResource(),this._memorySize<t)return void(this._isOverflow=!1)}},__getset(0,e,"memorySize",function(){return this._memorySize}),__getset(0,e,"name",function(){return this._name},function(e){!e&&""===e||this._name===e||(this._name=e,t._isResourceManagersSorted=!1)}),__getset(0,e,"id",function(){return this._id}),__getset(1,t,"sortedResourceManagersByName",function(){return t._isResourceManagersSorted||(t._isResourceManagersSorted=!0,t._resourceManagers.sort(t.compareResourceManagersByName)),t._resourceManagers}),__getset(1,t,"systemResourceManager",function(){return null===t._systemResourceManager&&(t._systemResourceManager=new t,t._systemResourceManager._name="System Resource Manager"),t._systemResourceManager}),t.__init__=function(){t.currentResourceManager=t.systemResourceManager},t.getLoadedResourceManagerByIndex=function(e){return t._resourceManagers[e]},t.getLoadedResourceManagersCount=function(){return t._resourceManagers.length},t.recreateContentManagers=function(e){void 0===e&&(e=!1);for(var n=t.currentResourceManager,i=0;i<t._resourceManagers.length;i++){t.currentResourceManager=t._resourceManagers[i];for(var r=0;r<t.currentResourceManager._resources.length;r++)t.currentResourceManager._resources[r].releaseResource(e),t.currentResourceManager._resources[r].activeResource(e)}t.currentResourceManager=n},t.releaseContentManagers=function(e){void 0===e&&(e=!1);for(var n=t.currentResourceManager,i=0;i<t._resourceManagers.length;i++){t.currentResourceManager=t._resourceManagers[i];for(var r=0;r<t.currentResourceManager._resources.length;r++){var a=t.currentResourceManager._resources[r];!a.released&&a.releaseResource(e)}}t.currentResourceManager=n},t.compareResourceManagersByName=function(t,e){if(t==e)return 0;var n=t._name,i=e._name;if(null==n)return null==i?0:-1;if(null==i)return 1;var r=n.localeCompare(i);return 0!=r?r:(e.setUniqueName(i),i=e._name,n.localeCompare(i))},t._uniqueIDCounter=0,t._systemResourceManager=null,t._isResourceManagersSorted=!1,t._resourceManagers=[],t.currentResourceManager=null,t}(),DebugConsts=function(){function t(){}return __class(t,"laya.debug.tools.DebugConsts"),t.CLICK_SELECT_COLOR="#ff0000",t.CANVAS_REC_COLOR="#FF00FF",t.RECACHE_REC_COLOR="#00ff00",t.SPRITE_REC_COLOR="#ff0000",t.SPRITE_REC_LINEWIDTH=2,t}(),SoundManager=function(){function t(){}return __class(t,"laya.media.SoundManager"),__getset(1,t,"musicMuted",function(){return t._musicMuted},function(e){e?(t._tMusic&&t.stopSound(t._tMusic),t._musicMuted=e):(t._musicMuted=e,t._tMusic&&t.playMusic(t._tMusic))}),__getset(1,t,"useAudioMusic",function(){return t._useAudioMusic},function(e){t._useAudioMusic=e,e&&(t._musicClass=AudioSound)}),__getset(1,t,"soundMuted",function(){return t._soundMuted},function(e){t._soundMuted=e}),__getset(1,t,"muted",function(){return t._muted},function(e){e&&t.stopAllSound(),t.musicMuted=e,t._muted=e}),__getset(1,t,"autoStopMusic",function(){return t._autoStopMusic},function(e){Laya.stage.off("blur",null,t._stageOnBlur),Laya.stage.off("focus",null,t._stageOnFocus),Laya.stage.off("visibilitychange",null,t._visibilityChange),t._autoStopMusic=e,e&&(Laya.stage.on("blur",null,t._stageOnBlur),Laya.stage.on("focus",null,t._stageOnFocus),Laya.stage.on("visibilitychange",null,t._visibilityChange))}),t.addChannel=function(e){t._channels.indexOf(e)>=0||t._channels.push(e)},t.removeChannel=function(e){var n=0;for(n=t._channels.length-1;n>=0;n--)t._channels[n]==e&&t._channels.splice(n,1)},t.disposeSoundIfNotUsed=function(e){var n=0;for(n=t._channels.length-1;n>=0;n--)if(t._channels[n].url==e)return;t.destroySound(e)},t._visibilityChange=function(){Laya.stage.isVisibility?t._stageOnFocus():t._stageOnBlur()},t._stageOnBlur=function(){t._isActive=!1,t._musicChannel&&(t._musicChannel.isStopped||(t._blurPaused=!0,t._musicLoops=t._musicChannel.loops,t._musicCompleteHandler=t._musicChannel.completeHandler,t._musicPosition=t._musicChannel.position,t._musicChannel.stop(),Laya.stage.once("mousedown",null,t._stageOnFocus))),t.stopAllSound()},t._stageOnFocus=function(){t._isActive=!0,Laya.stage.off("mousedown",null,t._stageOnFocus),t._blurPaused&&(t._tMusic&&t.playMusic(t._tMusic,t._musicLoops,t._musicCompleteHandler,t._musicPosition),t._blurPaused=!1)},t.playSound=function(e,n,i,r,a){if(void 0===n&&(n=1),void 0===a&&(a=0),!t._isActive||!e)return null;if(t._muted)return null;if((e=URL.formatURL(e))==t._tMusic){if(t._musicMuted)return null}else{if(Render.isConchApp){var s=Utils.getFileExtension(e);if("wav"!=s&&"ogg"!=s)return alert("The sound only supports wav or ogg format,for optimal performance reason,please refer to the official website document."),null}if(t._soundMuted)return null}var o=Laya.loader.getRes(e);r||(r=t._soundClass),o||(o=new r,o.load(e),Loader.cacheRes(e,o));var l;return(l=o.play(a,n))?(l.url=e,l.volume=e==t._tMusic?t.musicVolume:t.soundVolume,l.completeHandler=i,l):null},t.destroySound=function(t){var e=Laya.loader.getRes(t);e&&(Loader.clearRes(t),e.dispose())},t.playMusic=function(e,n,i,r){return void 0===n&&(n=0),void 0===r&&(r=0),e=URL.formatURL(e),t._tMusic=e,t._musicChannel&&t._musicChannel.stop(),t._musicChannel=t.playSound(e,n,i,t._musicClass,r)},t.stopSound=function(e){e=URL.formatURL(e);var n,i=0;for(i=t._channels.length-1;i>=0;i--)n=t._channels[i],n.url==e&&n.stop()},t.stopAll=function(){t._tMusic=null;var e,n=0;for(n=t._channels.length-1;n>=0;n--)e=t._channels[n],e.stop()},t.stopAllSound=function(){var e,n=0;for(n=t._channels.length-1;n>=0;n--)e=t._channels[n],e.url!=t._tMusic&&e.stop()},t.stopMusic=function(){t._musicChannel&&t._musicChannel.stop(),t._tMusic=null},t.setSoundVolume=function(e,n){if(n)n=URL.formatURL(n),t._setVolume(n,e);else{t.soundVolume=e;var i,r=0;for(r=t._channels.length-1;r>=0;r--)i=t._channels[r],i.url!=t._tMusic&&(i.volume=e)}},t.setMusicVolume=function(e){t.musicVolume=e,t._setVolume(t._tMusic,e)},t._setVolume=function(e,n){e=URL.formatURL(e);var i,r=0;for(r=t._channels.length-1;r>=0;r--)i=t._channels[r],i.url==e&&(i.volume=n)},t.musicVolume=1,t.soundVolume=1,t.playbackRate=1,t._useAudioMusic=!0,t._muted=!1,t._soundMuted=!1,t._musicMuted=!1,t._tMusic=null,t._musicChannel=null,t._channels=[],t._autoStopMusic=!1,t._blurPaused=!1,t._isActive=!0,t._musicLoops=0,t._musicPosition=0,t._musicCompleteHandler=null,t._soundClass=null,t._musicClass=null,t.autoReleaseSound=!0,t}(),DiagonalMovement=function(){function t(){}return __class(t,"PathFinding.core.DiagonalMovement"),t.Always=1,t.Never=2,t.IfAtMostOneObstacle=3,t.OnlyWhenNoObstacles=4,t}(),Heuristic=function(){function t(){}return __class(t,"PathFinding.core.Heuristic"),t.manhattan=function(t,e){return t+e},t.euclidean=function(t,e){return Math.sqrt(t*t+e*e)},t.octile=function(t,e){var n=Math.SQRT2-1;return t<e?n*t+e:n*e+t},t.chebyshev=function(t,e){return Math.max(t,e)},t}(),Node1=function(){function t(t,e,n){this.x=0,this.y=0,this.g=0,this.f=0,this.h=0,this.by=0,this.parent=null,this.opened=null,this.closed=null,this.tested=null,this.retainCount=null,this.walkable=!1,void 0===n&&(n=!0),this.x=t,this.y=e,this.walkable=n}return __class(t,"PathFinding.core.Node",null,"Node1"),t}(),Grid=function(){function t(t,e,n){this.width=0,this.height=0,this.nodes=null;var i=0;"number"==typeof t?i=t:(e=t.length,i=t[0].length,n=t),this.width=i,this.height=e,this.nodes=this._buildNodes(i,e,n)}__class(t,"PathFinding.core.Grid");var e=t.prototype;return e._buildNodes=function(t,e,n){var i=0,r=0,a=[];for(i=0;i<e;++i)for(a[i]=[],r=0;r<t;++r)a[i][r]=new Node1(r,i);if(null==n)return a;if(n.length!=e||n[0].length!=t)throw new Error("Matrix size does not fit");for(i=0;i<e;++i)for(r=0;r<t;++r)n[i][r]&&(a[i][r].walkable=!1);return a},e.getNodeAt=function(t,e){return this.nodes[e][t]},e.isWalkableAt=function(t,e){return this.isInside(t,e)&&this.nodes[e][t].walkable},e.isInside=function(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height},e.setWalkableAt=function(t,e,n){this.nodes[e][t].walkable=n},e.getNeighbors=function(t,e){var n=t.x,i=t.y,r=[],a=!1,s=!1,o=!1,l=!1,h=!1,_=!1,u=!1,c=!1,d=this.nodes;if(this.isWalkableAt(n,i-1)&&(r.push(d[i-1][n]),a=!0),this.isWalkableAt(n+1,i)&&(r.push(d[i][n+1]),o=!0),this.isWalkableAt(n,i+1)&&(r.push(d[i+1][n]),h=!0),this.isWalkableAt(n-1,i)&&(r.push(d[i][n-1]),u=!0),e==DiagonalMovement.Never)return r;if(e==DiagonalMovement.OnlyWhenNoObstacles)s=u&&a,l=a&&o,_=o&&h,c=h&&u;else if(e==DiagonalMovement.IfAtMostOneObstacle)s=u||a,l=a||o,_=o||h,c=h||u;else{if(e!=DiagonalMovement.Always)throw new Error("Incorrect value of diagonalMovement");s=!0,l=!0,_=!0,c=!0}return s&&this.isWalkableAt(n-1,i-1)&&r.push(d[i-1][n-1]),l&&this.isWalkableAt(n+1,i-1)&&r.push(d[i-1][n+1]),_&&this.isWalkableAt(n+1,i+1)&&r.push(d[i+1][n+1]),c&&this.isWalkableAt(n-1,i+1)&&r.push(d[i+1][n-1]),r},e.clone=function(){var e=0,n=0,i=this.width,r=this.height,a=this.nodes,s=new t(i,r),o=[];for(e=0;e<r;++e)for(o[e]=[],n=0;n<i;++n)o[e][n]=new Node1(n,e,a[e][n].walkable);return s.nodes=o,s},e.reset=function(){for(var t,e=0;e<this.height;++e)for(var n=0;n<this.width;++n)t=this.nodes[e][n],t.g=0,t.f=0,t.h=0,t.by=0,t.parent=null,t.opened=null,t.closed=null,t.tested=null},t.createGridFromAStarMap=function(e){for(var n=e.width,i=e.height,r=e.getPixels(),a=[],s=0,o=0;o<n;o++)for(var l=a[o]=[],h=0;h<i;h++){var _=r[s++],u=r[s++],c=r[s++],d=r[s++];l[h]=255==_&&255==u&&255==c&&255==d?1:0}return new t(n,i,a)},t}(),Util=function(){function t(){}return __class(t,"PathFinding.core.Util"),t.backtrace=function(t){for(var e=[[t.x,t.y]];t.parent;)t=t.parent,e.push([t.x,t.y]);return e.reverse()},t.biBacktrace=function(e,n){var i=t.backtrace(e),r=t.backtrace(n);return i.concat(r.reverse())},t.pathLength=function(t){var e=0,n=0,i=0,r=0,a=0,s=0;for(e=1;e<t.length;++e)i=t[e-1],r=t[e],a=i[0]-r[0],s=i[1]-r[1],n+=Math.sqrt(a*a+s*s);return n},t.interpolate=function(t,e,n,i){var r=Math.abs,a=[],s=0,o=0,l=0,h=0,_=0,u=0;for(l=r(n-t),h=r(i-e),s=t<n?1:-1,o=e<i?1:-1,_=l-h;;){if(a.push([t,e]),t==n&&e==i)break;u=2*_,u>-h&&(_-=h,t+=s),u<l&&(_+=l,e+=o)}return a},t.expandPath=function(e){var n,i,r,a=[],s=e.length,o=0,l=0,h=0;if(s<2)return a;for(l=0;l<s-1;++l)for(n=e[l],i=e[l+1],r=t.interpolate(n[0],n[1],i[0],i[1]),o=r.length,h=0;h<o-1;++h)a.push(r[h]);return a.push(e[s-1]),a},t.smoothenPath=function(e,n){var i,r,a,s,o,l=n.length,h=n[0][0],_=n[0][1],u=n[l-1][0],c=n[l-1][1],d=0,f=0,m=0,p=0,g=0,v=0,x=!1;for(d=h,f=_,i=[[d,f]],g=2;g<l;++g){for(r=n[g],m=r[0],p=r[1],a=t.interpolate(d,f,m,p),x=!1,v=1;v<a.length;++v)if(s=a[v],!e.isWalkableAt(s[0],s[1])){x=!0;break}x&&(o=n[g-1],i.push(o),d=o[0],f=o[1])}return i.push([u,c]),i},t.compressPath=function(t){if(t.length<3)return t;var e=[],n=t[0][0],i=t[0][1],r=t[1][0],a=t[1][1],s=r-n,o=a-i,l=0,h=0,_=0,u=0,c=NaN,d=0;for(c=Math.sqrt(s*s+o*o),s/=c,o/=c,e.push([n,i]),d=2;d<t.length;d++)l=r,h=a,_=s,u=o,r=t[d][0],a=t[d][1],s=r-l,o=a-h,c=Math.sqrt(s*s+o*o),s/=c,o/=c,s===_&&o===u||e.push([l,h]);return e.push([r,a]),e},t}(),HeapFunction=function(){function t(){this.defaultCmp=function(t,e){return t<e?-1:t>e?1:0}}__class(t,"PathFinding.libs.HeapFunction");var e=t.prototype;return e.insort=function(t,e,n,i,r){var a=NaN;if(null==n&&(n=0),null==r&&(r=this.defaultCmp),n<0)throw new Error("lo must be non-negative");for(null==i&&(i=t.length);n<i;)a=Math.floor((n+i)/2),r(e,t[a])<0?i=a:n=a+1;return[].splice.apply(t,[n,n-n].concat(e)),e},e.heappush=function(t,e,n){return null==n&&(n=this.defaultCmp),t.push(e),this._siftdown(t,0,t.length-1,n)},e.heappop=function(t,e){var n,i;return null==e&&(e=this.defaultCmp),n=t.pop(),t.length?(i=t[0],t[0]=n,this._siftup(t,0,e)):i=n,i},e.heapreplace=function(t,e,n){var i;return null==n&&(n=this.defaultCmp),i=t[0],t[0]=e,this._siftup(t,0,n),i},e.heappushpop=function(t,e,n){var i;return null==n&&(n=this.defaultCmp),t.length&&n(t[0],e)<0&&(i=[t[0],e],e=i[0],t[0]=i[1],this._siftup(t,0,n)),e},e.heapify=function(t,e){var n,i,r,a,s=0,o=0,l=0,h=0;for(null==e&&(e=this.defaultCmp),i=function(){for(a=[],l=0,n=Math.floor(t.length/2);0<=n?l<n:l>n;0<=n?l++:l--)a.push(l);return a}.apply(this).reverse(),r=[],o=0,h=i.length;o<h;o++)s=i[o],r.push(this._siftup(t,s,e));return r},e.updateItem=function(t,e,n){var i=0;return null==n&&(n=this.defaultCmp),-1===(i=t.indexOf(e))?null:(this._siftdown(t,0,i,n),this._siftup(t,i,n))},e.nlargest=function(t,e,n){var i,r,a,s=0,o=0;if(null==n&&(n=this.defaultCmp),r=t.slice(0,e),!r.length)return r;for(this.heapify(r,n),a=t.slice(e),s=0,o=a.length;s<o;s++)i=a[s],this.heappushpop(r,i,n);return r.sort(n).reverse()},e.nsmallest=function(t,e,n){var i,r,a,s,o,l,h,_=0,u=0;if(null==n&&(n=this.defaultCmp),10*e<=t.length){if(a=t.slice(0,e).sort(n),!a.length)return a;for(r=a[a.length-1],o=t.slice(e),_=0,s=o.length;_<s;_++)i=o[_],n(i,r)<0&&(this.insort(a,i,0,null,n),a.pop(),r=a[a.length-1]);return a}for(this.heapify(t,n),h=[],u=0,l=Math.min(e,t.length);0<=l?u<l:u>l;0<=l?++u:--u)h.push(this.heappop(t,n));return h},e._siftdown=function(t,e,n,i){var r,a,s=0;for(null==i&&(i=this.defaultCmp),r=t[n];n>e&&(s=n-1>>1,a=t[s],i(r,a)<0);)t[n]=a,n=s;return t[n]=r},e._siftup=function(t,e,n){var i,r=0,a=0,s=0,o=0;for(null==n&&(n=this.defaultCmp),a=t.length,o=e,i=t[e],r=2*e+1;r<a;)s=r+1,s<a&&!(n(t[r],t[s])<0)&&(r=s),t[e]=t[r],e=r,r=2*e+1;return t[e]=i,this._siftdown(t,o,e,n)},t}(),Heap=function(){function t(t){this.cmp=null,this.nodes=null,this.heapFunction=new HeapFunction,this.cmp=null!=t?t:this.heapFunction.defaultCmp,this.nodes=[]}__class(t,"PathFinding.libs.Heap");var e=t.prototype;return e.push=function(t){return this.heapFunction.heappush(this.nodes,t,this.cmp)},e.pop=function(){return this.heapFunction.heappop(this.nodes,this.cmp)},e.peek=function(){return this.nodes[0]},e.contains=function(t){return-1!==this.nodes.indexOf(t)},e.replace=function(t){return this.heapFunction.heapreplace(this.nodes,t,this.cmp)},e.pushpop=function(t){return this.heapFunction.heappushpop(this.nodes,t,this.cmp)},e.heapify=function(){return this.heapFunction.heapify(this.nodes,this.cmp)},e.updateItem=function(t){return this.heapFunction.updateItem(this.nodes,t,this.cmp)},e.clear=function(){return this.nodes=[]},e.empty=function(){return 0===this.nodes.length},e.size=function(){return this.nodes.length},e.clone=function(){var e=new t;return e.nodes=this.nodes.slice(0),e},e.toArray=function(){return this.nodes.slice(0)},t}(),BreadthFirstFinder=function(){function t(t){this.allowDiagonal=!1,this.dontCrossCorners=!1,this.heuristic=null,this.weight=0,this.diagonalMovement=0,t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=DiagonalMovement.OnlyWhenNoObstacles:this.diagonalMovement=DiagonalMovement.IfAtMostOneObstacle:this.diagonalMovement=DiagonalMovement.Never)}return __class(t,"PathFinding.finders.BreadthFirstFinder"),t.prototype.findPath=function(t,e,n,i,r){var a,s,o,l=[],h=this.diagonalMovement,_=r.getNodeAt(t,e),u=r.getNodeAt(n,i),c=0,d=0;for(l.push(_),_.opened=!0;l.length;){if(o=l.shift(),o.closed=!0,o===u)return Util.backtrace(u);for(a=r.getNeighbors(o,h),c=0,d=a.length;c<d;++c)s=a[c],s.closed||s.opened||(l.push(s),s.opened=!0,s.parent=o)}return[]},t}(),Laya3D=function(){function t(){}return __class(t,"Laya3D"),t._changeWebGLSize=function(t,e){WebGL.onStageResize(t,e),RenderState.clientWidth=t,RenderState.clientHeight=e},t.__init__=function(){var e=LoaderManager.createMap;e.lh=[Sprite3D,"SPRITE3DHIERARCHY"],e.ls=[Scene,"SPRITE3DHIERARCHY"],e.lm=[Mesh,"MESH"],e.lmat=[StandardMaterial,"MATERIAL"],e.lpbr=[PBRMaterial,"MATERIAL"],e.ltc=[TextureCube,"TEXTURECUBE"],e.jpg=[Texture2D,"nativeimage"],e.jpeg=[Texture2D,"nativeimage"],e.png=[Texture2D,"nativeimage"],e.pkm=[Texture2D,"arraybuffer"],e.lsani=[AnimationTemplet,"arraybuffer"],e.lrani=[AnimationTemplet,"arraybuffer"],e.raw=[DataTexture2D,"arraybuffer"],e.mipmaps=[DataTexture2D,"arraybuffer"],e.thdata=[TerrainHeightData,"arraybuffer"],e.lt=[TerrainRes,"TERRAIN"],e.lani=[AnimationClip,"arraybuffer"],e.lav=[Avatar,"json"],e.ani=[AnimationTemplet,"arraybuffer"],Loader.parserMap.SPRITE3DHIERARCHY=t._loadHierarchy,Loader.parserMap.MESH=t._loadMesh,Loader.parserMap.MATERIAL=t._loadMaterial,Loader.parserMap.TEXTURECUBE=t._loadTextureCube,Loader.parserMap.TERRAIN=t._loadTerrain,t._innerFirstLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerSecondLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerThirdLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerFourthLevelLoaderManager.on("error",null,t._eventLoadManagerError)},t.READ_BLOCK=function(){return t._readData.pos+=4,!0},t.READ_DATA=function(){return t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32(),!0},t.READ_STRINGS=function(){var e=[],n={offset:0,size:0};n.offset=t._readData.getUint16(),n.size=t._readData.getUint16();t._readData.pos;t._readData.pos=n.offset+t._DATA.offset;for(var i=0;i<n.size;i++){var r=t._readData.readUTFString();-1===r.lastIndexOf(".lmat")&&-1===r.lastIndexOf(".lpbr")||e.push(r)}return e},t._eventLoadManagerError=function(t){Laya.loader.event("error",t)},t._addHierarchyInnerUrls=function(t,e,n,i,r,a){var s=URL.formatURL(r,i);n&&(s+=n),t.push({url:s,clas:a}),e[r]=s},t._getSprite3DHierarchyInnerUrls=function(e,n,i,r,a,s,o){var l,h=0,_=0;switch(e.type){case"Scene":var u=e.customProps.lightmaps;for(h=0,_=u.length;h<_;h++){var c=u[h].replace("exr","png");t._addHierarchyInnerUrls(r,a,s,o,c,Texture2D)}break;case"MeshSprite3D":case"SkinnedMeshSprite3D":var d;if(e.instanceParams)(d=e.instanceParams.loadPath)&&t._addHierarchyInnerUrls(n,a,s,o,d,Mesh);else{l=e.customProps,d=l.meshPath,d&&t._addHierarchyInnerUrls(n,a,s,o,d,Mesh);var f=l.materials;if(f)for(h=0,_=f.length;h<_;h++){var m=f[h],p=m.type.split("."),g=Browser.window;if(p.forEach(function(t){g=g[t]}),"function"!=typeof g)throw"_getSprite3DHierarchyInnerUrls 错误: "+m.type+" 不是类";t._addHierarchyInnerUrls(i,a,s,o,m.path,g)}}break;case"ShuriKenParticle3D":l=e.customProps;var v=l.meshPath;v&&t._addHierarchyInnerUrls(n,a,s,o,v,Mesh);var x=l.material;if(x)t._addHierarchyInnerUrls(i,a,s,o,x.path,ShurikenParticleMaterial);else{var S=l.materialPath;if(S)t._addHierarchyInnerUrls(i,a,s,o,S,ShurikenParticleMaterial);else{var T=l.texturePath;T&&t._addHierarchyInnerUrls(r,a,s,o,T,Texture2D)}}break;case"Terrain":t._addHierarchyInnerUrls(r,a,s,o,e.customProps.dataPath,TerrainRes)}var E=e.components;for(var y in E){var M=E[y];switch(y){case"Animator":var D=M.avatarPath;if(D)t._addHierarchyInnerUrls(r,a,s,o,D,Avatar);else{var C=M.avatar;C&&t._addHierarchyInnerUrls(r,a,s,o,C.path,Avatar)}var R=M.clipPaths;for(h=0,_=R.length;h<_;h++)t._addHierarchyInnerUrls(r,a,s,o,R[h],AnimationClip)}}var A=e.child;for(h=0,_=A.length;h<_;h++)t._getSprite3DHierarchyInnerUrls(A[h],n,i,r,a,s,o)},t._loadHierarchy=function(e){e.on("loaded",null,t._onHierarchylhLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onHierarchylhLoaded=function(e,n){var i=e.url,r=Utils3D.getURLVerion(i),a=URL.getPath(URL.formatURL(i)),s=[],o=[],l=[],h={};t._getSprite3DHierarchyInnerUrls(n,s,o,l,h,r,a);var _=s.length+o.length+l.length,u=_+1,c=1/u;if(t._onProcessChange(e,0,c,1),l.length>0){var d=_/u,f=Handler.create(null,t._onProcessChange,[e,c,d],!1);t._innerFourthLevelLoaderManager.create(l,Handler.create(null,t._onHierarchyInnerForthLevResouLoaded,[e,f,n,h,s,o,c+d*l.length,d]),f)}else t._onHierarchyInnerForthLevResouLoaded(e,null,n,h,s,o,c,d)},t._onHierarchyInnerForthLevResouLoaded=function(e,n,i,r,a,s,o,l){if(n&&n.recover(),s.length>0){var h=Handler.create(null,t._onProcessChange,[e,o,l],!1);t._innerSecondLevelLoaderManager.create(s,Handler.create(null,t._onHierarchyInnerSecondLevResouLoaded,[e,h,i,r,a,o+l*s.length,l]),n)}else t._onHierarchyInnerSecondLevResouLoaded(e,null,i,r,a,o,l)},t._onHierarchyInnerSecondLevResouLoaded=function(e,n,i,r,a,s,o){if(n&&n.recover(),a.length>0){var l=Handler.create(null,t._onProcessChange,[e,s,o],!1);t._innerFirstLevelLoaderManager.create(a,Handler.create(null,t._onHierarchyInnerFirstLevResouLoaded,[e,l,i,r]),n)}else t._onHierarchyInnerFirstLevResouLoaded(e,null,i,r)},t._onHierarchyInnerFirstLevResouLoaded=function(t,e,n,i){e&&e.recover(),t.endLoad([n,i])},t._loadTerrain=function(e){e.on("loaded",null,t._onTerrainLtLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onTerrainLtLoaded=function(e,n){var i,r,a=e.url,s=Utils3D.getURLVerion(a),o=URL.getPath(URL.formatURL(a)),l=[],h={},_=0,u=0,c=n.heightData;i=c.url,r=URL.formatURL(i,o),s&&(r+=s),h[i]=r,i=r;var d=n.detailTexture;for(_=0,u=d.length;_<u;_++)l.push({url:d[_].diffuse});var f=n.normalMap;for(_=0,u=f.length;_<u;_++)l.push({url:f[_]});var m=n.alphaMap;for(_=0,u=m.length;_<u;_++)l.push({url:m[_],params:[!1,!1,6408,!0]});for(_=0,u=l.length;_<u;_++){var p=l[_].url;r=URL.formatURL(p,o),s&&(r+=s),l[_].url=r,h[p]=r}var g=l.length,v=g+2,x=1/v;t._onProcessChange(e,0,x,1);var S={heightMapLoaded:!1,texturesLoaded:!1},T=Handler.create(null,t._onProcessChange,[e,x,x],!1);t._innerFourthLevelLoaderManager.create(i,Handler.create(null,t._onTerrainHeightMapLoaded,[e,T,n,h,S]),T,null,[c.numX,c.numZ,c.bitType,c.value]);var E=Handler.create(null,t._onProcessChange,[e,2*x,g/v],!1);t._innerFourthLevelLoaderManager.create(l,Handler.create(null,t._onTerrainTexturesLoaded,[e,E,n,h,S]),E)},t._onTerrainHeightMapLoaded=function(t,e,n,i,r){r.heightMapLoaded=!0,r.texturesLoaded&&(t.endLoad([n,i]),e.recover())},t._onTerrainTexturesLoaded=function(t,e,n,i,r){r.texturesLoaded=!0,r.heightMapLoaded&&(t.endLoad([n,i]),e.recover())},t._loadMesh=function(e){e.on("loaded",null,t._onMeshLmLoaded,[e]),e.load(e.url,"arraybuffer",!1,null,!0)},t._onMeshLmLoaded=function(e,n){var i,r,a=e.url,s=Utils3D.getURLVerion(a),o=URL.getPath(URL.formatURL(a)),l={},h=0,_=0,u=0;switch(t._readData=new Byte(n),t._readData.pos=0,t._readData.readUTFString()){case"LAYAMODEL:02":case"LAYAMODEL:03":case"LAYAMODEL:0301":var c=t._readData.getUint32();t._readData.pos=t._readData.pos+4,u=t._readData.getUint16(),t._readData.pos=t._readData.pos+8*u;var d=t._readData.getUint32();for(u=t._readData.getUint16(),t._readData.pos=c+d,i=[],h=0;h<u;h++){var f=t._readData.readUTFString();-1!==f.lastIndexOf(".lmat")&&i.push(f)}break;default:for(t.READ_BLOCK(),h=0;h<2;h++){var m=t._readData.getUint16(),p=t._strings[m],g=t["READ_"+p];if(null==g)throw new Error("model file err,no this function:"+m+" "+p);1===h?i=g.call():g.call()}}for(h=0,_=i.length;h<_;h++){var v=i[h];r=URL.formatURL(v,o),s&&(r+=s),i[h]=r,l[v]=r}if(i.length>0){t._onProcessChange(e,0,.5,1);var x=Handler.create(null,t._onProcessChange,[e,.5,.5],!1);t._innerSecondLevelLoaderManager.create(i,Handler.create(null,t._onMeshMateialLoaded,[e,x,n,l]),x)}else e.endLoad([n,l])},t._onMeshMateialLoaded=function(t,e,n,i){t.endLoad([n,i]),e.recover()},t._getMaterialTexturePath=function(t,e,n){var i=t.length-4;return t.indexOf(".dds")!=i&&t.indexOf(".tga")!=i&&t.indexOf(".exr")!=i&&t.indexOf(".DDS")!=i&&t.indexOf(".TGA")!=i&&t.indexOf(".EXR")!=i||(t=t.substr(0,i)+".png"),t=URL.formatURL(t,n),e&&(t+=e),t},t._loadMaterial=function(e){e.on("loaded",null,t._onMaterilLmatLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onMaterilLmatLoaded=function(e,n){var i,r=e.url,a=Utils3D.getURLVerion(r),s=URL.getPath(URL.formatURL(r)),o=[],l={},h=n.customProps,_=n.version;if(_)switch(_){case"LAYAMATERIAL:01":for(var u=n.props.textures,c=0,d=u.length;c<d;c++){var f=u[c],m=f.path;if(m){var p=m.length-4;m.indexOf(".exr")!=p&&m.indexOf(".EXR")!=p||(m=m.substr(0,p)+".png"),i=URL.formatURL(m,s),a&&(i+=a),o.push({url:i,params:f.params}),l[m]=i}}break;default:throw new Error("Laya3D:unkonwn version.")}else{var g=h.diffuseTexture.texture2D;if(g&&(i=t._getMaterialTexturePath(g,a,s),o.push(i),l[g]=i),h.normalTexture){var v=h.normalTexture.texture2D;v&&(i=t._getMaterialTexturePath(v,a,s),o.push(i),l[v]=i)}if(h.specularTexture){var x=h.specularTexture.texture2D;x&&(i=t._getMaterialTexturePath(x,a,s),o.push(i),l[x]=i)}if(h.emissiveTexture){var S=h.emissiveTexture.texture2D;S&&(i=t._getMaterialTexturePath(S,a,s),o.push(i),l[S]=i)}if(h.ambientTexture){var T=h.ambientTexture.texture2D;T&&(i=t._getMaterialTexturePath(T,a,s),o.push(i),l[T]=i)}if(h.reflectTexture){var E=h.reflectTexture.texture2D;E&&(i=t._getMaterialTexturePath(E,a,s),o.push(i),l[E]=i)}}var y=o.length,M=y+1,D=1/M;if(t._onProcessChange(e,0,D,1),y>0){var C=Handler.create(null,t._onProcessChange,[e,D,y/M],!1);t._innerFourthLevelLoaderManager.create(o,Handler.create(null,t._onMateialTexturesLoaded,[e,C,n,l]),C,Texture2D)}else t._onMateialTexturesLoaded(e,null,n,null)},t._onMateialTexturesLoaded=function(t,e,n,i){t.endLoad([n,i]),e&&e.recover()},t._loadTextureCube=function(e){e.on("loaded",null,t._onTextureCubeLtcLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onTextureCubeLtcLoaded=function(e,n){var i=URL.getPath(URL.formatURL(e.url)),r=[URL.formatURL(n.px,i),URL.formatURL(n.nx,i),URL.formatURL(n.py,i),URL.formatURL(n.ny,i),URL.formatURL(n.pz,i),URL.formatURL(n.nz,i)];t._onProcessChange(e,0,1/7,1);var a=Handler.create(null,t._onProcessChange,[e,1/7,6/7],!1);t._innerFourthLevelLoaderManager.load(r,Handler.create(null,t._onTextureCubeImagesLoaded,[e,r,a]),a,"nativeimage")},t._onTextureCubeImagesLoaded=function(t,e,n){var i=[];i.length=6;for(var r=0;r<6;r++){var a=e[r];i[r]=Loader.getRes(a),Loader.clearRes(a)}t.endLoad(i),n.recover()},t._onProcessChange=function(t,e,n,i){(i=e+i*n)<1&&t.event("progress",i)},t.init=function(e,n,i,r,a,s){if(void 0===i&&(i=!1),void 0===r&&(r=!1),void 0===a&&(a=!0),void 0===s&&(s=!0),RunDriver.update3DLoop=function(){CollisionManager._triggerCollision()},Config.isAntialias=i,Config.isAlpha=r,Config.premultipliedAlpha=a,Config.isStencil=s,!Render.isConchNode&&!WebGL.enable())return void alert("Laya3D init error,must support webGL!");RunDriver.changeWebGLSize=t._changeWebGLSize,Render.is3DMode=!0,Laya.init(e,n),Layer.__init__(),Physics.__init__(),ShaderInit3D.__init__(),MeshSprite3D.__init__(),AnimationNode.__init__(),t.__init__(),AtlasResourceManager.maxTextureCount=2,(t.debugMode||OctreeNode.debugMode)&&(t._debugPhasorSprite=new PhasorSpriter3D)},t.HIERARCHY="SPRITE3DHIERARCHY",t.MESH="MESH",t.MATERIAL="MATERIAL",t.PBRMATERIAL="PBRMTL",t.TEXTURECUBE="TEXTURECUBE",t.TERRAIN="TERRAIN",t._readData=null,t._debugPhasorSprite=null,t.debugMode=!1,__static(t,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new LoaderManager},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new LoaderManager},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new LoaderManager},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new LoaderManager}]),t}(),Config=function(){function t(){}return __class(t,"Config"),t.WebGLTextCacheCount=500,t.atlasEnable=!1,t.showCanvasMark=!1,t.animationInterval=50,t.isAntialias=!1,t.isAlpha=!1,t.premultipliedAlpha=!0,t.isStencil=!0,t.preserveDrawingBuffer=!1,t}(),ColorFilter=function(t){function e(t){e.__super.call(this),t||(t=[.3,.59,.11,0,0,.3,.59,.11,0,0,.3,.59,.11,0,0,0,0,0,1,0]),this._mat=new Float32Array(16),this._alpha=new Float32Array(4);for(var n=0,i=0,r=0;r<20;r++)r%5!=4?this._mat[n++]=t[r]:this._alpha[i++]=t[r];this._action=RunDriver.createFilterAction(32),this._action.data=this}__class(e,"laya.filters.ColorFilter",t);var n=e.prototype;return Laya.imps(n,{"laya.filters.IFilter":!0}),n.callNative=function(t){t._$P.cf=this;t.conchModel&&t.conchModel.setFilterMatrix&&t.conchModel.setFilterMatrix(this._mat,this._alpha)},__getset(0,n,"action",function(){return this._action}),__getset(0,n,"type",function(){return 32}),e}(Filter),ColorFilterActionGL=function(t){function e(){this.data=null,e.__super.call(this)}__class(e,"laya.filters.webgl.ColorFilterActionGL",t);var n=e.prototype;return Laya.imps(n,{"laya.filters.IFilterActionGL":!0}),n.setValue=function(t){t.colorMat=this.data._mat,t.colorAlpha=this.data._alpha},n.apply3d=function(t,e,n,i,r){var a=t.getValue("bounds"),s=Value2D.create(1,0);s.setFilters([this.data]);var o=Matrix.TEMP;o.identity(),n.ctx.drawTarget(t,0,0,a.width,a.height,o,"src",s)},e}(FilterActionGL),Node=function(t){function e(){this._bits=0,this._displayedInStage=!1,this._parent=null,this.conchModel=null,this.name="",this.destroyed=!1,e.__super.call(this),this._childs=e.ARRAY_EMPTY,this._$P=e.PROP_EMPTY,this.timer=Laya.scaleTimer,this.conchModel=Render.isConchNode?this.createConchModel():null}__class(e,"laya.display.Node",t);var n=e.prototype;return n._setBit=function(t,e){if(1==t){this._getBit(t)!=e&&this._updateDisplayedInstage()}e?this._bits|=t:this._bits&=~t},n._getBit=function(t){return 0!=(this._bits&t)},n._setUpNoticeChain=function(){this._getBit(1)&&this._setUpNoticeType(1)},n._setUpNoticeType=function(t){var e=this;for(e._setBit(t,!0),e=e.parent;e;){if(e._getBit(t))return;e._setBit(t,!0),e=e.parent}},n.on=function(t,e,n,i){return"display"!==t&&"undisplay"!==t||this._getBit(1)||this._setUpNoticeType(1),this._createListener(t,e,n,i,!1)},n.once=function(t,e,n,i){return"display"!==t&&"undisplay"!==t||this._getBit(1)||this._setUpNoticeType(1),this._createListener(t,e,n,i,!0)},n.createConchModel=function(){return null},n.destroy=function(t){void 0===t&&(t=!0),this.destroyed=!0,this._parent&&this._parent.removeChild(this),this._childs&&(t?this.destroyChildren():this.removeChildren()),this._childs=null,this._$P=null,this.offAll(),this.timer.clearAll(this)},n.destroyChildren=function(){if(this._childs)for(var t=this._childs.length-1;t>-1;t--)this._childs[t].destroy(!0)},n.addChild=function(t){if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var n=this.getChildIndex(t);n!==this._childs.length-1&&(this._childs.splice(n,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else t.parent&&t.parent.removeChild(t),this._childs===e.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged();return t},n.addChildren=function(t){for(var e=arguments,n=0,i=e.length;n<i;)this.addChild(e[n++])},n.addChildAt=function(t,n){if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),n>=0&&n<=this._childs.length){if(t._parent===this){var i=this.getChildIndex(t);this._childs.splice(i,1),this._childs.splice(n,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,n)),this._childChanged()}else t.parent&&t.parent.removeChild(t),this._childs===e.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(n,0,t),
this.conchModel&&this.conchModel.addChildAt(t.conchModel,n),t.parent=this;return t}throw new Error("appendChildAt:The index is out of bounds")},n.getChildIndex=function(t){return this._childs.indexOf(t)},n.getChildByName=function(t){var e=this._childs;if(e)for(var n=0,i=e.length;n<i;n++){var r=e[n];if(r.name===t)return r}return null},n._get$P=function(t){return this._$P[t]},n._set$P=function(t,n){return this.destroyed||(this._$P===e.PROP_EMPTY&&(this._$P={}),this._$P[t]=n),n},n.getChildAt=function(t){return this._childs[t]},n.setChildIndex=function(t,e){var n=this._childs;if(e<0||e>=n.length)throw new Error("setChildIndex:The index is out of bounds.");var i=this.getChildIndex(t);if(i<0)throw new Error("setChildIndex:node is must child of this object.");return n.splice(i,1),n.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged(),t},n._childChanged=function(t){},n.removeChild=function(t){if(!this._childs)return t;var e=this._childs.indexOf(t);return this.removeChildAt(e)},n.removeSelf=function(){return this._parent&&this._parent.removeChild(this),this},n.removeChildByName=function(t){var e=this.getChildByName(t);return e&&this.removeChild(e),e},n.removeChildAt=function(t){var e=this.getChildAt(t);return e&&(this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null),e},n.removeChildren=function(t,n){if(void 0===t&&(t=0),void 0===n&&(n=2147483647),this._childs&&this._childs.length>0){var i=this._childs;if(0===t&&n>=s){var r=i;this._childs=e.ARRAY_EMPTY}else r=i.splice(t,n-t);for(var a=0,s=r.length;a<s;a++)r[a].parent=null,this.conchModel&&this.conchModel.removeChild(r[a].conchModel)}return this},n.replaceChild=function(t,e){var n=this._childs.indexOf(e);return n>-1?(this._childs.splice(n,1,t),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(t.conchModel,n)),e.parent=null,t.parent=this,t):null},n._updateDisplayedInstage=function(){var t;t=this;var e=Laya.stage;for(this._displayedInStage=!1;t;){if(t._getBit(1)){this._displayedInStage=t._displayedInStage;break}if(t==e||t._displayedInStage){this._displayedInStage=!0;break}t=t.parent}},n._setDisplay=function(t){this._displayedInStage!==t&&(this._displayedInStage=t,t?this.event("display"):this.event("undisplay"))},n._displayChild=function(t,e){var n=t._childs;if(n)for(var i=0,r=n.length;i<r;i++){var a=n[i];a._getBit(1)&&(a._childs.length>0?this._displayChild(a,e):a._setDisplay(e))}t._setDisplay(e)},n.contains=function(t){if(t===this)return!0;for(;t;){if(t.parent===this)return!0;t=t.parent}return!1},n.timerLoop=function(t,e,n,i,r,a){void 0===r&&(r=!0),void 0===a&&(a=!1),this.timer.loop(t,e,n,i,r,a)},n.timerOnce=function(t,e,n,i,r){void 0===r&&(r=!0),this.timer._create(!1,!1,t,e,n,i,r)},n.frameLoop=function(t,e,n,i,r){void 0===r&&(r=!0),this.timer._create(!0,!0,t,e,n,i,r)},n.frameOnce=function(t,e,n,i,r){void 0===r&&(r=!0),this.timer._create(!0,!1,t,e,n,i,r)},n.clearTimer=function(t,e){this.timer.clear(t,e)},__getset(0,n,"displayedInStage",function(){return this._getBit(1)?this._displayedInStage:(this._setUpNoticeType(1),this._displayedInStage)}),__getset(0,n,"parent",function(){return this._parent},function(t){this._parent!==t&&(t?(this._parent=t,this.event("added"),this._getBit(1)&&(this._setUpNoticeChain(),t.displayedInStage&&this._displayChild(this,!0)),t._childChanged(this)):(this.event("removed"),this._parent._childChanged(),this._getBit(1)&&this._displayChild(this,!1),this._parent=t))}),__getset(0,n,"numChildren",function(){return this._childs.length}),e.ARRAY_EMPTY=[],e.PROP_EMPTY={},e.NOTICE_DISPLAY=1,e.MOUSEENABLE=2,e}(EventDispatcher),Resource=function(t){function e(){e.__super.call(this),this._$1__id=++e._uniqueIDCounter,this.__loaded=!0,this._disposed=!1,e._loadedResources.push(this),this._released=!0,this.lock=!1,this._memorySize=0,this._lastUseFrameCount=-1,ResourceManager.currentResourceManager&&ResourceManager.currentResourceManager.addResource(this)}__class(e,"laya.resource.Resource",t);var n=e.prototype;return Laya.imps(n,{"laya.resource.IDispose":!0,"laya.resource.ICreateResource":!0}),n._endLoaded=function(){this.__loaded=!0,this.event("loaded",this)},n.recreateResource=function(){this.completeCreate()},n.detoryResource=function(){},n.activeResource=function(t){void 0===t&&(t=!1),this._lastUseFrameCount=Stat.loopCount,this._disposed||!this._released&&!t||this.recreateResource()},n.releaseResource=function(t){return void 0===t&&(t=!1),!(!t&&this.lock)&&(!(this._released&&!t)&&(this.detoryResource(),this._released=!0,this._lastUseFrameCount=-1,this.event("released",this),!0))},n.onAsynLoaded=function(t,e,n){throw new Error("Resource: must override this function!")},n.dispose=function(){if(!this._disposed){null!==this._resourceManager&&this._resourceManager.removeResource(this),this._disposed=!0,this.lock=!1,this.releaseResource();var t=e._loadedResources.indexOf(this);-1!==t&&e._loadedResources.splice(t,1),Loader.clearRes(this._url)}},n.completeCreate=function(){this._released=!1,this.event("recovered",this)},__getset(0,n,"url",function(){return this._url},function(t){this._url=t}),__getset(0,n,"resourceManager",function(){return this._resourceManager}),__getset(0,n,"released",function(){return this._released}),__getset(0,n,"loaded",function(){return this.__loaded}),__getset(0,n,"disposed",function(){return this._disposed}),__getset(0,n,"_loaded",null,function(t){this.__loaded=t}),__getset(0,n,"memorySize",function(){return this._memorySize},function(t){var e=t-this._memorySize;this._memorySize=t,this.resourceManager&&this.resourceManager.addSize(e)}),__getset(0,n,"id",function(){return this._$1__id}),e.getLoadedResourceByIndex=function(t){return e._loadedResources[t]},e.getLoadedResourcesCount=function(){return e._loadedResources.length},e._uniqueIDCounter=0,e._loadedResources=[],e}(EventDispatcher),Loader=function(t){function e(){this._data=null,this._url=null,this._type=null,this._cache=!1,this._http=null,this._customParse=!1,e.__super.call(this)}__class(e,"laya.net.Loader",t);var n=e.prototype;return n.load=function(t,n,i,r,a){if(void 0===i&&(i=!0),void 0===a&&(a=!1),this._url=t,0===t.indexOf("data:image")?this._type=n="image":(this._type=n||(n=this.getTypeFromUrl(t)),t=URL.formatURL(t)),this._cache=i,this._data=null,!a&&e.loadedMap[t])return this._data=e.loadedMap[t],this.event("progress",1),void this.event("complete",this._data);if(r&&e.setGroup(t,r),null!=e.parserMap[n])return this._customParse=!0,void(e.parserMap[n]instanceof laya.utils.Handler?e.parserMap[n].runWith(this):e.parserMap[n].call(null,this));if("image"===n||"htmlimage"===n||"nativeimage"===n)return this._loadImage(t);if("sound"===n)return this._loadSound(t);if("atlas"==n&&e.preLoadedAtlasConfigMap[t])return this.onLoaded(e.preLoadedAtlasConfigMap[t]),void delete e.preLoadedAtlasConfigMap[t];this._http||(this._http=new HttpRequest,this._http.on("progress",this,this.onProgress),this._http.on("error",this,this.onError),this._http.on("complete",this,this.onLoaded));var s;switch(n){case"atlas":s="json";break;case"font":s="xml";break;case"pkm":s="arraybuffer";break;default:s=n}this._http.send(t,null,"get",s)},n.getTypeFromUrl=function(t){var n=Utils.getFileExtension(t);return n?e.typeMap[n]:(console.warn("Not recognize the resources suffix",t),"text")},n._loadImage=function(t){function n(){i.onload=null,i.onerror=null,delete e.imgCache[t]}t=URL.formatURL(t);var i,r=this,a=function(){n(),r.onLoaded(i)},s=function(){n(),r.event("error","Load image failed")};"nativeimage"===this._type?(i=new Browser.window.Image,i.crossOrigin="",i.onload=a,i.onerror=s,i.src=t,e.imgCache[t]=i):new HTMLImage.create(t,{onload:a,onerror:s,onCreate:function(n){i=n,e.imgCache[t]=n}})},n._loadSound=function(t){function e(){i(),a.onLoaded(r)}function n(){i(),r.dispose(),a.event("error","Load sound failed")}function i(){r.offAll()}var r=new SoundManager._soundClass,a=this;r.on("complete",this,e),r.on("error",this,n),r.load(t)},n.onProgress=function(t){"atlas"===this._type?this.event("progress",.3*t):this.event("progress",t)},n.onError=function(t){this.event("error",t)},n.onLoaded=function(t){var n=this._type;if("image"===n){var i=new Texture(t);i.url=this._url,this.complete(i)}else if("sound"===n||"htmlimage"===n||"nativeimage"===n)this.complete(t);else if("atlas"===n){if(!t.src&&!t._setContext){if(!this._data){if(this._data=t,t.meta&&t.meta.image)for(var r=t.meta.image.split(","),a=this._url.indexOf("/")>=0?"/":"\\",s=this._url.lastIndexOf(a),o=s>=0?this._url.substr(0,s+1):"",l=0,h=r.length;l<h;l++)r[l]=o+r[l];else r=[this._url.replace(".json",".png")];r.reverse(),t.toLoads=r,t.pics=[]}return this.event("progress",.3+1/r.length*.6),this._loadImage(r.pop())}if(this._data.pics.push(t),this._data.toLoads.length>0)return this.event("progress",.3+1/this._data.toLoads.length*.6),this._loadImage(this._data.toLoads.pop());var _=this._data.frames,u=this._url.split("?")[0],c=this._data.meta&&this._data.meta.prefix?this._data.meta.prefix:u.substring(0,u.lastIndexOf("."))+"/",d=this._data.pics,f=URL.formatURL(this._url),m=e.atlasMap[f]||(e.atlasMap[f]=[]);m.dir=c;for(var p in _){var g=_[p],v=d[g.frame.idx?g.frame.idx:0],x=URL.formatURL(c+p);e.cacheRes(x,Texture.create(v,g.frame.x,g.frame.y,g.frame.w,g.frame.h,g.spriteSourceSize.x,g.spriteSourceSize.y,g.sourceSize.w,g.sourceSize.h)),e.loadedMap[x].url=x,m.push(x)}delete this._data.pics,this.complete(this._data)}else if("font"==n){if(!t.src)return this._data=t,this.event("progress",.5),this._loadImage(this._url.replace(".fnt",".png"));var S=new BitmapFont;S.parseFont(this._data,t);var T=this._url.split(".fnt")[0].split("/"),E=T[T.length-1];Text.registerBitmapFont(E,S),this._data=S,this.complete(this._data)}else if("pkm"==n){var y=HTMLImage.create(t,this._url),M=new Texture(y);M.url=this._url,this.complete(M)}else this.complete(t)},n.complete=function(t){this._data=t,this._customParse?this.event("loaded",t instanceof Array?[t]:t):(e._loaders.push(this),e._isWorking||e.checkNext())},n.endLoad=function(t){t&&(this._data=t),this._cache&&e.cacheRes(this._url,this._data),this._customParse=!1,this.event("progress",1),this.event("complete",this.data instanceof Array?[this.data]:this.data)},__getset(0,n,"data",function(){return this._data}),__getset(0,n,"cache",function(){return this._cache}),__getset(0,n,"type",function(){return this._type}),__getset(0,n,"url",function(){return this._url}),e.checkNext=function(){e._isWorking=!0;for(var t=Browser.now();e._startIndex<e._loaders.length;)if(Browser.now(),e._loaders[e._startIndex].endLoad(),e._startIndex++,Browser.now()-t>e.maxTimeOut)return console.warn("loader callback cost a long time:"+(Browser.now()-t)+" url="+e._loaders[e._startIndex-1].url),void Laya.timer.frameOnce(1,null,e.checkNext);e._loaders.length=0,e._startIndex=0,e._isWorking=!1},e.clearRes=function(t,n){void 0===n&&(n=!1),t=URL.formatURL(t);var i=e.getAtlas(t);if(i){for(var r=0,a=i.length;r<a;r++){var s=i[r],o=e.getRes(s);delete e.loadedMap[s],o&&o.destroy(n)}i.length=0,delete e.atlasMap[t],delete e.loadedMap[t]}else{var l=e.loadedMap[t];l&&(delete e.loadedMap[t],l instanceof laya.resource.Texture&&l.bitmap&&l.destroy(n))}},e.clearTextureRes=function(t){t=URL.formatURL(t);var e=laya.net.Loader.getAtlas(t),n=e&&e.length>0?laya.net.Loader.getRes(e[0]):laya.net.Loader.getRes(t);n&&n.bitmap&&(Render.isConchApp?n.bitmap.source.releaseTexture&&n.bitmap.source.releaseTexture():null==n.bitmap._atlaser&&n.bitmap.releaseResource(!0))},e.setAtlasConfigs=function(t,n){e.preLoadedAtlasConfigMap[URL.formatURL(t)]=n},e.getRes=function(t){return e.loadedMap[URL.formatURL(t)]},e.getAtlas=function(t){return e.atlasMap[URL.formatURL(t)]},e.cacheRes=function(t,n){t=URL.formatURL(t),null!=e.loadedMap[t]?console.warn("Resources already exist,is repeated loading:",t):e.loadedMap[t]=n},e.setGroup=function(t,n){e.groupMap[n]||(e.groupMap[n]=[]),e.groupMap[n].push(t)},e.clearResByGroup=function(t){if(e.groupMap[t]){var n=e.groupMap[t],i=0,r=n.length;for(i=0;i<r;i++)e.clearRes(n[i]);n.length=0}},e.TEXT="text",e.JSON="json",e.XML="xml",e.BUFFER="arraybuffer",e.IMAGE="image",e.SOUND="sound",e.ATLAS="atlas",e.FONT="font",e.PKM="pkm",e.typeMap={png:"image",jpg:"image",jpeg:"image",txt:"text",json:"json",xml:"xml",als:"atlas",atlas:"atlas",mp3:"sound",ogg:"sound",wav:"sound",part:"json",fnt:"font",pkm:"pkm"},e.parserMap={},e.groupMap={},e.maxTimeOut=100,e.loadedMap={},e.preLoadedAtlasConfigMap={},e.atlasMap={},e._loaders=[],e._isWorking=!1,e._startIndex=0,e.imgCache={},e}(EventDispatcher),HttpRequest=function(t){function e(){this._responseType=null,this._data=null,e.__super.call(this),this._http=new Browser.window.XMLHttpRequest}__class(e,"laya.net.HttpRequest",t);var n=e.prototype;return n.send=function(t,e,n,i,r){void 0===n&&(n="get"),void 0===i&&(i="text"),this._responseType=i,this._data=null;var a=this,s=this._http;if(s.open(n,t,!0),r)for(var o=0;o<r.length;o++)s.setRequestHeader(r[o++],r[o]);else Render.isConchApp||(e&&"string"!=typeof e?s.setRequestHeader("Content-Type","application/json"):s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"));s.responseType="arraybuffer"!==i?"text":"arraybuffer",s.onerror=function(t){a._onError(t)},s.onabort=function(t){a._onAbort(t)},s.onprogress=function(t){a._onProgress(t)},s.onload=function(t){a._onLoad(t)},s.send(e)},n._onProgress=function(t){t&&t.lengthComputable&&this.event("progress",t.loaded/t.total)},n._onAbort=function(t){this.error("Request was aborted by user")},n._onError=function(t){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)},n._onLoad=function(t){var e=this._http,n=void 0!==e.status?e.status:200;200===n||204===n||0===n?this.complete():this.error("["+e.status+"]"+e.statusText+":"+e.responseURL)},n.error=function(t){this.clear(),this.event("error",t)},n.complete=function(){this.clear();var t=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=Utils.parseXMLFromString(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(e){t=!1,this.error(e.message)}t&&this.event("complete",this._data instanceof Array?[this._data]:this._data)},n.clear=function(){var t=this._http;t.onerror=t.onabort=t.onprogress=t.onload=null},__getset(0,n,"data",function(){return this._data}),__getset(0,n,"http",function(){return this._http}),__getset(0,n,"url",function(){return this._http.responseURL}),e}(EventDispatcher),LoaderManager=function(t){function e(){this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loaders=[],this._loaderCount=0,this._resInfos=[],this._infoPool=[],this._maxPriority=5,this._failRes={},e.__super.call(this);for(var t=0;t<this._maxPriority;t++)this._resInfos[t]=[]}var n;__class(e,"laya.net.LoaderManager",t);var i=e.prototype;return i.create=function(t,e,n,i,r,a,s){function o(t,n){u++,t.progress=1,u===_&&e&&e.run()}function l(t,e){t.progress=e;for(var n=0,i=0;i<_;i++){n+=h[i].progress}var r=n/_;c.runWith(r)}if(void 0===a&&(a=1),void 0===s&&(s=!0),t instanceof Array){var h=t,_=h.length,u=0;if(n)var c=Handler.create(n.caller,n.method,n.args,!1);for(var d=0;d<_;d++){var f=h[d];"string"==typeof f&&(f=h[d]={url:f}),f.progress=0;var m=n?Handler.create(null,l,[f],!1):null,p=n||e?Handler.create(null,o,[f]):null;this._create(f.url,p,m,f.clas||i,f.params||r,f.priority||a,s)}return!0}return this._create(t,e,n,i,r,a,s)},i._create=function(t,n,i,r,a,s,o){function l(e){h&&!h.disposed&&e&&h.onAsynLoaded.call(h,t,e,a),n&&n.run(),Laya.loader.event(t)}void 0===s&&(s=1),void 0===o&&(o=!0),t=URL.formatURL(t);var h=this.getRes(t);if(h)!h.hasOwnProperty("loaded")||h.loaded?(i&&i.runWith(1),n&&n.run()):n&&Laya.loader._createListener(t,n.caller,n.method,n.args,!0,!1);else{var _=Utils.getFileExtension(t),u=e.createMap[_];if(!u)throw new Error("LoaderManager:unknown file("+t+") extension with: "+_+".");r||(r=u[0]);var c=u[1];"atlas"==_?this.load(t,n,i,c,s,o):(r===Texture&&(c="htmlimage"),h=r?new r:null,h.hasOwnProperty("_loaded")&&(h._loaded=!1),this.load(t,Handler.create(null,l),i,c,s,!1,null,!0),o&&(this.cacheRes(t,h),h.url=t))}return h},i.load=function(t,i,r,a,s,o,l,h){var _=this;if(void 0===s&&(s=1),void 0===o&&(o=!0),void 0===h&&(h=!1),t instanceof Array)return this._loadAssets(t,i,r,a,s,o,l);var u=Loader.getRes(t);if(null!=u)Laya.timer.frameOnce(1,null,function(){r&&r.runWith(1),i&&i.runWith(u),_._loaderCount||_.event("complete")});else{var c=e._resMap[t];c?(i&&c._createListener("complete",i.caller,i.method,i.args,!1,!1),r&&c._createListener("progress",r.caller,r.method,r.args,!1,!1)):(c=this._infoPool.length?this._infoPool.pop():new n,c.url=t,c.type=a,c.cache=o,c.group=l,c.ignoreCache=h,i&&c.on("complete",i.caller,i.method,i.args),r&&c.on("progress",r.caller,r.method,r.args),e._resMap[t]=c,s=s<this._maxPriority?s:this._maxPriority-1,this._resInfos[s].push(c),this._next())}return this},i._next=function(){if(!(this._loaderCount>=this.maxLoader)){for(var t=0;t<this._maxPriority;t++)for(var e=this._resInfos[t];e.length>0;){var n=e.shift();if(n)return this._doLoad(n)}this._loaderCount||this.event("complete")}},i._doLoad=function(t){function e(e){n.offAll(),n._data=null,i._loaders.push(n),i._endLoad(t,e instanceof Array?[e]:e),i._loaderCount--,i._next()}this._loaderCount++;var n=this._loaders.length?this._loaders.pop():new Loader;n.on("complete",null,e),n.on("progress",null,function(e){t.event("progress",e)}),n.on("error",null,function(t){e(null)});var i=this;n.load(t.url,t.type,t.cache,t.group,t.ignoreCache)},i._endLoad=function(t,n){var i=t.url;if(null==n){var r=this._failRes[i]||0;if(r<this.retryNum)return console.warn("[warn]Retry to load:",i),this._failRes[i]=r+1,void Laya.timer.once(this.retryDelay,this,this._addReTry,[t],!1);console.warn("[error]Failed to load:",i),this.event("error",i)}this._failRes[i]&&(this._failRes[i]=0),delete e._resMap[i],t.event("complete",n),t.offAll(),this._infoPool.push(t)},i._addReTry=function(t){this._resInfos[this._maxPriority-1].push(t),this._next()},i.clearRes=function(t,e){void 0===e&&(e=!1),Loader.clearRes(t,e)},i.getRes=function(t){return Loader.getRes(t)},i.cacheRes=function(t,e){Loader.cacheRes(t,e)},i.clearTextureRes=function(t){Loader.clearTextureRes(t)},i.setGroup=function(t,e){Loader.setGroup(t,e)},i.clearResByGroup=function(t){Loader.clearResByGroup(t)},i.clearUnLoaded=function(){for(var t=0;t<this._maxPriority;t++){for(var n=this._resInfos[t],i=n.length-1;i>-1;i--){var r=n[i];r&&(r.offAll(),this._infoPool.push(r))}n.length=0}this._loaderCount=0,e._resMap={}},i.cancelLoadByUrls=function(t){if(t)for(var e=0,n=t.length;e<n;e++)this.cancelLoadByUrl(t[e])},i.cancelLoadByUrl=function(t){for(var n=0;n<this._maxPriority;n++)for(var i=this._resInfos[n],r=i.length-1;r>-1;r--){var a=i[r];a&&a.url===t&&(i[r]=null,a.offAll(),this._infoPool.push(a))}e._resMap[t]&&delete e._resMap[t]},i._loadAssets=function(t,e,n,i,r,a,s){function o(t,n){_++,t.progress=1,n||(d=!1),_===h&&e&&e.runWith(d)}function l(t,e){if(null!=n){t.progress=e;for(var i=0,r=0;r<c.length;r++){var a=c[r];i+=a.size*a.progress}var s=i/u;n.runWith(s)}}void 0===r&&(r=1),void 0===a&&(a=!0);for(var h=t.length,_=0,u=0,c=[],d=!0,f=0;f<h;f++){var m=t[f];"string"==typeof m&&(m={url:m,type:i,size:1,priority:r}),m.size||(m.size=1),m.progress=0,u+=m.size,c.push(m);var p=n?Handler.create(null,l,[m],!1):null,g=e||n?Handler.create(null,o,[m]):null;this.load(m.url,g,p,m.type,m.priority||1,a,m.group||s)}return this},e.cacheRes=function(t,e){Loader.cacheRes(t,e)},e._resMap={},__static(e,["createMap",function(){return this.createMap={atlas:[null,"atlas"]}}]),e.__init$=function(){n=function(t){function e(){this.url=null,this.type=null,this.cache=!1,this.group=null,this.ignoreCache=!1,e.__super.call(this)}return __class(e,"",t),e}(EventDispatcher)},e}(EventDispatcher),SkinMeshCanvas=function(t){function e(){e.__super.call(this),this.mesh=new MeshData}__class(e,"laya.ani.bone.canvasmesh.SkinMeshCanvas",t);var n=e.prototype;return n.init2=function(t,e,n,i,r){this.transform&&(this.transform=null);var a;n?a=n:(a=[],a.push(0,1,3,3,1,2)),this.mesh.texture=t,this.mesh.indexes=a,this.mesh.vertices=i,this.mesh.uvs=r},n.render=function(t,n,i){this.mesh.texture&&(this.transform?(this.transform.translate(n,i),this.renderToContext(t),this.transform.translate(-n,-i)):(this.transform=e._tempMatrix,this.transform.identity(),this.transform.translate(n,i),this.renderToContext(t),this.transform.translate(-n,-i),this.transform=null))},__static(e,["_tempMatrix",function(){return this._tempMatrix=new Matrix}]),e}(CanvasMeshRender),Texture=function(t){function e(t,n){this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this._w=0,this._h=0,this._uvID=0,this._atlasID=-1,e.__super.call(this),t&&t.useNum++,this.setTo(t,n)}__class(e,"laya.resource.Texture",t);var n=e.prototype;return n.setTo=function(t,n){if(this.bitmap=t,this.uv=n||e.DEF_UV,t){this._w=t.width,this._h=t.height,this.sourceWidth=this.sourceWidth||this._w,this.sourceHeight=this.sourceHeight||this._h,this._loaded=this._w>0;var i=this;if(this._loaded)RunDriver.addToAtlas&&RunDriver.addToAtlas(i);else{var r=t;r instanceof laya.resource.HTMLImage&&r.image&&r.image.addEventListener("load",function(t){RunDriver.addToAtlas&&RunDriver.addToAtlas(i)},!1)}}},n.active=function(){this.bitmap&&this.bitmap.activeResource()},n.destroy=function(t){if(void 0===t&&(t=!1),this.bitmap&&this.bitmap.useNum>0){var e=this.bitmap;t?(Render.isConchApp&&e.source&&e.source.conchDestroy&&this.bitmap.source.conchDestroy(),this.bitmap=null,e.dispose(),e.useNum=0):0==--e.useNum&&(Render.isConchApp&&e.source&&e.source.conchDestroy&&this.bitmap.source.conchDestroy(),this.bitmap=null,e.dispose()),this.url&&this===Laya.loader.getRes(this.url)&&Laya.loader.clearRes(this.url,t),this._loaded=!1}},n.load=function(t){var e=this;this._loaded=!1,t=URL.customFormat(t);var n=this.bitmap||(this.bitmap=HTMLImage.create(t));n&&n.useNum++;var i=this;n.onload=function(){n.onload=null,i._loaded=!0,e.sourceWidth=e._w=n.width,e.sourceHeight=e._h=n.height,i.event("loaded",this),RunDriver.addToAtlas&&RunDriver.addToAtlas(i)}},n.addTextureToAtlas=function(t){RunDriver.addTextureToAtlas(this)},n.getPixels=function(t,e,n,i){if(Render.isConchApp){var r=this.bitmap;if(r.source&&r.source.getImageData){var a=r.source.getImageData(t,e,n,i),s=new Uint8Array(a);return Array.from(s)}return null}return Render.isWebGL?RunDriver.getTexturePixels(this,t,e,n,i):(Browser.canvas.size(n,i),Browser.canvas.clear(),Browser.context.drawTexture(this,-t,-e,this.width,this.height,0,0),Browser.context.getImageData(0,0,n,i).data)},n.onAsynLoaded=function(t,e){e&&e.useNum++,this.setTo(e,this.uv)},__getset(0,n,"isLinearSampling",function(){return!Render.isWebGL||9728!=this.bitmap.minFifter},function(t){!t&&Render.isWebGL&&(t||-1!=this.bitmap.minFifter||-1!=this.bitmap.magFifter||(this.bitmap.minFifter=9728,this.bitmap.magFifter=9728,this.bitmap.enableMerageInAtlas=!1))}),__getset(0,n,"height",function(){return this._h?this._h:this.uv&&this.uv!==e.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height},function(t){this._h=t,this.sourceHeight||(this.sourceHeight=t)}),__getset(0,n,"width",function(){return this._w?this._w:this.uv&&this.uv!==e.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width},function(t){this._w=t,this.sourceWidth||(this.sourceWidth=t)}),__getset(0,n,"source",function(){return this.bitmap?(this.bitmap.activeResource(),this.bitmap.source):null}),__getset(0,n,"released",function(){return!this.bitmap||this.bitmap.released}),__getset(0,n,"repeat",function(){return!Render.isWebGL||!this.bitmap||this.bitmap.repeat},function(t){t&&Render.isWebGL&&this.bitmap&&(this.bitmap.repeat=t,t&&(this.bitmap.enableMerageInAtlas=!1))}),__getset(0,n,"loaded",function(){return this._loaded}),e.moveUV=function(t,e,n){for(var i=0;i<8;i+=2)n[i]+=t,n[i+1]+=e;return n},e.create=function(t,n,i,r,a,s,o,l,h){void 0===s&&(s=0),void 0===o&&(o=0),void 0===l&&(l=0),void 0===h&&(h=0);var _=t instanceof laya.resource.Texture,u=_?t.uv:e.DEF_UV,c=_?t.bitmap:t,d=RunDriver.isAtlas(c);if(d){var f=c._atlaser,m=t._atlasID;if(-1==m)throw new Error("create texture error");c=f._inAtlasTextureBitmapValue[m],u=f._inAtlasTextureOriUVValue[m]}var p=new e(c,null);c.width&&n+r>c.width&&(r=c.width-n),c.height&&i+a>c.height&&(a=c.height-i),p.width=r,p.height=a,p.offsetX=s,p.offsetY=o,p.sourceWidth=l||r,p.sourceHeight=h||a;var g=1/c.width,v=1/c.height;n*=g,i*=v,r*=g,a*=v;var x=p.uv[0],S=p.uv[1],T=p.uv[4],E=p.uv[5],y=T-x,M=E-S,D=e.moveUV(u[0],u[1],[n,i,n+r,i,n+r,i+a,n,i+a]);return p.uv=[x+D[0]*y,S+D[1]*M,T-(1-D[2])*y,S+D[3]*M,T-(1-D[4])*y,E-(1-D[5])*M,x+D[6]*y,E-(1-D[7])*M],d&&p.addTextureToAtlas(),p},e.createFromTexture=function(t,n,i,r,a){var s=!Render.isWebGL&&Browser.onFirefox||Browser.onEdge?.5:0,o=Rectangle.TEMP.setTo(n-t.offsetX-s,i-t.offsetY-s,r+2*s,a+2*s),l=o.intersection(e._rect1.setTo(0,0,t.width,t.height),e._rect2);if(!l)return null;var h=e.create(t,l.x,l.y,l.width,l.height,l.x-o.x,l.y-o.y,r,a);return h.bitmap.useNum--,h},e.DEF_UV=[0,0,1,0,1,1,0,1],e.INV_UV=[0,1,1,1,1,0,0,0],e._rect1=new Rectangle,e._rect2=new Rectangle,e}(EventDispatcher),GraphicsGL=function(t){function e(){e.__super.call(this)}__class(e,"laya.webgl.display.GraphicsGL",t);var n=e.prototype;return n.setShader=function(t){this._saveToCmd(Render.context._setShader,[t])},n.setIBVB=function(t,e,n,i,r,a){this._saveToCmd(Render.context._setIBVB,[t,e,n,i,r,a])},n.drawParticle=function(t,e,n){var i=RunDriver.createParticleTemplate2D(n);i.x=t,i.y=e,this._saveToCmd(Render.context._drawParticle,[i])},e}(Graphics),RenderSprite3D=function(t){function e(t,n){e.__super.call(this,t,n)}__class(e,"laya.webgl.utils.RenderSprite3D",t);var n=e.prototype;return n.onCreate=function(t){switch(t){case 8:return void(this._fun=this._blend);case 4:return void(this._fun=this._transform)}},n._mask=function(t,n,i,r){var a,s,o=this._next,l=t.mask;if(l){n.ctx.save();var h=n.ctx.globalCompositeOperation,_=new Rectangle;if(_.copyFrom(l.getBounds()),_.width=Math.round(_.width),_.height=Math.round(_.height),_.x=Math.round(_.x),_.y=Math.round(_.y),_.width>0&&_.height>0){var u=t._style._tf,c=SubmitCMDScope.create();c.addValue("bounds",_),a=SubmitCMD.create([c,n],laya.webgl.utils.RenderSprite3D.tmpTarget),n.addRenderObject(a),l.render(n,-_.x,-_.y),a=SubmitCMD.create([c],laya.webgl.utils.RenderSprite3D.endTmpTarget),n.addRenderObject(a),n.ctx.save(),n.clipRect(i-u.translateX+_.x,r-u.translateY+_.y,_.width,_.height),o._fun.call(o,t,n,i,r),n.ctx.restore(),s=SubmitStencil.create(6),h=n.ctx.globalCompositeOperation,s.blendMode="mask",n.addRenderObject(s),Matrix.TEMP.identity();var d=Value2D.create(1,0),f=Texture.INV_UV,m=_.width,p=_.height;(_.width<32||_.height<32)&&(f=e.tempUV,f[0]=0,f[1]=0,f[2]=_.width>=32?1:_.width/32,f[3]=0,f[4]=_.width>=32?1:_.width/32,f[5]=_.height>=32?1:_.height/32,f[6]=0,f[7]=_.height>=32?1:_.height/32,_.width=_.width>=32?_.width:32,_.height=_.height>=32?_.height:32,f[1]*=-1,f[3]*=-1,f[5]*=-1,f[7]*=-1,f[1]+=1,f[3]+=1,f[5]+=1,f[7]+=1),n.ctx.drawTarget(c,i+_.x-u.translateX,r+_.y-u.translateY,m,p,Matrix.TEMP,"tmpTarget",d,f,6),a=SubmitCMD.create([c],laya.webgl.utils.RenderSprite3D.recycleTarget),n.addRenderObject(a),s=SubmitStencil.create(6),s.blendMode=h,n.addRenderObject(s)}n.ctx.restore()}else o._fun.call(o,t,n,i,r)},n._blend=function(t,e,n,i){var r=t._style,a=this._next;r.blendMode?(e.ctx.save(),e.ctx.globalCompositeOperation=r.blendMode,a._fun.call(a,t,e,n,i),e.ctx.restore()):a._fun.call(a,t,e,n,i)},n._transform=function(t,e,n,i){"use strict";var r=t.transform,a=this._next;if(r&&a!=RenderSprite.NORENDER){var s=e.ctx;t._style;r.tx=n,r.ty=i;var o=s._getTransformMatrix(),l=o.clone();Matrix.mul(r,o,o),o._checkTransform(),r.tx=r.ty=0,a._fun.call(a,t,e,0,0),l.copyTo(o),l.destroy()}else a._fun.call(a,t,e,n,i)},e.tmpTarget=function(t,e){var n=t.getValue("bounds"),i=RenderTarget2D.create(n.width,n.height);i.start(),i.clear(0,0,0,0),t.addValue("tmpTarget",i)},e.endTmpTarget=function(t){t.getValue("tmpTarget").end()},e.recycleTarget=function(t){t.getValue("tmpTarget").recycle(),t.recycle()},__static(e,["tempUV",function(){return this.tempUV=new Array(8)}]),e}(RenderSprite),SubmitTexture=function(t){function e(t){this._preIsSameTextureShader=!1,this._isSameTexture=!0,this._texs=new Array,this._texsID=new Array,this._vbPos=new Array,void 0===t&&(t=1e4),e.__super.call(this,t)}__class(e,"laya.webgl.submit.SubmitTexture",t);var n=e.prototype;return n.releaseRender=function(){var t=e._cache;t[t._length++]=this,this.shaderValue.release(),this._preIsSameTextureShader=!1,this._vb=null,this._texs.length=0,this._vbPos.length=0,this._isSameTexture=!0},n.addTexture=function(t,e){this._texsID[this._texs.length]=t._uvID,this._texs.push(t),this._vbPos.push(e)},n.checkTexture=function(){if(this._texs.length<1)return void(this._isSameTexture=!0);var t=this.shaderValue.textureHost,e=t.bitmap;if(null!==e)for(var n=this._vb.getFloat32Array(),i=0,r=this._texs.length;i<r;i++){var a=this._texs[i];a.active();var s=a.uv;if(this._texsID[i]!==a._uvID){this._texsID[i]=a._uvID;var o=this._vbPos[i];n[o+2]=s[0],n[o+3]=s[1],n[o+6]=s[2],n[o+7]=s[3],n[o+10]=s[4],n[o+11]=s[5],n[o+14]=s[6],n[o+15]=s[7],this._vb.setNeedUpload()}a.bitmap!==e&&(this._isSameTexture=!1)}},n.renderSubmit=function(){if(0===this._numEle)return e._shaderSet=!1,1;var t=this.shaderValue.textureHost;if(t){var n=t.source;if(!t.bitmap||!n)return e._shaderSet=!1,1;this.shaderValue.texture=n}this._vb.bind_upload(this._ib);var i=WebGL.mainContext;if(BlendMode.activeBlendFunction!==this._blendFn&&(i.enable(3042),this._blendFn(i),BlendMode.activeBlendFunction=this._blendFn),Stat.drawCall++,Stat.trianglesFaces+=this._numEle/3,this._preIsSameTextureShader&&BaseShader.activeShader&&e._shaderSet?BaseShader.activeShader.uploadTexture2D(this.shaderValue.texture):this.shaderValue.upload(),e._shaderSet=!0,this._texs.length>1&&!this._isSameTexture)for(var r=t.bitmap,a=0,s=BaseShader.activeShader,o=0,l=this._texs.length;o<l;o++){var h=this._texs[o];h.bitmap===r&&o+1!==l||(s.uploadTexture2D(h.source),i.drawElements(4,6*(o-a+1),5123,this._startIdx+6*a*CONST3D2D.BYTES_PIDX),r=h.bitmap,a=o)}else i.drawElements(4,this._numEle,5123,this._startIdx);return 1},e.create=function(t,n,i,r,a){var s=e._cache._length?e._cache[--e._cache._length]:new e;null==i&&(i=s._selfVb||(s._selfVb=VertexBuffer2D.create(-1)),i.clear(),r=0),s._ib=n,s._vb=i,s._startIdx=r*CONST3D2D.BYTES_PIDX,s._numEle=0;var o=t._nBlendType;s._blendFn=t._targets?BlendMode.targetFns[o]:BlendMode.fns[o],s.shaderValue=a,s.shaderValue.setValue(t._shader2D);var l=t._shader2D.filters;return l&&s.shaderValue.setFilters(l),s},e._cache=(e._cache=[],e._cache._length=0,e._cache),e._shaderSet=!0,e}(Submit),SubmitCanvas=function(t){function e(){this._matrix=new Matrix,this._matrix4=CONST3D2D.defaultMatrix4.concat(),e.__super.call(this,1e4),this.shaderValue=new Value2D(0,0)}__class(e,"laya.webgl.submit.SubmitCanvas",t);var n=e.prototype;return n.renderSubmit=function(){if(this._ctx_src._targets)return this._ctx_src._targets.flush(this._ctx_src),1;var t=RenderState2D.worldAlpha,e=RenderState2D.worldMatrix4,n=RenderState2D.worldMatrix,i=RenderState2D.worldFilters,r=RenderState2D.worldShaderDefines,a=this.shaderValue,s=this._matrix,o=this._matrix4,l=Matrix.TEMP;return Matrix.mul(s,n,l),o[0]=l.a,o[1]=l.b,o[4]=l.c,o[5]=l.d,o[12]=l.tx,o[13]=l.ty,RenderState2D.worldMatrix=l.clone(),RenderState2D.worldMatrix4=o,RenderState2D.worldAlpha=RenderState2D.worldAlpha*a.alpha,a.filters&&a.filters.length&&(RenderState2D.worldFilters=a.filters,RenderState2D.worldShaderDefines=a.defines),this._ctx_src.flush(),RenderState2D.worldAlpha=t,RenderState2D.worldMatrix4=e,RenderState2D.worldMatrix.destroy(),RenderState2D.worldMatrix=n,RenderState2D.worldFilters=i,RenderState2D.worldShaderDefines=r,1},n.releaseRender=function(){var t=e._cache;this._ctx_src=null,t[t._length++]=this},n.getRenderType=function(){
return 10003},e.create=function(t,n,i){var r=e._cache._length?e._cache[--e._cache._length]:new e;r._ctx_src=t;var a=r.shaderValue;return a.alpha=n,a.defines.setValue(0),i&&i.length&&a.setFilters(i),r},e._cache=(e._cache=[],e._cache._length=0,e._cache),e}(Submit),LoopLine=function(t){function e(t,n,i,r,a){this._points=[];for(var s=NaN,o=NaN,l=-1,h=-1,_=i.length/2-1,u=0;u<_;u++)s=i[2*u],o=i[2*u+1],(Math.abs(l-s)>.01||Math.abs(h-o)>.01)&&this._points.push(s,o),l=s,h=o;s=i[2*_],o=i[2*_+1],l=this._points[0],h=this._points[1],(Math.abs(l-s)>.01||Math.abs(h-o)>.01)&&this._points.push(s,o),e.__super.call(this,t,n,0,0,this._points.length/2,0,r,a)}__class(e,"laya.webgl.shapes.LoopLine",t);var n=e.prototype;return n.getData=function(t,e,n){if(this.borderWidth>0){for(var i=this.color,r=(i>>16&255)/255,a=(i>>8&255)/255,s=(255&i)/255,o=[],l=0,h=0,_=[],u=Math.floor(this._points.length/2),c=0;c<u;c++)l=this._points[2*c],h=this._points[2*c+1],o.push(this.x+l,this.y+h,r,a,s);this.createLoopLine(o,_,this.borderWidth,n+o.length/5),t.append(new Uint16Array(_)),e.append(new Float32Array(o))}},n.createLoopLine=function(t,e,n,i,r,a){var s=(t.length,t.concat()),o=r||t,l=this.borderColor,h=(l>>16&255)/255,_=(l>>8&255)/255,u=(255&l)/255,c=[s[0],s[1]],d=[s[s.length-5],s[s.length-4]],f=d[0]+.5*(c[0]-d[0]),m=d[1]+.5*(c[1]-d[1]);s.unshift(f,m,0,0,0),s.push(f,m,0,0,0);var p,g,v,x,S,T,E,y,M,D,C,R,A,b,I,w,V,L,P,N,O=s.length/5,F=i,B=n/2;v=s[0],x=s[1],S=s[5],T=s[6],M=-(x-T),D=v-S,N=Math.sqrt(M*M+D*D),M=M/N*B,D=D/N*B,o.push(v-M,x-D,h,_,u,v+M,x+D,h,_,u);for(var U=1;U<O-1;U++)v=s[5*(U-1)],x=s[5*(U-1)+1],S=s[5*U],T=s[5*U+1],E=s[5*(U+1)],y=s[5*(U+1)+1],M=-(x-T),D=v-S,N=Math.sqrt(M*M+D*D),M=M/N*B,D=D/N*B,C=-(T-y),R=S-E,N=Math.sqrt(C*C+R*R),C=C/N*B,R=R/N*B,A=-D+x-(-D+T),b=-M+S-(-M+v),I=(-M+v)*(-D+T)-(-M+S)*(-D+x),w=-R+y-(-R+T),V=-C+S-(-C+E),L=(-C+E)*(-R+T)-(-C+S)*(-R+y),P=A*V-w*b,Math.abs(P)<.1?(P+=10.1,o.push(S-M,T-D,h,_,u,S+M,T+D,h,_,u)):(p=(b*L-V*I)/P,g=(w*I-A*L)/P,(p-S)*(p-S)+(g-T)+(g-T),o.push(p,g,h,_,u,S-(p-S),T-(g-T),h,_,u));a&&(e=a);var G=this.edges+1;for(U=1;U<G;U++)e.push(F+2*(U-1),F+2*(U-1)+1,F+2*U+1,F+2*U+1,F+2*U,F+2*(U-1));return e.push(F+2*(U-1),F+2*(U-1)+1,F+1,F+1,F,F+2*(U-1)),o},e}(BasePoly),Line=function(t){function e(t,n,i,r,a){this._points=[],this.rebuild(i),e.__super.call(this,t,n,0,0,0,a,r,a,0)}__class(e,"laya.webgl.shapes.Line",t);var n=e.prototype;return n.rebuild=function(t){var e=t.length;e!=this._points.length&&(this.mUint16Array=new Uint16Array(6*(e/2-1)),this.mFloat32Array=new Float32Array(5*e)),this._points.length=0;for(var n=NaN,i=NaN,r=-1,a=-1,s=t.length/2,o=0;o<s;o++)n=t[2*o],i=t[2*o+1],(Math.abs(r-n)>.01||Math.abs(a-i)>.01)&&this._points.push(n,i),r=n,a=i},n.getData=function(t,e,n){var i=[],r=[];this.borderWidth>0&&this.createLine2(this._points,i,this.borderWidth,n,r,this._points.length/2),this.mUint16Array.set(i,0),this.mFloat32Array.set(r,0),t.append(this.mUint16Array),e.append(this.mFloat32Array)},e}(BasePoly),Polygon=function(t){function e(t,n,i,r,a,s){this._points=null,this._start=-1,this._repaint=!1,this._mat=Matrix.create(),this._points=i.slice(0,i.length),e.__super.call(this,t,n,0,0,this._points.length/2,r,a,s)}__class(e,"laya.webgl.shapes.Polygon",t);var n=e.prototype;return n.rebuild=function(t){this._repaint||(this._points.length=0,this._points=this._points.concat(t))},n.setMatrix=function(t){t.copyTo(this._mat)},n.needUpdate=function(t){return this._repaint=this._mat.a==t.a&&this._mat.b==t.b&&this._mat.c==t.c&&this._mat.d==t.d&&this._mat.tx==t.tx&&this._mat.ty==t.ty,!this._repaint},n.getData=function(t,e,n){var i,r=0,a=this._points,s=0;if(this.mUint16Array&&this.mFloat32Array&&this._repaint){if(this._start!=n){for(this._start=n,i=[],s=Math.floor(a.length/2),r=2;r<s;r++)i.push(n,n+r-1,n+r);this.mUint16Array=new Uint16Array(i)}}else{this._start=n,i=[];var o=[],l=this.color,h=(l>>16&255)/255,_=(l>>8&255)/255,u=(255&l)/255;for(s=Math.floor(a.length/2),r=0;r<s;r++)o.push(this.x+a[2*r],this.y+a[2*r+1],h,_,u);for(r=2;r<s;r++)i.push(n,n+r-1,n+r);this.mUint16Array=new Uint16Array(i),this.mFloat32Array=new Float32Array(o)}t.append(this.mUint16Array),e.append(this.mFloat32Array)},e}(BasePoly),GeometryFilter=function(t){function e(){this._destroyed=!1,e.__super.call(this),this._destroyed=!1}__class(e,"laya.d3.core.GeometryFilter",t);var n=e.prototype;return Laya.imps(n,{"laya.resource.IDestroy":!0}),n._destroy=function(){this.offAll(),this._destroyed=!0},__getset(0,n,"_originalBoundingBoxCorners",function(){throw new Error("BaseRender: must override it.")}),__getset(0,n,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),__getset(0,n,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),__getset(0,n,"destroyed",function(){return this._destroyed}),__getset(0,n,"_isAsyncLoaded",function(){return!0}),e}(EventDispatcher),TransformUV=function(t){function e(){this._rotation=0,this._matNeedUpdte=!1,e.__super.call(this),this._matrix=new Matrix4x4,this._offset=new Vector2,this._tiling=new Vector2(1,1)}__class(e,"laya.d3.core.TransformUV",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0}),n._updateMatrix=function(){e._tempOffsetV3.elements[0]=this._offset.x,e._tempOffsetV3.elements[1]=this._offset.y,Quaternion.createFromYawPitchRoll(0,0,this._rotation,e._tempRotationQua),e._tempTitlingV3.elements[0]=this._tiling.x,e._tempTitlingV3.elements[1]=this._tiling.y,Matrix4x4.createAffineTransformation(e._tempOffsetV3,e._tempRotationQua,e._tempTitlingV3,this._matrix)},n.cloneTo=function(t){t._matrix=this._matrix.clone(),t._offset=this._offset.clone(),t._rotation=this._rotation,t._tiling=this._tiling.clone()},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,n,"tiling",function(){return this._tiling},function(t){this._tiling=t,this._matNeedUpdte=!0}),__getset(0,n,"rotation",function(){return this._rotation},function(t){this._rotation=t,this._matNeedUpdte=!0}),__getset(0,n,"offset",function(){return this._offset},function(t){this._offset=t,this._matNeedUpdte=!0}),__getset(0,n,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),__static(e,["_tempOffsetV3",function(){return this._tempOffsetV3=new Vector3(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new Quaternion},"_tempTitlingV3",function(){return this._tempTitlingV3=new Vector3(1,1,1)}]),e}(EventDispatcher),Transform3D=function(t){function e(t){this._owner=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._dummy=null,this.pivot=null,e.__super.call(this),this._localPosition=new Vector3,this._localRotation=new Quaternion(0,0,0,1),this._localScale=new Vector3(1,1,1),this._localRotationEuler=new Vector3,this._localMatrix=new Matrix4x4,this._position=new Vector3,this._rotation=new Quaternion(0,0,0,1),this._scale=new Vector3(1,1,1),this._worldMatrix=new Matrix4x4,this._forward=new Vector3,this._up=new Vector3,this._right=new Vector3,this._owner=t,this._childs=[]}__class(e,"laya.d3.core.Transform3D",t);var n=e.prototype;return n._updateLocalMatrix=function(){if(!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z)Matrix4x4.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);else{var t=e._tempVector30;Vector3.multiply(this.pivot,this._localScale,t);var n=e._tempVector31;Vector3.subtract(t,this.pivot,n);var i=e._tempVector32,r=this.localRotation;Vector3.transformQuat(t,r,i),Vector3.subtract(i,t,i);var a=e._tempVector33;Vector3.subtract(this._localPosition,n,a),Vector3.subtract(a,i,a),Matrix4x4.createAffineTransformation(a,r,this._localScale,this._localMatrix)}},n._onWorldPositionRotationTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._rotationUpdate){this._worldUpdate=this._positionUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionRotationTransform()}},n._onWorldPositionScaleTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._scaleUpdate){this._worldUpdate=this._positionUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionScaleTransform()}},n._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionTransform()}},n._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionRotationTransform()}},n._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionScaleTransform()}},n._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldTransform()}},n.translate=function(t,n){void 0===n&&(n=!0),n?(Matrix4x4.createFromQuaternion(this.localRotation,e._tempMatrix0),Vector3.transformCoordinate(t,e._tempMatrix0,e._tempVector30),Vector3.add(this.localPosition,e._tempVector30,this._localPosition),this.localPosition=this._localPosition):(Vector3.add(this.position,t,this._position),this.position=this._position)},n.rotate=function(t,n,i){void 0===n&&(n=!0),void 0===i&&(i=!0);var r;i?r=t:(Vector3.scale(t,Math.PI/180,e._tempVector30),r=e._tempVector30),Quaternion.createFromYawPitchRoll(r.y,r.x,r.z,e._tempQuaternion0),n?(Quaternion.multiply(this._localRotation,e._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(Quaternion.multiply(e._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},n.lookAt=function(t,e,n){void 0===n&&(n=!1);var i,r=t.elements;if(n){if(i=this._localPosition.elements,Math.abs(i[0]-r[0])<MathUtils3D.zeroTolerance&&Math.abs(i[1]-r[1])<MathUtils3D.zeroTolerance&&Math.abs(i[2]-r[2])<MathUtils3D.zeroTolerance)return;Quaternion.lookAt(this._localPosition,t,e,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(i=a.elements,Math.abs(i[0]-r[0])<MathUtils3D.zeroTolerance&&Math.abs(i[1]-r[1])<MathUtils3D.zeroTolerance&&Math.abs(i[2]-r[2])<MathUtils3D.zeroTolerance)return;Quaternion.lookAt(a,t,e,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}},__getset(0,n,"up",function(){var t=this.worldMatrix.elements;return this._up.elements[0]=t[4],this._up.elements[1]=t[5],this._up.elements[2]=t[6],this._up}),__getset(0,n,"forward",function(){var t=this.worldMatrix.elements;return this._forward.elements[0]=-t[8],this._forward.elements[1]=-t[9],this._forward.elements[2]=-t[10],this._forward}),__getset(0,n,"dummy",function(){return this._dummy},function(t){this._dummy!==t&&(this._dummy&&(this._dummy._entity=null),t&&(t._entity=this),this._dummy=t)}),__getset(0,n,"parent",function(){return this._parent},function(t){if(this._parent!==t){if(this._parent){var e=this._parent._childs,n=e.indexOf(this);e.splice(n,1)}t&&(t._childs.push(this),t&&this._onWorldTransform()),this._parent=t}}),__getset(0,n,"rotationEuler",null,function(t){Quaternion.createFromYawPitchRoll(t.y,t.x,t.z,this._rotation),this.rotation=this._rotation}),__getset(0,n,"scale",function(){return this._scaleUpdate?(null!==this._parent?Vector3.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1,this._scale):this._scale},function(t){if(null!==this._parent){var n=this._parent.scale.elements,i=e._tempVector30.elements;i[0]=1/n[0],i[1]=1/n[1],i[2]=1/n[2],Vector3.multiply(t,e._tempVector30,this._localScale)}else t.cloneTo(this._localScale);this.localScale=this._localScale,this._scale=t,this._scaleUpdate=!1}),__getset(0,n,"rotation",function(){return this._rotationUpdate&&(null!=this._parent?Quaternion.multiply(this._parent.rotation,this._localRotation,this._rotation):this._localRotation.cloneTo(this._rotation),this._rotationUpdate=!1),this._rotation},function(t){null!=this._parent?(this._parent.rotation.invert(e._tempQuaternion0),Quaternion.multiply(t,e._tempQuaternion0,this._localRotation)):t.cloneTo(this._localRotation),this.localRotation=this._localRotation,this._rotation=t,this._rotationUpdate=!1}),__getset(0,n,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(e._tempVector30);var t=e._tempVector30.elements,n=this._localRotationEuler.elements;n[0]=t[1]/e._randinToAngle,n[1]=t[0]/e._randinToAngle,n[2]=t[2]/e._randinToAngle}return this._localRotationEuler},function(t){this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),__getset(0,n,"worldMatrix",function(){return this._worldUpdate&&(null!=this._parent?Matrix4x4.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},function(t){null===this._parent?t.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),Matrix4x4.multiply(this._localMatrix,t,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix=t,this._worldUpdate=!1}),__getset(0,n,"position",function(){if(this._positionUpdate){if(null!=this._parent){var t=this._parent.position;Vector3.multiply(this._localPosition,this._parent.scale,e._tempVector30),Vector3.transformQuat(e._tempVector30,this._parent.rotation,e._tempVector30),Vector3.add(t,e._tempVector30,this._position)}else this._localPosition.cloneTo(this._position);this._positionUpdate=!1}return this._position},function(t){if(null!=this._parent){Vector3.subtract(t,this._parent.position,this._localPosition);var n=this._parent.scale.elements,i=n[0],r=n[1],a=n[2];if(1!==i||1!==r||1!==a){var s=e._tempVector30,o=s.elements;o[0]=1/i,o[1]=1/r,o[2]=1/a,Vector3.multiply(this._localPosition,s,this._localPosition)}this._parent.rotation.invert(e._tempQuaternion0),Vector3.transformQuat(this._localPosition,e._tempQuaternion0,this._localPosition)}else t.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position=t,this._positionUpdate=!1}),__getset(0,n,"localRotation",function(){if(this._localQuaternionUpdate){var t=this._localRotationEuler.elements;Quaternion.createFromYawPitchRoll(t[1]/e._angleToRandin,t[0]/e._angleToRandin,t[2]/e._angleToRandin,this._localRotation)}return this._localRotation},function(t){this._localRotation=t,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),__getset(0,n,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(t){this._localMatrix=t,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._localUpdate=!1,this._onWorldTransform()}),__getset(0,n,"right",function(){var t=this.worldMatrix.elements;return this._right.elements[0]=t[0],this._right.elements[1]=t[1],this._right.elements[2]=t[2],this._right}),__getset(0,n,"worldNeedUpdate",function(){return this._worldUpdate}),__getset(0,n,"localPosition",function(){return this._localPosition},function(t){this._localPosition=t,this._localUpdate=!0,this._onWorldPositionTransform()}),__getset(0,n,"owner",function(){return this._owner}),__getset(0,n,"localScale",function(){return this._localScale},function(t){this._localScale=t,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),__getset(0,n,"_isFrontFaceInvert",function(){var t=this.scale,e=t.x<0;return t.y<0&&(e=!e),t.z<0&&(e=!e),e}),__static(e,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempQuaternion0",function(){return this._tempQuaternion0=new Quaternion},"_tempMatrix0",function(){return this._tempMatrix0=new Matrix4x4},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI},"_randinToAngle",function(){return this._randinToAngle=180*Math.PI}]),e}(EventDispatcher),BaseRender=function(t){function e(t){e.__super.call(this),this._id=++e._uniqueIDCounter,this._indexInSceneFrustumCullingObjects=-1,this._boundingBox=new BoundBox(new Vector3,new Vector3),this._boundingBoxCenter=new Vector3,this._boundingSphere=new BoundSphere(new Vector3,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._isPartOfStaticBatch=!1,this._destroyed=!1,this._owner=t,this._enable=!0,this._materialsInstance=[],this.lightmapIndex=-1,this.castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange)}__class(e,"laya.d3.core.render.BaseRender",t);var n=e.prototype;return Laya.imps(n,{"laya.resource.IDestroy":!0}),n._setShaderValuelightMap=function(t){this._setShaderValueTexture(3,t)},n._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},n._renderRenderableBoundBox=function(){var t=Laya3D._debugPhasorSprite,n=this.boundingBox,i=e._tempBoundBoxCorners;n.getCorners(i),t.line(i[0],e._greenColor,i[1],e._greenColor),t.line(i[2],e._greenColor,i[3],e._greenColor),t.line(i[4],e._greenColor,i[5],e._greenColor),t.line(i[6],e._greenColor,i[7],e._greenColor),t.line(i[0],e._greenColor,i[3],e._greenColor),t.line(i[1],e._greenColor,i[2],e._greenColor),t.line(i[2],e._greenColor,i[6],e._greenColor),t.line(i[3],e._greenColor,i[7],e._greenColor),t.line(i[0],e._greenColor,i[4],e._greenColor),t.line(i[1],e._greenColor,i[5],e._greenColor),t.line(i[4],e._greenColor,i[7],e._greenColor),t.line(i[5],e._greenColor,i[6],e._greenColor)},n._calculateBoundingSphere=function(){throw"BaseRender: must override it."},n._calculateBoundingBox=function(){throw"BaseRender: must override it."},n._setShaderValueTexture=function(t,e){this._owner._shaderValues.setValue(t,e)},n._setShaderValueMatrix4x4=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},n._setShaderValueColor=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},n._setShaderValueBuffer=function(t,e){this._owner._shaderValues.setValue(t,e)},n._setShaderValueInt=function(t,e){this._owner._shaderValues.setValue(t,e)},n._setShaderValueBool=function(t,e){this._owner._shaderValues.setValue(t,e)},n._setShaderValueNumber=function(t,e){this._owner._shaderValues.setValue(t,e)},n._setShaderValueVector2=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},n._addShaderDefine=function(t){this._owner._shaderDefineValue|=t},n._removeShaderDefine=function(t){this._owner._shaderDefineValue&=~t},n._renderUpdate=function(t){},n._applyLightMapParams=function(){if(this._lightmapIndex>=0){var t=this._owner.scene;if(t){var e=t.getlightmaps(),n=e[this._lightmapIndex];n?(this._addShaderDefine(4),n.loaded?this._setShaderValuelightMap(n):n.once("loaded",this,this._setShaderValuelightMap)):this._removeShaderDefine(4)}else this._removeShaderDefine(4)}else this._removeShaderDefine(4)},n._updateOctreeNode=function(){var t=this._treeNode;t&&this._octreeNodeNeedChange&&(t.updateObject(this),this._octreeNodeNeedChange=!1)},n._destroy=function(){this.offAll();for(var t=0,e=this._renderElements.length;t<e;t++)this._renderElements[t]._destroy();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null,this._destroyed=!0},__getset(0,n,"receiveShadow",function(){return this._receiveShadow},function(t){this._receiveShadow!==t&&(this._receiveShadow=t,t?this._addShaderDefine(1):this._removeShaderDefine(1))}),__getset(0,n,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),__getset(0,n,"sharedMaterials",function(){return this._materials.slice()},function(t){if(!t)throw new Error("MeshRender: shadredMaterials value can't be null.");var e=t.length;this._materialsInstance.length=e;for(var n=0;n<e;n++)this._materials[n]!==t[n]&&(this._materialsInstance[n]=!1,this.event("materialchanged",[this,n,t[n]]));this._materials=t}),__getset(0,n,"id",function(){return this._id}),__getset(0,n,"lightmapIndex",function(){return this._lightmapIndex},function(t){this._lightmapIndex=t,this._applyLightMapParams()}),__getset(0,n,"enable",function(){return this._enable},function(t){this._enable=t,this.event("enablechanged",[this,t])}),__getset(0,n,"destroyed",function(){return this._destroyed}),__getset(0,n,"sharedMaterial",function(){return this._materials[0]},function(t){this._materials[0]!==t&&(this._materials[0]=t,this._materialsInstance[0]=!1,this.event("materialchanged",[this,0,t]))}),__getset(0,n,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var t=this.boundingBox;Vector3.add(t.min,t.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),__getset(0,n,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),__getset(0,n,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(t){this._lightmapScaleOffset=t,this._setShaderValueColor(2,t),this._addShaderDefine(2)}),__getset(0,n,"material",function(){var t=this._materials[0];if(t&&!this._materialsInstance[0]){var e=new t.constructor;t.cloneTo(e),e.name=e.name+"(Instance)",this._materialsInstance[0]=!0,this._materials[0]=e,this.event("materialchanged",[this,0,e])}return this._materials[0]},function(t){this._materials[0]!==t&&(this._materials[0]=t,this._materialsInstance[0]=!1,this.event("materialchanged",[this,0,t]))}),__getset(0,n,"materials",function(){for(var t=0,e=this._materials.length;t<e;t++){var n=this._materials[t];if(!this._materialsInstance[t]){var i=new n.constructor;n.cloneTo(i),i.name=i.name+"(Instance)",this._materialsInstance[t]=!0,this._materials[t]=i,this.event("materialchanged",[this,t,i])}}return this._materials.slice()},function(t){if(!t)throw new Error("MeshRender: materials value can't be null.");var e=t.length;this._materialsInstance.length=e;for(var n=0;n<e;n++)this._materials[n]!==t[n]&&(this._materialsInstance[n]=!1,this.event("materialchanged",[this,n,t[n]]));this._materials=t}),e._uniqueIDCounter=0,__static(e,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]},"_greenColor",function(){return this._greenColor=new Vector4(0,1,0,1)}]),e}(EventDispatcher),WebGLContext2D=function(t){function e(t){this._x=0,this._y=0,this._id=++e._COUNT,this._path=null,this._drawCount=1,this._maxNumEle=0,this._clear=!1,this._isMain=!1,this._atlasResourceChange=0,this._submits=null,this._curSubmit=null,this._ib=null,this._vb=null,this._nBlendType=0,this._saveMark=null,this._shader2D=null,this.mId=-1,this.mHaveKey=!1,this.mHaveLineKey=!1,this.mX=0,this.mY=0,e.__super.call(this),this._width=99999999,this._height=99999999,this._clipRect=e.MAXCLIPRECT,this.mOutPoint,this._canvas=t,e._contextcount++,Render.isFlash?(this._ib=IndexBuffer2D.create(35044),GlUtils.fillIBQuadrangle(this._ib,16)):this._ib=IndexBuffer2D.QuadrangleIB,this.clear()}var n;__class(e,"laya.webgl.canvas.WebGLContext2D",t);var i=e.prototype;return i.setIsMainContext=function(){this._isMain=!0},i.clearBG=function(t,e,n,i){var r=WebGL.mainContext;r.clearColor(t,e,n,i),r.clear(16384)},i._getSubmits=function(){return this._submits},i._releaseMem=function(){if(this._submits){this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null;for(var t=0,e=this._submits._length;t<e;t++)this._submits[t].releaseRender();this._submits.length=0,this._submits._length=0,this._submits=null,this._curSubmit=null,this._path&&this._path.recover(),this._path=null,this._other&&(this._other.font=null),this._save=null,this._vb&&(this._vb.releaseResource(),this._vb.dispose(),this._vb.destory(),this._vb=null)}},i.destroy=function(){--e._contextcount,this.sprite=null,this._releaseMem(),this._targets&&this._targets.destroy(),this._targets=null,this._canvas=null,this._ib&&this._ib!=IndexBuffer2D.QuadrangleIB&&this._ib.releaseResource()},i.clear=function(){this._submits||(this._other=n.DEFAULT,this._curMat=Matrix.create(),this._vb=VertexBuffer2D.create(-1),this._submits=[],this._save=[SaveMark.Create(this)],this._save.length=10,this._shader2D=new Shader2D),this._vb.clear(),this._targets&&(this._targets.repaint=!0),this._other=n.DEFAULT,this._clear=!0,this._repaint=!1,this._drawCount=1,this._renderKey=0,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=e.MAXCLIPRECT,this._curSubmit=Submit.RENDERBASE,this._shader2D.glTexture=null,this._shader2D.fillStyle=this._shader2D.strokeStyle=DrawStyle.DEFAULT;for(var t=0,i=this._submits._length;t<i;t++)this._submits[t].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1},i.size=function(t,e){if(this._width!=t||this._height!=e)if(0==t||0==e){0!=this._vb._byteLength&&(this._width=t,this._height=e,this._vb.clear(),this._vb.upload());for(var n=0,i=this._submits._length;n<i;n++)this._submits[n].releaseRender();this._submits.length=0,this._submits._length=0,this._curSubmit=null,this._path&&this._path.recover(),this._path=null,this.sprite=null,this._targets&&this._targets.destroy(),this._targets=null}else this._width=t,this._height=e,this._targets&&this._targets.size(t,e),this._canvas.memorySize-=this._canvas.memorySize;0===t&&0===e&&this._releaseMem()},i._getTransformMatrix=function(){return this._curMat},i.translate=function(t,e){0===t&&0===e||(SaveTranslate.save(this),this._curMat.bTransform&&(SaveTransform.save(this),this._curMat.transformPointN(Point.TEMP.setTo(t,e)),t=Point.TEMP.x,e=Point.TEMP.y),this._x+=t,this._y+=e)},i.save=function(){this._save[this._save._length++]=SaveMark.Create(this)},i.restore=function(){var t=this._save._length;if(!(t<1))for(var e=t-1;e>=0;e--){var n=this._save[e];if(n.restore(this),n.isSaveMark())return void(this._save._length=e)}},i._fillText=function(t,e,n,i,r,a,s,o,l,h){void 0===h&&(h=0);var _=this._shader2D,u=this._curSubmit.shaderValue,c=r?FontInContext.create(r):this._other.font;if(AtlasResourceManager.enabled)_.ALPHA!==u.ALPHA&&(_.glTexture=null),DrawText.drawText(this,t,e,this._curMat,c,l||this._other.textAlign,a,s,o,n,i,h);else{var d=(this._shader2D.defines.getValue(),a?Color.create(a)._color:_.colorAdd);_.ALPHA===u.ALPHA&&d===_.colorAdd&&u.colorAdd===_.colorAdd||(_.glTexture=null,_.colorAdd=d),DrawText.drawText(this,t,e,this._curMat,c,l||this._other.textAlign,a,s,o,n,i,h)}},i.fillWords=function(t,e,n,i,r,a){this._fillText(null,t,e,n,i,r,null,-1,null,a)},i.fillBorderWords=function(t,e,n,i,r,a,s){this._fillBorderText(null,t,e,n,i,r,a,s,null)},i.fillText=function(t,e,n,i,r,a){this._fillText(t,null,e,n,i,r,null,-1,a)},i.strokeText=function(t,e,n,i,r,a,s){this._fillText(t,null,e,n,i,null,r,a||1,s)},i.fillBorderText=function(t,e,n,i,r,a,s,o){this._fillBorderText(t,null,e,n,i,r,a,s,o)},i._fillBorderText=function(t,n,i,r,a,s,o,l,h){if(!AtlasResourceManager.enabled)return this._fillText(t,n,i,r,a,null,o,l||1,h),void this._fillText(t,n,i,r,a,s,null,-1,h);var _=this._shader2D,u=this._curSubmit.shaderValue;_.ALPHA!==u.ALPHA&&(_.glTexture=null);var c=a?(e._fontTemp.setFont(a),e._fontTemp):this._other.font;DrawText.drawText(this,t,n,this._curMat,c,h||this._other.textAlign,s,o,l||1,i,r,0)},i.fillRect=function(t,e,n,i,r){var a=this._vb;if(GlUtils.fillRectImgVb(a,this._clipRect,t,e,n,i,Texture.DEF_UV,this._curMat,this._x,this._y,0,0)){this._renderKey=0;var s=this._shader2D.fillStyle;r&&(this._shader2D.fillStyle=DrawStyle.create(r));var o=this._shader2D,l=this._curSubmit.shaderValue;if(o.fillStyle!==l.fillStyle||o.ALPHA!==l.ALPHA){o.glTexture=null;var h=this._curSubmit=Submit.createSubmit(this,this._ib,a,(a._byteLength-64)/32*3,Value2D.create(2,0));h.shaderValue.color=o.fillStyle._color._color,h.shaderValue.ALPHA=o.ALPHA,this._submits[this._submits._length++]=h}this._curSubmit._numEle+=6,this._shader2D.fillStyle=s}},i.fillTexture=function(t,e,n,i,r,a,s,o){if(!(t.loaded&&t.bitmap&&t.source))return void(this.sprite&&Laya.timer.callLater(this,this._repaintSprite));var l=this._vb,h=t.bitmap.width,_=t.bitmap.height,u=t.uv,c=s.x%t.width,d=s.y%t.height;if(h!=o.w||_!=o.h){if(!o.w&&!o.h)switch(o.oy=o.ox=0,a){case"repeat":o.width=i,o.height=r;break;case"repeat-x":o.width=i,d<0?t.height+d>r?o.height=r:o.height=t.height+d:(o.oy=d,t.height+d>r?o.height=r-d:o.height=t.height);break;case"repeat-y":c<0?t.width+c>i?o.width=i:o.width=t.width+c:(o.ox=c,t.width+c>i?o.width=i-c:o.width=t.width),o.height=r;break;default:o.width=i,o.height=r}o.w=h,o.h=_,o.uv=[0,0,o.width/h,0,o.width/h,o.height/_,0,o.height/_]}if(e+=o.ox,n+=o.oy,c-=o.ox,d-=o.oy,GlUtils.fillRectImgVb(l,this._clipRect,e,n,o.width,o.height,o.uv,this._curMat,this._x,this._y,0,0)){this._renderKey=0;var f=SubmitTexture.create(this,this._ib,l,(l._byteLength-64)/32*3,Value2D.create(256,0));this._submits[this._submits._length++]=f;var m=f.shaderValue;m.textureHost=t;var p=u[0]*h,g=u[1]*_,v=(u[2]-u[0])*h,x=(u[5]-u[3])*_,S=-c/h,T=-d/_;m.u_TexRange[0]=p/h,m.u_TexRange[1]=v/h,m.u_TexRange[2]=g/_,m.u_TexRange[3]=x/_,m.u_offset[0]=S,m.u_offset[1]=T,AtlasResourceManager.enabled&&!this._isMain&&f.addTexture(t,(l._byteLength>>2)-16),this._curSubmit=f,f._renderType=10017,f._numEle+=6}},i.setShader=function(t){SaveBase.save(this,1048576,this._shader2D,!0),this._shader2D.shader=t},i.setFilters=function(t){SaveBase.save(this,2097152,this._shader2D,!0),this._shader2D.filters=t,this._curSubmit=Submit.RENDERBASE,this._renderKey=0,this._drawCount++},i.drawTexture=function(t,e,n,i,r,a,s){this._drawTextureM(t,e,n,i,r,a,s,null,1)},i.addTextureVb=function(t,e,n){var i=this._curSubmit._vb||this._vb,r=i._byteLength>>2;i.byteLength=r+16<<2;for(var a=i.getFloat32Array(),s=0;s<16;s+=4)a[r++]=t[s]+e,a[r++]=t[s+1]+n,a[r++]=t[s+2],a[r++]=t[s+3];this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle),i._upload=!0},i.willDrawTexture=function(t,e){if(!(t.loaded&&t.bitmap&&t.source))return this.sprite&&Laya.timer.callLater(this,this._repaintSprite),0;var n=t.bitmap,i=n.id+this._shader2D.ALPHA*e+10016;if(i==this._renderKey)return i;var r=this._shader2D,a=r.ALPHA,s=this._curSubmit.shaderValue;r.ALPHA*=e,this._renderKey=i,this._drawCount++,r.glTexture=n;var o=this._vb,l=null,h=o._byteLength/32*3;return l=SubmitTexture.create(this,this._ib,o,h,Value2D.create(1,0)),this._submits[this._submits._length++]=l,
l.shaderValue.textureHost=t,l._renderType=10016,l._preIsSameTextureShader=10016===this._curSubmit._renderType&&r.ALPHA===s.ALPHA,this._curSubmit=l,r.ALPHA=a,i},i.drawTextures=function(t,n,i,r){if(!(t.loaded&&t.bitmap&&t.source))return void(this.sprite&&Laya.timer.callLater(this,this._repaintSprite));var a=this._clipRect;if(this._clipRect=e.MAXCLIPRECT,!this._drawTextureM(t,n[0],n[1],t.width,t.height,i,r,null,1))return void alert("drawTextures err");if(this._clipRect=a,Stat.drawCall++,!(n.length<4)){for(var s=this._curSubmit._vb||this._vb,o=this._curMat.a,l=this._curMat.d,h=2,_=n.length;h<_;h+=2)GlUtils.copyPreImgVb(s,(n[h]-n[h-2])*o,(n[h+1]-n[h-1])*l),this._curSubmit._numEle+=6;this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle)}},i._drawTextureM=function(t,e,n,i,r,a,s,o,l){if(!t.loaded||!t.source)return this.sprite&&Laya.timer.callLater(this,this._repaintSprite),!1;var h=this._curSubmit._vb||this._vb,_=t.bitmap;e+=a,n+=s,this._drawCount++;var u=_.id+this._shader2D.ALPHA*l+10016;if(u!=this._renderKey){this._renderKey=u;var c=this._curSubmit.shaderValue,d=this._shader2D,f=d.ALPHA;d.ALPHA*=l,d.glTexture=_;var m=this._vb,p=null,g=m._byteLength/32*3;p=SubmitTexture.create(this,this._ib,m,g,Value2D.create(1,0)),this._submits[this._submits._length++]=p,p.shaderValue.textureHost=t,p._renderType=10016,p._preIsSameTextureShader=10016===this._curSubmit._renderType&&d.ALPHA===c.ALPHA,this._curSubmit=p,h=this._curSubmit._vb||this._vb,d.ALPHA=f}return!!GlUtils.fillRectImgVb(h,this._clipRect,e,n,i||t.width,r||t.height,t.uv,o||this._curMat,this._x,this._y,0,0)&&(AtlasResourceManager.enabled&&!this._isMain&&this._curSubmit.addTexture(t,(h._byteLength>>2)-16),this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle),!0)},i._repaintSprite=function(){this.sprite&&this.sprite.repaint()},i._drawText=function(t,e,n,i,r,a,s,o,l,h){var _=t.bitmap;this._drawCount++;var u=_.id+this._shader2D.ALPHA+10016;if(u!=this._renderKey){this._renderKey=u;var c=this._curSubmit.shaderValue,d=this._shader2D;d.glTexture=_;var f=this._vb,m=null,p=f._byteLength/32*3;m=AtlasResourceManager.enabled?SubmitTexture.create(this,this._ib,f,p,Value2D.create(1,0)):SubmitTexture.create(this,this._ib,f,p,TextSV.create()),m._preIsSameTextureShader=10016===this._curSubmit._renderType&&d.ALPHA===c.ALPHA,this._submits[this._submits._length++]=m,m.shaderValue.textureHost=t,m._renderType=10016,this._curSubmit=m}t.active();var g=this._curSubmit._vb||this._vb;GlUtils.fillRectImgVb(g,this._clipRect,e+s,n+o,i||t.width,r||t.height,t.uv,a||this._curMat,this._x,this._y,l,h,!0)&&(AtlasResourceManager.enabled&&!this._isMain&&this._curSubmit.addTexture(t,(g._byteLength>>2)-16),this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle))},i.drawTextureWithTransform=function(t,n,i,r,a,s,o,l,h){if(!s)return void this._drawTextureM(t,n,i,r,a,o,l,null,h);var _=this._curMat,u=this._x,c=this._y;(0!==o||0!==l)&&(this._x=o*_.a+l*_.c,this._y=l*_.d+o*_.b),s&&_.bTransform?(Matrix.mul(s,_,e._tmpMatrix),s=e._tmpMatrix,s._checkTransform()):(this._x+=_.tx,this._y+=_.ty),this._drawTextureM(t,n,i,r,a,0,0,s,h),this._x=u,this._y=c},i.fillQuadrangle=function(t,e,n,i,r){var a=this._curSubmit,s=this._vb,o=this._shader2D,l=a.shaderValue;if(this._renderKey=0,t.bitmap){var h=t.bitmap;o.glTexture==h&&o.ALPHA===l.ALPHA||(o.glTexture=h,a=this._curSubmit=Submit.createSubmit(this,this._ib,s,s._byteLength/32*3,Value2D.create(1,0)),a.shaderValue.glTexture=h,this._submits[this._submits._length++]=a),GlUtils.fillQuadrangleImgVb(s,e,n,i,t.uv,r||this._curMat,this._x,this._y)}else a.shaderValue.fillStyle&&a.shaderValue.fillStyle.equal(t)&&o.ALPHA===l.ALPHA||(o.glTexture=null,a=this._curSubmit=Submit.createSubmit(this,this._ib,s,s._byteLength/32*3,Value2D.create(2,0)),a.shaderValue.defines.add(2),a.shaderValue.fillStyle=DrawStyle.create(t),this._submits[this._submits._length++]=a),GlUtils.fillQuadrangleImgVb(s,e,n,i,Texture.DEF_UV,r||this._curMat,this._x,this._y);a._numEle+=6},i.drawTexture2=function(t,n,i,r,a,s,o,l){if(0!=s){var h=this._curMat;if(this._x=t*h.a+n*h.c,this._y=n*h.d+t*h.b,a&&(h.bTransform||a.bTransform?(Matrix.mul(a,h,e._tmpMatrix),a=e._tmpMatrix):(this._x+=a.tx+h.tx,this._y+=a.ty+h.ty,a=Matrix.EMPTY)),1!==s||o){var _=this._shader2D.ALPHA,u=this._nBlendType;this._shader2D.ALPHA=s,o&&(this._nBlendType=BlendMode.TOINT(o)),this._drawTextureM(l[0],l[1]-i,l[2]-r,l[3],l[4],0,0,a,1),this._shader2D.ALPHA=_,this._nBlendType=u}else this._drawTextureM(l[0],l[1]-i,l[2]-r,l[3],l[4],0,0,a,1);this._x=this._y=0}},i.drawCanvas=function(t,e,n,i,r){var a=t.context;if(this._renderKey=0,a._targets)this._submits[this._submits._length++]=SubmitCanvas.create(a,0,null),this._curSubmit=Submit.RENDERBASE,a._targets.drawTo(this,e,n,i,r);else{var s=this._submits[this._submits._length++]=SubmitCanvas.create(a,this._shader2D.ALPHA,this._shader2D.filters),o=i/t.width,l=r/t.height,h=s._matrix;this._curMat.copyTo(h),1!=o&&1!=l&&h.scale(o,l);var _=h.tx,u=h.ty;h.tx=h.ty=0,h.transformPoint(Point.TEMP.setTo(e,n)),h.translate(Point.TEMP.x+_,Point.TEMP.y+u),this._curSubmit=Submit.RENDERBASE}Config.showCanvasMark&&(this.save(),this.lineWidth=4,this.strokeStyle=a._targets?"yellow":"green",this.strokeRect(e-1,n-1,i+2,r+2,1),this.strokeRect(e,n,i,r,1),this.restore())},i.drawTarget=function(t,e,n,i,r,a,s,o,l,h){void 0===h&&(h=-1);var _=this._vb;if(GlUtils.fillRectImgVb(_,this._clipRect,e,n,i,r,l||Texture.DEF_UV,a||this._curMat,this._x,this._y,0,0)){this._renderKey=0;this._shader2D.glTexture=null;var u=(this._curSubmit.shaderValue,this._curSubmit=SubmitTarget.create(this,this._ib,_,(_._byteLength-64)/32*3,o,s));u.blendType=-1==h?this._nBlendType:h,u.scope=t,this._submits[this._submits._length++]=u,this._curSubmit._numEle+=6}},i.transform=function(t,e,n,i,r,a){SaveTransform.save(this),Matrix.mul(Matrix.TEMP.setTo(t,e,n,i,r,a),this._curMat,this._curMat),this._curMat._checkTransform()},i.setTransformByMatrix=function(t){t.copyTo(this._curMat)},i.transformByMatrix=function(t){SaveTransform.save(this),Matrix.mul(t,this._curMat,this._curMat),this._curMat._checkTransform()},i.rotate=function(t){SaveTransform.save(this),this._curMat.rotateEx(t)},i.scale=function(t,e){SaveTransform.save(this),this._curMat.scaleEx(t,e)},i.clipRect=function(t,e,n,i){if(0!=this._curMat.b||0!=this._curMat.c){this._renderKey=0;var r=SubmitStencil.create(4);this.addRenderObject(r);var a=this._vb,s=a._byteLength>>2;if(GlUtils.fillRectImgVb(a,null,t,e,n,i,Texture.DEF_UV,this._curMat,this._x,this._y,0,0)){this._shader2D.glTexture=null;var o=this._curSubmit=Submit.createSubmit(this,this._ib,a,(a._byteLength-64)/32*3,Value2D.create(2,0));o.shaderValue.ALPHA=1,this._submits[this._submits._length++]=o,this._curSubmit._numEle+=6}else alert("clipRect calc stencil rect error");var l=SubmitStencil.create(5);this.addRenderObject(l);var h=a.getFloat32Array(),_=Math.min(Math.min(Math.min(h[s+0],h[s+4]),h[s+8]),h[s+12]),u=Math.max(Math.max(Math.max(h[s+0],h[s+4]),h[s+8]),h[s+12]),c=Math.min(Math.min(Math.min(h[s+1],h[s+5]),h[s+9]),h[s+13]),d=Math.max(Math.max(Math.max(h[s+1],h[s+5]),h[s+9]),h[s+13]);SaveClipRectStencil.save(this,l,t,e,n,i,_,c,u-_,d-c),this._curSubmit=Submit.RENDERBASE}else{n*=this._curMat.a,i*=this._curMat.d;var f=Point.TEMP;this._curMat.transformPoint(f.setTo(t,e)),n<0&&(f.x=f.x+n,n=-n),i<0&&(f.y=f.y+i,i=-i),this._renderKey=0;var m=this._curSubmit=SubmitScissor.create(this);this._submits[this._submits._length++]=m,m.submitIndex=this._submits._length,m.submitLength=9999999,SaveClipRect.save(this,m);var p=this._clipRect,g=p.x,v=p.y,x=f.x+n,S=f.y+i;g<f.x&&(p.x=f.x),v<f.y&&(p.y=f.y),p.width=Math.min(x,g+p.width)-p.x,p.height=Math.min(S,v+p.height)-p.y,this._shader2D.glTexture=null,m.clipRect.copyFrom(p),this._curSubmit=Submit.RENDERBASE}},i.setIBVB=function(t,e,n,i,r,a,s,o,l,h,_){if(void 0===l&&(l=0),void 0===h&&(h=0),void 0===_&&(_=0),null===n){if(Render.isFlash){var u=i;u._selfIB||(u._selfIB=IndexBuffer2D.create(35044)),u._selfIB.clear(),n=u._selfIB}else n=this._ib;GlUtils.expandIBQuadrangle(n,i._byteLength/(4*i.vertexStride*4))}if(!o||!s)throw Error("setIBVB must input:shader shaderValues");var c=SubmitOtherIBVB.create(this,i,n,r,s,o,l,h,_);a||(a=Matrix.EMPTY),a.translate(t,e),Matrix.mul(a,this._curMat,c._mat),a.translate(-t,-e),this._submits[this._submits._length++]=c,this._curSubmit=Submit.RENDERBASE,this._renderKey=0},i.addRenderObject=function(t){this._submits[this._submits._length++]=t},i.fillTrangles=function(t,e,n,i,r){var a=this._curSubmit,s=this._vb,o=this._shader2D,l=a.shaderValue,h=i.length>>4,_=t.bitmap;this._renderKey=0,o.glTexture==_&&o.ALPHA===l.ALPHA||(a=this._curSubmit=Submit.createSubmit(this,this._ib,s,s._byteLength/32*3,Value2D.create(1,0)),a.shaderValue.textureHost=t,this._submits[this._submits._length++]=a),GlUtils.fillTranglesVB(s,e,n,i,r||this._curMat,this._x,this._y),a._numEle+=6*h},i.submitElement=function(t,e){var n=this._submits;for(e<0&&(e=n._length);t<e;)t+=n[t].renderSubmit()},i.finish=function(){WebGL.mainContext.finish()},i.flush=function(){var t=Math.max(this._vb._byteLength/64,this._maxNumEle/6)+8;if(t>this._ib.bufferLength/12&&GlUtils.expandIBQuadrangle(this._ib,t),!this._isMain&&AtlasResourceManager.enabled&&AtlasResourceManager._atlasRestore>this._atlasResourceChange){this._atlasResourceChange=AtlasResourceManager._atlasRestore;for(var e=this._submits,n=0,i=e._length;n<i;n++){var r=e[n];10016===r.getRenderType()&&r.checkTexture()}}return this.submitElement(0,this._submits._length),this._path&&this._path.reset(),SkinMeshBuffer.instance&&SkinMeshBuffer.getInstance().reset(),this._curSubmit=Submit.RENDERBASE,this._renderKey=0,this._submits._length},i.setPathId=function(t){if(this.mId=t,-1!=this.mId){this.mHaveKey=!1;var e=VectorGraphManager.getInstance();e.shapeDic[this.mId]&&(this.mHaveKey=!0),this.mHaveLineKey=!1,e.shapeLineDic[this.mId]&&(this.mHaveLineKey=!0)}},i.movePath=function(t,e){var n=t,i=e;t=this._curMat.a*n+this._curMat.c*i+this._curMat.tx,e=this._curMat.b*n+this._curMat.d*i+this._curMat.ty,this.mX+=t,this.mY+=e},i.beginPath=function(){var t=this._getPath();t.tempArray.length=0,t.closePath=!1,this.mX=0,this.mY=0},i.closePath=function(){this._path.closePath=!0},i.fill=function(t){void 0===t&&(t=!1);var e=this._getPath();this.drawPoly(0,0,e.tempArray,this.fillStyle._color.numColor,0,0,t)},i.stroke=function(){var t=this._getPath();if(this.lineWidth>0){if(-1==this.mId)t.drawLine(0,0,t.tempArray,this.lineWidth,this.strokeStyle._color.numColor);else if(this.mHaveLineKey){var e=VectorGraphManager.getInstance().shapeLineDic[this.mId];e.rebuild(t.tempArray),t.setGeomtry(e)}else VectorGraphManager.getInstance().addLine(this.mId,t.drawLine(0,0,t.tempArray,this.lineWidth,this.strokeStyle._color.numColor));t.update();var n=[this.mX,this.mY],i=Submit.createShape(this,t.ib,t.vb,t.count,t.offset,Value2D.create(4,0));i.shaderValue.ALPHA=this._shader2D.ALPHA,i.shaderValue.u_pos=n,i.shaderValue.u_mmat2=RenderState2D.TEMPMAT4_ARRAY,this._submits[this._submits._length++]=i}},i.line=function(t,e,n,i,r,a){var s=this._curSubmit,o=this._vb;if(GlUtils.fillLineVb(o,this._clipRect,t,e,n,i,r,a)){this._renderKey=0;var l=this._shader2D,h=s.shaderValue;l.strokeStyle===h.strokeStyle&&l.ALPHA===h.ALPHA||(l.glTexture=null,s=this._curSubmit=Submit.createSubmit(this,this._ib,o,(o._byteLength-64)/32*3,Value2D.create(2,0)),s.shaderValue.strokeStyle=l.strokeStyle,s.shaderValue.mainID=2,s.shaderValue.ALPHA=l.ALPHA,this._submits[this._submits._length++]=s),s._numEle+=6}},i.moveTo=function(t,e,n){void 0===n&&(n=!0);var i=this._getPath();if(n){var r=t,a=e;t=this._curMat.a*r+this._curMat.c*a,e=this._curMat.b*r+this._curMat.d*a}i.addPoint(t,e)},i.lineTo=function(t,e,n){void 0===n&&(n=!0);var i=this._getPath();if(n){var r=t,a=e;t=this._curMat.a*r+this._curMat.c*a,e=this._curMat.b*r+this._curMat.d*a}i.addPoint(t,e)},i.drawCurves=function(t,e,n){this.setPathId(-1),this.beginPath(),this.strokeStyle=n[3],this.lineWidth=n[4];var i=n[2];t+=n[0],e+=n[1],this.movePath(t,e),this.moveTo(i[0],i[1]);for(var r=2,a=i.length;r<a;)this.quadraticCurveTo(i[r++],i[r++],i[r++],i[r++]);this.stroke()},i.arcTo=function(t,n,i,r,a){if(-1==this.mId||!this.mHaveKey){var s=0,o=0,l=0,h=this._getPath();this._curMat.copyTo(e._tmpMatrix),e._tmpMatrix.tx=e._tmpMatrix.ty=0,e._tempPoint.setTo(h.getEndPointX(),h.getEndPointY()),e._tmpMatrix.invertTransformPoint(e._tempPoint);var _=e._tempPoint.x-t,u=e._tempPoint.y-n,c=Math.sqrt(_*_+u*u);if(!(c<=1e-6)){var d=_/c,f=u/c,m=i-t,p=r-n,g=m*m+p*p,v=Math.sqrt(g);if(!(v<=1e-6)){var x=m/v,S=p/v,T=d+x,E=f+S,y=Math.sqrt(T*T+E*E);if(!(y<=1e-6)){var M=T/y,D=E/y,C=Math.acos(M*d+D*f),R=Math.PI/2-C;c=a/Math.tan(R);var A=c*d+t,b=c*f+n,I=Math.sqrt(c*c+a*a),w=t+M*I,V=n+D*I,L=d*S-f*x,P=0,N=0,O=0;if(L>=0){P=2*R;var F=P/e.SEGNUM;N=Math.sin(F),O=Math.cos(F)}else P=2*-R,F=P/e.SEGNUM,N=Math.sin(F),O=Math.cos(F);o=this._curMat.a*A+this._curMat.c*b,l=this._curMat.b*A+this._curMat.d*b,o==this._path.getEndPointX()&&l==this._path.getEndPointY()||h.addPoint(o,l);var B=A-w,U=b-V;for(s=0;s<e.SEGNUM;s++){var G=B*O+U*N,H=-B*N+U*O;o=G+w,l=H+V,t=this._curMat.a*o+this._curMat.c*l,n=this._curMat.b*o+this._curMat.d*l,o=t,l=n,o==this._path.getEndPointX()&&l==this._path.getEndPointY()||h.addPoint(o,l),B=G,U=H}}}}}},i.arc=function(t,e,n,i,r,a,s){if(void 0===a&&(a=!1),void 0===s&&(s=!0),-1!=this.mId){var o=VectorGraphManager.getInstance().shapeDic[this.mId];if(o&&this.mHaveKey&&!o.needUpdate(this._curMat))return;t=0,e=0}var l=0,h=0,_=0,u=0,c=0,d=0,f=0,m=0,p=0,g=0;if(h=r-i,a)if(Math.abs(h)>=2*Math.PI)h=2*-Math.PI;else for(;h>0;)h-=2*Math.PI;else if(Math.abs(h)>=2*Math.PI)h=2*Math.PI;else for(;h<0;)h+=2*Math.PI;g=n<101?Math.max(10,h*n/5):n<201?Math.max(10,h*n/20):Math.max(10,h*n/40),_=h/g/2,u=Math.abs(4/3*(1-Math.cos(_))/Math.sin(_)),a&&(u=-u);var v=this._getPath(),x=NaN,S=NaN;for(p=0;p<=g;p++)l=i+h*(p/g),c=Math.cos(l),d=Math.sin(l),f=t+c*n,m=e+d*n,s&&(x=f,S=m,f=this._curMat.a*x+this._curMat.c*S,m=this._curMat.b*x+this._curMat.d*S),f==this._path.getEndPointX()&&m==this._path.getEndPointY()||v.addPoint(f,m);c=Math.cos(r),d=Math.sin(r),f=t+c*n,m=e+d*n,s&&(x=f,S=m,f=this._curMat.a*x+this._curMat.c*S,m=this._curMat.b*x+this._curMat.d*S),f==this._path.getEndPointX()&&m==this._path.getEndPointY()||v.addPoint(f,m)},i.quadraticCurveTo=function(t,e,n,i){var r=Bezier.I,a=n,s=i;n=this._curMat.a*a+this._curMat.c*s,i=this._curMat.b*a+this._curMat.d*s,a=t,s=e,t=this._curMat.a*a+this._curMat.c*s,e=this._curMat.b*a+this._curMat.d*s;for(var o=r.getBezierPoints([this._path.getEndPointX(),this._path.getEndPointY(),t,e,n,i],30,2),l=0,h=o.length/2;l<h;l++)this.lineTo(o[2*l],o[2*l+1],!1);this.lineTo(n,i,!1)},i.rect=function(t,e,n,i){this._other=this._other.make(),this._other.path||(this._other.path=new Path),this._other.path.rect(t,e,n,i)},i.strokeRect=function(t,e,n,i,r){var a=.5*r;this.line(t-a,e,t+n+a,e,r,this._curMat),this.line(t+n,e,t+n,e+i,r,this._curMat),this.line(t,e,t,e+i,r,this._curMat),this.line(t-a,e+i,t+n+a,e+i,r,this._curMat)},i.clip=function(){},i.drawPoly=function(t,e,n,i,r,a,s){void 0===s&&(s=!1),this._renderKey=0,this._shader2D.glTexture=null;var o=this._getPath();if(-1==this.mId)o.polygon(t,e,n,i,r||1,a);else if(this.mHaveKey){var l=VectorGraphManager.getInstance().shapeDic[this.mId];l.setMatrix(this._curMat),l.rebuild(o.tempArray),o.setGeomtry(l)}else{var h=o.polygon(t,e,n,i,r||1,a);VectorGraphManager.getInstance().addShape(this.mId,h),h.setMatrix(this._curMat)}o.update();var _,u=[this.mX,this.mY];if(!s){var c=SubmitStencil.create(4);this.addRenderObject(c),_=Submit.createShape(this,o.ib,o.vb,o.count,o.offset,Value2D.create(4,0)),_.shaderValue.ALPHA=this._shader2D.ALPHA,_.shaderValue.u_pos=u,_.shaderValue.u_mmat2=RenderState2D.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=_,c=SubmitStencil.create(5),this.addRenderObject(c)}if(_=Submit.createShape(this,o.ib,o.vb,o.count,o.offset,Value2D.create(4,0)),_.shaderValue.ALPHA=this._shader2D.ALPHA,_.shaderValue.u_pos=u,_.shaderValue.u_mmat2=RenderState2D.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=_,s||(_=Submit.createShape(this,o.ib,o.vb,o.count,o.offset,Value2D.create(4,0)),_.shaderValue.ALPHA=this._shader2D.ALPHA,_.shaderValue.u_pos=u,_.shaderValue.u_mmat2=RenderState2D.EMPTYMAT4_ARRAY,SubmitStencil.restore2(this,_)),r>0){if(this.mHaveLineKey){var d=VectorGraphManager.getInstance().shapeLineDic[this.mId];d.rebuild(o.tempArray),o.setGeomtry(d)}else VectorGraphManager.getInstance().addShape(this.mId,o.drawLine(t,e,n,r,a));o.update(),_=Submit.createShape(this,o.ib,o.vb,o.count,o.offset,Value2D.create(4,0)),_.shaderValue.ALPHA=this._shader2D.ALPHA,_.shaderValue.u_mmat2=RenderState2D.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=_}},i.drawParticle=function(t,e,n){n.x=t,n.y=e,this._submits[this._submits._length++]=n},i._getPath=function(){return this._path||(this._path=new Path)},__getset(0,i,"globalCompositeOperation",function(){return BlendMode.NAMES[this._nBlendType]},function(t){var e=BlendMode.TOINT[t];null==e||this._nBlendType===e||(SaveBase.save(this,65536,this,!0),this._curSubmit=Submit.RENDERBASE,this._renderKey=0,this._nBlendType=e)}),__getset(0,i,"textAlign",function(){return this._other.textAlign},function(t){this._other.textAlign===t||(this._other=this._other.make(),SaveBase.save(this,32768,this._other,!1),this._other.textAlign=t)}),__getset(0,i,"globalAlpha",function(){return this._shader2D.ALPHA},function(t){(t=Math.floor(1e3*t)/1e3)!=this._shader2D.ALPHA&&(SaveBase.save(this,1,this._shader2D,!0),this._shader2D.ALPHA=t)}),__getset(0,i,"strokeStyle",function(){return this._shader2D.strokeStyle},function(t){this._shader2D.strokeStyle.equal(t)||(SaveBase.save(this,512,this._shader2D,!1),this._shader2D.strokeStyle=DrawStyle.create(t))}),__getset(0,i,"textBaseline",function(){return this._other.textBaseline},function(t){this._other.textBaseline===t||(this._other=this._other.make(),SaveBase.save(this,16384,this._other,!1),this._other.textBaseline=t)}),__getset(0,i,"font",null,function(t){t!=this._other.font.toString()&&(this._other=this._other.make(),SaveBase.save(this,8,this._other,!1),this._other.font===FontInContext.EMPTY?this._other.font=new FontInContext(t):this._other.font.setFont(t))}),__getset(0,i,"lineWidth",function(){return this._other.lineWidth},function(t){this._other.lineWidth===t||(this._other=this._other.make(),SaveBase.save(this,256,this._other,!1),this._other.lineWidth=t)}),__getset(0,i,"fillStyle",function(){return this._shader2D.fillStyle},function(t){this._shader2D.fillStyle.equal(t)||(SaveBase.save(this,2,this._shader2D,!1),this._shader2D.fillStyle=DrawStyle.create(t))}),__getset(0,i,"asBitmap",null,function(t){if(t){if(this._targets||(this._targets=new RenderTargetMAX),this._targets.repaint=!0,!this._width||!this._height)throw Error("asBitmap no size!");this._targets.setSP(this.sprite),this._targets.size(this._width,this._height)}else this._targets=null}),e.__init__=function(){n.DEFAULT=new n},e._tempPoint=new Point,e._SUBMITVBSIZE=32e3,e._MAXSIZE=99999999,e._RECTVBSIZE=16,e.MAXCLIPRECT=new Rectangle(0,0,99999999,99999999),e._COUNT=0,e._tmpMatrix=new Matrix,e.SEGNUM=32,e._contextcount=0,__static(e,["_fontTemp",function(){return this._fontTemp=new FontInContext},"_drawStyleTemp",function(){return this._drawStyleTemp=new DrawStyle(null)}]),e.__init$=function(){n=function(){function t(){this.lineWidth=1,this.path=null,this.textAlign=null,this.textBaseline=null,this.font=FontInContext.EMPTY}__class(t,"");var e=t.prototype;return e.clear=function(){this.lineWidth=1,this.path&&this.path.clear(),this.textAlign=this.textBaseline=null,this.font=FontInContext.EMPTY},e.make=function(){return this===t.DEFAULT?new t:this},t.DEFAULT=null,t}()},e}(Context),Value2D=function(t){function e(t,n){this.size=[0,0],this.alpha=1,this.ALPHA=1,this.subID=0,this._cacheID=0,e.__super.call(this),this.defines=new ShaderDefines2D,this.position=e._POSITION,this.mainID=t,this.subID=n,this.textureHost=null,this.texture=null,this.fillStyle=null,this.color=null,this.strokeStyle=null,this.colorAdd=null,this.glTexture=null,this.u_mmat2=null,this._cacheID=t|n,this._inClassCache=e._cache[this._cacheID],t>0&&!this._inClassCache&&(this._inClassCache=e._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}__class(e,"laya.webgl.shader.d2.value.Value2D",t);var n=e.prototype;return n.setValue=function(t){},n.refresh=function(){var t=this.size;return t[0]=RenderState2D.width,t[1]=RenderState2D.height,this.alpha=this.ALPHA*RenderState2D.worldAlpha,this.mmat=RenderState2D.worldMatrix4,this},n._ShaderWithCompile=function(){return Shader.withCompile2D(0,this.mainID,this.defines.toNameDic(),this.mainID|this.defines._value,Shader2X.create)},n._withWorldShaderDefines=function(){var t=RenderState2D.worldShaderDefines,e=Shader.sharders[this.mainID|this.defines._value|t.getValue()];if(!e){var n,i,r={};n=this.defines.toNameDic();for(i in n)r[i]="";n=t.toNameDic();for(i in n)r[i]="";e=Shader.withCompile2D(0,this.mainID,r,this.mainID|this.defines._value|t.getValue(),Shader2X.create)}var a=RenderState2D.worldFilters;if(!a)return e;for(var s,o=a.length,l=0;l<o;l++)(s=a[l])&&s.action.setValue(this);return e},n.upload=function(){var t=RenderState2D;this.alpha=this.ALPHA*t.worldAlpha,RenderState2D.worldMatrix4!==RenderState2D.TEMPMAT4_ARRAY&&this.defines.add(128),WebGL.shaderHighPrecision&&this.defines.add(1024);var e,n=t.worldShaderDefines?this._withWorldShaderDefines():Shader.sharders[this.mainID|this.defines._value]||this._ShaderWithCompile();this.size[0]=t.width,this.size[1]=t.height,this.mmat=t.worldMatrix4,BaseShader.activeShader!==n?(n._shaderValueWidth!==t.width||n._shaderValueHeight!==t.height?(n._shaderValueWidth=t.width,n._shaderValueHeight=t.height):e=n._params2dQuick2||n._make2dQuick2(),n.upload(this,e)):(n._shaderValueWidth!==t.width||n._shaderValueHeight!==t.height?(n._shaderValueWidth=t.width,n._shaderValueHeight=t.height):e=n._params2dQuick1||n._make2dQuick1(),n.upload(this,e))},n.setFilters=function(t){if(this.filters=t,t)for(var e,n=t.length,i=0;i<n;i++)(e=t[i])&&(this.defines.add(e.type),e.action.setValue(this))},n.clear=function(){this.defines.setValue(this.subID)},n.release=function(){this._inClassCache[this._inClassCache._length++]=this,this.fillStyle=null,this.strokeStyle=null,this.clear()},e._initone=function(t,n){e._typeClass[t]=n,e._cache[t]=[],e._cache[t]._length=0},e.__init__=function(){e._POSITION=[2,5126,!1,4*CONST3D2D.BYTES_PE,0],e._TEXCOORD=[2,5126,!1,4*CONST3D2D.BYTES_PE,2*CONST3D2D.BYTES_PE],e._initone(2,Color2dSV),e._initone(4,PrimitiveSV),e._initone(256,FillTextureSV),e._initone(512,SkinSV),e._initone(1,TextureSV),e._initone(65,TextSV),e._initone(9,TextureSV)},e.create=function(t,n){var i=e._cache[t|n];return i._length?i[--i._length]:new e._typeClass[t|n](n)},e._POSITION=null,e._TEXCOORD=null,e._cache=[],e._typeClass=[],e.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e}(ShaderValue),ShaderDefines2D=function(t){function e(){e.__super.call(this,e.__name2int,e.__int2name,e.__int2nameMap)}return __class(e,"laya.webgl.shader.d2.ShaderDefines2D",t),e.__init__=function(){e.reg("TEXTURE2D",1),e.reg("COLOR2D",2),e.reg("PRIMITIVE",4),e.reg("GLOW_FILTER",8),e.reg("BLUR_FILTER",16),e.reg("COLOR_FILTER",32),e.reg("COLOR_ADD",64),e.reg("WORLDMAT",128),e.reg("FILLTEXTURE",256),e.reg("FSHIGHPRECISION",1024)},e.reg=function(t,n){ShaderDefines._reg(t,n,e.__name2int,e.__int2name)},e.toText=function(t,e,n){return ShaderDefines._toText(t,e,n)},e.toInt=function(t){return ShaderDefines._toInt(t,e.__name2int)},e.TEXTURE2D=1,e.COLOR2D=2,e.PRIMITIVE=4,e.FILTERGLOW=8,e.FILTERBLUR=16,e.FILTERCOLOR=32,e.COLORADD=64,e.WORLDMAT=128,e.FILLTEXTURE=256,e.SKINMESH=512,e.SHADERDEFINE_FSHIGHPRECISION=1024,e.__name2int={},e.__int2name=[],e.__int2nameMap=[],e}(ShaderDefines),AnimationTransform3D=function(t){function e(t){this._worldMatrix=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._parent=null,this._childs=null,this._owner=null,this._worldUpdate=!0,this._scaleUpdate=!0,this._entity=null,e.__super.call(this),this._scale=new Vector3(1,1,1),this._localMatrix=new Matrix4x4,this._localPosition=new Vector3,this._localRotation=new Quaternion(0,0,0,1),this._localScale=new Vector3(1,1,1),this._localRotationEuler=new Vector3,this._owner=t,this._childs=[]}__class(e,"laya.d3.animation.AnimationTransform3D",t);var n=e.prototype;return n._updateLocalMatrix=function(){Matrix4x4.createAffineTransformation(this._localPosition,this._localRotation,this._localScale,this._localMatrix)},n._onLocalTransform=function(){this._localUpdate=!0},n._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldTransform()}},n._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldScaleTransform()}},n._setLocalPosition=function(t){if(this._parent)this._localPosition=t,this._onLocalTransform(),this._onWorldTransform();else{var e=this._entity.owner._transform,n=this._entity.localPosition;t.cloneTo(n),e.localPosition=n}},n._setLocalRotation=function(t){if(this._parent)this._localRotation=t,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldTransform();else{var e=this._entity.owner._transform,n=this._entity.localRotation;t.cloneTo(n),e.localRotation=n}},n._setLocalScale=function(t){if(this._parent)this._localScale=t,this._onLocalTransform(),this._onWorldTransform();else{var e=this._entity.owner._transform,n=this._entity.localScale;t.cloneTo(n),e.localScale=n}},n._setLocalRotationEuler=function(t){if(this._parent){var n=t.elements;Quaternion.createFromYawPitchRoll(n[1]/e._angleToRandin,n[0]/e._angleToRandin,n[2]/e._angleToRandin,this._localRotation),this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldTransform()}else{var i=this._entity.owner._transform,r=this._entity.localRotationEuler;t.cloneTo(r),i.localRotationEuler=r}},n._getWorldMatrix=function(){return this._worldUpdate&&(null!=this._parent._parent?Matrix4x4.multiply(this._parent._getWorldMatrix(),this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},n._setWorldMatrixAndUpdate=function(t){if(this._worldMatrix=t,null==this._parent)throw new Error("don't need to set worldMatrix to root Node.");null==this._parent._parent?this.localMatrix.cloneTo(this._worldMatrix):Matrix4x4.multiply(this._parent._getWorldMatrix(),this.localMatrix,this._worldMatrix),this._worldUpdate=!1},n._setWorldMatrixNoUpdate=function(t){this._worldMatrix=t,this._worldUpdate=!1},n.getScale=function(){return this._scaleUpdate&&(null!==this._parent?Vector3.multiply(this._parent.getScale(),this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1),this._scale},__getset(0,n,"localScale",function(){return this._localScale},function(t){this._localScale=t,this._onLocalTransform(),this._onWorldScaleTransform()}),__getset(0,n,"parent",function(){return this._parent},function(t){if(this._parent!==t){if(this._parent){var e=this._parent._childs,n=e.indexOf(this);e.splice(n,1)}t&&(t._childs.push(this),t&&this._onWorldTransform()),this._parent=t}}),__getset(0,n,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(e._tempVector3);var t=e._tempVector3.elements,n=this._localRotationEuler.elements;n[0]=t[1]/e._randinToAngle,n[1]=t[0]/e._randinToAngle,n[2]=t[2]/e._randinToAngle,this._locaEulerlUpdate=!1}return this._localRotationEuler},function(t){t.elements;this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._onLocalTransform(),this._onWorldTransform()}),__getset(0,n,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix}),__getset(0,n,"localRotation",function(){if(this._localQuaternionUpdate){var t=this._localRotationEuler.elements;Quaternion.createFromYawPitchRoll(t[1]/e._angleToRandin,t[0]/e._angleToRandin,t[2]/e._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},function(t){this._localRotation=t,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldTransform()}),__getset(0,n,"localPosition",function(){return this._localPosition},function(t){this._localPosition=t,this._onLocalTransform(),this._onWorldTransform()}),__static(e,["_tempVector3",function(){return this._tempVector3=new Vector3},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI},"_randinToAngle",function(){return this._randinToAngle=180*Math.PI}]),e}(EventDispatcher),Component3D=function(t){function e(){this._destroyed=!1,this._id=0,this._enable=!1,this._owner=null,this.started=!1,e.__super.call(this),this._destroyed=!1,this._id=e._uniqueIDCounter,e._uniqueIDCounter++}__class(e,"laya.d3.component.Component3D",t);var n=e.prototype;return Laya.imps(n,{"laya.resource.IDestroy":!0,"laya.d3.core.render.IUpdate":!0}),n._initialize=function(t){this._owner=t,this._enable=!0,this.started=!1,this._load(t)},n._destroy=function(){this._unload(this._owner),this._owner=null,this._destroyed=!0},n._load=function(t){},n._start=function(t){},n._update=function(t){},n._lateUpdate=function(t){},n._preRenderUpdate=function(t){},n._postRenderUpdate=function(t){},n._unload=function(t){this.offAll()},n._cloneTo=function(t){},__getset(0,n,"destroyed",function(){return this._destroyed}),__getset(0,n,"isSingleton",function(){return e._isSingleton}),__getset(0,n,"enable",function(){return this._enable},function(t){this._enable!==t&&(this._enable=t,this.event("enablechanged",this._enable))}),__getset(0,n,"owner",function(){return this._owner}),__getset(0,n,"id",function(){return this._id}),e._isSingleton=!0,e._uniqueIDCounter=1,e}(EventDispatcher),CollisionManager=function(t){function e(){e.__super.call(this)}return __class(e,"laya.d3.utils.CollisionManager",t),e._onTrigger=function(t,e,n,i,r){var a=0,s=0,o=t.id,l=e.id;if(!t._ignoreCollisonMap[l]){var h=Physics.collisionManager,_=t._runtimeCollisonTestMap[l];if(null!=_)if(_)if(t._collisonTo(e))if(t._runtimeCollisonMap[l]){for(a=0,s=n.length;a<s;a++)n[a].onTriggerStay(e);for(a=0,s=i.length;a<s;a++)i[a].onTriggerStay(t);h.event("triggerstay",[t,e])}else{for(t._runtimeCollisonMap[l]=e,t._runtimeCollisonTestMap[l]=!1,e._runtimeCollisonMap[o]=t,r&&(e._runtimeCollisonTestMap[o]=!1),a=0,s=n.length;a<s;a++)n[a].onTriggerEnter(e);for(a=0,s=i.length;a<s;a++)i[a].onTriggerEnter(t);h.event("triggerenter",[t,e])}else{var u=t._runtimeCollisonMap;if(u[l]){for(delete u[l],delete t._runtimeCollisonTestMap[l],delete e._runtimeCollisonMap[o],r&&delete e._runtimeCollisonTestMap[o],a=0,s=n.length;a<s;a++)n[a].onTriggerExit(e);for(a=0,s=i.length;a<s;a++)i[a].onTriggerExit(t);h.event("triggerexit",[t,e])}}else{for(a=0,s=n.length;a<s;a++)n[a].onTriggerStay(e);for(a=0,s=i.length;a<s;a++)i[a].onTriggerStay(t);h.event("triggerstay",[t,e])}else if(t._collisonTo(e)){for(t._runtimeCollisonMap[l]=e,t._runtimeCollisonTestMap[l]=!1,e._runtimeCollisonMap[o]=t,r&&(e._runtimeCollisonTestMap[o]=!1),a=0,s=n.length;a<s;a++)n[a].onTriggerEnter(e);for(a=0,s=i.length;a<s;a++)i[a].onTriggerEnter(t);h.event("triggerenter",[t,e])}}},e._triggerCollision=function(){for(var t=Layer._collsionTestList,n=t.length,i=Physics._layerCollsionMatrix,r=0;r<n;r++)for(var a=t[r],s=Layer.getLayerByNumber(a),o=s._colliders,l=s._nonRigidbodyOffset,h=n-1;h>=r;h--){var _=t[h],u=i[a][30-_];if(u){var c,d,f,m=0,p=0,g=0,v=0,x=Layer.getLayerByNumber(_),S=x._colliders,T=x._nonRigidbodyOffset;if(s!==x){for(m=0;m<l;m++)if(c=o[m],c.enable){for(f=c.owner._scripts,g=0,v=T;g<v;g++)d=S[g],
d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!0);for(g=T,v=S.length;g<v;g++)d=S[g],d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!1)}for(m=l,p=o.length;m<p;m++)if(c=o[m],c.enable)for(f=c.owner._scripts,g=0,v=x._nonRigidbodyOffset;g<v;g++)d=S[g],d.enable&&e._onTrigger(d,c,f,d.owner._scripts,!1)}else for(m=0;m<l;m++)if(c=o[m],c.enable){for(f=c.owner._scripts,g=m+1,v=l;g<v;g++)d=S[g],d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!0);for(g=l,v=o.length;g<v;g++)d=S[g],d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!1)}}}},e}(EventDispatcher),Atlaser=function(t){function e(t,n,i,r,a){this._atlasCanvas=null,this._inAtlasTextureKey=null,this._inAtlasTextureBitmapValue=null,this._inAtlasTextureOriUVValue=null,this._InAtlasWebGLImagesKey=null,this._InAtlasWebGLImagesOffsetValue=null,e.__super.call(this,t,n,a),this._inAtlasTextureKey=[],this._inAtlasTextureBitmapValue=[],this._inAtlasTextureOriUVValue=[],this._InAtlasWebGLImagesKey={},this._InAtlasWebGLImagesOffsetValue=[],this._atlasCanvas=new AtlasWebGLCanvas,this._atlasCanvas._atlaser=this,this._atlasCanvas.width=i,this._atlasCanvas.height=r,this._atlasCanvas.activeResource(),this._atlasCanvas.lock=!0}__class(e,"laya.webgl.atlas.Atlaser",t);var n=e.prototype;return n.computeUVinAtlasTexture=function(t,e,n,i){var r=AtlasResourceManager.atlasTextureWidth,a=AtlasResourceManager.atlasTextureHeight,s=n/r,o=i/a,l=(n+t.bitmap.width)/r,h=(i+t.bitmap.height)/a,_=t.bitmap.width/r,u=t.bitmap.height/a;t.uv=[s+e[0]*_,o+e[1]*u,l-(1-e[2])*_,o+e[3]*u,l-(1-e[4])*_,h-(1-e[5])*u,s+e[6]*_,h-(1-e[7])*u]},n.findBitmapIsExist=function(t){if(t instanceof laya.webgl.resource.WebGLImage){var e=t,n=e.url,i=this._InAtlasWebGLImagesKey[n||e.id];if(i)return i.offsetInfoID}return-1},n.addToAtlasTexture=function(t,e,n){if(t instanceof laya.webgl.resource.WebGLImage){var i=t,r=i.url;this._InAtlasWebGLImagesKey[r||i.id]={bitmap:t,offsetInfoID:this._InAtlasWebGLImagesOffsetValue.length},this._InAtlasWebGLImagesOffsetValue.push([e,n])}this._atlasCanvas.texSubImage2D(e,n,t.atlasSource),t.clearAtlasSource()},n.addToAtlas=function(t,e,n){t._atlasID=this._inAtlasTextureKey.length;var i=t.uv.slice(),r=t.bitmap;this._inAtlasTextureKey.push(t),this._inAtlasTextureOriUVValue.push(i),this._inAtlasTextureBitmapValue.push(r),this.computeUVinAtlasTexture(t,i,e,n),t.bitmap=this._atlasCanvas},n.clear=function(){for(var t=0,e=this._inAtlasTextureKey.length;t<e;t++)this._inAtlasTextureKey[t].bitmap=this._inAtlasTextureBitmapValue[t],this._inAtlasTextureKey[t].uv=this._inAtlasTextureOriUVValue[t],this._inAtlasTextureKey[t]._atlasID=-1,this._inAtlasTextureKey[t].bitmap.lock=!1,this._inAtlasTextureKey[t].bitmap.releaseResource();this._inAtlasTextureKey.length=0,this._inAtlasTextureBitmapValue.length=0,this._inAtlasTextureOriUVValue.length=0,this._InAtlasWebGLImagesKey=null,this._InAtlasWebGLImagesOffsetValue.length=0},n.dispose=function(){this.clear(),this._atlasCanvas.dispose()},__getset(0,n,"inAtlasWebGLImagesKey",function(){return this._InAtlasWebGLImagesKey}),__getset(0,n,"InAtlasWebGLImagesOffsetValue",function(){return this._InAtlasWebGLImagesOffsetValue}),__getset(0,n,"texture",function(){return this._atlasCanvas}),e}(AtlasGrid),ShaderCompile3D=function(t){function e(t,n,i,r,a,s){this._name=NaN,this._attributeMap=null,this._renderElementUniformMap=null,this._materialUniformMap=null,this._spriteUniformMap=null,this._cameraUniformMap=null,this._sceneUniformMap=null,this.sharders=null,this._curMaterialDefinePower=1,this._curSpriteDefinePower=3,this._materialInt2name=[],this._materialName2Int={},this._spriteInt2name=[],this._conchShader=null,this._name=t,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this._spriteInt2name[1]="RECEIVESHADOW",this._spriteInt2name[2]="SCALEOFFSETLIGHTINGMAPUV",this._spriteInt2name[4]="LIGHTMAP",this._spriteInt2name[SkinnedMeshSprite3D.SHADERDEFINE_BONE]="BONE",this._materialInt2name[1]="ALPHATEST",e.__super.call(this,t,n,i,null),this._attributeMap=r;var o;for(o in a){var l=a[o];switch(l[1]){case 0:this._renderElementUniformMap[o]=l[0];break;case 1:this._materialUniformMap[o]=l[0];break;case 2:this._spriteUniformMap[o]=l[0];break;case 3:this._cameraUniformMap[o]=l[0];break;case 4:this._sceneUniformMap[o]=l[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}if(Render.isConchNode){this._conchShader=new ConchShader,this._conchShader.setSrc(this._VS.sd,this._PS.sd),delete this._VS.sd,delete this._PS.sd;var h=[];for(o in this._attributeMap)h.push({name:o,elementUsage:this._attributeMap[o]});this._conchShader.setAttrDeclare(h);var _=[];for(o in a){var u=a[o];_.push({name:o,elementUsage:u[0],periodType:u[1]})}this._conchShader.setUniformDeclare(_)}}__class(e,"laya.d3.shader.ShaderCompile3D",t);var n=e.prototype;return n._definesToNameDic=function(t,e){for(var n={},i=1,r=0;r<32&&!((i=1<<r)>t);r++)if(t&i){var a=e[i];a&&(n[a]="")}return n},n.withCompile=function(t,n,i){var r,a,s;if(a=this.sharders[t])if(s=a[n]){if(r=s[i])return r}else s=a[n]=[];else a=this.sharders[t]=[],s=a[n]=[];var o,l=this._definesToNameDic(t,e._globalInt2name),h=this._definesToNameDic(n,this._spriteInt2name),_=this._definesToNameDic(i,this._materialInt2name);if(laya.d3.shader.ShaderCompile3D.debugMode){var u="";for(o in l)u+=o+" ";var c="";for(o in h)c+=o+" ";var d="";for(o in _)d+=o+" ";console.log("ShaderCompile3DDebugMode---(Name:"+Shader3D.nameKey.getName(this._name)+" PublicDefine:"+t+" SpriteDefine:"+n+" MaterialDefine:"+i+" PublicDefineGroup:"+u+" SpriteDefineGroup:"+c+"MaterialDefineGroup: "+d+")---ShaderCompile3DDebugMode")}var f={},m="";if(l)for(o in l)m+="#define "+o+"\n",f[o]=!0;if(h)for(o in h)m+="#define "+o+"\n",f[o]=!0;if(_)for(o in _)m+="#define "+o+"\n",f[o]=!0;var p=this._VS.toscript(f,[]),g=this._PS.toscript(f,[]);return r=Shader3D.create(m+p.join("\n"),m+g.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap),s[i]=r,r},n.precompileShaderWithShaderDefine=function(t,e,n){this.withCompile(t,e,n)},n.registerMaterialDefine=function(t){var e=Math.pow(2,this._curMaterialDefinePower++);return this._materialInt2name[e]=t,this._materialName2Int[t]=e,Render.isConchNode&&conch.regShaderDefine&&conch.regShaderDefine(t,e),e},n.registerSpriteDefine=function(t){var e=Math.pow(2,this._curSpriteDefinePower++);return this._spriteInt2name[e]=t,Render.isConchNode&&conch.regShaderDefine&&conch.regShaderDefine(t,e),e},n.getMaterialDefineByName=function(t){return this._materialName2Int[t]},e._globalRegDefine=function(t,n){e._globalInt2name[n]=t},e.add=function(t,n,i,r,a){return laya.d3.shader.ShaderCompile3D._preCompileShader[t]=new e(t,n,i,r,a,ShaderCompile.includes)},e.get=function(t){return laya.d3.shader.ShaderCompile3D._preCompileShader[Shader3D.nameKey.getID(t)]},e._preCompileShader={},e._globalInt2name=[],e.debugMode=!1,e.SHADERDEFINE_HIGHPRECISION=1,e.SHADERDEFINE_FOG=4,e.SHADERDEFINE_DIRECTIONLIGHT=8,e.SHADERDEFINE_POINTLIGHT=16,e.SHADERDEFINE_SPOTLIGHT=32,e.SHADERDEFINE_UV0=64,e.SHADERDEFINE_COLOR=128,e.SHADERDEFINE_UV1=256,e.SAHDERDEFINE_DEPTHFOG=131072,e}(ShaderCompile),SubMeshRenderElement=function(t){function e(){this._batchIndexStart=0,this._batchIndexEnd=0,this._skinAnimationDatas=null,e.__super.call(this)}return __class(e,"laya.d3.core.render.SubMeshRenderElement",t),e}(RenderElement),HemisphereShape=function(t){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",t);var n=e.prototype;return n._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-this.radius;var n=t.max.elements;n[0]=n[1]=this.radius,n[2]=0},n._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=-1,e[2]=0;var n=t.max.elements;n[0]=n[1]=n[2]=1},n.generatePositionAndDirection=function(t,e,n,i){var r=t.elements;n?(n.seed=i[16],this.emitFromShell?ShapeUtils._randomPointUnitSphere(t,n):ShapeUtils._randomPointInsideUnitSphere(t,n),i[16]=n.seed):this.emitFromShell?ShapeUtils._randomPointUnitSphere(t):ShapeUtils._randomPointInsideUnitSphere(t),Vector3.scale(t,this.radius,t);var a=r[2];a<0&&(r[2]=-1*a),this.randomDirection?n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(e,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(e):t.cloneTo(e)},n.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var n=e;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},e}(BaseShape),CircleShape=function(t){function e(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,e.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.CircleShape",t);var n=e.prototype;return n._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[2]=-this.radius,e[1]=0;var n=t.max.elements;n[0]=n[2]=this.radius,n[1]=0},n._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=-1,e[2]=0;var n=t.max.elements;n[0]=n[1]=1,n[2]=0},n.generatePositionAndDirection=function(t,n,i,r){var a=t.elements,s=e._tempPositionPoint.elements;i?(i.seed=r[16],this.emitFromEdge?ShapeUtils._randomPointUnitArcCircle(this.arc,e._tempPositionPoint,i):ShapeUtils._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint,i),r[16]=i.seed):this.emitFromEdge?ShapeUtils._randomPointUnitArcCircle(this.arc,e._tempPositionPoint):ShapeUtils._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint),a[0]=-s[0],a[1]=s[1],a[2]=0,Vector3.scale(t,this.radius,t),this.randomDirection?i?(i.seed=r[17],ShapeUtils._randomPointUnitSphere(n,i),r[17]=i.seed):ShapeUtils._randomPointUnitSphere(n):t.cloneTo(n)},n.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var n=e;n.radius=this.radius,n.arc=this.arc,n.emitFromEdge=this.emitFromEdge,n.randomDirection=this.randomDirection},__static(e,["_tempPositionPoint",function(){return this._tempPositionPoint=new Vector2}]),e}(BaseShape),BoxShape=function(t){function e(){this.x=NaN,this.y=NaN,this.z=NaN,e.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.BoxShape",t);var n=e.prototype;return n._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=.5*-this.x,e[1]=.5*-this.y,e[2]=.5*-this.z;var n=t.max.elements;n[0]=.5*this.x,n[1]=.5*this.y,n[2]=.5*this.z},n._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=0,e[1]=0,e[2]=0;var n=t.max.elements;n[0]=0,n[1]=1,n[2]=0},n.generatePositionAndDirection=function(t,e,n,i){var r=t.elements,a=e.elements;n?(n.seed=i[16],ShapeUtils._randomPointInsideHalfUnitBox(t,n),i[16]=n.seed):ShapeUtils._randomPointInsideHalfUnitBox(t),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(e,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(e):(a[0]=0,a[1]=0,a[2]=1)},n.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var n=e;n.x=this.x,n.y=this.y,n.z=this.z,n.randomDirection=this.randomDirection},e}(BaseShape),ConeShape=function(t){function e(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,e.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.ConeShape",t);var n=e.prototype;return n._getShapeBoundBox=function(t){var e=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),i=t.min.elements;i[0]=i[1]=-e,i[2]=0;var r=t.max.elements;r[0]=r[1]=e,r[2]=n},n._getSpeedBoundBox=function(t){var e=Math.sin(this.angle),n=t.min.elements;n[0]=n[1]=-e,n[2]=0;var i=t.max.elements;i[0]=n[1]=e,i[2]=1},n.generatePositionAndDirection=function(t,n,i,r){var a,s=t.elements,o=n.elements,l=e._tempPositionPoint.elements,h=NaN,_=NaN,u=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:i?(i.seed=r[16],ShapeUtils._randomPointInsideUnitCircle(e._tempPositionPoint,i),r[16]=i.seed):ShapeUtils._randomPointInsideUnitCircle(e._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,this.randomDirection?(i?(i.seed=r[17],ShapeUtils._randomPointInsideUnitCircle(e._tempDirectionPoint,i),r[17]=i.seed):ShapeUtils._randomPointInsideUnitCircle(e._tempDirectionPoint),a=e._tempDirectionPoint.elements,o[0]=a[0]*c,o[1]=a[1]*c):(o[0]=h*c,o[1]=_*c),o[2]=u;break;case 1:i?(i.seed=r[16],ShapeUtils._randomPointUnitCircle(e._tempPositionPoint,i),r[16]=i.seed):ShapeUtils._randomPointUnitCircle(e._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,this.randomDirection?(i?(i.seed=r[17],ShapeUtils._randomPointInsideUnitCircle(e._tempDirectionPoint,i),r[17]=i.seed):ShapeUtils._randomPointInsideUnitCircle(e._tempDirectionPoint),a=e._tempDirectionPoint.elements,o[0]=a[0]*c,o[1]=a[1]*c):(o[0]=h*c,o[1]=_*c),o[2]=u;break;case 2:i?(i.seed=r[16],ShapeUtils._randomPointInsideUnitCircle(e._tempPositionPoint,i)):ShapeUtils._randomPointInsideUnitCircle(e._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,o[0]=h*c,o[1]=_*c,o[2]=u,Vector3.normalize(n,n),i?(Vector3.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):Vector3.scale(n,this.length*Math.random(),n),Vector3.add(t,n,t),this.randomDirection&&(i?(i.seed=r[17],ShapeUtils._randomPointUnitSphere(n,i),r[17]=i.seed):ShapeUtils._randomPointUnitSphere(n));break;case 3:i?(i.seed=r[16],ShapeUtils._randomPointUnitCircle(e._tempPositionPoint,i)):ShapeUtils._randomPointUnitCircle(e._tempPositionPoint),h=l[0],_=l[1],s[0]=h*this.radius,s[1]=_*this.radius,s[2]=0,o[0]=h*c,o[1]=_*c,o[2]=u,Vector3.normalize(n,n),i?(Vector3.scale(n,this.length*i.getFloat(),n),r[16]=i.seed):Vector3.scale(n,this.length*Math.random(),n),Vector3.add(t,n,t),this.randomDirection&&(i?(i.seed=r[17],ShapeUtils._randomPointUnitSphere(n,i),r[17]=i.seed):ShapeUtils._randomPointUnitSphere(n));break;default:throw new Error("ConeShape:emitType is invalid.")}},n.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var n=e;n.angle=this.angle,n.radius=this.radius,n.length=this.length,n.emitType=this.emitType,n.randomDirection=this.randomDirection},__static(e,["_tempPositionPoint",function(){return this._tempPositionPoint=new Vector2},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new Vector2}]),e}(BaseShape),SphereShape=function(t){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}__class(e,"laya.d3.core.particleShuriKen.module.shape.SphereShape",t);var n=e.prototype;return n._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-this.radius;var n=t.max.elements;n[0]=n[1]=n[2]=this.radius},n._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-1;var n=t.max.elements;n[0]=n[1]=n[2]=1},n.generatePositionAndDirection=function(t,e,n,i){n?(n.seed=i[16],this.emitFromShell?ShapeUtils._randomPointUnitSphere(t,n):ShapeUtils._randomPointInsideUnitSphere(t,n),i[16]=n.seed):this.emitFromShell?ShapeUtils._randomPointUnitSphere(t):ShapeUtils._randomPointInsideUnitSphere(t),Vector3.scale(t,this.radius,t),this.randomDirection?n?(n.seed=i[17],ShapeUtils._randomPointUnitSphere(e,n),i[17]=n.seed):ShapeUtils._randomPointUnitSphere(e):t.cloneTo(e)},n.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var n=e;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection},e}(BaseShape),SoundChannel=function(t){function e(){this.url=null,this.loops=0,this.startTime=NaN,this.isStopped=!1,this.completeHandler=null,e.__super.call(this)}__class(e,"laya.media.SoundChannel",t);var n=e.prototype;return n.play=function(){},n.stop=function(){},n.pause=function(){},n.resume=function(){},n.__runComplete=function(t){t&&t.run()},__getset(0,n,"duration",function(){return 0}),__getset(0,n,"position",function(){return 0}),__getset(0,n,"volume",function(){return 1},function(t){}),e}(EventDispatcher),AudioSound=function(t){function e(){this.url=null,this.audio=null,this.loaded=!1,e.__super.call(this)}__class(e,"laya.media.h5audio.AudioSound",t);var n=e.prototype;return n.dispose=function(){var t=e._audioCache[this.url];t&&(t.src="",delete e._audioCache[this.url])},n.load=function(t){function n(){r(),s.loaded=!0,s.event("complete")}function i(){a.load=null,r(),s.event("error")}function r(){a.removeEventListener("canplaythrough",n),a.removeEventListener("error",i)}t=URL.formatURL(t),this.url=t;var a;if(t==SoundManager._tMusic?(e._initMusicAudio(),a=e._musicAudio,a.src!=t&&(e._audioCache[a.src]=null,a=null)):a=e._audioCache[t],a&&a.readyState>=2)return void this.event("complete");a||(t==SoundManager._tMusic?(e._initMusicAudio(),a=e._musicAudio):a=Browser.createElement("audio"),e._audioCache[t]=a,a.src=t),a.addEventListener("canplaythrough",n),a.addEventListener("error",i);var s=this;this.audio=a,a.load?a.load():i()},n.play=function(t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),!this.url)return null;var i;if(!(i=this.url==SoundManager._tMusic?e._musicAudio:e._audioCache[this.url]))return null;var r;r=Pool.getItem("audio:"+this.url),Render.isConchApp?r||(r=Browser.createElement("audio"),r.src=this.url):this.url==SoundManager._tMusic?(e._initMusicAudio(),r=e._musicAudio,r.src=this.url):r=r||i.cloneNode(!0);var a=new AudioSoundChannel(r);return a.url=this.url,a.loops=n,a.startTime=t,a.play(),SoundManager.addChannel(a),a},__getset(0,n,"duration",function(){var t;return t=e._audioCache[this.url],t?t.duration:0}),e._initMusicAudio=function(){e._musicAudio||(e._musicAudio||(e._musicAudio=Browser.createElement("audio")),Render.isConchApp||Browser.document.addEventListener("mousedown",e._makeMusicOK))},e._makeMusicOK=function(){Browser.document.removeEventListener("mousedown",e._makeMusicOK),e._musicAudio.src?e._musicAudio.play():(e._musicAudio.src="",e._musicAudio.load())},e._audioCache={},e._musicAudio=null,e}(EventDispatcher),Sound=function(t){function e(){e.__super.call(this)}__class(e,"laya.media.Sound",t);var n=e.prototype;return n.load=function(t){},n.play=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),null},n.dispose=function(){},__getset(0,n,"duration",function(){return 0}),e}(EventDispatcher),WebAudioSound=function(t){function e(){this.url=null,this.loaded=!1,this.data=null,this.audioBuffer=null,this.__toPlays=null,e.__super.call(this)}__class(e,"laya.media.webaudio.WebAudioSound",t);var n=e.prototype;return n.load=function(t){var n=this;if(t=URL.formatURL(t),this.url=t,this.audioBuffer=e._dataCache[t],this.audioBuffer)return void this._loaded(this.audioBuffer);if(e.e.on("loaded:"+t,this,this._loaded),e.e.on("err:"+t,this,this._err),!e.__loadingSound[t]){e.__loadingSound[t]=!0;var i=new Browser.window.XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){n.data=i.response,e.buffs.push({buffer:n.data,url:n.url}),e.decode()},i.onerror=function(t){n._err()},i.send()}},n._err=function(){this._removeLoadEvents(),e.__loadingSound[this.url]=!1,this.event("error")},n._loaded=function(t){this._removeLoadEvents(),this.audioBuffer=t,e._dataCache[this.url]=this.audioBuffer,this.loaded=!0,this.event("complete")},n._removeLoadEvents=function(){e.e.off("loaded:"+this.url,this,this._loaded),e.e.off("err:"+this.url,this,this._err)},n.__playAfterLoaded=function(){if(this.__toPlays){var t,e=0,n=0;t=this.__toPlays,n=t.length;var i;for(e=0;e<n;e++)i=t[e],i[2]&&!i[2].isStopped&&this.play(i[0],i[1],i[2]);this.__toPlays.length=0}},n.play=function(t,e,n){return void 0===t&&(t=0),void 0===e&&(e=0),n=n||new WebAudioSoundChannel,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([t,e,n]),this.once("complete",this,this.__playAfterLoaded),this.load(this.url)),n.url=this.url,n.loops=e,n.audioBuffer=this.audioBuffer,n.startTime=t,n.play(),SoundManager.addChannel(n),n},n.dispose=function(){delete e._dataCache[this.url],delete e.__loadingSound[this.url]},__getset(0,n,"duration",function(){return this.audioBuffer?this.audioBuffer.duration:0}),e.decode=function(){e.buffs.length<=0||e.isDecoding||(e.isDecoding=!0,e.tInfo=e.buffs.shift(),e.ctx.decodeAudioData(e.tInfo.buffer,e._done,e._fail))},e._done=function(t){e.e.event("loaded:"+e.tInfo.url,t),e.isDecoding=!1,e.decode()},e._fail=function(){e.e.event("err:"+e.tInfo.url,null),e.isDecoding=!1,e.decode()},e._playEmptySound=function(){if(null!=e.ctx){var t=e.ctx.createBufferSource();t.buffer=e._miniBuffer,t.connect(e.ctx.destination),t.start(0,0,0)}},e._unlock=function(){e._unlocked||(e._playEmptySound(),"running"==e.ctx.state&&(Browser.document.removeEventListener("mousedown",e._unlock,!0),Browser.document.removeEventListener("touchend",e._unlock,!0),e._unlocked=!0))},e.initWebAudio=function(){"running"!=e.ctx.state&&(e._unlock(),Browser.document.addEventListener("mousedown",e._unlock,!0),Browser.document.addEventListener("touchend",e._unlock,!0))},e._dataCache={},e.buffs=[],e.isDecoding=!1,e._unlocked=!1,e.tInfo=null,e.__loadingSound={},__static(e,["window",function(){return this.window=Browser.window},"webAudioEnabled",function(){return this.webAudioEnabled=e.window.AudioContext||e.window.webkitAudioContext||e.window.mozAudioContext},"ctx",function(){return this.ctx=e.webAudioEnabled?new(e.window.AudioContext||e.window.webkitAudioContext||e.window.mozAudioContext):void 0},"_miniBuffer",function(){return this._miniBuffer=e.ctx.createBuffer(1,1,22050)},"e",function(){return this.e=new EventDispatcher}]),e}(EventDispatcher),SubMeshStaticBatch=function(t){function e(t,n,i,r,a){this._batchOwnerIndices=null,this._batchOwners=null,this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=null,this._vertexBuffer=null,this._indexBuffer=null,e.__super.call(this,t,n,i),this._batchOwnerIndices=[],this._batchOwners=[],this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=r,this._material=a}__class(e,"laya.d3.graphics.SubMeshStaticBatch",t);var n=e.prototype;return n._compareBatchRenderElement=function(t,e){return t._batchIndexStart>e._batchIndexStart},n._addCombineBatchRenderObjTest=function(t){var e=t.renderObj._vertexCount;return!((e>0?this._currentCombineVertexCount+e:this._currentCombineVertexCount+t.renderObj._getVertexBuffer().vertexCount)>65535)},n._addCombineBatchRenderObj=function(t){var e=t.renderObj,n=e._vertexCount;this._initBatchRenderElements.push(t),t._staticBatch=this,n>0?(this._currentCombineIndexCount+=e._indexCount,this._currentCombineVertexCount+=n):(this._currentCombineIndexCount=this._currentCombineIndexCount+e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+e._getVertexBuffer().vertexCount),this._needFinishCombine=!0},n._deleteCombineBatchRenderObj=function(t){var e=t.renderObj,n=this._initBatchRenderElements.indexOf(t);if(-1!==n){this._initBatchRenderElements.splice(n,1),t._staticBatch=null;var i=e._vertexCount;i>0?(this._currentCombineIndexCount=this._currentCombineIndexCount-e._indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-i):(this._currentCombineIndexCount=this._currentCombineIndexCount-e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-e._getVertexBuffer().vertexCount),this._needFinishCombine=!0}},n._finshInit=function(){if(this._needFinishCombine){var t=0,e=0;this._initBatchRenderElements[0]._sprite3D._render.lightmapIndex>=0?this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration):this._material instanceof laya.d3.core.material.StandardMaterial&&this._material.ambientTexture&&(this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration));var n=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),i=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._vertexBuffer=VertexBuffer3D.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=IndexBuffer3D.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._initBatchRenderElements.length;r<a;r++){var s=this._initBatchRenderElements[r],o=s.renderObj,l=o._getStaticBatchBakedVertexs(this._rootOwner?this._rootOwner._transform:null,s._sprite3D),h=o.getIndices(),_=s._sprite3D.transform._isFrontFaceInvert,u=t/(this._vertexDeclaration.vertexStride/4)-o._vertexStart,c=e,d=c+h.length;s._batchIndexStart=c,s._batchIndexEnd=d,i.set(h,e);var f=0;if(_)for(f=c;f<d;f+=3){i[f]=u+i[f];var m=i[f+1],p=i[f+2];i[f+1]=u+p,i[f+2]=u+m}else for(f=c;f<d;f+=3)i[f]=u+i[f],i[f+1]=u+i[f+1],i[f+2]=u+i[f+2];e+=h.length,n.set(l,t),t+=l.length}this._vertexBuffer.setData(n),this._indexBuffer.setData(i),this._needFinishCombine=!1}},n._getCombineRenderElementFromPool=function(){return this._combineRenderElementPool[this._combineRenderElementPoolIndex++]||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new SubMeshRenderElement)},n._getRenderElement=function(t,e,n){for(var i,r,a=this._batchRenderElements.length,s=!0,o=0;o<a;o++){r=this._batchRenderElements[o];var l,h=r._sprite3D._render;0!==o&&(i=this._batchRenderElements[o-1],l=i._sprite3D._render,s=l.lightmapIndex!==h.lightmapIndex||l.receiveShadow!==h.receiveShadow||i._batchIndexEnd!==r._batchIndexStart);var _;if(s){_=this._getCombineRenderElementFromPool(),_.renderObj=this,_._material=this._material,_._batchIndexStart=r._batchIndexStart,_._batchIndexEnd=r._batchIndexEnd;var u=h.lightmapIndex,c=u+1,d=this._batchOwnerIndices[c];d||(d=this._batchOwnerIndices[c]=[]);var f,m=d[r._render.receiveShadow?1:0];void 0===m?(d[h.receiveShadow?1:0]=this._batchOwners.length,f=new MeshSprite3D(null,"StaticBatchMeshSprite3D"),f._scene=e,f._transform=this._rootOwner?this._rootOwner._transform:null,f._render.lightmapIndex=u,f._render.receiveShadow=r._render.receiveShadow,this._batchOwners.push(f)):f=this._batchOwners[m],f._render._renderUpdate(n),_._sprite3D=f,t.push(_)}else _._batchIndexEnd=r._batchIndexEnd}},n._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},n._render=function(t){var e=t.renderElement,n=e._batchIndexStart,i=e._batchIndexEnd-n;WebGL.mainContext.drawElements(4,i,5123,2*n),Stat.drawCall++,Stat.trianglesFaces+=i/3},n.dispose=function(){this._batchOwnerIndices=null,this._batchOwners=null,this._vertexDeclaration=null,this._vertexBuffer.dispose(),this._indexBuffer.dispose()},n._getVertexBuffer=function(t){return void 0===t&&(t=0),this._vertexBuffer},e}(StaticBatch),MeshSprite3DStaticBatchManager=function(t){function e(){e.__super.call(this)}__class(e,"laya.d3.graphics.MeshSprite3DStaticBatchManager",t);var n=e.prototype;return n._getStaticBatch=function(t,e,n,i){var r,a;return a=t?t.id.toString()+n.id.toString()+e.id.toString()+i.toString():n.id.toString()+e.id.toString()+i.toString(),this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new SubMeshStaticBatch(a,this,t,e,n),r},n._initStaticBatchs=function(t){this._initBatchRenderElements.sort(e._sortPrepareStaticBatch);for(var n,i,r,a=!1,s=0,o=0,l=this._initBatchRenderElements.length;o<l;o++){var h=this._initBatchRenderElements[o],_=h.renderObj._getVertexBuffer(0);h._sprite3D;if(i===_.vertexDeclaration&&n===h._material){var u;if(a)r._addCombineBatchRenderObjTest(h)?(u=h._staticBatch,u&&u!==r&&u._deleteCombineBatchRenderObj(h),r._addCombineBatchRenderObj(h)):(a=!1,s++);else{var c=this._initBatchRenderElements[o-1],d=c.renderObj,f=h.renderObj;d._getVertexBuffer().vertexCount+f._getVertexBuffer().vertexCount>65535?a=!1:(r=this._getStaticBatch(t,i,n,s),u=c._staticBatch,u&&u!==r&&u._deleteCombineBatchRenderObj(c),r._addCombineBatchRenderObj(c),u=h._staticBatch,u&&u!==r&&u._deleteCombineBatchRenderObj(h),r._addCombineBatchRenderObj(h),a=!0)}}else a=!1,s=0;n=h._material,i=_.vertexDeclaration}},e._sortPrepareStaticBatch=function(t,e){var n=t._render,i=e._render,r=n.lightmapIndex-i.lightmapIndex;if(0===r){var a=n.receiveShadow-i.receiveShadow;if(0===a){var s=t._mainSortID-e._mainSortID;return 0===s?t.renderObj.triangleCount-e.renderObj.triangleCount:s}return a}return r},e}(StaticBatchManager),CSSStyle=function(t){function e(t){this._bgground=null,this._border=null,this._rect=null,this.underLine=0,this.lineHeight=0,e.__super.call(this),this._padding=e._PADDING,this._spacing=e._SPACING,this._aligns=e._ALIGNS,this._font=Font.EMPTY,this._ower=t}__class(e,"laya.display.css.CSSStyle",t);var n=e.prototype;return n.destroy=function(){this._ower=null,this._font=null,this._rect=null},n.inherit=function(t){this._font=t._font,this._spacing=t._spacing===e._SPACING?e._SPACING:t._spacing.slice(),this.lineHeight=t.lineHeight},n._widthAuto=function(){return 0!=(262144&this._type)},n.widthed=function(t){return 0!=(8&this._type)},n._calculation=function(t,e){function n(t,e,n){return t*n[0]+e*n[1]+n[2]}function i(t){var e=a.width,i=r.width;s.width&&(r.width=n(e,i,s.width)),s.height&&(r.height=n(e,i,s.height)),s.left&&(r.x=n(e,i,s.left)),s.top&&(r.y=n(e,i,s.top))}if(e.indexOf("%")<0)return!1;var r=this._ower,a=r.parent,s=this._rect;null===s&&(a._getCSSStyle()._type|=524288,a.on("resize",this,i),this._rect=s={input:{}});var o=e.split(" ");return o[0]=parseFloat(o[0])/100,1==o.length?o[1]=o[2]=0:(o[1]=parseFloat(o[1])/100,o[2]=parseFloat(o[2])),s[t]=o,s.input[t]=e,i(t),!0},n.heighted=function(t){return 0!=(8192&this._type)},n.size=function(t,e){var n=this._ower,i=!1;-1!==t&&t!=this._ower.width&&(this._type|=8,this._ower.width=t,i=!0),-1!==e&&e!=this._ower.height&&(this._type|=8192,this._ower.height=e,i=!0),i&&(n._layoutLater(),524288&this._type&&n.event("resize",this))},n._getAlign=function(){return this._aligns[0]},n._getValign=function(){return this._aligns[1]},n._getCssFloat=function(){return 0!=(32768&this._type)?32768:0},n._createFont=function(){return 4096&this._type?this._font:(this._type|=4096,this._font=new Font(this._font))},n.render=function(t,e,n,i){var r=t.width,a=t.height;n-=t.pivotX,i-=t.pivotY,this._bgground&&null!=this._bgground.color&&e.ctx.fillRect(n,i,r,a,this._bgground.color),this._border&&this._border.color&&e.drawRect(n,i,r,a,this._border.color.strColor,this._border.size)},n.getCSSStyle=function(){return this},n.cssText=function(t){this.attrs(e.parseOneCSS(t,";"))},n.attrs=function(t){if(t)for(var e=0,n=t.length;e<n;e++){var i=t[e];this[i[0]]=i[1]}},n.setTransform=function(t){"none"===t?this._tf=Style._TF_EMPTY:this.attrs(e.parseOneCSS(t,","))},n.translate=function(t,e){this._tf===Style._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.translateX=t,this._tf.translateY=e},n.scale=function(t,e){this._tf===Style._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleX=t,this._tf.scaleY=e},n._enableLayout=function(){return 0==(2&this._type)&&0==(4&this._type)},__getset(0,n,"_rotate",null,function(t){this._ower.rotation=t}),__getset(0,n,"_translate",null,function(t){this.translate(t[0],t[1])}),__getset(0,n,"display",null,function(t){switch(t){case"":this._type&=-3,this.visible=!0;break;case"none":this._type|=2,this.visible=!1,this._ower._layoutLater()}}),__getset(0,n,"paddingLeft",function(){return this.padding[3]}),__getset(0,n,"background",null,function(t){if(!t)return void(this._bgground=null);this._bgground||(this._bgground={}),this._bgground.color=t,this._ower.conchModel&&this._ower.conchModel.bgColor(t),this._type|=16384,this._ower._renderType|=256}),__getset(0,n,"border",function(){return this._border?this._border.value:""},function(t){if("none"==t)return void(this._border=null);this._border||(this._border={}),this._border.value=t;var e=t.split(" ");if(this._border.color=Color.create(e[e.length-1]),1==e.length)return this._border.size=1,void(this._border.type="solid");var n=0;e[0].indexOf("px")>0?(this._border.size=parseInt(e[0]),n++):this._border.size=1,this._border.type=e[n],this._ower._renderType|=256}),__getset(0,n,"absolute",function(){
return 0!=(4&this._type)}),__getset(0,n,"strokeColor",function(){return this._font.stroke[1]},function(t){this._createFont().stroke===Font._STROKE&&(this._font.stroke=[0,"#000000"]),this._font.stroke[1]=t}),__getset(0,n,"stroke",function(){return this._font.stroke[0]},function(t){this._createFont().stroke===Font._STROKE&&(this._font.stroke=[0,"#000000"]),this._font.stroke[0]=t}),__getset(0,n,"color",function(){return this._font.color},function(t){this._createFont().color=t}),__getset(0,n,"textDecoration",function(){return this._font.decoration},function(t){this._createFont().decoration=t}),__getset(0,n,"fontWeight",function(){return this._font.weight},function(t){this._createFont().weight=t}),__getset(0,n,"weight",null,function(t){this._createFont().weight=t}),__getset(0,n,"fontFamily",function(){return this._font.family},function(t){this._createFont().family=t}),__getset(0,n,"borderColor",function(){return this._border&&this._border.color?this._border.color.strColor:null},function(t){if(!t)return void(this._border=null);this._border||(this._border={size:1,type:"solid"}),this._border.color=null==t?null:Color.create(t),this._ower.conchModel&&this._ower.conchModel.border(this._border.color.strColor),this._ower._renderType|=256}),__getset(0,n,"valign",function(){return e._valigndef[this._aligns[1]]},function(t){this._aligns===e._ALIGNS&&(this._aligns=[0,0,0]),this._aligns[1]=e._valigndef[t]}),__getset(0,n,"whiteSpace",function(){return 131072&this._type?"nowrap":""},function(t){"nowrap"===t&&(this._type|=131072),"none"===t&&(this._type&=-131073)}),__getset(0,n,"letterSpacing",function(){return this._spacing[0]},function(t){"string"==typeof t&&(t=parseInt(t+"")),this._spacing===e._SPACING&&(this._spacing=[0,0]),this._spacing[0]=t}),__getset(0,n,"backgroundColor",function(){return this._bgground?this._bgground.color:null},function(t){"none"===t?this._bgground=null:(this._bgground||(this._bgground={}),this._bgground.color=t),this._ower.conchModel&&this._ower.conchModel.bgColor(t),this._ower._renderType|=256}),__getset(0,n,"leading",function(){return this._spacing[1]},function(t){"string"==typeof t&&(t=parseInt(t+"")),this._spacing===e._SPACING&&(this._spacing=[0,0]),this._spacing[1]=t}),__getset(0,n,"font",function(){return this._font.toString()},function(t){this._createFont().set(t)}),__getset(0,n,"password",function(){return this._font.password},function(t){this._createFont().password=t}),__getset(0,n,"padding",function(){return this._padding},function(t){this._padding=t}),__getset(0,n,"bold",function(){return this._font.bold},function(t){this._createFont().bold=t}),__getset(0,n,"paddingTop",function(){return this.padding[0]}),__getset(0,n,"height",null,function(t){if(this._type|=8192,"string"==typeof t){if(this._calculation("height",t))return;t=parseInt(t)}this.size(-1,t)}),__getset(0,n,"wordWrap",function(){return 0==(131072&this._type)},function(t){t?this._type&=-131073:this._type|=131072}),__getset(0,n,"lineElement",function(){return 0!=(65536&this._type)},function(t){t?this._type|=65536:this._type&=-65537}),__getset(0,n,"italic",function(){return this._font.italic},function(t){this._createFont().italic=t}),__getset(0,n,"_scale",null,function(t){this._ower.scale(t[0],t[1])}),__getset(0,n,"top",null,function(t){var e=this._ower;if("string"==typeof t){if("middle"===t?t="50% -50% 0":"bottom"===t&&(t="100% -100% 0"),this._calculation("top",t))return;t=parseInt(t)}e.y=t}),__getset(0,n,"left",null,function(t){var e=this._ower;if("string"==typeof t){if("center"===t?t="50% -50% 0":"right"===t&&(t="100% -100% 0"),this._calculation("left",t))return;t=parseInt(t)}e.x=t}),__getset(0,n,"block",t.prototype._$get_block,function(t){t?this._type|=1:this._type&=-2}),__getset(0,n,"position",function(){return 4&this._type?"absolute":""},function(t){"absolute"==t?this._type|=4:this._type&=-5}),__getset(0,n,"cssFloat",function(){return 0!=(32768&this._type)?"right":"left"},function(t){this.lineElement=!1,"right"===t?this._type|=32768:this._type&=-32769}),__getset(0,n,"fontSize",function(){return this._font.size},function(t){this._createFont().size=t}),__getset(0,n,"align",function(){return e._aligndef[this._aligns[0]]},function(t){this._aligns===e._ALIGNS&&(this._aligns=[0,0,0]),this._aligns[0]=e._aligndef[t]}),__getset(0,n,"width",null,function(t){if(this._type|=8,"string"==typeof t){var e=t.indexOf("auto");if(e>=0&&(this._type|=262144,t=t.substr(0,e)),this._calculation("width",t))return;t=parseInt(t)}this.size(t,-1)}),e.parseOneCSS=function(t,n){for(var i,r=[],a=t.split(n),s=0,o=a.length;s<o;s++){var l=a[s],h=l.indexOf(":"),_=l.substr(0,h).replace(/^\s+|\s+$/g,"");if(0!=_.length){var u=l.substr(h+1).replace(/^\s+|\s+$/g,""),c=[_,u];switch(_){case"italic":case"bold":c[1]="true"==u;break;case"line-height":c[0]="lineHeight",c[1]=parseInt(u);break;case"font-size":c[0]="fontSize",c[1]=parseInt(u);break;case"padding":i=u.split(" "),i.length>1||(i[1]=i[2]=i[3]=i[0]),c[1]=[parseInt(i[0]),parseInt(i[1]),parseInt(i[2]),parseInt(i[3])];break;case"rotate":c[0]="_rotate",c[1]=parseFloat(u);break;case"scale":i=u.split(" "),c[0]="_scale",c[1]=[parseFloat(i[0]),parseFloat(i[1])];break;case"translate":i=u.split(" "),c[0]="_translate",c[1]=[parseInt(i[0]),parseInt(i[1])];break;default:(c[0]=e._CSSTOVALUE[_])||(c[0]=_)}r.push(c)}}return r},e.parseCSS=function(t,n){for(var i;null!=(i=e._parseCSSRegExp.exec(t));)e.styleSheets[i[1]]=e.parseOneCSS(i[2],";")},e.EMPTY=new e(null),e._CSSTOVALUE={"letter-spacing":"letterSpacing","line-spacing":"lineSpacing","white-space":"whiteSpace","line-height":"lineHeight","scale-x":"scaleX","scale-y":"scaleY","translate-x":"translateX","translate-y":"translateY","font-family":"fontFamily","font-weight":"fontWeight","vertical-align":"valign","text-decoration":"textDecoration","background-color":"backgroundColor","border-color":"borderColor",float:"cssFloat"},e._parseCSSRegExp=new RegExp("([.#]\\w+)\\s*{([\\s\\S]*?)}","g"),e._aligndef={left:0,center:1,right:2,0:"left",1:"center",2:"right"},e._valigndef={top:0,middle:1,bottom:2,0:"top",1:"middle",2:"bottom"},e.styleSheets={},e.ALIGN_CENTER=1,e.ALIGN_RIGHT=2,e.VALIGN_MIDDLE=1,e.VALIGN_BOTTOM=2,e._CSS_BLOCK=1,e._DISPLAY_NONE=2,e._ABSOLUTE=4,e._WIDTH_SET=8,e._PADDING=[0,0,0,0],e._RECT=[-1,-1,-1,-1],e._SPACING=[0,0],e._ALIGNS=[0,0,0],e.ADDLAYOUTED=512,e._NEWFONT=4096,e._HEIGHT_SET=8192,e._BACKGROUND_SET=16384,e._FLOAT_RIGHT=32768,e._LINE_ELEMENT=65536,e._NOWARP=131072,e._WIDTHAUTO=262144,e._LISTERRESZIE=524288,e}(Style),Sprite=function(t){function e(){this._transform=null,this._tfChanged=!1,this._x=0,this._y=0,this._width=0,this._height=0,this._repaint=1,this._mouseEnableState=0,this._zOrder=0,this._graphics=null,this._renderType=0,this._optimizeScrollRect=!1,this._texture=null,this.mouseThrough=!1,this.autoSize=!1,this.hitTestPrior=!1,this.viewport=null,e.__super.call(this),this._style=Style.EMPTY}__class(e,"laya.display.Sprite",t);var n=e.prototype;return Laya.imps(n,{"laya.display.ILayout":!0}),n.createConchModel=function(){return new ConchNode},n.destroy=function(e){void 0===e&&(e=!0),this._releaseMem(),t.prototype.destroy.call(this,e),this._style&&this._style.destroy(),this._transform&&this._transform.destroy(),this._transform=null,this._style=null,this._graphics=null},n.updateZOrder=function(){Utils.updateOrder(this._childs)&&this.repaint()},n.reCache=function(){this._$P.cacheCanvas&&(this._$P.cacheCanvas.reCache=!0),this._repaint=1},n.setBounds=function(t){this._set$P("uBounds",t)},n.getBounds=function(){return this._$P.mBounds||this._set$P("mBounds",new Rectangle),Rectangle._getWrapRec(this._boundPointsToParent(),this._$P.mBounds)},n.getSelfBounds=function(){return this._$P.uBounds?this._$P.uBounds:(this._$P.mBounds||this._set$P("mBounds",new Rectangle),Rectangle._getWrapRec(this._getBoundPointsM(!1),this._$P.mBounds))},n._boundPointsToParent=function(t){void 0===t&&(t=!1);var e=0,n=0;this._style&&(e=this._style._tf.translateX,n=this._style._tf.translateY,t=t||0!==this._style._tf.rotate,this._style.scrollRect&&(e+=this._style.scrollRect.x,n+=this._style.scrollRect.y));var i=this._getBoundPointsM(t);if(!i||i.length<1)return i;if(8!=i.length&&(i=t?GrahamScan.scanPList(i):Rectangle._getWrapRec(i,Rectangle.TEMP)._getBoundPoints()),!this.transform)return Utils.transPointList(i,this._x-e,this._y-n),i;var r=Point.TEMP,a=0,s=i.length;for(a=0;a<s;a+=2)r.x=i[a],r.y=i[a+1],this.toParentPoint(r),i[a]=r.x,i[a+1]=r.y;return i},n.getGraphicBounds=function(t){return void 0===t&&(t=!1),this._graphics?this._graphics.getBounds(t):Rectangle.TEMP.setTo(0,0,0,0)},n._getBoundPointsM=function(t){if(void 0===t&&(t=!1),this._$P.uBounds)return this._$P.uBounds._getBoundPoints();if(this._$P.temBM||this._set$P("temBM",[]),this.scrollRect){var e=Utils.clearArray(this._$P.temBM),n=Rectangle.TEMP;return n.copyFrom(this.scrollRect),Utils.concatArray(e,n._getBoundPoints()),e}var i,r,a,s=this._graphics?this._graphics.getBoundPoints():Utils.clearArray(this._$P.temBM);a=this._childs;for(var o=0,l=a.length;o<l;o++)(i=a[o])instanceof laya.display.Sprite&&1==i.visible&&(r=i._boundPointsToParent(t))&&(s=s?Utils.concatArray(s,r):r);return s},n.getStyle=function(){return this._style===Style.EMPTY&&(this._style=new Style),this._style},n.setStyle=function(t){this._style=t},n._adjustTransform=function(){"use strict";this._tfChanged=!1;var t,e=this._style,n=e._tf,i=n.scaleX,r=n.scaleY;if(n.rotate||1!==i||1!==r||n.skewX||n.skewY){t=this._transform||(this._transform=Matrix.create()),t.bTransform=!0;var a=.0174532922222222*(n.rotate-n.skewX),s=.0174532922222222*(n.rotate+n.skewY),o=Math.cos(s),l=Math.sin(s),h=Math.sin(a),_=Math.cos(a);return t.a=i*o,t.b=i*l,t.c=-r*h,t.d=r*_,t.tx=t.ty=0,t}return this._transform&&this._transform.destroy(),this._transform=null,this._renderType&=-5,t},n.pos=function(t,e,n){if(void 0===n&&(n=!1),this._x!==t||this._y!==e){if(this.destroyed)return this;if(n){this._x=t,this._y=e,this.conchModel&&this.conchModel.pos(this._x,this._y);var i=this._parent;i&&0===i._repaint&&(i._repaint=1,i.parentRepaint()),this._$P.maskParent&&0===this._$P.maskParent._repaint&&(this._$P.maskParent._repaint=1,this._$P.maskParent.parentRepaint())}else this.x=t,this.y=e}return this},n.pivot=function(t,e){return this.pivotX=t,this.pivotY=e,this},n.size=function(t,e){return this.width=t,this.height=e,this},n.scale=function(t,e,n){void 0===n&&(n=!1);var i=this.getStyle(),r=i._tf;if(r.scaleX!=t||r.scaleY!=e){if(this.destroyed)return this;if(n){i.setScale(t,e),this._tfChanged=!0,this.conchModel&&this.conchModel.scale(t,e),this._renderType|=4;var a=this._parent;a&&0===a._repaint&&(a._repaint=1,a.parentRepaint())}else this.scaleX=t,this.scaleY=e}return this},n.skew=function(t,e){return this.skewX=t,this.skewY=e,this},n.render=function(t,e,n){Stat.spriteCount++,RenderSprite.renders[this._renderType]._fun(this,t,e+this._x,n+this._y),this._repaint=0},n.drawToCanvas=function(t,e,n,i){if(Render.isConchNode){var r=HTMLCanvas.create("2D");return new RenderContext(t,e,r).ctx.setCanvasType(1),this.conchModel.drawToCanvas(r.source,n,i),r}return RunDriver.drawToCanvas(this,this._renderType,t,e,n,i)},n.customRender=function(t,e,n){this._renderType|=1024},n._applyFilters=function(){if(!Render.isWebGL){var t;if((t=this._$P.filters)&&!(t.length<1))for(var e=0,n=t.length;e<n;e++)t[e].action.apply(this._$P.cacheCanvas)}},n._isHaveGlowFilter=function(){var t=0,e=0;if(this.filters)for(t=0;t<this.filters.length;t++)if(8==this.filters[t].type)return!0;for(t=0,e=this._childs.length;t<e;t++)if(this._childs[t]._isHaveGlowFilter())return!0;return!1},n.localToGlobal=function(t,e){void 0===e&&(e=!1),!0===e&&(t=new Point(t.x,t.y));for(var n=this;n&&n!=Laya.stage;)t=n.toParentPoint(t),n=n.parent;return t},n.globalToLocal=function(t,e){void 0===e&&(e=!1),e&&(t=new Point(t.x,t.y));for(var n=this,i=[];n&&n!=Laya.stage;)i.push(n),n=n.parent;for(var r=i.length-1;r>=0;)n=i[r],t=n.fromParentPoint(t),r--;return t},n.toParentPoint=function(t){if(!t)return t;t.x-=this.pivotX,t.y-=this.pivotY,this.transform&&this._transform.transformPoint(t),t.x+=this._x,t.y+=this._y;var e=this._style.scrollRect;return e&&(t.x-=e.x,t.y-=e.y),t},n.fromParentPoint=function(t){if(!t)return t;t.x-=this._x,t.y-=this._y;var e=this._style.scrollRect;return e&&(t.x+=e.x,t.y+=e.y),this.transform&&this._transform.invertTransformPoint(t),t.x+=this.pivotX,t.y+=this.pivotY,t},n.on=function(e,n,i,r){return 1!==this._mouseEnableState&&this.isMouseEvent(e)?(this.mouseEnabled=!0,this._setBit(2,!0),this._parent&&this._$2__onDisplay(),this._createListener(e,n,i,r,!1)):t.prototype.on.call(this,e,n,i,r)},n.once=function(e,n,i,r){return 1!==this._mouseEnableState&&this.isMouseEvent(e)?(this.mouseEnabled=!0,this._setBit(2,!0),this._parent&&this._$2__onDisplay(),this._createListener(e,n,i,r,!0)):t.prototype.once.call(this,e,n,i,r)},n._$2__onDisplay=function(){if(1!==this._mouseEnableState){var t=this;for(t=t.parent;t&&1!==t._mouseEnableState&&!t._getBit(2);)t.mouseEnabled=!0,t._setBit(2,!0),t=t.parent}},n.loadImage=function(t,e,n,i,r,a){function s(t){o.destroyed||(o.size(e+(i||t.width),n+(r||t.height)),o.repaint(),a&&a.runWith(t))}var o=this;return void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),this.graphics.loadImage(t,e,n,i,r,s),this},n.repaint=function(){this.conchModel&&this.conchModel.repaint&&this.conchModel.repaint(),0===this._repaint&&(this._repaint=1,this.parentRepaint()),this._$P&&this._$P.maskParent&&this._$P.maskParent.repaint()},n._needRepaint=function(){return 0!==this._repaint&&this._$P.cacheCanvas&&this._$P.cacheCanvas.reCache},n._childChanged=function(t){this._childs.length?this._renderType|=2048:this._renderType&=-2049,t&&this._get$P("hasZorder")&&Laya.timer.callLater(this,this.updateZOrder),this.repaint()},n.parentRepaint=function(){var t=this._parent;t&&0===t._repaint&&(t._repaint=1,t.parentRepaint())},n.startDrag=function(t,e,n,i,r,a,s){void 0===e&&(e=!1),void 0===n&&(n=0),void 0===i&&(i=300),void 0===a&&(a=!1),void 0===s&&(s=.92),this._$P.dragging||this._set$P("dragging",new Dragging),this._$P.dragging.start(this,t,e,n,i,r,a,s)},n.stopDrag=function(){this._$P.dragging&&this._$P.dragging.stop()},n._releaseMem=function(){if(this._$P){var t=this._$P.cacheCanvas;t&&t.ctx&&(Pool.recover("RenderContext",t.ctx),t.ctx.canvas.size(0,0),t.ctx=null);var e=this._$P._filterCache;e&&(e.destroy(),e.recycle(),this._set$P("_filterCache",null)),this._$P._isHaveGlowFilter&&this._set$P("_isHaveGlowFilter",!1),this._$P._isHaveGlowFilter=null}},n._setDisplay=function(e){e||this._releaseMem(),t.prototype._setDisplay.call(this,e)},n.hitTestPoint=function(t,e){var n=this.globalToLocal(Point.TEMP.setTo(t,e));return(this._$P.hitArea?this._$P.hitArea:this._width>0&&this._height>0?Rectangle.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(n.x,n.y)},n.getMousePoint=function(){return this.globalToLocal(Point.TEMP.setTo(Laya.stage.mouseX,Laya.stage.mouseY))},n._getWords=function(){return null},n._addChildsToLayout=function(t){var e=this._getWords();if(null==e&&0==this._childs.length)return!1;if(e)for(var n=0,i=e.length;n<i;n++)t.push(e[n]);return this._childs.forEach(function(e,n,i){e._style._enableLayout()&&e._addToLayout(t)}),!0},n._addToLayout=function(t){this._style.absolute||(this._style.block?t.push(this):this._addChildsToLayout(t)&&(this.x=this.y=0))},n._isChar=function(){return!1},n._getCSSStyle=function(){return this._style.getCSSStyle()},n._setAttributes=function(t,e){switch(t){case"x":this.x=parseFloat(e);break;case"y":this.y=parseFloat(e);break;case"width":this.width=parseFloat(e);break;case"height":this.height=parseFloat(e);break;default:this[t]=e}},n._layoutLater=function(){this.parent&&this.parent._layoutLater()},__getset(0,n,"texture",function(){return this._texture},function(t){this._texture!=t&&(this._texture=t,this.graphics.cleanByTexture(t,0,0))}),__getset(0,n,"mouseY",function(){return this.getMousePoint().y}),__getset(0,n,"globalScaleX",function(){for(var t=1,e=this;e&&e!==Laya.stage;)t*=e.scaleX,e=e.parent;return t}),__getset(0,n,"mouseEnabled",function(){return this._mouseEnableState>1},function(t){this._mouseEnableState=t?2:1}),__getset(0,n,"mask",function(){return this._$P._mask},function(t){t&&this.mask&&this.mask._$P.maskParent||(t?(this.cacheAs="bitmap",this._set$P("_mask",t),t._set$P("maskParent",this)):(this.cacheAs="none",this.mask&&this.mask._set$P("maskParent",null),this._set$P("_mask",t)),this.conchModel&&this.conchModel.mask(t?t.conchModel:null),this._renderType|=64,this.parentRepaint())}),__getset(0,n,"hitArea",function(){return this._$P.hitArea},function(t){this._set$P("hitArea",t)}),__getset(0,n,"graphics",function(){return this._graphics||(this.graphics=RunDriver.createGraphics())},function(t){this._graphics&&(this._graphics._sp=null),this._graphics=t,t?(this._renderType&=-2,this._renderType|=512,t._sp=this,this.conchModel&&this.conchModel.graphics(this._graphics)):(this._renderType&=-513,this._renderType&=-2,this.conchModel&&(e.RUNTIMEVERION<"0.9.1"?this.conchModel.removeType(256):this.conchModel.removeType(512))),this.repaint()}),__getset(0,n,"filters",function(){return this._$P.filters},function(t){t&&0===t.length&&(t=null),this._$P.filters!=t&&(this._set$P("filters",t?t.slice():null),Render.isConchApp&&(this.conchModel&&(e.RUNTIMEVERION<"0.9.1"?this.conchModel.removeType(16):this.conchModel.removeType(32)),this._$P.filters&&1==this._$P.filters.length&&this._$P.filters[0].callNative(this)),Render.isWebGL&&(t&&t.length?this._renderType|=32:this._renderType&=-33),t&&t.length>0?(this._getBit(1)||this._setUpNoticeType(1),Render.isWebGL&&1==t.length&&t[0]instanceof laya.filters.ColorFilter||("bitmap"!=this.cacheAs&&(Render.isConchNode||(this.cacheAs="bitmap"),this._set$P("cacheForFilters",!0)),this._set$P("hasFilter",!0))):(this._set$P("hasFilter",!1),this._$P.cacheForFilters&&"bitmap"==this.cacheAs&&(this.cacheAs="none")),this.repaint())}),__getset(0,n,"globalScaleY",function(){for(var t=1,e=this;e&&e!==Laya.stage;)t*=e.scaleY,e=e.parent;return t}),__getset(0,n,"alpha",function(){return this._style.alpha},function(t){this._style&&this._style.alpha!==t&&(t=t<0?0:t>1?1:t,this.getStyle().alpha=t,this.conchModel&&this.conchModel.alpha(t),1!==t?this._renderType|=2:this._renderType&=-3,this.parentRepaint())}),__getset(0,n,"scaleX",function(){return this._style._tf.scaleX},function(t){var e=this.getStyle();if(e._tf.scaleX!==t){e.setScaleX(t),this._tfChanged=!0,this.conchModel&&this.conchModel.scale(t,e._tf.scaleY),this._renderType|=4;var n=this._parent;n&&0===n._repaint&&(n._repaint=1,n.parentRepaint())}}),__getset(0,n,"skewY",function(){return this._style._tf.skewY},function(t){var e=this.getStyle();if(e._tf.skewY!==t){e.setSkewY(t),this._tfChanged=!0,this.conchModel&&this.conchModel.skew(e._tf.skewX,t),this._renderType|=4;var n=this._parent;n&&0===n._repaint&&(n._repaint=1,n.parentRepaint())}}),__getset(0,n,"visible",function(){return this._style.visible},function(t){this._style&&this._style.visible!==t&&(this.getStyle().visible=t,this.conchModel&&this.conchModel.visible(t),this.parentRepaint())}),__getset(0,n,"pivotY",function(){return this._style._tf.translateY},function(t){this.getStyle().setTranslateY(t),this.conchModel&&this.conchModel.pivot(this._style._tf.translateX,t),this.repaint()}),__getset(0,n,"y",function(){return this._y},function(t){if(this._y!==t){if(this.destroyed)return;this._y=t,this.conchModel&&this.conchModel.pos(this._x,t);var e=this._parent;e&&0===e._repaint&&(e._repaint=1,e.parentRepaint()),this._$P.maskParent&&0===this._$P.maskParent._repaint&&(this._$P.maskParent._repaint=1,this._$P.maskParent.parentRepaint())}}),__getset(0,n,"pivotX",function(){return this._style._tf.translateX},function(t){this.getStyle().setTranslateX(t),this.conchModel&&this.conchModel.pivot(t,this._style._tf.translateY),this.repaint()}),__getset(0,n,"skewX",function(){return this._style._tf.skewX},function(t){var e=this.getStyle();if(e._tf.skewX!==t){e.setSkewX(t),this._tfChanged=!0,this.conchModel&&this.conchModel.skew(t,e._tf.skewY),this._renderType|=4;var n=this._parent;n&&0===n._repaint&&(n._repaint=1,n.parentRepaint())}}),__getset(0,n,"scrollRect",function(){return this._style.scrollRect},function(t){this.getStyle().scrollRect=t,this.repaint(),t?(this._renderType|=128,this.conchModel&&this.conchModel.scrollRect(t.x,t.y,t.width,t.height)):(this._renderType&=-129,this.conchModel&&(e.RUNTIMEVERION<"0.9.1"?this.conchModel.removeType(64):this.conchModel.removeType(128)))}),__getset(0,n,"rotation",function(){return this._style._tf.rotate},function(t){var e=this.getStyle();if(e._tf.rotate!==t){e.setRotate(t),this._tfChanged=!0,this.conchModel&&this.conchModel.rotate(t),this._renderType|=4;var n=this._parent;n&&0===n._repaint&&(n._repaint=1,n.parentRepaint())}}),__getset(0,n,"transform",function(){return this._tfChanged?this._adjustTransform():this._transform},function(t){this._tfChanged=!1,this._transform=t,t&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0,this.conchModel&&this.conchModel.transform(t.a,t.b,t.c,t.d,this._x,this._y)),t?this._renderType|=4:(this._renderType&=-5,this.conchModel&&this.conchModel.removeType(4)),this.parentRepaint()}),__getset(0,n,"scaleY",function(){return this._style._tf.scaleY},function(t){var e=this.getStyle();if(e._tf.scaleY!==t){e.setScaleY(t),this._tfChanged=!0,this.conchModel&&this.conchModel.scale(e._tf.scaleX,t),this._renderType|=4;var n=this._parent;n&&0===n._repaint&&(n._repaint=1,n.parentRepaint())}}),__getset(0,n,"mouseX",function(){return this.getMousePoint().x}),__getset(0,n,"width",function(){return this.autoSize?this.getSelfBounds().width:this._width},function(t){this._width!==t&&(this._width=t,this.conchModel&&this.conchModel.size(t,this._height),this.repaint())}),__getset(0,n,"cacheAs",function(){return null==this._$P.cacheCanvas?"none":this._$P.cacheCanvas.type},function(t){var e=this._$P.cacheCanvas;if(t!==(e?e.type:"none")){if("none"!==t)this._getBit(1)||this._setUpNoticeType(1),e||(e=this._set$P("cacheCanvas",Pool.getItemByClass("cacheCanvas",Object))),e.type=t,e.reCache=!0,this._renderType|=16,"bitmap"==t&&this.conchModel&&this.conchModel.cacheAs(1),this._set$P("cacheForFilters",!1);else if(this._$P.hasFilter)this._set$P("cacheForFilters",!0);else{if(e){var n=e;n&&n.ctx&&(Pool.recover("RenderContext",n.ctx),n.ctx.canvas.size(0,0),n.ctx=null),Pool.recover("cacheCanvas",e)}this._$P.cacheCanvas=null,this._renderType&=-17,this.conchModel&&this.conchModel.cacheAs(0)}this.repaint()}}),__getset(0,n,"staticCache",function(){return this._$P.staticCache},function(t){this._set$P("staticCache",t),t||this.reCache()}),__getset(0,n,"zOrder",function(){return this._zOrder},function(t){this._zOrder!=t&&(this._zOrder=t,this.conchModel&&this.conchModel.setZOrder&&this.conchModel.setZOrder(t),this._parent&&(t&&this._parent._set$P("hasZorder",!0),Laya.timer.callLater(this._parent,this.updateZOrder)))}),__getset(0,n,"stage",function(){return Laya.stage}),__getset(0,n,"parent",t.prototype._$get_parent,function(e){t.prototype._$set_parent.call(this,e),e&&this._getBit(2)&&this._$2__onDisplay()}),__getset(0,n,"customRenderEnable",null,function(t){if(t&&(this._renderType|=1024,Render.isConchNode)){e.CustomList.push(this);var n=new HTMLCanvas("2d");n._setContext(new CanvasRenderingContext2D),this.customContext=new RenderContext(0,0,n),n.context.setCanvasType&&n.context.setCanvasType(2),this.conchModel.custom(n.context)}}),__getset(0,n,"height",function(){return this.autoSize?this.getSelfBounds().height:this._height},function(t){this._height!==t&&(this._height=t,this.conchModel&&this.conchModel.size(this._width,t),this.repaint())}),__getset(0,n,"cacheAsBitmap",function(){return"none"!==this.cacheAs},function(t){this.cacheAs=t?this._$P.hasFilter?"none":"normal":"none"}),__getset(0,n,"x",function(){return this._x},function(t){if(this._x!==t){if(this.destroyed)return;this._x=t,this.conchModel&&this.conchModel.pos(t,this._y);var e=this._parent;e&&0===e._repaint&&(e._repaint=1,e.parentRepaint()),this._$P.maskParent&&0===this._$P.maskParent._repaint&&(this._$P.maskParent._repaint=1,this._$P.maskParent.parentRepaint())}}),__getset(0,n,"blendMode",function(){return this._style.blendMode},function(t){this.getStyle().blendMode=t,this.conchModel&&this.conchModel.blendMode(t),t&&"source-over"!=t?this._renderType|=8:this._renderType&=-9,this.parentRepaint()}),__getset(0,n,"optimizeScrollRect",function(){return this._optimizeScrollRect},function(t){this._optimizeScrollRect!=t&&(this._optimizeScrollRect=t,this.conchModel&&this.conchModel.optimizeScrollRect(t))}),e.fromImage=function(t){return(new e).loadImage(t)},e.CustomList=[],__static(e,["RUNTIMEVERION",function(){return this.RUNTIMEVERION=window.conch?conchConfig.getRuntimeVersion().substr(conchConfig.getRuntimeVersion().lastIndexOf("-")+1):""}]),e}(Node),AnimationTemplet=function(t){function e(){this._aniMap={},this.unfixedLastAniIndex=-1,e.__super.call(this),this._anis=new Array}__class(e,"laya.ani.AnimationTemplet",t);var n=e.prototype;return n.parse=function(t){var e=new Byte(t);this._aniVersion=e.readUTFString(),AnimationParser01.parse(this,e)},n._calculateKeyFrame=function(t,e,n){var i=t.keyFrame;i[e]=i[0];for(var r=0;r<e;r++){var a=i[r];a.nextData=0===a.duration?a.data:i[r+1].data}i.length--},n.onAsynLoaded=function(t,e,n){var i=new Byte(e);switch(this._aniVersion=i.readUTFString(),this._aniVersion){case"LAYAANIMATION:02":AnimationParser02.parse(this,i);break;default:AnimationParser01.parse(this,i)}this._endLoaded()},n.detoryResource=function(){this._aniVersion=null,this._anis=null,this._aniMap=null,this._publicExtData=null,this.unfixedCurrentFrameIndexes=null,this.unfixedCurrentTimes=null,this.unfixedKeyframes=null,this._aniClassName=null,this._animationDatasCache=null},n.getAnimationCount=function(){return this._anis.length},n.getAnimation=function(t){return this._anis[t]},n.getAniDuration=function(t){return this._anis[t].playTime},n.getNodes=function(t){return this._anis[t].nodes},n.getNodeIndexWithName=function(t,e){return this._anis[t].bone3DMap[e]},n.getNodeCount=function(t){return this._anis[t].nodes.length},n.getTotalkeyframesLength=function(t){return this._anis[t].totalKeyframeDatasLength},n.getPublicExtData=function(){return this._publicExtData},n.getAnimationDataWithCache=function(t,e,n,i){var r=e[n];if(r){var a=r[t];return a?a[i]:null}return null},n.setAnimationDataWithCache=function(t,e,n,i,r){var a=e[n]||(e[n]={});(a[t]||(a[t]=[]))[i]=r},n.getOriginalData=function(t,n,i,r,a){for(var s=this._anis[t],o=s.nodes,l=0,h=0,_=o.length,u=0;h<_;h++){var c,d=o[h];c=d.keyFrame[i[h][r]],d.dataOffset=u;var f=a-c.startTime,m=d.lerpType;if(m)switch(m){case 0:case 1:for(l=0;l<d.keyframeWidth;)l+=d.interpolationMethod[l](d,l,n,u+l,c.data,f,null,c.duration,c.nextData);break;case 2:var p=c.interpolationData,g=p.length,v=0;for(l=0;l<g;){var x=p[l];switch(x){case 6:case 7:l+=e.interpolation[x](d,v,n,u+v,c.data,f,null,c.duration,c.nextData,p,l+1);break;default:l+=e.interpolation[x](d,v,n,u+v,c.data,f,null,c.duration,c.nextData)}v++}}else for(l=0;l<d.keyframeWidth;)l+=d.interpolationMethod[l](d,l,n,u+l,c.data,f,null,c.duration,c.nextData);u+=d.keyframeWidth}},n.getNodesCurrentFrameIndex=function(t,e){var n=this._anis[t],i=n.nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(i.length),this.unfixedCurrentTimes=new Float32Array(i.length),this.unfixedLastAniIndex=t);for(var r=0,a=i.length;r<a;r++){var s=i[r];for(e<this.unfixedCurrentTimes[r]&&(this.unfixedCurrentFrameIndexes[r]=0),this.unfixedCurrentTimes[r]=e;this.unfixedCurrentFrameIndexes[r]<s.keyFrame.length&&!(s.keyFrame[this.unfixedCurrentFrameIndexes[r]].startTime>this.unfixedCurrentTimes[r]);)this.unfixedCurrentFrameIndexes[r]++;this.unfixedCurrentFrameIndexes[r]--}return this.unfixedCurrentFrameIndexes},n.getOriginalDataUnfixedRate=function(t,n,i){var r=this._anis[t],a=r.nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(a.length),this.unfixedCurrentTimes=new Float32Array(a.length),this.unfixedKeyframes=__newvec(a.length),this.unfixedLastAniIndex=t);for(var s=0,o=0,l=a.length,h=0;o<l;o++){var _=a[o];for(i<this.unfixedCurrentTimes[o]&&(this.unfixedCurrentFrameIndexes[o]=0),this.unfixedCurrentTimes[o]=i;this.unfixedCurrentFrameIndexes[o]<_.keyFrame.length&&!(_.keyFrame[this.unfixedCurrentFrameIndexes[o]].startTime>this.unfixedCurrentTimes[o]);)this.unfixedKeyframes[o]=_.keyFrame[this.unfixedCurrentFrameIndexes[o]],this.unfixedCurrentFrameIndexes[o]++;var u=this.unfixedKeyframes[o];_.dataOffset=h;var c=i-u.startTime;if(_.lerpType)switch(_.lerpType){case 0:case 1:for(s=0;s<_.keyframeWidth;)s+=_.interpolationMethod[s](_,s,n,h+s,u.data,c,null,u.duration,u.nextData);break;case 2:var d=u.interpolationData,f=d.length,m=0;for(s=0;s<f;){var p=d[s];switch(p){case 6:case 7:s+=e.interpolation[p](_,m,n,h+m,u.data,c,null,u.duration,u.nextData,d,s+1);break;default:s+=e.interpolation[p](_,m,n,h+m,u.data,c,null,u.duration,u.nextData)}m++}}else for(s=0;s<_.keyframeWidth;)s+=_.interpolationMethod[s](_,s,n,h+s,u.data,c,null,u.duration,u.nextData);h+=_.keyframeWidth}},e._LinearInterpolation_0=function(t,e,n,i,r,a,s,o,l,h){var _=0===o?0:a/o;return n[i]=(1-_)*r[e]+_*l[e],1},e._QuaternionInterpolation_1=function(t,e,n,i,r,a,s,o,l,h){var _=0===o?0:a/o;return MathUtil.slerpQuaternionArray(r,e,l,e,_,n,i),4},e._AngleInterpolation_2=function(t,e,n,i,r,a,s,o,l,h){return 0},e._RadiansInterpolation_3=function(t,e,n,i,r,a,s,o,l,h){return 0},e._Matrix4x4Interpolation_4=function(t,e,n,i,r,a,s,o,l,h){for(var _=0;_<16;_++,e++)n[i+_]=r[e]+a*s[e];return 16},e._NoInterpolation_5=function(t,e,n,i,r,a,s,o,l,h){return n[i]=r[e],1},e._BezierInterpolation_6=function(t,e,n,i,r,a,s,o,l,h,_){return void 0===_&&(_=0),n[i]=r[e]+(l[e]-r[e])*BezierLerp.getBezierRate(a/o,h[_],h[_+1],h[_+2],h[_+3]),5},e._BezierInterpolation_7=function(t,e,n,i,r,a,s,o,l,h,_){return void 0===_&&(_=0),n[i]=h[_+4]+h[_+5]*BezierLerp.getBezierRate((.001*a+h[_+6])/h[_+7],h[_],h[_+1],h[_+2],h[_+3]),9},e.load=function(t){return Laya.loader.create(t,null,null,e)},e.interpolation=[e._LinearInterpolation_0,e._QuaternionInterpolation_1,e._AngleInterpolation_2,e._RadiansInterpolation_3,e._Matrix4x4Interpolation_4,e._NoInterpolation_5,e._BezierInterpolation_6,e._BezierInterpolation_7],e}(Resource),Buffer=function(t){function e(){this._glBuffer=null,this._buffer=null,this._bufferType=0,this._bufferUsage=0,this._byteLength=0,e.__super.call(this),e._gl=WebGL.mainContext}__class(e,"laya.webgl.utils.Buffer",t);var n=e.prototype;return n._bind=function(){this.activeResource(),e._bindActive[this._bufferType]!==this._glBuffer&&(34962===this._bufferType&&(e._bindVertexBuffer=this._glBuffer),e._gl.bindBuffer(this._bufferType,e._bindActive[this._bufferType]=this._glBuffer),BaseShader.activeShader=null)},n.recreateResource=function(){this._glBuffer||(this._glBuffer=e._gl.createBuffer()),this.completeCreate()},n.detoryResource=function(){this._glBuffer&&(WebGL.mainContext.deleteBuffer(this._glBuffer),this._glBuffer=null),this.memorySize=0},__getset(0,n,"bufferUsage",function(){return this._bufferUsage}),e._gl=null,e._bindActive={},e._bindVertexBuffer=null,e._enableAtributes=[],e}(Resource),CacheAbleSkinMesh=function(t){function e(){this.isCached=!1,this.canvas=null,this.tex=null,this.rec=null,e.__super.call(this)}__class(e,"laya.ani.bone.canvasmesh.CacheAbleSkinMesh",t);var n=e.prototype;return n.getCanvasPic=function(){var t=new HTMLCanvas("2D"),n=t.getContext("2d");this.rec=this.mesh.getBounds(),t.size(this.rec.width,this.rec.height);var i;return i=this.transform,this.transform=e.tempMt,this.transform.identity(),this.transform.translate(-this.rec.x,-this.rec.y),this.renderToContext(n),this.transform.translate(+this.rec.x,+this.rec.y),this.transform=i,new Texture(t)},n.render=function(t,e,n){this.mesh.texture&&(this.isCached||(this.isCached=!0,this.tex=this.getCanvasPic()),this.transform?(this.transform.translate(e,n),this._renderTextureToContext(t),this.transform.translate(-e,-n)):(this.transform=SkinMeshCanvas._tempMatrix,
this.transform.identity(),this.transform.translate(e,n),this._renderTextureToContext(t),this.transform.translate(-e,-n),this.transform=null))},n._renderTextureToContext=function(t){this.context=t.ctx||t,t.save();var e;if(e=this.tex,this.transform){var n=this.transform;t.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)}this.rec=this.mesh.getBounds(),t.translate(this.rec.x,this.rec.y),t.drawTexture(e,0,0,e.width,e.height,0,0),t.restore()},__static(e,["tempMt",function(){return this.tempMt=new Matrix}]),e}(SkinMeshCanvas),BaseShader=function(t){function e(){e.__super.call(this)}return __class(e,"laya.webgl.shader.BaseShader",t),e.activeShader=null,e.bindShader=null,e}(Resource),Bitmap=function(t){function e(){this.useNum=0,e.__super.call(this),this._w=0,this._h=0}__class(e,"laya.resource.Bitmap",t);var n=e.prototype;return __getset(0,n,"source",function(){return this._source}),__getset(0,n,"height",function(){return this._h}),__getset(0,n,"width",function(){return this._w}),e}(Resource),ComponentNode=function(t){function e(){this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,this._scripts=null,e.__super.call(this),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[],this._scripts=[]}__class(e,"laya.d3.core.ComponentNode",t);var n=e.prototype;return n._addComponent=function(t){var e,n=this._componentsMap.indexOf(t);if(-1===n)e=[],this._componentsMap.push(t),this._typeComponentsIndices.push(e);else if(e=this._typeComponentsIndices[n],this._components[e[0]].isSingleton)throw new Error("无法单实例创建"+t+"组件，"+t+"组件已存在！");var i=ClassUtils.getInstance(t);return e.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.Script&&this._scripts.push(i),i._initialize(this),i},n._removeComponent=function(t,e){var n=this._typeComponentsIndices[t],i=n[e],r=this._components[i];this._components.splice(i,1),r instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(r),1),n.splice(e,1),0===n.length&&(this._typeComponentsIndices.splice(t,1),this._componentsMap.splice(t,1));for(var a=0,s=this._componentsMap.length;a<s;a++){n=this._typeComponentsIndices[a];for(var o=n.length-1;o>=0;o--){var l=n[o];if(!(l>i))break;n[o]=--l}}r._destroy()},n._getComponentByType=function(t,e){void 0===e&&(e=0);var n=this._componentsMap.indexOf(t);return-1===n?null:this._components[this._typeComponentsIndices[n][e]]},n._getComponentsByType=function(t,e){var n=this._componentsMap.indexOf(t);if(-1===n)return void(e.length=0);var i=this._typeComponentsIndices[n],r=i.length;e.length=r;for(var a=0;a<r;a++)e[a]=this._components[i[a]]},n._getComponentByIndex=function(t){return this._components[t]},n._removeComponentByType=function(t,e){void 0===e&&(e=0);var n=this._componentsMap.indexOf(t);-1!==n&&this._removeComponent(n,e)},n._removeComponentsByType=function(t){var e=this._componentsMap.indexOf(t);if(-1!==e)for(var n=this._typeComponentsIndices[e],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(e,i)},n._removeAllComponent=function(){for(var t=0,e=this._componentsMap.length;t<e;this._componentsMap.length<e?e--:t++)this._removeComponentsByType(this._componentsMap[t])},n._updateComponents=function(t){for(var e=0,n=this._components.length;e<n;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._update(t)}},n._lateUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._lateUpdate(t)}},n._preRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._preRenderUpdate(t)}},n._postRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._postRenderUpdate(t)}},e}(Node),BaseMaterial=function(t){function e(){e.__super.call(this),this._shaderDefineValue=0,this._disablePublicShaderDefine=0,this._shaderValues=new ValusArray,this._values=[],this.renderQueue=1,this._alphaTest=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new Vector4(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=513,this.depthWrite=!0,Render.isConchNode&&(this._conchMaterial=new ConchMaterial)}__class(e,"laya.d3.core.material.BaseMaterial",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0}),n._addShaderDefine=function(t){this._shaderDefineValue|=t,this._conchMaterial&&this._conchMaterial.addShaderDefine(t)},n._removeShaderDefine=function(t){this._shaderDefineValue&=~t,this._conchMaterial&&this._conchMaterial.removeShaderDefine(t)},n._addDisablePublicShaderDefine=function(t){this._disablePublicShaderDefine|=t},n._removeDisablePublicShaderDefine=function(t){this._disablePublicShaderDefine&=~t},n._setBuffer=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,0)},n._getBuffer=function(t){return this._values[t]},n._setMatrix4x4=function(t,e){this._shaderValues.setValue(t,e?e.elements:null),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e.elements,0)},n._getMatrix4x4=function(t){return this._values[t]},n._setInt=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,1)},n._getInt=function(t){return this._values[t]},n._setNumber=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,2)},n._getNumber=function(t){return this._values[t]},n._setBool=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,1)},n._getBool=function(t){return this._values[t]},n._setVector2=function(t,e){this._shaderValues.setValue(t,e?e.elements:null),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e.elements,0)},n._getVector2=function(t){return this._values[t]},n._setColor=function(t,e){this._shaderValues.setValue(t,e?e.elements:null),this._values[t]=e,this._conchMaterial&&e&&this._conchMaterial.setShaderValue(t,e.elements,0)},n._getColor=function(t){return this._values[t]},n._setTexture=function(t,e){this._values[t]=e,this._shaderValues.setValue(t,e)},n._getTexture=function(t){return this._values[t]},n._upload=function(){this._shader.uploadMaterialUniforms(this._shaderValues.data)},n._getShader=function(t,e,n){var i=(t|e)&~this._disablePublicShaderDefine;return this._shader=this._shaderCompile.withCompile(i,n,this._shaderDefineValue),this._shader},n._setRenderStateBlendDepth=function(){var t=WebGL.mainContext;switch(WebGLContext.setDepthMask(t,this.depthWrite),0===this.depthTest?WebGLContext.setDepthTest(t,!1):(WebGLContext.setDepthTest(t,!0),WebGLContext.setDepthFunc(t,this.depthTest)),this.blend){case 0:WebGLContext.setBlend(t,!1);break;case 1:WebGLContext.setBlend(t,!0),WebGLContext.setBlendFunc(t,this.srcBlend,this.dstBlend);break;case 2:WebGLContext.setBlend(t,!0)}},n._setRenderStateFrontFace=function(t,e){var n=WebGL.mainContext,i=0;switch(this.cull){case 0:WebGLContext.setCullFace(n,!1);break;case 1:WebGLContext.setCullFace(n,!0),i=t?e&&e._isFrontFaceInvert?2305:2304:e&&e._isFrontFaceInvert?2304:2305,WebGLContext.setFrontFace(n,i);break;case 2:WebGLContext.setCullFace(n,!0),i=t?e&&e._isFrontFaceInvert?2304:2305:e&&e._isFrontFaceInvert?2305:2304,WebGLContext.setFrontFace(n,i)}},n.setShaderName=function(t){var e=Shader3D.nameKey.getID(t);if(-1===e)throw new Error("BaseMaterial: unknown shader name.");this._shaderCompile=ShaderCompile3D._preCompileShader[e],this._conchMaterial&&this._conchMaterial.setShader(this._shaderCompile._conchShader)},n.onAsynLoaded=function(t,e,n){var i=e[0],r=e[1];switch(i.version){case"LAYAMATERIAL:01":var a=0,s=0,o=i.props;for(var l in o)switch(l){case"vectors":var h=o[l];for(a=0,s=h.length;a<s;a++){var _=h[a],u=_.value;switch(u.length){case 2:this[_.name]=new Vector2(u[0],u[1]);break;case 3:this[_.name]=new Vector3(u[0],u[1],u[2]);break;case 4:this[_.name]=new Vector4(u[0],u[1],u[2],u[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var c=o[l];for(a=0,s=c.length;a<s;a++){var d=c[a],f=d.path;f&&(this[d.name]=Loader.getRes(r[f]))}break;case"defines":var m=o[l];for(a=0,s=m.length;a<s;a++){var p=this._shaderCompile.getMaterialDefineByName(m[a]);this._addShaderDefine(p)}break;default:this[l]=o[l]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this._endLoaded()},n.cloneTo=function(t){var e=t;e.name=this.name,e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(e.blendConstColor),e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.renderQueue=this.renderQueue,e._shader=this._shader,e._disablePublicShaderDefine=this._disablePublicShaderDefine,e._shaderDefineValue=this._shaderDefineValue;var n=0,i=0,r=e._shaderValues;e._shaderValues.data.length=this._shaderValues.data.length;var a=this._values.length,s=e._values;for(s.length=a,n=0,i=a;n<i;n++){var o=this._values[n];if(o)if("number"==typeof o)s[n]=o,r.data[n]=o;else if("number"==typeof o&&Math.floor(o)==o)s[n]=o,r.data[n]=o;else if("boolean"==typeof o)s[n]=o,r.data[n]=o;else if(o instanceof laya.d3.math.Vector2){var l=s[n]||(s[n]=new Vector2);o.cloneTo(l),r.data[n]=l.elements}else if(o instanceof laya.d3.math.Vector3){var h=s[n]||(s[n]=new Vector3);o.cloneTo(h),r.data[n]=h.elements}else if(o instanceof laya.d3.math.Vector4){var _=s[n]||(s[n]=new Vector4);o.cloneTo(_),r.data[n]=_.elements}else if(o instanceof laya.d3.math.Matrix4x4){var u=s[n]||(s[n]=new Matrix4x4);o.cloneTo(u),r.data[n]=u.elements}else o instanceof laya.d3.resource.BaseTexture&&(s[n]=o,r.data[n]=o)}},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},__getset(0,n,"alphaTest",function(){return this._alphaTest},function(t){this._alphaTest=t,t?this._addShaderDefine(1):this._removeShaderDefine(1)}),__getset(0,n,"alphaTestValue",function(){return this._getNumber(0)},function(t){this._setNumber(0,t)}),e.CULL_NONE=0,e.CULL_FRONT=1,e.CULL_BACK=2,e.BLEND_DISABLE=0,e.BLEND_ENABLE_ALL=1,e.BLEND_ENABLE_SEPERATE=2,e.BLENDPARAM_ZERO=0,e.BLENDPARAM_ONE=1,e.BLENDPARAM_SRC_COLOR=768,e.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,e.BLENDPARAM_DST_COLOR=774,e.BLENDPARAM_ONE_MINUS_DST_COLOR=775,e.BLENDPARAM_SRC_ALPHA=770,e.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,e.BLENDPARAM_DST_ALPHA=772,e.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,e.BLENDPARAM_SRC_ALPHA_SATURATE=776,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_SUBTRACT=1,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.DEPTHTEST_OFF=0,e.DEPTHTEST_NEVER=512,e.DEPTHTEST_LESS=513,e.DEPTHTEST_EQUAL=514,e.DEPTHTEST_LEQUAL=515,e.DEPTHTEST_GREATER=516,e.DEPTHTEST_NOTEQUAL=517,e.DEPTHTEST_GEQUAL=518,e.DEPTHTEST_ALWAYS=519,e.SHADERDEFINE_ALPHATEST=1,e.ALPHATESTVALUE=0,e}(Resource),Avatar=function(t){function e(){e.__super.call(this)}__class(e,"laya.d3.core.Avatar",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0}),n._initCloneToAnimator=function(t,e){e._avatarNodeMap[t.name]=t,e._avatarNodes.push(t);for(var n=0,i=t.getChildCount();n<i;n++)this._initCloneToAnimator(t.getChildByIndex(n),e)},n._parseNode=function(t,e){var n=t.props.name;e.name=n;var i=t.customProps,r=e._transform,a=r.localPosition,s=a.elements,o=i.translate;s[0]=o[0],s[1]=o[1],s[2]=o[2],r.localPosition=a;var l=r.localRotation,h=l.elements,_=i.rotation;h[0]=_[0],h[1]=_[1],h[2]=_[2],h[3]=_[3],r.localRotation=l;var u=r.localScale,c=u.elements,d=i.scale;c[0]=d[0],c[1]=d[1],c[2]=d[2],r.localScale=u;for(var f=t.child,m=0,p=f.length;m<p;m++){var g=f[m],v=new AnimationNode;e.addChild(v),this._parseNode(g,v)}},n.onAsynLoaded=function(t,e,n){if(this._rootNode=new AnimationNode,e.version){this._version=e.version;var i=e.rootNode;i&&this._parseNode(i,this._rootNode)}else this._parseNode(e,this._rootNode);this._endLoaded()},n._cloneDatasToAnimator=function(t){var e=this._rootNode.clone(),n=[];t._avatarRootNode=e,t._avatarNodeMap={},t._avatarNodes=n,this._initCloneToAnimator(e,t);for(var i=0,r=n.length;i<r;i++){var a=n[i];a._parent?a._transform._setWorldMatrixAndUpdate(new Matrix4x4):a._transform._setWorldMatrixNoUpdate(null)}},n.cloneTo=function(t){var e=t,n=this._rootNode.clone();e._rootNode=n},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.load=function(t){return Laya.loader.create(t,null,null,e)},e}(Resource),RenderTarget2D=function(t){function e(t,n,i,r,a,s,o,l,h){this._type=0,this._svWidth=NaN,this._svHeight=NaN,this._preRenderTarget=null,this._alreadyResolved=!1,this._looked=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._mipMap=!1,this._repeat=!1,this._minFifter=0,this._magFifter=0,this._destroy=!1,void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1),this._type=1,this._w=t,this._h=n,this._surfaceFormat=i,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=l,this._magFifter=h,this._createWebGLRenderTarget(),this.bitmap.lock=!0,e.__super.call(this,this.bitmap,Texture.INV_UV)}__class(e,"laya.webgl.resource.RenderTarget2D",t);var n=e.prototype;return Laya.imps(n,{"laya.resource.IDispose":!0}),n.getType=function(){return this._type},n.getTexture=function(){return this},n.size=function(t,e){this._w==t&&this._h==e||(this._w=t,this._h=e,this.release(),0!=this._w&&0!=this._h&&this._createWebGLRenderTarget())},n.release=function(){this.destroy()},n.recycle=function(){e.POOL.push(this)},n.start=function(){var t=WebGL.mainContext;return this._preRenderTarget=RenderState2D.curRenderTarget,RenderState2D.curRenderTarget=this,t.bindFramebuffer(36160,this.bitmap.frameBuffer),this._alreadyResolved=!1,1==this._type&&(t.viewport(0,0,this._w,this._h),this._svWidth=RenderState2D.width,this._svHeight=RenderState2D.height,RenderState2D.width=this._w,RenderState2D.height=this._h,BaseShader.activeShader=null),this},n.clear=function(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1);var r=WebGL.mainContext;r.clearColor(t,e,n,i);var a=16384;switch(this._depthStencilFormat){case 33189:a|=256;break;case 36168:a|=1024;break;case 34041:a|=256,a|=1024}r.clear(a)},n.end=function(){var t=WebGL.mainContext;t.bindFramebuffer(36160,this._preRenderTarget?this._preRenderTarget.bitmap.frameBuffer:null),this._alreadyResolved=!0,RenderState2D.curRenderTarget=this._preRenderTarget,1==this._type?(t.viewport(0,0,this._svWidth,this._svHeight),RenderState2D.width=this._svWidth,RenderState2D.height=this._svHeight,BaseShader.activeShader=null):t.viewport(0,0,Laya.stage.width,Laya.stage.height)},n.getData=function(t,e,n,i){var r=WebGL.mainContext;if(r.bindFramebuffer(36160,this.bitmap.frameBuffer),!(36053===r.checkFramebufferStatus(36160)))return r.bindFramebuffer(36160,null),null;var a=new Uint8Array(this._w*this._h*4);return r.readPixels(t,e,n,i,this._surfaceFormat,this._surfaceType,a),r.bindFramebuffer(36160,null),a},n.destroy=function(e){void 0===e&&(e=!1),this._destroy||(this._loaded=!1,this.bitmap.offAll(),this.bitmap.detoryResource(),this.bitmap.dispose(),this.offAll(),this.bitmap=null,this._alreadyResolved=!1,this._destroy=!0,t.prototype.destroy.call(this))},n.dispose=function(){},n._createWebGLRenderTarget=function(){this.bitmap=new WebGLRenderTarget(this.width,this.height,this._surfaceFormat,this._surfaceType,this._depthStencilFormat,this._mipMap,this._repeat,this._minFifter,this._magFifter),this.bitmap.activeResource(),this._alreadyResolved=!0,this._destroy=!1,this._loaded=!0,this.bitmap.on("recovered",this,function(t){this.event("recovered")})},__getset(0,n,"source",function(){return this._alreadyResolved?t.prototype._$get_source.call(this):null}),__getset(0,n,"magFifter",function(){return this._magFifter}),__getset(0,n,"mipMap",function(){return this._mipMap}),__getset(0,n,"minFifter",function(){return this._minFifter}),__getset(0,n,"surfaceType",function(){return this._surfaceType}),__getset(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),__getset(0,n,"surfaceFormat",function(){return this._surfaceFormat}),e.create=function(t,n,i,r,a,s,o,l,h){void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1);var _=e.POOL.pop();return _||(_=new e(t,n)),_.bitmap&&_._w==t&&_._h==n&&_._surfaceFormat==i&&_._surfaceType==r&&_._depthStencilFormat==a&&_._mipMap==s&&_._repeat==o&&_._minFifter==l&&_._magFifter==h||(_._w=t,_._h=n,_._surfaceFormat=i,_._surfaceType=r,_._depthStencilFormat=a,_._mipMap=s,_._repeat=o,_._minFifter=l,_._magFifter=h,_.release(),_._createWebGLRenderTarget()),_},e.TYPE2D=1,e.TYPE3D=2,e.POOL=[],e}(Texture),AnimationClip=function(t){function e(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyToNodeMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyToNodeMap=null,this._duration=NaN,this._frameRate=0,this.islooping=!1,e.__super.call(this),this._fullKeyframeIndicesCache={},this._animationDatasCache=[],this._avatarDatasCache=[],this._skinnedDatasCache=[]}__class(e,"laya.d3.animation.AnimationClip",t);var n=e.prototype;return n.duration=function(){return this._duration},n._hermiteInterpolate=function(t,e,n,i){for(var r=t.data,a=t.outTangent,s=t.next,o=s.data,l=s.inTangent,h=!1,_=NaN,u=NaN,c=NaN,d=NaN,f=0,m=i.length;f<m;f++){var p=a[f],g=l[f];if(Number.isFinite(p)&&Number.isFinite(g)){if(!h){var v=e*e,x=v*e;_=2*x-3*v+1,u=x-2*v+e,c=x-v,d=-2*x+3*v,h=!0}i[f]=_*r[f]+u*p*n+c*g*n+d*o[f]}else i[f]=r[f]}},n._getFullKeyframeIndicesWithCache=function(t){return this._fullKeyframeIndicesCache[t]},n._cacheFullKeyframeIndices=function(t,e){this._fullKeyframeIndicesCache[t]=e},n._getAnimationDataWithCache=function(t,e){var n=this._animationDatasCache[t];return n?n[e]:null},n._cacheAnimationData=function(t,e,n){(this._animationDatasCache[t]||(this._animationDatasCache[t]=[]))[e]=n},n._getAvatarDataWithCache=function(t,e,n){var i=this._avatarDatasCache[t.id];if(i){var r=i[e];return r?r[n]:null}return null},n._cacheAvatarData=function(t,e,n,i){var r=this._avatarDatasCache[t.id]||(this._avatarDatasCache[t.id]=[]);(r[e]||(r[e]=[]))[n]=i},n._getSkinnedDatasWithCache=function(t,e,n,i){var r=this._skinnedDatasCache[t.id];if(r){var a=r[e.id];if(a){var s=a[n];return s?s[i]:null}return null}return null},n._cacheSkinnedDatasWithCache=function(t,e,n,i,r){var a=this._skinnedDatasCache[t.id]||(this._skinnedDatasCache[t.id]=[]),s=a[e.id]||(a[e.id]=[]);(s[n]||(s[n]=[]))[i]=r},n._evaluateAnimationlDatasCacheMode=function(t,e,n,i,r){for(var a=0,s=0,o=0,l=r?r.length:this._nodes.length;o<l;o++){var h=r?r[o]:o,_=this._nodes[h],u=_._cacheProperty;if(t[h]){var c,d=e[h],f=d[n.currentFrameIndex],m=0;if(-1!==f){var p=_.keyFrames[f];if(p.next){r?u?(c=new Float32Array(_.keyFrameWidth),i[o]=c):(c=i[h])||(c=i[h]=new Float32Array(_.keyFrameWidth)):(c=new Float32Array(_.keyFrameWidth),i[o]=c);var g=NaN,v=p.duration;g=0!==v?(n.currentFrameTime-p.startTime)/v:0,this._hermiteInterpolate(p,g,v,c)}else{if(r)if(u){if(-1!==(m=n._lastFrameIndex)&&d[m]===f)continue;c=new Float32Array(_.keyFrameWidth),i[o]=c}else(c=i[h])||(c=i[h]=new Float32Array(_.keyFrameWidth));else{if(-1!==(m=n._lastFrameIndex)&&d[m]===f)continue;c=new Float32Array(_.keyFrameWidth),i[o]=c}var x=p.data;for(a=0,s=c.length;a<s;a++)c[a]=x[a]}}else{if(r)if(u){if(-1!==(m=n._lastFrameIndex)&&d[m]===f)continue;c=new Float32Array(_.keyFrameWidth),i[o]=c}else(c=i[h])||(c=i[h]=new Float32Array(_.keyFrameWidth));else{if(-1!==(m=n._lastFrameIndex)&&d[m]===f)continue;c=new Float32Array(_.keyFrameWidth),i[o]=c}var S=_.keyFrames[0].data;for(a=0,s=c.length;a<s;a++)c[a]=S[a]}}}},n._evaluateAnimationlDatasRealTime=function(t,e,n,i){var r=0,a=0,s=this._nodes;if(!this._realTimeCurrentFrameIndexes){for(this._realTimeCurrentFrameIndexes=new Int32Array(s.length),r=0,a=s.length;r<a;r++)this._realTimeCurrentFrameIndexes[r]=-1;this._realTimeCurrentTimes=new Float32Array(s.length)}for(r=0,a=s.length;r<a;r++){var o=s[r];e<this._realTimeCurrentTimes[r]&&(this._realTimeCurrentFrameIndexes[r]=-1),this._realTimeCurrentTimes[r]=e;for(var l=this._realTimeCurrentFrameIndexes[r]+1,h=o.keyFrames,_=h.length;l<_;){if(h[l].startTime>e){this._realTimeCurrentFrameIndexes[r]=l-1;break}l++}l===_&&(this._realTimeCurrentFrameIndexes[r]=_-1);var u=0,c=0,d=n[r];d||(d=n[r]=new Float32Array(o.keyFrameWidth));var f=h[this._realTimeCurrentFrameIndexes[r]];if(f){if(f.next){var m=f.duration,p=NaN;p=0!==m?(e-f.startTime)/m:0,this._hermiteInterpolate(f,p,m,d)}else{var g=f.data;for(u=0,c=d.length;u<c;u++)d[u]=g[u]}}else{var v=o.keyFrames[0].data;for(u=0,c=d.length;u<c;u++)d[u]=v[u]}var x=t[r];x&&(i?AnimationNode._propertySetFuncs[o.propertyNameID](x,null,d):AnimationNode._propertySetFuncs[o.propertyNameID](null,x,d))}},n.onAsynLoaded=function(t,e,n){var i=new Byte(e);switch(this._version=i.readUTFString(),this._version){case"LAYAANIMATION:01":AnimationClipParser01.parse(this,i)}this._endLoaded()},n.detoryResource=function(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyToNodeMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyToNodeMap=null},e.load=function(t){return Laya.loader.create(t,null,null,e)},e}(Resource),TerrainHeightData=function(t){function e(){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,e.__super.call(this)}return __class(e,"laya.d3.terrain.TerrainHeightData",t),e.prototype.onAsynLoaded=function(t,e,n){this._width=n[0],this._height=n[1],this._bitType=n[2],this._value=n[3];var i,r=NaN;8==this._bitType?(i=new Uint8Array(e),r=1/255):16==this._bitType&&(i=new Int16Array(e),r=1/32766),this._terrainHeightData=new Float32Array(this._height*this._width);for(var a=0,s=this._height*this._width;a<s;a++)this._terrainHeightData[a]=i[a]*r*this._value/2;this._endLoaded()},e.load=function(t,n,i,r,a){return Laya.loader.create(t,null,null,e,[n,i,r,a],1,!1)},e}(Resource),TerrainRes=function(t){function e(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,e.__super.call(this)}__class(e,"laya.d3.terrain.TerrainRes",t);var n=e.prototype;return n.parseData=function(t){var e=t[0],n=t[1];if(this._version=e.version,1==this._version){this._cameraCoordinateInverse=e.cameraCoordinateInverse,this._gridSize=e.gridSize,this._chunkNumX=e.chunkNumX,this._chunkNumZ=e.chunkNumZ;var i=e.heightData;if(this._heightDataX=i.numX,this._heightDataZ=i.numZ,this._heightDataBitType=i.bitType,this._heightDataValue=i.value,this._heightDataUrl=n[i.url],this._materialInfo=new MaterialInfo,e.material){var r=e.material.ambient,a=e.material.diffuse,s=e.material.specular;this._materialInfo.ambientColor=new Vector3(r[0],r[1],r[2]),this._materialInfo.diffuseColor=new Vector3(a[0],a[1],a[2]),this._materialInfo.specularColor=new Vector4(s[0],s[1],s[2],s[3])}var o=e.detailTexture;this._detailTextureInfos=__newvec(o.length);for(var l=0;l<o.length;l++){var h=o[l],_=new DetailTextureInfo;_.diffuseTexture=n[h.diffuse],_.normalTexture=h.normal?n[h.normal]:null,h.scale?_.scale=new Vector2(h.scale[0],h.scale[1]):_.scale=new Vector2(1,1),h.offset?_.offset=new Vector2(h.offset[0],h.offset[1]):_.offset=new Vector2(0,0),this._detailTextureInfos[l]=_}var u=e.alphaMap;for(this._alphaMaps=__newvec(u.length),l=0;l<this._alphaMaps.length;l++)this._alphaMaps[l]=e.alphaMap[l];var c=e.normalMap;for(this._normalMaps=__newvec(c.length),l=0;l<this._normalMaps.length;l++)this._normalMaps[l]=e.normalMap[l];var d=e.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=d.length)return alert("terrain data error"),!1;for(this._chunkInfos=__newvec(d.length),l=0;l<d.length;l++){var f=d[l],m=new ChunkInfo,p=f.alphaMap.length,g=f.detailID.length;if(p!=g)return alert("terrain chunk data error"),!1;m.alphaMap=__newvec(p),m.detailID=__newvec(g),m.normalMap=n[this._normalMaps[f.normalMap]];for(var v=0;v<p;v++){m.alphaMap[v]=n[this._alphaMaps[f.alphaMap[v]]];var x=f.detailID[v],S=x.length;m.detailID[v]=new Uint8Array(S);for(var T=0;T<S;T++)m.detailID[v][T]=x[T]}this._chunkInfos[l]=m}this._heightData=Loader.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData)}return!0},n.onLoadTerrainComplete=function(t){this._endLoaded()},n.onAsynLoaded=function(t,e,n){this.parseData(e)},e.load=function(t){return Laya.loader.create(t,null,null,e,null,1,!1)},e}(Resource),BaseTexture=function(t){function e(){this._type=0,this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._format=0,this._source=null,e.__super.call(this),this._conchTexture,Render.isConchNode&&(this._conchTexture=new ConchTexture),this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}__class(e,"laya.d3.resource.BaseTexture",t);var n=e.prototype;return __getset(0,n,"defaulteTexture",function(){return SolidColorTexture2D.grayTexture}),__getset(0,n,"source",function(){return this.activeResource(),this._source}),__getset(0,n,"format",function(){return this._format}),__getset(0,n,"magFifter",function(){return this._magFifter},function(t){this._magFifter=t,t!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(t)}),__getset(0,n,"mipmap",function(){return this._mipmap},function(t){this._mipmap=t,this._mipmap!=t&&this._conchTexture&&this._conchTexture.setMipMap(t)}),__getset(0,n,"size",function(){return this._size}),__getset(0,n,"repeat",function(){return this._repeat},function(t){if(this._repeat!==t&&(this._repeat=t,this._source)){var e=WebGL.mainContext;WebGLContext.bindTexture(e,this._type,this._source);Arith.isPOT(this._width,this._height)&&this._repeat?(e.texParameteri(this._type,10242,10497),e.texParameteri(this._type,10243,10497)):(e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071))}}),__getset(0,n,"height",function(){return this._height}),__getset(0,n,"minFifter",function(){return this._minFifter},function(t){this._minFifter=t,this._minFifter!=t&&this._conchTexture&&this._conchTexture.setMinFifter(t)}),__getset(0,n,"width",function(){return this._width}),e}(Resource),BaseMesh=function(t){function e(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._positions=null,e.__super.call(this),this._boundingBoxCorners=__newvec(8,null)}__class(e,"laya.d3.resource.models.BaseMesh",t);var n=e.prototype;return n._getPositions=function(){throw new Error("未Override,请重载该属性！")},n._generateBoundingObject=function(){this._boundingSphere=new BoundSphere(new Vector3,0),BoundSphere.createfromPoints(this._positions,this._boundingSphere),this._boundingBox=new BoundBox(new Vector3,new Vector3),BoundBox.createfromPoints(this._positions,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},n.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},n.getRenderElement=function(t){throw new Error("未Override,请重载该属性！")},__getset(0,n,"boundingBoxCorners",function(){return this._boundingBoxCorners}),__getset(0,n,"boundingBox",function(){return this._boundingBox}),__getset(0,n,"boundingSphere",function(){return this._boundingSphere}),__getset(0,n,"subMeshCount",function(){return this._subMeshCount}),e}(Resource),Sky=function(t){function e(){this.__ownerCamera=null,this._alphaBlending=1,this._colorIntensity=1,this._vertexBuffer=null,this._indexBuffer=null,this._sharderNameID=0,this._shader=null,this._shaderValue=null,this._shaderCompile=null,this._environmentDiffuse=null,this._environmentSpecular=null,this._conchSky=null,e.__super.call(this),this._shaderValue=new ValusArray,Render.isConchNode&&(this._conchSky=new ConchSkyMesh)}__class(e,"laya.d3.resource.models.Sky",t);var n=e.prototype;return n._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse):this._environmentDiffuse.on("loaded",this,this._environmentDiffuseLoaded)},n._setEnvironmentSpecular=function(){if(this._environmentSpecular.loaded){var t=this._environmentSpecular.simLodInfo;t&&t instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,t),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)}else this._environmentSpecular.on("loaded",this,this._environmentSpecularLoaded)},n._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse)},n._environmentSpecularLoaded=function(){var t=this._environmentSpecular.simLodInfo;t&&t instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,t),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)},n._render=function(t){},__getset(0,n,"envDiffuseSHRed",null,function(t){this.__ownerCamera._shaderValues.setValue(10,t)}),__getset(0,n,"envDiffuseSHBlue",null,function(t){this.__ownerCamera._shaderValues.setValue(12,t)}),__getset(0,n,"environmentDiffuse",function(){return this._environmentDiffuse},function(t){t.minFifter=9728,this._environmentDiffuse=t,this.__ownerCamera&&this._setEnvironmentDiffuse()}),__getset(0,n,"environmentSpecular",function(){return this._environmentSpecular},function(t){this._environmentSpecular=t,this.__ownerCamera&&this._setEnvironmentSpecular()}),__getset(0,n,"colorIntensity",function(){return this._colorIntensity},function(t){this._colorIntensity=t,this._colorIntensity<0&&(this._colorIntensity=0),this._conchSky&&this._conchSky.setShaderValue(1,this._colorIntensity,2)}),__getset(0,n,"envDiffuseSHGreen",null,function(t){this.__ownerCamera._shaderValues.setValue(11,t)}),__getset(0,n,"alphaBlending",function(){return this._alphaBlending},function(t){this._alphaBlending=t,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1),this._conchSky&&this._conchSky.setShaderValue(2,this._alphaBlending,2)}),__getset(0,n,"_ownerCamera",null,function(t){this.__ownerCamera=t,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),e.MVPMATRIX=0,e.INTENSITY=1,e.ALPHABLENDING=2,e.DIFFUSETEXTURE=3,e}(Resource),TextureSV=function(t){function e(t){this.u_colorMatrix=null,this.strength=0,this.blurInfo=null,this.colorMat=null,this.colorAlpha=null,this.texcoord=Value2D._TEXCOORD,void 0===t&&(t=0),e.__super.call(this,1,t)}__class(e,"laya.webgl.shader.d2.value.TextureSV",t);var n=e.prototype;return n.setValue=function(t){this.ALPHA=t.ALPHA,t.filters&&this.setFilters(t.filters)},n.clear=function(){this.texture=null,this.shader=null,this.defines.setValue(0)},e}(Value2D),PrimitiveSV=function(t){function e(t){this.a_color=null,this.u_pos=[0,0],e.__super.call(this,4,0),this.position=[2,5126,!1,5*CONST3D2D.BYTES_PE,0],this.a_color=[3,5126,!1,5*CONST3D2D.BYTES_PE,2*CONST3D2D.BYTES_PE]}return __class(e,"laya.webgl.shader.d2.value.PrimitiveSV",t),e}(Value2D),Color2dSV=function(t){function e(t){e.__super.call(this,2,0),this.color=[]}
return __class(e,"laya.webgl.shader.d2.value.Color2dSV",t),e.prototype.setValue=function(t){t.fillStyle&&(this.color=t.fillStyle._color._color),t.strokeStyle&&(this.color=t.strokeStyle._color._color)},e}(Value2D),FillTextureSV=function(t){function e(t){this.u_colorMatrix=null,this.strength=0,this.colorMat=null,this.colorAlpha=null,this.u_TexRange=[0,1,0,1],this.u_offset=[0,0],this.texcoord=Value2D._TEXCOORD,e.__super.call(this,256,0)}__class(e,"laya.webgl.shader.d2.value.FillTextureSV",t);var n=e.prototype;return n.setValue=function(t){this.ALPHA=t.ALPHA,t.filters&&this.setFilters(t.filters)},n.clear=function(){this.texture=null,this.shader=null,this.defines.setValue(0)},e}(Value2D),SkinSV=function(t){function e(t){this.texcoord=null,this.offsetX=300,this.offsetY=0,e.__super.call(this,512,0);var n=8*CONST3D2D.BYTES_PE;this.position=[2,5126,!1,n,0],this.texcoord=[2,5126,!1,n,2*CONST3D2D.BYTES_PE],this.color=[4,5126,!1,n,4*CONST3D2D.BYTES_PE]}return __class(e,"laya.webgl.shader.d2.skinAnishader.SkinSV",t),e}(Value2D),MeshFilter=function(t){function e(t){this._owner=null,this._sharedMesh=null,e.__super.call(this),this._owner=t}__class(e,"laya.d3.core.MeshFilter",t);var n=e.prototype;return n._sharedMeshLoaded=function(){this.event("loaded")},n._destroy=function(){t.prototype._destroy.call(this),this._owner=null,this._sharedMesh=null},__getset(0,n,"_originalBoundingBoxCorners",function(){return this._sharedMesh.boundingBoxCorners}),__getset(0,n,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),__getset(0,n,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),__getset(0,n,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox}),__getset(0,n,"sharedMesh",function(){return this._sharedMesh},function(t){var e=this._sharedMesh;this._sharedMesh=t,this.event("meshchanged",[this,e,t]),t.loaded||this._sharedMesh.once("loaded",this,this._sharedMeshLoaded)}),e}(GeometryFilter),ShurikenParticleRender=function(t){function e(t){this._finalGravity=new Vector3,this._tempRotationMatrix=new Matrix4x4,e.__super.call(this,t),this._defaultBoundBox=new BoundBox(new Vector3,new Vector3),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}__class(e,"laya.d3.core.particleShuriKen.ShurikenParticleRender",t);var n=e.prototype;return n._calculateBoundingBox=function(){var t=this._boundingBox.min.elements;t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;var e=this._boundingBox.min.elements;e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var t=this._owner.particleSystem._boundingSphere,e=NaN,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),s=Math.abs(i[2]);e=r>=a&&r>=s?r:a>=s?a:s,Vector3.transformCoordinate(t.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*e},n._renderUpdate=function(t){var e=this._owner.particleSystem,n=this._owner.transform;switch(e.simulationSpace){case 0:break;case 1:this._setShaderValueColor(0,n.position),this._setShaderValueColor(1,n.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(e.scaleMode){case 0:var i=n.scale;this._setShaderValueColor(4,i),this._setShaderValueColor(5,i);break;case 1:var r=n.localScale;this._setShaderValueColor(4,r),this._setShaderValueColor(5,r);break;case 2:this._setShaderValueColor(4,n.scale),this._setShaderValueColor(5,Vector3.ONE)}var a=this._finalGravity.elements,s=Physics.gravity.elements,o=e.gravityModifier;a[0]=s[0]*o,a[1]=s[1]*o,a[2]=s[2]*o,this._setShaderValueBuffer(7,a),this._setShaderValueInt(11,e.simulationSpace),this._setShaderValueBool(8,e.threeDStartRotation),this._setShaderValueInt(6,e.scaleMode),this._setShaderValueInt(9,this.stretchedBillboardLengthScale),this._setShaderValueInt(10,this.stretchedBillboardSpeedScale),this._setShaderValueNumber(12,e._currentTime),Laya3D.debugMode&&this._renderRenderableBoundBox()},__getset(0,n,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),__getset(0,n,"mesh",function(){return this._mesh},function(t){this._mesh!==t&&(this._mesh=t,this._owner.particleSystem._initBufferDatas())}),__getset(0,n,"renderMode",function(){return this._renderMode},function(t){if(this._renderMode!==t){switch(this._renderMode){case 0:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=t,t){case 0:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),e}(BaseRender),ShurikenParticleSystem=function(t){function e(t){e.__super.call(this),this._tempRotationMatrix=new Matrix4x4,this._uvLength=new Vector2,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=t,this._ownerRender=t.particleRender,this._boundingBoxCorners=__newvec(8,null),this._boundingSphere=new BoundSphere(new Vector3,Number.MAX_VALUE),this._boundingBox=new BoundBox(new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new GradientDataNumber,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new GradientDataNumber,this._startLifeTimeGradientMax=new GradientDataNumber,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new Vector3(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new Vector3(0,0,0),this.startSizeConstantMaxSeparate=new Vector3(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new Vector3(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new Vector3(0,0,0),this.startRotationConstantMaxSeparate=new Vector3(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new Vector4(1,1,1,1),this.startColorConstantMin=new Vector4(1,1,1,1),this.startColorConstantMax=new Vector4(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new Rand(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(e._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new Emission,this._emission.enbale=!0,this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)}__class(e,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0,"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},n._getIndexBuffer=function(){return this._indexBuffer},n._generateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._generateBoundingBox=function(){var t=this._owner,n=t.particleRender,i=this._boundingBox.min,r=this._boundingBox.max,a=0,s=0,o=NaN;switch(this.startLifetimeType){case 0:o=this.startLifetimeConstant;break;case 1:o=-Number.MAX_VALUE;var l=l;for(a=0,s=l.gradientCount;a<s;a++)o=Math.max(o,l.getValueByIndex(a));break;case 2:o=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:o=-Number.MAX_VALUE;var h=h;for(a=0,s=h.gradientCount;a<s;a++)o=Math.max(o,h.getValueByIndex(a));var _=_;for(a=0,s=_.gradientCount;a<s;a++)o=Math.max(o,_.getValueByIndex(a))}var u=NaN,c=NaN;switch(this.startSpeedType){case 0:u=c=this.startSpeedConstant;break;case 1:break;case 2:u=this.startLifetimeConstantMin,c=this.startLifetimeConstantMax}var d,f,m,p;this._shape&&this._shape.enable||(d=f=Vector3.ZERO,m=Vector3.ZERO,p=Vector3.UnitZ);var g=new Vector3(m.x*u,m.y*u,m.z*u),v=new Vector3(p.x*c,p.y*c,p.z*c);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var x=this._velocityOverLifetime.velocity;switch(x.type){case 0:x.constant;break;case 1:new Vector3(x.gradientX.getAverageValue(),x.gradientY.getAverageValue(),x.gradientZ.getAverageValue());break;case 2:x.constantMin,x.constantMax;break;case 3:new Vector3(x.gradientXMin.getAverageValue(),x.gradientYMin.getAverageValue(),x.gradientZMin.getAverageValue()),new Vector3(x.gradientXMax.getAverageValue(),x.gradientYMax.getAverageValue(),x.gradientZMax.getAverageValue())}}var S,T,E=this._owner.transform,y=E.position,M=e._tempVector39,D=M.elements,C=n.renderMode;switch(this.scaleMode){case 0:var R=E.scale;S=R,D[0]=R.x,D[1]=R.z,D[2]=R.y,1===C&&(T=R);break;case 1:var A=E.localScale;S=A,D[0]=A.x,D[1]=A.z,D[2]=A.y,1===C&&(T=A);break;case 2:S=E.scale,D[0]=D[1]=D[2]=1,1===C&&(T=Vector3.ONE)}var b,I;switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(b=new Vector3(g.x*o,g.y*o,g.z*o),I=new Vector3(v.x*o,v.y*o,v.z*o),2!=this.scaleMode?(Vector3.add(d,b,i),Vector3.multiply(S,i,i),Vector3.add(f,I,r),Vector3.multiply(S,r,r)):(Vector3.multiply(S,d,i),Vector3.add(i,b,i),Vector3.multiply(S,f,r),Vector3.add(r,I,r))),this.simulationSpace){case 0:break;case 1:Vector3.add(i,y,i),Vector3.add(r,y,r)}var w=NaN,V=NaN;switch(this.startSizeType){case 0:if(this.threeDStartSize){var L=L;w=Math.max(L.x,L.y),1===C&&(V=L.y)}else w=this.startSizeConstant,1===C&&(V=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var P=P;w=Math.max(P.x,P.y),1===C&&(V=P.y)}else w=this.startSizeConstantMax,1===C&&(V=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){this._sizeOverLifetime.size;w*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var N=e._tempVector30,O=N.elements,F=NaN,B=NaN;switch(C){case 0:F=w*e.halfKSqrtOf2,Vector3.scale(M,w,N),Vector3.subtract(i,N,i),Vector3.add(r,N,r);break;case 1:var U=e._tempVector31,G=e._tempVector32,H=e._tempVector33,W=e._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(Vector3.multiply(T,v,G),Vector3.multiply(T,g,H));var k=V*n.stretchedBillboardLengthScale,z=Vector3.scalarLength(G)*n.stretchedBillboardSpeedScale+k,X=Vector3.scalarLength(H)*n.stretchedBillboardSpeedScale+k,Y=e._tempVector35,K=e._tempVector36;Vector3.normalize(G,Y),Vector3.scale(Y,z,W),Vector3.subtract(I,W,W),Vector3.normalize(H,K),Vector3.scale(K,X,U),Vector3.add(b,U,U),F=w*e.halfKSqrtOf2,Vector3.scale(M,F,N);var Z=e._tempVector37,j=e._tempVector38;Vector3.scale(Y,.5,Z),Vector3.scale(K,.5,j),Vector3.multiply(Z,M,Z),Vector3.multiply(j,M,j),Vector3.add(i,j,i),Vector3.min(i,W,i),Vector3.subtract(i,N,i),Vector3.subtract(r,Z,r),Vector3.max(r,U,r),Vector3.add(r,N,r);break;case 2:w*=Math.cos(.7853981633974483),B=.5*w,O[0]=M.x*B,O[1]=M.z*B,Vector3.subtract(i,N,i),Vector3.add(r,N,r);break;case 3:w*=Math.cos(.7853981633974483),B=.5*w,Vector3.scale(M,B,N),Vector3.subtract(i,N,i),Vector3.add(r,N,r)}this._boundingBox.getCorners(this._boundingBoxCorners)},n._updateEmission=function(){if(Laya.stage.isVisibility)if(this._simulateUpdate)this._simulateUpdate=!1;else{var t=this._startUpdateLoopCount===Stat.loopCount||this._isPaused?0:Laya.timer.delta/1e3;t=Math.min(e._maxElapsedTime,t),this._updateParticles(t)}},n._updateParticles=function(t){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=t,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=t,this._totalDelayTime<this._playStartDelay||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(t,this._currentTime))},n._updateParticlesSimulationRestart=function(t){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=t,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=t;var e=t;if(e<this._playStartDelay)return void(this._totalDelayTime=e);this._emission.enbale&&this._advanceTime(t,t)},n._addUpdateEmissionToTimer=function(){Laya.timer.frameLoop(1,this,this._updateEmission)},n._removeUpdateEmissionToTimer=function(){Laya.timer.clear(this,this._updateEmission)},n._onOwnerActiveHierarchyChanged=function(t){this._owner.displayedInStage&&(t?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},n._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var t=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,e=t+this._timeIndex;if(this._currentTime-this._vertices[e]+1e-4<this._vertices[t+this._startLifeTimeIndex])break;this._vertices[e]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},n._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&t<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},n._burst=function(t,e){for(var n=0,i=this._emission._bursts,r=i.length;this._burstsIndex<r;this._burstsIndex++){var a=i[this._burstsIndex],s=a.time;if(!(t<=s&&s<e))break;var o=0;this.autoRandomSeed?o=MathUtil.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=MathUtil.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),n+=o}return n},n._advanceTime=function(t,e){var n=0,i=this._emissionTime;this._emissionTime+=t;var r=0;if(this._emissionTime>this.duration){if(!this.looping){for(this._isPlaying=!1,r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(e);return void this.event("stopped")}r+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(i,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(e);var a=this.emission.emissionRate;if(a>0){var s=1/a;for(this._frameRateTime+=s,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=e&&this.emit(this._frameRateTime);)this._frameRateTime+=s;this._frameRateTime=Math.floor(e/s)*s}},n._initBufferDatas=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose());var t=this._ownerRender,e=t.renderMode;if(-1!==e&&this.maxParticles>0){var n,i,r=0,a=0,s=0,o=0,l=0,h=t.mesh;if(4===e){if(h){var _=h._vertexBuffers.length;if(_>1)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");i=VertexShurikenParticleMesh.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=h._vertexBuffers[0].vertexCount;var u=this._bufferMaxParticles*this._vertexStride,c=Math.floor(u/65535)+1,d=u%65535;if(c>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");this._vertexBuffer=VertexBuffer3D.create(i,d,35048),this._vertices=new Float32Array(this._floatCountPerVertex*d),this._indexStride=h._indexBuffer.indexCount;var f=h._indexBuffer.getData(),m=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=IndexBuffer3D.create("ushort",m,35044),n=new Uint16Array(m),o=0,r=0;r<this._bufferMaxParticles;r++){var p=r*this._vertexStride;for(a=0,s=f.length;a<s;a++)n[o++]=p+f[a]}this._indexBuffer.setData(n)}}else{for(i=VertexShurikenParticleBillboard.vertexDeclaration,this._floatCountPerVertex=i.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,this._vertexBuffer=VertexBuffer3D.create(i,this._bufferMaxParticles*this._vertexStride,35048),this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),r=0;r<this._bufferMaxParticles;r++)l=r*this._floatCountPerVertex*this._vertexStride,this._vertices[l]=-.5,this._vertices[l+1]=-.5,this._vertices[l+2]=0,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=-.5,this._vertices[l+2]=1,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=.5,this._vertices[l+2]=1,this._vertices[l+3]=0,l+=this._floatCountPerVertex,this._vertices[l]=-.5,this._vertices[l+1]=.5,this._vertices[l+2]=0,this._vertices[l+3]=0;for(this._indexStride=6,this._indexBuffer=IndexBuffer3D.create("ushort",6*this._bufferMaxParticles,35044),n=new Uint16Array(6*this._bufferMaxParticles),r=0;r<this._bufferMaxParticles;r++){o=6*r;var g=r*this._vertexStride,v=g+2;n[o++]=g,n[o++]=v,n[o++]=g+1,n[o++]=g,n[o++]=g+3,n[o++]=v}this._indexBuffer.setData(n)}}},n._destroy=function(){t.prototype._destroy.call(this),this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.dispose(),this._indexBuffer.dispose(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},n.emit=function(t){var n=e._tempPosition,i=e._tempDirection;if(this._shape&&this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(n,i):this._shape.generatePositionAndDirection(n,i,this._rand,this._randomSeeds);else{var r=n.elements,a=i.elements;r[0]=r[1]=r[2]=0,a[0]=a[1]=0,a[2]=1}return this.addParticle(n,i,t)},n.addParticle=function(t,e,n){Vector3.normalize(e,e);var i=this._firstFreeElement+1;if(i>=this._bufferMaxParticles&&(i=0),i===this._firstRetiredElement)return!1;if(ShurikenParticleData.create(this,this._ownerRender,this._owner.transform),this._currentTime-n>=ShurikenParticleData.startLifeTime)return!0;var r=NaN,a=NaN,s=NaN,o=NaN,l=NaN,h=NaN,_=NaN,u=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(u){var c=this._velocityOverLifetime.velocity.type;2===c||3===c?this.autoRandomSeed?(r=Math.random(),a=Math.random(),s=Math.random()):(this._rand.seed=this._randomSeeds[9],r=this._rand.getFloat(),a=this._rand.getFloat(),s=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):u=!1}else u=!1;var d=this._colorOverLifetime&&this._colorOverLifetime.enbale;if(d){3===this._colorOverLifetime.color.type?this.autoRandomSeed?o=Math.random():(this._rand.seed=this._randomSeeds[10],o=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):d=!1}else d=!1;var f=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;if(f){3===this._sizeOverLifetime.size.type?this.autoRandomSeed?l=Math.random():(this._rand.seed=this._randomSeeds[11],l=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):f=!1}else f=!1;var m=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(m){var p=this._rotationOverLifetime.angularVelocity.type;2===p||3===p?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[12],h=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):m=!1}else m=!1;var g=this._textureSheetAnimation&&this._textureSheetAnimation.enable;if(g){3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?_=Math.random():(this._rand.seed=this._randomSeeds[15],_=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):g=!1}else g=!1;var v,x=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,S=ShurikenParticleData.startUVInfo[0],T=ShurikenParticleData.startUVInfo[1],E=ShurikenParticleData.startUVInfo[2],y=ShurikenParticleData.startUVInfo[3],M=t.elements,D=e.elements,C=0,R=0,A=0,b=0,I=0,w=this._ownerRender;if(4===w.renderMode){var V=w.mesh._vertexBuffers[0];v=V.getData();var L=V.vertexDeclaration;R=L.getVertexElementByUsage(0).offset/4;var P=L.getVertexElementByUsage(1);A=P?P.offset/4:-1;var N=L.getVertexElementByUsage(2);b=N?N.offset/4:-1,C=L.vertexStride/4,I=0}else{this._vertices[x+2]=E,this._vertices[x+3]=y+T;var O=x+this._floatCountPerVertex;this._vertices[O+2]=E+S,this._vertices[O+3]=y+T;var F=O+this._floatCountPerVertex;this._vertices[F+2]=E+S,this._vertices[F+3]=y;var B=F+this._floatCountPerVertex;this._vertices[B+2]=E,this._vertices[B+3]=y}for(var U=x,G=x+this._floatCountPerVertex*this._vertexStride;U<G;U+=this._floatCountPerVertex){var H=0;if(4===w.renderMode){H=U;var W=C*I++,k=W+R;this._vertices[H++]=v[k++],this._vertices[H++]=v[k++],this._vertices[H++]=v[k],-1===A?(this._vertices[H++]=1,this._vertices[H++]=1,this._vertices[H++]=1,this._vertices[H++]=1):(k=W+A,this._vertices[H++]=v[k++],this._vertices[H++]=v[k++],this._vertices[H++]=v[k++],this._vertices[H++]=v[k]),-1===A?(this._vertices[H++]=0,this._vertices[H++]=0):(k=W+b,this._vertices[H++]=E+v[k++]*S,this._vertices[H++]=y+v[k]*T)}else H=U+4;switch(this._vertices[H++]=M[0],this._vertices[H++]=M[1],this._vertices[H++]=M[2],this._vertices[H++]=ShurikenParticleData.startLifeTime,this._vertices[H++]=D[0],this._vertices[H++]=D[1],this._vertices[H++]=D[2],this._vertices[H++]=n,this._vertices[H++]=ShurikenParticleData.startColor[0],this._vertices[H++]=ShurikenParticleData.startColor[1],this._vertices[H++]=ShurikenParticleData.startColor[2],this._vertices[H++]=ShurikenParticleData.startColor[3],this._vertices[H++]=ShurikenParticleData.startSize[0],this._vertices[H++]=ShurikenParticleData.startSize[1],this._vertices[H++]=ShurikenParticleData.startSize[2],this._vertices[H++]=ShurikenParticleData.startRotation[0],this._vertices[H++]=ShurikenParticleData.startRotation[1],this._vertices[H++]=ShurikenParticleData.startRotation[2],this._vertices[H++]=ShurikenParticleData.startSpeed,d&&(this._vertices[H+1]=o),f&&(this._vertices[H+2]=l),m&&(this._vertices[H+3]=h),g&&(this._vertices[H+4]=_),u&&(this._vertices[H+5]=r,this._vertices[H+6]=a,this._vertices[H+7]=s),this.simulationSpace){case 0:H+=8,this._vertices[H++]=ShurikenParticleData.simulationWorldPostion[0],this._vertices[H++]=ShurikenParticleData.simulationWorldPostion[1],this._vertices[H++]=ShurikenParticleData.simulationWorldPostion[2],this._vertices[H++]=ShurikenParticleData.simulationWorldRotation[0],this._vertices[H++]=ShurikenParticleData.simulationWorldRotation[1],this._vertices[H++]=ShurikenParticleData.simulationWorldRotation[2],this._vertices[H++]=ShurikenParticleData.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=i,!0},n.addNewParticlesToVertexBuffer=function(){var t=0;this._firstNewElement<this._firstFreeElement?(t=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(t=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},n._beforeRender=function(t){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0)},n._render=function(t){var e=0,n=WebGL.mainContext;this._firstActiveElement<this._firstFreeElement?(e=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,n.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),Stat.trianglesFaces+=e/3,Stat.drawCall++):(e=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,n.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),Stat.trianglesFaces+=e/3,Stat.drawCall++,this._firstFreeElement>0&&(e=this._firstFreeElement*this._indexStride,n.drawElements(4,e,5123,0),Stat.trianglesFaces+=e/3,Stat.drawCall++))},n.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var t=0,n=this._randomSeeds.length;t<n;t++)this._randomSeeds[t]=this.randomSeed[0]+e._RANDOMOFFSET[t];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime+=this._playStartDelay,this._startUpdateLoopCount=Stat.loopCount,this.event("played")},n.pause=function(){this._isPaused=!0,this.event("paused")},n.simulate=function(t,e){void 0===e&&(e=!0),this._simulateUpdate=!0,e?this._updateParticlesSimulationRestart(t):(this._isPaused=!1,this._updateParticles(t)),this.pause()},n.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0,this.event("stopped")},n.cloneTo=function(t){var e=t;e.duration=this.duration,e.looping=this.looping,e.prewarm=this.prewarm,e.startDelayType=this.startDelayType,e.startDelay=this.startDelay,e.startDelayMin=this.startDelayMin,e.startDelayMax=this.startDelayMax,e._maxStartLifetime=this._maxStartLifetime,e.startLifetimeType=this.startLifetimeType,e.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(e.startLifeTimeGradient),e.startLifetimeConstantMin=this.startLifetimeConstantMin,e.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(e.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(e.startLifeTimeGradientMax),e.startSpeedType=this.startSpeedType,e.startSpeedConstant=this.startSpeedConstant,e.startSpeedConstantMin=this.startSpeedConstantMin,e.startSpeedConstantMax=this.startSpeedConstantMax,e.threeDStartSize=this.threeDStartSize,e.startSizeType=this.startSizeType,e.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(e.startSizeConstantSeparate),e.startSizeConstantMin=this.startSizeConstantMin,e.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(e.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(e.startSizeConstantMaxSeparate),e.threeDStartRotation=this.threeDStartRotation,e.startRotationType=this.startRotationType,e.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(e.startRotationConstantSeparate),e.startRotationConstantMin=this.startRotationConstantMin,e.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(e.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(e.startRotationConstantMaxSeparate),e.randomizeRotationDirection=this.randomizeRotationDirection,e.startColorType=this.startColorType,this.startColorConstant.cloneTo(e.startColorConstant),this.startColorConstantMin.cloneTo(e.startColorConstantMin),this.startColorConstantMax.cloneTo(e.startColorConstantMax),e.gravityModifier=this.gravityModifier,e.simulationSpace=this.simulationSpace,e.scaleMode=this.scaleMode,e.playOnAwake=this.playOnAwake,e.maxParticles=this.maxParticles,this._emission&&(e._emission=this._emission.clone()),this.shape&&(e.shape=this.shape.clone()),this.velocityOverLifetime&&(e.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(e.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(e.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(e.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(e.textureSheetAnimation=this.textureSheetAnimation.clone()),e.isPerformanceMode=this.isPerformanceMode,e._isEmitting=this._isEmitting,e._isPlaying=this._isPlaying,e._isPaused=this._isPaused,e._playStartDelay=this._playStartDelay,e._frameRateTime=this._frameRateTime,e._emissionTime=this._emissionTime,e._totalDelayTime=this._totalDelayTime,e._burstsIndex=this._burstsIndex},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},n._renderRuntime=function(t,e,n){},__getset(0,n,"_originalBoundingBoxCorners",function(){return this._boundingBoxCorners}),__getset(0,n,"_originalBoundingBox",function(){return this._boundingBox}),__getset(0,n,"_originalBoundingSphere",function(){return this._boundingSphere}),__getset(0,n,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(t){var e=this._ownerRender;if(t){var n=t.frame,i=n.type;if(t.enable)switch(i){case 1:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE)}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===i||3===i){e._setShaderValueInt(48,t.cycles);var r=t.tiles,a=this._uvLength.elements;a[0]=1/r.x,a[1]=1/r.y,e._setShaderValueVector2(49,this._uvLength)}switch(i){case 1:e._setShaderValueBuffer(50,n.frameOverTimeData._elements);break;case 3:e._setShaderValueBuffer(50,n.frameOverTimeDataMin._elements),e._setShaderValueBuffer(51,n.frameOverTimeDataMax._elements)}}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),e._setShaderValueInt(48,void 0),e._setShaderValueVector2(49,null),e._setShaderValueBuffer(50,null),e._setShaderValueBuffer(51,null);this._textureSheetAnimation=t}),__getset(0,n,"colorOverLifetime",function(){return this._colorOverLifetime},function(t){var e=this._ownerRender;if(t){var n=t.color;if(t.enbale)switch(n.type){case 1:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:
e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var i=n.gradient;e._setShaderValueBuffer(22,i._alphaElements),e._setShaderValueBuffer(23,i._rgbElements);break;case 3:var r=n.gradientMin,a=n.gradientMax;e._setShaderValueBuffer(22,r._alphaElements),e._setShaderValueBuffer(23,r._rgbElements),e._setShaderValueBuffer(24,a._alphaElements),e._setShaderValueBuffer(25,a._rgbElements)}}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),e._setShaderValueBuffer(22,i._alphaElements),e._setShaderValueBuffer(23,i._rgbElements),e._setShaderValueBuffer(22,r._alphaElements),e._setShaderValueBuffer(23,r._rgbElements),e._setShaderValueBuffer(24,a._alphaElements),e._setShaderValueBuffer(25,a._rgbElements);this._colorOverLifetime=t}),__getset(0,n,"_vertexBufferCount",function(){return 1}),__getset(0,n,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(t){var e=this._ownerRender;if(t){var n=t.angularVelocity;if(!n)return;var i=n.separateAxes,r=n.type;if(t.enbale)switch(i?e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:i?e._setShaderValueColor(35,n.constantSeparate):e._setShaderValueNumber(34,n.constant);break;case 1:i?(e._setShaderValueBuffer(37,n.gradientX._elements),e._setShaderValueBuffer(38,n.gradientY._elements),e._setShaderValueBuffer(39,n.gradientZ._elements),e._setShaderValueBuffer(40,n.gradientW._elements)):e._setShaderValueBuffer(36,n.gradient._elements);break;case 2:i?(e._setShaderValueColor(35,n.constantMinSeparate),e._setShaderValueColor(42,n.constantMaxSeparate)):(e._setShaderValueNumber(34,n.constantMin),e._setShaderValueNumber(41,n.constantMax));break;case 3:i?(e._setShaderValueBuffer(37,n.gradientXMin._elements),e._setShaderValueBuffer(44,n.gradientXMax._elements),e._setShaderValueBuffer(38,n.gradientYMin._elements),e._setShaderValueBuffer(45,n.gradientYMax._elements),e._setShaderValueBuffer(39,n.gradientZMin._elements),e._setShaderValueBuffer(46,n.gradientZMax._elements),e._setShaderValueBuffer(40,n.gradientWMin._elements),e._setShaderValueBuffer(47,n.gradientWMax._elements)):(e._setShaderValueBuffer(36,n.gradientMin._elements),e._setShaderValueBuffer(43,n.gradientMax._elements))}}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),e._setShaderValueColor(35,null),e._setShaderValueColor(42,null),e._setShaderValueNumber(34,void 0),e._setShaderValueNumber(41,void 0),e._setShaderValueBuffer(37,null),e._setShaderValueBuffer(44,null),e._setShaderValueBuffer(38,null),e._setShaderValueBuffer(45,null),e._setShaderValueBuffer(39,null),e._setShaderValueBuffer(46,null),e._setShaderValueBuffer(40,null),e._setShaderValueBuffer(47,null),e._setShaderValueBuffer(36,null),e._setShaderValueBuffer(43,null);this._rotationOverLifetime=t}),__getset(0,n,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax},function(t){if(3===this._startLifetimeType){var e=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,e=0,n=this._startLifeTimeGradientMin.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(e));for(e=0,n=t.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,t.getValueByIndex(e))}this._startLifeTimeGradientMax=t}),__getset(0,n,"isPaused",function(){return this._isPaused}),__getset(0,n,"startLifetimeType",function(){return this._startLifetimeType},function(t){var e=0,n=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(e=0,n=i.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(e));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var r=r;for(e=0,n=r.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(e));var a=a;for(e=0,n=a.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(e))}this._startLifetimeType=t}),__getset(0,n,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax},function(t){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,t)),this._startLifetimeConstantMax=t}),__getset(0,n,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),__getset(0,n,"startLifeTimeGradient",function(){return this._startLifeTimeGradient},function(t){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var e=0,n=t.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,t.getValueByIndex(e))}this._startLifeTimeGradient=t}),__getset(0,n,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin},function(t){if(3===this._startLifetimeType){var e=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,e=0,n=t.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,t.getValueByIndex(e));for(e=0,n=this._startLifeTimeGradientMax.gradientCount;e<n;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(e))}this._startLifeTimeGradientMin=t}),__getset(0,n,"isAlive",function(){return!!(this._isPlaying||this.aliveParticleCount>0)}),__getset(0,n,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(t){var e=this._ownerRender;if(t){var n=t.size,i=n.separateAxes,r=n.type;if(t.enbale)switch(r){case 0:i?e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:i?(e._setShaderValueBuffer(27,n.gradientX._elements),e._setShaderValueBuffer(28,n.gradientY._elements),e._setShaderValueBuffer(29,n.gradientZ._elements)):e._setShaderValueBuffer(26,n.gradient._elements);break;case 2:i?(e._setShaderValueBuffer(27,n.gradientXMin._elements),e._setShaderValueBuffer(31,n.gradientXMax._elements),e._setShaderValueBuffer(28,n.gradientYMin._elements),e._setShaderValueBuffer(32,n.gradientYMax._elements),e._setShaderValueBuffer(29,n.gradientZMin._elements),e._setShaderValueBuffer(33,n.gradientZMax._elements)):(e._setShaderValueBuffer(26,n.gradientMin._elements),e._setShaderValueBuffer(30,n.gradientMax._elements))}}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),e._setShaderValueBuffer(27,null),e._setShaderValueBuffer(31,null),e._setShaderValueBuffer(28,null),e._setShaderValueBuffer(32,null),e._setShaderValueBuffer(29,null),e._setShaderValueBuffer(33,null),e._setShaderValueBuffer(26,null),e._setShaderValueBuffer(30,null);this._sizeOverLifetime=t}),__getset(0,n,"isPlaying",function(){return this._isPlaying}),__getset(0,n,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(t){var e=this._ownerRender;if(t){var n=t.velocity,i=n.type;if(t.enbale)switch(i){case 0:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:e._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:e._setShaderValueColor(13,n.constant);break;case 1:e._setShaderValueBuffer(14,n.gradientX._elements),e._setShaderValueBuffer(15,n.gradientY._elements),e._setShaderValueBuffer(16,n.gradientZ._elements);break;case 2:e._setShaderValueColor(13,n.constantMin),e._setShaderValueColor(17,n.constantMax);break;case 3:e._setShaderValueBuffer(14,n.gradientXMin._elements),e._setShaderValueBuffer(18,n.gradientXMax._elements),e._setShaderValueBuffer(15,n.gradientYMin._elements),e._setShaderValueBuffer(19,n.gradientYMax._elements),e._setShaderValueBuffer(16,n.gradientZMin._elements),e._setShaderValueBuffer(20,n.gradientZMax._elements)}e._setShaderValueInt(21,t.space)}else e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),e._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),e._setShaderValueColor(13,null),e._setShaderValueBuffer(14,null),e._setShaderValueBuffer(15,null),e._setShaderValueBuffer(16,null),e._setShaderValueColor(13,null),e._setShaderValueColor(17,null),e._setShaderValueBuffer(14,null),e._setShaderValueBuffer(18,null),e._setShaderValueBuffer(15,null),e._setShaderValueBuffer(19,null),e._setShaderValueBuffer(16,null),e._setShaderValueBuffer(20,null),e._setShaderValueInt(21,void 0);this._velocityOverLifetime=t}),__getset(0,n,"isEmitting",function(){return this._isEmitting}),__getset(0,n,"startLifetimeConstant",function(){return this._startLifetimeConstant},function(t){0===this._startLifetimeType&&(this._maxStartLifetime=t),this._startLifetimeConstant=t}),__getset(0,n,"triangleCount",function(){return this._indexBuffer?this._indexBuffer.indexCount/3:0}),__getset(0,n,"shape",function(){return this._shape},function(t){this._shape!==t&&(t&&t.enable?this._ownerRender._addShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SHAPE):this._ownerRender._removeShaderDefine(ShuriKenParticle3D.SHADERDEFINE_SHAPE),this._shape=t)}),__getset(0,n,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),__getset(0,n,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin},function(t){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(t,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=t}),__getset(0,n,"emission",function(){return this._emission}),__getset(0,n,"maxParticles",function(){return this._bufferMaxParticles-1},function(t){var e=t+1;e!==this._bufferMaxParticles&&(this._bufferMaxParticles=e,this._initBufferDatas())}),e.halfKSqrtOf2=.71,__static(e,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempVector34",function(){return this._tempVector34=new Vector3},"_tempVector35",function(){return this._tempVector35=new Vector3},"_tempVector36",function(){return this._tempVector36=new Vector3},"_tempVector37",function(){return this._tempVector37=new Vector3},"_tempVector38",function(){return this._tempVector38=new Vector3},"_tempVector39",function(){return this._tempVector39=new Vector3},"_tempPosition",function(){return this._tempPosition=new Vector3},"_tempDirection",function(){return this._tempDirection=new Vector3}]),e}(GeometryFilter),GlitterRender=function(t){function e(t){e.__super.call(this,t)}__class(e,"laya.d3.core.GlitterRender",t);var n=e.prototype;return n._calculateBoundingBox=function(){var t=this._boundingBox.min.elements;t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;var e=this._boundingBox.min.elements;e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},n._renderUpdate=function(t){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var e=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,e);var n=this._owner.templet;this._setShaderValueNumber(3,n.lifeTime),this._setShaderValueNumber(2,n._currentTime)},e}(BaseRender),MeshRender=function(t){function e(t){e.__super.call(this,t),t.meshFilter.on("meshchanged",this,this._onMeshChanged)}__class(e,"laya.d3.core.MeshRender",t);var n=e.prototype;return n._onMeshChanged=function(t,e,n){n.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:n.once("loaded",this,this._onMeshLoaed)},n._onMeshLoaed=function(t,e){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},n._calculateBoundingSphereByInitSphere=function(t){var e=NaN,n=this._owner.transform,i=n.scale.elements,r=Math.abs(i[0]),a=Math.abs(i[1]),s=Math.abs(i[2]);e=r>=a&&r>=s?r:a>=s?a:s,Vector3.transformCoordinate(t.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*e},n._calculateBoundBoxByInitCorners=function(t){for(var e=this._owner.transform.worldMatrix,n=0;n<8;n++)Vector3.transformCoordinate(t[n],e,BaseRender._tempBoundBoxCorners[n]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox)},n._calculateBoundingSphere=function(){var t=this._owner.meshFilter.sharedMesh;null==t||null==t.boundingSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(t.boundingSphere)},n._calculateBoundingBox=function(){var t=this._owner.meshFilter.sharedMesh;null==t||null==t.boundingBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(t.boundingBoxCorners)},n._renderUpdate=function(t){var e=this._owner.transform;if(e){this._setShaderValueMatrix4x4(0,e.worldMatrix);var n=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,n)}else this._setShaderValueMatrix4x4(0,Matrix4x4.DEFAULT),this._setShaderValueMatrix4x4(1,t);Laya3D.debugMode&&this._renderRenderableBoundBox()},e}(BaseRender),TerrainFilter=function(t){function e(t,n,i,r,a,s,o,l){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._boundingSphere=null,this._boundingBox=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,e.__super.call(this),this._owner=t,this._cameraPos=new Vector3,this._chunkOffsetX=n,this._chunkOffsetZ=i,this._gridSize=r,this._terrainHeightData=a,this._terrainHeightDataWidth=s,this._terrainHeightDataHeight=o,this._leafNum=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM),this._leafs=__newvec(this._leafNum),this._cameraCoordinateInverse=l;for(var h=0;h<this._leafNum;h++)this._leafs[h]=new TerrainLeaf;this.recreateResource()}__class(e,"laya.d3.terrain.TerrainFilter",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._destroy=function(){t.prototype._destroy.call(this),this._owner=null,this._vertexBuffer&&this._vertexBuffer.dispose(),this._indexBuffer&&this._indexBuffer.dispose()},n.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;var t=TerrainLeaf.LEAF_VERTEXT_COUNT,e=TerrainLeaf.LEAF_MAX_INDEX_COUNT;this._numberVertices=t*this._leafNum,this._maxNumberIndices=e*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices);var n=VertexPositionTerrain.vertexDeclaration,i=n.vertexStride/4,r=new Float32Array(this._numberVertices*i),a=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM,s=0,o=0,l=0;for(s=0;s<this._leafNum;s++)o=s%a,l=Math.floor(s/a),this._leafs[s].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*TerrainLeaf.LEAF_GRID_NUM,l*TerrainLeaf.LEAF_GRID_NUM,this._gridSize,r,s*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT,i,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(s=0;s<this._leafNum;s++)o=s%a,l=Math.floor(s/a),this._leafs[s].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*TerrainLeaf.LEAF_GRID_NUM,l*TerrainLeaf.LEAF_GRID_NUM,this._gridSize,r,this._leafNum*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT+s*TerrainLeaf.LEAF_SKIRT_VERTEXT_COUNT,i,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new VertexBuffer3D(n,this._numberVertices,35044,!1),this._indexBuffer=new IndexBuffer3D("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(r),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.calcOriginalBoudingBoxAndSphere()},n.setLODLevel=function(t){if(4!=t.length)return!0;var e=(t[0]+1<<24)+(t[1]+1<<16)+(t[2]+1<<8)+(t[3]+1);return this._currentLOD!=e&&(this._currentLOD=e,!0)},n.assembleIndexInit=function(){this._currentNumberIndices=0,this._numberTriangle=0;for(var t=0,e=0;e<this._leafNum;e++){var n=TerrainLeaf.getPlaneLODIndex(e,0);this._indexArrayBuffer.set(n,t),t+=n.length;var i=TerrainLeaf.getSkirtLODIndex(e,0);this._indexArrayBuffer.set(i,t),t+=i.length,this._currentNumberIndices+=n.length+i.length}this._numberTriangle=this._currentNumberIndices/3},n.isNeedAssemble=function(t,e){var n=Math.min(t.viewport.width,t.viewport.height)/(2*Math.tan(Math.PI*t.fieldOfView/180));return this._perspectiveFactor!=n?(this._perspectiveFactor=n,1):this._LODTolerance!=Terrain.LOD_TOLERANCE_VALUE?(this._LODTolerance=Terrain.LOD_TOLERANCE_VALUE,1):0==Vector3.equals(e,this._cameraPos)?(this._cameraPos.x=e.x,this._cameraPos.y=e.y,this._cameraPos.z=e.z,2):0},n.assembleIndex=function(t,n){var i=this.isNeedAssemble(t,n);if(i>0){for(var r=0;r<this._leafNum;r++)e._TEMP_ARRAY_BUFFER[r]=this._leafs[r].determineLod(n,this._perspectiveFactor,Terrain.LOD_TOLERANCE_VALUE,1==i);if(this.setLODLevel(e._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0,this._numberTriangle=0;var a=0;for(r=0;r<this._leafNum;r++){var s=e._TEMP_ARRAY_BUFFER[r],o=TerrainLeaf.getPlaneLODIndex(r,s);this._indexArrayBuffer.set(o,a),a+=o.length;var l=TerrainLeaf.getSkirtLODIndex(r,s);this._indexArrayBuffer.set(l,a),a+=l.length,this._currentNumberIndices+=o.length+l.length}return this._numberTriangle=this._currentNumberIndices/3,!0}}return!1},n.calcOriginalBoudingBoxAndSphere=function(){for(var t=new Vector2(2147483647,-2147483647),e=0;e<this._leafNum;e++)t.x=this._leafs[e]._sizeOfY.x<t.x?this._leafs[e]._sizeOfY.x:t.x,t.y=this._leafs[e]._sizeOfY.y>t.y?this._leafs[e]._sizeOfY.y:t.y;var n=new Vector3(this._chunkOffsetX*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize,t.x,this._chunkOffsetZ*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize),i=new Vector3((this._chunkOffsetX+1)*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize,t.y,(this._chunkOffsetZ+1)*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize);TerrainLeaf.__ADAPT_MATRIX__&&(Vector3.transformV3ToV3(n,TerrainLeaf.__ADAPT_MATRIX__,n),Vector3.transformV3ToV3(i,TerrainLeaf.__ADAPT_MATRIX__,i)),this._boundingBox=new BoundBox(n,i);var r=new Vector3;Vector3.subtract(i,n,r),Vector3.scale(r,.5,r);var a=new Vector3;Vector3.add(n,r,a),this._boundingSphere=new BoundSphere(a,Vector3.scalarLength(r)),this._boundingBoxCorners=__newvec(8,null),this._boundingBox.getCorners(this._boundingBoxCorners)},n.calcLeafBoudingBox=function(t){for(var e=0;e<this._leafNum;e++)this._leafs[e].calcLeafBoudingBox(t)},n.calcLeafBoudingSphere=function(t,e){for(var n=0;n<this._leafNum;n++)this._leafs[n].calcLeafBoudingSphere(t,e)},n._getVertexBuffer=function(t){return void 0===t&&(t=0),0==t?this._vertexBuffer:null},n._getIndexBuffer=function(){return this._indexBuffer},n._beforeRender=function(t){if(this._vertexBuffer._bind(),this._indexBuffer._bind(),0==t.renderElement._material.blend){var e=t.camera;this.assembleIndex(e,e.position)&&this._indexBuffer.setData(this._indexArrayBuffer)}return!0},n._render=function(t){WebGL.mainContext.drawElements(Terrain.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),Stat.trianglesFaces+=this._numberTriangle,Stat.drawCall++},n._renderRuntime=function(t,e,n){},__getset(0,n,"_vertexBufferCount",function(){return this._numberVertices}),__getset(0,n,"triangleCount",function(){return this._numberTriangle}),__getset(0,n,"_originalBoundingBox",function(){return this._boundingBox}),__getset(0,n,"_originalBoundingSphere",function(){return this._boundingSphere}),__static(e,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM)}]),e}(GeometryFilter),GlitterTemplet=function(t){function e(t){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.lifeTime=NaN,this.minSegmentDistance=NaN,this.minInterpDistance=NaN,this.maxSlerpCount=0,this._maxSegments=0,e.__super.call(this),this._tempVector0=new Vector3,this._tempVector1=new Vector3,this._tempVector2=new Vector3,this._tempVector3=new Vector3,this._posModeLastPosition0=new Vector3,this._posModeLastPosition1=new Vector3,this._posModePosition0=new Vector3,this._posModePosition1=new Vector3,this._posVelModePosition0=new Vector3,this._posVelModeVelocity0=new Vector3,this._posVelModePosition1=new Vector3,this._posVelModeVelocity1=new Vector3,this._owner=t,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new Vector3,this._lastPatchAddPos1=new Vector3,this.scLeft=new SplineCurvePositionVelocity,this.scRight=new SplineCurvePositionVelocity,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this._maxSegments=200,this._owner.on("activeinhierarchychanged",this,this._onActiveHierarchyChanged)}__class(e,"laya.d3.resource.tempelet.GlitterTemplet",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},n._getIndexBuffer=function(){return null},n._initialize=function(){this._vertexBuffer=VertexBuffer3D.create(VertexGlitter.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},n._onActiveHierarchyChanged=function(t){t||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},n._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},n._updateSubTextureCoordinates=function(t,e){for(var n=2*t,i=0;i<e;i+=2){var r=n+i,a=r*this._floatCountPerVertex,s=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[s+3]=(this._vertices[a+5]-this._currentTime)/this.lifeTime}},n._retireActiveGlitter=function(){for(var t=this.lifeTime,e=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var n=this._firstActiveElement*e+5;if(this._currentTime-this._vertices[n]<t)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},n._freeRetiredGlitter=function(){for(var t=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement;){if(this._drawCounter-this._vertices[this._firstRetiredElement*t+5]<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)}},n._calcVelocity=function(t,e,n){Vector3.subtract(t,e,n),Vector3.scale(n,.5,n)},n._addNewGlitterSegementToVertexBuffer=function(){var t=0;this._firstActiveElement<this._firstFreeElement?(t=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(t=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},n._addGlitter=function(t,e,n){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var i=this._firstFreeElement+1;if(i>=this.maxSegments&&(i=0,t.cloneTo(this._lastPatchAddPos0),e.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=n,this._needPatch=!0),i===this._firstRetiredElement)throw new Error("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=t.elements,a=e.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;s<3;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=n;var l=o+this._floatCountPerVertex;for(s=0;s<3;s++)this._vertices[l+s]=a[s];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=n,this._firstFreeElement=i},n._update=function(t){this._currentTime+=t/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},n._beforeRender=function(t){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer.bindWithIndexBuffer(null),!0)},n._render=function(t){var e=0,n=WebGL.mainContext;this._firstActiveElement<this._firstFreeElement?(e=2*(this._firstFreeElement-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,e),Stat.trianglesFaces+=e-2,Stat.drawCall++):(e=2*(this.maxSegments-this._firstActiveElement),n.drawArrays(5,2*this._firstActiveElement,e),Stat.trianglesFaces+=e-2,Stat.drawCall++,this._firstFreeElement>0&&(e=2*this._firstFreeElement,n.drawArrays(5,0,e),Stat.trianglesFaces+=e-2,Stat.drawCall++))},n.addVertexPosition=function(t,e){if(this._owner.activeInHierarchy)if(this._numPositionMode<2)0===this._numPositionMode?(t.cloneTo(this._posModeLastPosition0),e.cloneTo(this._posModeLastPosition1)):(t.cloneTo(this._posModePosition0),e.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var n=this._tempVector2;this._calcVelocity(t,this._posModeLastPosition0,n);var i=this._tempVector3;this._calcVelocity(e,this._posModeLastPosition1,i),this.addVertexPositionVelocity(this._posModePosition0,n,this._posModePosition1,i),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),t.cloneTo(this._posModePosition0),e.cloneTo(this._posModePosition1)}},n.addVertexPositionVelocity=function(t,e,n,i){if(this._owner.activeInHierarchy){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;Vector3.subtract(t,this._posVelModePosition0,r);var a=Vector3.scalarLength(r);Vector3.subtract(n,this._posVelModePosition1,r);var s=Vector3.scalarLength(r),o=0,l=l;if(a<l&&s<l)return;if(1===(o=1+Math.floor(Math.max(a,s)/this.minInterpDistance)))this._addGlitter(t,n,this._currentTime);else{o=Math.min(o,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,t,e),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,n,i);for(var h=1/o,_=h,u=this._currentTime-this._lastTime,c=1;c<=o;c++){var d=this._tempVector0;this.scLeft.Slerp(_,d);var f=this._tempVector1;this.scRight.Slerp(_,f);var m=this._lastTime+u*c/o;this._addGlitter(d,f,m),_+=h}}}this._lastTime=this._currentTime,t.cloneTo(this._posVelModePosition0),e.cloneTo(this._posVelModeVelocity0),n.cloneTo(this._posVelModePosition1),i.cloneTo(this._posVelModeVelocity1)}},n._destroy=function(){t.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._vertices=null,this._vertexBuffer.dispose(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,
this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null},n._renderRuntime=function(t,e,n){},__getset(0,n,"_originalBoundingSphere",function(){return t.prototype._$get__originalBoundingSphere.call(this)}),__getset(0,n,"_originalBoundingBox",function(){return t.prototype._$get__originalBoundingBox.call(this)}),__getset(0,n,"triangleCount",function(){var t=0;return this._firstActiveElement<this._firstFreeElement?t=2*(this._firstFreeElement-this._firstActiveElement)-2:(t=2*(this.maxSegments-this._firstActiveElement)-2,t+=2*this._firstFreeElement-2),t}),__getset(0,n,"_vertexBufferCount",function(){return 1}),__getset(0,n,"maxSegments",function(){return this._maxSegments-1},function(t){var e=t+1;e!==this._maxSegments&&(this._maxSegments=e,this._vertexBuffer&&this._vertexBuffer.dispose(),this._initialize())}),e}(GeometryFilter),TerrainRender=function(t){function e(t){this._terrainSprite3DOwner=null,e.__super.call(this,t),this._terrainSprite3DOwner=t}__class(e,"laya.d3.terrain.TerrainRender",t);var n=e.prototype;return n._calculateBoundingSphere=function(){var t=this._terrainSprite3DOwner.terrainFilter;if(null==t)this._boundingSphere.toDefault();else{var e=t._originalBoundingSphere,n=NaN,i=this._terrainSprite3DOwner.transform,r=i.scale;n=r.x>=r.y&&r.x>=r.z?r.x:r.y>=r.z?r.y:r.z,Vector3.transformCoordinate(e.center,i.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*n,t.calcLeafBoudingSphere(i.worldMatrix,n)}},n._calculateBoundingBox=function(){var t=this._terrainSprite3DOwner.terrainFilter;if(null==t)this._boundingBox.toDefault();else{for(var e=this._terrainSprite3DOwner.transform.worldMatrix,n=t._boundingBoxCorners,i=0;i<8;i++)Vector3.transformCoordinate(n[i],e,BaseRender._tempBoundBoxCorners[i]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox),t.calcLeafBoudingBox(e)}},n._renderUpdate=function(t){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var e=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,e)},n._destroy=function(){t.prototype._destroy.call(this),this._terrainSprite3DOwner=null},e}(BaseRender),Animator=function(t){function e(){e.__super.call(this),this._clipNames=[],this._clips=[],this._playStartFrames=[],this._playEndFrames=[],this._cacheNodesSpriteOwners=[],this._cacheNodesAvatarOwners=[],this._cacheNodesDefaultlValues=[],this._cacheNodesToSpriteMap=[],this._cacheSpriteToNodesMap=[],this._cacheFullFrames=[],this._publicClipAnimationDatas=[],this._updateTransformPropertyLoopCount=-1,this._lastFrameIndex=-1,this._defaultClipIndex=-1,this._cachePlayRate=1,this._currentPlayClip=null,this._currentFrameIndex=-1,this._currentTime=0,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this.isCache=!0,this.cacheFrameRate=60,this.playbackRate=1,this.playOnWake=!0}__class(e,"laya.d3.component.Animator",t);var n=e.prototype;return Laya.imps(n,{"laya.resource.IDestroy":!0}),n._getAvatarOwnersByClip=function(t){var e=this._clips[t]._nodes,n=e.length,i=this._cacheNodesAvatarOwners[t];i.length=n;var r=this._cacheNodesDefaultlValues[t];r.length=n;for(var a=0;a<n;a++){for(var s=this._avatarRootNode,o=e[a],l=o.path,h=0,_=l.length;h<_;h++){var u=l[h];if(""===u)break;if(!(s=s.getChildByName(u)))break}if(s){i[a]=s;var c=AnimationNode._propertyGetFuncs[o.propertyNameID](s);if(c){var d=new Float32Array(o.keyFrameWidth);for(r[a]=d,h=0,_=c.length;h<_;h++)d[h]=c[h]}}}},n._handleSpriteOwnersByClip=function(t){var e=this._clips[t]._nodes,n=e.length,i=this._cacheNodesSpriteOwners[t];i.length=n;var r=this._cacheNodesDefaultlValues[t];r.length=n;for(var a=0;a<n;a++){var s=this._owner,o=e[a],l=o.path,h=0,_=0;for(h=0,_=l.length;h<_;h++){var u=l[h];if(""===u)break;if(!(s=s.getChildByName(u)))break}if(s){i[a]=s;var c=AnimationNode._propertyGetFuncs[o.propertyNameID](null,s);if(c){var d=new Float32Array(o.keyFrameWidth);for(r[a]=d,h=0,_=c.length;h<_;h++)d[h]=c[h]}}}},n._offClipAndAvatarRelateEvent=function(t,e){t.loaded?e.loaded||e.off("loaded",this,this._getAvatarOwnersByClip):t.off("loaded",this,this._getAvatarOwnersAndInitDatasAsync)},n._getAvatarOwnersByClipAsync=function(t,e){e.loaded?this._getAvatarOwnersByClip(t):e.once("loaded",this,this._getAvatarOwnersByClip,[t])},n._offGetSpriteOwnersByClipAsyncEvent=function(t){t.loaded||t.off("loaded",this,this._getSpriteOwnersByClipAsync)},n._getSpriteOwnersByClipAsync=function(t,e){e.loaded?this._handleSpriteOwnersByClip(t):e.once("loaded",this,this._handleSpriteOwnersByClip,[t])},n._getAvatarOwnersAndInitDatasAsync=function(){for(var t=0,e=this._clips.length;t<e;t++)this._getAvatarOwnersByClipAsync(t,this._clips[t]);this._avatar._cloneDatasToAnimator(this);var n=this._avatarNodes.length;for(this._publicAvatarAnimationDatas=[],this._publicAvatarAnimationDatas.length=n,t=0;t<n;t++)this._publicAvatarAnimationDatas[t]=new Matrix4x4;for(t=0,e=this._avatarNodes.length;t<e;t++)this._checkAnimationNode(this._avatarNodes[t],this._owner)},n._offGetClipCacheFullKeyframeIndicesEvent=function(t){t.loaded||t.off("loaded",this,this._computeCacheFullKeyframeIndices)},n._computeCacheFullKeyframeIndices=function(t){var e=this._clips[t],n=this._cacheFrameRateInterval*this._cachePlayRate,i=e._getFullKeyframeIndicesWithCache(n);if(i)return void(this._cacheFullFrames[t]=i);i=this._cacheFullFrames[t]=[];var r=e._nodes,a=r.length;i.length=a;for(var s=Math.ceil(e._duration/n+1e-5)+1,o=0;o<a;o++){for(var l=r[o],h=new Int32Array(s),_=-1,u=l.keyFrames,c=0,d=u.length;c<d;c++){var f=u[c],m=f.startTime,p=m+f.duration;do{for(var g=Math.ceil(m/n-1e-5),v=_+1;v<g;v++)h[v]=-1;h[g]=c,_=g,m+=n}while(m<p)}i[o]=h}e._cacheFullKeyframeIndices(n,i)},n._updateAnimtionPlayer=function(){this._updatePlayer(Laya.timer.delta/1e3)},n._onOwnerActiveHierarchyChanged=function(){this._owner.activeInHierarchy?(Laya.timer.frameLoop(1,this,this._updateAnimtionPlayer),this.playOnWake&&this.clip&&this.play()):(0!==this.playState&&this.stop(),Laya.timer.clear(this,this._updateAnimtionPlayer))},n._setPlayParams=function(t,e){this._currentTime=t,this._currentFrameIndex=Math.floor(this.currentPlayTime/e+1e-5),this._currentFrameTime=this._currentFrameIndex*e},n._setPlayParamsWhenStop=function(t,e){this._currentTime=t,this._currentFrameIndex=Math.floor(t/e+1e-5),this._currentFrameTime=this._currentFrameIndex*e,this._currentPlayClip=null},n._revertKeyframeNodes=function(t,e){if(this._avatar)for(var n=this._cacheNodesDefaultlValues[e],i=t._nodes,r=this._cacheNodesAvatarOwners[e],a=0,s=r.length;a<s;a++){var o=r[a];o&&AnimationNode._propertySetFuncs[i[a].propertyNameID](o,null,n[a])}},n._onAnimationStop=function(){var t,e,n,i=0,r=0;this._lastFrameIndex=-1;var a=this._currentPlayClip._nodes;if(this._avatar){var s=this._cacheNodesAvatarOwners[this._currentPlayClipIndex];for(i=0,r=s.length;i<r;i++){var o=s[i];t=a[i],e=t.keyFrames,n=e[e.length-1].data,o&&AnimationNode._propertySetFuncs[t.propertyNameID](o,null,n)}}else{var l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];for(i=0,r=l.length;i<r;i++){var h=l[i];t=a[i],e=t.keyFrames,n=e[e.length-1].data,h&&AnimationNode._propertySetFuncs[t.propertyNameID](null,h,n)}}},n._setAnimationClipPropertyToAnimationNode=function(t,e,n){for(var i=0,r=e.length;i<r;i++){var a=e[i],s=t[a];if(s){var o=this._currentPlayClip._nodes[a],l=n[a];l&&AnimationNode._propertySetFuncs[o.propertyNameID](s,null,l)}}},n._setAnimationClipPropertyToSprite3D=function(t,e){for(var n=0,i=t.length;n<i;n++){var r=t[n];if(r){var a=this._currentPlayClip._nodes[n],s=e[n];s&&AnimationNode._propertySetFuncs[a.propertyNameID](null,r,s)}}},n._handleSpriteOwnersBySprite=function(t,e,n,i){var r=this._clips[t],a=n.join("/"),s=r._nodesMap[a];if(s)for(var o=this._cacheNodesSpriteOwners[t],l=r._nodes,h=this._cacheNodesDefaultlValues[t],_=0,u=s.length;_<u;_++){var c=s[_],d=l.indexOf(c);if(e){o[d]=i;var f=AnimationNode._propertyGetFuncs[c.propertyNameID](null,i);if(f){var m=h[d];m||(h[d]=m=new Float32Array(c.keyFrameWidth));for(var p=0,g=f.length;p<g;p++)m[p]=f[p]}}else o[d]=null}},n._updateAvatarNodesCacheMode=function(t,e,n){for(var i=!0,r=0,a=this._cacheSpriteToNodesMap.length;r<a;r++){var s=this._cacheSpriteToNodesMap[r],o=n[s];if(!o&&i){var l=this._publicClipAnimationDatas[this._currentPlayClipIndex],h=e._unCachePropertyToNodeMap;e._evaluateAnimationlDatasCacheMode(t,this._cacheFullFrames[this._currentPlayClipIndex],this,l,h),this._setAnimationClipPropertyToAnimationNode(t,h,l),this._updateTransformPropertyLoopCount=Stat.loopCount,i=!1}var _,u,c=this._avatarNodes[s],d=c._transform;o?o!==Matrix4x4.NAN&&(_=c._transform._entity,u=_.worldMatrix,Matrix4x4.multiply(this._owner._transform.worldMatrix,o,u),_.worldMatrix=u):d._worldUpdate?(o=new Matrix4x4,n[s]=o,d._setWorldMatrixAndUpdate(o),_=c._transform._entity,u=_.worldMatrix,Matrix4x4.multiply(this._owner._transform.worldMatrix,o,u),_.worldMatrix=u):n[s]=Matrix4x4.NAN}},n._updateAvatarNodesRealTime=function(t){for(var e=0,n=this._cacheSpriteToNodesMap.length;e<n;e++){var i=this._avatarNodes[this._cacheSpriteToNodesMap[e]],r=i._transform._entity,a=i._transform;if(a._worldUpdate){var s=t[e];a._setWorldMatrixAndUpdate(s);var o=r.worldMatrix;Matrix4x4.multiply(this._owner._transform.worldMatrix,s,o),r.worldMatrix=o}}},n._updatePlayer=function(t){if(null!=this._currentPlayClip&&!this._stoped&&this._currentPlayClip.loaded){var e=this._cacheFrameRateInterval*this._cachePlayRate,n=0;this._startUpdateLoopCount!==Stat.loopCount&&(n=t*this.playbackRate,this._elapsedPlaybackTime+=n);var i=this._currentPlayClip._frameRate,r=this._playStartFrames[this._currentPlayClipIndex]/i,a=Math.min(this._playEndFrames[this._currentPlayClipIndex]/i,this._currentPlayClip._duration),s=a-r;if(!this._currentPlayClip.islooping&&this._elapsedPlaybackTime>=s)return this._onAnimationStop(),this._setPlayParamsWhenStop(s,e),void this.event("stopped");if(n+=this._currentTime,s>0)if(n>=s)do{if(n-=s,this._stopWhenCircleFinish)return this._stopWhenCircleFinish=!1,this._onAnimationStop(),this._setPlayParamsWhenStop(s,e),void this.event("stopped");n<s&&(this._setPlayParams(n,e),this.event("complete"))}while(n>=s);else this._setPlayParams(n,e);else{if(this._stopWhenCircleFinish)return this._stopWhenCircleFinish=!1,this._onAnimationStop(),this._setPlayParamsWhenStop(s,e),void this.event("stopped");this._currentTime=this._currentFrameTime=this._currentFrameIndex=0,this.event("complete")}}},n._updateTansformProperty=function(){if(this._canCache&&this._updateTransformPropertyLoopCount!==Stat.loopCount&&this._avatar){var t=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],e=this._clips[this._currentPlayClipIndex]._unCachePropertyToNodeMap,n=this._publicClipAnimationDatas[this._currentPlayClipIndex];this.currentPlayClip._evaluateAnimationlDatasCacheMode(t,this._cacheFullFrames[this._currentPlayClipIndex],this,n,e),this._setAnimationClipPropertyToAnimationNode(t,e,n),this._updateTransformPropertyLoopCount=Stat.loopCount}},n._update=function(t){var e=this._currentPlayClip;if(2===this.playState&&e&&e.loaded){var n=this.playbackRate*Laya.timer.scale,i=this._cachePlayRate;this._canCache=this.isCache&&n>=i;var r=-1;if(this._canCache){if(r=this._currentFrameIndex,this._lastFrameIndex===r)return;if(this._curClipAnimationDatas=e._getAnimationDataWithCache(i,r),this._avatar){var a=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],s=e._cachePropertyToNodeMap,o=s.length;o>0&&(this._curClipAnimationDatas||(this._curClipAnimationDatas=[],this._curClipAnimationDatas.length=o,e._cacheAnimationData(i,r,this._curClipAnimationDatas),e._evaluateAnimationlDatasCacheMode(a,this._cacheFullFrames[this._currentPlayClipIndex],this,this._curClipAnimationDatas,s)),this._setAnimationClipPropertyToAnimationNode(a,s,this._curClipAnimationDatas));this._cacheSpriteToNodesMap.length;this._curAvatarAnimationDatas=e._getAvatarDataWithCache(this._avatar,this._cachePlayRate,r),this._curAvatarAnimationDatas||(this._curAvatarAnimationDatas=[],this._curAvatarAnimationDatas.length=this._avatarNodes.length,e._cacheAvatarData(this._avatar,this._cachePlayRate,r,this._curAvatarAnimationDatas)),this._updateAvatarNodesCacheMode(a,e,this._curAvatarAnimationDatas)}else{var l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];this._curClipAnimationDatas||(this._curClipAnimationDatas=[],this._curClipAnimationDatas.length=this._currentPlayClip._nodes.length,e._evaluateAnimationlDatasCacheMode(l,this._cacheFullFrames[this._currentPlayClipIndex],this,this._curClipAnimationDatas,null),e._cacheAnimationData(i,r,this._curClipAnimationDatas)),this._setAnimationClipPropertyToSprite3D(l,this._curClipAnimationDatas)}}else this._curClipAnimationDatas=this._publicClipAnimationDatas[this._currentPlayClipIndex],this._avatar?(e._evaluateAnimationlDatasRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],this.currentPlayTime,this._curClipAnimationDatas,!0),this._curAvatarAnimationDatas=this._publicAvatarAnimationDatas,this._updateAvatarNodesRealTime(this._curAvatarAnimationDatas)):e._evaluateAnimationlDatasRealTime(this._cacheNodesSpriteOwners[this._currentPlayClipIndex],this.currentPlayTime,this._curClipAnimationDatas,!1);this._lastFrameIndex=r}},n._checkAnimationNode=function(t,e){t.name!==e.name||e._transform.dummy||e._isLinkSpriteToAnimationNode(this,t,!0);for(var n=0,i=e._childs.length;n<i;n++)this._checkAnimationNode(t,e.getChildAt(n))},n._load=function(t){t.activeInHierarchy&&Laya.timer.frameLoop(1,this,this._updateAnimtionPlayer),this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},n._unload=function(e){t.prototype._unload.call(this,e),e.activeInHierarchy&&Laya.timer.clear(this,this._updateAnimtionPlayer),this._owner.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._curClipAnimationDatas=null,this._publicClipAnimationDatas=null,this._curAvatarAnimationDatas=null,this._publicAvatarAnimationDatas=null},n._destroy=function(){t.prototype._destroy.call(this),this._currentPlayClip=null,this._clipNames=null,this._cacheNodesSpriteOwners=null,this._cacheNodesAvatarOwners=null,this._cacheNodesDefaultlValues=null,this._publicClipAnimationDatas=null,this._clips=null,this._cacheFullFrames=null},n._cloneTo=function(t){var e=t;e.avatar=this.avatar;for(var n=(this._clips.length,0),i=this._clips.length;n<i;n++)e.addClip(this._clips[n]);this.clip&&(e.clip=this.clip)},n.addClip=function(t,e,n,i){void 0===n&&(n=0),void 0===i&&(i=4294967295),e=e||t.name;var r=this._clipNames.indexOf(e);if(-1!==r){if(this._clips[r]!==t)throw new Error("Animation:this playName has exist with another clip.")}else{var a=this._clips.indexOf(t);if(n<0||i<0)throw new Error("Animator:startFrame and endFrame must large than zero.");if(n>i)throw new Error("Animator:startFrame must less than endFrame.");this._clipNames.push(e),this._clips.push(t),this._playStartFrames.push(n),this._playEndFrames.push(i),this._cacheNodesSpriteOwners.push([]),this._cacheNodesAvatarOwners.push([]),this._cacheNodesDefaultlValues.push([]),this._publicClipAnimationDatas.push([]),a=this._clips.length-1,this._avatar?this._avatar.loaded?this._getAvatarOwnersByClipAsync(a,t):this._avatar.once("loaded",this,this._getAvatarOwnersByClipAsync,[a,t]):this._getSpriteOwnersByClipAsync(a,t),t.loaded?this._computeCacheFullKeyframeIndices(a):t.once("loaded",this,this._computeCacheFullKeyframeIndices,[a])}},n.removeClip=function(t){var e=this._clips.indexOf(t);-1!==e&&(this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,t):this._offGetSpriteOwnersByClipAsyncEvent(t),this._offGetClipCacheFullKeyframeIndicesEvent(t),this._clipNames.splice(e,1),this._clips.splice(e,1),this._playStartFrames.splice(e,1),this._playEndFrames.splice(e,1),this._cacheNodesSpriteOwners.splice(e,1),this._cacheNodesAvatarOwners.splice(e,1),this._cacheNodesDefaultlValues.splice(e,1),this._publicClipAnimationDatas.splice(e,1))},n.removeClipByName=function(t){var e=this._clipNames.indexOf(t);if(-1!==e){var n=this._clips[e];this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,n):this._offGetSpriteOwnersByClipAsyncEvent(n),this._offGetClipCacheFullKeyframeIndicesEvent(n),this._clipNames.splice(e,1),this._clips.splice(e,1),this._playStartFrames.splice(e,1),this._playEndFrames.splice(e,1),this._cacheNodesSpriteOwners.splice(e,1),this._cacheNodesAvatarOwners.splice(e,1),this._cacheNodesDefaultlValues.splice(e,1),this._publicClipAnimationDatas.splice(e,1)}},n.getClip=function(t){var e=this._clipNames.indexOf(t);return-1!==e?this._clips[e]:null},n.getClipCount=function(){return this._clips.length},n.play=function(t,e){if(void 0===e&&(e=1),!t&&-1==this._defaultClipIndex)throw new Error("Animator:must have  default clip value,please set clip property.");t?(this._currentPlayClipIndex=this._clipNames.indexOf(t),this._currentPlayClip=this._clips[this._currentPlayClipIndex]):(this._currentPlayClipIndex=this._defaultClipIndex,this._currentPlayClip=this._clips[this._defaultClipIndex]),this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=e,this._stoped=!1,this._currentFrameIndex=0,this._startUpdateLoopCount=Stat.loopCount,this.event("played"),this._lastPlayAnimationClip&&this._lastPlayAnimationClip!==this._currentPlayClip&&this._revertKeyframeNodes(this._lastPlayAnimationClip,this._lastPlayAnimationClipIndex),this._updatePlayer(0),this._lastPlayAnimationClip=this._currentPlayClip,this._lastPlayAnimationClipIndex=this._currentPlayClipIndex},n.stop=function(t){void 0===t&&(t=!0),0!==this.playState&&(t?(this._stoped=!0,this.event("stopped")):this._stopWhenCircleFinish=!0)},n.linkSprite3DToAvatarNode=function(t,e){if(this._avatar){var n=this._avatarNodeMap[t];return!!n&&(e._isLinkSpriteToAnimationNode(this,n,!0),!0)}return!1},n.unLinkSprite3DToAvatarNode=function(t){if(this._avatar){var e=t.transform.dummy;if(e){var n=this._avatarNodeMap[e._owner.name];return t._isLinkSpriteToAnimationNode(this,n,!1),!0}return!1}return!1},__getset(0,n,"playbackTime",null,function(t){if(null!=this._currentPlayClip&&this._currentPlayClip&&this._currentPlayClip.loaded){this._startUpdateLoopCount=Stat.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentFrameIndex=Math.floor(this.currentPlayTime/e),this._currentFrameTime=this._currentFrameIndex*e}}),__getset(0,n,"curAnimationDatas",function(){return this._curClipAnimationDatas}),__getset(0,n,"currentFrameTime",function(){return this._currentFrameTime}),__getset(0,n,"playState",function(){return null==this._currentPlayClip?0:this._stoped?0:2}),__getset(0,n,"currentPlayTime",function(){return this._currentTime+this._playStartFrames[this._currentPlayClipIndex]/this._currentPlayClip._frameRate}),__getset(0,n,"paused",function(){return this._stoped},function(t){this._stoped=t,t&&this.event("paused")}),__getset(0,n,"currentPlayClip",function(){return this._currentPlayClip}),__getset(0,n,"cachePlayRate",function(){return this._cachePlayRate},function(t){if(this._cachePlayRate!==t){this._cachePlayRate=t;for(var e=0,n=this._clips.length;e<n;e++)this._clips[e].loaded&&this._computeCacheFullKeyframeIndices(e)}}),__getset(0,n,"cacheFrameRate",function(){return this._cacheFrameRate},function(t){if(this._cacheFrameRate!==t){this._cacheFrameRate=t,this._cacheFrameRateInterval=1/this._cacheFrameRate;for(var e=0,n=this._clips.length;e<n;e++)this._clips[e].loaded&&this._computeCacheFullKeyframeIndices(e)}}),__getset(0,n,"clip",function(){return this._clips[this._defaultClipIndex]},function(t){var e=t?this._clips.indexOf(t):-1;this._defaultClipIndex!==e&&(-1!==this._defaultClipIndex&&this.removeClip(this._clips[this._defaultClipIndex]),-1!==e&&this.addClip(t,t.name),this._defaultClipIndex=e)}),__getset(0,n,"currentFrameIndex",function(){return this._currentFrameIndex}),__getset(0,n,"avatar",function(){return this._avatar},function(t){if(this._avatar!==t){var e=this._avatar;this._avatar=t;for(var n=this._clips.length,i=0;i<n;i++)this._offClipAndAvatarRelateEvent(e,this._clips[i]);t&&(t.loaded?this._getAvatarOwnersAndInitDatasAsync():t.once("loaded",this,this._getAvatarOwnersAndInitDatasAsync))}}),e}(Component3D),Script=function(t){function e(){e.__super.call(this)}__class(e,"laya.d3.component.Script",t);var n=e.prototype;return n.onTriggerEnter=function(t){},n.onTriggerExit=function(t){},n.onTriggerStay=function(t){},__getset(0,n,"isSingleton",function(){return e._isSingleton}),e._isSingleton=!1,e}(Component3D),Collider=function(t){function e(){e.__super.call(this),this._isRigidbody=!1,this._runtimeCollisonMap={},this._runtimeCollisonTestMap={},this._ignoreCollisonMap={},this.isTrigger=!0}__class(e,"laya.d3.component.physics.Collider",t);var n=e.prototype;return n._clearCollsionMap=function(){for(var t in this._runtimeCollisonMap){var e=this._runtimeCollisonMap[t];delete e._runtimeCollisonMap[this.id],e._isRigidbody&&delete e._runtimeCollisonTestMap[this.id];var n=e.id;delete this._runtimeCollisonMap[n],this._isRigidbody&&delete this._runtimeCollisonTestMap[n]}},n._unload=function(t){for(var e in this._runtimeCollisonMap){var n=this._runtimeCollisonMap[e];delete n._runtimeCollisonMap[this.id],n._isRigidbody&&delete n._runtimeCollisonTestMap[this.id],delete this._ignoreCollisonMap[e]._ignoreCollisonMap[this.id]}},n._setIsRigidbody=function(t){if(this._isRigidbody!==t){this._isRigidbody=t;var e=this._owner;if(e.displayedInStage){var n=e.layer;n._removeCollider(this),n._addCollider(this)}}},n._getType=function(){return-1},n._collisonTo=function(t){return!1},n.raycast=function(t,e,n){throw void 0===n&&(n=1.79e308),new Error("Collider:Must override it.")},__getset(0,n,"isSingleton",function(){return e._isSingleton}),__getset(0,n,"enable",t.prototype._$get_enable,function(t){if(this._enable!==t){this._owner.displayedInStage&&(t||this._clearCollsionMap()),this._enable=t,this.event("enablechanged",this._enable)}}),e._isSingleton=!1,e}(Component3D),Rigidbody=function(t){function e(){e.__super.call(this)}__class(e,"laya.d3.component.Rigidbody",t);var n=e.prototype;return __getset(0,n,"enable",t.prototype._$get_enable,function(t){if(this._enable!==t){for(var e=this._owner._colliders,n=0,i=e.length;n<i;n++){var r=e[n];r._setIsRigidbody(t);var a=r._runtimeCollisonMap,s=r._runtimeCollisonTestMap;if(!t)for(var o in a)delete s[o]}this._enable=t,this.event("enablechanged",this._enable)}}),e}(Component3D),AudioSoundChannel=function(t){function e(t){this._audio=null,this._onEnd=null,this._resumePlay=null,e.__super.call(this),this._onEnd=Utils.bind(this.__onEnd,this),this._resumePlay=Utils.bind(this.__resumePlay,this),t.addEventListener("ended",this._onEnd),this._audio=t}__class(e,"laya.media.h5audio.AudioSoundChannel",t);var n=e.prototype;return n.__onEnd=function(){if(1==this.loops)return this.completeHandler&&(Laya.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event("complete");this.loops>0&&this.loops--,this.startTime=0,this.play()},n.__resumePlay=function(){this._audio&&this._audio.removeEventListener("canplay",this._resumePlay);try{this._audio.currentTime=this.startTime,Browser.container.appendChild(this._audio),this._audio.play()}catch(t){this.event("error")}},n.play=function(){this.isStopped=!1;try{this._audio.playbackRate=SoundManager.playbackRate,this._audio.currentTime=this.startTime}catch(t){return void this._audio.addEventListener("canplay",this._resumePlay)}SoundManager.addChannel(this),Browser.container.appendChild(this._audio),"play"in this._audio&&this._audio.play()},n.stop=function(){this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&Render.isConchApp&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),Browser.onIE||this._audio!=AudioSound._musicAudio&&Pool.recover("audio:"+this.url,this._audio),Browser.removeElement(this._audio),this._audio=null)},n.pause=function(){this.isStopped=!0,SoundManager.removeChannel(this),"pause"in this._audio&&this._audio.pause()},n.resume=function(){this._audio&&(this.isStopped=!1,SoundManager.addChannel(this),"play"in this._audio&&this._audio.play())},__getset(0,n,"volume",function(){return this._audio?this._audio.volume:1},function(t){this._audio&&(this._audio.volume=t)}),__getset(0,n,"duration",function(){return this._audio?this._audio.duration:0}),__getset(0,n,"position",function(){return this._audio?this._audio.currentTime:0}),e}(SoundChannel),WebAudioSoundChannel=function(t){function e(){this.audioBuffer=null,this.gain=null,this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this._onPlayEnd=null,this.context=WebAudioSound.ctx,e.__super.call(this),this._onPlayEnd=Utils.bind(this.__onPlayEnd,this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}__class(e,"laya.media.webaudio.WebAudioSoundChannel",t);var n=e.prototype;return n.play=function(){if(SoundManager.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){var t=this.context,e=this.gain,n=t.createBufferSource();this.bufferSource=n,n.buffer=this.audioBuffer,n.connect(e),e&&e.disconnect(),e.connect(t.destination),n.onended=this._onPlayEnd,this.startTime>=this.duration&&(this.startTime=0),this._startTime=Browser.now(),this.gain.gain.value=this._volume,0==this.loops&&(n.loop=!0),n.playbackRate.value=SoundManager.playbackRate,n.start(0,this.startTime),this._currentTime=0}},n.__onPlayEnd=function(){if(1==this.loops)return this.completeHandler&&(Laya.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event("complete");this.loops>0&&this.loops--,this.startTime=0,this.play()},n._clearBufferSource=function(){if(this.bufferSource){var t=this.bufferSource;t.stop?t.stop(0):t.noteOff(0),t.disconnect(0),t.onended=null,e._tryCleanFailed||this._tryClearBuffer(t),this.bufferSource=null}},n._tryClearBuffer=function(t){if(!Browser.onIOS)return void(e._tryCleanFailed=!0);try{t.buffer=WebAudioSound._miniBuffer}catch(t){e._tryCleanFailed=!0}},n.stop=function(){this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,SoundManager.autoReleaseSound&&Laya.timer.once(5e3,null,SoundManager.disposeSoundIfNotUsed,[this.url],!1)},n.pause=function(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),SoundManager.autoReleaseSound&&Laya.timer.once(5e3,null,SoundManager.disposeSoundIfNotUsed,[this.url],!1)},n.resume=function(){this.startTime=this._pauseTime,this.play()},__getset(0,n,"volume",function(){return this._volume},function(t){this.isStopped||(this._volume=t,this.gain.gain.value=t)}),__getset(0,n,"duration",function(){return this.audioBuffer?this.audioBuffer.duration:0}),__getset(0,n,"position",function(){return this.bufferSource?(Browser.now()-this._startTime)/1e3+this.startTime:0}),e._tryCleanFailed=!1,e}(SoundChannel),Scene=function(t){function e(){this._enableLightCount=3,this._customRenderQueneIndex=11,this.enableLight=!0,e.__super.call(this),this._renderState=new RenderState,this._lights=[],this._quenes=[],this._cameraPool=[],this._renderableSprite3Ds=[],this.__loaded=!0,this._lightmaps=[],this._shaderValues=new ValusArray,this.parallelSplitShadowMaps=[],this._dynamicBatchManager=new DynamicBatchManager,this._cullingRenders=[],this._cullingRendersLength=0,this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new Vector3(.7,.7,.7),this.ambientColor=new Vector3(.212,.227,.259),WebGL.shaderHighPrecision&&this.addShaderDefine(ShaderCompile3D.SHADERDEFINE_HIGHPRECISION),this.on("display",this,this._display),this.on("undisplay",this,this._unDisplay),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[]}__class(e,"laya.d3.core.scene.Scene",t);var n=e.prototype;return Laya.imps(n,{"laya.resource.ICreateResource":!0,"laya.webgl.submit.ISubmit":!0}),n._display=function(){Laya.stage._scenes.push(this),Laya.stage._scenes.sort(e._sortScenes);for(var t=0,n=this._childs.length;t<n;t++){var i=this._childs[t];i.active&&i._activeHierarchy()}},n._unDisplay=function(){var t=Laya.stage._scenes;t.splice(t.indexOf(this),1);for(var e=0,n=this._childs.length;e<n;e++){var i=this._childs[e];i.active&&i._inActiveHierarchy()}},n._addChild3D=function(t){t.transform._onWorldTransform(),t._setBelongScene(this),this.displayedInStage&&t.active&&t._activeHierarchy()},n._removeChild3D=function(t){t.transform.parent=null,this.displayedInStage&&t.active&&t._inActiveHierarchy(),t._setUnBelongScene()},n.initOctree=function(t,e,n,i,r){void 0===r&&(r=6),this.treeSize=new Vector3(t,e,n),this.treeLevel=r,this.treeRoot=new OctreeNode(this,0),this.treeRoot.init(i,this.treeSize)},n._prepareUpdateToRenderState=function(t,e){e.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,e.scene=this},n._prepareSceneToRender=function(t){var e=this._lights.length;if(e>0)for(var n=0,i=0;i<e&&!(this._lights[i]._prepareToScene(t)&&++n>=this._enableLightCount);i++);},n._updateChilds=function(t){for(var e=0,n=this._childs.length;e<n;++e)this._childs[e]._update(t)},n._updateChildsConch=function(t){for(var e=0,n=this._childs.length;e<n;++e)this._childs[e]._updateConch(t)},n._preRenderScene=function(t,e,n){var i=e._viewMatrix,r=e._projectionMatrix,a=e._projectionViewMatrix,s=0,o=0,l=e.camera;for(l.useOcclusionCulling?this.treeRoot?FrustumCulling.renderObjectCullingOctree(n,this,l,i,r,a):FrustumCulling.renderObjectCulling(n,this,l,i,r,a):FrustumCulling.renderObjectCullingNoBoundFrustum(this,l,i,r,a),s=0,o=this._quenes.length;s<o;s++)this._quenes[s]&&this._quenes[s]._preRender(e)},n._clear=function(t,e){var n=e._viewport,i=e.camera,r=n.x,a=i.renderTargetSize.height-n.y-n.height,s=n.width,o=n.height;t.viewport(r,a,s,o);var l=256,h=i.renderTarget;switch(i.clearFlag){case 0:var _=i.clearColor;if(_){t.enable(3089),t.scissor(r,a,s,o);var u=_.elements;t.clearColor(u[0],u[1],u[2],u[3]),l|=16384}if(h)switch(_||(l=16384),h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}t.clear(l),_&&t.disable(3089);break;case 1:case 2:if(h)switch(l=16384,h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}t.clear(l);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},n._renderScene=function(t,e){var n,i=e.camera,r=0,a=0;for(r=0;r<2;r++)(n=this._quenes[r])&&(i.renderTarget?n._render(e,!0):n._render(e,!1));if(1===i.clearFlag){var s=i.sky;s&&(WebGLContext.setCullFace(t,!1),WebGLContext.setDepthFunc(t,515),WebGLContext.setDepthMask(t,!1),s._render(e),WebGLContext.setDepthFunc(t,513),WebGLContext.setDepthMask(t,!0))}for(r=2,a=this._quenes.length;r<a;r++)(n=this._quenes[r])&&(n._sortAlpha(e.camera.transform.position),i.renderTarget?n._render(e,!0):n._render(e,!1))},n._set3DRenderConfig=function(t){t.disable(3042),WebGLContext._blend=!1,t.blendFunc(770,771),WebGLContext._sFactor=770,WebGLContext._dFactor=771,t.disable(2929),WebGLContext._depthTest=!1,t.enable(2884),WebGLContext._cullFace=!0,t.depthMask(1),WebGLContext._depthMask=!0,t.frontFace(2304),WebGLContext._frontFace=2304},n._set2DRenderConfig=function(t){WebGLContext.setBlend(t,!0),WebGLContext.setBlendFunc(t,1,771),WebGLContext.setDepthTest(t,!1),WebGLContext.setCullFace(t,!1),WebGLContext.setDepthMask(t,!0),WebGLContext.setFrontFace(t,2305),t.viewport(0,0,RenderState2D.width,RenderState2D.height)},n._parseCustomProps=function(t,e,n,i){
var r=i.customProps.lightmaps,a=r.length,s=this._lightmaps;s.length=a;for(var o=0;o<a;o++)s[o]=Loader.getRes(e[r[o].replace("exr","png")]);this.setlightmaps(s);var l=i.customProps.ambientColor;l&&(this.ambientColor=new Vector3(l[0],l[1],l[2]))},n._addLight=function(t){this._lights.indexOf(t)<0&&this._lights.push(t)},n._removeLight=function(t){var e=this._lights.indexOf(t);e>=0&&this._lights.splice(e,1)},n._updateScene=function(){var t=this._renderState;this._prepareUpdateToRenderState(WebGL.mainContext,t),this._updateComponents(t),this._updateChilds(t),this._lateUpdateComponents(t)},n._updateSceneConch=function(){var t=this._renderState;this._prepareUpdateToRenderState(WebGL.mainContext,t),this._updateComponents(t),this._updateChildsConch(t),this._lateUpdateComponents(t),this._prepareSceneToRender(t);for(var e=0,n=this._cameraPool.length;e<n;e++){var i=this._cameraPool[e];t.camera=i,i._prepareCameraToRender()}},n._preRenderShadow=function(t,e,n,i,r){this.treeRoot?FrustumCulling.renderShadowObjectCullingOctree(this,e,n,i,r):FrustumCulling.renderShadowObjectCulling(this,e,n,i,r);for(var a=0,s=n.length;a<s;a++)n[a]&&n[a]._preRender(t)},n._renderShadowMap=function(t,e,n){var i=this.parallelSplitShadowMaps[0];i._calcAllLightCameraInfo(n);var r=i.PSSMNum;this._preRenderShadow(e,i._lightCulling,i._shadowQuenes,i._lightVPMatrix[0],r),this.addShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_CAST_SHADOW);var a,s,o;if(r>1)for(var l=0;l<r;l++)a=i.getRenderTarget(l+1),i.beginRenderTarget(l+1),t.clearColor(1,1,1,1),t.clear(16640),t.viewport(0,0,a.width,a.height),e.camera=o=i.getLightCamera(l),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),e._projectionViewMatrix=i._lightVPMatrix[l+1],s=i._shadowQuenes[l],s._preRender(e),s._renderShadow(e,!1),i.endRenderTarget(l+1);else a=i.getRenderTarget(1),i.beginRenderTarget(1),t.clearColor(1,1,1,1),t.clear(16640),t.viewport(0,0,a.width,a.height),e.camera=o=i.getLightCamera(0),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),e._projectionViewMatrix=i._lightVPMatrix[0],s=i._shadowQuenes[0],s._preRender(e),s._renderShadow(e,!0),i.endRenderTarget(1);this.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_CAST_SHADOW)},n.addTreeNode=function(t){this.treeRoot.addTreeNode(t)},n.removeTreeNode=function(t){this.treeSize&&t._treeNode&&t._treeNode.removeObject(t)},n.setlightmaps=function(t){this._lightmaps=t;for(var e=0,n=this._renderableSprite3Ds.length;e<n;e++)this._renderableSprite3Ds[e]._render._applyLightMapParams()},n.getlightmaps=function(){return this._lightmaps},n.addChildAt=function(t,e){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),e>=0&&e<=this._childs.length){if(t._parent===this){var n=this.getChildIndex(t);this._childs.splice(n,1),this._childs.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged()}else t.parent&&t.parent.removeChild(t),this._childs===Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(e,0,t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,e),t.parent=this,this._addChild3D(t);return t}throw new Error("appendChildAt:The index is out of bounds")},n.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var e=this.getChildIndex(t);e!==this._childs.length-1&&(this._childs.splice(e,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else t.parent&&t.parent.removeChild(t),this._childs===Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged(),this._addChild3D(t);return t},n.removeChildAt=function(t){var e=this.getChildAt(t);return e&&(this._removeChild3D(e),this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null),e},n.removeChildren=function(t,e){if(void 0===t&&(t=0),void 0===e&&(e=2147483647),this._childs&&this._childs.length>0){var n=this._childs;if(0===t&&e>=a){var i=n;this._childs=Node.ARRAY_EMPTY}else i=n.splice(t,e-t);for(var r=0,a=i.length;r<a;r++)this._removeChild3D(i[r]),i[r].parent=null,this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}return this},n.addFrustumCullingObject=function(t){this.treeRoot?this.addTreeNode(t):(this._cullingRendersLength===this._cullingRenders.length?this._cullingRenders.push(t):this._cullingRenders[this._cullingRendersLength]=t,t._indexInSceneFrustumCullingObjects=this._cullingRendersLength++)},n.removeFrustumCullingObject=function(t){if(this.treeRoot)this.removeTreeNode(t);else{this._cullingRendersLength--;var e=t._indexInSceneFrustumCullingObjects;if(e!==this._cullingRendersLength){var n=this._cullingRenders[this._cullingRendersLength];this._cullingRenders[e]=n,n._indexInSceneFrustumCullingObjects=e,t._indexInSceneFrustumCullingObjects=-1}}},n.getRenderQueue=function(t){return this._quenes[t]||(this._quenes[t]=new RenderQueue(this))},n.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new RenderQueue(this)},n.addShaderDefine=function(t){this._shaderDefineValue|=t},n.removeShaderDefine=function(t){this._shaderDefineValue&=~t},n.addScript=function(t){return this._addComponent(t)},n.getScriptByType=function(t,e){return void 0===e&&(e=0),this._getComponentByType(t,e)},n.getScriptsByType=function(t,e){this._getComponentsByType(t,e)},n.getScriptByIndex=function(t){return this._getComponentByIndex(t)},n.removeScriptByType=function(t,e){void 0===e&&(e=0),this._removeComponentByType(t,e)},n.removeScriptsByType=function(t){this._removeComponentByType(t)},n.removeAllScript=function(){this._removeAllComponent()},n.render=function(t,e,n){Render._context.ctx._renderKey=0,this._childs.length>0&&t.addRenderObject(this)},n.renderSubmit=function(){var t=WebGL.mainContext,e=this._renderState;this._set3DRenderConfig(t),this._prepareSceneToRender(this._renderState);var n,i=0,r=0;if(Laya3D.debugMode||OctreeNode.debugMode)for(i=0,r=this._cameraPool.length;i<r;i++)n=this._cameraPool[i],Laya3D._debugPhasorSprite.begin(1,n),n.activeInHierarchy&&n._renderCamera(t,e,this),Laya3D._debugPhasorSprite.end();else for(i=0,r=this._cameraPool.length;i<r;i++)n=this._cameraPool[i],n.activeInHierarchy&&n._renderCamera(t,e,this);return this._set2DRenderConfig(t),1},n.onAsynLoaded=function(t,e,n){if(!this.destroyed){var i=e[0];if("Scene"!==i.type)throw new Error("Scene: the .lh file root type must be Scene,please use other function to  load  this file.");var r=e[1];Utils3D._createNodeByJson(this,i,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0}},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._renderState=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._cullingRenders=null,this._dynamicBatchManager=null,this._quenes=null,this._cameraPool=null,this._renderableSprite3Ds=null,this.treeRoot=null,this.treeSize=null,this.parallelSplitShadowMaps=null,this._typeComponentsIndices=null,this._components=null,Loader.clearRes(this.url))},n.getRenderType=function(){return 0},n.releaseRender=function(){},n.createConchModel=function(){var t=new ConchScene;return t.init(512,512,512,4),t},n._addComponent=function(t){var e,n=this._componentsMap.indexOf(t);if(-1===n)e=[],this._componentsMap.push(t),this._typeComponentsIndices.push(e);else if(e=this._typeComponentsIndices[n],this._components[e[0]].isSingleton)throw new Error("无法单实例创建"+t+"组件，"+t+"组件已存在！");var i=ClassUtils.getInstance(t);e.push(this._components.length),this._components.push(i);var r=this;return i._initialize(r),i},n._removeComponent=function(t,e){var n=this._typeComponentsIndices[t],i=n[e],r=this._components[i];this._components.splice(i,1),n.splice(e,1),0===n.length&&(this._typeComponentsIndices.splice(t,1),this._componentsMap.splice(t,1));for(var a=0,s=this._componentsMap.length;a<s;a++){n=this._typeComponentsIndices[a];for(var o=n.length-1;o>=0;o--){var l=n[o];if(!(l>i))break;n[o]=--l}}r._destroy()},n._getComponentByType=function(t,e){void 0===e&&(e=0);var n=this._componentsMap.indexOf(t);return-1===n?null:this._components[this._typeComponentsIndices[n][e]]},n._getComponentsByType=function(t,e){var n=this._componentsMap.indexOf(t);if(-1===n)return void(e.length=0);var i=this._typeComponentsIndices[n],r=i.length;e.length=r;for(var a=0;a<r;a++)e[a]=this._components[i[a]]},n._getComponentByIndex=function(t){return this._components[t]},n._removeComponentByType=function(t,e){void 0===e&&(e=0);var n=this._componentsMap.indexOf(t);-1!==n&&this._removeComponent(n,e)},n._removeComponentsByType=function(t){var e=this._componentsMap.indexOf(t);if(-1!==e)for(var n=this._typeComponentsIndices[e],i=0,r=n.length;i<r;n.length<r?r--:i++)this._removeComponent(e,i)},n._removeAllComponent=function(){for(var t=0,e=this._componentsMap.length;t<e;this._componentsMap.length<e?e--:t++)this._removeComponentsByType(this._componentsMap[t])},n._updateComponents=function(t){for(var e=0,n=this._components.length;e<n;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._update(t)}},n._lateUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._lateUpdate(t)}},n._preRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._preRenderUpdate(t)}},n._postRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._postRenderUpdate(t)}},__getset(0,n,"renderableSprite3Ds",function(){return this._renderableSprite3Ds.slice()}),__getset(0,n,"fogStart",function(){return this._fogStart},function(t){this._fogStart=t,this._shaderValues.setValue(1,t)}),__getset(0,n,"fogRange",function(){return this._fogRange},function(t){this._fogRange=t,this._shaderValues.setValue(2,t)}),__getset(0,n,"fogColor",function(){return this._fogColor},function(t){this._fogColor=t,this._shaderValues.setValue(0,t.elements)}),__getset(0,n,"scene",function(){return this}),__getset(0,n,"ambientColor",function(){return this._ambientColor},function(t){this._ambientColor=t,this._shaderValues.setValue(21,t.elements)}),__getset(0,n,"_loaded",null,function(t){this.__loaded=t}),__getset(0,n,"enableDepthFog",function(){return this._enableDepthFog},function(t){this._enableDepthFog!=t&&(this._enableDepthFog=t,t?(this.addShaderDefine(ShaderCompile3D.SAHDERDEFINE_DEPTHFOG),this.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)):this.removeShaderDefine(ShaderCompile3D.SAHDERDEFINE_DEPTHFOG))}),__getset(0,n,"loaded",function(){return this.__loaded}),__getset(0,n,"enableFog",function(){return this._enableFog},function(t){this._enableFog!==t&&(this._enableFog=t,t?(this.addShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG),this.removeShaderDefine(ShaderCompile3D.SAHDERDEFINE_DEPTHFOG)):this.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG))}),__getset(0,n,"url",function(){return this._url},function(t){this._url=t}),e._sortScenes=function(t,n){if(t.parent===Laya.stage&&n.parent===Laya.stage){var i=Laya.stage._childs;return i.indexOf(t)-i.indexOf(n)}return t.parent!==Laya.stage&&n.parent!==Laya.stage?e._sortScenes(t.parent,n.parent):t.parent===Laya.stage?-1:1},e.load=function(t){return Laya.loader.create(t,null,null,e)},e.FOGCOLOR=0,e.FOGSTART=1,e.FOGRANGE=2,e.LIGHTDIRECTION=3,e.LIGHTDIRCOLOR=4,e.POINTLIGHTPOS=5,e.POINTLIGHTRANGE=6,e.POINTLIGHTATTENUATION=7,e.POINTLIGHTCOLOR=8,e.SPOTLIGHTPOS=9,e.SPOTLIGHTDIRECTION=10,e.SPOTLIGHTSPOT=11,e.SPOTLIGHTRANGE=12,e.SPOTLIGHTATTENUATION=13,e.SPOTLIGHTCOLOR=14,e.SHADOWDISTANCE=15,e.SHADOWLIGHTVIEWPROJECT=16,e.SHADOWMAPPCFOFFSET=17,e.SHADOWMAPTEXTURE1=18,e.SHADOWMAPTEXTURE2=19,e.SHADOWMAPTEXTURE3=20,e.AMBIENTCOLOR=21,e}(Sprite),Buffer2D=function(t){function e(){this._maxsize=0,this._upload=!0,this._uploadSize=0,e.__super.call(this),this.lock=!0}__class(e,"laya.webgl.utils.Buffer2D",t);var n=e.prototype;return n._bufferData=function(){this._maxsize=Math.max(this._maxsize,this._byteLength),Stat.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this.memorySize=this._buffer.byteLength,this._buffer=this._buffer.slice(0,this._maxsize+64),this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,Buffer._gl.bufferData(this._bufferType,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),Buffer._gl.bufferSubData(this._bufferType,0,this._buffer)},n._bufferSubData=function(t,e,n){if(void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._maxsize=Math.max(this._maxsize,this._byteLength),Stat.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this.memorySize=this._buffer.byteLength,this._buffer=this._buffer.slice(0,this._maxsize+64),this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,Buffer._gl.bufferData(this._bufferType,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),e||n){var i=this._buffer.slice(e,n);Buffer._gl.bufferSubData(this._bufferType,t,i)}else Buffer._gl.bufferSubData(this._bufferType,t,this._buffer)},n._checkArrayUse=function(){},n._bind_upload=function(){return!!this._upload&&(this._upload=!1,this._bind(),this._bufferData(),!0)},n._bind_subUpload=function(t,e,n){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),!!this._upload&&(this._upload=!1,this._bind(),this._bufferSubData(t,e,n),!0)},n._resizeBuffer=function(t,e){if(t<this._buffer.byteLength)return this;if(this.memorySize=t,e&&this._buffer&&this._buffer.byteLength>0){var n=new ArrayBuffer(t);new Uint8Array(n).set(new Uint8Array(this._buffer),0),this._buffer=n}else this._buffer=new ArrayBuffer(t);return this._checkArrayUse(),this._upload=!0,this},n.append=function(t){this._upload=!0;var e,n=0;n=t.byteLength,t instanceof Uint8Array?(this._resizeBuffer(this._byteLength+n,!0),e=new Uint8Array(this._buffer,this._byteLength)):t instanceof Uint16Array?(this._resizeBuffer(this._byteLength+n,!0),e=new Uint16Array(this._buffer,this._byteLength)):t instanceof Float32Array&&(this._resizeBuffer(this._byteLength+n,!0),e=new Float32Array(this._buffer,this._byteLength)),e.set(t,0),this._byteLength+=n,this._checkArrayUse()},n.appendEx=function(t,e){this._upload=!0;var n,i=0;i=t.byteLength,this._resizeBuffer(this._byteLength+i,!0),n=new e(this._buffer,this._byteLength),n.set(t,0),this._byteLength+=i,this._checkArrayUse()},n.appendEx2=function(t,e,n,i){void 0===i&&(i=1),this._upload=!0;var r,a=0;a=n*i,this._resizeBuffer(this._byteLength+a,!0),r=new e(this._buffer,this._byteLength);var s=0;for(s=0;s<n;s++)r[s]=t[s];this._byteLength+=a,this._checkArrayUse()},n.getBuffer=function(){return this._buffer},n.setNeedUpload=function(){this._upload=!0},n.getNeedUpload=function(){return this._upload},n.upload=function(){var t=this._bind_upload();return Buffer._gl.bindBuffer(this._bufferType,null),Buffer._bindActive[this._bufferType]=null,BaseShader.activeShader=null,t},n.subUpload=function(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0);var i=this._bind_subUpload();return Buffer._gl.bindBuffer(this._bufferType,null),Buffer._bindActive[this._bufferType]=null,BaseShader.activeShader=null,i},n.detoryResource=function(){t.prototype.detoryResource.call(this),this._upload=!0,this._uploadSize=0},n.clear=function(){this._byteLength=0,this._upload=!0},__getset(0,n,"byteLength",null,function(t){this._byteLength!==t&&(t<=this._buffer.byteLength||this._resizeBuffer(2*t+256,!0),this._byteLength=t)}),__getset(0,n,"bufferLength",function(){return this._buffer.byteLength}),e.__int__=function(t){IndexBuffer2D.QuadrangleIB=IndexBuffer2D.create(35044),GlUtils.fillIBQuadrangle(IndexBuffer2D.QuadrangleIB,16)},e.FLOAT32=4,e.SHORT=2,e}(Buffer),Shader=function(t){function e(t,n,i,r){if(this.customCompile=!1,this._curActTexIndex=0,this.tag={},this._program=null,this._params=null,this._paramsMap={},this._offset=0,e.__super.call(this),!t||!n)throw"Shader Error";(Render.isConchApp||Render.isFlash)&&(this.customCompile=!0),this._id=++e._count,this._vs=t,this._ps=n,this._nameMap=r||{},null!=i&&(e.sharders[i]=this)}__class(e,"laya.webgl.shader.Shader",t);var n=e.prototype;return n.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},n.detoryResource=function(){WebGL.mainContext.deleteShader(this._vshader),WebGL.mainContext.deleteShader(this._pshader),WebGL.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._params=null,this._paramsMap={},this.memorySize=0,this._curActTexIndex=0},n._compile=function(){if(this._vs&&this._ps&&!this._params){this._reCompile=!0,this._params=[];var t,n=[this._vs,this._ps];this.customCompile&&(t=ShaderCompile.preGetParams(this._vs,this._ps));var i=WebGL.mainContext;if(this._program=i.createProgram(),this._vshader=e._createShader(i,n[0],35633),this._pshader=e._createShader(i,n[1],35632),i.attachShader(this._program,this._vshader),i.attachShader(this._program,this._pshader),i.linkProgram(this._program),!this.customCompile&&!i.getProgramParameter(this._program,35714))throw i.getProgramInfoLog(this._program);var r,a,s=0,o=0,l=this.customCompile?t.attributes.length:i.getProgramParameter(this._program,35721);for(s=0;s<l;s++){var h=this.customCompile?t.attributes[s]:i.getActiveAttrib(this._program,s);a=i.getAttribLocation(this._program,h.name),r={vartype:"attribute",glfun:null,ivartype:0,attrib:h,location:a,name:h.name,type:h.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._params.push(r)}var _=this.customCompile?t.uniforms.length:i.getProgramParameter(this._program,35718);for(s=0;s<_;s++){var u=this.customCompile?t.uniforms[s]:i.getActiveUniform(this._program,s);a=i.getUniformLocation(this._program,u.name),r={vartype:"uniform",glfun:null,ivartype:1,attrib:h,location:a,name:u.name,type:u.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},r.name.indexOf("[0]")>0&&(r.name=r.name.substr(0,r.name.length-3),r.isArray=!0,r.location=i.getUniformLocation(this._program,r.name)),this._params.push(r)}for(s=0,o=this._params.length;s<o;s++)if(r=this._params[s],r.indexOfParams=s,r.index=1,r.value=[r.location,null],r.codename=r.name,r.name=this._nameMap[r.codename]?this._nameMap[r.codename]:r.codename,this._paramsMap[r.name]=r,r._this=this,r.uploadedValue=[],"attribute"!==r.vartype)switch(r.type){case 5124:r.fun=r.isArray?this._uniform1iv:this._uniform1i;break;case 5126:r.fun=r.isArray?this._uniform1fv:this._uniform1f;break;case 35664:r.fun=r.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:r.fun=r.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:r.fun=r.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:r.fun=this._uniform_sampler2D;break;case 35680:r.fun=this._uniform_samplerCube;break;case 35676:r.glfun=i.uniformMatrix4fv,r.fun=this._uniformMatrix4fv;break;case 35670:r.fun=this._uniform1i;break;case 35674:case 35675:default:throw new Error("compile shader err!")}else r.fun=this._attribute}},n.getUniform=function(t){return this._paramsMap[t]},n._attribute=function(t,e){var n=WebGL.mainContext,i=Buffer._enableAtributes,r=t.location;return i[r]||n.enableVertexAttribArray(r),n.vertexAttribPointer(r,e[0],e[1],e[2],e[3],e[4]+this._offset),i[r]=Buffer._bindVertexBuffer,1},n._uniform1f=function(t,e){var n=t.uploadedValue;return n[0]!==e?(WebGL.mainContext.uniform1f(t.location,n[0]=e),1):0},n._uniform1fv=function(t,e){if(e.length<4){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform1fv(t.location,e),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],1):0}return WebGL.mainContext.uniform1fv(t.location,e),1},n._uniform_vec2=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]?(WebGL.mainContext.uniform2f(t.location,n[0]=e[0],n[1]=e[1]),1):0},n._uniform_vec2v=function(t,e){if(e.length<2){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform2fv(t.location,e),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],1):0}return WebGL.mainContext.uniform2fv(t.location,e),1},n._uniform_vec3=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]?(WebGL.mainContext.uniform3f(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2]),1):0},n._uniform_vec3v=function(t,e){return WebGL.mainContext.uniform3fv(t.location,e),1},n._uniform_vec4=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform4f(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3]),1):0},n._uniform_vec4v=function(t,e){return WebGL.mainContext.uniform4fv(t.location,e),1},n._uniformMatrix2fv=function(t,e){return WebGL.mainContext.uniformMatrix2fv(t.location,!1,e),1},n._uniformMatrix3fv=function(t,e){return WebGL.mainContext.uniformMatrix3fv(t.location,!1,e),1},n._uniformMatrix4fv=function(t,e){return WebGL.mainContext.uniformMatrix4fv(t.location,!1,e),1},n._uniform1i=function(t,e){var n=t.uploadedValue;return n[0]!==e?(WebGL.mainContext.uniform1i(t.location,n[0]=e),1):0},n._uniform1iv=function(t,e){return WebGL.mainContext.uniform1iv(t.location,e),1},n._uniform_ivec2=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]?(WebGL.mainContext.uniform2i(t.location,n[0]=e[0],n[1]=e[1]),1):0},n._uniform_ivec2v=function(t,e){return WebGL.mainContext.uniform2iv(t.location,e),1},n._uniform_vec3i=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]?(WebGL.mainContext.uniform3i(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2]),1):0},n._uniform_vec3vi=function(t,e){return WebGL.mainContext.uniform3iv(t.location,e),1},n._uniform_vec4i=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform4i(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3]),1):0},n._uniform_vec4vi=function(t,e){return WebGL.mainContext.uniform4iv(t.location,e),1},n._uniform_sampler2D=function(t,n){var i=WebGL.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,i.uniform1i(t.location,this._curActTexIndex),i.activeTexture(e._TEXTURES[this._curActTexIndex]),WebGLContext.bindTexture(i,3553,n),this._curActTexIndex++,1):(i.activeTexture(e._TEXTURES[r[0]]),WebGLContext.bindTexture(i,3553,n),0)},n._uniform_samplerCube=function(t,n){var i=WebGL.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,i.uniform1i(t.location,this._curActTexIndex),i.activeTexture(e._TEXTURES[this._curActTexIndex]),WebGLContext.bindTexture(i,34067,n),this._curActTexIndex++,1):(i.activeTexture(e._TEXTURES[r[0]]),WebGLContext.bindTexture(i,34067,n),0)},n._noSetValue=function(t){console.log("no....:"+t.name)},n.uploadOne=function(t,e){this.activeResource(),WebGLContext.UseProgram(this._program);var n=this._paramsMap[t];n.fun.call(this,n,e)},n.uploadTexture2D=function(t){Stat.shaderCall++;var e=WebGL.mainContext;e.activeTexture(33984),WebGLContext.bindTexture(e,3553,t)},n.upload=function(t,e){BaseShader.activeShader=BaseShader.bindShader=this,this._lastUseFrameCount===Stat.loopCount||this.activeResource(),WebGLContext.UseProgram(this._program),this._reCompile?(e=this._params,this._reCompile=!1):e=e||this._params;for(var n,i,r=(WebGL.mainContext,e.length),a=0,s=0;s<r;s++)n=e[s],null!==(i=t[n.name])&&(a+=n.fun.call(this,n,i));Stat.shaderCall+=a},n.uploadArray=function(t,e,n){BaseShader.activeShader=this,BaseShader.bindShader=this,this.activeResource(),WebGLContext.UseProgram(this._program);for(var i,r,a=(this._params,0),s=e-2;s>=0;s-=2)(r=this._paramsMap[t[s]])&&null!=(i=t[s+1])&&(n&&n[r.name]&&n[r.name].bind(),a+=r.fun.call(this,r,i));Stat.shaderCall+=a},n.getParams=function(){return this._params},e.getShader=function(t){return e.sharders[t]},e.create=function(t,n,i,r){return new e(t,n,i,r)},e.withCompile=function(t,n,i,r){if(i&&e.sharders[i])return e.sharders[i];var a=e._preCompileShader[2e-4*t];if(!a)throw new Error("withCompile shader err!"+t);return a.createShader(n,i,r)},e.withCompile2D=function(t,n,i,r,a){if(r&&e.sharders[r])return e.sharders[r];var s=e._preCompileShader[2e-4*t+n];if(!s)throw new Error("withCompile shader err!"+t+" "+n);return s.createShader(i,r,a)},e.addInclude=function(t,e){ShaderCompile.addInclude(t,e)},e.preCompile=function(t,n,i,r){var a=2e-4*t;e._preCompileShader[a]=new ShaderCompile(a,n,i,r)},e.preCompile2D=function(t,n,i,r,a){var s=2e-4*t+n;e._preCompileShader[s]=new ShaderCompile(s,i,r,a)},e._createShader=function(t,e,n){var i=t.createShader(n);return t.shaderSource(i,e),t.compileShader(i),i},e._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,,33991,33992],e._count=0,e._preCompileShader={},e.SHADERNAME2ID=2e-4,e.sharders=(e.sharders=[],e.sharders.length=32,e.sharders),__static(e,["nameKey",function(){return this.nameKey=new StringKey}]),e}(BaseShader),AtlasWebGLCanvas=function(t){function e(){this._atlaser=null,this._flashCacheImage=null,this._flashCacheImageNeedFlush=!1,e.__super.call(this)}__class(e,"laya.webgl.atlas.AtlasWebGLCanvas",t);var n=e.prototype;return n.recreateResource=function(){var t=WebGL.mainContext,e=this._source=t.createTexture(),n=WebGLContext.curBindTexTarget,i=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,3553,e),t.texImage2D(3553,0,6408,this._w,this._h,0,6408,5121,null),t.texParameteri(3553,10241,9729),t.texParameteri(3553,10240,9729),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),n&&i&&WebGLContext.bindTexture(t,n,i),this.memorySize=this._w*this._h*4,this.completeCreate()},n.detoryResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n.texSubImage2D=function(t,e,n){if(Render.isFlash){this._flashCacheImage||(this._flashCacheImage=HTMLImage.create(""),this._flashCacheImage._image.createCanvas(this._w,this._h));var i=n.bitmapdata;this._flashCacheImage._image.copyPixels(i,0,0,i.width,i.height,t,e),this._flashCacheImageNeedFlush||(this._flashCacheImageNeedFlush=!0)}else{var r=WebGL.mainContext,a=WebGLContext.curBindTexTarget,s=WebGLContext.curBindTexValue;WebGLContext.bindTexture(r,3553,this._source),r.pixelStorei(37441,!0),t-1>=0&&r.texSubImage2D(3553,0,t-1,e,6408,5121,n),t+1<=this._w&&r.texSubImage2D(3553,0,t+1,e,6408,5121,n),e-1>=0&&r.texSubImage2D(3553,0,t,e-1,6408,5121,n),e+1<=this._h&&r.texSubImage2D(3553,0,t,e+1,6408,5121,n),r.texSubImage2D(3553,0,t,e,6408,5121,n),r.pixelStorei(37441,!1),a&&s&&WebGLContext.bindTexture(r,a,s)}},n.texSubImage2DPixel=function(t,e,n,i,r){var a=WebGL.mainContext,s=WebGLContext.curBindTexTarget,o=WebGLContext.curBindTexValue;WebGLContext.bindTexture(a,3553,this._source);var l=new Uint8Array(r.data);a.pixelStorei(37441,!0),a.texSubImage2D(3553,0,t,e,n,i,6408,5121,l),a.pixelStorei(37441,!1),s&&o&&WebGLContext.bindTexture(a,s,o)},__getset(0,n,"height",t.prototype._$get_height,function(t){this._h=t}),__getset(0,n,"width",t.prototype._$get_width,function(t){this._w=t}),e}(Bitmap),WebGLSubImage=function(t){function e(t,n,i,r,a,s,o){this.offsetX=0,this.offsetY=0,e.__super.call(this),this.repeat=!0,this.mipmap=!1,this.minFifter=-1,this.magFifter=-1,this.atlasImage=s,this.canvas=t,this._ctx=t.getContext("2d",void 0),this._w=r,this._h=a,this.offsetX=n,this.offsetY=i,this.src=o,this._enableMerageInAtlas=!0,AtlasResourceManager.enabled&&this._w<AtlasResourceManager.atlasLimitWidth&&this._h<AtlasResourceManager.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1}__class(e,"laya.webgl.resource.WebGLSubImage",t);var n=e.prototype;return Laya.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n.size=function(t,e){this._w=t,this._h=e,this._ctx&&this._ctx.size(t,e),this.canvas&&(this.canvas.height=e,this.canvas.width=t)},n.recreateResource=function(){this.size(this._w,this._h),this._ctx.drawImage(this.atlasImage,this.offsetX,this.offsetY,this._w,this._h,0,0,this._w,this._h),this._allowMerageInAtlas&&this._enableMerageInAtlas?this.memorySize=0:this.createWebGlTexture(),this.completeCreate()},n.createWebGlTexture=function(){var t=WebGL.mainContext;if(!this.canvas)throw"create GLTextur err:no data:"+this.canvas;var e=this._source=t.createTexture(),n=WebGLContext.curBindTexTarget,i=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,3553,e),t.pixelStorei(37441,!0),t.texImage2D(3553,0,6408,6408,5121,this.canvas),t.pixelStorei(37441,!1);var r=this.minFifter,a=this.magFifter,s=this.repeat?10497:33071;Arith.isPOT(this.width,this.height)?(this.mipmap?-1!==r||(r=9987):-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10240,a),t.texParameteri(3553,10241,r),t.texParameteri(3553,10242,s),t.texParameteri(3553,10243,s),this.mipmap&&t.generateMipmap(3553)):(-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),n&&i&&WebGLContext.bindTexture(t,n,i),this.canvas=null,this.memorySize=this._w*this._h*4},n.detoryResource=function(){AtlasResourceManager.enabled&&this._allowMerageInAtlas||!this._source||(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n.clearAtlasSource=function(){},__getset(0,n,"enableMerageInAtlas",function(){return this._allowMerageInAtlas},function(t){this._allowMerageInAtlas=t}),__getset(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),__getset(0,n,"atlasSource",function(){return this.canvas}),e}(Bitmap),FileBitmap=function(t){function e(){this._src=null,this._onload=null,this._onerror=null,e.__super.call(this)}__class(e,"laya.resource.FileBitmap",t);var n=e.prototype;return __getset(0,n,"onload",null,function(t){}),__getset(0,n,"onerror",null,function(t){}),__getset(0,n,"src",function(){return this._src},function(t){this._src=t}),e}(Bitmap),WebGLRenderTarget=function(t){function e(t,n,i,r,a,s,o,l,h){void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=1),e.__super.call(this),this._w=t,this._h=n,this._surfaceFormat=i,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=l,this._magFifter=h}__class(e,"laya.webgl.resource.WebGLRenderTarget",t);var n=e.prototype;return n.recreateResource=function(){var t=WebGL.mainContext;this._frameBuffer||(this._frameBuffer=t.createFramebuffer()),this._source||(this._source=t.createTexture());var e=WebGLContext.curBindTexTarget,n=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,3553,this._source),t.texImage2D(3553,0,6408,this._w,this._h,0,this._surfaceFormat,this._surfaceType,null);var i=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071;if(Arith.isPOT(this._w,this._h)?(this._mipMap?-1!==i||(i=9987):-1!==i||(i=9729),-1!==r||(r=9729),t.texParameteri(3553,10241,i),t.texParameteri(3553,10240,r),t.texParameteri(3553,10242,a),t.texParameteri(3553,10243,a),this._mipMap&&t.generateMipmap(3553)):(-1!==i||(i=9729),-1!==r||(r=9729),t.texParameteri(3553,10241,i),t.texParameteri(3553,10240,r),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),t.bindFramebuffer(36160,this._frameBuffer),t.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer||(this._depthStencilBuffer=t.createRenderbuffer()),t.bindRenderbuffer(36161,this._depthStencilBuffer),t.renderbufferStorage(36161,this._depthStencilFormat,this._w,this._h),this._depthStencilFormat){case 33189:t.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer)
;break;case 36168:t.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:t.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}t.bindFramebuffer(36160,null),e&&n&&WebGLContext.bindTexture(t,e,n),t.bindRenderbuffer(36161,null),this.memorySize=this._w*this._h*4,this.completeCreate()},n.detoryResource=function(){this._frameBuffer&&(WebGL.mainContext.deleteTexture(this._source),WebGL.mainContext.deleteFramebuffer(this._frameBuffer),WebGL.mainContext.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0)},__getset(0,n,"depthStencilBuffer",function(){return this._depthStencilBuffer}),__getset(0,n,"frameBuffer",function(){return this._frameBuffer}),e}(Bitmap),WebGLCharImage=function(t){function e(t,n){this.CborderSize=12,e.__super.call(this),this.char=t,this.isSpace=" "===t,this.xs=n.scaleX,this.ys=n.scaleY,this.font=n.font.toString(),this.fontSize=n.font.size,this.fillColor=n.fillColor,this.borderColor=n.borderColor,this.lineWidth=n.lineWidth,this.underLine=n.underLine;var i,r=Render.isConchApp;r?(i=ConchTextCanvas,i._source=ConchTextCanvas,i._source.canvas=ConchTextCanvas):i=Browser.canvas.source,this.canvas=i,this._enableMerageInAtlas=!0,this._ctx=r?i:this.canvas.getContext("2d",void 0);var a=Utils.measureText(this.char,this.font);this.cw=a.width*this.xs,this.ch=(a.height||this.fontSize)*this.ys,this.onresize(this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this.texture=new Texture(this)}__class(e,"laya.webgl.resource.WebGLCharImage",t);var n=e.prototype;return Laya.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n.active=function(){this.texture.active()},n.recreateResource=function(){var t=Render.isConchApp;if(this.onresize(this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this.canvas&&(this.canvas.height=this._h,this.canvas.width=this._w),t){var e=this.fontSize;1==this.xs&&1==this.ys||(e=parseInt(e*(this.xs>this.ys?this.xs:this.ys)+""));var n="normal 100 "+e+"px Arial";this.borderColor&&(n+=" 1 "+this.borderColor),this._ctx.font=n,this._ctx.textBaseline="top",this._ctx.fillStyle=this.fillColor,this._ctx.fillText(this.char,this.CborderSize,this.CborderSize,null,null,null)}else{if(this._ctx.save(),this._ctx.clearRect(0,0,this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this._ctx.font=this.font,Text.RightToLeft&&(this._ctx.textAlign="end"),this._ctx.textBaseline="top",this._ctx.translate(this.CborderSize,this.CborderSize),1==this.xs&&1==this.ys||this._ctx.scale(this.xs,this.ys),this.fillColor&&this.borderColor?(this._ctx.strokeStyle=this.borderColor,this._ctx.lineWidth=this.lineWidth,this._ctx.strokeText(this.char,0,0,null,null,0,null),this._ctx.fillStyle=this.fillColor,this._ctx.fillText(this.char,0,0,null,null,null)):-1===this.lineWidth?(this._ctx.fillStyle=this.fillColor?this.fillColor:"white",this._ctx.fillText(this.char,0,0,null,null,null)):(this._ctx.strokeStyle=this.borderColor?this.borderColor:"white",this._ctx.lineWidth=this.lineWidth,this._ctx.strokeText(this.char,0,0,null,null,0,null)),this.underLine){this._ctx.lineWidth=1,this._ctx.strokeStyle=this.fillColor,this._ctx.beginPath(),this._ctx.moveTo(0,this.fontSize+1);var i=this._ctx.measureText(this.char).width+1;this._ctx.lineTo(i,this.fontSize+1),this._ctx.stroke()}this._ctx.restore()}this.borderSize=this.CborderSize,this.completeCreate()},n.onresize=function(t,e){this._w=t,this._h=e,this._allowMerageInAtlas=!0},n.clearAtlasSource=function(){},__getset(0,n,"enableMerageInAtlas",function(){return this._enableMerageInAtlas},function(t){this._enableMerageInAtlas=t}),__getset(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),__getset(0,n,"atlasSource",function(){return this.canvas}),e.createOneChar=function(t,n){return new e(t,n)},e}(Bitmap),WebGLCanvas=function(t){function e(){e.__super.call(this)}__class(e,"laya.webgl.resource.WebGLCanvas",t);var n=e.prototype;return n.getCanvas=function(){return this._canvas},n.clear=function(){this._ctx&&this._ctx.clear()},n.destroy=function(){this._ctx&&this._ctx.destroy(),this._ctx=null},n._setContext=function(t){this._ctx=t},n.getContext=function(t,n){return this._ctx?this._ctx:this._ctx=e._createContext(this)},n.size=function(t,e){this._w==t&&this._h==e||(this._w=t,this._h=e,this._ctx&&this._ctx.size(t,e),this._canvas&&(this._canvas.height=e,this._canvas.width=t))},n.recreateResource=function(){this.createWebGlTexture(),this.completeCreate()},n.detoryResource=function(){this._source&&!this.iscpuSource&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n.createWebGlTexture=function(){var t=WebGL.mainContext;if(!this._canvas)throw"create GLTextur err:no data:"+this._canvas;var e=this._source=t.createTexture();this.iscpuSource=!1;var n=WebGLContext.curBindTexTarget,i=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,3553,e),t.pixelStorei(37440,1),t.texImage2D(3553,0,6408,6408,5121,this._imgData),t.texParameteri(3553,10240,9729),t.texParameteri(3553,10241,9729),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),t.pixelStorei(37440,0),this.memorySize=this._w*this._h*4,n&&i&&WebGLContext.bindTexture(t,n,i)},n.texSubImage2D=function(t,e,n){var i=WebGL.mainContext,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;WebGLContext.bindTexture(i,3553,this._source),i.pixelStorei(37441,!0),i.texSubImage2D(3553,0,e,n,6408,5121,t._source),i.pixelStorei(37441,!1),r&&a&&WebGLContext.bindTexture(i,r,a)},__getset(0,n,"asBitmap",null,function(t){this._ctx&&(this._ctx.asBitmap=t)}),__getset(0,n,"context",function(){return this._ctx}),e._createContext=null,e}(Bitmap),Text=function(t){function e(){this._clipPoint=null,this._currBitmapFont=null,this._text=null,this._isChanged=!1,this._textWidth=0,this._textHeight=0,this._lines=[],this._lineWidths=[],this._startX=NaN,this._startY=NaN,this._lastVisibleLineIndex=-1,this._words=null,this._charSize={},this.underline=!1,this._underlineColor=null,e.__super.call(this),this.overflow=e.VISIBLE,this._style=new CSSStyle(this),this._style.wordWrap=!1}__class(e,"laya.display.Text",t);var n=e.prototype;return n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._lines=null,this._words&&(this._words.length=0,this._words=null)},n._getBoundPointsM=function(t){void 0===t&&(t=!1);var e=Rectangle.TEMP;return e.setTo(0,0,this.width,this.height),e._getBoundPoints()},n.getGraphicBounds=function(t){void 0===t&&(t=!1);var e=Rectangle.TEMP;return e.setTo(0,0,this.width,this.height),e},n._getCSSStyle=function(){return this._style},n.lang=function(t,n,i,r,a,s,o,l,h,_,u){if(t=e.langPacks&&e.langPacks[t]?e.langPacks[t]:t,arguments.length<2)this._text=t;else{for(var c=0,d=arguments.length;c<d;c++)t=t.replace("{"+c+"}",arguments[c+1]);this._text=t}},n.renderText=function(t,e){var n=this.graphics;n.clear(!0);var i=(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+(Browser.onIPhone?laya.display.Text._fontFamilyMap[this.font]||this.font:this.font);Browser.context.font=i;var r=this.padding,a=r[3],s="left",o=this._lines,l=this.leading+this._charSize.height,h=this._currBitmapFont;h&&(l=this.leading+h.getMaxHeight());var _=r[0];if(!h&&this._width>0&&this._textWidth<=this._width&&("right"==this.align?(s="right",a=this._width-r[1]):"center"==this.align&&(s="center",a=.5*this._width+r[3]-r[1])),this._height>0){var u=this._textHeight>this._height?"top":this.valign;"middle"===u?_=.5*(this._height-e*l)+r[0]-r[2]:"bottom"===u&&(_=this._height-e*l-r[2])}var c=this._style;if(h&&h.autoScaleSize)var d=h.fontSize/this.fontSize;if(this._clipPoint)if(n.save(),h&&h.autoScaleSize){var f=0,m=0;f=this._width?this._width-r[3]-r[1]:this._textWidth,m=this._height?this._height-r[0]-r[2]:this._textHeight,f*=d,m*=d,n.clipRect(r[3],r[0],f,m)}else n.clipRect(r[3],r[0],this._width?this._width-r[3]-r[1]:this._textWidth,this._height?this._height-r[0]-r[2]:this._textHeight);var p=c.password;"prompt"in this&&this.prompt==this._text&&(p=!1);for(var g=0,v=0,x=Math.min(this._lines.length,e+t)||1,S=t;S<x;S++){var T,E=o[S];if(p){var y=E.length;E="";for(var M=y;M>0;M--)E+="●"}if(g=a-(this._clipPoint?this._clipPoint.x:0),v=_+l*S-(this._clipPoint?this._clipPoint.y:0),this.underline&&this.drawUnderline(s,g,v,S),h){var D=this.width;h.autoScaleSize&&(D=this.width*d),h.drawText(E,this,g,v,this.align,D)}else Render.isWebGL?(this._words||(this._words=[]),T=this._words.length>S-t?this._words[S-t]:new WordText,T.setText(E)):T=E,c.stroke?n.fillBorderText(T,g,v,i,this.color,c.strokeColor,c.stroke,s):n.fillText(T,g,v,i,this.color,s)}if(h&&h.autoScaleSize){var C=1/d;this.scale(C,C)}this._clipPoint&&n.restore(),this._startX=a,this._startY=_},n.drawUnderline=function(t,e,n,i){var r=this._lineWidths[i];switch(t){case"center":e-=r/2;break;case"right":e-=r}n+=this._charSize.height,this._graphics.drawLine(e,n,e+r,n,this.underlineColor||this.color,1)},n.typeset=function(){if(this._isChanged=!1,!this._text)return this._clipPoint=null,this._textWidth=this._textHeight=0,void this.graphics.clear(!0);Browser.context.font=this._getCSSStyle().font,this._lines.length=0,this._lineWidths.length=0,this.parseLines(this._text),this.evalTextSize(),this.checkEnabledViewportOrNot()?this._clipPoint||(this._clipPoint=new Point(0,0)):this._clipPoint=null;var t=this._lines.length;if(this.overflow!=e.VISIBLE){var n=this.overflow==e.HIDDEN?Math.floor:Math.ceil;t=Math.min(t,n((this.height-this.padding[0]-this.padding[2])/(this.leading+this._charSize.height)))}var i=this.scrollY/(this._charSize.height+this.leading)|0;this.renderText(i,t),this.repaint()},n.evalTextSize=function(){var t=NaN,e=NaN;t=Math.max.apply(this,this._lineWidths),e=this._currBitmapFont?this._lines.length*(this._currBitmapFont.getMaxHeight()+this.leading)+this.padding[0]+this.padding[2]:this._lines.length*(this._charSize.height+this.leading)+this.padding[0]+this.padding[2],t==this._textWidth&&e==this._textHeight||(this._textWidth=t,this._textHeight=e,this._width&&this._height||this.conchModel&&this.conchModel.size(this._width||this._textWidth,this._height||this._textHeight))},n.checkEnabledViewportOrNot=function(){return this.overflow==e.SCROLL&&(this._width>0&&this._textWidth>this._width||this._height>0&&this._textHeight>this._height)},n.changeText=function(t){this._text!==t&&(this.lang(t+""),this._graphics&&this._graphics.replaceText(this._text)||this.typeset())},n.parseLines=function(t){var n=this.wordWrap||this.overflow==e.HIDDEN;if(n)var i=this.getWordWrapWidth();if(this._currBitmapFont)this._charSize.width=this._currBitmapFont.getMaxWidth(),this._charSize.height=this._currBitmapFont.getMaxHeight();else{var r=Browser.context.measureText(e._testWord);this._charSize.width=r.width,this._charSize.height=r.height||this.fontSize}for(var a=t.replace(/\r\n/g,"\n").split("\n"),s=0,o=a.length;s<o;s++){var l=a[s];n?this.parseLine(l,i):(this._lineWidths.push(this.getTextWidth(l)),this._lines.push(l))}},n.parseLine=function(t,n){var i,r=(Browser.context,this._lines),a=0,s=NaN,o=NaN,l=0;if((s=this.getTextWidth(t))<=n)return r.push(t),void this._lineWidths.push(s);s=this._charSize.width,a=Math.floor(n/s),0==a&&(a=1),s=this.getTextWidth(t.substring(0,a)),o=s;for(var h=a,_=t.length;h<_;h++)if(s=this.getTextWidth(t.charAt(h)),(o+=s)>n)if(this.wordWrap){var u=t.substring(l,h);if(u.charCodeAt(u.length-1)<255?(i=/(?:\w|-)+$/.exec(u))&&(h=i.index+l,0==i.index?h+=u.length:u=t.substring(l,h)):e.RightToLeft&&(i=/([\u0600-\u06FF])+$/.exec(u))&&(h=i.index+l,0==i.index?h+=u.length:u=t.substring(l,h)),r.push(u),this._lineWidths.push(o-s),l=h,!(h+a<_)){r.push(t.substring(l,_)),this._lineWidths.push(this.getTextWidth(r[r.length-1])),l=-1;break}h+=a,s=this.getTextWidth(t.substring(l,h)),o=s,h--}else if(this.overflow==e.HIDDEN)return r.push(t.substring(0,h)),void this._lineWidths.push(this.getTextWidth(r[r.length-1]));this.wordWrap&&-1!=l&&(r.push(t.substring(l,_)),this._lineWidths.push(this.getTextWidth(r[r.length-1])))},n.getTextWidth=function(t){return this._currBitmapFont?this._currBitmapFont.getTextWidth(t):Browser.context.measureText(t).width},n.getWordWrapWidth=function(){var t=this.padding,e=NaN;return e=this._currBitmapFont&&this._currBitmapFont.autoScaleSize?this._width*(this._currBitmapFont.fontSize/this.fontSize):this._width,e<=0&&(e=this.wordWrap?100:Browser.width),e<=0&&(e=100),e-t[3]-t[1]},n.getCharPoint=function(t,e){this._isChanged&&Laya.timer.runCallLater(this,this.typeset);for(var n=0,i=this._lines,r=0,a=0,s=i.length;a<s;a++){if(n+=i[a].length,t<n){var o=a;break}r=n}var l=(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+this.font;Browser.context.font=l;var h=this.getTextWidth(this._text.substring(r,t));return(e||new Point).setTo(this._startX+h-(this._clipPoint?this._clipPoint.x:0),this._startY+o*(this._charSize.height+this.leading)-(this._clipPoint?this._clipPoint.y:0))},__getset(0,n,"lines",function(){return this._isChanged&&this.typeset(),this._lines}),__getset(0,n,"scrollY",function(){return this._clipPoint?this._clipPoint.y:0},function(t){if(!(this.overflow!=e.SCROLL||this.textHeight<this._height)&&this._clipPoint){t=t<this.padding[0]?this.padding[0]:t;var n=this._textHeight-this._height;t=t>n?n:t;var i=t/(this._charSize.height+this.leading)|0;this._lastVisibleLineIndex=i;var r=1+(this._height/(this._charSize.height+this.leading)|0);this._clipPoint.y=t,this.renderText(i,r)}}),__getset(0,n,"scrollX",function(){return this._clipPoint?this._clipPoint.x:0},function(t){if(!(this.overflow!=e.SCROLL||this.textWidth<this._width)&&this._clipPoint){t=t<this.padding[3]?this.padding[3]:t;var n=this._textWidth-this._width;t=t>n?n:t;var i=this._height/(this._charSize.height+this.leading)|1;this._clipPoint.x=t,this.renderText(this._lastVisibleLineIndex,i)}}),__getset(0,n,"stroke",function(){return this._getCSSStyle().stroke},function(t){this._getCSSStyle().stroke=t,this.isChanged=!0}),__getset(0,n,"strokeColor",function(){return this._getCSSStyle().strokeColor},function(t){this._getCSSStyle().strokeColor=t,this.isChanged=!0}),__getset(0,n,"bold",function(){return this._getCSSStyle().bold},function(t){this._getCSSStyle().bold=t,this.isChanged=!0}),__getset(0,n,"padding",function(){return this._getCSSStyle().padding},function(t){this._getCSSStyle().padding=t,this.isChanged=!0}),__getset(0,n,"height",function(){return this._height?this._height:this.textHeight+this.padding[0]+this.padding[2]},function(e){e!=this._height&&(t.prototype._$set_height.call(this,e),this.isChanged=!0)}),__getset(0,n,"wordWrap",function(){return this._getCSSStyle().wordWrap},function(t){this._getCSSStyle().wordWrap=t,this.isChanged=!0}),__getset(0,n,"maxScrollX",function(){return this.textWidth<this._width?0:this._textWidth-this._width}),__getset(0,n,"isChanged",null,function(t){this._isChanged!==t&&(this._isChanged=t,t&&Laya.timer.callLater(this,this.typeset))}),__getset(0,n,"borderColor",function(){return this._getCSSStyle().borderColor},function(t){this._getCSSStyle().borderColor=t,this.isChanged=!0}),__getset(0,n,"text",function(){return this._text||""},function(t){this._text!==t&&(this.lang(t+""),this.isChanged=!0,this.event("change"))}),__getset(0,n,"valign",function(){return this._getCSSStyle().valign},function(t){this._getCSSStyle().valign=t,this.isChanged=!0}),__getset(0,n,"underlineColor",function(){return this._underlineColor},function(t){this._underlineColor=t,this._isChanged=!0,this.typeset()}),__getset(0,n,"italic",function(){return this._getCSSStyle().italic},function(t){this._getCSSStyle().italic=t,this.isChanged=!0}),__getset(0,n,"bgColor",function(){return this._getCSSStyle().backgroundColor},function(t){this._getCSSStyle().backgroundColor=t,this.isChanged=!0}),__getset(0,n,"color",function(){return this._getCSSStyle().color},function(t){this._getCSSStyle().color!=t&&(this._getCSSStyle().color=t,!this._isChanged&&this._graphics?this._graphics.replaceTextColor(this.color):this.isChanged=!0)}),__getset(0,n,"align",function(){return this._getCSSStyle().align},function(t){this._getCSSStyle().align=t,this.isChanged=!0}),__getset(0,n,"fontSize",function(){return this._getCSSStyle().fontSize},function(t){this._getCSSStyle().fontSize=t,this.isChanged=!0}),__getset(0,n,"textHeight",function(){return this._isChanged&&Laya.timer.runCallLater(this,this.typeset),this._textHeight}),__getset(0,n,"maxScrollY",function(){return this.textHeight<this._height?0:this._textHeight-this._height}),__getset(0,n,"leading",function(){return this._getCSSStyle().leading},function(t){this._getCSSStyle().leading=t,this.isChanged=!0}),__getset(0,n,"font",function(){return this._getCSSStyle().fontFamily},function(t){this._currBitmapFont&&(this._currBitmapFont=null,this.scale(1,1)),e._bitmapFonts&&e._bitmapFonts[t]&&(this._currBitmapFont=e._bitmapFonts[t]),this._getCSSStyle().fontFamily=t,this.isChanged=!0}),__getset(0,n,"textWidth",function(){return this._isChanged&&Laya.timer.runCallLater(this,this.typeset),this._textWidth}),__getset(0,n,"width",function(){return this._width?this._width:this.textWidth+this.padding[1]+this.padding[3]},function(e){e!=this._width&&(t.prototype._$set_width.call(this,e),this.isChanged=!0)}),e.registerBitmapFont=function(t,n){e._bitmapFonts||(e._bitmapFonts={}),e._bitmapFonts[t]=n},e.unregisterBitmapFont=function(t,n){if(void 0===n&&(n=!0),e._bitmapFonts&&e._bitmapFonts[t]){var i=e._bitmapFonts[t];n&&i.destroy(),delete e._bitmapFonts[t]}},e.setTextRightToLeft=function(){var t;t=Browser.canvas.source.style,t.display="none",t.position="absolute",t.direction="rtl",Render._mainCanvas.source.style.direction="rtl",laya.display.Text.RightToLeft=!0,Browser.document.body.appendChild(Browser.canvas.source)},e.supportFont=function(t){Browser.context.font="10px sans-serif";var e=Browser.context.measureText("abcji").width;Browser.context.font="10px "+t;var n=Browser.context.measureText("abcji").width;return console.log(e,n),e!==n},e._testWord="游",e.langPacks=null,e.VISIBLE="visible",e.SCROLL="scroll",e.HIDDEN="hidden",e.CharacterCache=!0,e.RightToLeft=!1,e._bitmapFonts=null,__static(e,["_fontFamilyMap",function(){return this._fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"}}]),e}(Sprite),Stage=function(t){function e(){function t(){"hidden"==Browser.document[a]?(n._isVisibility=!1,r._isInputting()&&(Input.inputElement.target.focus=!1)):n._isVisibility=!0,r.event("visibilitychange")}this.focus=null,this.frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="black",this._mouseMoveTime=0,this._renderCount=0,this._frameStartTime=NaN,this._isFocused=!1,this._isVisibility=!1,this._scenes=null,e.__super.call(this),this.offset=new Point,this._canvasTransform=new Matrix,this._previousOrientation=Browser.window.orientation;var n=this;this.transform=Matrix.create(),this._scenes=[],this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._displayedInStage=!0,this._isFocused=!0,this._isVisibility=!0;var i=Browser.window,r=this;i.addEventListener("focus",function(){n._isFocused=!0,r.event("focus"),r.event("focuschange")}),i.addEventListener("blur",function(){n._isFocused=!1,r.event("blur"),r.event("focuschange"),r._isInputting()&&(Input.inputElement.target.focus=!1)});var a="visibilityState",s="visibilitychange",o=i.document;void 0!==o.hidden?(s="visibilitychange",a="visibilityState"):void 0!==o.mozHidden?(s="mozvisibilitychange",a="mozVisibilityState"):void 0!==o.msHidden?(s="msvisibilitychange",a="msVisibilityState"):void 0!==o.webkitHidden&&(s="webkitvisibilitychange",a="webkitVisibilityState"),i.document.addEventListener(s,t),i.addEventListener("resize",function(){var t=Browser.window.orientation;null!=t&&t!=n._previousOrientation&&r._isInputting()&&(Input.inputElement.target.focus=!1),n._previousOrientation=t,r._isInputting()||r._resetCanvas()}),i.addEventListener("orientationchange",function(t){r._resetCanvas()}),this.on("mousemove",this,this._onmouseMove),Browser.onMobile&&this.on("mousedown",this,this._onmouseMove)}__class(e,"laya.display.Stage",t);var n=e.prototype;return n._isInputting=function(){return Browser.onMobile&&Input.isInputting},n._changeCanvasSize=function(){this.setScreenSize(Browser.clientWidth*Browser.pixelRatio,Browser.clientHeight*Browser.pixelRatio)},n._resetCanvas=function(){if(this.screenAdaptationEnabled){var t=Render._mainCanvas;t.source.style;t.size(1,1),Laya.timer.once(100,this,this._changeCanvasSize)}},n.setScreenSize=function(t,e){var n=!1;if("none"!==this._screenMode){if(n=(t/e<1?"vertical":"horizontal")!==this._screenMode){var i=e;e=t,t=i}}this.canvasRotation=n;var r=Render._mainCanvas,a=r.source.style,s=this._canvasTransform.identity(),o=this._scaleMode,l=t/this.designWidth,h=e/this.designHeight,_=this.designWidth,u=this.designHeight,c=t,d=e,f=Browser.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,o){case"noscale":l=h=1,c=this.designWidth,d=this.designHeight;break;case"showall":l=h=Math.min(l,h),_=c=Math.round(this.designWidth*l),u=d=Math.round(this.designHeight*h);break;case"noborder":l=h=Math.max(l,h),c=Math.round(this.designWidth*l),d=Math.round(this.designHeight*h);break;case"full":l=h=1,this._width=_=t,this._height=u=e;break;case"fixedwidth":h=l,this._height=u=Math.round(e/l);break;case"fixedheight":l=h,this._width=_=Math.round(t/h);break;case"fixedauto":t/e<this.designWidth/this.designHeight?(h=l,this._height=u=Math.round(e/l)):(l=h,this._width=_=Math.round(t/h))}this.conchModel&&this.conchModel.size(this._width,this._height),l*=this.scaleX,h*=this.scaleY,1===l&&1===h?this.transform.identity():(this.transform.a=this._formatData(l/(c/_)),this.transform.d=this._formatData(h/(d/u)),this.conchModel&&this.conchModel.scale(this.transform.a,this.transform.d)),r.size(_,u),RunDriver.changeWebGLSize(_,u),s.scale(c/_/f,d/u/f),"left"===this._alignH?this.offset.x=0:"right"===this._alignH?this.offset.x=t-c:this.offset.x=.5*(t-c)/f,"top"===this._alignV?this.offset.y=0:"bottom"===this._alignV?this.offset.y=e-d:this.offset.y=.5*(e-d)/f,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),s.translate(this.offset.x,this.offset.y),this.canvasDegree=0,n&&("horizontal"===this._screenMode?(s.rotate(Math.PI/2),s.translate(e/f,0),this.canvasDegree=90):(s.rotate(-Math.PI/2),s.translate(0,t/f),this.canvasDegree=-90)),s.a=this._formatData(s.a),s.d=this._formatData(s.d),s.tx=this._formatData(s.tx),s.ty=this._formatData(s.ty),a.transformOrigin=a.webkitTransformOrigin=a.msTransformOrigin=a.mozTransformOrigin=a.oTransformOrigin="0px 0px 0px",a.transform=a.webkitTransform=a.msTransform=a.mozTransform=a.oTransform="matrix("+s.toString()+")",s.translate(parseInt(a.left)||0,parseInt(a.top)||0),this.visible=!0,this._repaint=1,this.event("resize")},n._formatData=function(t){return Math.abs(t)<1e-6?0:Math.abs(1-t)<.001?t>0?1:-1:t},n.getMousePoint=function(){return Point.TEMP.setTo(this.mouseX,this.mouseY)},n.repaint=function(){this._repaint=1},n.parentRepaint=function(){},n._loop=function(){return this.render(Render.context,0,0),!0},n._onmouseMove=function(t){this._mouseMoveTime=Browser.now()},n.getTimeFromFrameStart=function(){return Browser.now()-this._frameStartTime},n.render=function(e,n,i){if("sleep"===this.frameRate){var r=Browser.now();if(!(r-this._frameStartTime>=1e3))return;this._frameStartTime=r}if(this._renderCount++,Render.isFlash&&this.repaint(),!this._style.visible)return void(this._renderCount%5==0&&(Stat.loopCount++,MouseManager.instance.runEvent(),Laya.timer._update()));this._frameStartTime=Browser.now();var a="mouse"===this.frameRate?this._frameStartTime-this._mouseMoveTime<2e3?"fast":"slow":this.frameRate,s="slow"!==a,o=this._renderCount%2==0;if(Stat.renderSlow=!s,s||o){Stat.loopCount++,MouseManager.instance.runEvent(),Laya.timer._update(),RunDriver.update3DLoop();var l,h=0,_=0;if(Render.isConchNode)for(h=0,_=this._scenes.length;h<_;h++)(l=this._scenes[h])&&l._updateSceneConch();else for(h=0,_=this._scenes.length;h<_;h++)(l=this._scenes[h])&&l._updateScene();if(Render.isConchNode){var u=Sprite.CustomList;for(h=0,_=u.length;h<_;h++){var c=u[h];c.customRender(c.customContext,0,0)}return}}Render.isConchNode||!this.renderingEnabled||!s&&o||(Render.isWebGL?(e.clear(),t.prototype.render.call(this,e,n,i),Stat._show&&Stat._sp.render(e,n,i),RunDriver.clear(this._bgColor),RunDriver.beginFlush(),e.flush(),RunDriver.endFinish(),VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose()):(RunDriver.clear(this._bgColor),t.prototype.render.call(this,e,n,i),Stat._show&&Stat._sp.render(e,n,i)))},n._requestFullscreen=function(){var t=Browser.document.documentElement;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()},n._fullScreenChanged=function(){Laya.stage.event("fullscreenchange")},n.exitFullscreen=function(){var t=Browser.document;t.exitFullscreen?t.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitExitFullscreen&&t.webkitExitFullscreen()},__getset(0,n,"fullScreenEnabled",null,function(t){var e=Browser.document,n=Render.canvas;t?(n.addEventListener("mousedown",this._requestFullscreen),n.addEventListener("touchstart",this._requestFullscreen),e.addEventListener("fullscreenchange",this._fullScreenChanged),e.addEventListener("mozfullscreenchange",this._fullScreenChanged),e.addEventListener("webkitfullscreenchange",this._fullScreenChanged),e.addEventListener("msfullscreenchange",this._fullScreenChanged)):(n.removeEventListener("mousedown",this._requestFullscreen),n.removeEventListener("touchstart",this._requestFullscreen),e.removeEventListener("fullscreenchange",this._fullScreenChanged),e.removeEventListener("mozfullscreenchange",this._fullScreenChanged),e.removeEventListener("webkitfullscreenchange",this._fullScreenChanged),e.removeEventListener("msfullscreenchange",this._fullScreenChanged))}),__getset(0,n,"screenMode",function(){return this._screenMode},function(t){this._screenMode=t}),__getset(0,n,"mouseX",function(){return Math.round(MouseManager.instance.mouseX/this.clientScaleX)}),__getset(0,n,"bgColor",function(){return this._bgColor},function(t){this._bgColor=t,this.conchModel&&this.conchModel.bgColor(t),Render.isWebGL&&(t&&"black"!==t&&"#000000"!==t?e._wgColor=Color.create(t)._color:Browser.onMiniGame||(e._wgColor=null)),Render.canvas.style.background=t||"none"}),__getset(0,n,"visible",t.prototype._$get_visible,function(e){if(this.visible!==e){t.prototype._$set_visible.call(this,e);Render._mainCanvas.source.style.visibility=e?"visible":"hidden"}}),__getset(0,n,"alignH",function(){return this._alignH},function(t){this._alignH=t,Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,n,"alignV",function(){return this._alignV},function(t){this._alignV=t,Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,n,"scaleMode",function(){return this._scaleMode},function(t){this._scaleMode=t,Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,n,"clientScaleY",function(){return this._transform?this._transform.getScaleY():1}),__getset(0,n,"isVisibility",function(){return this._isVisibility}),__getset(0,n,"isFocused",function(){return this._isFocused}),__getset(0,n,"desginHeight",function(){return console.debug("desginHeight已经弃用，请使用designHeight代替"),this.designHeight}),__getset(0,n,"desginWidth",function(){return console.debug("desginWidth已经弃用，请使用designWidth代替"),this.designWidth}),__getset(0,n,"transform",function(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||Matrix.create()},t.prototype._$set_transform),__getset(0,n,"height",t.prototype._$get_height,function(e){this.designHeight=e,t.prototype._$set_height.call(this,e),Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,n,"clientScaleX",function(){return this._transform?this._transform.getScaleX():1}),__getset(0,n,"mouseY",function(){return Math.round(MouseManager.instance.mouseY/this.clientScaleY)}),__getset(0,n,"width",t.prototype._$get_width,function(e){this.designWidth=e,t.prototype._$set_width.call(this,e),Laya.timer.callLater(this,this._changeCanvasSize)}),e.SCALE_NOSCALE="noscale",e.SCALE_EXACTFIT="exactfit",e.SCALE_SHOWALL="showall",e.SCALE_NOBORDER="noborder",e.SCALE_FULL="full",e.SCALE_FIXED_WIDTH="fixedwidth",e.SCALE_FIXED_HEIGHT="fixedheight",e.SCALE_FIXED_AUTO="fixedauto",e.ALIGN_LEFT="left",e.ALIGN_RIGHT="right",e.ALIGN_CENTER="center",e.ALIGN_TOP="top",e.ALIGN_MIDDLE="middle",e.ALIGN_BOTTOM="bottom",e.SCREEN_NONE="none",e.SCREEN_HORIZONTAL="horizontal",e.SCREEN_VERTICAL="vertical",e.FRAME_FAST="fast",e.FRAME_SLOW="slow",e.FRAME_MOUSE="mouse",e.FRAME_SLEEP="sleep",e._wgColor=null,e}(Sprite),Sprite3D=function(t){function e(t){e.__super.call(this),this.__loaded=!0,this._projectionViewWorldUpdateLoopCount=-1,this._activeInHierarchy=!1,this._projectionViewWorldMatrix=new Matrix4x4,this._shaderValues=new ValusArray,this._colliders=[],this._id=++e._uniqueIDCounter,this._transform=new Transform3D(this),this.name=t||"Sprite3D-"+e._nameNumberCounter++,this.layer=Layer.currentCreationLayer,this.active=!0}__class(e,"laya.d3.core.Sprite3D",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.IClone":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.render.IUpdate":!0}),n._addChild3D=function(t){t.transform.parent=this.transform,this._hierarchyAnimator&&(!t._hierarchyAnimator&&t._setHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(t,!0,[t.name])),this._scene&&(t._setBelongScene(this._scene),this._activeInHierarchy&&t._active&&t._activeHierarchy())},n._removeChild3D=function(t){t.transform.parent=null,this._scene&&(this._activeInHierarchy&&t._active&&t._inActiveHierarchy(),t._setUnBelongScene()),this._hierarchyAnimator&&(t._hierarchyAnimator==this._hierarchyAnimator&&t._clearHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(t,!1,[t.name]))},n._parseBaseCustomProps=function(t){var e=this.transform.localPosition;e.fromArray(t.translate),this.transform.localPosition=e;var n=this.transform.localRotation;n.fromArray(t.rotation),this.transform.localRotation=n;var i=this.transform.localScale;i.fromArray(t.scale),this.transform.localScale=i;var r=t.layer;null!=r&&(this.layer=Layer.getLayerByNumber(r))},n._parseCustomComponent=function(t,e,n){for(var i in n){var r=n[i];switch(i){case"Animator":var a=this.addComponent(Animator);if(r.avatarPath)a.avatar=Loader.getRes(e[r.avatarPath]);else{var s=r.avatar;if(s){a.avatar=Loader.getRes(e[s.path]);var o=s.linkSprites;o&&t.once("hierarchyloaded",this,this._onRootNodeHierarchyLoaded,[a,o])}}for(var l=r.clipPaths,h=l.length,_=0;_<h;_++)a.addClip(Loader.getRes(e[l[_]]));a.clip=Loader.getRes(e[l[0]]);var u=r.playOnWake;void 0!==u&&(a.playOnWake=u);break;case"Rigidbody":this.addComponent(Rigidbody);break;case"SphereCollider":var c=this.addComponent(SphereCollider);c.isTrigger=r.isTrigger;var d=c.center;d.fromArray(r.center),c.center=d,c.radius=r.radius;break;case"BoxCollider":var f=this.addComponent(BoxCollider);f.isTrigger=r.isTrigger,f.center.fromArray(r.center);var m=f.size;m.fromArray(r.size),f.size=m;break;case"MeshCollider":this.addComponent(MeshCollider)}}},n._onRootNodeHierarchyLoaded=function(t,e){for(var n in e){for(var i=this,r=e[n],a=0,s=r.length;a<s;a++){var o=r[a];if(""===o)break;if(!(i=i.getChildByName(o)))break}i&&t.linkSprite3DToAvatarNode(n,i)}},n._setHierarchyAnimator=function(t,e){this._changeHierarchyAnimator(t);for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==e&&r._setHierarchyAnimator(t,e)}},n._clearHierarchyAnimator=function(t,e){this._changeHierarchyAnimator(e)
;for(var n=0,i=this._childs.length;n<i;n++){var r=this._childs[n];r._hierarchyAnimator==t&&r._clearHierarchyAnimator(t,e)}},n._getAnimatorToLinkSprite3D=function(t,e,n){var i=this.getComponentByType(Animator);if(i&&(i.avatar?i.avatar._version||t._setAnimatorToLinkAvatar(i,e):t._setAnimatorToLinkSprite3DNoAvatar(i,e,n)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D){n.unshift(this._parent.name);var r=this._parent;r._hierarchyAnimator&&r._getAnimatorToLinkSprite3D(t,e,n)}},n._setAnimatorToLinkSprite3DNoAvatar=function(t,e,n){var i=0,r=0;for(i=0,r=t.getClipCount();i<r;i++)t._handleSpriteOwnersBySprite(i,e,n,this);for(i=0,r=this._childs.length;i<r;i++){var a=this._childs[i],s=n.length;n.push(a.name),a._setAnimatorToLinkSprite3DNoAvatar(t,e,n),n.splice(s,1)}},n._changeHierarchyAnimator=function(t){this._hierarchyAnimator=t},n._isLinkSpriteToAnimationNode=function(t,e,n){var i=t._avatarNodes.indexOf(e),r=t._cacheSpriteToNodesMap;if(n)this._transform.dummy=e._transform,t._cacheNodesToSpriteMap[i]=r.length,r.push(i);else{this._transform.dummy=null;var a=t._cacheNodesToSpriteMap[i];t._cacheNodesToSpriteMap[i]=null,r.splice(a,1)}},n._setBelongScene=function(t){this._scene=t;for(var e=0,n=this._childs.length;e<n;e++)this._childs[e]._setBelongScene(t)},n._setUnBelongScene=function(){this._scene=null;for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._setUnBelongScene()},n._activeHierarchy=function(){var t=0,e=0;for(this._activeInHierarchy=!0,this._addSelfRenderObjects(),t=0,e=this._colliders.length;t<e;t++)this._layer._addCollider(this._colliders[t]);for(this.event("activeinhierarchychanged",!0),t=0,e=this._childs.length;t<e;t++){var n=this._childs[t];n._active&&n._activeHierarchy()}},n._inActiveHierarchy=function(){var t=0,e=0;for(this._activeInHierarchy=!1,this._clearSelfRenderObjects(),t=0,e=this._colliders.length;t<e;t++){var n=this._colliders[t];n._clearCollsionMap(),this._layer._removeCollider(n)}for(this.event("activeinhierarchychanged",!1),t=0,e=this._childs.length;t<e;t++){var i=this._childs[t];i._active&&i._inActiveHierarchy()}},n._addComponent=function(t){var e,n=this._componentsMap.indexOf(t);if(-1===n)e=[],this._componentsMap.push(t),this._typeComponentsIndices.push(e);else if(e=this._typeComponentsIndices[n],this._components[e[0]].isSingleton)throw new Error("无法单实例创建"+t+"组件，"+t+"组件已存在！");var i=ClassUtils.getInstance(t);if(e.push(this._components.length),this._components.push(i),i instanceof laya.d3.component.physics.Collider){this.getComponentByType(Rigidbody)&&(i._isRigidbody=!0),this.displayedInStage&&this._layer._addCollider(i),this._colliders.push(i)}else if(i instanceof laya.d3.component.Animator){var r=i;this._setHierarchyAnimator(r,this._parent?this._parent._hierarchyAnimator:null),this._setAnimatorToLinkSprite3DNoAvatar(r,!0,[])}else if(i instanceof laya.d3.component.Rigidbody)for(var a=0,s=this._colliders.length;a<s;a++)this._colliders[a]._setIsRigidbody(!0);return i instanceof laya.d3.component.Script&&this._scripts.push(i),i._initialize(this),i},n._removeComponent=function(t,e){var n=0,i=0,r=this._typeComponentsIndices[t],a=r[e],s=this._components[a];if(s instanceof laya.d3.component.physics.Collider){var o=s;this.displayedInStage&&this._layer._removeCollider(o),this._colliders.splice(this._colliders.indexOf(o),1)}else if(s instanceof laya.d3.component.Animator){var l=s;this._clearHierarchyAnimator(l,this._parent?this._parent._hierarchyAnimator:null)}else if(s instanceof laya.d3.component.Rigidbody)for(n=0,i=this._colliders.length;n<i;n++){var h=this._colliders[n];h._setIsRigidbody(!1);var _=h._runtimeCollisonMap,u=h._runtimeCollisonTestMap;for(var c in _)delete u[c]}for(this._components.splice(a,1),s instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(s),1),r.splice(e,1),0===r.length&&(this._typeComponentsIndices.splice(t,1),this._componentsMap.splice(t,1)),n=0,i=this._componentsMap.length;n<i;n++){r=this._typeComponentsIndices[n];for(var d=r.length-1;d>=0;d--){var f=r[d];if(!(f>a))break;r[d]=--f}}s._destroy()},n.createConchModel=function(){return null},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._parseCustomProps=function(t,e,n,i){},n._updateChilds=function(t){var e=this._childs.length;if(0!==e)for(var n=0;n<e;++n)this._childs[n]._update(t)},n._updateChildsConch=function(t){var e=this._childs.length;if(0!==e)for(var n=0;n<e;++n)this._childs[n]._update(t)},n._getSortID=function(t,e){return 1e3*e.id+t._getVertexBuffer().vertexDeclaration.id},n._update=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._lateUpdateComponents(t),Stat.spriteCount++,this._childs.length&&this._updateChilds(t))},n._updateConch=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._lateUpdateComponents(t),Stat.spriteCount++,this._childs.length&&this._updateChilds(t))},n.getProjectionViewWorldMatrix=function(t){return Matrix4x4.multiply(t,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},n.loadHierarchy=function(t){this.addChild(laya.d3.core.Sprite3D.load(t))},n.addChildAt=function(t,e){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),e>=0&&e<=this._childs.length){if(t._parent===this){var n=this.getChildIndex(t);this._childs.splice(n,1),this._childs.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged()}else t.parent&&t.parent.removeChild(t),this._childs===Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(e,0,t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,e),t.parent=this,this._addChild3D(t);return t}throw new Error("appendChildAt:The index is out of bounds")},n.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var e=this.getChildIndex(t);e!==this._childs.length-1&&(this._childs.splice(e,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else t.parent&&t.parent.removeChild(t),this._childs===Node.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged(),this._addChild3D(t);return t},n.removeChildAt=function(t){var e=this.getChildAt(t);return e&&(this._removeChild3D(e),this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null),e},n.removeChildren=function(t,e){if(void 0===t&&(t=0),void 0===e&&(e=2147483647),this._childs&&this._childs.length>0){var n=this._childs;if(0===t&&e>=a){var i=n;this._childs=Node.ARRAY_EMPTY}else i=n.splice(t,e-t);for(var r=0,a=i.length;r<a;r++)this._removeChild3D(i[r]),i[r].parent=null,this.conchModel&&this.conchModel.removeChild(i[r].conchModel)}return this},n.addComponent=function(t){return this._addComponent(t)},n.getComponentByType=function(t,e){return void 0===e&&(e=0),this._getComponentByType(t,e)},n.getComponentsByType=function(t,e){return this._getComponentsByType(t,e)},n.getComponentByIndex=function(t){return this._getComponentByIndex(t)},n.removeComponentByType=function(t,e){void 0===e&&(e=0),this._removeComponentByType(t,e)},n.removeComponentsByType=function(t){this._removeComponentByType(t)},n.removeAllComponent=function(){this._removeAllComponent()},n.onAsynLoaded=function(t,e,n){if(!this.destroyed){var i=e[0];if("Sprite3D"!==i.type)throw new Error("Sprite3D: The .lh file root type must be Sprite3D,please use other function to  load  this file.");var r=e[1];Utils3D._createNodeByJson(this,i,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0}},n.cloneTo=function(t){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var e=t;e.name=this.name,e.destroyed=this.destroyed,e.timer=this.timer,e._$P=this._$P,e.active=this._active;var n=e.transform.localPosition;this.transform.localPosition.cloneTo(n),e.transform.localPosition=n;var i=e.transform.localRotation;this.transform.localRotation.cloneTo(i),e.transform.localRotation=i;var r=e.transform.localScale;this.transform.localScale.cloneTo(r),e.transform.localScale=r,e.isStatic=this.isStatic;var a=0,s=0;for(a=0,s=this._componentsMap.length;a<s;a++){var o=e.addComponent(this._componentsMap[a]);this._components[a]._cloneTo(o)}for(a=0,s=this._childs.length;a<s;a++)e.addChild(this._childs[a].clone())},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},n.destroy=function(t){if(void 0===t&&(t=!0),!this.destroyed){laya.display.Node.prototype.destroy.call(this,t);var e=0,n=0;for(e=0,n=this._components.length;e<n;e++)this._components[e]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this._transform=null,this._colliders=null,Loader.clearRes(this.url)}},n._handleSpriteToAvatar=function(t,e){var n=(t._avatarNodes,t._avatarNodeMap[this.name]);n&&n.name===this.name&&!this._transform.dummy&&this._isLinkSpriteToAnimationNode(t,n,e)},n._setAnimatorToLinkAvatar=function(t,e){this._handleSpriteToAvatar(t,e);for(var n=0,i=this._childs.length;n<i;n++){this._childs[n]._setAnimatorToLinkAvatar(t,e)}},__getset(0,n,"url",function(){return this._url},function(t){this._url=t}),__getset(0,n,"transform",function(){return this._transform}),__getset(0,n,"scene",function(){return this._scene}),__getset(0,n,"_loaded",null,function(t){this.__loaded=t}),__getset(0,n,"activeInHierarchy",function(){return this._activeInHierarchy}),__getset(0,n,"loaded",function(){return this.__loaded}),__getset(0,n,"layer",function(){return this._layer},function(t){if(!t)throw new Error("Layer value can be null.");if(this.displayedInStage){var e=0,n=this._colliders.length;if(this._layer)for(e=0;e<n;e++)this._layer._removeCollider(this._colliders[e]);for(e=0;e<n;e++)t._addCollider(this._colliders[e])}this._layer=t,this.event("layerchanged",t)}),__getset(0,n,"id",function(){return this._id}),__getset(0,n,"componentsCount",function(){return this._components.length}),__getset(0,n,"active",function(){return this._active},function(t){this._active!==t&&(this._active=t,this._parent&&(this._parent===this._scene&&this._parent.displayedInStage||this._parent._activeInHierarchy)&&(t?this._activeHierarchy():this._inActiveHierarchy()))}),e.instantiate=function(t,e,n,i,r){void 0===n&&(n=!0);var a=t.clone();e&&e.addChild(a);var s=a.transform;if(n){var o=s.worldMatrix;t.transform.worldMatrix.cloneTo(o),s.worldMatrix=o}else i&&(s.position=i),r&&(s.rotation=r);return a},e.load=function(t){return Laya.loader.create(t,null,null,e)},e.WORLDMATRIX=0,e.MVPMATRIX=1,e._uniqueIDCounter=0,e._nameNumberCounter=0,e}(ComponentNode),Shader3D=function(t){function e(t,n,i,r,a,s,o,l){if(this.customCompile=!1,this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],e.__super.call(this),!t||!n)throw"Shader Error";(Render.isConchApp||Render.isFlash)&&(this.customCompile=!0),this._id=++e._count,this._vs=t,this._ps=n,this._attributeMap=i,this._sceneUniformMap=r,this._cameraUniformMap=a,this._spriteUniformMap=s,this._materialUniformMap=o,this._renderElementUniformMap=l,this.recreateResource()}__class(e,"laya.d3.shader.Shader3D",t);var n=e.prototype;return n.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},n.detoryResource=function(){WebGL.mainContext.deleteShader(this._vshader),WebGL.mainContext.deleteShader(this._pshader),WebGL.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},n._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var t=[this._vs,this._ps],n=WebGL.mainContext;if(this._program=n.createProgram(),this._vshader=e._createShader(n,t[0],35633),this._pshader=e._createShader(n,t[1],35632),n.attachShader(this._program,this._vshader),n.attachShader(this._program,this._pshader),n.linkProgram(this._program),ShaderCompile3D.debugMode&&!this.customCompile&&!n.getProgramParameter(this._program,35714))throw n.getProgramInfoLog(this._program);var i,r,a=0,s=0,o=this.customCompile?(void 0).attributes.length:n.getProgramParameter(this._program,35721);for(a=0;a<o;a++){var l=this.customCompile?(void 0).attributes[a]:n.getActiveAttrib(this._program,a);r=n.getAttribLocation(this._program,l.name),i={vartype:"attribute",ivartype:0,attrib:l,location:r,name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._attributeParams.push(i)}var h=this.customCompile?(void 0).uniforms.length:n.getProgramParameter(this._program,35718);for(a=0;a<h;a++){var _=this.customCompile?(void 0).uniforms[a]:n.getActiveUniform(this._program,a);r=n.getUniformLocation(this._program,_.name),i={vartype:"uniform",ivartype:1,attrib:l,location:r,name:_.name,type:_.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},i.name.indexOf("[0]")>0&&(i.name=i.name.substr(0,i.name.length-3),i.isArray=!0,i.location=n.getUniformLocation(this._program,i.name)),this._uniformParams.push(i)}for(a=0,s=this._attributeParams.length;a<s;a++)i=this._attributeParams[a],i.indexOfParams=a,i.index=1,i.value=[i.location,null],i.codename=i.name,i.name=null!=this._attributeMap[i.codename]?this._attributeMap[i.codename]:i.codename,this._attributeParamsMap.push(i.name),this._attributeParamsMap.push(i),i._this=this,i.uploadedValue=[],i.fun=this._attribute;for(a=0,s=this._uniformParams.length;a<s;a++)switch(i=this._uniformParams[a],i.indexOfParams=a,i.index=1,i.value=[i.location,null],i.codename=i.name,null!=this._sceneUniformMap[i.codename]?(i.name=this._sceneUniformMap[i.codename],this._sceneUniformParamsMap.push(i.name),this._sceneUniformParamsMap.push(i)):null!=this._cameraUniformMap[i.codename]?(i.name=this._cameraUniformMap[i.codename],this._cameraUniformParamsMap.push(i.name),this._cameraUniformParamsMap.push(i)):null!=this._spriteUniformMap[i.codename]?(i.name=this._spriteUniformMap[i.codename],this._spriteUniformParamsMap.push(i.name),this._spriteUniformParamsMap.push(i)):null!=this._materialUniformMap[i.codename]?(i.name=this._materialUniformMap[i.codename],this._materialUniformParamsMap.push(i.name),this._materialUniformParamsMap.push(i)):null!=this._renderElementUniformMap[i.codename]?(i.name=this._renderElementUniformMap[i.codename],this._renderElementUniformParamsMap.push(i.name),this._renderElementUniformParamsMap.push(i)):console.log("Shader:can't find uinform name:"+i.codename+" in shader file."),i._this=this,i.uploadedValue=[],i.type){case 5124:i.fun=i.isArray?this._uniform1iv:this._uniform1i;break;case 5126:i.fun=i.isArray?this._uniform1fv:this._uniform1f;break;case 35664:i.fun=i.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:i.fun=i.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:i.fun=i.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:i.fun=this._uniform_sampler2D;break;case 35680:i.fun=this._uniform_samplerCube;break;case 35676:i.fun=this._uniformMatrix4fv;break;case 35670:i.fun=this._uniform1i;break;case 35674:i.fun=this._uinformMatrix2fv;break;case 35675:i.fun=this._uinformMatrix3fv;break;default:throw new Error("compile shader err!")}}},n._attribute=function(t,e){var n=WebGL.mainContext,i=Buffer._enableAtributes,r=t.location;return i[r]||n.enableVertexAttribArray(r),n.vertexAttribPointer(r,e[0],e[1],e[2],e[3],e[4]),i[r]=Buffer._bindVertexBuffer,1},n._uniform1f=function(t,e){var n=t.uploadedValue;return n[0]!==e?(WebGL.mainContext.uniform1f(t.location,n[0]=e),1):0},n._uniform1fv=function(t,e){if(e.length<4){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform1fv(t.location,e),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],1):0}return WebGL.mainContext.uniform1fv(t.location,e),1},n._uniform_vec2=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]?(WebGL.mainContext.uniform2f(t.location,n[0]=e[0],n[1]=e[1]),1):0},n._uniform_vec2v=function(t,e){if(e.length<2){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform2fv(t.location,e),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],1):0}return WebGL.mainContext.uniform2fv(t.location,e),1},n._uniform_vec3=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]?(WebGL.mainContext.uniform3f(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2]),1):0},n._uniform_vec3v=function(t,e){return WebGL.mainContext.uniform3fv(t.location,e),1},n._uniform_vec4=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform4f(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3]),1):0},n._uniform_vec4v=function(t,e){return WebGL.mainContext.uniform4fv(t.location,e),1},n._uniformMatrix2fv=function(t,e){return WebGL.mainContext.uniformMatrix2fv(t.location,!1,e),1},n._uniformMatrix3fv=function(t,e){return WebGL.mainContext.uniformMatrix3fv(t.location,!1,e),1},n._uniformMatrix4fv=function(t,e){return WebGL.mainContext.uniformMatrix4fv(t.location,!1,e),1},n._uinformMatrix2fv=function(t,e){return WebGL.mainContext.uniformMatrix2fv(t.location,!1,e),1},n._uinformMatrix3fv=function(t,e){return WebGL.mainContext.uniformMatrix3fv(t.location,!1,e),1},n._uniform1i=function(t,e){var n=t.uploadedValue;return n[0]!==e?(WebGL.mainContext.uniform1i(t.location,n[0]=e),1):0},n._uniform1iv=function(t,e){return WebGL.mainContext.uniform1iv(t.location,e),1},n._uniform_ivec2=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]?(WebGL.mainContext.uniform2i(t.location,n[0]=e[0],n[1]=e[1]),1):0},n._uniform_ivec2v=function(t,e){return WebGL.mainContext.uniform2iv(t.location,e),1},n._uniform_vec3i=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]?(WebGL.mainContext.uniform3i(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2]),1):0},n._uniform_vec3vi=function(t,e){return WebGL.mainContext.uniform3iv(t.location,e),1},n._uniform_vec4i=function(t,e){var n=t.uploadedValue;return n[0]!==e[0]||n[1]!==e[1]||n[2]!==e[2]||n[3]!==e[3]?(WebGL.mainContext.uniform4i(t.location,n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3]),1):0},n._uniform_vec4vi=function(t,e){return WebGL.mainContext.uniform4iv(t.location,e),1},n._uniform_sampler2D=function(t,n){var i=n.source||n.defaulteTexture.source,r=WebGL.mainContext,a=t.uploadedValue;if(null==a[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return a[0]=this._curActTexIndex,r.uniform1i(t.location,this._curActTexIndex),r.activeTexture(e._TEXTURES[this._curActTexIndex]),i&&WebGLContext.bindTexture(r,3553,i),this._curActTexIndex++,1}return r.activeTexture(e._TEXTURES[a[0]]),i&&WebGLContext.bindTexture(r,3553,i),0},n._uniform_samplerCube=function(t,n){var i=n.source||n.defaulteTexture.source,r=WebGL.mainContext,a=t.uploadedValue;if(null==a[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return a[0]=this._curActTexIndex,r.uniform1i(t.location,this._curActTexIndex),r.activeTexture(e._TEXTURES[this._curActTexIndex]),i?WebGLContext.bindTexture(r,34067,i):WebGLContext.bindTexture(r,34067,SolidColorTextureCube.grayTexture.source),this._curActTexIndex++,1}return r.activeTexture(e._TEXTURES[a[0]]),i?WebGLContext.bindTexture(r,34067,i):WebGLContext.bindTexture(r,34067,SolidColorTextureCube.grayTexture.source),0},n._noSetValue=function(t){console.log("no....:"+t.name)},n.bind=function(){return BaseShader.activeShader=this,BaseShader.bindShader=this,this.activeResource(),WebGLContext.UseProgram(this._program)},n.uploadAttributes=function(t,e){for(var n,i,r=0,a=0,s=this._attributeParamsMap.length;a<s;a+=2)i=this._attributeParamsMap[a+1],null!=(n=t[this._attributeParamsMap[a]])&&(e&&e[i.name]&&e[i.name].bind(),r+=i.fun.call(this,i,n));Stat.shaderCall+=r},n.uploadSceneUniforms=function(t){for(var e,n,i=0,r=0,a=this._sceneUniformParamsMap.length;r<a;r+=2)n=this._sceneUniformParamsMap[r+1],null!=(e=t[this._sceneUniformParamsMap[r]])&&(i+=n.fun.call(this,n,e));Stat.shaderCall+=i},n.uploadCameraUniforms=function(t){for(var e,n,i=0,r=0,a=this._cameraUniformParamsMap.length;r<a;r+=2)n=this._cameraUniformParamsMap[r+1],null!=(e=t[this._cameraUniformParamsMap[r]])&&(i+=n.fun.call(this,n,e));Stat.shaderCall+=i},n.uploadSpriteUniforms=function(t){for(var e,n,i=0,r=0,a=this._spriteUniformParamsMap.length;r<a;r+=2)n=this._spriteUniformParamsMap[r+1],null!=(e=t[this._spriteUniformParamsMap[r]])&&(i+=n.fun.call(this,n,e));Stat.shaderCall+=i},n.uploadMaterialUniforms=function(t){for(var e,n,i=0,r=0,a=this._materialUniformParamsMap.length;r<a;r+=2)n=this._materialUniformParamsMap[r+1],null!=(e=t[this._materialUniformParamsMap[r]])&&(i+=n.fun.call(this,n,e));Stat.shaderCall+=i},n.uploadRenderElementUniforms=function(t){for(var e,n,i=0,r=0,a=this._renderElementUniformParamsMap.length;r<a;r+=2)n=this._renderElementUniformParamsMap[r+1],null!=(e=t[this._renderElementUniformParamsMap[r]])&&(i+=n.fun.call(this,n,e));Stat.shaderCall+=i},e.create=function(t,n,i,r,a,s,o,l){return new e(t,n,i,r,a,s,o,l)},e.addInclude=function(t,e){ShaderCompile.addInclude(t,e)},e._createShader=function(t,e,n){var i=t.createShader(n);if(t.shaderSource(i,e),t.compileShader(i),ShaderCompile3D.debugMode&&!t.getShaderParameter(i,35713))throw t.getShaderInfoLog(i);return i},e.PERIOD_RENDERELEMENT=0,e.PERIOD_MATERIAL=1,e.PERIOD_SPRITE=2,e.PERIOD_CAMERA=3,e.PERIOD_SCENE=4,e._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,33991],e._count=0,__static(e,["shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new StringKey}]),e}(BaseShader),VertexBuffer3D=function(t){function e(t,n,i,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),e.__super.call(this),this._vertexDeclaration=t,this._vertexCount=n,this._bufferUsage=i,this._bufferType=34962,this._canRead=r,this.memorySize=this._byteLength=this._vertexDeclaration.vertexStride*n,Render.isConchNode||(this._bind(),Buffer._gl.bufferData(this._bufferType,this._byteLength,this._bufferUsage)),r&&(this._buffer=new Float32Array(this._byteLength/4))}__class(e,"laya.d3.graphics.VertexBuffer3D",t);var n=e.prototype;return n.bindWithIndexBuffer=function(t){t&&t._bind(),this._bind()},n.setData=function(t,e,n,i){if(void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=4294967295),0===n&&4294967295===i||(t=new Float32Array(t.buffer,4*n,i)),Render.isConchNode||(this._bind(),Buffer._gl.bufferSubData(this._bufferType,4*e,t)),this._canRead)if(0!==e||0!==n||4294967295!==i){var r=this._buffer.length-e;i>r&&(i=r);for(var a=0;a<i;a++)this._buffer[e+a]=t[a]}else this._buffer=t},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.detoryResource=function(){for(var e=WebGL.mainContext,n=this._vertexDeclaration.getVertexElements(),i=Buffer._enableAtributes,r=0,a=n.length;r<a;r++)i[r]===this._glBuffer&&(e.disableVertexAttribArray(r),i[r]=null);t.prototype.detoryResource.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},__getset(0,n,"canRead",function(){return this._canRead}),__getset(0,n,"vertexCount",function(){return this._vertexCount}),__getset(0,n,"vertexDeclaration",function(){return this._vertexDeclaration}),e.create=function(t,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new e(t,n,i,r)},e}(Buffer),TextSV=function(t){function e(t){e.__super.call(this,64),this.defines.add(64)}__class(e,"laya.webgl.shader.d2.value.TextSV",t);var n=e.prototype;return n.release=function(){e.pool[e._length++]=this,this.clear()},n.clear=function(){t.prototype.clear.call(this)},e.create=function(){return e._length?e.pool[--e._length]:new e(null)},e.pool=[],e._length=0,e}(TextureSV),IndexBuffer3D=function(t){function e(t,n,i,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===i&&(i=35044),void 0===r&&(r=!1),e.__super.call(this),this._indexType=t,this._indexCount=n,this._bufferUsage=i,this._bufferType=34963,this._canRead=r;var a=0;if("ushort"==t)this._indexTypeByteCount=2;else{if("ubyte"!=t)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*n,this._byteLength=a,Render.isConchNode||(this._bind(),Buffer._gl.bufferData(this._bufferType,a,this._bufferUsage)),r?("ushort"==t?this._buffer=new Uint16Array(n):"ubyte"==t&&(this._buffer=new Uint8Array(n)),this.memorySize=2*a):this.memorySize=a}__class(e,"laya.d3.graphics.IndexBuffer3D",t);var n=e.prototype;return n.setData=function(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0===n&&4294967295===i||(t=new Uint16Array(t.buffer,n*r,i))):"ubyte"==this._indexType&&(r=1,0===n&&4294967295===i||(t=new Uint8Array(t.buffer,n*r,i))),Render.isConchNode||(this._bind(),Buffer._gl.bufferSubData(this._bufferType,e*r,t)),this._canRead)if(0!==e||0!==n||4294967295!==i){var a=this._buffer.length-e;i>a&&(i=a);for(var s=0;s<i;s++)this._buffer[e+s]=t[s]}else this._buffer=t},n.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},n.detoryResource=function(){t.prototype.detoryResource.call(this),this._buffer=null,this.memorySize=0},__getset(0,n,"canRead",function(){return this._canRead}),__getset(0,n,"indexCount",function(){return this._indexCount}),__getset(0,n,"indexTypeByteCount",function(){return this._indexTypeByteCount}),__getset(0,n,"indexType",function(){return this._indexType}),e.INDEXTYPE_UBYTE="ubyte",e.INDEXTYPE_USHORT="ushort",e.create=function(t,n,i,r){return void 0===i&&(i=35044),void 0===r&&(r=!1),new e(t,n,i,r)},e}(Buffer),ShurikenParticleMaterial=function(t){function e(){e.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this.renderMode=6}__class(e,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",t);var n=e.prototype;return n.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)t.prototype.onAsynLoaded.call(this,n,i,r);else{var s=i[1],o=a.props;for(var l in o)this[l]=o[l];e._parseShurikenParticleMaterial(s,this,a),this._endLoaded()}},__getset(0,n,"tilingOffset",function(){return this._getColor(3)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,t)}),__getset(0,n,"tintColor",function(){return this._getColor(2)},function(t){t?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._setColor(2,t)}),__getset(0,n,"diffuseTexture",function(){return this._getTexture(0)},function(t){t?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),__getset(0,n,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e._parseShurikenParticleMaterial=function(t,e,n){var i=n.customProps,r=i.diffuseTexture.texture2D;r&&(e.diffuseTexture=Loader.getRes(t[r]));var a=i.tintColor;a&&(e.tintColor=new Vector4(a[0],a[1],a[2],a[3]))},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_TINTCOLOR=0,e.SHADERDEFINE_TILINGOFFSET=0,e.SHADERDEFINE_ADDTIVEFOG=0,e.DIFFUSETEXTURE=1,e.TINTCOLOR=2,e.TILINGOFFSET=3,e._diffuseTextureIndex=0,
__static(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(BaseMaterial),ExtendTerrainMaterial=function(t){function e(){e.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1}__class(e,"laya.d3.core.material.ExtendTerrainMaterial",t);var n=e.prototype;return n._setDetailNum=function(t){switch(t){case 1:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}},n.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},__getset(0,n,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),__getset(0,n,"specularColor",function(){return this._getColor(13)},function(t){this._setColor(13,t)}),__getset(0,n,"ambientColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),__getset(0,n,"albedo",function(){return this._getColor(14)},function(t){this._setColor(14,t)}),__getset(0,n,"diffuseColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),__getset(0,n,"diffuseScaleOffset2",null,function(t){this._setColor(7,t)}),__getset(0,n,"diffuseScaleOffset4",null,function(t){this._setColor(9,t)}),__getset(0,n,"diffuseScaleOffset5",null,function(t){this._setColor(10,t)}),__getset(0,n,"diffuseScaleOffset3",null,function(t){this._setColor(8,t)}),__getset(0,n,"diffuseTexture5",function(){return this._getTexture(5)},function(t){this._setTexture(5,t),this._setDetailNum(5)}),__getset(0,n,"diffuseScaleOffset1",null,function(t){this._setColor(6,t)}),__getset(0,n,"diffuseTexture4",function(){return this._getTexture(4)},function(t){this._setTexture(4,t),this._setDetailNum(4)}),__getset(0,n,"diffuseTexture3",function(){return this._getTexture(3)},function(t){this._setTexture(3,t),this._setDetailNum(3)}),__getset(0,n,"diffuseTexture2",function(){return this._getTexture(2)},function(t){this._setTexture(2,t),this._setDetailNum(2)}),__getset(0,n,"diffuseTexture1",null,function(t){this._setTexture(1,t),this._setDetailNum(1)}),__getset(0,n,"splatAlphaTexture",function(){return this._getTexture(0)},function(t){this._setTexture(0,t)}),e.RENDERMODE_OPAQUE=1,e.RENDERMODE_TRANSPARENT=2,e.SPLATALPHATEXTURE=0,e.DIFFUSETEXTURE1=1,e.DIFFUSETEXTURE2=2,e.DIFFUSETEXTURE3=3,e.DIFFUSETEXTURE4=4,e.DIFFUSETEXTURE5=5,e.DIFFUSESCALEOFFSET1=6,e.DIFFUSESCALEOFFSET2=7,e.DIFFUSESCALEOFFSET3=8,e.DIFFUSESCALEOFFSET4=9,e.DIFFUSESCALEOFFSET5=10,e.MATERIALAMBIENT=11,e.MATERIALDIFFUSE=12,e.MATERIALSPECULAR=13,e.MATERIALALBEDO=14,e.SHADERDEFINE_DETAIL_NUM1=0,e.SHADERDEFINE_DETAIL_NUM2=0,e.SHADERDEFINE_DETAIL_NUM3=0,e.SHADERDEFINE_DETAIL_NUM4=0,e.SHADERDEFINE_DETAIL_NUM5=0,e}(BaseMaterial),WaterMaterial=function(t){function e(){this._useVertexDeep=!1,e.__super.call(this),this.setShaderName("Water")}__class(e,"laya.d3.core.material.WaterMaterial",t);var n=e.prototype;return n.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},n.onAsynLoaded=function(e,n,i){t.prototype.onAsynLoaded.call(this,e,n,i)},__getset(0,n,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),__getset(0,n,"useRefractTexture",null,function(t){t?this._addShaderDefine(e.SHADERDEFINE_USE_REFRACT_TEX):this._removeShaderDefine(e.SHADERDEFINE_USE_REFRACT_TEX)}),__getset(0,n,"useFoam",null,function(t){t?this._addShaderDefine(e.SHADERDEFINE_USE_FOAM):this._removeShaderDefine(e.SHADERDEFINE_USE_FOAM)}),__getset(0,n,"deepScale",function(){return this._getNumber(20)},function(t){this._setNumber(20,t)}),__getset(0,n,"seaColor",function(){return this._getBuffer(19)},function(t){this._setBuffer(19,t)}),__getset(0,n,"waveMainDir",function(){return this._getNumber(14)},function(t){this._setNumber(14,t*Math.PI/180)}),__getset(0,n,"waveInfoD",function(){return this._getBuffer(13)},function(t){this._setBuffer(13,t)}),__getset(0,n,"scrsize",null,function(t){this._setBuffer(15,t)}),__getset(0,n,"currentTm",function(){return this._getNumber(8)},function(t){this._setNumber(8,t)}),__getset(0,n,"deepColorTexture",function(){return this._getTexture(10)},function(t){this._setTexture(10,t)}),__getset(0,n,"detailTexture",function(){return this._getTexture(9)},function(t){this._setTexture(9,t)}),__getset(0,n,"foamTexture",function(){return this._getTexture(17)},function(t){this._setTexture(17,t)}),__getset(0,n,"useVertexDeep",function(){return this._useVertexDeep},function(t){this._useVertexDeep=t,t?this._addShaderDefine(e.SHADERDEFINE_USEVERTEXHEIGHT):this._removeShaderDefine(e.SHADERDEFINE_USEVERTEXHEIGHT)}),__getset(0,n,"skyTexture",function(){return this._getTexture(11)},function(t){this._setTexture(11,t)}),__getset(0,n,"windSpeed",function(){return 0},function(t){}),__getset(0,n,"waterInfoTexture",function(){return this._getTexture(16)},function(t){this._setTexture(16,t)}),__getset(0,n,"geoWaveUVScale",function(){return this._getNumber(18)},function(t){this._setNumber(18,t)}),__getset(0,n,"vertexDispTexture",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),__getset(0,n,"underWaterTexture",function(){return this._getTexture(3)},function(t){this._setTexture(3,t)}),__getset(0,n,"waveInfo",function(){return this._getBuffer(12)},function(t){this._setBuffer(12,t)}),__getset(0,n,"normalTexture",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),__getset(0,n,"windDir",function(){return 0},function(t){}),__getset(0,n,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.UNDERWATERTEXTURE=3,e.VERTEXDISPTEXTURE=4,e.UVANIAGE=5,e.UVMATRIX=6,e.UVAGE=7,e.CURTM=8,e.DETAILTEXTURE=9,e.DEEPCOLORTEXTURE=10,e.SKYTEXTURE=11,e.WAVEINFO=12,e.WAVEINFOD=13,e.WAVEMAINDIR=14,e.SCRSIZE=15,e.WATERINFO=16,e.FOAMTEXTURE=17,e.GEOWAVE_UV_SCALE=18,e.SEA_COLOR=19,e.WAVEINFODEEPSCALE=20,e.SHADERDEFINE_SHOW_NORMAL=0,e.SHADERDEFINE_CUBE_ENV=0,e.SHADERDEFINE_HDR_ENV=0,e.SHADERDEFINE_USE_FOAM=0,e.SHADERDEFINE_USE_REFRACT_TEX=0,e.SHADERDEFINE_USEVERTEXHEIGHT=0,e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,__static(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(BaseMaterial),PBRStandardMaterial=function(t){function e(){e.__super.call(this),this.setShaderName("PBRStandard"),this._setColor(7,new Vector4(1,1,1,1)),this._setColor(8,new Vector4(0,0,0,0)),this._setNumber(9,0),this._setNumber(10,.5),this._setNumber(11,1),this._setNumber(12,0),this._setNumber(13,1),this._setNumber(14,1),this._setNumber(15,.001),this._setBool(16,!1),this._setNumber(0,.5)}__class(e,"laya.d3.core.material.PBRStandardMaterial",t);var n=e.prototype;return __getset(0,n,"tilingOffset",null,function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(17,t)}),__getset(0,n,"emissionColor",function(){return this._getColor(8)},function(t){this._setColor(8,t)}),__getset(0,n,"enableEmission",function(){return this._getBool(16)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION),this._setBool(16,t)}),__getset(0,n,"smoothnessSource",function(){return this._getNumber(12)},function(t){1==t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA):(this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA),t=0),this._setNumber(12,t)}),__getset(0,n,"smoothnessTextureScale",function(){return this._getNumber(11)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(11,t)}),__getset(0,n,"parallaxTextureScale",function(){return this._getNumber(15)},function(t){t=Math.max(.005,Math.min(.08,t)),this._setNumber(15,t)}),__getset(0,n,"metallicGlossTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._setTexture(2,t)}),__getset(0,n,"occlusionTextureStrength",function(){return this._getNumber(13)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(13,t)}),__getset(0,n,"metallic",function(){return this._getNumber(9)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(9,t)}),__getset(0,n,"occlusionTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._setTexture(5,t)}),__getset(0,n,"emissionTexture",function(){return this._getTexture(6)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._setTexture(6,t)}),__getset(0,n,"albedoTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,t)}),__getset(0,n,"normalTextureScale",function(){return this._getNumber(14)},function(t){this._setNumber(14,t)}),__getset(0,n,"normalTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE),this._setTexture(3,t)}),__getset(0,n,"smoothness",function(){return this._getNumber(10)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(10,t)}),__getset(0,n,"parallaxTexture",function(){return this._getTexture(4)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._setTexture(4,t)}),__getset(0,n,"albedoColor",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),e.SmoothnessSource_MetallicGlossTexture_Alpha=0,e.SmoothnessSource_DiffuseTexture_Alpha=1,e.SHADERDEFINE_DIFFUSETEXTURE=0,e.SHADERDEFINE_NORMALTEXTURE=0,e.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,e.SHADERDEFINE_METALLICGLOSSTEXTURE=0,e.SHADERDEFINE_OCCLUSIONTEXTURE=0,e.SHADERDEFINE_PARALLAXTEXTURE=0,e.SHADERDEFINE_EMISSION=0,e.SHADERDEFINE_EMISSIONTEXTURE=0,e.SHADERDEFINE_TILINGOFFSET=0,e.DIFFUSETEXTURE=1,e.METALLICGLOSSTEXTURE=2,e.NORMALTEXTURE=3,e.PARALLAXTEXTURE=4,e.OCCLUSIONTEXTURE=5,e.EMISSIONTEXTURE=6,e.DIFFUSECOLOR=7,e.EMISSIONCOLOR=8,e.METALLIC=9,e.SMOOTHNESS=10,e.SMOOTHNESSSCALE=11,e.SMOOTHNESSSOURCE=12,e.OCCLUSIONSTRENGTH=13,e.NORMALSCALE=14,e.PARALLAXSCALE=15,e.ENABLEEMISSION=16,e.TILINGOFFSET=17,e}(BaseMaterial),GlitterMaterial=function(t){function e(){e.__super.call(this),this.setShaderName("GLITTER"),this.renderMode=1,this._setColor(3,new Vector4(1,1,1,1)),this._setColor(2,new Vector4(1,1,1,1))}__class(e,"laya.d3.core.material.GlitterMaterial",t);var n=e.prototype;return n.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},__getset(0,n,"color",function(){return this._getColor(3)},function(t){this._setColor(3,t)}),__getset(0,n,"albedo",function(){return this._getColor(2)},function(t){this._setColor(2,t)}),__getset(0,n,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),__getset(0,n,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.DIFFUSETEXTURE=1,e.ALBEDO=2,e.UNICOLOR=3,__static(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(BaseMaterial),StandardMaterial=function(t){function e(){this._transformUV=null,e.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new Vector3(.6,.6,.6)),this._setColor(10,new Vector3(1,1,1)),this._setColor(11,new Vector4(1,1,1,8)),this._setColor(12,new Vector3(1,1,1)),this._setColor(7,new Vector4(1,1,1,1)),this._setNumber(0,.5),this._setColor(15,new Vector4(1,1,0,0)),this.renderMode=1}__class(e,"laya.d3.core.material.StandardMaterial",t);var n=e.prototype;return n.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},n.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},n.onAsynLoaded=function(n,i,r){var a=i[0];if(a.version)t.prototype.onAsynLoaded.call(this,n,i,r);else{var s=i[1],o=a.props;for(var l in o)this[l]=o[l];e._parseStandardMaterial(s,this,a),this._endLoaded()}},n.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var n=e;this._transformUV&&(n._transformUV=this._transformUV.clone())},__getset(0,n,"ambientTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(5,t)}),__getset(0,n,"emissiveTexture",function(){return this._getTexture(4)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(4,t)}),__getset(0,n,"transformUV",function(){return this._transformUV},function(t){this._transformUV=t,this._setMatrix4x4(13,t.matrix),t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,t.matrix.elements,0)}),__getset(0,n,"reflectTexture",function(){return this._getTexture(6)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(6,t)}),__getset(0,n,"specularTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,t)}),__getset(0,n,"diffuseTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),__getset(0,n,"albedoColor",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),__getset(0,n,"specularColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),__getset(0,n,"normalTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,t)}),__getset(0,n,"reflectColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),__getset(0,n,"diffuseColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),__getset(0,n,"albedo",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),__getset(0,n,"ambientColor",function(){return this._getColor(9)},function(t){this._setColor(9,t)}),__getset(0,n,"tilingOffset",function(){return this._getColor(15)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(15,t)}),__getset(0,n,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e._parseStandardMaterial=function(t,e,n){var i=n.customProps,r=i.ambientColor;e.ambientColor=new Vector3(r[0],r[1],r[2]);var a=i.diffuseColor;e.diffuseColor=new Vector3(a[0],a[1],a[2]);var s=i.specularColor;e.specularColor=new Vector4(s[0],s[1],s[2],s[3]);var o=i.reflectColor;e.reflectColor=new Vector3(o[0],o[1],o[2]);var l=i.albedoColor;l&&(e.albedo=new Vector4(l[0],l[1],l[2],l[3]));var h=i.diffuseTexture.texture2D;h&&(e.diffuseTexture=Loader.getRes(t[h]));var _=i.normalTexture.texture2D;_&&(e.normalTexture=Loader.getRes(t[_]));var u=i.specularTexture.texture2D;u&&(e.specularTexture=Loader.getRes(t[u]));var c=i.emissiveTexture.texture2D;c&&(e.emissiveTexture=Loader.getRes(t[c]));var d=i.ambientTexture.texture2D;d&&(e.ambientTexture=Loader.getRes(t[d]));var f=i.reflectTexture.texture2D;f&&(e.reflectTexture=Loader.getRes(t[f]))},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_NORMALMAP=0,e.SHADERDEFINE_SPECULARMAP=0,e.SHADERDEFINE_EMISSIVEMAP=0,e.SHADERDEFINE_AMBIENTMAP=0,e.SHADERDEFINE_REFLECTMAP=0,e.SHADERDEFINE_UVTRANSFORM=0,e.SHADERDEFINE_TILINGOFFSET=0,e.SHADERDEFINE_ADDTIVEFOG=0,e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.SPECULARTEXTURE=3,e.EMISSIVETEXTURE=4,e.AMBIENTTEXTURE=5,e.REFLECTTEXTURE=6,e.ALBEDO=7,e.UVANIAGE=8,e.MATERIALAMBIENT=9,e.MATERIALDIFFUSE=10,e.MATERIALSPECULAR=11,e.MATERIALREFLECT=12,e.UVMATRIX=13,e.UVAGE=14,e.TILINGOFFSET=15,__static(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(BaseMaterial),PBRMaterial=function(t){function e(){if(this._transformUV=null,e.__super.call(this),!laya.d3.core.material.PBRMaterial.pbrlutTex){var t=Browser.window.__pbrlutdata;if(!t)throw alert("no pbr lutdata, need pbrlut.js"),"no pbr lutdata, need pbrlut.js";var n=DataTexture2D.create(new Uint32Array(t).buffer,256,256,9728,9728,!1);laya.d3.core.material.PBRMaterial.pbrlutTex=n}this._setTexture(4,laya.d3.core.material.PBRMaterial.pbrlutTex),this.setShaderName("PBR"),this._setNumber(0,.5),this.use_groundtruth=!1}__class(e,"laya.d3.core.material.PBRMaterial",t);var n=e.prototype;return n.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},n.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},n.onAsynLoaded=function(e,n,i){t.prototype.onAsynLoaded.call(this,e,n,i)},n.radicalInverse_VdC=function(t){var e=new Uint32Array(1);return function(t){return t=t<<16|t>>>16,t=(1431655765&t)<<1|(2863311530&t)>>>1,t=(858993459&t)<<2|(3435973836&t)>>>2,t=(252645135&t)<<4|(4042322160&t)>>>4,t=(16711935&t)<<8|(4278255360&t)>>>8,e[0]=t,2.3283064365386963e-10*e[0]}(t)},n.createHammersleyTex=function(t,e){var n=new Uint8Array(t*e*4),i=0,r=0;for(r=0;r<t*e;r++){var a=this.radicalInverse_VdC(r);n[i++]=255*a,n[i++]=0,n[i++]=0,n[i++]=255}return n},__getset(0,n,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),__getset(0,n,"transformUV",function(){return this._transformUV},function(t){this._transformUV=t,this._setMatrix4x4(8,t.matrix),this._conchMaterial&&this._conchMaterial.setShaderValue(8,t.matrix.elements,0)}),__getset(0,n,"normalTexture",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),__getset(0,n,"pbrlutTexture",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),__getset(0,n,"pbrInfoTexture",function(){return this._getTexture(3)},function(t){this._setTexture(3,t),this._addShaderDefine(e.SHADERDEFINE_HAS_PBRINFO)}),__getset(0,n,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),__getset(0,n,"testClipZ",null,function(t){this._addShaderDefine(e.SHADERDEFINE_TEST_CLIPZ)}),__getset(0,n,"metaless",function(){return this._getNumber(7)},function(t){this._setNumber(7,t),this._addShaderDefine(e.SHADERDEFINE_FIX_METALESS)}),__getset(0,n,"roughness",function(){return this._getNumber(6)},function(t){this._setNumber(6,t),this._addShaderDefine(e.SHADERDEFINE_FIX_ROUGHNESS)}),__getset(0,n,"use_groundtruth",null,function(t){if(t){if(this._addShaderDefine(e.SHADERDEFINE_USE_GROUNDTRUTH),!laya.d3.core.material.PBRMaterial.HammersleyNoiseTex){var n=this.createHammersleyTex(32,32);laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=DataTexture2D.create(n.buffer,32,32,9728,9728,!1)}this._setTexture(15,e.HammersleyNoiseTex)}else laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=null,this._removeShaderDefine(e.SHADERDEFINE_USE_GROUNDTRUTH)}),__getset(0,n,"has_tangent",null,function(t){this._addShaderDefine(e.SHADERDEFINE_HAS_TANGENT)}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.PBRINFOTEXTURE=3,e.PBRLUTTEXTURE=4,e.UVANIAGE=5,e.MATERIALROUGHNESS=6,e.MATERIALMETALESS=7,e.UVMATRIX=8,e.UVAGE=9,e.AOOBJPOS=14,e.HSNOISETEXTURE=15,e.SHADERDEFINE_FIX_ROUGHNESS=0,e.SHADERDEFINE_FIX_METALESS=0,e.SHADERDEFINE_HAS_TANGENT=0,e.SHADERDEFINE_TEST_CLIPZ=0,e.SHADERDEFINE_HAS_PBRINFO=0,e.SHADERDEFINE_USE_GROUNDTRUTH=0,e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.pbrlutTex=null,e.HammersleyNoiseTex=null,__static(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(BaseMaterial),BlinnPhongMaterial=function(t){function e(){e.__super.call(this),this.setShaderName("BLINNPHONG"),this._setColor(8,new Vector3(1,1,1)),this._setNumber(9,.078125),this._setColor(10,new Vector3(1,1,1)),this._setColor(6,new Vector4(1,1,1,1)),this._setNumber(0,.5),this._setColor(11,new Vector4(1,1,0,0)),this.renderMode=0}__class(e,"laya.d3.core.material.BlinnPhongMaterial",t);var n=e.prototype;return n.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},n.disableFog=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_FOG)},__getset(0,n,"specularTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,t)}),__getset(0,n,"normalTexture",function(){return this._getTexture(2)},function(t){
t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,t)}),__getset(0,n,"reflectColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),__getset(0,n,"shininess",function(){return this._getNumber(9)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(9,t)}),__getset(0,n,"specularColor",function(){return this._getColor(8)},function(t){this._setColor(8,t)}),__getset(0,n,"albedoTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),__getset(0,n,"tilingOffset",function(){return this._getColor(11)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(11,t)}),__getset(0,n,"albedoColor",function(){return this._getColor(6)},function(t){this._setColor(6,t)}),__getset(0,n,"reflectTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(5,t)}),__getset(0,n,"renderMode",null,function(t){switch(t){case 0:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 1:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this.depthTest=513,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this.depthTest=513,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e.SPECULARSOURCE_DIFFUSEMAPALPHA=0,e.SPECULARSOURCE_SPECULARMAP=0,e.RENDERMODE_OPAQUE=0,e.RENDERMODE_CUTOUT=1,e.RENDERMODE_TRANSPARENT=2,e.RENDERMODE_ADDTIVE=3,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_NORMALMAP=0,e.SHADERDEFINE_SPECULARMAP=0,e.SHADERDEFINE_REFLECTMAP=0,e.SHADERDEFINE_TILINGOFFSET=0,e.SHADERDEFINE_ADDTIVEFOG=0,e.ALBEDOTEXTURE=1,e.NORMALTEXTURE=2,e.SPECULARTEXTURE=3,e.EMISSIVETEXTURE=4,e.REFLECTTEXTURE=5,e.ALBEDOCOLOR=6,e.MATERIALSPECULAR=8,e.SHININESS=9,e.MATERIALREFLECT=10,e.TILINGOFFSET=11,__static(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(BaseMaterial),TerrainMaterial=function(t){function e(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,e.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new Vector2,this._diffuseScale2=new Vector2,this._diffuseScale3=new Vector2,this._diffuseScale4=new Vector2,this.ambientColor=new Vector3(.6,.6,.6),this.diffuseColor=new Vector3(1,1,1),this.specularColor=new Vector4(.2,.2,.2,32)}__class(e,"laya.d3.core.material.TerrainMaterial",t);var n=e.prototype;return n.setDiffuseScale1=function(t,e){this._diffuseScale1.x=t,this._diffuseScale1.y=e,this._setColor(6,this._diffuseScale1)},n.setDiffuseScale2=function(t,e){this._diffuseScale2.x=t,this._diffuseScale2.y=e,this._setColor(7,this._diffuseScale2)},n.setDiffuseScale3=function(t,e){this._diffuseScale3.x=t,this._diffuseScale3.y=e,this._setColor(8,this._diffuseScale3)},n.setDiffuseScale4=function(t,e){this._diffuseScale4.x=t,this._diffuseScale4.y=e,this._setColor(9,this._diffuseScale4)},n.setDetailNum=function(t){switch(t){case 1:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3)}},n.disableLight=function(){this._addDisablePublicShaderDefine(ShaderCompile3D.SHADERDEFINE_POINTLIGHT|ShaderCompile3D.SHADERDEFINE_SPOTLIGHT|ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},n.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},__getset(0,n,"diffuseTexture4",function(){return this._getTexture(5)},function(t){this._setTexture(5,t)}),__getset(0,n,"diffuseTexture3",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),__getset(0,n,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("TerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),__getset(0,n,"diffuseTexture2",function(){return this._getTexture(3)},function(t){this._setTexture(3,t)}),__getset(0,n,"diffuseTexture1",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),__getset(0,n,"specularColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),__getset(0,n,"normalTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),__getset(0,n,"diffuseColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),__getset(0,n,"splatAlphaTexture",function(){return this._getTexture(0)},function(t){this._setTexture(0,t)}),__getset(0,n,"ambientColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_TRANSPARENT=2,e.SPLATALPHATEXTURE=0,e.NORMALTEXTURE=1,e.DIFFUSETEXTURE1=2,e.DIFFUSETEXTURE2=3,e.DIFFUSETEXTURE3=4,e.DIFFUSETEXTURE4=5,e.DIFFUSESCALE1=6,e.DIFFUSESCALE2=7,e.DIFFUSESCALE3=8,e.DIFFUSESCALE4=9,e.MATERIALAMBIENT=10,e.MATERIALDIFFUSE=11,e.MATERIALSPECULAR=12,e.SHADERDEFINE_DETAIL_NUM1=0,e.SHADERDEFINE_DETAIL_NUM2=0,e.SHADERDEFINE_DETAIL_NUM3=0,e.SHADERDEFINE_DETAIL_NUM4=0,__static(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(BaseMaterial),HTMLSubImage=function(t){function e(t,n,i,r,a,s,o,l){throw e.__super.call(this),new Error("不允许new！")}return __class(e,"laya.resource.HTMLSubImage",t),e.create=function(t,n,i,r,a,s,o,l){return void 0===l&&(l=!1),new e(t,n,i,r,a,s,o,l)},e}(Bitmap),HTMLCanvas=function(t){function e(t){this._is2D=!1,e.__super.call(this);var n=this;if(this._source=this,"2D"===t||"AUTO"===t&&!Render.isWebGL){this._is2D=!0,this._source=Browser.createElement("canvas");var i=this;i.getContext=function(t,e){if(n._ctx)return n._ctx;var r=n._ctx=n._source.getContext(t,e);return r&&(r._canvas=i,Render.isFlash||(r.size=function(t,e){})),r}}}__class(e,"laya.resource.HTMLCanvas",t);var n=e.prototype;return n.clear=function(){this._ctx&&this._ctx.clear()},n.destroy=function(){this._ctx&&this._ctx.destroy(),this._ctx=null,this.dispose()},n.release=function(){},n._setContext=function(t){this._ctx=t},n.getContext=function(t,n){return this._ctx?this._ctx:this._ctx=e._createContext(this)},n.getMemSize=function(){return 0},n.size=function(t,e){(this._w!=t||this._h!=e||this._source&&(this._source.width!=t||this._source.height!=e))&&(this._w=t,this._h=e,this.memorySize=this._w*this._h*4,this._ctx&&this._ctx.size(t,e),this._source&&(this._source.height=e,this._source.width=t))},n.getCanvas=function(){return this._source},__getset(0,n,"asBitmap",null,function(t){}),__getset(0,n,"context",function(){return this._ctx}),e.create=function(t){return new e(t)},e.TYPE2D="2D",e.TYPE3D="3D",e.TYPEAUTO="AUTO",e._createContext=null,e}(Bitmap),SolidColorTexture2D=function(t){function e(t){this._color=null,this._pixels=null,e.__super.call(this),this._type=3553,this._width=1,this._height=1,this._size=new Size(this.width,this.height),this._color=t,this._pixels=new Uint8Array([255*t.x,255*t.y,255*t.z,255*t.w])}__class(e,"laya.d3.resource.SolidColorTexture2D",t);var n=e.prototype;return n._createWebGlTexture=function(){var t=WebGL.mainContext,e=this._source=t.createTexture(),n=this._width,i=this._height,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,this._type,e),t.texImage2D(this._type,0,6408,n,i,0,6408,5121,this._pixels);var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,h=Arith.isPOT(n,i);h?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,l),t.texParameteri(this._type,10243,l),this._mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&WebGLContext.bindTexture(t,r,a),this.memorySize=h?n*i*4*(1+1/3):n*i*4},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.detoryResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},__static(e,["magentaTexture",function(){return this.magentaTexture=new e(new Vector4(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new e(new Vector4(.5,.5,.5,1))}]),e}(BaseTexture),SolidColorTextureCube=function(t){function e(t){this._color=null,this._pixels=null,this._texCount=6,e.__super.call(this),this._type=34067,this._width=1,this._height=1,this._size=new Size(this.width,this.height),this._color=t,this._pixels=new Uint8Array([255*t.x,255*t.y,255*t.z,255*t.w])}__class(e,"laya.d3.resource.SolidColorTextureCube",t);var n=e.prototype;return n._createWebGlTexture=function(){var t=WebGL.mainContext,e=this._source=t.createTexture(),n=this._width,i=this._height,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,this._type,e),t.texImage2D(34069,0,6408,n,i,0,6408,5121,this._pixels),t.texImage2D(34070,0,6408,n,i,0,6408,5121,this._pixels),t.texImage2D(34071,0,6408,n,i,0,6408,5121,this._pixels),t.texImage2D(34072,0,6408,n,i,0,6408,5121,this._pixels),t.texImage2D(34073,0,6408,n,i,0,6408,5121,this._pixels),t.texImage2D(34074,0,6408,n,i,0,6408,5121,this._pixels);var s=this.minFifter,o=this.magFifter,l=this._repeat?10497:33071,h=Arith.isPOT(n,i);h?(this.mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,l),t.texParameteri(this._type,10243,l),this.mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&WebGLContext.bindTexture(t,r,a),this.memorySize=h?n*i*4*(1+1/3)*this._texCount:n*i*4*this._texCount},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.detoryResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},__static(e,["magentaTexture",function(){return this.magentaTexture=new e(new Vector4(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new e(new Vector4(.5,.5,.5,1))}]),e}(BaseTexture),Texture2D=function(t){function e(t,n,i,r){this._canRead=!1,this._image=null,this._pixels=null,void 0===t&&(t=!1),void 0===n&&(n=!0),void 0===i&&(i=6408),void 0===r&&(r=!0),e.__super.call(this),this._type=3553,this._repeat=n,this._canRead=t,this._format=i,this._mipmap=r}__class(e,"laya.d3.resource.Texture2D",t);var n=e.prototype;return n._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var t=WebGL.mainContext,e=this._source=t.createTexture(),n=this._width,i=this._height,r=WebGLContext.curBindTexTarget,a=WebGLContext.curBindTexValue;switch(WebGLContext.bindTexture(t,this._type,e),this._format){case 6407:case 6408:this._canRead?t.texImage2D(this._type,0,this._format,n,i,0,this._format,5121,this._pixels):t.texImage2D(this._type,0,this._format,this._format,5121,this._image);break;case WebGL.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:t.compressedTexImage2D(this._type,0,this._format,this._width,this._height,0,this._image)}var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,h=Arith.isPOT(n,i);h?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,l),t.texParameteri(this._type,10243,l),this._mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&WebGLContext.bindTexture(t,r,a),this._image.onload=null,this._image=null,this.memorySize=h?n*i*4*(1+1/3):n*i*4},n.recreateResource=function(){this.loaded&&(this._createWebGlTexture(),this.completeCreate())},n.onAsynLoaded=function(t,e,n){if(n){var i=n[0];void 0!==i&&(this._canRead=i);var r=n[1];void 0!==r&&(this._repeat=r);var a=n[2];void 0!==a&&(this._format=a);var s=n[3];void 0!==s&&(this._mipmap=s)}switch(this.url=t,this._format){case 6407:case 6408:this._image=e;var o=e.width,l=e.height;this._width=o,this._height=l,this._size=new Size(o,l),this._canRead&&(Browser.canvas.size(o,l),Browser.canvas.clear(),Browser.context.drawImage(e,0,0,o,l),this._pixels=new Uint8Array(Browser.context.getImageData(0,0,o,l).data.buffer));break;case WebGL.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:var h=new Byte(e);h.readUTFBytes(4),h.readUTFBytes(2),h.getInt16();h.endian="bigEndian",this._width=h.getInt16(),this._height=h.getInt16(),this._size=new Size(this._width,this._height);h.getInt16(),h.getInt16();this._image=new Uint8Array(e,h.pos)}this._conchTexture?this._conchTexture.setTexture2DImage(this._image):this.activeResource(),this._endLoaded()},n.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},n.detoryResource=function(){this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},__getset(0,n,"src",function(){return this.url}),__getset(0,n,"_src",function(){return this.url}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e}(BaseTexture),PrimitiveMesh=function(t){function e(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,e.__super.call(this)}__class(e,"laya.d3.resource.models.PrimitiveMesh",t);var n=e.prototype;return Laya.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},n._getIndexBuffer=function(){return this._indexBuffer},n._getPositions=function(){var t,e=[],n=this._vertexBuffer.vertexDeclaration.getVertexElements(),i=0;for(i=0;i<n.length;i++){var r=n[i];if("vector3"===r.elementFormat&&0===r.elementUsage){t=r;break}}var a=this._vertexBuffer.getData();for(i=0;i<a.length;i+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var s=i+t.offset/4,o=new Vector3(a[s+0],a[s+1],a[s+2]);e.push(o)}return e},n.getRenderElement=function(t){return this},n.getRenderElementsCount=function(){return 1},n.detoryResource=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.dispose(),this._indexBuffer=null),this.memorySize=0},n._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},n._render=function(t){WebGL.mainContext.drawElements(4,this._numberIndices,5123,0),Stat.drawCall++,Stat.trianglesFaces+=this._numberIndices/3},n._renderRuntime=function(t,e,n){t.drawSubmesh(e._conchSubmesh,0,4,0,this._numberIndices)},__getset(0,n,"triangleCount",function(){return this._indexBuffer.indexCount/3}),__getset(0,n,"_vertexBufferCount",function(){return 1}),e}(BaseMesh),RenderTexture=function(t){function e(t,n,i,r,a,s,o,l,h){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===i&&(i=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1),e.__super.call(this),this._type=3553,this._width=t,this._height=n,this._size=new Size(t,n),this._surfaceFormat=i,this._surfaceType=r,this._depthStencilFormat=a,this._mipmap=s,this._repeat=o,this._minFifter=l,this._magFifter=h,this.activeResource(),this._alreadyResolved=!0}__class(e,"laya.d3.resource.RenderTexture",t);var n=e.prototype;return n.recreateResource=function(){var t=WebGL.mainContext;this._frameBuffer=t.createFramebuffer(),this._source=t.createTexture();var e=WebGLContext.curBindTexTarget,n=WebGLContext.curBindTexValue;WebGLContext.bindTexture(t,this._type,this._source),t.texImage2D(this._type,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var i=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071;if(Arith.isPOT(this._width,this._height)?(this._mipmap?-1!==i||(i=9987):-1!==i||(i=9729),-1!==r||(r=9729),t.texParameteri(this._type,10241,i),t.texParameteri(this._type,10240,r),t.texParameteri(this._type,10242,a),t.texParameteri(this._type,10243,a),this._mipmap&&t.generateMipmap(this._type)):(-1!==i||(i=9729),-1!==r||(r=9729),t.texParameteri(this._type,10241,i),t.texParameteri(this._type,10240,r),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),t.bindFramebuffer(36160,this._frameBuffer),t.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,this._depthStencilBuffer),t.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:t.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:t.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:t.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}t.bindFramebuffer(36160,null),e&&n&&WebGLContext.bindTexture(t,e,n),t.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},n.start=function(){WebGL.mainContext.bindFramebuffer(36160,this.frameBuffer),e._currentRenderTarget=this,this._alreadyResolved=!1},n.end=function(){WebGL.mainContext.bindFramebuffer(36160,null),e._currentRenderTarget=null,this._alreadyResolved=!0},n.getData=function(t,e,n,i){var r=WebGL.mainContext;if(r.bindFramebuffer(36160,this._frameBuffer),!(36053===r.checkFramebufferStatus(36160)))return r.bindFramebuffer(36160,null),null;var a=new Uint8Array(this._width*this._height*4);return r.readPixels(t,e,n,i,this._surfaceFormat,this._surfaceType,a),r.bindFramebuffer(36160,null),a},n.detoryResource=function(){if(this._frameBuffer){var t=WebGL.mainContext;t.deleteTexture(this._source),t.deleteFramebuffer(this._frameBuffer),t.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},__getset(0,n,"source",function(){return this._alreadyResolved?t.prototype._$get_source.call(this):null}),__getset(0,n,"frameBuffer",function(){return this._frameBuffer}),__getset(0,n,"depthStencilBuffer",function(){return this._depthStencilBuffer}),__getset(0,n,"surfaceType",function(){return this._surfaceType}),__getset(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),__getset(0,n,"surfaceFormat",function(){return this._surfaceFormat}),e._currentRenderTarget=null,e}(BaseTexture),DataTexture2D=function(t){function e(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,e.__super.call(this),this._type=3553}__class(e,"laya.d3.resource.DataTexture2D",t);var n=e.prototype;return n.genDebugMipmaps=function(){var t=[];return t.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),t.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),t.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),t.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),t.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),t.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),t.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),t.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),t.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),t.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),t},n._onTextureLoaded=function(t){},n._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var t=WebGL.mainContext;t.getExtension("EXT_shader_texture_lod");var n=this._source=t.createTexture(),i=this._width,r=this._height,a=WebGLContext.curBindTexTarget,s=WebGLContext.curBindTexValue;if(WebGLContext.bindTexture(t,this._type,n),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var o=0;t.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null);for(var l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=h*_*4)throw"mipmap size error  level:"+l;t.texSubImage2D(this._type,0,e.simLodRect[o++],e.simLodRect[o++],e.simLodRect[o++],e.simLodRect[o++],6408,5121,new Uint8Array(this._mipmaps[l]))}this.minFifter=9729,this.magFifter=9729}else{var h=this._width,_=this._height;for(o=0,t.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null),l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=h*_*4)throw"mipmap size error  level:"+l;t.texImage2D(this._type,l,6408,h,_,0,6408,5121,new Uint8Array(this._mipmaps[l])),h/=2,_/=2,h<1&&(h=1),_<1&&(_=1),this.minFifter=9987,this.magFifter=9729}}this.mipmap=!1}else t.texImage2D(this._type,0,6408,i,r,0,6408,5121,new Uint8Array(this._buffer));var u=this._minFifter,c=this._magFifter,d=this._repeat?10497:33071,f=Arith.isPOT(i,r);if(!f)throw"data texture must be POT";this._mipmap||this._mipmaps?-1!==u||(u=9987):-1!==u||(u=9729),-1!==c||(c=9729),t.texParameteri(this._type,10241,u),t.texParameteri(this._type,10240,c),t.texParameteri(this._type,10242,d),this._mipmaps?t.texParameteri(this._type,10243,33071):t.texParameteri(this._type,10243,d),this._mipmap&&t.generateMipmap(this._type),a&&s&&WebGLContext.bindTexture(t,a,s),this.src&&this.src.length>0&&(this._buffer=null),this.memorySize=f?i*r*4*(1+1/3):i*r*4,this._recreateLock=!1},n.recreateResource=function(){if(this._buffer||null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._buffer||this._mipmaps){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0}},n.onAsynLoaded=function(t,e,n){var i;n&&(i=n[0].call(this,e)),i&&(this._width=i.width,this._height=i.height,this._buffer=i.data),this._src=t,this._size=new Size(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._endLoaded()},n.getPixels=function(){return new Uint8Array(this._buffer)},n.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},__getset(0,n,"src",function(){return this._src}),e.create=function(t,n,i,r,a,s){if(void 0===r&&(r=9729),void 0===a&&(a=9729),void 0===s&&(s=!0),!t||t.byteLength<n*i*4)throw"DataTexture2D create error";var o=new e;return o._buffer=t,o._width=n,o._height=i,o._mipmap=s,o._magFifter=r,o._minFifter=a,o._size=new Size(o._width,o._height),o._conchTexture?alert("怎么给runtime传递datatexture数据"):o.activeResource(),o},e.load=function(t,n,i,r,a){if(void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=9729),void 0===a&&(a=9729),"mipmaps"===Utils.getFileExtension(t)){var s=Laya.loader.create(t,null,null,e,[function(t){this._mipmaps=[];var e=new Uint32Array(t);this._width=e[0];var n=512;if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,n=1024),this._width!=n)throw console.error("现在只支持512x256的环境贴图。当前的是"+e[0]),"现在只支持512x256的环境贴图。当前的是"+e[0];this._height=e[1];for(var i=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var s=i*r*4;if(a+s>t.byteLength)throw"load mipmaps data size error ";var o=new Uint8Array(t,a,s);if(this._mipmaps.push(o),a+=s,1==i&&1==r)break;i/=2,r/=2,i<1&&(i=1),r<1&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){s.simLodInfo=new Float32Array(40);for(var o=0;o<s.simLodInfo.length;)s.simLodInfo[o]=(e.simLodRect[o]+.5)/1024,o++,s.simLodInfo[o]=(e.simLodRect[o]+.5)/256,o++,s.simLodInfo[o]=Math.max(e.simLodRect[o]-1,.1)/1024,o++,s.simLodInfo[o]=Math.max(e.simLodRect[o]-1.5,.1)/256,o++}return s}if("number"==typeof n)return Laya.loader.create(t,null,null,e,[function(t){return this._width=n,this._height=i,this._buffer=t,null}]);if("function"==typeof n)return Laya.loader.create(t,null,null,e,[n]);throw new Error("unknown params.")},e.lodasatlas=!1,__static(e,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]),e}(BaseTexture),Mesh=function(t){function e(){this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,e.__super.call(this),this._subMeshes=[],this._materials=[],this._vertexBuffers=[]}__class(e,"laya.d3.resource.models.Mesh",t);var n=e.prototype;return n._getPositions=function(){var t,e,n,i,r,a=[],s=0,o=0,l=0;if(0!==this._vertexBuffers.length){var h=this._vertexBuffers.length;for(s=0;s<h;s++){for(t=this._vertexBuffers[s],n=t.vertexDeclaration.getVertexElements(),o=0;o<n.length;o++)if(i=n[o],"vector3"===i.elementFormat&&0===i.elementUsage){e=i;break}for(r=t.getData(),o=0;o<r.length;o+=t.vertexDeclaration.vertexStride/4)l=o+e.offset/4,a.push(new Vector3(r[l+0],r[l+1],r[l+2]))}}else{var _=this._subMeshes.length;for(s=0;s<_;s++){var u=this._subMeshes[s];for(t=u._getVertexBuffer(),n=t.vertexDeclaration.getVertexElements(),o=0;o<n.length;o++)if(i=n[o],"vector3"===i.elementFormat&&0===i.elementUsage){e=i;break}for(r=t.getData(),o=0;o<r.length;o+=t.vertexDeclaration.vertexStride/4)l=o+e.offset/4,a.push(new Vector3(r[l+0],r[l+1],r[l+2]))}}return a},n._setSubMeshes=function(t){this._subMeshes=t,this._subMeshCount=t.length;for(var e=0;e<this._subMeshCount;e++)t[e]._indexInMesh=e;this._positions=this._getPositions(),this._generateBoundingObject()},n.onAsynLoaded=function(t,e,n){var i=e[0],r=e[1];MeshReader.read(i,this,this._materials,this._subMeshes,r),this.completeCreate(),this._endLoaded()},n.getSubMesh=function(t){return this._subMeshes[t]},n.getSubMeshCount=function(){return this._subMeshes.length},n.getRenderElementsCount=function(){return this._subMeshes.length},n.getRenderElement=function(t){return this._subMeshes[t]},n.detoryResource=function(){for(var t=0;t<this._subMeshes.length;t++)this._subMeshes[t].dispose();this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null},__getset(0,n,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),__getset(0,n,"materials",function(){return this._materials.slice()}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e}(BaseMesh),TextureCube=function(t){function e(){this._texCount=6,this._recreateLock=!1,this._needReleaseAgain=!1,e.__super.call(this),this._type=34067}__class(e,"laya.d3.resource.TextureCube",t);var n=e.prototype;return n._onTextureLoaded=function(t){this._images=t;for(var e=2147483647,n=2147483647,i=0;i<6;i++){var r=t[i];e=Math.min(e,r.width),n=Math.min(n,r.height)}this._width=e,this._height=n,this._size=new Size(e,n)},n._createWebGlTexture=function(){var t=0;for(t=0;t<this._texCount;t++)if(!this._images[t])throw"create GLTextur err:no data:"+this._images[t];var e=WebGL.mainContext,n=this._source=e.createTexture(),i=this._width,r=this._height,a=WebGLContext.curBindTexTarget,s=WebGLContext.curBindTexValue;WebGLContext.bindTexture(e,this._type,n),e.texImage2D(34069,0,6408,6408,5121,this._images[0]),e.texImage2D(34070,0,6408,6408,5121,this._images[1]),e.texImage2D(34071,0,6408,6408,5121,this._images[2]),e.texImage2D(34072,0,6408,6408,5121,this._images[3]),e.texImage2D(34073,0,6408,6408,5121,this._images[4]),e.texImage2D(34074,0,6408,6408,5121,this._images[5]);var o=this.minFifter,l=this.magFifter,h=this._repeat?10497:33071,_=Arith.isPOT(i,r);for(_?(this.mipmap?-1!==o||(o=9987):-1!==o||(o=9729),-1!==l||(l=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,l),e.texParameteri(this._type,10242,h),e.texParameteri(this._type,10243,h),this.mipmap&&e.generateMipmap(this._type)):(-1!==o||(o=9729),-1!==l||(l=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,l),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),a&&s&&WebGLContext.bindTexture(e,a,s),t=0;t<6;t++)this._images[t].onload=null,this._images[t]=null;this.memorySize=_?i*r*4*(1+1/3)*this._texCount:i*r*4*this._texCount,this._recreateLock=!1},n.recreateResource=function(){var t=this;if(null!=this._srcs)if(this._needReleaseAgain=!1,this._images[0]){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0;for(var e=this,n=0;n<this._texCount;n++){this._images[n]=new Browser.window.Image,this._images[n].crossOrigin="";var i=n;this._images[i].onload=function(){var n=0;if(e._needReleaseAgain){for(n=0;n<t._texCount;n++)if(!e._images[n].complete)return;for(e._needReleaseAgain=!1,n=0;n<t._texCount;n++)e._images[n].onload=null,e._images[n]=null}else{for(n=0;n<t._texCount;n++)if(!e._images[n].complete)return;e._createWebGlTexture(),e.completeCreate()}},this._images[n].src=this._srcs[n]}}},n.onAsynLoaded=function(t,e,n){this._srcs=t,this._onTextureLoaded(e),this._conchTexture?this._conchTexture.setTextureCubeImages(this._images):this.activeResource(),this._endLoaded()},n.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},
__getset(0,n,"defaulteTexture",function(){return SolidColorTextureCube.grayTexture}),__getset(0,n,"srcs",function(){return this._srcs}),e.load=function(t){return Laya.loader.create(t,null,null,e)},e}(BaseTexture),SkinnedMeshRender=function(t){function e(t){this._hasIndependentBound=!0,e.__super.call(this,t),this._owner.transform.off("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._cacheAnimationNode=[],this._localBoundingBoxCorners=__newvec(8,null),this._owner.meshFilter.on("meshchanged",this,this._$3__onMeshChanged)}__class(e,"laya.d3.core.SkinnedMeshRender",t);var n=e.prototype;return n._getCacheAnimationNodes=function(){var t=this._cacheMesh._boneNames,e=t.length;this._cacheAnimationNode.length=e;for(var n=this._cacheAnimator._avatarNodeMap,i=0;i<e;i++)this._cacheAnimationNode[i]=n[t[i]]},n._offComputeBoneIndexToMeshEvent=function(t,e){t.loaded?e.loaded||e.off("loaded",this,this._getCacheAnimationNodes):t.off("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},n._computeBoneIndexToMeshWithAsyncAvatar=function(){this._cacheAvatar.loaded?this._computeBoneIndexToMeshWithAsyncMesh():this._cacheAvatar.once("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},n._computeBoneIndexToMeshWithAsyncMesh=function(){this._cacheMesh.loaded?this._getCacheAnimationNodes():this._cacheMesh.on("loaded",this,this._getCacheAnimationNodes)},n._$3__onMeshChanged=function(t,e,n){this._cacheMesh=n,e&&!e.loaded&&n.off("loaded",this,this._onMeshLoaded),n.loaded?this._onMeshLoaded(n):n.on("loaded",this,this._onMeshLoaded),this._cacheAvatar&&(e&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,e),n&&this._computeBoneIndexToMeshWithAsyncAvatar())},n._onMeshLoaded=function(t){var e=t.subMeshCount;this._skinnedDatas=new Float32Array(16*t.InverseAbsoluteBindPoses.length),this._publicSubSkinnedDatas=[],this._publicSubSkinnedDatas.length=e;for(var n=0;n<e;n++)for(var i=this._publicSubSkinnedDatas[n]=[],r=t.getSubMesh(n)._boneIndicesList,a=0,s=r.length;a<s;a++)i[a]=new Float32Array(16*r[a].length)},n._setRootBone=function(t){this._rootBone=t},n._setCacheAvatar=function(t){this._cacheAvatar!==t&&(this._cacheMesh?(this._cacheAvatar&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,this._cacheMesh),this._cacheAvatar=t,t&&(this._addShaderDefine(SkinnedMeshSprite3D.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=t)},n._calculateBoundingBox=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var e=this._cacheAnimator._avatarNodeMap[this._rootBone];null==e||null==this._localBoundBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(this._localBoundingBoxCorners)}}else t.prototype._calculateBoundingBox.call(this)},n._calculateBoundingSphere=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var e=this._cacheAnimator._avatarNodeMap[this._rootBone];null==e||null==this.localBoundSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(this.localBoundSphere)}}else t.prototype._calculateBoundingSphere.call(this)},n._updateOctreeNode=function(){var t=this._treeNode;t&&t.updateObject(this)},n._renderUpdate=function(t){var n,i=this._cacheAnimator,r=this._cacheMesh.subMeshCount,a=this._owner.transform;if(i){if(this._hasIndependentBound){var s=i._avatarNodeMap[this._rootBone],o=e._tempMatrix0;Matrix4x4.multiply(this._cacheAnimator.owner.transform.worldMatrix,s._transform._getWorldMatrix(),o);var l=a.worldMatrix;o.cloneTo(l),a.worldMatrix=l}var h=i.owner;if(this._setShaderValueMatrix4x4(0,h._transform.worldMatrix),n=h.getProjectionViewWorldMatrix(t),this._setShaderValueMatrix4x4(1,n),this._cacheMesh&&this._cacheMesh.loaded&&this._cacheAvatar&&this._cacheAvatar.loaded){var _,u,c,d,f=0,m=0,p=0,g=0;if(0!==i.playState&&i._canCache){if(_=i.currentPlayClip._getSkinnedDatasWithCache(this._cacheMesh,this._cacheAvatar,i.cachePlayRate,i.currentFrameIndex)){for(f=0;f<r;f++)this._renderElements[f]._skinAnimationDatas=_[f];return void(Laya3D.debugMode&&this._renderRenderableBoundBox())}for(i._updateTansformProperty(),u=this._cacheMesh._inverseBindPoses,f=0,m=u.length;f<m;f++)Utils3D._mulMatrixArray(this._cacheAnimationNode[f]._transform._getWorldMatrix(),u[f],this._skinnedDatas,16*f);for(_=[],_.length=r,f=0;f<r;f++){for(d=_[f]=[],c=this._cacheMesh.getSubMesh(f)._boneIndicesList,g=c.length,d.length=g,p=0;p<g;p++)d[p]=new Float32Array(16*c[p].length),e._splitAnimationDatas(c[p],this._skinnedDatas,d[p]);this._renderElements[f]._skinAnimationDatas=d}i.currentPlayClip._cacheSkinnedDatasWithCache(this._cacheMesh,this._cacheAvatar,i.cachePlayRate,i.currentFrameIndex,_)}else{for(u=this._cacheMesh._inverseBindPoses,f=0,m=u.length;f<m;f++)Utils3D._mulMatrixArray(this._cacheAnimationNode[f]._transform._getWorldMatrix(),u[f],this._skinnedDatas,16*f);for(f=0;f<r;f++){for(c=this._cacheMesh.getSubMesh(f)._boneIndicesList,g=c.length,d=this._publicSubSkinnedDatas[f],p=0;p<g;p++)e._splitAnimationDatas(c[p],this._skinnedDatas,d[p]);this._renderElements[f]._skinAnimationDatas=d}}}}else this._setShaderValueMatrix4x4(0,a.worldMatrix),n=this._owner.getProjectionViewWorldMatrix(t),this._setShaderValueMatrix4x4(1,n);Laya3D.debugMode&&this._renderRenderableBoundBox()},__getset(0,n,"boundingBox",function(){return this._calculateBoundingBox(),this._boundingBox}),__getset(0,n,"boundingSphere",function(){return this._calculateBoundingSphere(),this._boundingSphere}),__getset(0,n,"boundingBoxCenter",function(){var t=this.boundingBox;return Vector3.add(t.min,t.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenter}),__getset(0,n,"localBoundBox",function(){return this._localBoundBox},function(t){this._localBoundBox=t,t.getCorners(this._localBoundingBoxCorners)}),e._splitAnimationDatas=function(t,e,n){for(var i=0,r=t.length,a=0;i<r;i++)for(var s=0;s<16;s++,a++)n[a]=e[(t[i]<<4)+s]},__static(e,["_tempMatrix0",function(){return this._tempMatrix0=new Matrix4x4}]),e}(MeshRender),SphereCollider=function(t){function e(){this._originalBoundSphere=null,this._transformBoundSphere=null,e.__super.call(this),this._needUpdate=!1}__class(e,"laya.d3.component.physics.SphereCollider",t);var n=e.prototype;return n._updateCollider=function(){if(this._needUpdate){var t=NaN,e=this._owner.transform,n=e.scale;t=n.x>=n.y&&n.x>=n.z?n.x:n.y>=n.z?n.y:n.z,Vector3.transformCoordinate(this._originalBoundSphere.center,e.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*t,this._needUpdate=!1}},n._onWorldMatrixChanged=function(){this._needUpdate=!0;for(var t in this._runtimeCollisonMap)this._runtimeCollisonTestMap[t]=!0,this._runtimeCollisonMap[t]._runtimeCollisonTestMap[this.id]=!0},n._initialize=function(t){laya.d3.component.Component3D.prototype._initialize.call(this,t),this._originalBoundSphere=new BoundSphere(new Vector3(0,0,0),.5),this._transformBoundSphere=new BoundSphere(new Vector3(0,0,0),.5),t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._getType=function(){return 0},n._collisonTo=function(t){switch(t._getType()){case 0:return 0!==Collision.sphereContainsSphere(this.boundSphere,t.boundSphere);case 1:return 0!==t.boundBox.containsSphere(this.boundSphere);case 2:var e=t;if(0!==Collision.sphereContainsBox(this.boundSphere,e._boundBox)){for(var n=e.mesh._positions,i=0,r=n.length;i<r;i++)if(1===Collision.sphereContainsPoint(this.boundSphere,n[i]))return!0;return!1}return!1;default:throw new Error("SphereCollider:unknown collider type.")}},n._cloneTo=function(t){var e=t;e.radius=this.radius;var n=e.center;this.center.cloneTo(n),e.center=n},n.raycast=function(t,e,n){void 0===n&&(n=1.79e308),this._updateCollider();var i=this._transformBoundSphere.intersectsRayPoint(t,e.position);return-1!==i&&i<=n?(e.distance=i,e.sprite3D=this._owner,!0):(e.distance=-1,e.sprite3D=null,!1)},__getset(0,n,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere}),__getset(0,n,"radius",function(){return this._originalBoundSphere.radius},function(t){this._originalBoundSphere.radius=t}),__getset(0,n,"center",function(){return this._originalBoundSphere.center},function(t){this._originalBoundSphere.center=t}),e}(Collider),MeshCollider=function(t){function e(){this._transformBoundingBox=null,this._mesh=null,e.__super.call(this),this._transformBoundingBox=new BoundBox(new Vector3,new Vector3),this._needUpdate=!1}__class(e,"laya.d3.component.physics.MeshCollider",t);var n=e.prototype;return n._updateBoundBoxCollider=function(){if(this._needUpdate){for(var t=this._owner.transform.worldMatrix,n=this._mesh.boundingBoxCorners,i=0;i<8;i++)Vector3.transformCoordinate(n[i],t,e._tempBoundBoxCorners[i]);BoundBox.createfromPoints(e._tempBoundBoxCorners,this._transformBoundingBox),this._needUpdate=!1}},n._raycastMesh=function(t,n,i,r){void 0===r&&(r=1.79e308);var a=n.transform.worldMatrix,s=e._tempMatrix4x40;a.invert(s);var o=t.origin,l=t.direction,h=e._tempRay0;Vector3.transformCoordinate(o,s,h.origin),Vector3.TransformNormal(l,s,h.direction);for(var _=Number.MAX_VALUE,u=0,c=this._mesh.getRenderElementsCount();u<c;u++){var d=this._mesh.getRenderElement(u),f=d._getVertexBuffer(0),m=f.getData(),p=d._getIndexBuffer().getData(),g=e._tempRaycastHit;if(Picker.rayIntersectsPositionsAndIndices(h,m,f.vertexDeclaration,p,g)){Vector3.transformCoordinate(g.position,a,g.position);var v=e._tempVector30;Vector3.subtract(o,g.position,v);var x=Vector3.scalarLength(v);if(x<r&&x<_){g.distance=x,g.sprite3D=n;var S=g.trianglePositions;Vector3.transformCoordinate(S[0],a,S[0]),Vector3.transformCoordinate(S[1],a,S[1]),Vector3.transformCoordinate(S[2],a,S[2]);var T=g.triangleNormals;return Vector3.transformCoordinate(T[0],a,T[0]),Vector3.transformCoordinate(T[1],a,T[1]),Vector3.transformCoordinate(T[2],a,T[2]),_=x,g.cloneTo(i),!0}return!1}}return!1},n._onWorldMatrixChanged=function(){this._needUpdate=!0},n._initialize=function(t){laya.d3.component.Component3D.prototype._initialize.call(this,t),t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._getType=function(){return 2},n._collisonTo=function(t){var e=0,n=0,i=this.mesh._positions;switch(t._getType()){case 0:var r=t;if(0!==Collision.sphereContainsBox(r.boundSphere,this._boundBox)){for(e=0,n=i.length;e<n;e++)if(1===Collision.sphereContainsPoint(r.boundSphere,i[e]))return!0;return!1}return!1;case 1:var a=t;if(0!==a.boundBox.containsBoundBox(this._boundBox)){for(e=0,n=i.length;e<n;e++)if(1===a.boundBox.containsPoint(i[e]))return!0;return!1}return!1;case 2:var s=t;return 1!==Collision.intersectsBoxAndBox(s._boundBox,this._boundBox);default:throw new Error("MeshCollider:unknown collider type.")}},n._cloneTo=function(t){t.mesh=this._mesh},n.raycast=function(t,e,n){if(void 0===n&&(n=1.79e308),null==this._mesh||!this._mesh.loaded)return!1;var i=Collision.intersectsRayAndBoxRD(t,this._boundBox);return!!(-1!==i&&i<=n&&this._raycastMesh(t,this._owner,e,n))||(e.distance=-1,e.sprite3D=null,!1)},__getset(0,n,"mesh",function(){return this._mesh},function(t){this._mesh=t}),__getset(0,n,"_boundBox",function(){return this._updateBoundBoxCollider(),this._transformBoundingBox}),__static(e,["_tempRay0",function(){return this._tempRay0=new Ray(new Vector3,new Vector3)},"_tempVector30",function(){return this._tempVector30=new Vector3},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_tempRaycastHit",function(){return this._tempRaycastHit=new RaycastHit},"_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]}]),e}(Collider),BoxCollider=function(t){function e(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,e.__super.call(this),this._needUpdate=!1}__class(e,"laya.d3.component.physics.BoxCollider",t);var n=e.prototype;return n._updateCollider=function(){if(this._needUpdate){var t=this._owner.transform;t.worldMatrix.cloneTo(this._transformOrientedBoundBox.transformation),Vector3.multiply(t.scale,this.center,e._deviationV3),Vector3.transformQuat(e._deviationV3,t.rotation,e._deviationV3),this._transformOrientedBoundBox.getCenter(e._obbCenterV3),Vector3.add(e._obbCenterV3,e._deviationV3,e._deviationV3),this._transformOrientedBoundBox.transformation.setTranslationVector(e._deviationV3),this._needUpdate=!1}},n._onWorldMatrixChanged=function(){this._needUpdate=!0;for(var t in this._runtimeCollisonMap)this._runtimeCollisonTestMap[t]=!0,this._runtimeCollisonMap[t]._runtimeCollisonTestMap[this.id]=!0},n._initialize=function(t){laya.d3.component.Component3D.prototype._initialize.call(this,t),this._transformOrientedBoundBox=new OrientedBoundBox(new Vector3,new Matrix4x4),this._size=new Vector3,this.center=new Vector3,t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},n._getType=function(){return 1},n._collisonTo=function(t){switch(t._getType()){case 0:return 0!==this.boundBox.containsSphere(t.boundSphere);case 1:return 0!==this.boundBox.containsOrientedBoundBox(t.boundBox);case 2:var e=t;if(0!==this.boundBox.containsBoundBox(e._boundBox)){for(var n=t.mesh._positions,i=0,r=n.length;i<r;i++)if(1===this.boundBox.containsPoint(n[i]))return!0;return!1}return!1;default:throw new Error("BoxCollider:unknown collider type.")}},n._cloneTo=function(t){var e=t,n=e.size;this.size.cloneTo(n),e.size=n,this.center.cloneTo(e.center)},n.raycast=function(t,e,n){void 0===n&&(n=1.79e308),this._updateCollider();var i=this._transformOrientedBoundBox.intersectsRay(t,e.position);return-1!==i&&i<=n?(e.distance=i,e.sprite3D=this._owner,!0):(e.distance=-1,e.sprite3D=null,!1)},n.setFromBoundBox=function(t){OrientedBoundBox.createByBoundBox(t,this._transformOrientedBoundBox);var e=this._transformOrientedBoundBox.extents;this._size=new Vector3(2*e.x,2*e.y,2*e.z),this.center=new Vector3,Vector3.add(t.min,t.max,this.center),Vector3.scale(this.center,.5,this.center),this._needUpdate=!0},__getset(0,n,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),__getset(0,n,"size",function(){return this._size},function(t){this._size=t,Vector3.scale(t,.5,this._transformOrientedBoundBox.extents)}),__static(e,["_deviationV3",function(){return this._deviationV3=new Vector3},"_obbCenterV3",function(){return this._obbCenterV3=new Vector3}]),e}(Collider),VertexBuffer2D=function(t){function e(t,n){this._floatArray32=null,this._vertexStride=0,e.__super.call(this),this._vertexStride=t,this._bufferUsage=n,this._bufferType=34962,Render.isFlash||(this._buffer=new ArrayBuffer(8)),this.getFloat32Array()}__class(e,"laya.webgl.utils.VertexBuffer2D",t);var n=e.prototype;return n.getFloat32Array=function(){return this._floatArray32||(this._floatArray32=new Float32Array(this._buffer))},n.bind=function(t){t&&t._bind(),this._bind()},n.insertData=function(t,e){this.getFloat32Array().set(t,e),this._upload=!0},n.bind_upload=function(t){t._bind_upload()||t._bind(),this._bind_upload()||this._bind()},n._checkArrayUse=function(){this._floatArray32&&(this._floatArray32=new Float32Array(this._buffer))},n.detoryResource=function(){t.prototype.detoryResource.call(this);for(var e=Buffer._enableAtributes,n=0;n<10;n++)WebGL.mainContext.disableVertexAttribArray(n),e[n]=null},n.destory=function(){this._byteLength=0,this._upload=!0,this._buffer=null,this._floatArray32=null},__getset(0,n,"vertexStride",function(){return this._vertexStride}),e.create=function(t,n){return void 0===n&&(n=35048),new e(t,n)},e}(Buffer2D),IndexBuffer2D=function(t){function e(t){this._uint8Array=null,this._uint16Array=null,void 0===t&&(t=35044),e.__super.call(this),this._bufferUsage=t,this._bufferType=34963,Render.isFlash||(this._buffer=new ArrayBuffer(8))}__class(e,"laya.webgl.utils.IndexBuffer2D",t);var n=e.prototype;return n._checkArrayUse=function(){this._uint8Array&&(this._uint8Array=new Uint8Array(this._buffer)),this._uint16Array&&(this._uint16Array=new Uint16Array(this._buffer))},n.getUint8Array=function(){return this._uint8Array||(this._uint8Array=new Uint8Array(this._buffer))},n.getUint16Array=function(){return this._uint16Array||(this._uint16Array=new Uint16Array(this._buffer))},n.destory=function(){this._uint16Array=null,this._uint8Array=null,this._buffer=null},e.QuadrangleIB=null,e.create=function(t){return void 0===t&&(t=35044),new e(t)},e}(Buffer2D),Shader2X=function(t){function e(t,n,i,r){this._params2dQuick1=null,this._params2dQuick2=null,this._shaderValueWidth=NaN,this._shaderValueHeight=NaN,e.__super.call(this,t,n,i,r)}__class(e,"laya.webgl.shader.d2.Shader2X",t);var n=e.prototype;return n.upload2dQuick1=function(t){this.upload(t,this._params2dQuick1||this._make2dQuick1())},n._make2dQuick1=function(){if(!this._params2dQuick1){this.activeResource(),this._params2dQuick1=[];for(var t,e=this._params,n=0,i=e.length;n<i;n++)t=e[n],(Render.isFlash||"size"!==t.name&&"position"!==t.name&&"texcoord"!==t.name)&&this._params2dQuick1.push(t)}return this._params2dQuick1},n.detoryResource=function(){t.prototype.detoryResource.call(this),this._params2dQuick1=null,this._params2dQuick2=null},n.upload2dQuick2=function(t){this.upload(t,this._params2dQuick2||this._make2dQuick2())},n._make2dQuick2=function(){if(!this._params2dQuick2){this.activeResource(),this._params2dQuick2=[];for(var t,e=this._params,n=0,i=e.length;n<i;n++)t=e[n],(Render.isFlash||"size"!==t.name)&&this._params2dQuick2.push(t)}return this._params2dQuick2},e.create=function(t,n,i,r){return new e(t,n,i,r)},e}(Shader),HTMLImage=function(t){function e(t,n){this._recreateLock=!1,this._needReleaseAgain=!1,this._enableMerageInAtlas=!0,e.__super.call(this),this._init_(t,n)}__class(e,"laya.resource.HTMLImage",t);var n=e.prototype;return n._init_=function(t,e){this._src=t,this._source=new Browser.window.Image,e&&(e.onload&&(this.onload=e.onload),e.onerror&&(this.onerror=e.onerror),e.onCreate&&e.onCreate(this)),0!=t.indexOf("data:image")&&(this._source.crossOrigin=""),t&&(this._source.src=t)},n.recreateResource=function(){var t=this;if(""===this._src)throw new Error("src no null！");if(this._needReleaseAgain=!1,this._source){if(this._recreateLock)return;this.memorySize=this._w*this._h*4,this._recreateLock=!1,this.completeCreate()}else{this._recreateLock=!0;var e=this;this._source=new Browser.window.Image,this._source.crossOrigin="",this._source.onload=function(){if(e._needReleaseAgain)return e._needReleaseAgain=!1,e._source.onload=null,void(e._source=null);e._source.onload=null,e.memorySize=t._w*t._h*4,e._recreateLock=!1,e.completeCreate()},this._source.src=this._src}},n.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(this._source=null,this.memorySize=0)},n.onresize=function(){this._w=this._source.width,this._h=this._source.height},__getset(0,n,"enableMerageInAtlas",function(){return this._enableMerageInAtlas},function(t){this._enableMerageInAtlas=t,Render.isConchApp&&this._source&&(this._source.enableMerageInAtlas=t)}),__getset(0,n,"onerror",null,function(t){var e=this;this._onerror=t,this._source&&(this._source.onerror=null!=this._onerror?function(){e._onerror()}:null)}),__getset(0,n,"onload",null,function(t){var e=this;this._onload=t,this._source&&(this._source.onload=null!=this._onload?function(){e.onresize(),e._onload()}:null)}),e.create=function(t,n){return new e(t,n)},e}(FileBitmap),RenderableSprite3D=function(t){function e(t){this._render=null,this._geometryFilter=null,e.__super.call(this,t)}__class(e,"laya.d3.core.RenderableSprite3D",t);var n=e.prototype;return n._addToInitStaticBatchManager=function(){},n._setBelongScene=function(e){t.prototype._setBelongScene.call(this,e),e._renderableSprite3Ds.push(this),this._render._applyLightMapParams()},n._setUnBelongScene=function(){var e=this._scene._renderableSprite3Ds,n=e.indexOf(this);e.splice(n,1),this._render._removeShaderDefine(4),t.prototype._setUnBelongScene.call(this)},n._update=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._render._updateOctreeNode(),this._lateUpdateComponents(t),Stat.spriteCount++,this._childs.length&&this._updateChilds(t))},n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._render._destroy(),this._render=null},n._updateConch=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._render._updateOctreeNode(),this._lateUpdateComponents(t),Stat.spriteCount++,this._childs.length&&this._updateChildsConch(t))},e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=2,e.SAHDERDEFINE_LIGHTMAP=4,e.LIGHTMAPSCALEOFFSET=2,e.LIGHTMAP=3,e}(Sprite3D),BaseCamera=function(t){function e(t,n){e.__super.call(this),void 0===t&&(t=.3),void 0===n&&(n=1e3),this._tempVector3=new Vector3,this._position=new Vector3,this._up=new Vector3,this._forward=new Vector3,this._right=new Vector3,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=Size.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=t,this._farPlane=n,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),Laya.stage.on("resize",this,this._onScreenSizeChanged)}__class(e,"laya.d3.core.BaseCamera",t);var n=e.prototype;return n.createConchModel=function(){return new ConchCamera},n._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var t=this.scene._cameraPool,e=t.length-1,n=0;n<e;n++)if(t[n].renderingOrder>t[e].renderingOrder){var i=t[n];t[n]=t[e],t[e]=i}},n._calculateProjectionMatrix=function(){},n._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},n._prepareCameraToRender=function(){Layer._currentCameraCullingMask=this.cullingMask;var t=this._shaderValues;t.setValue(0,this.transform.position.elements),t.setValue(5,this.forward.elements),t.setValue(6,this.up.elements)},n._prepareCameraViewProject=function(t,e){var n=this._shaderValues;n.setValue(1,t.elements),n.setValue(2,e.elements)},n._renderCamera=function(t,e,n){},n.addLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask|t.mask)},n.removeLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask&~t.mask)},n.addAllLayers=function(){this.cullingMask=2147483647},n.removeAllLayers=function(){this.cullingMask=0|Layer.getLayerByNumber(29).mask|Layer.getLayerByNumber(30).mask},n.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},n.destroy=function(e){void 0===e&&(e=!0),this._sky&&(this._sky._ownerCamera=null,this._sky=null),this.renderTarget=null,Laya.stage.off("resize",this,this._onScreenSizeChanged),t.prototype.destroy.call(this,e)},n.moveForward=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=t,this.transform.translate(this._tempVector3)},n.moveRight=function(t){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=t,this.transform.translate(this._tempVector3)},n.moveVertical=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=t,this.transform.translate(this._tempVector3,!1)},n._addSelfRenderObjects=function(){var t=this.scene._cameraPool,e=t.length;if(e>0){for(var n=e-1;n>=0;n--)if(this.renderingOrder<=t[n].renderingOrder){t.splice(n+1,0,this);break}}else t.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},n._clearSelfRenderObjects=function(){var t=this.scene._cameraPool;t.splice(t.indexOf(this),1)},__getset(0,n,"renderingOrder",function(){return this._renderingOrder},function(t){this._renderingOrder=t,this._sortCamerasByRenderingOrder()}),__getset(0,n,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(t){this._orthographicVerticalSize=t,this._calculateProjectionMatrix()}),__getset(0,n,"orthographic",function(){return this._orthographic},function(t){this._orthographic=t,this._calculateProjectionMatrix()}),__getset(0,n,"renderTargetSize",function(){return this._renderTargetSize},function(t){null!=this.renderTarget&&this._renderTargetSize,this._renderTargetSize=t,this._calculateProjectionMatrix()}),__getset(0,n,"farPlane",function(){return this._farPlane},function(t){this._farPlane=t,this._calculateProjectionMatrix()}),__getset(0,n,"fieldOfView",function(){return this._fieldOfView},function(t){this._fieldOfView=t,this._calculateProjectionMatrix()}),__getset(0,n,"renderTarget",function(){return this._renderTarget},function(t){this._renderTarget=t,null!=t&&(this._renderTargetSize=t.size)}),__getset(0,n,"up",function(){var t=this.transform.worldMatrix.elements,e=this._up.elements;return e[0]=t[4],e[1]=t[5],e[2]=t[6],this._up}),__getset(0,n,"nearPlane",function(){return this._nearPlane},function(t){this._nearPlane=t,this._calculateProjectionMatrix()}),__getset(0,n,"right",function(){var t=this.transform.worldMatrix.elements,e=this._right.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],this._right}),__getset(0,n,"forward",function(){var t=this.transform.worldMatrix.elements,e=this._forward.elements;return e[0]=-t[8],e[1]=-t[9],e[2]=-t[10],this._forward}),__getset(0,n,"position",function(){var t=this.transform.worldMatrix.elements,e=this._position.elements;return e[0]=t[12],e[1]=t[13],e[2]=t[14],this._position}),__getset(0,n,"sky",function(){return this._sky},function(t){this._sky=t,t._ownerCamera=this,this.conchModel&&this.conchModel.setSkyMesh(this._sky._conchSky)}),e.CAMERAPOS=0,e.VIEWMATRIX=1,e.PROJECTMATRIX=2,e.VPMATRIX=3,e.VPMATRIX_NO_TRANSLATE=4,e.CAMERADIRECTION=5,e.CAMERAUP=6,e.ENVIRONMENTDIFFUSE=7,e.ENVIRONMENTSPECULAR=8,e.SIMLODINFO=9,e.DIFFUSEIRRADMATR=10,e.DIFFUSEIRRADMATG=11,e.DIFFUSEIRRADMATB=12,e.HDREXPOSURE=13,e.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",e.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",e.CLEARFLAG_SOLIDCOLOR=0,e.CLEARFLAG_SKY=1,e.CLEARFLAG_DEPTHONLY=2,e.CLEARFLAG_NONE=3,__static(e,["_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new Matrix4x4(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new Matrix4x4},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new Matrix4x4}]),e}(Sprite3D),LightSprite=function(t){function e(){this._intensityColor=null,this._intensity=NaN,this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this._lightmapBakedType=0,this.color=null,e.__super.call(this),this._intensity=1,this._intensityColor=new Vector3,this.color=new Vector3(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0,this._lightmapBakedType=e.LIGHTMAPBAKEDTYPE_REALTIME}__class(e,"laya.d3.core.light.LightSprite",t);var n=e.prototype;return n._parseCustomProps=function(t,e,n,i){var r=n.color,a=this.color.elements;a[0]=r[0],a[1]=r[1],a[2]=r[2]},n._addSelfRenderObjects=function(){this.lightmapBakedType!==e.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._addLight(this)},n._clearSelfRenderObjects=function(){this.lightmapBakedType!==e.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._removeLight(this)},n._prepareToScene=function(t){return!1},__getset(0,n,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(t){console.log("LightSprite: discard property,please use color property instead."),this.color=t}),__getset(0,n,"lightmapBakedType",function(){return this._lightmapBakedType},function(t){this._lightmapBakedType!==t&&(this._lightmapBakedType=t,this._activeInHierarchy&&(t!==e.LIGHTMAPBAKEDTYPE_BAKED?this._scene._addLight(this):this._scene._removeLight(this)))}),__getset(0,n,"shadowPCFType",function(){return this._shadowMapPCFType},function(t){this._shadowMapPCFType=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(t)}),__getset(0,n,"shadowPSSMCount",function(){return this._shadowMapCount},function(t){this._shadowMapCount=t,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.PSSMNum=t)}),__getset(0,n,"intensity",function(){return this._intensity},function(t){this._intensity=t}),__getset(0,n,"shadow",function(){return this._shadow},function(t){throw new Error("LightSprite: must override it.")}),__getset(0,n,"shadowResolution",function(){return this._shadowMapSize},function(t){this._shadowMapSize=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(t)}),__getset(0,n,"shadowDistance",function(){return this._shadowFarPlane},function(t){this._shadowFarPlane=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(t)}),e.LIGHTMAPBAKEDTYPE_REALTIME=0,e.LIGHTMAPBAKEDTYPE_MIXED=1,e.LIGHTMAPBAKEDTYPE_BAKED=2,e}(Sprite3D),Terrain=function(t){function e(t){this._terrainRes=null,this._lightmapScaleOffset=null,e.__super.call(this),this._lightmapScaleOffset=new Vector4(1,1,0,0),t&&(this._terrainRes=t,t.loaded?this.buildTerrain(t):t.once("loaded",this,this.buildTerrain))}__class(e,"laya.d3.terrain.Terrain",t);var n=e.prototype;return n._parseCustomProps=function(t,e,n,i){this.terrainRes=Loader.getRes(e[n.dataPath]);var r=n.lightmapIndex;null!=r&&this.setLightmapIndex(r);var a=n.lightmapScaleOffset;a&&this.setLightmapScaleOffset(new Vector4(a[0],a[1],a[2],a[3]))},n.setLightmapIndex=function(t){for(var e=0;e<this._childs.length;e++){this._childs[e].terrainRender.lightmapIndex=t}},n.setLightmapScaleOffset=function(t){if(t){t.cloneTo(this._lightmapScaleOffset);for(var e=0;e<this._childs.length;e++){this._childs[e].terrainRender.lightmapScaleOffset=this._lightmapScaleOffset}}},n.disableLight=function(){for(var t=0,e=this._childs.length;t<e;t++)for(var n=this._childs[t],i=0,r=n._render.sharedMaterials.length;i<r;i++){var a=n._render.sharedMaterials[i];a.disableLight()}},n.buildTerrain=function(t){for(var e=t._chunkNumX,n=t._chunkNumZ,i=t._heightData,r=0,a=0;a<n;a++)for(var s=0;s<e;s++){for(var o=new TerrainChunk(s,a,t._gridSize,i._terrainHeightData,i._width,i._height,t._cameraCoordinateInverse),l=t._chunkInfos[r++],h=0;h<l.alphaMap.length;h++){var _=l.detailID[h].length,u=_>0?t._detailTextureInfos[l.detailID[h][0]].diffuseTexture:null,c=_>1?t._detailTextureInfos[l.detailID[h][1]].diffuseTexture:null,d=_>2?t._detailTextureInfos[l.detailID[h][2]].diffuseTexture:null,f=_>3?t._detailTextureInfos[l.detailID[h][3]].diffuseTexture:null,m=_>0?t._detailTextureInfos[l.detailID[h][0]].scale:null,p=_>1?t._detailTextureInfos[l.detailID[h][1]].scale:null,g=_>2?t._detailTextureInfos[l.detailID[h][2]].scale:null,v=_>3?t._detailTextureInfos[l.detailID[h][3]].scale:null;o.buildRenderElementAndMaterial(_,l.normalMap,l.alphaMap[h],u,c,d,f,t._materialInfo.ambientColor,t._materialInfo.diffuseColor,t._materialInfo.specularColor,m?m.x:1,m?m.y:1,p?p.x:1,p?p.y:1,g?g.x:1,g?g.y:1,v?v.x:1,v?v.y:1)}o.terrainRender.receiveShadow=!0,o.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(o)}},n.width=function(){return this._terrainRes._chunkNumX*TerrainLeaf.CHUNK_GRID_NUM*this._terrainRes._gridSize},n.depth=function(){return this._terrainRes._chunkNumZ*TerrainLeaf.CHUNK_GRID_NUM*this._terrainRes._gridSize},n.getHeightXZ=function(t,n){if(!this._terrainRes||!this._terrainRes.loaded)return NaN;if(t-=this.transform.position.x,n-=this.transform.position.z,e.__VECTOR3__||(e.__VECTOR3__=new Vector3),e.__VECTOR3__.elements[0]=t,e.__VECTOR3__.elements[1]=0,e.__VECTOR3__.elements[2]=n,Vector3.transformV3ToV3(e.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX_INV__,e.__VECTOR3__),t=e.__VECTOR3__.elements[0],n=e.__VECTOR3__.elements[2],t<0||t>this.width()||n<0||n>this.depth())return NaN;var i=this._terrainRes._gridSize,r=parseInt(""+t/i),a=parseInt(""+n/i),s=t-r*i,o=n-a*i,l=NaN,h=NaN,_=NaN,u=NaN,c=NaN,d=this._terrainRes._heightData;return s+o>i?(l=d._terrainHeightData[(a+1-1)*d._width+r+1],h=d._terrainHeightData[(a+1-1)*d._width+r],
_=d._terrainHeightData[(a-1)*d._width+r+1],u=(i-s)/i,c=(i-o)/i,l+(h-l)*u+(_-l)*c):(l=d._terrainHeightData[Math.max(0,a-1)*d._width+r],h=d._terrainHeightData[Math.min(d._width*d._height-1,(a+1-1)*d._width+r)],_=d._terrainHeightData[Math.min(d._width*d._height-1,Math.max(0,a-1)*d._width+r+1)],u=s/i,c=o/i,l+(h-l)*c+(_-l)*u)},__getset(0,n,"terrainRes",null,function(t){t&&(this._terrainRes=t,t.loaded?this.buildTerrain(t):t.once("loaded",this,this.buildTerrain))}),e.load=function(t){return Laya.loader.create(t,null,null,e,null,1,!1)},e.RENDER_LINE_MODEL=!1,e.LOD_TOLERANCE_VALUE=4,e.LOD_DISTANCE_FACTOR=2,e.__VECTOR3__=null,e}(Sprite3D),Input=function(t){function e(){this._focus=!1,this._multiline=!1,this._editable=!0,this._restrictPattern=null,this._type="text",this._prompt="",this._promptColor="#A9A9A9",this._originColor="#000000",this._content="",e.__super.call(this),this._maxChars=1e5,this._width=100,this._height=20,this.multiline=!1,this.overflow=Text.SCROLL,this.on("mousedown",this,this._onMouseDown),this.on("undisplay",this,this._onUnDisplay)}__class(e,"laya.display.Input",t);var n=e.prototype;return n.setSelection=function(t,e){this.focus=!0,laya.display.Input.inputElement.selectionStart=t,laya.display.Input.inputElement.selectionEnd=e},n._onUnDisplay=function(t){this.focus=!1},n._onMouseDown=function(t){this.focus=!0},n._syncInputTransform=function(){var t=this.nativeInput,n=Utils.getTransformRelativeToWindow(this,this.padding[3],this.padding[0]),i=this._width-this.padding[1]-this.padding[3],r=this._height-this.padding[0]-this.padding[2];Render.isConchApp?(t.setScale(n.scaleX,n.scaleY),t.setSize(i,r),t.setPos(n.x,n.y)):(e.inputContainer.style.transform=e.inputContainer.style.webkitTransform="scale("+n.scaleX+","+n.scaleY+") rotate("+Laya.stage.canvasDegree+"deg)",t.style.width=i+"px",t.style.height=r+"px",e.inputContainer.style.left=n.x+"px",e.inputContainer.style.top=n.y+"px")},n.select=function(){this.nativeInput.select()},n._setInputMethod=function(){e.input.parentElement&&e.inputContainer.removeChild(e.input),e.area.parentElement&&e.inputContainer.removeChild(e.area),e.inputElement=this._multiline?e.area:e.input,e.inputContainer.appendChild(e.inputElement),Text.RightToLeft&&(e.inputElement.style.direction="rtl")},n._focusIn=function(){laya.display.Input.isInputting=!0;var t=this.nativeInput;this._focus=!0;var e=t.style;e.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),t.readOnly=!this._editable,Render.isConchApp&&(t.setType(this._type),t.setForbidEdit(!this._editable)),t.maxLength=this._maxChars;this.padding;if(t.type=this._type,t.value=this._content,t.placeholder=this._prompt,Laya.stage.off("keydown",this,this._onKeyDown),Laya.stage.on("keydown",this,this._onKeyDown),Laya.stage.focus=this,this.event("focus"),Browser.onPC&&t.focus(),!Browser.onMiniGame){this._text;this._text=null}this.typeset(),t.setColor(this._originColor),t.setFontSize(this.fontSize),t.setFontFace(Browser.onIPhone?Text._fontFamilyMap[this.font]||this.font:this.font),Render.isConchApp&&t.setMultiAble&&t.setMultiAble(this._multiline),e.lineHeight=this.leading+this.fontSize+"px",e.fontStyle=this.italic?"italic":"normal",e.fontWeight=this.bold?"bold":"normal",e.textAlign=this.align,e.padding="0 0",this._syncInputTransform(),!Render.isConchApp&&Browser.onPC&&Laya.timer.frameLoop(1,this,this._syncInputTransform)},n._setPromptColor=function(){e.promptStyleDOM=Browser.getElementById("promptStyle"),e.promptStyleDOM||(e.promptStyleDOM=Browser.createElement("style"),e.promptStyleDOM.setAttribute("id","promptStyle"),Browser.document.head.appendChild(e.promptStyleDOM)),e.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"},n._focusOut=function(){laya.display.Input.isInputting=!1,this._focus=!1,this._text=null,this._content=this.nativeInput.value,this._content?(t.prototype._$set_text.call(this,this._content),t.prototype._$set_color.call(this,this._originColor)):(t.prototype._$set_text.call(this,this._prompt),t.prototype._$set_color.call(this,this._promptColor)),Laya.stage.off("keydown",this,this._onKeyDown),Laya.stage.focus=null,this.event("blur"),Render.isConchApp&&this.nativeInput.blur(),Browser.onPC&&Laya.timer.clear(this,this._syncInputTransform)},n._onKeyDown=function(t){13===t.keyCode&&(Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event("enter"))},n.changeText=function(e){this._content=e,this._focus?(this.nativeInput.value=e||"",this.event("change")):t.prototype.changeText.call(this,e)},__getset(0,n,"inputElementXAdjuster",function(){return console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementXAdjuster已弃用。"),0},function(t){console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementXAdjuster已弃用。")}),__getset(0,n,"type",function(){return this._type},function(t){this._getCSSStyle().password="password"==t,this._type=t,Render.isConchApp&&this.nativeInput.setType(t)}),__getset(0,n,"editable",function(){return this._editable},function(t){this._editable=t,Render.isConchApp&&e.input.setForbidEdit(!t)}),__getset(0,n,"prompt",function(){return this._prompt},function(e){!this._text&&e&&t.prototype._$set_color.call(this,this._promptColor),this.promptColor=this._promptColor,this._text?t.prototype._$set_text.call(this,this._text==this._prompt?e:this._text):t.prototype._$set_text.call(this,e),this._prompt=Text.langPacks&&Text.langPacks[e]?Text.langPacks[e]:e}),__getset(0,n,"restrict",function(){return this._restrictPattern?this._restrictPattern.source:""},function(t){t?(t="[^"+t+"]",t.indexOf("^^")>-1&&(t=t.replace("^^","")),this._restrictPattern=new RegExp(t,"g")):this._restrictPattern=null}),__getset(0,n,"color",t.prototype._$get_color,function(e){this._focus&&this.nativeInput.setColor(e),t.prototype._$set_color.call(this,this._content?e:this._promptColor),this._originColor=e}),__getset(0,n,"asPassword",function(){return this._getCSSStyle().password},function(t){this._getCSSStyle().password=t,this._type="password",console.warn('deprecated: 使用type="password"替代设置asPassword, asPassword将在下次重大更新时删去'),this.isChanged=!0}),__getset(0,n,"maxChars",function(){return this._maxChars},function(t){t<=0&&(t=1e5),this._maxChars=t}),__getset(0,n,"inputElementYAdjuster",function(){return console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementYAdjuster已弃用。"),0},function(t){console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementYAdjuster已弃用。")}),__getset(0,n,"text",function(){return this._focus?this.nativeInput.value:this._content||""},function(e){t.prototype._$set_color.call(this,this._originColor),e+="",this._focus?(this.nativeInput.value=e||"",this.event("change")):(this._multiline||(e=e.replace(/\r?\n/g,"")),this._content=e,e?t.prototype._$set_text.call(this,e):(t.prototype._$set_text.call(this,this._prompt),t.prototype._$set_color.call(this,this.promptColor)))}),__getset(0,n,"promptColor",function(){return this._promptColor},function(e){this._promptColor=e,this._content||t.prototype._$set_color.call(this,e)}),__getset(0,n,"focus",function(){return this._focus},function(t){var n=this.nativeInput;this._focus!==t&&(t?(n.target?n.target._focusOut():this._setInputMethod(),n.target=this,this._focusIn()):(n.target=null,this._focusOut(),Browser.document.body.scrollTop=0,n.blur(),Render.isConchApp?n.setPos(-1e4,-1e4):e.inputContainer.contains(n)&&e.inputContainer.removeChild(n)))}),__getset(0,n,"nativeInput",function(){return this._multiline?e.area:e.input}),__getset(0,n,"multiline",function(){return this._multiline},function(t){this._multiline=t,this.valign=t?"top":"middle"}),e.__init__=function(){e._createInputElement(),Browser.onMobile&&Render.canvas.addEventListener(e.IOS_IFRAME?Browser.onMiniGame?"touchend":"click":"touchend",e._popupInputMethod)},e._popupInputMethod=function(t){if(laya.display.Input.isInputting){laya.display.Input.inputElement.focus()}},e._createInputElement=function(){e._initInput(e.area=Browser.createElement("textarea")),e._initInput(e.input=Browser.createElement("input")),e.inputContainer=Browser.createElement("div"),e.inputContainer.style.position="absolute",e.inputContainer.style.zIndex=1e5,Browser.container.appendChild(e.inputContainer),e.inputContainer.setPos=function(t,n){e.inputContainer.style.left=t+"px",e.inputContainer.style.top=n+"px"}},e._initInput=function(t){var n=t.style;n.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",n.resize="none",n.backgroundColor="transparent",n.border="none",n.outline="none",n.zIndex=1,t.addEventListener("input",e._processInputting),t.addEventListener("mousemove",e._stopEvent),t.addEventListener("mousedown",e._stopEvent),t.addEventListener("touchmove",e._stopEvent),t.setFontFace=function(e){t.style.fontFamily=e},Render.isConchApp||(t.setColor=function(e){t.style.color=e},t.setFontSize=function(e){t.style.fontSize=e+"px"})},e._processInputting=function(t){var e=laya.display.Input.inputElement.target;if(e){var n=laya.display.Input.inputElement.value;e._restrictPattern&&(n=n.replace(/\u2006|\x27/g,""),e._restrictPattern.test(n)&&(n=n.replace(e._restrictPattern,""),laya.display.Input.inputElement.value=n)),e._text=n,e.event("input")}},e._stopEvent=function(t){"touchmove"==t.type&&t.preventDefault(),t.stopPropagation&&t.stopPropagation()},e.TYPE_TEXT="text",e.TYPE_PASSWORD="password",e.TYPE_EMAIL="email",e.TYPE_URL="url",e.TYPE_NUMBER="number",e.TYPE_RANGE="range",e.TYPE_DATE="date",e.TYPE_MONTH="month",e.TYPE_WEEK="week",e.TYPE_TIME="time",e.TYPE_DATE_TIME="datetime",e.TYPE_DATE_TIME_LOCAL="datetime-local",e.TYPE_SEARCH="search",e.input=null,e.area=null,e.inputElement=null,e.inputContainer=null,e.confirmButton=null,e.promptStyleDOM=null,e.inputHeight=45,e.isInputting=!1,e.stageMatrix=null,__static(e,["IOS_IFRAME",function(){return this.IOS_IFRAME=Browser.onIOS&&Browser.window.top!=Browser.window.self}]),e}(Text),BoxMesh=function(t){function e(t,n,i){this._long=NaN,this._width=NaN,this._height=NaN,void 0===t&&(t=1),void 0===n&&(n=1),void 0===i&&(i=1),e.__super.call(this),this._long=t,this._width=n,this._height=i,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}__class(e,"laya.d3.resource.models.BoxMesh",t);var n=e.prototype;return n.recreateResource=function(){this._numberVertices=24,this._numberIndices=36;var t=VertexPositionNormalTexture.vertexDeclaration,e=(t.vertexStride,this._long/2),n=this._height/2,i=this._width/2,r=new Float32Array([-e,n,-i,0,1,0,0,0,e,n,-i,0,1,0,1,0,e,n,i,0,1,0,1,1,-e,n,i,0,1,0,0,1,-e,-n,-i,0,-1,0,0,1,e,-n,-i,0,-1,0,1,1,e,-n,i,0,-1,0,1,0,-e,-n,i,0,-1,0,0,0,-e,n,-i,-1,0,0,0,0,-e,n,i,-1,0,0,1,0,-e,-n,i,-1,0,0,1,1,-e,-n,-i,-1,0,0,0,1,e,n,-i,1,0,0,1,0,e,n,i,1,0,0,0,0,e,-n,i,1,0,0,0,1,e,-n,-i,1,0,0,1,1,-e,n,i,0,0,1,0,0,e,n,i,0,0,1,1,0,e,-n,i,0,0,1,1,1,-e,-n,i,0,0,1,0,1,-e,n,-i,0,0,-1,1,0,e,n,-i,0,0,-1,0,0,e,-n,-i,0,0,-1,0,1,-e,-n,-i,0,0,-1,1,1]),a=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);this._vertexBuffer=new VertexBuffer3D(t,this._numberVertices,35044,!0),this._indexBuffer=new IndexBuffer3D("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(r),this._indexBuffer.setData(a),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},__getset(0,n,"height",function(){return this._height},function(t){this._height!==t&&(this._height=t,this.releaseResource(),this.activeResource())}),__getset(0,n,"width",function(){return this._width},function(t){this._width!==t&&(this._width=t,this.releaseResource(),this.activeResource())}),__getset(0,n,"long",function(){return this._long},function(t){this._long!==t&&(this._long=t,this.releaseResource(),this.activeResource())}),e}(PrimitiveMesh),WebGLImage=function(t){function e(t,n,i,r){if(this._format=0,this._mipmap=!1,this._allowMerageInAtlas=!1,this._enableMerageInAtlas=!1,this.repeat=!1,this._image=null,this.minFifter=0,this.magFifter=0,void 0===i&&(i=6408),void 0===r&&(r=!0),e.__super.call(this,t,n),this._format=i,this._mipmap=r,this.repeat=!1,this.minFifter=-1,this.magFifter=-1,"string"==typeof t)this.url=t,this._src=t,this._image=new Browser.window.Image,n&&(n.onload&&(this.onload=n.onload),n.onerror&&(this.onerror=n.onerror),n.onCreate&&n.onCreate(this)),this._image.crossOrigin=t&&0==t.indexOf("data:")?null:"",t&&(this._image.src=t);else if(t instanceof ArrayBuffer){this._src=n,this.url=this._src;var a=new Byte(t);a.readUTFBytes(4),a.readUTFBytes(2),a.getInt16();a.endian="bigEndian",this._w=a.getInt16(),this._h=a.getInt16();a.getInt16(),a.getInt16();this._image=new Uint8Array(t,a.pos),this._format=WebGL.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL,AtlasResourceManager.enabled&&this._w<AtlasResourceManager.atlasLimitWidth&&this._h<AtlasResourceManager.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1}else this._src=n,this.url=this._src,this._image=t.source||t,this.onresize();this._$5__enableMerageInAtlas=!0}__class(e,"laya.webgl.resource.WebGLImage",t);var n=e.prototype;return Laya.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n._init_=function(t,e){},n._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var t=WebGL.mainContext,e=this._source=t.createTexture(),n=WebGLContext.curBindTexTarget,i=WebGLContext.curBindTexValue;switch(WebGLContext.bindTexture(t,3553,e),t.pixelStorei(37441,!0),this._format){case 6408:t.texImage2D(3553,0,this._format,6408,5121,this._image);break;case WebGL.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:t.compressedTexImage2D(3553,0,this._format,this._w,this._h,0,this._image)}t.pixelStorei(37441,!1);var r=this.minFifter,a=this.magFifter,s=this.repeat?10497:33071,o=Arith.isPOT(this._w,this._h);o?(this.mipmap?-1!==r||(r=9987):-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,s),t.texParameteri(3553,10243,s),this.mipmap&&t.generateMipmap(3553)):(-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),n&&i&&WebGLContext.bindTexture(t,n,i),this._image.onload=null,this._image=null,this.memorySize=o?this._w*this._h*4*(1+1/3):this._w*this._h*4,this._recreateLock=!1},n.recreateResource=function(){var t=this;if(null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._image){if(this._recreateLock)return;this._allowMerageInAtlas&&this._$5__enableMerageInAtlas?(this.memorySize=0,this._recreateLock=!1):this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0;var e=this;this._image=new Browser.window.Image,this._image.crossOrigin=0==this._src.indexOf("data:")?null:"",this._image.onload=function(){if(e._needReleaseAgain)return e._needReleaseAgain=!1,e._image.onload=null,void(e._image=null);e._allowMerageInAtlas&&e._enableMerageInAtlas?(t.memorySize=0,t._recreateLock=!1):e._createWebGlTexture(),e.completeCreate()},this._image.src=this._src}},n.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(WebGL.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},n.onresize=function(){this._w=this._image.width,this._h=this._image.height,AtlasResourceManager.enabled&&this._w<AtlasResourceManager.atlasLimitWidth&&this._h<AtlasResourceManager.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1},n.clearAtlasSource=function(){this._image=null},__getset(0,n,"onload",null,function(t){var e=this;this._onload=t,this._image&&(this._image.onload=null!=this._onload?function(){e.onresize(),e._onload()}:null)}),__getset(0,n,"onerror",null,function(t){var e=this;this._onerror=t,this._image&&(this._image.onerror=null!=this._onerror?function(){e._onerror()}:null)}),__getset(0,n,"format",function(){return this._format}),__getset(0,n,"enableMerageInAtlas",function(){return this._$5__enableMerageInAtlas},function(t){this._$5__enableMerageInAtlas=t}),__getset(0,n,"atlasSource",function(){return this._image}),__getset(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),__getset(0,n,"mipmap",function(){return this._mipmap}),e}(HTMLImage),MeshSprite3D=function(t){function e(t,n){e.__super.call(this,n),this._geometryFilter=new MeshFilter(this),this._render=new MeshRender(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),t&&(this._geometryFilter.sharedMesh=t,t instanceof laya.d3.resource.models.Mesh&&(t.loaded?this._render.sharedMaterials=t.materials:t.once("loaded",this,this._applyMeshMaterials)))}__class(e,"laya.d3.core.MeshSprite3D",t);var n=e.prototype;return n._changeRenderObjectByMesh=function(t){var e=this._render._renderElements,n=e[t];n||(n=e[t]=new SubMeshRenderElement),n._render=this._render;var i=this._render.sharedMaterials[t];i||(i=StandardMaterial.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(t);if(n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,Render.isConchNode){var a=r._getVertexBuffer();n._conchSubmesh.setVBIB(a.vertexDeclaration._conchVertexDeclaration,a.getData(),r._getIndexBuffer().getData())}return n},n._changeRenderObjectByMaterial=function(t,e){var n=this._render._renderElements[t];e||(e=StandardMaterial.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(t);return n._mainSortID=this._getSortID(i,e),n._sprite3D=this,n.renderObj=i,n._material=e,Render.isConchNode&&n._conchSubmesh.setMaterial(e._conchMaterial),n},n._changeRenderObjectsByMesh=function(){Render.isConchNode;var t=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=t;for(var e=0;e<t;e++)this._changeRenderObjectByMesh(e)},n._onMeshChanged=function(t){var e=t.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._onMeshLoaded)},n._onMeshLoaded=function(t){t===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},n._onMaterialChanged=function(t,e,n){e<this._render._renderElements.length&&this._changeRenderObjectByMaterial(e,n)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._parseCustomProps=function(t,e,n,i){var r=this.meshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var s=n.lightmapScaleOffset;s&&(r.lightmapScaleOffset=new Vector4(s[0],s[1],s[2],s[3]));var o,l;if(i.instanceParams)(o=i.instanceParams.loadPath)&&(l=Loader.getRes(e[o]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{o=n.meshPath,o&&(l=Loader.getRes(e[o]),this.meshFilter.sharedMesh=l);var h=n.materials;if(h){var _=r.sharedMaterials,u=h.length;_.length=u;for(var c=0;c<u;c++)_[c]=Loader.getRes(e[h[c].path]);r.sharedMaterials=_}}},n._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,n=t.materials,i=0,r=n.length;i<r;i++)e[i]||(e[i]=n[i]);this._render.sharedMaterials=e},n._addToInitStaticBatchManager=function(){e._staticBatchManager._addInitBatchSprite(this)},n.cloneTo=function(t){var e=t;e._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=e._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.lightmapIndex=n.lightmapIndex,i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},n.destroy=function(e){if(void 0===e&&(e=!0),!this.destroyed){var n=this.meshFilter.sharedMesh;n.loaded||n.off("loaded",this,this._applyMeshMaterials),t.prototype.destroy.call(this,e),this._geometryFilter._destroy()}},n.createConchModel=function(){return null},__getset(0,n,"meshRender",function(){return this._render}),__getset(0,n,"meshFilter",function(){return this._geometryFilter}),e.__init__=function(){StaticBatchManager._staticBatchManagers.push(e._staticBatchManager)},e.load=function(t){return Laya.loader.create(t,null,null,e,null,1,!1)},__static(e,["_staticBatchManager",function(){return this._staticBatchManager=new MeshSprite3DStaticBatchManager}]),e}(RenderableSprite3D),Glitter=function(t){function e(){e.__super.call(this),this._render=new GlitterRender(this),this._render.on("materialchanged",this,this._onMaterialChanged);var t=new GlitterMaterial;this._render.sharedMaterial=t,this._geometryFilter=new GlitterTemplet(this),t.renderMode=8,this._changeRenderObject(0)}__class(e,"laya.d3.core.glitter.Glitter",t);var n=e.prototype;return n._changeRenderObject=function(t){var e=this._render._renderElements,n=e[t];n||(n=e[t]=new RenderElement),n._render=this._render;var i=this._render.sharedMaterials[t];i||(i=GlitterMaterial.defaultMaterial);var r=this._geometryFilter;return n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i,n},n._onMaterialChanged=function(t,e,n){e<t._renderElements.length&&this._changeRenderObject(e)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._update=function(e){this._geometryFilter._update(e.elapsedTime),t.prototype._update.call(this,e)},n.addGlitterByPositions=function(t,e){this._geometryFilter.addVertexPosition(t,e)},n.addGlitterByPositionsVelocitys=function(t,e,n,i){this._geometryFilter.addVertexPositionVelocity(t,e,n,i)},n.cloneTo=function(t){var e=t,n=e.templet,i=this._geometryFilter;n.lifeTime=i.lifeTime,n.minSegmentDistance=i.minSegmentDistance,n.minInterpDistance=i.minInterpDistance,n.maxSlerpCount=i.maxSlerpCount,n._maxSegments=i._maxSegments;var r=e._render,a=this._render;r.sharedMaterials=a.sharedMaterials,r.enable=a.enable,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},__getset(0,n,"glitterRender",function(){return this._render}),__getset(0,n,"templet",function(){return this._geometryFilter}),e.CURRENTTIME=2,e.DURATION=3,e}(RenderableSprite3D),Camera=function(t){function e(t,n,i){void 0===t&&(t=0),void 0===n&&(n=.3),void 0===i&&(i=1e3),this._viewMatrix=new Matrix4x4,this._projectionMatrix=new Matrix4x4,this._projectionViewMatrix=new Matrix4x4,this._viewport=new Viewport(0,0,0,0),this._normalizedViewport=new Viewport(0,0,1,1),this._aspectRatio=t,this._boundFrustumUpdate=!0,this._boundFrustum=new BoundFrustum(Matrix4x4.DEFAULT),e.__super.call(this,n,i),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}__class(e,"laya.d3.core.Camera",t);var n=e.prototype;return n._onWorldMatrixChanged=function(){this._boundFrustumUpdate=!0},n._parseCustomProps=function(t,e,n,i){var r=n.clearColor;this.clearColor=new Vector4(r[0],r[1],r[2],r[3]);var a=n.viewport;this.normalizedViewport=new Viewport(a[0],a[1],a[2],a[3])},n._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var t=this.orthographicVerticalSize*this.aspectRatio*.5,e=.5*this.orthographicVerticalSize;Matrix4x4.createOrthoOffCenterRH(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._boundFrustumUpdate=!0},n._update=function(t){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,t)},n._renderCamera=function(t,e,n){n.parallelSplitShadowMaps[0]&&n._renderShadowMap(t,e,this),e.camera=this,this._prepareCameraToRender(),n._preRenderUpdateComponents(e);var i,r;i=e._viewMatrix=this.viewMatrix;var a=this._renderTarget;a?(a.start(),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this._projectionMatrix,BaseCamera._invertYProjectionMatrix),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this.projectionViewMatrix,BaseCamera._invertYProjectionViewMatrix),r=e._projectionMatrix=BaseCamera._invertYProjectionMatrix,e._projectionViewMatrix=BaseCamera._invertYProjectionViewMatrix):(r=e._projectionMatrix=this._projectionMatrix,e._projectionViewMatrix=this.projectionViewMatrix),this._prepareCameraViewProject(i,r),e._viewport=this.viewport,n._preRenderScene(t,e,this.boundFrustum),n._clear(t,e),n._renderScene(t,e),n._postRenderUpdateComponents(e),a&&a.end()},n.viewportPointToRay=function(t,e){Picker.calculateCursorRay(t,this.viewport,this._projectionMatrix,this.viewMatrix,null,e)},n.normalizedViewportPointToRay=function(t,n){var i=e._tempVector20,r=this.viewport,a=t.elements,s=i.elements;s[0]=a[0]*r.width,s[1]=a[1]*r.height,Picker.calculateCursorRay(i,this.viewport,this._projectionMatrix,this.viewMatrix,null,n)},n.worldToViewportPoint=function(t,e){Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(t,this._projectionViewMatrix,e);var n=e.elements;e.z<0||e.z>1?n[0]=n[1]=n[2]=NaN:(n[0]=n[0]/Laya.stage.clientScaleX,n[1]=n[1]/Laya.stage.clientScaleY)},n.worldToNormalizedViewportPoint=function(t,e){Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(t,this._projectionViewMatrix,e);var n=e.elements;e.z<0||e.z>1?n[0]=n[1]=n[2]=NaN:(n[0]=n[0]/Laya.stage.clientScaleX,n[1]=n[1]/Laya.stage.clientScaleY)},n.convertScreenCoordToOrthographicCoord=function(t,e){if(this._orthographic){var n=RenderState.clientWidth,i=RenderState.clientHeight,r=this.orthographicVerticalSize*this.aspectRatio/n,a=this.orthographicVerticalSize/i,s=t.elements,o=e.elements;return o[0]=(-n/2+s[0])*r,o[1]=(i/2-s[1])*a,o[2]=(this.nearPlane-this.farPlane)*(s[2]+1)/2-this.nearPlane,Vector3.transformCoordinate(e,this.transform.worldMatrix,e),!0}return!1},__getset(0,n,"projectionViewMatrix",function(){return Matrix4x4.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),__getset(0,n,"projectionMatrix",function(){return this._projectionMatrix},function(t){this._projectionMatrix=t,this._useUserProjectionMatrix=!0}),__getset(0,n,"viewport",function(){if(this._viewportExpressedInClipSpace){var t=this._normalizedViewport,e=this.renderTargetSize,n=e.width,i=e.height;this._viewport.x=t.x*n,this._viewport.y=t.y*i,this._viewport.width=t.width*n,this._viewport.height=t.height*i}return this._viewport},function(t){if(null!=this.renderTarget&&(t.x<0||t.y<0||0==t.width||0==t.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=t,this._calculateProjectionMatrix()}),__getset(0,n,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),__getset(0,n,"needViewport",function(){var t=this.normalizedViewport;return 0===t.x&&0===t.y&&1===t.width&&1===t.height}),__getset(0,n,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var t=this._viewport,e=this.renderTargetSize,n=e.width,i=e.height;this._normalizedViewport.x=t.x/n,this._normalizedViewport.y=t.y/i,this._normalizedViewport.width=t.width/n,this._normalizedViewport.height=t.height/i}return this._normalizedViewport},function(t){t.x<0&&(t.x=0,console.warn("Camera: viewport.x must large than 0.0.")),t.y<0&&(t.y=0,console.warn("Camera: viewport.y must large than 0.0.")),t.x+t.width>1&&(t.width=1-t.x,console.warn("Camera: viewport.width + viewport.x must less than 1.0.")),t.y+t.height>1&&(t.height=1-t.y,console.warn("Camera: viewport.height + viewport.y must less than 1.0.")),this._viewportExpressedInClipSpace=!0,this._normalizedViewport=t,this._calculateProjectionMatrix()}),__getset(0,n,"boundFrustum",function(){return this._boundFrustumUpdate&&(this._boundFrustum.matrix=this.projectionViewMatrix),this._boundFrustum}),__getset(0,n,"aspectRatio",function(){if(0===this._aspectRatio){var t=this.viewport;return t.width/t.height}return this._aspectRatio},function(t){if(t<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=t,this._calculateProjectionMatrix()}),__static(e,["_tempVector20",function(){return this._tempVector20=new Vector2}]),e}(BaseCamera),ShuriKenParticle3D=function(t){function e(t){e.__super.call(this),this._render=new ShurikenParticleRender(this),this._render.on("materialchanged",this,this._onMaterialChanged),this._geometryFilter=new ShurikenParticleSystem(this),this._createRenderElement(0),t&&(this._render.sharedMaterial=t)}__class(e,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",t);var n=e.prototype;return n._initParticleVelocity=function(t){for(var e=new GradientDataNumber,n=t.velocitys,i=0,r=n.length;i<r;i++){var a=n[i];e.add(a.key,a.value)}return e},n._initParticleColor=function(t){var e=new GradientDataColor,n=t.alphas,i=0,r=0;for(i=0,r=n.length;i<r;i++){var a=n[i];e.addAlpha(a.key,a.value)}var s=t.rgbs;for(i=0,r=s.length;i<r;i++){var o=s[i],l=o.value;e.addRGB(o.key,new Vector3(l[0],l[1],l[2]))}return e},n._initParticleSize=function(t){for(var e=new GradientDataNumber,n=t.sizes,i=0,r=n.length;i<r;i++){var a=n[i];e.add(a.key,a.value)}return e},n._initParticleRotation=function(t){for(var e=new GradientDataNumber,n=t.angularVelocitys,i=0,r=n.length;i<r;i++){var a=n[i];e.add(a.key,a.value/180*Math.PI)}return e},n._initParticleFrame=function(t){for(var e=new GradientDataInt,n=t.frames,i=0,r=n.length;i<r;i++){var a=n[i];e.add(a.key,a.value)}return e},n._createRenderElement=function(t){var e=this._render._renderElements,n=e[t]=new RenderElement;n._render=this._render;var i=this._render.sharedMaterials[t];i||(i=ShurikenParticleMaterial.defaultMaterial);var r=this._geometryFilter;n._mainSortID=0,n._sprite3D=this,n.renderObj=r,n._material=i},n._onMaterialChanged=function(t,e,n){var i=t._renderElements;if(e<i.length){i[e]._material=n||ShurikenParticleMaterial.defaultMaterial}},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._parseCustomProps=function(t,n,i,r){var a,s=Math.PI/180,o=0,l=0,h=this.particleRender,_=i.material;if(_)a=Loader.getRes(n[_.path]);else{var u=i.materialPath;u?a=Loader.getRes(n[u]):(a=new ShurikenParticleMaterial,a.diffuseTexture=n?Loader.getRes(n[i.texturePath]):Texture2D.load(i.texturePath))}h.sharedMaterial=a;var c=i.meshPath;c&&(h.mesh=Loader.getRes(n[c])),h.renderMode=i.renderMode,h.stretchedBillboardCameraSpeedScale=i.stretchedBillboardCameraSpeedScale,h.stretchedBillboardSpeedScale=i.stretchedBillboardSpeedScale,h.stretchedBillboardLengthScale=i.stretchedBillboardLengthScale,h.sortingFudge=i.sortingFudge?i.sortingFudge:0;var d=this.particleSystem;d.isPerformanceMode=i.isPerformanceMode,d.duration=i.duration,d.looping=i.looping,d.prewarm=i.prewarm,d.startDelayType=i.startDelayType,d.startDelay=i.startDelay,d.startDelayMin=i.startDelayMin,d.startDelayMax=i.startDelayMax,d.startLifetimeType=i.startLifetimeType,d.startLifetimeConstant=i.startLifetimeConstant,d.startLifeTimeGradient=e._initStartLife(i.startLifetimeGradient),d.startLifetimeConstantMin=i.startLifetimeConstantMin,d.startLifetimeConstantMax=i.startLifetimeConstantMax,d.startLifeTimeGradientMin=e._initStartLife(i.startLifetimeGradientMin),d.startLifeTimeGradientMax=e._initStartLife(i.startLifetimeGradientMax),d.startSpeedType=i.startSpeedType,d.startSpeedConstant=i.startSpeedConstant,d.startSpeedConstantMin=i.startSpeedConstantMin,d.startSpeedConstantMax=i.startSpeedConstantMax,d.threeDStartSize=i.threeDStartSize,
d.startSizeType=i.startSizeType,d.startSizeConstant=i.startSizeConstant;var f=i.startSizeConstantSeparate,m=d.startSizeConstantSeparate.elements;m[0]=f[0],m[1]=f[1],m[2]=f[2],d.startSizeConstantMin=i.startSizeConstantMin,d.startSizeConstantMax=i.startSizeConstantMax;var p=i.startSizeConstantMinSeparate,g=d.startSizeConstantMinSeparate.elements;g[0]=p[0],g[1]=p[1],g[2]=p[2];var v=i.startSizeConstantMaxSeparate,x=d.startSizeConstantMaxSeparate.elements;x[0]=v[0],x[1]=v[1],x[2]=v[2],d.threeDStartRotation=i.threeDStartRotation,d.startRotationType=i.startRotationType,d.startRotationConstant=i.startRotationConstant*s;var S=i.startRotationConstantSeparate,T=d.startRotationConstantSeparate.elements;T[0]=S[0]*s,T[1]=S[1]*s,T[2]=S[2]*s,d.startRotationConstantMin=i.startRotationConstantMin*s,d.startRotationConstantMax=i.startRotationConstantMax*s;var E=i.startRotationConstantMinSeparate,y=d.startRotationConstantMinSeparate.elements;y[0]=E[0]*s,y[1]=E[1]*s,y[2]=E[2]*s;var M=i.startRotationConstantMaxSeparate,D=d.startRotationConstantMaxSeparate.elements;D[0]=M[0]*s,D[1]=M[1]*s,D[2]=M[2]*s,d.randomizeRotationDirection=i.randomizeRotationDirection,d.startColorType=i.startColorType;var C=i.startColorConstant,R=d.startColorConstant.elements;R[0]=C[0],R[1]=C[1],R[2]=C[2],R[3]=C[3];var A=i.startColorConstantMin,b=d.startColorConstantMin.elements;b[0]=A[0],b[1]=A[1],b[2]=A[2],b[3]=A[3];var I=i.startColorConstantMax,w=d.startColorConstantMax.elements;w[0]=I[0],w[1]=I[1],w[2]=I[2],w[3]=I[3],d.gravityModifier=i.gravityModifier,d.simulationSpace=i.simulationSpace,d.scaleMode=i.scaleMode,d.playOnAwake=i.playOnAwake,d.maxParticles=i.maxParticles;var V=i.autoRandomSeed;null!=V&&(d.autoRandomSeed=V);var L=i.randomSeed;null!=L&&(d.randomSeed[0]=L);var P=i.emission;if(P){var N=d.emission;N.emissionRate=P.emissionRate;var O=P.bursts;if(O)for(o=0,l=O.length;o<l;o++){var F=O[o];N.addBurst(new Burst(F.time,F.min,F.max))}N.enbale=P.enable}else N.enbale=!1;var B=i.shape;if(B){var U;switch(B.shapeType){case 0:var G;U=G=new SphereShape,G.radius=B.sphereRadius,G.emitFromShell=B.sphereEmitFromShell,G.randomDirection=B.sphereRandomDirection;break;case 1:var H;U=H=new HemisphereShape,H.radius=B.hemiSphereRadius,H.emitFromShell=B.hemiSphereEmitFromShell,H.randomDirection=B.hemiSphereRandomDirection;break;case 2:var W;U=W=new ConeShape,W.angle=B.coneAngle*s,W.radius=B.coneRadius,W.length=B.coneLength,W.emitType=B.coneEmitType,W.randomDirection=B.coneRandomDirection;break;case 3:var k;U=k=new BoxShape,k.x=B.boxX,k.y=B.boxY,k.z=B.boxZ,k.randomDirection=B.boxRandomDirection;break;case 7:var z;U=z=new CircleShape,z.radius=B.circleRadius,z.arc=B.circleArc*s,z.emitFromEdge=B.circleEmitFromEdge,z.randomDirection=B.circleRandomDirection;break;default:var X;U=X=new CircleShape,X.radius=B.circleRadius,X.arc=B.circleArc*s,X.emitFromEdge=B.circleEmitFromEdge,X.randomDirection=B.circleRandomDirection}U.enable=B.enable,d.shape=U}var Y=i.velocityOverLifetime;if(Y){var K,Z=Y.velocity;switch(Z.type){case 0:var j=Z.constant;K=GradientVelocity.createByConstant(new Vector3(j[0],j[1],j[2]));break;case 1:K=GradientVelocity.createByGradient(this._initParticleVelocity(Z.gradientX),this._initParticleVelocity(Z.gradientY),this._initParticleVelocity(Z.gradientZ));break;case 2:var q=Z.constantMin,Q=Z.constantMax;K=GradientVelocity.createByRandomTwoConstant(new Vector3(q[0],q[1],q[2]),new Vector3(Q[0],Q[1],Q[2]));break;case 3:K=GradientVelocity.createByRandomTwoGradient(this._initParticleVelocity(Z.gradientXMin),this._initParticleVelocity(Z.gradientXMax),this._initParticleVelocity(Z.gradientYMin),this._initParticleVelocity(Z.gradientYMax),this._initParticleVelocity(Z.gradientZMin),this._initParticleVelocity(Z.gradientZMax))}var $=new VelocityOverLifetime(K);$.space=Y.space,$.enbale=Y.enable,d.velocityOverLifetime=$}var J=i.colorOverLifetime;if(J){var tt,et=J.color;switch(et.type){case 0:var nt=et.constant;tt=GradientColor.createByConstant(new Vector4(nt[0],nt[1],nt[2],nt[3]));break;case 1:tt=GradientColor.createByGradient(this._initParticleColor(et.gradient));break;case 2:var it=et.constantMin,rt=et.constantMax;tt=GradientColor.createByRandomTwoConstant(new Vector4(it[0],it[1],it[2],it[3]),new Vector4(rt[0],rt[1],rt[2],rt[3]));break;case 3:tt=GradientColor.createByRandomTwoGradient(this._initParticleColor(et.gradientMin),this._initParticleColor(et.gradientMax))}var at=new ColorOverLifetime(tt);at.enbale=J.enable,d.colorOverLifetime=at}var st=i.sizeOverLifetime;if(st){var ot,lt=st.size;switch(lt.type){case 0:ot=lt.separateAxes?GradientSize.createByGradientSeparate(this._initParticleSize(lt.gradientX),this._initParticleSize(lt.gradientY),this._initParticleSize(lt.gradientZ)):GradientSize.createByGradient(this._initParticleSize(lt.gradient));break;case 1:if(lt.separateAxes){var ht=lt.constantMinSeparate,_t=lt.constantMaxSeparate;ot=GradientSize.createByRandomTwoConstantSeparate(new Vector3(ht[0],ht[1],ht[2]),new Vector3(_t[0],_t[1],_t[2]))}else ot=GradientSize.createByRandomTwoConstant(lt.constantMin,lt.constantMax);break;case 2:ot=lt.separateAxes?GradientSize.createByRandomTwoGradientSeparate(this._initParticleSize(lt.gradientXMin),this._initParticleSize(lt.gradientYMin),this._initParticleSize(lt.gradientZMin),this._initParticleSize(lt.gradientXMax),this._initParticleSize(lt.gradientYMax),this._initParticleSize(lt.gradientZMax)):GradientSize.createByRandomTwoGradient(this._initParticleSize(lt.gradientMin),this._initParticleSize(lt.gradientMax))}var ut=new SizeOverLifetime(ot);ut.enbale=st.enable,d.sizeOverLifetime=ut}var ct=i.rotationOverLifetime;if(ct){var dt,ft=ct.angularVelocity;switch(ft.type){case 0:ft.separateAxes||(dt=GradientAngularVelocity.createByConstant(ft.constant*s));break;case 1:ft.separateAxes||(dt=GradientAngularVelocity.createByGradient(this._initParticleRotation(ft.gradient)));break;case 2:ft.separateAxes||(dt=GradientAngularVelocity.createByRandomTwoConstant(ft.constantMin*s,ft.constantMax*s));break;case 3:ft.separateAxes||(dt=GradientAngularVelocity.createByRandomTwoGradient(this._initParticleRotation(ft.gradientMin),this._initParticleRotation(ft.gradientMax)))}var mt=new RotationOverLifetime(dt);mt.enbale=ct.enable,d.rotationOverLifetime=mt}var pt=i.textureSheetAnimation;if(pt){var gt,vt=pt.frame;switch(vt.type){case 0:gt=FrameOverTime.createByConstant(vt.constant);break;case 1:gt=FrameOverTime.createByOverTime(this._initParticleFrame(vt.overTime));break;case 2:gt=FrameOverTime.createByRandomTwoConstant(vt.constantMin,vt.constantMax);break;case 3:gt=FrameOverTime.createByRandomTwoOverTime(this._initParticleFrame(vt.overTimeMin),this._initParticleFrame(vt.overTimeMax))}var xt,St=pt.startFrame;switch(St.type){case 0:xt=StartFrame.createByConstant(St.constant);break;case 1:xt=StartFrame.createByRandomTwoConstant(St.constantMin,St.constantMax)}var Tt=new TextureSheetAnimation(gt,xt);Tt.enable=pt.enable;var Et=pt.tiles;Tt.tiles=new Vector2(Et[0],Et[1]),Tt.type=pt.type,Tt.randomRow=pt.randomRow,Tt.cycles=pt.cycles,d.textureSheetAnimation=Tt}},n._activeHierarchy=function(){laya.d3.core.Sprite3D.prototype._activeHierarchy.call(this),this.particleSystem.playOnAwake&&this.particleSystem.play()},n._inActiveHierarchy=function(){laya.d3.core.Sprite3D.prototype._inActiveHierarchy.call(this),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)},n.cloneTo=function(t){var e=t,n=e._geometryFilter;this._geometryFilter.cloneTo(n);var i=e._render,r=this._render;i.sharedMaterials=r.sharedMaterials,i.enable=r.enable,i.renderMode=r.renderMode,i.mesh=r.mesh,i.stretchedBillboardCameraSpeedScale=r.stretchedBillboardCameraSpeedScale,i.stretchedBillboardSpeedScale=r.stretchedBillboardSpeedScale,i.stretchedBillboardLengthScale=r.stretchedBillboardLengthScale,i.sortingFudge=r.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},__getset(0,n,"particleRender",function(){return this._render}),__getset(0,n,"particleSystem",function(){return this._geometryFilter}),e.load=function(t){return Laya.loader.create(t,null,null,e,null,1,!1)},e._initStartLife=function(t){for(var e=new GradientDataNumber,n=t.startLifetimes,i=0,r=n.length;i<r;i++){var a=n[i];e.add(a.key,a.value)}return e},e.SHADERDEFINE_RENDERMODE_BILLBOARD=0,e.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_MESH=0,e.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,e.SHADERDEFINE_COLOROVERLIFETIME=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,e.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,e.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIME=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,e.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,e.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,e.SHADERDEFINE_SHAPE=0,e.WORLDPOSITION=0,e.WORLDROTATION=1,e.POSITIONSCALE=4,e.SIZESCALE=5,e.SCALINGMODE=6,e.GRAVITY=7,e.THREEDSTARTROTATION=8,e.STRETCHEDBILLBOARDLENGTHSCALE=9,e.STRETCHEDBILLBOARDSPEEDSCALE=10,e.SIMULATIONSPACE=11,e.CURRENTTIME=12,e.VOLVELOCITYCONST=13,e.VOLVELOCITYGRADIENTX=14,e.VOLVELOCITYGRADIENTY=15,e.VOLVELOCITYGRADIENTZ=16,e.VOLVELOCITYCONSTMAX=17,e.VOLVELOCITYGRADIENTXMAX=18,e.VOLVELOCITYGRADIENTYMAX=19,e.VOLVELOCITYGRADIENTZMAX=20,e.VOLSPACETYPE=21,e.COLOROVERLIFEGRADIENTALPHAS=22,e.COLOROVERLIFEGRADIENTCOLORS=23,e.MAXCOLOROVERLIFEGRADIENTALPHAS=24,e.MAXCOLOROVERLIFEGRADIENTCOLORS=25,e.SOLSIZEGRADIENT=26,e.SOLSIZEGRADIENTX=27,e.SOLSIZEGRADIENTY=28,e.SOLSizeGradientZ=29,e.SOLSizeGradientMax=30,e.SOLSIZEGRADIENTXMAX=31,e.SOLSIZEGRADIENTYMAX=32,e.SOLSizeGradientZMAX=33,e.ROLANGULARVELOCITYCONST=34,e.ROLANGULARVELOCITYCONSTSEPRARATE=35,e.ROLANGULARVELOCITYGRADIENT=36,e.ROLANGULARVELOCITYGRADIENTX=37,e.ROLANGULARVELOCITYGRADIENTY=38,e.ROLANGULARVELOCITYGRADIENTZ=39,e.ROLANGULARVELOCITYGRADIENTW=40,e.ROLANGULARVELOCITYCONSTMAX=41,e.ROLANGULARVELOCITYCONSTMAXSEPRARATE=42,e.ROLANGULARVELOCITYGRADIENTMAX=43,e.ROLANGULARVELOCITYGRADIENTXMAX=44,e.ROLANGULARVELOCITYGRADIENTYMAX=45,e.ROLANGULARVELOCITYGRADIENTZMAX=46,e.ROLANGULARVELOCITYGRADIENTWMAX=47,e.TEXTURESHEETANIMATIONCYCLES=48,e.TEXTURESHEETANIMATIONSUBUVLENGTH=49,e.TEXTURESHEETANIMATIONGRADIENTUVS=50,e.TEXTURESHEETANIMATIONGRADIENTMAXUVS=51,e}(RenderableSprite3D),SkinnedMeshSprite3D=function(t){function e(t,n){this._subMeshOffset=null,e.__super.call(this,n),this._subMeshOffset=[],this._geometryFilter=new MeshFilter(this),this._render=new SkinnedMeshRender(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),t&&(this._geometryFilter.sharedMesh=t)}__class(e,"laya.d3.core.SkinnedMeshSprite3D",t);var n=e.prototype;return n._changeRenderObjectByMesh=function(t){var e=this._render._renderElements,n=e[t];n||(n=e[t]=new SubMeshRenderElement),n._render=this._render;var i=this._render.sharedMaterials[t];i||(i=StandardMaterial.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(t);return n._mainSortID=this._getSortID(r,i),n._sprite3D=this,n.renderObj=r,n._material=i,n},n._changeRenderObjectByMaterial=function(t,e){var n=this._render._renderElements[t];e||(e=StandardMaterial.defaultMaterial);var i=this._geometryFilter.sharedMesh.getRenderElement(t);return n._mainSortID=this._getSortID(i,e),n._sprite3D=this,n.renderObj=i,n._material=e,n},n._changeRenderObjectsByMesh=function(){var t=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=t;for(var e=0;e<t;e++)this._changeRenderObjectByMesh(e)},n._onMeshChanged=function(t){var e=t.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._changeRenderObjectsByMesh)},n._onMaterialChanged=function(t,e,n){e<this._render._renderElements.length&&this._changeRenderObjectByMaterial(e,n)},n._parseCustomProps=function(t,e,n,i){var r=this.skinnedMeshRender,a=n.lightmapIndex;null!=a&&(r.lightmapIndex=a);var s=n.lightmapScaleOffset;s&&(r.lightmapScaleOffset=new Vector4(s[0],s[1],s[2],s[3]));var o,l;if(i.instanceParams)(o=i.instanceParams.loadPath)&&(l=Loader.getRes(e[o]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{o=n.meshPath,o&&(l=Loader.getRes(e[o]),this.meshFilter.sharedMesh=l);var h=n.materials;if(h){var _=r.sharedMaterials,u=h.length;_.length=u;for(var c=0;c<u;c++)_[c]=Loader.getRes(e[h[c].path]);r.sharedMaterials=_}var d=n.rootBone;d&&r._setRootBone(d);var f=n.boundBox;if(f){var m=f.min,p=f.max,g=new BoundBox(new Vector3(m[0],m[1],m[2]),new Vector3(p[0],p[1],p[2]));r.localBoundBox=g}else r._hasIndependentBound=!1;var v=n.boundSphere;if(v){var x=v.center,S=new BoundSphere(new Vector3(x[0],x[1],x[2]),v.radius);r.localBoundSphere=S}}},n._changeHierarchyAnimator=function(t){if(t){var e=this.skinnedMeshRender;e._cacheAnimator=t;var n=t.avatar;n&&e._setCacheAvatar(n)}laya.d3.core.Sprite3D.prototype._changeHierarchyAnimator.call(this,t)},n._clearSelfRenderObjects=function(){this._scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this._scene.addFrustumCullingObject(this._render)},n._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,n=t.materials,i=0,r=n.length;i<r;i++)e[i]||(e[i]=n[i]);this._render.sharedMaterials=e},n.cloneTo=function(t){var e=t;e._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var n=this._render,i=e._render;i.enable=n.enable,i.sharedMaterials=n.sharedMaterials,i.castShadow=n.castShadow;var r=n.lightmapScaleOffset;r&&(i.lightmapScaleOffset=r.clone()),i.receiveShadow=n.receiveShadow,i.sortingFudge=n.sortingFudge,i._rootBone=n._rootBone;var a=n.localBoundSphere;a&&(i.localBoundSphere=a.clone());var s=n.localBoundBox;s&&(i.localBoundBox=s.clone()),i._hasIndependentBound=n._hasIndependentBound,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy())},n.createConchModel=function(){return null},__getset(0,n,"skinnedMeshRender",function(){return this._render}),__getset(0,n,"meshFilter",function(){return this._geometryFilter}),e.load=function(t){return Laya.loader.create(t,null,null,MeshSprite3D,null,1,!1)},e.BONES=0,e.SHADERDEFINE_BONE=8,e}(RenderableSprite3D),DirectionLight=function(t){function e(){this._direction=null,this._updateDirection=!1,e.__super.call(this),this._updateDirection=!1,this._direction=new Vector3,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}__class(e,"laya.d3.core.light.DirectionLight",t);var n=e.prototype;return n._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new ParallelSplitShadowMap,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var t=this.scene.parallelSplitShadowMaps;t.splice(t.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,this.scene.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),this.scene.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),this.scene.removeShaderDefine(ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3)}},n._addSelfRenderObjects=function(){t.prototype._addSelfRenderObjects.call(this),this._shadow&&this._initShadow()},n._clearSelfRenderObjects=function(){var t=this.scene,e=t._shaderValues;e.setValue(4,null),e.setValue(3,null),t.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT)},n._prepareToScene=function(t){var e=t.scene;if(e.enableLight&&this._activeInHierarchy){var n=e._shaderValues;return e.addShaderDefine(ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT),Vector3.scale(this.color,this._intensity,this._intensityColor),n.setValue(4,this._intensityColor.elements),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),n.setValue(3,this._direction.elements),!0}return e.removeShaderDefine(ShaderCompile3D.SHADERDEFINE_DIRECTIONLIGHT),!1},n._onWorldMatrixChange=function(){this._updateDirection=!0},__getset(0,n,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),this._updateDirection=!1),this._direction},function(t){console.log("Warning: discard property,please use transform's property instead.");var e=this.transform.worldMatrix;e.setForward(t),this.transform.worldMatrix=e,Vector3.normalize(t,t),this._direction=t,this.shadow&&this._parallelSplitShadowMap&&this._parallelSplitShadowMap._setGlobalParallelLightDir(this._direction)}),__getset(0,n,"shadow",t.prototype._$get_shadow,function(t){this._shadow!==t&&(this._shadow=t,this.scene&&this._initShadow())}),e}(LightSprite),TerrainChunk=function(t){function e(t,n,i,r,a,s,o,l){e.__super.call(this,l),this._geometryFilter=new TerrainFilter(this,t,n,i,r,a,s,o),this._render=new TerrainRender(this)}__class(e,"laya.d3.terrain.TerrainChunk",t);var n=e.prototype;return n.buildRenderElementAndMaterial=function(t,e,n,i,r,a,s,o,l,h,_,u,c,d,f,m,p,g){void 0===_&&(_=1),void 0===u&&(u=1),void 0===c&&(c=1),void 0===d&&(d=1),void 0===f&&(f=1),void 0===m&&(m=1),void 0===p&&(p=1),void 0===g&&(g=1);var v=new TerrainMaterial;l&&(v.diffuseColor=l),o&&(v.ambientColor=o),h&&(v.specularColor=h),v.splatAlphaTexture=Loader.getRes(n),v.normalTexture=e?Loader.getRes(e):null,v.diffuseTexture1=i?Loader.getRes(i):null,v.diffuseTexture2=r?Loader.getRes(r):null,v.diffuseTexture3=a?Loader.getRes(a):null,v.diffuseTexture4=s?Loader.getRes(s):null,v.setDiffuseScale1(_,u),v.setDiffuseScale2(c,d),v.setDiffuseScale3(f,m),v.setDiffuseScale4(p,g),v.setDetailNum(t),0!=this._render._renderElements.length&&(v.renderMode=2);var x=new RenderElement;x._mainSortID=0,x._sprite3D=this,x.renderObj=this._geometryFilter,x._material=v,this._render._materials.push(v),this._render._renderElements.push(x)},n.createConchModel=function(){return null},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,n=t.materials,i=0,r=n.length;i<r;i++)e[i]||(e[i]=n[i]);this._render.sharedMaterials=e},n.cloneTo=function(t){console.log("Terrain Chunk can't clone")},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy())},__getset(0,n,"terrainRender",function(){return this._render}),__getset(0,n,"terrainFilter",function(){return this._geometryFilter}),e.load=function(t){return Laya.loader.create(t,null,null,e,null,1,!1)},e}(RenderableSprite3D);Laya.__init([EventDispatcher,LoaderManager,AtlasGrid,Timer,DrawText,ShaderCompile,WebGLContext2D,LocalStorage,Browser,Render]),new LayaAir3D}(window,document,Laya);